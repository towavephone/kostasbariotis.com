webpackJsonp([0x7abf84841505],{1056:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlUlEQVRIx11WaWxU1xWewbQlrdofkSIhGiBpMPZ4Vs/2lpm3zupZPOOZ8Sz2YGzANkaAKaYQUrMkLYgiIlxCQjCYQAwYEoMQNJAIFBxaQgUhoCopYceBJo1pKFVDCbOc0/fesOZKV+fM1Tvf/c56R0VYOZW8lvAxtSybvbExAu1+mndGuaDQ2F4rNHVFhCZJZlMeZ1Qrf9Mt+H+qur/ihFORAFA64J0pVTcXVcDmcKFfruIzZ7rY1H89fAZivjbM1MzFxkAnZqWd9M7KJcTmv7zCN44sY+tflm12C79WLxLCqidWN9cwWpYvsfXL13vasZudgm4mgX4hW6h1teRjnrZCwjOzWO/twIR/FjZ7WnEZ35JvcUSeU4gwSXV7W1sJzEH6R8nSRArlXjr6r7S1DqNUvMAzCXCzSfDxDRAUmyDkaoawtEPi1LxHyGLMkby5gEqUy7atjnq1roosAXqE6Yq7DBXa7RLS6HRG8y4hhbwzDiJbj4IkXUwS5e1h07IOorMePUL6ruiKGmRblg2PesJlq9nxrJMMfydIbhIWP9jMPrBLkrIHgXfG0CdmgKMjwFARFKVvHEQo5xUyKDDRN2T7aE17mV5rfZQYm1lM0EQYWUe0aNTxoKl0Qnk5jVqNA/VaFu3SBS7SB7Ju0ougr2KKWg2DBi17mbCaxyghMzgeMTTp2W7CGkTKHshZqn0Q5Osg6opBhAmAzcADY/NheyQJBi2D8mXVehYMOgEsJg9aTIxSN2YTO+ohQ62G6rGZa5AmAjmj0YvzG5vhVP8f4fTO12FtVxfMjTfC6zPbwOsIQNybhK6GlmLCm5DA6cu2aoeSaaOeVheLxRKgpoJcZ5UAly94MeeiQ+jnQtBCcTBTZ8Ght9fDfy58DDdOHIRj2zdA/4uzYWBpZ6Fr6jR8/lfWP8n2usqA2mQgH7msr3Ks0WgEfGvN6lz/q6tgXqgZjgpZOGSLwsldA4CFG4j3rmP/osU47xkdrm5pLfjdETm+p64cf0fJME34HiVFV+VYajF50UGGc/Nnz4XDfW/ArQ09+M++XsCblwD+fQEL356HswuWwdedS+Dg2p5ilZQwa7VrpCHZ9nOl7Ojg44B0hxxg0hbMjx2rh2iwDk4feReKI58hfn8V8c5lwNyXiF+dRbz4Z1jY1g4TJ1rQbnHfc/ORihJDr5q0kw8AyVqDjpeSEpJLAyaMN6HRwMDuTa/B1fcPwcfbBuHc8SPw+cnDsGvzeim7HOg0DpAYoouPBWUMJxUo65y18X4MtbYJOo3zjgQoxwWen1iNDdPmwPu9+2BvfCXsXbQRehf9Hly0B8aN04OuioGqCipvt/hQ5GLzS4Dh0Tdv3+/nvm0qVVUlfUouboOWK8jxmaznMBXIwpbfroWN63th384tcHTfDpj0gg21lQxoK+m8TQGMb5UxAt6OUYSVkUuGK5MPKiuIHicZwWqDmNNqpE6pIFBjpGDxsqXwuxUroWtBN5w4NgSbNvcDIRW61CUFu9UrtV/si7Fjf/ajUmICSvxKgJMtdQxVK2XOU9RpGNBL3VBeQWIqPR3SjR3QOW8xrFmxCnrWbYJMaobEkr1HE/4zIpv4nrK7NIrbpF+tspoYZdpMLte+wNPRu6S1Bs1GqV/1DOqMPFjIMFbq3dg6cyFkGmagqZqHaoOAHF2XZ6ngWg+XBM4RVoLHOWrLVG4uWpo4FvsvfHz6NktFkbT6QafnQGsUoFLHYm1dFj44cgwYPgQVkymkbP6RWl+LNIRjL/uFhltuNjEoYySCXaNUojOsMPSw4aqwa+o9ga5DggiC1RFDmyMG1bYQVlTSIIhRMJq9RaPZJ4VF+DQZ6MCAmOkLurJ/DYiNt/R67VMKs4hrqjL+o+6mjrj0hjBEOG+1h8FOxcFO1oHVFgazPYQGqdfNthBYpUqwEME78nsT4tP7o96WwWSwA1nKb35iyCZ8M85EXE3oYBO3ab4RKWcSKCaFJJMCQprSpPQcUFwKzWQUKo1+lC9x0r7Fcc+0OVOj8zEkNrY8BAuLDV11ruZvDXrhuJ3NIu+bAYK/FXjfdOA8zegUp6DdmQKNMQD+8HTseW1LYeijE/jB4Q+/Wry8a5L01B6MeaetUcDSjfVjjOVM7da+bTMPvHfkbmrKb5DksjkLncmZqXTe6siAnWmAmkhbYUPvQP7cufO5L69fxyvD/8Ctb+/aI2PU8AmvRGqZAoiIityzb8/T165d3X3t2vD/Pjr+KW7b+R6u2/AOrli9CQfePYQXLg3jpSvDeOLkWTxw6Oh3uwYPrJTMlNHlFcLPeNk6/UOXZ7cuGP1A397fP/7v584vvzJ8o+dvn33+Zm/v9q9X/2EDbN+19+ybm3ds33/ww5f63uovf/D9woVL1A90P5dQqYaGhpQfg4N71BJbteoHqyk7Z+e8zlfuSupPHj+/eO2bso5ZcxQ9Fsiqgny6ZOv3+VTfjIwo+iefnFYN7BxQf3FxuEwGH1c+fgxBuIZnTFuIIh9U2qt3844fb9y0Vf0gXPKm7bzKzYZ+wGTKFFWNz1/6v8OLUiuaFKMJz00yEvaa/RQZnK086s6MutpEqRLx+kcT+rH1f+YikeeNfqnwAAAAAElFTkSuQmCC",aspectRatio:.6666666666666666,src:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png",srcSet:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-8a97b.png 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-0fdf3.png 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png 600w",srcWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp",srcSetWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-5d70e.webp 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-d1677.webp 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>需求背景接上文 <a href="/components-pack-as-library/">记一次组件打包为链接的实践</a></p>\n<p>框架搭建接上文 <a href="/webpack-template-new-project/">Webpack 脚手架搭建笔记——记一次新项目搭建</a></p>\n<h2 id="组件轻量化"><a href="#%E7%BB%84%E4%BB%B6%E8%BD%BB%E9%87%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件轻量化</h2>\n<p>在将客服组件上线后，由于未考虑到加载的组件包的大小，尤其是初始加载的包比较大，即使是压缩过初始加载也有 600 多 k，严重影响首页加载，导致加载此脚本的网站需要很长时间才能响应，所以有了这次的优化任务</p>\n<h2 id="移动端适配"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端适配</h2>\n<p>根据产品要求，此客服组件还需要兼容到移动端，微信端（微信网页、小程序）</p>\n<h1 id="方案调研"><a href="#%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案调研</h1>\n<ol>\n<li>组件异步加载，减少首屏加载大小，非首屏且较大的组件预加载，这里需要 nginx 的配合</li>\n<li>去除较大的库，改用轻量级的替代库或者不用</li>\n<li>所有用到的组件最好都由自己编写，有利于定制化功能、减小组件大小</li>\n<li>移动端可以和桌面端项目写在一起分开打包</li>\n<li>代码的分层尤其是 IM 层要分离出来，便于切换不同的 IM 提供商</li>\n<li>小程序端用 webview 加载的网页，需要注意在第三方小程序上配置 nginx</li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="组件异步加载"><a href="#%E7%BB%84%E4%BB%B6%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件异步加载</h2>\n<p>需要修改 webpack 配置，由于之前是在 webpack2 上开发，不能很完美的做到异步加载。此时将框架升级到和本文 <a href="/webpack-template-new-project/">Webpack 脚手架搭建笔记——记一次新项目搭建</a> 的同一版本，具体修改如下：</p>\n<ol>\n<li>\n<p>去除 mini-css-extract-plugin，防止 css 单独抽离</p>\n</li>\n<li>\n<p>聚合初始加载脚本到一个文件，异步加载的在其他文件，且对异步加载的做 hash 处理</p>\n<p>boot\\internals\\webpack\\webpack.prod.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2274075049939972000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`entry: {\n bundle: [\'runtime/polyfill\', path.join(process.cwd(), buildMap.indexEntry)],\n},\n\noutput: {\n filename: \'[name].js\',\n chunkFilename: \'[name].[chunkhash].chunk.js\',\n},\n\n// 关闭代码切割，防止首页产生除 bundle.js 外的其他文件\n// runtimeChunk: \'single\',\nsplitChunks: false,`, `2274075049939972000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n bundle<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'runtime/polyfill\'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\noutput<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n chunkFilename<span class="token punctuation">:</span> <span class="token string">\'[name].[chunkhash].chunk.js\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 关闭代码切割，防止首页产生除 bundle.js 外的其他文件</span>\n<span class="token comment">// runtimeChunk: \'single\',</span>\nsplitChunks<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>生成构建文件如下：</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 539px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 34.137291280148425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA7ElEQVQY03WQ2W7DIBBF/SnOZmzMDDuG9rEPVZQ2iqqm//8pvUCk9qGVrq6AmTMLQ3x6OV9vLj4rW1adF05/i355k+Q0jEd1v4gQPQHmsJ/UARJ0EKqJ/tPutA67ie9v0nkrlNduI5vYbdplpSPbRG7D1fhsY4HXkM/KJLhYTYU/L9IHN1MACVXShF6ITDS+IBWyoZiAc0EJZSKiFf56ly7YWTXYpFUHeG9IrQlGQIneHxPhcSE3HuWwn/jjdcHY+ADAkr2qcM3oKyC7lrOp+2lmYFi47Swoz9Joz3XaiA8bWwAZD/2c8f7Aur4Bl0hM5Y3OZe0AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 11 25 49"\n        title=""\n        src="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png"\n        srcset="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-e7723.png 200w,\n/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-61f03.png 400w,\n/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png 539w"\n        sizes="(max-width: 539px) 100vw, 539px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-b1a91.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 38.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA8klEQVQY033Q227DIAwG4DzLtuYA2GDAxpAmat//pUrSVdsuVumTZS7gNx50vSOV0cbL7C+L/5zwvY8RF0gY9WvGIVHdyy51c0GBdAGeXX5vsnk0qTcDexUqQDJDHm2aTJrst9nmw/+vDDnULTVujbYWWYOoP6GoS6UzyH9jj8zpNHCoShVTgazYSQ1JQ1QX1QBb4AWk/2VBMSeL5ajApl8OoTbeGzVt91RvmjepN77eO1lvm1y17Z5Xii2kFag+eV8A5ViYeHVBXDxYz44EcrFJ7Dk2cDEkCGLOmX820pOJVu/rDGV5wrO619G9ejwY1N8ehLJaU7IJP7EAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 11 26 45"\n        title=""\n        src="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-fee1c.png"\n        srcset="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-a67b7.png 200w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-0b187.png 400w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-fee1c.png 800w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-b1a91.png 1200w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>首页只会引入 bundle.js 文件，且异步组件在其他文件</p>\n<h2 id="较大组件预加载"><a href="#%E8%BE%83%E5%A4%A7%E7%BB%84%E4%BB%B6%E9%A2%84%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>较大组件预加载</h2>\n<p>这里为了打开聊天组件时不会卡顿，使用了预加载，一定要注意要在主入口加载完成，也就是请求加载完成后在进行预加载，否则同样会造成首页加载时间过长</p>\n<p>这里采取的方案是请求完成后要提前知道加载哪个组件就立即预加载此组件（需要后端配合，不适用于点击后才知道加载哪个组件的情况。当然也可以全部预加载所有较大组件，不过为了省流就没这么做），不用等到点击后加载</p>\n<h2 id="精简依赖库"><a href="#%E7%B2%BE%E7%AE%80%E4%BE%9D%E8%B5%96%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>精简依赖库</h2>\n<h3 id="打包前依赖"><a href="#%E6%89%93%E5%8C%85%E5%89%8D%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包前依赖</h3>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86116719773356180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;dependencies&quot;: {\n &quot;antd&quot;: &quot;^3.11.0&quot;,\n &quot;babel-polyfill&quot;: &quot;6.26.0&quot;,\n &quot;classnames&quot;: &quot;^2.2.5&quot;,\n &quot;element-resize-event&quot;: &quot;^2.0.9&quot;,\n &quot;immutable&quot;: &quot;3.8.1&quot;,\n &quot;invariant&quot;: &quot;2.2.2&quot;,\n &quot;lodash&quot;: &quot;4.17.2&quot;,\n &quot;md5&quot;: &quot;^2.2.1&quot;,\n &quot;moment&quot;: &quot;^2.18.1&quot;,\n &quot;prop-types&quot;: &quot;^15.6.2&quot;,\n &quot;raf&quot;: &quot;^3.4.1&quot;,\n &quot;react&quot;: &quot;16.6.0&quot;,\n &quot;react-dom&quot;: &quot;16.6.0&quot;,\n &quot;react-helmet&quot;: &quot;5.2.0&quot;,\n &quot;react-player&quot;: &quot;^1.6.4&quot;,\n &quot;react-redux&quot;: &quot;5.1.0&quot;,\n &quot;react-router&quot;: &quot;3.2.1&quot;,\n &quot;react-router-redux&quot;: &quot;4.0.6&quot;,\n &quot;react-router-scroll&quot;: &quot;0.4.4&quot;,\n &quot;redux&quot;: &quot;3.6.0&quot;,\n &quot;redux-immutable&quot;: &quot;3.0.8&quot;,\n &quot;redux-saga&quot;: &quot;0.16.2&quot;,\n &quot;reselect&quot;: &quot;2.5.4&quot;,\n &quot;rxjs&quot;: &quot;5.5.3&quot;,\n &quot;smoothscroll-polyfill&quot;: &quot;^0.3.6&quot;,\n &quot;warning&quot;: &quot;3.0.0&quot;,\n &quot;whatwg-fetch&quot;: &quot;2.0.1&quot;\n},`, `86116719773356180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"antd"</span><span class="token punctuation">:</span> <span class="token string">"^3.11.0"</span><span class="token punctuation">,</span>\n <span class="token string">"babel-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"6.26.0"</span><span class="token punctuation">,</span>\n <span class="token string">"classnames"</span><span class="token punctuation">:</span> <span class="token string">"^2.2.5"</span><span class="token punctuation">,</span>\n <span class="token string">"element-resize-event"</span><span class="token punctuation">:</span> <span class="token string">"^2.0.9"</span><span class="token punctuation">,</span>\n <span class="token string">"immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.8.1"</span><span class="token punctuation">,</span>\n <span class="token string">"invariant"</span><span class="token punctuation">:</span> <span class="token string">"2.2.2"</span><span class="token punctuation">,</span>\n <span class="token string">"lodash"</span><span class="token punctuation">:</span> <span class="token string">"4.17.2"</span><span class="token punctuation">,</span>\n <span class="token string">"md5"</span><span class="token punctuation">:</span> <span class="token string">"^2.2.1"</span><span class="token punctuation">,</span>\n <span class="token string">"moment"</span><span class="token punctuation">:</span> <span class="token string">"^2.18.1"</span><span class="token punctuation">,</span>\n <span class="token string">"prop-types"</span><span class="token punctuation">:</span> <span class="token string">"^15.6.2"</span><span class="token punctuation">,</span>\n <span class="token string">"raf"</span><span class="token punctuation">:</span> <span class="token string">"^3.4.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react"</span><span class="token punctuation">:</span> <span class="token string">"16.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-dom"</span><span class="token punctuation">:</span> <span class="token string">"16.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-helmet"</span><span class="token punctuation">:</span> <span class="token string">"5.2.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-player"</span><span class="token punctuation">:</span> <span class="token string">"^1.6.4"</span><span class="token punctuation">,</span>\n <span class="token string">"react-redux"</span><span class="token punctuation">:</span> <span class="token string">"5.1.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router"</span><span class="token punctuation">:</span> <span class="token string">"3.2.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router-redux"</span><span class="token punctuation">:</span> <span class="token string">"4.0.6"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router-scroll"</span><span class="token punctuation">:</span> <span class="token string">"0.4.4"</span><span class="token punctuation">,</span>\n <span class="token string">"redux"</span><span class="token punctuation">:</span> <span class="token string">"3.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"redux-immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.0.8"</span><span class="token punctuation">,</span>\n <span class="token string">"redux-saga"</span><span class="token punctuation">:</span> <span class="token string">"0.16.2"</span><span class="token punctuation">,</span>\n <span class="token string">"reselect"</span><span class="token punctuation">:</span> <span class="token string">"2.5.4"</span><span class="token punctuation">,</span>\n <span class="token string">"rxjs"</span><span class="token punctuation">:</span> <span class="token string">"5.5.3"</span><span class="token punctuation">,</span>\n <span class="token string">"smoothscroll-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"^0.3.6"</span><span class="token punctuation">,</span>\n <span class="token string">"warning"</span><span class="token punctuation">:</span> <span class="token string">"3.0.0"</span><span class="token punctuation">,</span>\n <span class="token string">"whatwg-fetch"</span><span class="token punctuation">:</span> <span class="token string">"2.0.1"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="打包后依赖"><a href="#%E6%89%93%E5%8C%85%E5%90%8E%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包后依赖</h3>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40146139984467410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;dependencies&quot;: {\n &quot;array-tree-filter&quot;: &quot;^2.1.0&quot;,\n &quot;babel-polyfill&quot;: &quot;6.26.0&quot;,\n &quot;classnames&quot;: &quot;2.2.5&quot;,\n &quot;immutable&quot;: &quot;3.8.2&quot;,\n &quot;lodash&quot;: &quot;4.17.2&quot;,\n &quot;prop-types&quot;: &quot;15.6.2&quot;,\n &quot;rc-dialog&quot;: &quot;^7.5.7&quot;,\n &quot;rc-notification&quot;: &quot;^3.3.1&quot;,\n &quot;rc-select&quot;: &quot;^9.2.0&quot;,\n &quot;rc-tooltip&quot;: &quot;^3.7.3&quot;,\n &quot;rc-upload&quot;: &quot;^2.8.1&quot;,\n &quot;react-lite&quot;: &quot;^0.15.40&quot;,\n &quot;react-loadable&quot;: &quot;5.5.0&quot;,\n &quot;rmc-cascader&quot;: &quot;^5.0.3&quot;,\n &quot;rmc-feedback&quot;: &quot;^2.0.0&quot;,\n &quot;rmc-picker&quot;: &quot;^5.0.10&quot;,\n &quot;whatwg-fetch&quot;: &quot;3.0.0&quot;\n},`, `40146139984467410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"array-tree-filter"</span><span class="token punctuation">:</span> <span class="token string">"^2.1.0"</span><span class="token punctuation">,</span>\n <span class="token string">"babel-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"6.26.0"</span><span class="token punctuation">,</span>\n <span class="token string">"classnames"</span><span class="token punctuation">:</span> <span class="token string">"2.2.5"</span><span class="token punctuation">,</span>\n <span class="token string">"immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.8.2"</span><span class="token punctuation">,</span>\n <span class="token string">"lodash"</span><span class="token punctuation">:</span> <span class="token string">"4.17.2"</span><span class="token punctuation">,</span>\n <span class="token string">"prop-types"</span><span class="token punctuation">:</span> <span class="token string">"15.6.2"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-dialog"</span><span class="token punctuation">:</span> <span class="token string">"^7.5.7"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-notification"</span><span class="token punctuation">:</span> <span class="token string">"^3.3.1"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-select"</span><span class="token punctuation">:</span> <span class="token string">"^9.2.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-tooltip"</span><span class="token punctuation">:</span> <span class="token string">"^3.7.3"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-upload"</span><span class="token punctuation">:</span> <span class="token string">"^2.8.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react-lite"</span><span class="token punctuation">:</span> <span class="token string">"^0.15.40"</span><span class="token punctuation">,</span>\n <span class="token string">"react-loadable"</span><span class="token punctuation">:</span> <span class="token string">"5.5.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-cascader"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.3"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-feedback"</span><span class="token punctuation">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-picker"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.10"</span><span class="token punctuation">,</span>\n <span class="token string">"whatwg-fetch"</span><span class="token punctuation">:</span> <span class="token string">"3.0.0"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="主要变化"><a href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主要变化</h3>\n<ol>\n<li>\n<p>去除比较大的依赖库 antd、moment、rxjs</p>\n</li>\n<li>\n<p>替换 react 为 react-lite</p>\n<p>其中需要对 react-lite 做下兼容处理，不影响之前依赖 react 的代码</p>\n<p>boot\\internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63493644627509486000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'react\': path.resolve(process.cwd(), \'node_modules/react-lite\'),\n\'react-dom\': path.resolve(process.cwd(), \'node_modules/react-lite\'),`, `63493644627509486000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'react\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/react-lite\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token string">\'react-dom\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/react-lite\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h2 id="组件自编写"><a href="#%E7%BB%84%E4%BB%B6%E8%87%AA%E7%BC%96%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件自编写</h2>\n<p>此项目的所有组件使用 antd、antd-mobile 的底层组件，以便优化包大小、自定义功能，组件接口尽量保持一致</p>\n<h3 id="antd-引入方式兼容"><a href="#antd-%E5%BC%95%E5%85%A5%E6%96%B9%E5%BC%8F%E5%85%BC%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>antd 引入方式兼容</h3>\n<p>之前的项目用到 antd，这里采用了和 antd 一样的引用方式。</p>\n<p>作用：有利于代码分割，不会将 antd 的组件代码分割到主入口，antd-mobile 同理。</p>\n<p>.babelrc</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49717005796321124000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n   &quot;import&quot;,\n   {\n     &quot;libraryName&quot;: &quot;antd&quot;,\n     &quot;libraryDirectory&quot;: &quot;components&quot;,\n     &quot;camel2DashComponentName&quot;: false\n   },\n   &quot;antd&quot;\n],\n[\n   &quot;import&quot;,\n   {\n     &quot;libraryName&quot;: &quot;antd-mobile&quot;,\n     &quot;libraryDirectory&quot;: &quot;components&quot;,\n     &quot;camel2DashComponentName&quot;: false\n   },\n   &quot;antd-mobile&quot;\n],`, `49717005796321124000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n   <span class="token string">"import"</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n     <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n     <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"components"</span><span class="token punctuation">,</span>\n     <span class="token string">"camel2DashComponentName"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token string">"antd"</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">[</span>\n   <span class="token string">"import"</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n     <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd-mobile"</span><span class="token punctuation">,</span>\n     <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"components"</span><span class="token punctuation">,</span>\n     <span class="token string">"camel2DashComponentName"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token string">"antd-mobile"</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>文件目录如下</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 323px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 169.3498452012384%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAiCAIAAADQyG7qAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC+ElEQVRIx5VV2W7TQBTNbwBq0tSJHdvjbbyNd3sSr4mzlbRViApVEUKIF9545Rf4Yq7TAuIB25Xu6/FZ5tzrgayT/f0nnYTxPF8UK5pW2PKGV7MrFo2nYvsMkGK5cR6XO5NEfpyrhseJOi8ZMDOkt88AqbYdpEm1t9wkTApeMsesxHAKDCtg+FDLDFhBhXn84iw3ETajtGyUJ2mVFmse4dFEaJM9mSlTXqFZlNc1Ui3bi8AzUkxBNhhO6vDMcDInqEhzl7cf3HAe0yJZlDOEL8Zcd2CTmczyimK41duTqjuAlzG5bFX7D5gTVYTJYn1oZLuRpFl9kH/B2Pa3p4+2F6fFyiDBC8AgW8KELvdINb1wDuG/hFlQwfPy5l7RCU1LCPn1aNrH9pm5AXvF/mg6YZKWxE8imkPgnfhnZpCdbm4V3QG85UZBkk55uRvMnAPTILB3j7YLgdXzbAm16bMbfwJz4Kk00zVsXzO9nq/17FnW3Xx3pxku0Ppx5sdpr5V8Ttv0y6e0s4p4yXA8ewGzqpnbqkZa0zBseuC5H5iTppJuC9rPdWg4ARyTRb5qyPsEBk8ymqD310JGsWqEbkhhJUFOL2bo05ARH65ZGsqmO08WhRvMR4wwYvhuMA+vBPEWd5oZeCHV7QAaVtU7CA+UQ09aBsCGZodZnXsxdcKU+HM3SoOk0EnEinr7DLAVaWb87Xt+e6q9uF7vj/nqsCj3q+3RcKigEDgy/5vmAPKSrpjB8nAPmv0ohZIEcSZrNsQBR6pl4J0lTtTOi3ED9QySjHgxbDU09LwYbdOUBE4sXIH67kExHCegry4mb0bTXmk/1VNUrajYADPQKphw/Y7Jb2bL3xwfwDNtzn3d83fVgOFoNGfocNIsD26IbvuXE/Hsqp9sGdvZ5qAaDkQFYDB8yfCdthuwgLCIo83pM6iF3wUEXiy35WoHKtqVD847IK0zFEcWUh1YSeCHzsL7sV2L2YAvGPHH19l1pQa0Xm328H8Ew8MrkN1h+xe7D2/fwFmjrAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 14 30 51"\n        title=""\n        src="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png"\n        srcset="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-82faf.png 200w,\n/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png 323w"\n        sizes="(max-width: 323px) 100vw, 323px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id="桌面移动端分离打包"><a href="#%E6%A1%8C%E9%9D%A2%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>桌面移动端分离打包</h2>\n<p>考虑到桌面移动端的复用逻辑较多，所以将桌面移动端写在一个项目中，这里就涉及到了多平台分离打包</p>\n<h3 id="文件目录"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录</h3>\n<p>总体上来说分为 3 个文件夹，分别是公用组件、移动端组件、桌面端组件</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 355px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 147.88732394366195%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAIAAACjcKk8AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACmklEQVQ4y42UWW/bMBCE/S+KJqlt2bpFUhJ1UyKp247TxEkQJ216IEALBEXQvrY/v+s2zzaBfR1pZvZbTmyb0muW3ogsq3WbvNOs2dLRDE9lJiDwaFz0YxAzEmY+zZGfLC2sKMYuibuLO5rxvKx5Mxa8Nd1griJemMiwcSb6YXsfxkUpuneaeTY3pwtrrruHZ+KSlFDG2s1wtWNiaMcrmoqs7JKisVFyeCagDFMuV9erm0+yuxgv7trV9vL28fxyh2mJwuLATJYW2I7bET99ZwVfeX50MtWh8+nCPp4ZijVsPxfV9v46jMukEChIDJsotQ1i2wvSahSrWyhMNKNsV/u2dVdFjCwniluy/VbnrE+ZgKqVIbGwg6Jq6Pkg44xnZW04PuwPRokwCCnXdw6uRDOAZ8sLzzRTBdK9bc0Ixw3+8VO6hIl2zKsGkleyh+8eTr4vzHJ8Kpvxw4MfZLweMrb3j8P0qHPAEzsunsfvteY5ipJSDoB3KXtIftT5ZAGrchDqH6qvf9K0kN0aZCczQ3FVWDNREGQd7xImGW99mkGFRwO/iqcmDnSr1peU1SVvGe/aYeNgetw23PPbGVq31q8nh8S1bAe4aqhKcVVYt4OSFzUP/KikCaNJaThEFRLYSn/1SPPBJfTN6eJ0ZsBVwahkRguA5Bw/v3CARLZjxmomuqJqlCCBk4zqev1xF9Ac2AIZEB7EhRIkroe1ZLvsXuI4qWoAc4CXDGKrQIJcJ5jLijzcsFzIfg2/BbdKhf0jjBjVGN5+CYJEtCt4wDUF5avYsj3S7OTn30VRAZ7Qk+J78J8wBIR1ppnwDtRwFXW3dpAKYSDWUU69rfBIUhVVHWUVPGZQ2PE9A54nc7wZXMAzyoduPIeTVsTzL9kaOuxEzI+RAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 14 31 53"\n        title=""\n        src="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png"\n        srcset="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-d1052.png 200w,\n/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png 355w"\n        sizes="(max-width: 355px) 100vw, 355px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3 id="优化环境变量配置"><a href="#%E4%BC%98%E5%8C%96%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化环境变量配置</h3>\n<p>将所有的环境变量整合到一个文件</p>\n<p>boot\\internals\\scripts\\get-build-map.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4909894439332563000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\nconst prodEnv = process.env.PROD_ENV || \'pc\';\nconst globalJSON = require(path.resolve(process.cwd(), \'global.json\'));\n\nconst varsEnv = process.env.SERVER || \'master\';\nconst globalVars = globalJSON.runtime[varsEnv];\n\nconst RESOLVE_MODULES_MAP = {\n  pc: [\'src/common\', \'src/pc\', \'node_modules\'],\n  mobile: [\'src/common\', \'src/mobile\', \'node_modules\']\n};\n\nconst OUTPUT_PATH_MAP = {\n  pc: \'build/pc\',\n  mobile: \'build/mobile\'\n};\n\nconst resolveModules = RESOLVE_MODULES_MAP[prodEnv];\nconst outputPath = OUTPUT_PATH_MAP[prodEnv];\n\nconst INDEX_ENTRY_MAP = {\n  pc: \'src/pc/index.js\',\n  mobile: \'src/mobile/index.js\'\n};\n\nconst INDEX_HTML_MAP = {\n  pc: \'src/pc/index.html\',\n  mobile: \'src/mobile/index.html\'\n};\n\nconst indexEntry = INDEX_ENTRY_MAP[prodEnv];\nconst indexHtml = INDEX_HTML_MAP[prodEnv];\n\nmodule.exports = {\n  resolveModules,\n  outputPath,\n  indexEntry,\n  indexHtml,\n  globalVars\n};`, `4909894439332563000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> prodEnv <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROD_ENV</span> <span class="token operator">||</span> <span class="token string">\'pc\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> varsEnv <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SERVER</span> <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalVars <span class="token operator">=</span> globalJSON<span class="token punctuation">.</span>runtime<span class="token punctuation">[</span>varsEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">RESOLVE_MODULES_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'src/common\'</span><span class="token punctuation">,</span> <span class="token string">\'src/pc\'</span><span class="token punctuation">,</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'src/common\'</span><span class="token punctuation">,</span> <span class="token string">\'src/mobile\'</span><span class="token punctuation">,</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">OUTPUT_PATH_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'build/pc\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'build/mobile\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resolveModules <span class="token operator">=</span> <span class="token constant">RESOLVE_MODULES_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> outputPath <span class="token operator">=</span> <span class="token constant">OUTPUT_PATH_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">INDEX_ENTRY_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'src/pc/index.js\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'src/mobile/index.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">INDEX_HTML_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'src/pc/index.html\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'src/mobile/index.html\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> indexEntry <span class="token operator">=</span> <span class="token constant">INDEX_ENTRY_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> indexHtml <span class="token operator">=</span> <span class="token constant">INDEX_HTML_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  resolveModules<span class="token punctuation">,</span>\n  outputPath<span class="token punctuation">,</span>\n  indexEntry<span class="token punctuation">,</span>\n  indexHtml<span class="token punctuation">,</span>\n  globalVars\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用环境变量进行分离打包"><a href="#%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用环境变量进行分离打包</h3>\n<p>boot\\internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77764691684762880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\noutput: Object.assign({ // Compile into js/build.js\n // 根据环境变量输出到不同平台\n path: path.resolve(process.cwd(), buildMap.outputPath),\n publicPath: \\`\\${buildMap.globalVars.customerServiceOrigin}/im/\\`,\n}, options.output), // Merge with env dependent settings\n\nresolve: {\n  // 根据环境变量决定相对路径的查找方式\n  modules: buildMap.resolveModules,\n},`, `77764691684762880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\noutput<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// Compile into js/build.js</span>\n <span class="token comment">// 根据环境变量输出到不同平台</span>\n path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">,</span>\n publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMap<span class="token punctuation">.</span>globalVars<span class="token punctuation">.</span>customerServiceOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/im/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Merge with env dependent settings</span>\n\nresolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 根据环境变量决定相对路径的查找方式</span>\n  modules<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>resolveModules<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以下都是根据环境变量输出到不同平台的文件夹下</p>\n<p>boot\\internals\\webpack\\webpack.dev.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60979644606869510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\n// Add hot reloading in development\nentry: [\n  \'eventsource-polyfill\', // Necessary for hot reloading with IE\n  \'webpack-hot-middleware/client?reload=true\',\n  path.join(process.cwd(), buildMap.indexEntry), // Start with src/index.js\n],\n\nnew HtmlWebpackPlugin({\n   inject: true, // Inject all files that are generated by webpack, e.g. bundle.js\n   template: buildMap.indexHtml,\n}),`, `60979644606869510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Add hot reloading in development</span>\nentry<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n  <span class="token string">\'eventsource-polyfill\'</span><span class="token punctuation">,</span> <span class="token comment">// Necessary for hot reloading with IE</span>\n  <span class="token string">\'webpack-hot-middleware/client?reload=true\'</span><span class="token punctuation">,</span>\n  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Start with src/index.js</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n\n<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Inject all files that are generated by webpack, e.g. bundle.js</span>\n   template<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>indexHtml<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>boot\\internals\\webpack\\webpack.prod.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22441748682576380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\nentry: {\n   bundle: [\'runtime/polyfill\', path.join(process.cwd(), buildMap.indexEntry)],\n},\n\nnew HtmlWebpackPlugin({\n  template: buildMap.indexHtml,\n  minify: {\n    removeComments: true,\n    collapseWhitespace: true,\n    removeRedundantAttributes: true,\n    useShortDoctype: true,\n    removeEmptyAttributes: true,\n    removeStyleLinkTypeAttributes: true,\n    keepClosingSlash: true,\n    minifyJS: true,\n    minifyCSS: true,\n    minifyURLs: true,\n  },\n  inject: true,\n}),`, `22441748682576380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nentry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n   bundle<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'runtime/polyfill\'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  template<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>indexHtml<span class="token punctuation">,</span>\n  minify<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeRedundantAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    useShortDoctype<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeEmptyAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeStyleLinkTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    keepClosingSlash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyJS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyURLs<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化打包脚本"><a href="#%E4%BC%98%E5%8C%96%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化打包脚本</h3>\n<h4 id="优化编译脚本"><a href="#%E4%BC%98%E5%8C%96%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化编译脚本</h4>\n<p>以下是其中一个脚本，主要是根据参数传递来进行打包</p>\n<p>boot/scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90742948208678830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst argv = require(\'yargs\').argv;\nconst \\$_SERVER = argv.server || \'master\';\nconst \\$_NODE_ENV = argv.env || \'production\';\nconst \\$_PROD_ENV = argv.prod || \'pc\';\n\nshelljs.exec(\n  \\`rimraf ./build/\\${\\$_PROD_ENV}/* && cross-env NODE_ENV=\\${\\$_NODE_ENV} SERVER=\\${\\$_SERVER} PROD_ENV=\\${\\$_PROD_ENV} webpack --config boot/internals/webpack/webpack.prod.babel.js --color --progress\\`,\n  { stdio: \'inherit\' }\n);`, `90742948208678830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_SERVER <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_NODE_ENV <span class="token operator">=</span> argv<span class="token punctuation">.</span>env <span class="token operator">||</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_PROD_ENV <span class="token operator">=</span> argv<span class="token punctuation">.</span>prod <span class="token operator">||</span> <span class="token string">\'pc\'</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>\n  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rimraf ./build/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_PROD_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/* &amp;&amp; cross-env NODE_ENV=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_NODE_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> SERVER=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> PROD_ENV=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_PROD_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> webpack --config boot/internals/webpack/webpack.prod.babel.js --color --progress</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span> <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="多平台并行编译"><a href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%B9%B6%E8%A1%8C%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多平台并行编译</h4>\n<p>采用 concurrently 三方库进行多平台的编译，唯一的缺点就是进度会刷屏，暂时未找到解决方案</p>\n<p>global.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81395340419542990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;APPS&quot;: {\n &quot;dev&quot;: [\n   &quot;pc&quot;, &quot;mobile&quot;\n ],\n}`, `81395340419542990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"APPS"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n   <span class="token string">"pc"</span><span class="token punctuation">,</span> <span class="token string">"mobile"</span>\n <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>boot\\scripts\\pre-build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45684859959107600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst argv = require(\'yargs\').argv;\nconst path = require(\'path\');\nconst \\$_SERVER = argv.server || \'master\';\nconst APPS = require(path.resolve(process.cwd(), \'global.json\')).APPS[\\$_SERVER];\n\nconsole.log(\\`build environment: \\${\\$_SERVER}\\`, \\`build apps: \\${APPS}\\`);\n\nconst cmd = APPS.map((APP) => \\`&quot;node boot/scripts/build --server=\\${\\$_SERVER} --prod=\\${APP}&quot;\\`);\n\n// 进度输出刷屏，待优化\n// https://github.com/kimmobrunfeldt/concurrently/issues/188\n// https://github.com/kimmobrunfeldt/concurrently/issues/85\nshelljs.exec(\\`concurrently \\${cmd.join(\' \')}\\`, { stdio: \'inherit\' });`, `45684859959107600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_SERVER <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">APPS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">APPS</span><span class="token punctuation">[</span>$_SERVER<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">build environment: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">build apps: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APPS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token constant">APPS</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">APP</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"node boot/scripts/build --server=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --prod=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 进度输出刷屏，待优化</span>\n<span class="token comment">// https://github.com/kimmobrunfeldt/concurrently/issues/188</span>\n<span class="token comment">// https://github.com/kimmobrunfeldt/concurrently/issues/85</span>\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">concurrently </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cmd<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里调用会并行编译 pc、mobile 两个平台的代码</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53074003936510270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;scripts&quot;: {\n &quot;build:dev&quot;: &quot;node boot/scripts/pre-build --server=dev&quot;,\n}`, `53074003936510270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n <span class="token property">"build:dev"</span><span class="token operator">:</span> <span class="token string">"node boot/scripts/pre-build --server=dev"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>编译速度：2 个平台同时编译的情况下第一次 30~40s，第二次 8~10s</p>\n<h2 id="分离打包的-nginx-配置"><a href="#%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85%E7%9A%84-nginx-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分离打包的 nginx 配置</h2>\n<h3 id="nginx-配置"><a href="#nginx-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 配置</h3>\n<p>由于之前第三方平台只用引入一个文件，这里的异步加载需要引入不止一个文件，所以要改下 nginx 配置，这里和主产品在一个域名下，故这里用前缀 /im/ 来代表加载客服组件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58532077674586080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`set \\$root_dir &quot;/home/frontend/pony/pc/&quot;;\n# 根据 \\$http_user_agent 来判断加载哪个目录下的脚本\nif ( \\$http_user_agent ~ &quot;(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)&quot; )\n{\n   set \\$root_dir &quot;/home/frontend/pony/mobile/&quot;;\n}\n\n# 不缓存 bundle.js 入口文件，防止页面刷新后不是最新代码\nlocation = /im/bundle.js {\n   expires -1;\n   add_header Pragma no-cache;\n   alias &quot;\\${root_dir}/bundle.js&quot;;\n}\n\n# 其他文件照常做缓存处理，并映射到 /im 路径\nlocation ^~ /im {\n alias \\$root_dir;\n}`, `58532077674586080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token variable">$root_dir</span> <span class="token string">"/home/frontend/pony/pc/"</span><span class="token punctuation">;</span>\n<span class="token comment"># 根据 $http_user_agent 来判断加载哪个目录下的脚本</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$http_user_agent</span> ~ <span class="token string">"(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)"</span> <span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n   <span class="token builtin class-name">set</span> <span class="token variable">$root_dir</span> <span class="token string">"/home/frontend/pony/mobile/"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 不缓存 bundle.js 入口文件，防止页面刷新后不是最新代码</span>\nlocation <span class="token operator">=</span> /im/bundle.js <span class="token punctuation">{</span>\n   expires -1<span class="token punctuation">;</span>\n   add_header Pragma no-cache<span class="token punctuation">;</span>\n   <span class="token builtin class-name">alias</span> <span class="token string">"<span class="token variable">${root_dir}</span>/bundle.js"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 其他文件照常做缓存处理，并映射到 /im 路径</span>\nlocation ^~ /im <span class="token punctuation">{</span>\n <span class="token builtin class-name">alias</span> <span class="token variable">$root_dir</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="webpack-配合修改"><a href="#webpack-%E9%85%8D%E5%90%88%E4%BF%AE%E6%94%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 配合修改</h3>\n<p>webpack 也需要做下 public 的映射，否则资源访问不到，注意这里的 <code class="language-text">buildMap.globalVars.customerServiceOrigin</code> 代表主产品的域名</p>\n<p>webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81089779873946200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: Object.assign({\n path: path.resolve(process.cwd(), buildMap.outputPath),\n publicPath: \\`\\${buildMap.globalVars.customerServiceOrigin}/im/\\`,\n}, options.output),`, `81089779873946200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">,</span>\n publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMap<span class="token punctuation">.</span>globalVars<span class="token punctuation">.</span>customerServiceOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/im/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="代码分层"><a href="#%E4%BB%A3%E7%A0%81%E5%88%86%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码分层</h2>\n<p>这里主要对 IM 层、消息提醒功能做了分层。其他的桌面与移动端复用率不高，没有分层</p>\n<h3 id="im-层"><a href="#im-%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IM 层</h3>\n<p>主要把所有与第三方提供商、调用后台的接口整合到一个类中，各种消息的回调采用消息订阅的方式进行分发调用</p>\n<h3 id="消息提醒类"><a href="#%E6%B6%88%E6%81%AF%E6%8F%90%E9%86%92%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息提醒类</h3>\n<p>将公共的消息提醒逻辑抽成一个类</p>\n<p>src\\common\\utils\\TitleMessage\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14241075053095420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import utils from \'utils\';\nimport { filePrefix } from \'containers/App/constants\';\n\nimport tungeeLogo from \'./images/tungee-logo.jpg\';\n\nclass TitleMessage {\n  constructor() {\n    // 闪烁前标题\n    this.originTitle = document.title;\n    // 计数\n    this.count = 0;\n    // 计时器\n    this.timer = null;\n    // 提示音\n    this.alertPlayer = document.createElement(\'audio\');\n    this.alertPlayer.src = \\`\\${filePrefix}message_alert.wav\\`;\n    this.alertPlayer.style.display = \'none\';\n    document.body.appendChild(this.alertPlayer);\n  }\n\n  start(msg) {\n    // 提示音\n    this.alertPlayer.play();\n    // 网页提示\n    utils.showNotification(msg, {\n      icon: tungeeLogo\n    });\n    this.stop();\n    this.timer = setInterval(() => {\n      if (this.count % 2 === 0) {\n        document.title = msg;\n      } else {\n        document.title = this.originTitle;\n      }\n      this.count += 1;\n    }, 1000);\n  }\n\n  stop() {\n    if (this.timer) {\n      clearInterval(this.timer);\n      this.timer = null;\n      this.count = 0;\n    }\n    document.title = this.originTitle;\n  }\n}\n\nexport default TitleMessage;`, `14241075053095420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">\'utils\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> filePrefix <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'containers/App/constants\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> tungeeLogo <span class="token keyword">from</span> <span class="token string">\'./images/tungee-logo.jpg\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">TitleMessage</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 闪烁前标题</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle <span class="token operator">=</span> document<span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n    <span class="token comment">// 计数</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 计时器</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token comment">// 提示音</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'audio\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">message_alert.wav</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 提示音</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 网页提示</span>\n    utils<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      icon<span class="token punctuation">:</span> tungeeLogo\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        document<span class="token punctuation">.</span>title <span class="token operator">=</span> msg<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> TitleMessage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="小程序部署代理配置"><a href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小程序部署代理配置</h2>\n<p>小程序用到 webview 限制了接口调用必须是第三方的域名，需要更改第三方域名指向的服务器配置</p>\n<p>这里以 nginx 为例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12411834848368740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location ^~ /im {\n  # 反代到组件所在的域名，并把参数传递过去\n  proxy_pass 组件所在的域名/im/\\$1;\n  # 传递 http_user_agent 参数，否则不能判断移动端\n  proxy_set_header User-Agent \\$http_user_agent;\n}`, `12411834848368740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">location ^~ /im <span class="token punctuation">{</span>\n  <span class="token comment"># 反代到组件所在的域名，并把参数传递过去</span>\n  proxy_pass 组件所在的域名/im/<span class="token variable">$1</span><span class="token punctuation">;</span>\n  <span class="token comment"># 传递 http_user_agent 参数，否则不能判断移动端</span>\n  proxy_set_header User-Agent <span class="token variable">$http_user_agent</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="优化效果"><a href="#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化效果</h1>\n<h2 id="优化前"><a href="#%E4%BC%98%E5%8C%96%E5%89%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化前</h2>\n<p>优化前包大小如下图，首页/全部加载大小都为 644.58kb。</p>\n<p>加载速度（不限速）540ms，3g low（限速 120 kb/s）40.75s。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-72d75.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 48.645833333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB8klEQVQoz02Q23OaYBDF/cf7kIe+Ne1Dm5e00bHqNE2LRo03vGuEIkQLKqLggILcRKMoiCi2X9KpyZkzszs785vdPb6l3HGthbMxds725IO78/bu42I+HDDdDiVPJcu2wNyx7b3rAIPeNE2fvV54B3d/8GaarIi8IgnieNTCUapNPDRRpF7huf6YZ/nRUBaFAd1u1PL3VXjYbxvGzPfnWUfPMwxFngq9bpumycmEk6djXVc1TVktF7IE2C5Dt+rlZDwajEPBRjWla8p/+Hh03d1z9TzvACZb27KstWVtTHOlqxLLkARWzqevs8kIcCHzXTvBQK7r4jhOEATHcYIgOFvLmOnmajmgWy2iht7DpRyUgIKxH1exmy/peFiTxRfYcZweTVMURZIkwzC2vZnPZ8ZMxdHiA1bB0VIlH7u7/ZqAAnHIn05ENGny+mznX+8dns7WVKnzG+v3WuyAAjxSTRdzPzOJyF0smIQCcOqb9vrn1SPIT9HVqSqLI7YLyBHbHzIUhuSbSIH4VcYacDjw4fLibejqPOx/Pz1tBri9tddrkJClKRJSzxbhqMCzDN0uZG4atQxazzbRAoaWMvFQAvJ/PH8j8KOXzTvnSSBzcczVyoly4bZLYul4CE5dl+AogFvNKlLPhf3vLj+dfb44k8TxX9Ge/9+DNMidAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 10 25 53"\n        title=""\n        src="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-fee1c.png"\n        srcset="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-a67b7.png 200w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-0b187.png 400w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-fee1c.png 800w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-b1a91.png 1200w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-95179.png 1600w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-72d75.png 1920w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-ad506.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 38.81278538812785%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/klEQVQY06WQy07FMAxE8///w5JfYIMQlwVXLPoiTdqmsfPsg2nCAiR2HFXuWPFIHouUs1FKdt04jm3bNk1zf/+4Pz13r7e+76WUwzDgSSk1z/P6G3GeJ1kL0yilKszTNGk1afwmGKbCZ8EYY61d7Tfi8UG9vawxO2LywccUz784jmPfd9TSnFWIURoL1xZjDBQ9xUwhccwxpW3bcs61gpRSTpmDp+DROOeE80S8Yh9XYOed9/OyMDNSQWPnZVmgsScRLcasREjjmAUxIzOe4Qze1w9zaGvFFbTWiI5pjMFvClhVnP/gMiMV8lyhQ/gpqr5uGGIYdWKHqDV9vcIXe7DLvuDDBk0AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 25 47"\n        title=""\n        src="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-fee1c.png"\n        srcset="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-a67b7.png 200w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-0b187.png 400w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-fee1c.png 800w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-ad506.png 1095w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-74b93.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 31.74366616989568%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA5ElEQVQY01WQ627DIAyF8/5vN2lTtU7aqi3N6CWEAL4CzYyWPzUf1sFY5ohh27ZHa/PF3a/Xafodx/Hz8H4+fjjnLracu91ufvbrc8R19X4Zph8ZT3y/eu9nK1qk2O9M5JyJ6L+biZhpz50uh8NreHtZQiJgBNpJiBkhI4oqixALSxesalpFqm2mQRRYcohpBYpICXlJOXRgiem+BDt2Ymc2T4DfczwHcCENRIJoz2VhLqqGCRsr3RhZc4ZsJhEAESyr6inIMehX4KG21qlNS3miVrOoGQugTdzbWiulPh61f3Ipf9oPVumHRIeSAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 14 46 52"\n        title=""\n        src="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-fee1c.png"\n        srcset="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-a67b7.png 200w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-0b187.png 400w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-fee1c.png 800w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-b1a91.png 1200w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-74b93.png 1342w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id="优化后"><a href="#%E4%BC%98%E5%8C%96%E5%90%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化后</h2>\n<h3 id="桌面端"><a href="#%E6%A1%8C%E9%9D%A2%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>桌面端</h3>\n<p>优化后，首页加载 107.08kb，全部加载 356.46kb。</p>\n<p>加载速度（不限速） 246ms，3g low （限速 120 kb/s）7s。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a0f42.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 48.42271293375394%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNklEQVQoz2WP209SARzH+Tt6rZ7aury4HnqqLVdrqd1zri22VsEEq9mgFplT09IWyzZZcXB0IkWkYgQEHRBIhHO4g1yEIFoIR87hcD+icE7EQ7X87rfvvi+f/b5fBkEUarkQ1dyiaJqiG2Tux5pC6ZVKvdI3fhCExQACSFoZAQAPCCJiYBV4LX6R5PDL/KE8I08UyWqhSVGNJt2kabJYTMwvJOfk3+WKCPjWB8y280JqURl4JnQ9nli5x5vguZkD9SvXiwwURTGcqNXIarVGbtbJQmEdMqUNUMvjak1So1uHjD/1hhgo+3rnrm2Q94XVLxMujzzf7OzGGKVSCcMwvK08QZRyORRGMnZHBoYzDjjrQFCnK21acgkeGW+w9NdYEJs1dAs+cqp8+NgGg/4jqrWa3q5UQwaDV6MJ6HR+rTao+xzU60Mqlevh8Lvus+CFyyYO+wEX7jhe2nsw/D+8VangTg+OuHHEk3e2z+VFTVaEL5g70fXxXJ/6Yi+fZTvaU95zwP8XpujfcLVessbfW+NKa0Jpjiug8BwUnLfGFiHPrNYuklueqJCpvpvuXbtD+zq+7YAbZUd+ybihhgkznLU6UDOYnBYlxsSpKWFCMBzhDPjOcF8ae65iJy/B/9Ruw2SjGi36LLlPvpx9Ne0N4R5ZanomOiKJTo55uPddzK6ZQ/1OS2+qEUCcOz5vl6HsB0nyqSmtdqM2N7b8KjY+7r0tWhudjAwyTZ2nxfvZ4ZXzeCPstP8CuQTKZbxKTaYAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 14 38 30"\n        title=""\n        src="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-fee1c.png"\n        srcset="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a67b7.png 200w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-0b187.png 400w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-fee1c.png 800w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-b1a91.png 1200w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-95179.png 1600w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a0f42.png 1902w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-e4a38.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 34.08736349453978%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABAklEQVQY021QW27DIBD0sXuZnqVH6Gf7k0iJmsh2eJhdXgu4dHDUr3aEBhjNLrNMvXcy5jHPy7Lcbl+Xy/X28Tmfz7iu6wpWSllr3X+YUMzk4NoOMBE5B2ZmzwPmQAzxD8LkS2epSWIuOZfS9r1974OPNdD22mquRcANjgodvtb26eWtv75L75FSzlnQ0EWmECgkjnlIIi762SnF2+KN9s75yCGllKc19uuyOauRKxywxo64hK8w9/tda83EG0Qi9VApJqbtpLUhP2YOnvArGBg+FGBqvIfGUKC31qQW6OgLQ61VikQpmnkUIxj/wnv/ZGxOWfPYSNlkzDP/EzhXEUT4AQlZjkeKWe+qAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 36 51"\n        title=""\n        src="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-fee1c.png"\n        srcset="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-a67b7.png 200w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-0b187.png 400w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-fee1c.png 800w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-b1a91.png 1200w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-e4a38.png 1282w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-166cd.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 37.20728534258456%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABGElEQVQY001Q7W7DIAzMo+4h97PPME390WnqtC6pugSS8GliTAKZqVStJ2TdYRt8bvZ910KMfT8MQ9d117b9fDv+vB9/21ZI2fe9lHKeZ2OMfYJzVk664WajtRjEf5rJnXvv+ZIfVUqFBwDgQUJtRiIIkLdtLyXnXEphwqyKe9y2LT+BFR+uaF5ey+GylZwcJo8EkWMcHPiYQkwsA61QSU05pIVSXlMkSuvWHC776WaCd0uMGKMHUFob5xyAHMdpmrVhW+zCKaXBgzDuS9pMuOJSx7Z6kqJ6Zm/TNHJFdQbQXa/WWUo0K8UrGAZBcbFIH6P/Nnjz1OSyIyL4Cv6PI8t4n8Jqg2EhjME5XBZeEqU6MyGeTTzb9Q9bC42MbmEgJwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 38 36"\n        title=""\n        src="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-fee1c.png"\n        srcset="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-a67b7.png 200w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-0b187.png 400w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-fee1c.png 800w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-166cd.png 1153w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3 id="移动端"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端</h3>\n<p>优化后，首页加载 105.89kb，全部加载 306.3kb。</p>\n<p>加载速度（不限速）236ms，3g low（限速 120 kb/s）6.98s。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-c3264.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 48.454688318491364%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACLElEQVQoz2WR3U9SARjG+Wf6A7pok3lTa627WtLUlWuGAw1lwNxcGFg6kSA+jthFBRMRQUSPWcSHIIgnioOCgMCBwznEOJRaCK44TtnoEGZX9Ox99179nj3PXtrJjyRVP6OoBkX9rp9WimlbBn6NhfVoSJeGtUhQm4bfYGGD2ZBXKUrPJYhoFJZJMUD53Wk/pp2dklSToxoXU0wtoZ9keEi955fFfFIcVmNBJR6aNuqz0klifCytkKOAEn8mJub1JVqpdESSJ9VqlSTJWq1WiOvRLVHcOwatDu84hGhgAtl8ErGxP3qx+bmjkWF8bfXQbitxH2GSCZxWLpePz1VpbtMiH9UhvpGY+3HgrSADiRC/KGwbCIK9oAV9KjroZiBiYYE/mGM+yJgXDmiNf6IuDr6tiTrY8XVezMVNePhBsGdz4a7PeHvRkFApCNlUjsNG73Ume3vSs9r9Vji3Mx13shJu7t76YNLDC1gYq0CbFbgOLsVNpqJl8SunP9vZkexipGaAb61wAlJ4TfehZRZk7QuA/T7jHRCga8RXzdrUS3lFMrrf14kybkTplz9PjqOtcBZWb79j7to5kQ8DUccQtNgBqq9IBG3L8PZckHixlhW8irI0+akZzL2O/Rc7pIrZmX9jD513Xum2qtp1U9fkua2Hh7s3CxtdqEf5qxFKJ+p5pBUmkpYM1HzPaMzFj7l44fdMp+6WfbZbmvXTI/ZLG4b2Fa2w2vChX34SxB86lbnYVroPKgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 40 29"\n        title=""\n        src="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-fee1c.png"\n        srcset="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-a67b7.png 200w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-0b187.png 400w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-fee1c.png 800w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-b1a91.png 1200w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-95179.png 1600w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-c3264.png 1909w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-7169a.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 34.113712374581944%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABC0lEQVQY01VQ2Y7EIAzr/3/haHdfVppuL0oIRzgCdEJH87AWVFWMLTtTSimGcMzzsW3rtj2fz795nh+P9ftn33el1LIs67oCAP6HMThd19Va0wDGmHyjyGXOXMRX/ikEa22MkYtgsOWDt7gWFkHpvTNz7Y2rzFpvLQvTKtcxLJW5DWqwrddahzjmit65SGJKKVoKGCKllFOa4VhQaQsnIZJHT44SuDDYnCexM6GMVlo756SMPrVFlKjSReobDRatOg7QcCqVYlRofkGTD5NE55INnPd7K81FL7ZEJF7nqboE5mwsvq0LsxwJ+GWW6V5C8V5yD4j+8x0TtB58hgO80tE7WaH4jkWmjMG/AM88kKE+GpBtAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 43 18"\n        title=""\n        src="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-fee1c.png"\n        srcset="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-a67b7.png 200w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-0b187.png 400w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-fee1c.png 800w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-7169a.png 1196w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-29961.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 36.02329450915141%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABAklEQVQY002Q227DIAxA8//ftodJ0x47bavWZCVAYoJvQDqTVlOPLLCNrwybkcCN0+zcNE3f5/Pn6ePr7f3ndBqnzjiO3vsQwvoEwOp8HG63277vS4wWAQCpAwlgOzSrPBtuNgUx3/lXHslailaj1faQUhuLsgixZEJWOZy1y/Haau3JWttGlIgTyUYCyIB3s0tmjRljttYMmVImZdpVRHjYW12wTL/XdYmIfaIYQ58fwBYZL5cYgnkM72eLWVJ6uayvjpYNB6tQVIO3vWaLcs5uT9YQ0b7p6pwNaB8QjwLWXlRXUo/yHmhQVbNZuM/xhPntpBUYkp1KpAfWqZVSiwLpHxBlj9DumN8wAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 44 43"\n        title=""\n        src="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-fee1c.png"\n        srcset="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-a67b7.png 200w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-0b187.png 400w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-fee1c.png 800w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-b1a91.png 1200w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-29961.png 1202w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1 id="优化总结"><a href="#%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化总结</h1>\n<p>待优化的点：组件化复用做的不够好、以原生方式写客服组件体积会更小等等</p>',
excerpt:"需求背景 需求背景接上文  记一次组件打包为链接的实践 框架搭建接上文  Webpack 脚手架搭建笔记——记一次新项目搭建 组件轻量化 在将客服组件上线后，由于未考虑到加载的组件包的大小，尤其是初始加载的包比较大，即使是压缩过初始加载也有 600 多 k…",timeToRead:12,tableOfContents:'<ul>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF">需求背景</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#%E7%BB%84%E4%BB%B6%E8%BD%BB%E9%87%8F%E5%8C%96">组件轻量化</a></li>\n<li><a href="/building-platform-lightweight-components/#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D">移动端适配</a></li>\n</ul>\n</li>\n<li><a href="/building-platform-lightweight-components/#%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94">方案调研</a></li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD">具体实施</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#%E7%BB%84%E4%BB%B6%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD">组件异步加载</a></li>\n<li><a href="/building-platform-lightweight-components/#%E8%BE%83%E5%A4%A7%E7%BB%84%E4%BB%B6%E9%A2%84%E5%8A%A0%E8%BD%BD">较大组件预加载</a></li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E7%B2%BE%E7%AE%80%E4%BE%9D%E8%B5%96%E5%BA%93">精简依赖库</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#%E6%89%93%E5%8C%85%E5%89%8D%E4%BE%9D%E8%B5%96">打包前依赖</a></li>\n<li><a href="/building-platform-lightweight-components/#%E6%89%93%E5%8C%85%E5%90%8E%E4%BE%9D%E8%B5%96">打包后依赖</a></li>\n<li><a href="/building-platform-lightweight-components/#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96">主要变化</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E7%BB%84%E4%BB%B6%E8%87%AA%E7%BC%96%E5%86%99">组件自编写</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#antd-%E5%BC%95%E5%85%A5%E6%96%B9%E5%BC%8F%E5%85%BC%E5%AE%B9">antd 引入方式兼容</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E6%A1%8C%E9%9D%A2%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85">桌面移动端分离打包</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95">文件目录</a></li>\n<li><a href="/building-platform-lightweight-components/#%E4%BC%98%E5%8C%96%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE">优化环境变量配置</a></li>\n<li><a href="/building-platform-lightweight-components/#%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85">使用环境变量进行分离打包</a></li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E4%BC%98%E5%8C%96%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC">优化打包脚本</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#%E4%BC%98%E5%8C%96%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC">优化编译脚本</a></li>\n<li><a href="/building-platform-lightweight-components/#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%B9%B6%E8%A1%8C%E7%BC%96%E8%AF%91">多平台并行编译</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85%E7%9A%84-nginx-%E9%85%8D%E7%BD%AE">分离打包的 nginx 配置</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#nginx-%E9%85%8D%E7%BD%AE">nginx 配置</a></li>\n<li><a href="/building-platform-lightweight-components/#webpack-%E9%85%8D%E5%90%88%E4%BF%AE%E6%94%B9">webpack 配合修改</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E4%BB%A3%E7%A0%81%E5%88%86%E5%B1%82">代码分层</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#im-%E5%B1%82">IM 层</a></li>\n<li><a href="/building-platform-lightweight-components/#%E6%B6%88%E6%81%AF%E6%8F%90%E9%86%92%E7%B1%BB">消息提醒类</a></li>\n</ul>\n</li>\n<li><a href="/building-platform-lightweight-components/#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE">小程序部署代理配置</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C">优化效果</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#%E4%BC%98%E5%8C%96%E5%89%8D">优化前</a></li>\n<li>\n<p><a href="/building-platform-lightweight-components/#%E4%BC%98%E5%8C%96%E5%90%8E">优化后</a></p>\n<ul>\n<li><a href="/building-platform-lightweight-components/#%E6%A1%8C%E9%9D%A2%E7%AB%AF">桌面端</a></li>\n<li><a href="/building-platform-lightweight-components/#%E7%A7%BB%E5%8A%A8%E7%AB%AF">移动端</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href="/building-platform-lightweight-components/#%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93">优化总结</a></li>\n</ul>',wordCount:{words:318},frontmatter:{date:"2019-10-29 09:51:53",path:"/building-platform-lightweight-components/",tags:"前端, 组件轻量化, webpack, 预研",title:"构建多平台轻量化组件的实践",draft:null,catalog_number:null}},nextPost:{html:'<p>接上文<a href="/webpack-upgrade-about-product/">Webpack 升级优化——记一次产品端升级</a></p>\n<p>最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点</p>\n<h1 id="babel-编译兼容-ie"><a href="#babel-%E7%BC%96%E8%AF%91%E5%85%BC%E5%AE%B9-ie" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel 编译兼容 IE</h1>\n<p>在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3629320964404336600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;env&quot;: {\n    &quot;production&quot;: {\n      &quot;only&quot;: [\n        &quot;src&quot;,\n        &quot;unicorn&quot;\n      ],\n      &quot;plugins&quot;: [\n        &quot;transform-react-remove-prop-types&quot;,\n        &quot;transform-react-constant-elements&quot;,\n        &quot;transform-react-inline-elements&quot;\n      ]\n    },\n  },\n  &quot;plugins&quot;: [\n    [\n      &quot;import&quot;,\n      {\n        &quot;libraryName&quot;: &quot;antd&quot;,\n        &quot;libraryDirectory&quot;: &quot;es&quot;,\n        &quot;style&quot;: true\n      }\n    ],\n    &quot;transform-decorators-legacy&quot;,\n    &quot;lodash&quot;\n  ],\n  &quot;presets&quot;: [\n    [\n      &quot;latest&quot;,\n      {\n        &quot;es2015&quot;: {\n          &quot;modules&quot;: false\n        }\n      }\n    ],\n    &quot;es2015-ie&quot;,\n    &quot;react&quot;,\n    &quot;stage-0&quot;\n  ]\n}`, `3629320964404336600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token string">"production"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token string">"only"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"src"</span><span class="token punctuation">,</span>\n        <span class="token string">"unicorn"</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"transform-react-remove-prop-types"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-constant-elements"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-inline-elements"</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"import"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n        <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"es"</span><span class="token punctuation">,</span>\n        <span class="token string">"style"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token string">"transform-decorators-legacy"</span><span class="token punctuation">,</span>\n    <span class="token string">"lodash"</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"latest"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"es2015"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          <span class="token string">"modules"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token string">"es2015-ie"</span><span class="token punctuation">,</span></span>    <span class="token string">"react"</span><span class="token punctuation">,</span>\n    <span class="token string">"stage-0"</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="脚本运行颜色"><a href="#%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C%E9%A2%9C%E8%89%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本运行颜色</h1>\n<p>在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上<code class="language-text">--color</code>参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68982366581009334000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\n\nshelljs.exec(\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\', {\n  stdio: \'inherit\'\n});`, `68982366581009334000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">shelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>  stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-加速构建"><a href="#webpack-%E5%8A%A0%E9%80%9F%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 加速构建</h1>\n<p>在 webpack.base.babel.js 文件中添加 hard-source-webpack-plugin 插件，启用了之后构建速度由第二次的 30~40s 缩短到第二次的 3~5s 左右</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76954205344289770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new HardSourceWebpackPlugin({\n  // Either an absolute path or relative to webpack\'s options.context.\n  cacheDirectory: path.resolve(process.cwd(), \'node_modules/.cache/hard-source/[confighash]\'),\n  // Either a string of object hash function given a webpack config.\n  configHash(webpackConfig) {\n    // node-object-hash on npm can be used to build this.\n    return require(\'node-object-hash\')({ sort: false }).hash({\n      webpackConfig,\n      globalVars,\n    });\n  },\n  // Either false, a string, an object, or a project hashing function.\n  environmentHash: {\n    root: process.cwd(),\n    directories: [],\n    files: [\'package-lock.json\', \'yarn.lock\'],\n  },\n  // An object.\n  info: {\n    // \'none\' or \'test\'.\n    mode: \'none\',\n    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n    level: \'debug\',\n  },\n  // Clean up large, old caches automatically.\n  cachePrune: {\n    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n    // be at least this (default: 2 days) old in milliseconds.\n    maxAge: 2 * 24 * 60 * 60 * 1000,\n    // All caches together must be larger than \\`sizeThreshold\\` before any\n    // caches will be deleted. Together they must be at least this\n    // (default: 50 MB) big in bytes.\n    sizeThreshold: 50 * 1024 * 1024,\n  },\n}),\n\n// 这里会对 svg 生成造成影响，暂时关闭\n// You can optionally exclude items that may not be working with HardSource\n// or items with custom loaders while you are actively developing the\n// loader.\n// new HardSourceWebpackPlugin.ExcludeModulePlugin([\n//   {\n//     // HardSource works with mini-css-extract-plugin but due to how\n//     // mini-css emits assets, assets are not emitted on repeated builds with\n//     // mini-css and hard-source together. Ignoring the mini-css loader\n//     // modules, but not the other css loader modules, excludes the modules\n//     // that mini-css needs rebuilt to output assets every time.\n//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,\n//   },\n// ]),`, `76954205344289770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n  cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/.cache/hard-source/[confighash]\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n  <span class="token function">configHash</span><span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      webpackConfig<span class="token punctuation">,</span>\n      globalVars<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n  environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'package-lock.json\'</span><span class="token punctuation">,</span> <span class="token string">\'yarn.lock\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// An object.</span>\n  info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// \'none\' or \'test\'.</span>\n    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Clean up large, old caches automatically.</span>\n  cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 这里会对 svg 生成造成影响，暂时关闭</span>\n<span class="token comment">// You can optionally exclude items that may not be working with HardSource</span>\n<span class="token comment">// or items with custom loaders while you are actively developing the</span>\n<span class="token comment">// loader.</span>\n<span class="token comment">// new HardSourceWebpackPlugin.ExcludeModulePlugin([</span>\n<span class="token comment">//   {</span>\n<span class="token comment">//     // HardSource works with mini-css-extract-plugin but due to how</span>\n<span class="token comment">//     // mini-css emits assets, assets are not emitted on repeated builds with</span>\n<span class="token comment">//     // mini-css and hard-source together. Ignoring the mini-css loader</span>\n<span class="token comment">//     // modules, but not the other css loader modules, excludes the modules</span>\n<span class="token comment">//     // that mini-css needs rebuilt to output assets every time.</span>\n<span class="token comment">//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,</span>\n<span class="token comment">//   },</span>\n<span class="token comment">// ]),</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-进度显示异常"><a href="#webpack-%E8%BF%9B%E5%BA%A6%E6%98%BE%E7%A4%BA%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 进度显示异常</h1>\n<p>在 npm run build 执行时 simple-progress-webpack-plugin 插件会不停的刷屏显示，造成不好的体验，所以暂时只把它写在 webpack.dev.babel.js 中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62662272835400890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new SimpleProgressWebpackPlugin({\n  format: \'minimal\',\n}),`, `62662272835400890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">SimpleProgressWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  format<span class="token punctuation">:</span> <span class="token string">\'minimal\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="lodash-插件优化异常"><a href="#lodash-%E6%8F%92%E4%BB%B6%E4%BC%98%E5%8C%96%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>lodash 插件优化异常</h1>\n<p>在开启 lodash-webpack-plugin 插件后，lodash.get 不能正常执行，加入 <code class="language-text">paths: true</code> 即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9018422041649110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Deep property path support for methods like _.get, _.has, & _.set.\n// lodash优化由592.53k到240k\nnew LodashModuleReplacementPlugin({\n  paths: true,\n}),`, `9018422041649110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Deep property path support for methods like _.get, _.has, &amp; _.set.</span>\n<span class="token comment">// lodash优化由592.53k到240k</span>\n<span class="token keyword">new</span> <span class="token class-name">LodashModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  paths<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上更新于<code class="language-text">2019-9-17 20:43:04</code></p>\n<hr>\n<h1 id="react-loadable-优化"><a href="#react-loadable-%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-loadable 优化</h1>\n<h2 id="withref-方法报错"><a href="#withref-%E6%96%B9%E6%B3%95%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>withRef 方法报错</h2>\n<p>当 react-loadable 应用到组件为 function 类型，此时 withRef 方法会报错，因为 function 组件是没有 ref 的，此时要做下兼容处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6306712039405471000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        const { isPureReactComponent, isReactComponent } = Component.prototype;\n        let refProps = null;\n        if (isPureReactComponent || isReactComponent) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `6306712039405471000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> isPureReactComponent<span class="token punctuation">,</span> isReactComponent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPureReactComponent <span class="token operator">||</span> isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          refProps <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>            <span class="token punctuation">}</span>\n<span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span><span class="token punctuation">;</span></span>        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="阻止-setstate"><a href="#%E9%98%BB%E6%AD%A2-setstate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>阻止 setState</h2>\n<p>因为组件卸载时继续网络请求会导致 setState 报错，因为采用的是 promise 方法，不能取消请求，所以需要在卸载时将 setState 置空，以下分别针对页面、组件级别将其置空</p>\n<h3 id="页面级别"><a href="#%E9%A1%B5%E9%9D%A2%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面级别</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46396523550312500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* eslint-disable no-param-reassign */\nimport React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        let refProps = null;\n        // 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空\n        if (Component.prototype && (Component.prototype.isPureReactComponent || Component.prototype.isReactComponent)) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n              if (!r) {\n                return;\n              }\n              const cb = r.componentWillUnmount;\n              r.componentWillUnmount = () => {\n                r.setState = () => {\n                  // eslint-disable-next-line no-useless-return\n                  return;\n                };\n                cb && cb.call(r);\n              };\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `46396523550312500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* eslint-disable no-param-reassign */</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token comment">// 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isPureReactComponent <span class="token operator">||</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          refProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">const</span> cb <span class="token operator">=</span> r<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              r<span class="token punctuation">.</span><span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                r<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                  <span class="token comment">// eslint-disable-next-line no-useless-return</span></span><span class="gatsby-highlight-code-line">                  <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>              <span class="token punctuation">}</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="组件级别"><a href="#%E7%BB%84%E4%BB%B6%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件级别</h3>\n<p>src\\runtime\\preventSetState.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34903765307751567000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\n\nexport default function preventSetState(WrappedComponent) {\n  return class Hoc extends React.PureComponent {\n    componentWillUnmount = () => {\n      this.wrappedComponent.setState = () => {\n        // eslint-disable-next-line no-useless-return\n        return;\n      };\n    };\n\n    render() {\n      return (\n        <WrappedComponent\n          ref={(r) => {\n            this.wrappedComponent = r;\n          }}\n          {...this.props}\n        />\n      );\n    }\n  };\n}`, `34903765307751567000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Hoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// eslint-disable-next-line no-useless-return</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token operator">&lt;</span>WrappedComponent\n          ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent <span class="token operator">=</span> r<span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span>\n          <span class="token punctuation">{</span><span class="token operator">...</span>this<span class="token punctuation">.</span>props<span class="token punctuation">}</span>\n        <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99071432676686430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\n@preventSetState\nexport default class Component extends React.PureComponent {}`, `99071432676686430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n@preventSetState\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34042946581329470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\nclass Component extends React.PureComponent {}\n\nexport default preventSetState(Component);`, `34042946581329470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>待拓展的功能：react-hook 替换 mobx、HTML 内实现 Loading 态或者骨架屏、动态 polyfill、编译到 ES2015+（提高运行效率）、LazyLoad、三方库 external 化</p>\n<h1 id="重置报错状态"><a href="#%E9%87%8D%E7%BD%AE%E6%8A%A5%E9%94%99%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重置报错状态</h1>\n<p>单个组件报错时不影响其他页面的加载</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88874656460043240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Component } from \'react\';\nimport PropTypes from \'prop-types\';\n\nimport styles from \'./styles.css\';\n\nclass ErrorBoundary extends Component {\n  state = {\n    hasError: false\n  };\n\n  componentWillReceiveProps() {\n    // 重置未报错状态\n    this.setState({\n      hasError: false\n    });\n  }\n\n  componentDidCatch(error) {\n    this.setState({\n      hasError: true\n    });\n\n    console.error(error);\n    if (window.__bl) {\n      window.__bl.error(error);\n    }\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className={styles.error}>\n          <div className={styles.title}>抱歉，页面出错了！</div>\n        </div>\n      );\n    }\n    return this.props.children;\n  }\n}\n\nErrorBoundary.propTypes = {\n  children: PropTypes.node\n};\n\nexport default ErrorBoundary;`, `88874656460043240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">\'prop-types\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.css\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    hasError<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 重置未报错状态</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      hasError<span class="token punctuation">:</span> <span class="token boolean">false</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      hasError<span class="token punctuation">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__bl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>__bl<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>error<span class="token punctuation">}</span><span class="token operator">></span>\n          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">></span>抱歉，页面出错了！<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nErrorBoundary<span class="token punctuation">.</span>propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>\n  children<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>node\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ErrorBoundary<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="stylelint-无效"><a href="#stylelint-%E6%97%A0%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stylelint 无效</h1>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87161664980792150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint src/**/*.css&quot;`, `87161664980792150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint src/**/*.css"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当在苹果电脑上运行以上命令时，没有任何效果，即使 css 格式错误也直接通过，同时提交代码前的报错信息也没有颜色，需要做下特殊处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10913343664836762000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint \\&quot;src/**/*.css\\&quot; --color&quot; # src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色\n&quot;lint&quot;: &quot;npm run lint:js && npm run lint:css&quot;,\n&quot;pre-commit&quot;: &quot;lint&quot;,`, `10913343664836762000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint <span class="token entity" title="\\&quot;">\\"</span>src/**/*.css<span class="token entity" title="\\&quot;">\\"</span> --color"</span> <span class="token comment"># src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色</span>\n<span class="token string">"lint"</span><span class="token builtin class-name">:</span> <span class="token string">"npm run lint:js &amp;&amp; npm run lint:css"</span>,\n<span class="token string">"pre-commit"</span><span class="token builtin class-name">:</span> <span class="token string">"lint"</span>,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>',
excerpt:"接上文 Webpack 升级优化——记一次产品端升级 最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点 babel 编译兼容 IE 在 .babelrc…",frontmatter:{date:"2019-10-10 21:46:40",path:"/webpack-template-new-project/",tags:"前端, 前端构建工具, webpack, 预研",title:"Webpack脚手架搭建笔记——记一次新项目搭建",draft:null}},prePost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>最近在做表单分享的需求，类似于问卷调查，需要在三端（桌面端、移动端、微信端）同时兼容</p>\n<h1 id="技术方案"><a href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术方案</h1>\n<ol>\n<li>我出的方案：采用原生语法新框架写，考虑到首屏渲染的问题未采用</li>\n<li>\n<p>主管出的方案：采用后端渲染模板的方式，最大化首屏加载速度，但有以下问题：</p>\n<ol>\n<li>后端渲染对服务器 CPU 的要求较高</li>\n<li>本来打算用 oss 来减少后端渲染，但考虑到表单经常变化，且分享的链接要尽可能的保持不变，这就限制了 oss 的使用</li>\n<li>同样由于分享的链接要尽可能的保持不变，在新的表单分享模板加入后需要后端刷数据，容错性较低</li>\n</ol>\n</li>\n<li>最终讨论结果：采用前后端分离的方式，用原生语法新框架写，需要考虑到版本兼容（新的模板数据和旧的模板数据要同时兼容，在接口里面加一个版本号）、模板枚举 wiki 的命名（减少沟通成本同时缩短分享链接的长度）、loading 页（首屏加载时间可能较长）</li>\n</ol>\n<h1 id="方案调研"><a href="#%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案调研</h1>\n<p>刚开始考虑到用官网的框架，但是由于官网的框架构建过程有太多冗余的东西、以及只能在 node v9.11.2 里面使用的原因，决定自己在 <a href="https://github.com/yeoman/generator-webapp" target="_blank" rel="nofollow noreferrer noopener">generator-webapp</a> 生成的框架上做一下改造，以下是改造的要点：</p>\n<ol>\n<li>资源文件 hash</li>\n<li>接口代理</li>\n<li>模板功能</li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="构建框架搭建"><a href="#%E6%9E%84%E5%BB%BA%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建框架搭建</h2>\n<h3 id="gulp-打包优化"><a href="#gulp-%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gulp 打包优化</h3>\n<p>gulpfile.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58596241468913115000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// generated on 2019-11-07 using generator-webapp 4.0.0-6\nconst { src, dest, watch, series, parallel, lastRun } = require(\'gulp\');\nconst gulpLoadPlugins = require(\'gulp-load-plugins\');\nconst browserSync = require(\'browser-sync\');\nconst del = require(\'del\');\n// const autoprefixer = require(\'autoprefixer\');\nconst cssnano = require(\'cssnano\');\nconst { argv } = require(\'yargs\');\nconst proxy = require(\'http-proxy-middleware\');\nconst postcssPresetEnv = require(\'postcss-preset-env\');\n\nconst config = require(\'./proxy.json\');\nconst globalJSON = require(\'./global.json\');\n\nconst \\$ = gulpLoadPlugins();\nconst server = browserSync.create();\n\nconst port = argv.port || config.port || 9000;\nconst buildPath = argv.buildPath || \'build\';\nconst varsEnv = argv.server || \'master\';\nconst globalVars = globalJSON.runtime[varsEnv];\nconst publicPath = argv.publicPath || \'/form\';\n\nconst isProd = process.env.NODE_ENV === \'production\';\nconst isTest = process.env.NODE_ENV === \'test\';\nconst isDev = !isProd && !isTest;\n\n// 配置反向代理\nconst middleware = config.proxies.map((item) =>\n  proxy(item.match, {\n    target: item.host,\n    changeOrigin: true\n  })\n);\n\nfunction styles() {\n  return src(\'app/styles/*.css\')\n    .pipe(\\$.if(!isProd, \\$.sourcemaps.init()))\n    .pipe(\n      \\$.postcss([\n        // autoprefixer(),\n        // 采用 postcss 最新语法\n        postcssPresetEnv({\n          stage: 0\n        })\n      ])\n    )\n    .pipe(\\$.if(!isProd, \\$.sourcemaps.write()))\n    .pipe(dest(\'.tmp/styles\'))\n    .pipe(server.reload({ stream: true }));\n}\n\nfunction scripts() {\n  return (\n    src(\'app/scripts/**/*.js\')\n      // plumber 插件防止 gulp 报错崩溃\n      .pipe(\\$.plumber())\n      .pipe(\\$.if(!isProd, \\$.sourcemaps.init()))\n      .pipe(\\$.babel())\n      .pipe(\\$.if(!isProd, \\$.sourcemaps.write(\'.\')))\n      .pipe(dest(\'.tmp/scripts\'))\n      .pipe(server.reload({ stream: true }))\n  );\n}\n\nconst lintBase = (files) => {\n  return src(files)\n    .pipe(\\$.eslint({ fix: true }))\n    .pipe(server.reload({ stream: true, once: true }))\n    .pipe(\\$.eslint.format())\n    .pipe(\\$.if(!server.active, \\$.eslint.failAfterError()));\n};\n\nfunction lint() {\n  return lintBase(\'app/scripts/**/*.js\').pipe(dest(\'app/scripts\'));\n}\n\nfunction lintTest() {\n  return lintBase(\'test/spec/**/*.js\').pipe(dest(\'test/spec\'));\n}\n\nfunction html() {\n  // 合成 js、css 过程中，要过滤掉模板编译文件夹的代码\n  // 注意这里的 useref 插件合成 js、css 有一个问题文件行尾必须为 crlf，否则此文件不能正常合成\n  // 可用 .editorconfig 来限制文件行尾符\n  return src([\'app/**/*.html\', \'.tmp/**/*.html\', \'!app/common/**/*.html\', \'!.tmp/common/**/*.html\'])\n    .pipe(\\$.useref({ searchPath: [\'.tmp\', \'app\', \'.\'] }))\n    .pipe(\\$.if(/\\.js\\$/, \\$.uglify({ compress: { drop_console: true } })))\n    .pipe(\\$.if(/\\.css\\$/, \\$.postcss([cssnano({ safe: true, autoprefixer: false })])))\n    .pipe(\n      \\$.if(\n        /\\.html\\$/,\n        \\$.htmlmin({\n          collapseWhitespace: true,\n          minifyCSS: true,\n          minifyJS: { compress: { drop_console: true } },\n          processConditionalComments: true,\n          removeComments: true,\n          removeEmptyAttributes: true,\n          removeScriptTypeAttributes: true,\n          removeStyleLinkTypeAttributes: true\n        })\n      )\n    )\n    .pipe(dest(buildPath));\n}\n\nfunction images() {\n  return src(\'app/images/**/*\', { since: lastRun(images) }).pipe(dest(\\`\\${buildPath}/images\\`));\n}\n\nfunction fonts() {\n  return src(\'app/fonts/**/*.{eot,svg,ttf,woff,woff2}\').pipe(\n    \\$.if(!isProd, dest(\'.tmp/fonts\'), dest(\\`\\${buildPath}/fonts\\`))\n  );\n}\n\nfunction extras() {\n  // 过滤掉模板编译文件夹的代码与 html 代码\n  return src([\'app/*\', \'!app/**/*.html\', \'!app/common\'], {\n    dot: true\n  }).pipe(dest(buildPath));\n}\n\nfunction clean() {\n  return del([\'.tmp\', \\`\\${buildPath}/*\\`]);\n}\n\nfunction measureSize() {\n  return src(\\`\\${buildPath}/**/*\\`).pipe(\\$.size({ title: \'build\', gzip: true }));\n}\n\nconst build = series(\n  clean,\n  parallel(lint, series(parallel(styles, scripts, fileVarInclude), html), images, fonts, extras),\n  revAll,\n  measureSize\n);\n\nfunction startAppServer() {\n  server.init({\n    notify: false,\n    port,\n    server: {\n      baseDir: [\'.tmp\', \'app\'],\n      routes: {\n        \'/node_modules\': \'node_modules\'\n      },\n      middleware\n    }\n  });\n\n  watch([\'app/**/*.html\', \'app/images/**/*\', \'.tmp/fonts/**/*\']).on(\'change\', server.reload);\n\n  watch(\'app/styles/*.css\', styles);\n  watch(\'app/scripts/**/*.js\', scripts);\n  watch(\'app/fonts/**/*\', fonts);\n  // 监控 html 编译模板改动\n  watch(\'app/**/*.html\', fileVarInclude);\n}\n\nfunction startTestServer() {\n  server.init({\n    notify: false,\n    port,\n    ui: false,\n    server: {\n      baseDir: \'test\',\n      routes: {\n        \'/scripts\': \'.tmp/scripts\',\n        \'/node_modules\': \'node_modules\'\n      }\n    }\n  });\n\n  watch(\'app/scripts/**/*.js\', scripts);\n  watch([\'test/spec/**/*.js\', \'test/index.html\']).on(\'change\', server.reload);\n  watch(\'test/spec/**/*.js\', lintTest);\n}\n\nfunction startDistServer() {\n  server.init({\n    notify: false,\n    port,\n    server: {\n      baseDir: buildPath,\n      routes: {\n        \'/node_modules\': \'node_modules\',\n        // 注意这里的别名也要配置，否则资源访问不到\n        [publicPath]: buildPath\n      },\n      middleware\n    }\n  });\n}\n\n// 资源 hash，注意要在最后一步，同时配置路径别名，注意所有的资源引用必须以 &quot;/&quot; 开头，否则别名替换不成功\nfunction revAll() {\n  return src(\\`\\${buildPath}/**\\`)\n    .pipe(\n      \\$.revAll.revision({\n        prefix: publicPath,\n        dontRenameFile: [/^\\/favicon.ico\\$/g, \'.html\', \'robots.txt\']\n      })\n    )\n    .pipe(\\$.revDeleteOriginal())\n    .pipe(dest(buildPath));\n}\n\nfunction fileVarInclude() {\n  return src(\'app/**/*.html\')\n    .pipe(\\$.plumber())\n    .pipe(\n      \\$.fileInclude({\n        prefix: \'@@\',\n        basepath: \'@root\',\n        // 环境变量注入\n        // 需要在公共的模板文件中注入此变量\n        // <script>\n        //   window.GLOBAL_VARS = @@GLOBAL_VARS;\n        // </script>\n        context: {\n          GLOBAL_VARS: JSON.stringify(globalVars)\n        }\n      })\n    )\n    .pipe(dest(\'.tmp\'))\n    .pipe(server.reload({ stream: true }));\n}\n\nlet serve;\nif (isDev) {\n  serve = series(clean, parallel(styles, scripts, fonts, fileVarInclude), startAppServer);\n} else if (isTest) {\n  serve = series(clean, scripts, startTestServer);\n} else if (isProd) {\n  serve = series(build, startDistServer);\n}\n\nexports.serve = serve;\nexports.build = build;\nexports.default = build;`, `58596241468913115000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// generated on 2019-11-07 using generator-webapp 4.0.0-6</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> series<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> lastRun <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> gulpLoadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-load-plugins\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'browser-sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'del\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const autoprefixer = require(\'autoprefixer\');</span>\n<span class="token keyword">const</span> cssnano <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'cssnano\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http-proxy-middleware\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> postcssPresetEnv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'postcss-preset-env\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./proxy.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">gulpLoadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> server <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> port <span class="token operator">=</span> argv<span class="token punctuation">.</span>port <span class="token operator">||</span> config<span class="token punctuation">.</span>port <span class="token operator">||</span> <span class="token number">9000</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> buildPath <span class="token operator">=</span> argv<span class="token punctuation">.</span>buildPath <span class="token operator">||</span> <span class="token string">\'build\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> varsEnv <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalVars <span class="token operator">=</span> globalJSON<span class="token punctuation">.</span>runtime<span class="token punctuation">[</span>varsEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> publicPath <span class="token operator">=</span> argv<span class="token punctuation">.</span>publicPath <span class="token operator">||</span> <span class="token string">\'/form\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> isTest <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'test\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> isDev <span class="token operator">=</span> <span class="token operator">!</span>isProd <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isTest<span class="token punctuation">;</span>\n\n<span class="token comment">// 配置反向代理</span>\n<span class="token keyword">const</span> middleware <span class="token operator">=</span> config<span class="token punctuation">.</span>proxies<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n  <span class="token function">proxy</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>match<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    target<span class="token punctuation">:</span> item<span class="token punctuation">.</span>host<span class="token punctuation">,</span>\n    changeOrigin<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">styles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/styles/*.css\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span><span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n        <span class="token comment">// autoprefixer(),</span>\n        <span class="token operator">/</span><span class="token operator">/</span> 采用 postcss 最新语法\n        <span class="token function">postcssPresetEnv</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          stage<span class="token punctuation">:</span> <span class="token number">0</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/styles\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">scripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">)</span>\n      <span class="token comment">// plumber 插件防止 gulp 报错崩溃</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">plumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/scripts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">lintBase</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">eslint</span><span class="token punctuation">(</span><span class="token punctuation">{</span> fix<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> once<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span>eslint<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>active<span class="token punctuation">,</span> $<span class="token punctuation">.</span>eslint<span class="token punctuation">.</span><span class="token function">failAfterError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">lint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">lintBase</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'app/scripts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">lintTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">lintBase</span><span class="token punctuation">(</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'test/spec\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 合成 js、css 过程中，要过滤掉模板编译文件夹的代码</span>\n  <span class="token comment">// 注意这里的 useref 插件合成 js、css 有一个问题文件行尾必须为 crlf，否则此文件不能正常合成</span>\n  <span class="token comment">// 可用 .editorconfig 来限制文件行尾符</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'.tmp/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/common/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!.tmp/common/**/*.html\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token string">\'app\'</span><span class="token punctuation">,</span> <span class="token string">\'.\'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\\.js$/</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> compress<span class="token punctuation">:</span> <span class="token punctuation">{</span> drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\\.css$/</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">cssnano</span><span class="token punctuation">(</span><span class="token punctuation">{</span> safe<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoprefixer<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span>\n        <span class="token regex">/\\.html$/</span><span class="token punctuation">,</span>\n        $<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          minifyCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          minifyJS<span class="token punctuation">:</span> <span class="token punctuation">{</span> compress<span class="token punctuation">:</span> <span class="token punctuation">{</span> drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          processConditionalComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          removeEmptyAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          removeScriptTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          removeStyleLinkTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/images/**/*\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> since<span class="token punctuation">:</span> <span class="token function">lastRun</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/images</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">fonts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/fonts/**/*.{eot,svg,ttf,woff,woff2}\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n    $<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> <span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/fonts\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dest</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/fonts</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">extras</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 过滤掉模板编译文件夹的代码与 html 代码</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/*\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/common\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    dot<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">measureSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">\'build\'</span><span class="token punctuation">,</span> gzip<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>\n  clean<span class="token punctuation">,</span>\n  <span class="token function">parallel</span><span class="token punctuation">(</span>lint<span class="token punctuation">,</span> <span class="token function">series</span><span class="token punctuation">(</span><span class="token function">parallel</span><span class="token punctuation">(</span>styles<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">,</span> images<span class="token punctuation">,</span> fonts<span class="token punctuation">,</span> extras<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  revAll<span class="token punctuation">,</span>\n  measureSize\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">startAppServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">,</span>\n    server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      baseDir<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token string">\'app\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      middleware\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'app/images/**/*\'</span><span class="token punctuation">,</span> <span class="token string">\'.tmp/fonts/**/*\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'change\'</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>reload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/styles/*.css\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">,</span> scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/fonts/**/*\'</span><span class="token punctuation">,</span> fonts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 监控 html 编译模板改动</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">startTestServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">,</span>\n    ui<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      baseDir<span class="token punctuation">:</span> <span class="token string">\'test\'</span><span class="token punctuation">,</span>\n      routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'/scripts\'</span><span class="token punctuation">:</span> <span class="token string">\'.tmp/scripts\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">,</span> scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">,</span> <span class="token string">\'test/index.html\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'change\'</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>reload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">,</span> lintTest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">startDistServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">,</span>\n    server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      baseDir<span class="token punctuation">:</span> buildPath<span class="token punctuation">,</span>\n      routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">,</span>\n        <span class="token comment">// 注意这里的别名也要配置，否则资源访问不到</span>\n        <span class="token punctuation">[</span>publicPath<span class="token punctuation">]</span><span class="token punctuation">:</span> buildPath\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      middleware\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 资源 hash，注意要在最后一步，同时配置路径别名，注意所有的资源引用必须以 "/" 开头，否则别名替换不成功</span>\n<span class="token keyword">function</span> <span class="token function">revAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span>revAll<span class="token punctuation">.</span><span class="token function">revision</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        prefix<span class="token punctuation">:</span> publicPath<span class="token punctuation">,</span>\n        dontRenameFile<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^\\/favicon.ico$/g</span><span class="token punctuation">,</span> <span class="token string">\'.html\'</span><span class="token punctuation">,</span> <span class="token string">\'robots.txt\'</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">revDeleteOriginal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">fileVarInclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">plumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span><span class="token function">fileInclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        prefix<span class="token punctuation">:</span> <span class="token string">\'@@\'</span><span class="token punctuation">,</span>\n        basepath<span class="token punctuation">:</span> <span class="token string">\'@root\'</span><span class="token punctuation">,</span>\n        <span class="token comment">// 环境变量注入</span>\n        <span class="token comment">// 需要在公共的模板文件中注入此变量</span>\n        <span class="token comment">// &lt;script></span>\n        <span class="token comment">//   window.GLOBAL_VARS = @@GLOBAL_VARS;</span>\n        <span class="token comment">// &lt;/script></span>\n        context<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          <span class="token constant">GLOBAL_VARS</span><span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>globalVars<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">let</span> serve<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>isDev<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>styles<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> fonts<span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">,</span> startAppServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isTest<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> startTestServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>build<span class="token punctuation">,</span> startDistServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nexports<span class="token punctuation">.</span>serve <span class="token operator">=</span> serve<span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>build <span class="token operator">=</span> build<span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>default <span class="token operator">=</span> build<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="文件目录结构"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录结构</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-0f2f0.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 455px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 154.2857142857143%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAfCAIAAABoLHqZAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACVklEQVQ4y5WVSW7cMBBFdRH3pJmUOFOkRM1St9pT2okRIIvkALn/BVINeB3TQC318ate/aKCKMwP55fj+kwKHiN2jLF/BblofvTrr8trv90wNYgazKxnBWFOlXLb45sbL7ado4zeK/eq4BghxE338k6EqeoeE3WIkGcFhxgTom7jZtzYDqvQzSkpfGc+JgUl8nfbgy2V9e6YfgFYGBcRVdH3d2W6cbkiovZh7u0c45Kb7fWnaYZx3rhuYBhfMUyYl9L0i6raupsTxL4gDhOcs1q//TXNCMyg5684xzjBont67sbV9WvBqiSn/jMXSYYvKlbGVc3o+gVTYIZ8gcU5dbypbAd7tu3kDxzEKMEyW/+oeoDO63byZxY8xPhbN7+NS0pknJGHY7q/R89v5v0Jz9d6e13SXFBhSl4xVUcZ8TEPohNKnq7sdtOyDrMSzBNEPeMdHEOc1lpOTWV6sAXOD97xDnYhYoxJKdvhAnsqWZVi7g3slBnjrO3qdoZV9dPFuslXvIsLlSQNxlW7wFVaNxJuvJ0jXGV5S8hwhoSemW5g8wDMh1mwDzGjSEmq7AAJgcPcnTIon5DdxZQgrbltF+sGUw+67qGosJ82D7QxZ6gy8ArM0na6GbhqICdwHv8XQwqDfYQLhGVJtTCNNJTKXfh52/BsxmkR7GOcp4Ut6MD1KLQo2MGDM3yTpmVwgIRRLBxc5DqcH4flCi8hNPwp7Y+2AZippHFT004QsmHe7juTtQ+wgpNMiRIRTXiVlwI0YVp6heQQZrFwedVRrsGNSQt/HM+r+gcaZzZfDs4qsgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 15 48 13"\n        title=""\n        src="/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-0f2f0.png"\n        srcset="/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-f5c73.png 200w,\n/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-799a4.png 400w,\n/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-0f2f0.png 455w"\n        sizes="(max-width: 455px) 100vw, 455px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id="代码优化"><a href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码优化</h2>\n<ol>\n<li>除了在使用大量原生语法外，利用 gulp-file-include 插件大量复用了模板代码，确保多次使用的 html 代码在模板代码文件夹下。</li>\n<li>\n<p>同时为了首屏加载速度，图片需要压缩，这里用了阿里云的 oss 图片压缩服务，代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31613023069971000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 参数的功能分别是调整宽度、质量、是否是渐进式、格式转换为 jpg\nfunction compressImg(oss, width = window.innerWidth) {\n return \\`\\${oss}?x-oss-process=image/resize,w_\\${width}/quality,q_50/interlace,1/format,jpg\\`;\n}`, `31613023069971000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 参数的功能分别是调整宽度、质量、是否是渐进式、格式转换为 jpg</span>\n<span class="token keyword">function</span> <span class="token function">compressImg</span><span class="token punctuation">(</span><span class="token parameter">oss<span class="token punctuation">,</span> width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oss<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?x-oss-process=image/resize,w_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/quality,q_50/interlace,1/format,jpg</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>尽量在各自对应的平台加载相应的代码，比如微信分享脚本只在微信端加载，背景图只在桌面端加载，图片压缩的宽度尽可能的小</li>\n</ol>\n<h1 id="加载效果"><a href="#%E5%8A%A0%E8%BD%BD%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加载效果</h1>\n<p>加载大小非自定义图片部分 28.4kb，自定义图片部分 57.5kb。</p>\n<p>加载速度（不限速）264ms，3g low（限速 120 kb/s）1.01s。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-c26ee.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 38.22505800464037%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABp0lEQVQY002Nj0vicBjG919fgdNCzQvKHwcHB0Ed1JVkRdN2rZmpc9bMzFrmlGbrh0xvszWnc23f9e2+GkUfXh6eF97nebGV5ZXE5laW2mfT9Nrv5WDAHwoGv4fmgn5/KBDw4bgP9/hmZn3+QCIeZ9PpzN+9PJViqFSOJDCOImunXDa5wzOZxMafb1PTHo8Hx3GkXq8XGaTvntiMn5C7VyUWTY1jrwp5jCFT60u/WHK7miFocndhMRyNRmOxWCQSCYfDSKMTkKWJbTa50SwzzYuyWCk1uCJ2nD38Oe8tFw5a9aqhdQFwHccBAFiWpaqqMwGttm2fc0fCZUmWBEngqyfF2jGLlXK5ev2sXi1IfNHsKxC+ffLFjrm/vRbK2ae2IN/fHFE0sZPE8vR+q8UPtEdDFZ0Xw3Vf4QcoDj8qkJqG2lfFF0PWtQ5N7a0ltjDm+lxRJMeQbf3BtY3x3eS7BSDXfq+YhOEbMDVHf7AHcrf3yEsNoX2H/VhdP6xU5KHWVDrKyER/wSsEEFrA/TcEQ9McDMdjjkbdwbPY64ha71Z/Fvv9hm78B0R1gs7qLKXOAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 16 27 42"\n        title=""\n        src="/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-fee1c.png"\n        srcset="/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-a67b7.png 200w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-0b187.png 400w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-fee1c.png 800w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-b1a91.png 1200w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-95179.png 1600w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-c26ee.png 1724w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-5fe3e.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 24.685314685314683%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAvElEQVQY021P2Y7EIAzr//9lpUIp5SyQhGOk9Y5m92ksZEUJjuPNO5dStPZOKd23U0qZU+f8jD7mnOMb/vsbCfU5ZQ6awkMaU2USrpmewsQivXd586cQ+TDzprS21p7G6BNkzHXhXcaEGBpRTKm1VkrBJOfMRBV4nuJcuOymldr3HTPvfQwhRhAQa22vtWopMGTm4ziwE8Lfo3sv3mfnNtghJwLPP6y1cBTcUIOhJCL8gd45h6h9DCzNKf0ArA0cKACop4UAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 16 28 14"\n        title=""\n        src="/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-fee1c.png"\n        srcset="/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-a67b7.png 200w,\n/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-0b187.png 400w,\n/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-fee1c.png 800w,\n/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-b1a91.png 1200w,\n/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-5fe3e.png 1430w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-4cbd1.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 41.47582697201018%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABFUlEQVQY01WRi26EIBBF/f9PbLJZH7AgCCqowG676RHbpL2AmbnzuAM2s1drWEKMgbVF752drPEWt5SUnjmVXMqzcP4Dpsk5HQf72FkXUkq5pGP3i5m2NRx73I8Ml/O2bcRzBVmN1mqaJpzyFznTO4SI6uv1ijHu+47hnLMVy7KQ0IihGwZB8VfF5y+w17DS5ypGEFJr3XVd3/fowTft/Y4vpcQ3xrgK7MvIPyMEhiSbhLZtkcU+7yyF6CrGcaQxZUxlKii+3oaZ6YIyISEEIWY5lfU4KnVem+d7v9/n6Hzr5nnIgCAVZaLeeyqRQRy++bjd7m0rldLQ/CXnjHyYQVrxYCRrJ+fnh9KjsW6eByF6jjwJ3G+x1cS1cLEYUwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 16 30 09"\n        title=""\n        src="/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-fee1c.png"\n        srcset="/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-a67b7.png 200w,\n/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-0b187.png 400w,\n/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-fee1c.png 800w,\n/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-4cbd1.png 1179w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-28530.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 54.91559086395233%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABiklEQVQoz11S25ajIBDk/39wzz6sSYwakQACzV3NFPqwM1OnT1M2tH1lqxAUklbqNU3DOM5dJ7tOCCGl0lpLKY0x/hvI0yXg7Ph8jhP7th17Ayxb3XZ846jQW7uF/dS11pxLBlJiec8heJvdGp0vZfXO52KCo1w1BZfpHY2KaaGkYhWUZIzCWxUzt4EJbY1P0nppSbmoCZK0b1pBrOfaKIqrz2Kltw3aJ+XCAq9Q2Z/b+PfBu0mN0gu3SX9Iv7+paXBuSs+tCh9wPOi5AV/s9m+Q3aTZOD7RKjTirLF8l32rOUVydm/Fl+BB7WWcpnHhMxufj6HvrbHoRPkJWEIIqzG1/bZYBxBojPFxv/e3G5PPp+26ME2JqPzyR2Nj9PNcnAPHA/S2GUNwfe9fL/YcRvwGgpH+D35OA2eLrBSGgyvkDEEWiHy/NTC+zHzm2AciOie74d3WxoqBHwnZXvZaryUBTynxZUEwxjlf19XaVhGW6ayLzCzE4yWHxQ6jFQL7gKW4nJEOnJERyBdhznPZL6HixAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 16 32 29"\n        title=""\n        src="/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-fee1c.png"\n        srcset="/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-a67b7.png 200w,\n/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-0b187.png 400w,\n/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-fee1c.png 800w,\n/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-28530.png 1007w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>',
excerpt:"需求背景 最近在做表单分享的需求，类似于问卷调查，需要在三端（桌面端、移动端、微信端）同时兼容 技术方案 我出的方案：采用原生语法新框架写，考虑到首屏渲染的问题未采用 主管出的方案：采用后端渲染模板的方式，最大化首屏加载速度，但有以下问题： 后端渲染对服务器 CPU…",frontmatter:{date:"2019-11-15 15:04:04",path:"/lightweight-website-construction/",tags:"前端, 轻量级网站, 预研",title:"轻量级网站构建实践",draft:null}}},pathContext:{mainPostPath:"/building-platform-lightweight-components/",nextPostPath:"/webpack-template-new-project/",prePostPath:"/lightweight-website-construction/"}}}});
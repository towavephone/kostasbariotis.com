webpackJsonp([92273702718447],{1454:function(n,a){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlUlEQVRIx11WaWxU1xWewbQlrdofkSIhGiBpMPZ4Vs/2lpm3zupZPOOZ8Sz2YGzANkaAKaYQUrMkLYgiIlxCQjCYQAwYEoMQNJAIFBxaQgUhoCopYceBJo1pKFVDCbOc0/fesOZKV+fM1Tvf/c56R0VYOZW8lvAxtSybvbExAu1+mndGuaDQ2F4rNHVFhCZJZlMeZ1Qrf9Mt+H+qur/ihFORAFA64J0pVTcXVcDmcKFfruIzZ7rY1H89fAZivjbM1MzFxkAnZqWd9M7KJcTmv7zCN44sY+tflm12C79WLxLCqidWN9cwWpYvsfXL13vasZudgm4mgX4hW6h1teRjnrZCwjOzWO/twIR/FjZ7WnEZ35JvcUSeU4gwSXV7W1sJzEH6R8nSRArlXjr6r7S1DqNUvMAzCXCzSfDxDRAUmyDkaoawtEPi1LxHyGLMkby5gEqUy7atjnq1roosAXqE6Yq7DBXa7RLS6HRG8y4hhbwzDiJbj4IkXUwS5e1h07IOorMePUL6ruiKGmRblg2PesJlq9nxrJMMfydIbhIWP9jMPrBLkrIHgXfG0CdmgKMjwFARFKVvHEQo5xUyKDDRN2T7aE17mV5rfZQYm1lM0EQYWUe0aNTxoKl0Qnk5jVqNA/VaFu3SBS7SB7Ju0ougr2KKWg2DBi17mbCaxyghMzgeMTTp2W7CGkTKHshZqn0Q5Osg6opBhAmAzcADY/NheyQJBi2D8mXVehYMOgEsJg9aTIxSN2YTO+ohQ62G6rGZa5AmAjmj0YvzG5vhVP8f4fTO12FtVxfMjTfC6zPbwOsIQNybhK6GlmLCm5DA6cu2aoeSaaOeVheLxRKgpoJcZ5UAly94MeeiQ+jnQtBCcTBTZ8Ght9fDfy58DDdOHIRj2zdA/4uzYWBpZ6Fr6jR8/lfWP8n2usqA2mQgH7msr3Ks0WgEfGvN6lz/q6tgXqgZjgpZOGSLwsldA4CFG4j3rmP/osU47xkdrm5pLfjdETm+p64cf0fJME34HiVFV+VYajF50UGGc/Nnz4XDfW/ArQ09+M++XsCblwD+fQEL356HswuWwdedS+Dg2p5ilZQwa7VrpCHZ9nOl7Ojg44B0hxxg0hbMjx2rh2iwDk4feReKI58hfn8V8c5lwNyXiF+dRbz4Z1jY1g4TJ1rQbnHfc/ORihJDr5q0kw8AyVqDjpeSEpJLAyaMN6HRwMDuTa/B1fcPwcfbBuHc8SPw+cnDsGvzeim7HOg0DpAYoouPBWUMJxUo65y18X4MtbYJOo3zjgQoxwWen1iNDdPmwPu9+2BvfCXsXbQRehf9Hly0B8aN04OuioGqCipvt/hQ5GLzS4Dh0Tdv3+/nvm0qVVUlfUouboOWK8jxmaznMBXIwpbfroWN63th384tcHTfDpj0gg21lQxoK+m8TQGMb5UxAt6OUYSVkUuGK5MPKiuIHicZwWqDmNNqpE6pIFBjpGDxsqXwuxUroWtBN5w4NgSbNvcDIRW61CUFu9UrtV/si7Fjf/ajUmICSvxKgJMtdQxVK2XOU9RpGNBL3VBeQWIqPR3SjR3QOW8xrFmxCnrWbYJMaobEkr1HE/4zIpv4nrK7NIrbpF+tspoYZdpMLte+wNPRu6S1Bs1GqV/1DOqMPFjIMFbq3dg6cyFkGmagqZqHaoOAHF2XZ6ngWg+XBM4RVoLHOWrLVG4uWpo4FvsvfHz6NktFkbT6QafnQGsUoFLHYm1dFj44cgwYPgQVkymkbP6RWl+LNIRjL/uFhltuNjEoYySCXaNUojOsMPSw4aqwa+o9ga5DggiC1RFDmyMG1bYQVlTSIIhRMJq9RaPZJ4VF+DQZ6MCAmOkLurJ/DYiNt/R67VMKs4hrqjL+o+6mjrj0hjBEOG+1h8FOxcFO1oHVFgazPYQGqdfNthBYpUqwEME78nsT4tP7o96WwWSwA1nKb35iyCZ8M85EXE3oYBO3ab4RKWcSKCaFJJMCQprSpPQcUFwKzWQUKo1+lC9x0r7Fcc+0OVOj8zEkNrY8BAuLDV11ruZvDXrhuJ3NIu+bAYK/FXjfdOA8zegUp6DdmQKNMQD+8HTseW1LYeijE/jB4Q+/Wry8a5L01B6MeaetUcDSjfVjjOVM7da+bTMPvHfkbmrKb5DksjkLncmZqXTe6siAnWmAmkhbYUPvQP7cufO5L69fxyvD/8Ctb+/aI2PU8AmvRGqZAoiIityzb8/T165d3X3t2vD/Pjr+KW7b+R6u2/AOrli9CQfePYQXLg3jpSvDeOLkWTxw6Oh3uwYPrJTMlNHlFcLPeNk6/UOXZ7cuGP1A397fP/7v584vvzJ8o+dvn33+Zm/v9q9X/2EDbN+19+ybm3ds33/ww5f63uovf/D9woVL1A90P5dQqYaGhpQfg4N71BJbteoHqyk7Z+e8zlfuSupPHj+/eO2bso5ZcxQ9Fsiqgny6ZOv3+VTfjIwo+iefnFYN7BxQf3FxuEwGH1c+fgxBuIZnTFuIIh9U2qt3844fb9y0Vf0gXPKm7bzKzYZ+wGTKFFWNz1/6v8OLUiuaFKMJz00yEvaa/RQZnK086s6MutpEqRLx+kcT+rH1f+YikeeNfqnwAAAAAElFTkSuQmCC",aspectRatio:.6666666666666666,src:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png",srcSet:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-8a97b.png 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-0fdf3.png 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png 600w",srcWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp",srcSetWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-5d70e.webp 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-d1677.webp 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="需求"><a href="#%E9%9C%80%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求</h1>\n<p>用生成 x86-64 汇编代码的代码替换程序中的解释器</p>\n<h1 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h1>\n<h2 id="修改解释树"><a href="#%E4%BF%AE%E6%94%B9%E8%A7%A3%E9%87%8A%E6%A0%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修改解释树</h2>\n<p>开始之前，先回顾以下解释器的代码：</p>\n<p>interp.c</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72083638810620520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// AST tree interpreter\n// Copyright (c) 2019 Warren Toomey, GPL3\n\n// List of AST operators\nstatic char *ASTop[] = { &quot;+&quot;, &quot;-&quot;, &quot;*&quot;, &quot;/&quot; };\n\n// 给一个 AST 树并做出解释得到最终值\nint interpretAST(struct ASTnode *n) {\n  int leftval, rightval;\n\n  if (n->left)\n    leftval = interpretAST(n->left);\n  if (n->right)\n    rightval = interpretAST(n->right);\n\n  // 调试\n  if (n->op == A_INTLIT)\n    printf(&quot;int %d\\n&quot;, n->intvalue);\n  else\n    printf(&quot;%d %s %d\\n&quot;, leftval, ASTop[n->op], rightval);\n\n  switch (n->op) {\n    case A_ADD:\n      return (leftval + rightval);\n    case A_SUBTRACT:\n      return (leftval - rightval);\n    case A_MULTIPLY:\n      return (leftval * rightval);\n    case A_DIVIDE:\n      return (leftval / rightval);\n    case A_INTLIT:\n      return (n->intvalue);\n    default:\n      fprintf(stderr, &quot;Unknown AST operator %d\\n&quot;, n->op);\n      exit(1);\n  }\n}`, `72083638810620520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// AST tree interpreter</span>\n<span class="token comment">// Copyright (c) 2019 Warren Toomey, GPL3</span>\n\n<span class="token comment">// List of AST operators</span>\n<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>ASTop<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"+"</span><span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token string">"/"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 给一个 AST 树并做出解释得到最终值</span>\n<span class="token keyword">int</span> <span class="token function">interpretAST</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">int</span> leftval<span class="token punctuation">,</span> rightval<span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">)</span>\n    leftval <span class="token operator">=</span> <span class="token function">interpretAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span>\n    rightval <span class="token operator">=</span> <span class="token function">interpretAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调试</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>op <span class="token operator">==</span> A_INTLIT<span class="token punctuation">)</span>\n    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"int %d\\n"</span><span class="token punctuation">,</span> n<span class="token operator">-></span>intvalue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">else</span>\n    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %s %d\\n"</span><span class="token punctuation">,</span> leftval<span class="token punctuation">,</span> ASTop<span class="token punctuation">[</span>n<span class="token operator">-></span>op<span class="token punctuation">]</span><span class="token punctuation">,</span> rightval<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> A_ADD<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>leftval <span class="token operator">+</span> rightval<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> A_SUBTRACT<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>leftval <span class="token operator">-</span> rightval<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> A_MULTIPLY<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>leftval <span class="token operator">*</span> rightval<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> A_DIVIDE<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>leftval <span class="token operator">/</span> rightval<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> A_INTLIT<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>intvalue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">default</span><span class="token operator">:</span>\n      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Unknown AST operator %d\\n"</span><span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该 interpretAST() 函数先走给定的 AST 树深度。它先遍历任何左子树，然后再遍历右子树，最后它使用 op 当前树的底部的值对这些子代进行操作。</p>\n<p>如果该 op 值是四个数学运算符之一，则将执行此数学运算。如果该 op 值指示该节点只是简单的整数文字，则返回整数值。</p>\n<p>该函数返回此树的最终值，并且由于它是递归的，它将一次为一棵子树计算整个树的最终值。</p>\n<h2 id="更改为汇编代码生成"><a href="#%E6%9B%B4%E6%94%B9%E4%B8%BA%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更改为汇编代码生成</h2>\n<p>我们将编写一个通用的汇编代码生成器。反过来，这将调出一组特定于 CPU 的代码生成功能。</p>\n<p>这是通用汇编代码生成器 gen.c：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37028251949040250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Given an AST, generate\n// assembly code recursively\nstatic int genAST(struct ASTnode *n) {\n  int leftreg, rightreg;\n\n  // Get the left and right sub-tree values\n  if (n->left)\n    leftreg = genAST(n->left);\n  if (n->right)\n    rightreg = genAST(n->right);\n\n  switch (n->op) {\n    case A_ADD:\n      return (cgadd(leftreg,rightreg));\n    case A_SUBTRACT:\n      return (cgsub(leftreg,rightreg));\n    case A_MULTIPLY:\n      return (cgmul(leftreg,rightreg));\n    case A_DIVIDE:\n      return (cgdiv(leftreg,rightreg));\n    case A_INTLIT:\n      return (cgload(n->intvalue));\n    default:\n      fprintf(stderr, &quot;Unknown AST operator %d\\n&quot;, n->op);\n      exit(1);\n  }\n}`, `37028251949040250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Given an AST, generate</span>\n<span class="token comment">// assembly code recursively</span>\n<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">genAST</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">int</span> leftreg<span class="token punctuation">,</span> rightreg<span class="token punctuation">;</span>\n\n  <span class="token comment">// Get the left and right sub-tree values</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">)</span>\n    leftreg <span class="token operator">=</span> <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span>\n    rightreg <span class="token operator">=</span> <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> A_ADD<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">cgadd</span><span class="token punctuation">(</span>leftreg<span class="token punctuation">,</span>rightreg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> A_SUBTRACT<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">cgsub</span><span class="token punctuation">(</span>leftreg<span class="token punctuation">,</span>rightreg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> A_MULTIPLY<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">cgmul</span><span class="token punctuation">(</span>leftreg<span class="token punctuation">,</span>rightreg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> A_DIVIDE<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">cgdiv</span><span class="token punctuation">(</span>leftreg<span class="token punctuation">,</span>rightreg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> A_INTLIT<span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">cgload</span><span class="token punctuation">(</span>n<span class="token operator">-></span>intvalue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">default</span><span class="token operator">:</span>\n      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Unknown AST operator %d\\n"</span><span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看起来很熟吧？我们正在进行相同的深度优先树遍历。这次：</p>\n<ul>\n<li>A_INTLIT：使用文字值加载寄存器</li>\n<li>其他运算符：在保存左子树和右子树的两个寄存器上执行数学函数</li>\n</ul>\n<p>不是传递值而是通过代码 genAST() 传递寄存器标识符，例如 cgload() 将值加载到寄存器中，并返回具有已加载值的寄存器的标识。</p>\n<p>genAST() 本身返回此时持有树的最终值的寄存器的标识，这就是为什么顶部的代码获取寄存器标识的原因：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46828643475458966000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (n->left) leftreg = genAST(n->left);\nif (n->right) rightreg = genAST(n->right);`, `46828643475458966000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">)</span> leftreg <span class="token operator">=</span> <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span> rightreg <span class="token operator">=</span> <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="调用-genast"><a href="#%E8%B0%83%E7%94%A8-genast" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用 genAST()</h2>\n<p>genAST() 只会计算赋予它的表达式的值，我们需要打印出最终的计算结果。我们还需要用一些前导代码（preamble）和一些尾随代码（postamble）包装生成的汇编代码，这是通过以下其他功能完成的 gen.c：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5056630628776037000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`void generatecode(struct ASTnode *n) {\n  int reg;\n\n  cgpreamble();\n  reg= genAST(n);\n  cgprintint(reg);\n  cgpostamble();\n}`, `5056630628776037000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">void</span> <span class="token function">generatecode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">int</span> reg<span class="token punctuation">;</span>\n\n  <span class="token function">cgpreamble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  reg<span class="token operator">=</span> <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">cgprintint</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">cgpostamble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="x86-64-代码生成器"><a href="#x86-64-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>x86-64 代码生成器</h2>\n<p>那就是通用代码生成器，现在我们需要看看一些实际的汇编代码的生成。目前我的目标是 x86-64 CPU，因为它仍然是最常见的 Linux 平台之一，因此打开 cg.c 并开始浏览。</p>\n<h3 id="分配寄存器"><a href="#%E5%88%86%E9%85%8D%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分配寄存器</h3>\n<p>任何 CPU 的寄存器数量都有限，我们将不得不分配一个寄存器来保存整数文字值，以及我们对它们执行的任何计算。但是一旦使用了一个值，我们通常可以丢弃该值，从而释放保存它的寄存器，然后我们可以将该寄存器重用于另一个值。</p>\n<p>有三个函数处理寄存器分配：</p>\n<ul>\n<li>freeall_registers()：将所有寄存器设置为可用</li>\n<li>alloc_register()：分配寄存器</li>\n<li>free_register()：释放分配的寄存器</li>\n</ul>\n<p>我不会通过代码使用因为它很简单，但是会进行一些错误检查。现在如果我用完了寄存器，程序将崩溃。稍后当自由寄存器用完时，我将处理这种情况。</p>\n<p>该代码适用于通用寄存器：r0，r1，r2 和 r3，有一个带有实际寄存器名称的字符串表：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77971108794395820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`static char *reglist[4]= { &quot;%r8&quot;, &quot;%r9&quot;, &quot;%r10&quot;, &quot;%r11&quot; };`, `77971108794395820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>reglist<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"%r8"</span><span class="token punctuation">,</span> <span class="token string">"%r9"</span><span class="token punctuation">,</span> <span class="token string">"%r10"</span><span class="token punctuation">,</span> <span class="token string">"%r11"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这使得这些功能相当独立于 CPU 体系结构。</p>\n<h3 id="加载寄存器"><a href="#%E5%8A%A0%E8%BD%BD%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加载寄存器</h3>\n<p>这是通过以下方式完成的 cgload()：分配了一个寄存器，然后一条 movq 指令将文字值加载到分配的寄存器中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44147154235859040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Load an integer literal value into a register.\n// Return the number of the register\nint cgload(int value) {\n\n  // Get a new register\n  int r = alloc_register();\n\n  // Print out the code to initialise it\n  fprintf(Outfile, &quot;\\tmovq\\t\\$%d, %s\\n&quot;, value, reglist[r]);\n  return(r);\n}`, `44147154235859040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Load an integer literal value into a register.</span>\n<span class="token comment">// Return the number of the register</span>\n<span class="token keyword">int</span> <span class="token function">cgload</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n  <span class="token comment">// Get a new register</span>\n  <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">alloc_register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Print out the code to initialise it</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tmovq\\t$%d, %s\\n"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="加法寄存器"><a href="#%E5%8A%A0%E6%B3%95%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加法寄存器</h3>\n<p>cgadd() 接受两个寄存器号并生成代码以将它们加在一起，结果保存在两个寄存器之一中，然后释放另一个以供将来使用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25257878382335820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Add two registers together and return\n// the number of the register with the result\nint cgadd(int r1, int r2) {\n  fprintf(Outfile, &quot;\\taddq\\t%s, %s\\n&quot;, reglist[r1], reglist[r2]);\n  free_register(r1);\n  return(r2);\n}`, `25257878382335820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Add two registers together and return</span>\n<span class="token comment">// the number of the register with the result</span>\n<span class="token keyword">int</span> <span class="token function">cgadd</span><span class="token punctuation">(</span><span class="token keyword">int</span> r1<span class="token punctuation">,</span> <span class="token keyword">int</span> r2<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\taddq\\t%s, %s\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r1<span class="token punctuation">]</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">free_register</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="相乘寄存器"><a href="#%E7%9B%B8%E4%B9%98%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>相乘寄存器</h3>\n<p>这与加法非常相似，并且操作也是可交换的，因此可以返回任何寄存器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6795123353585142000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Multiply two registers together and return\n// the number of the register with the result\nint cgmul(int r1, int r2) {\n  fprintf(Outfile, &quot;\\timulq\\t%s, %s\\n&quot;, reglist[r1], reglist[r2]);\n  free_register(r1);\n  return(r2);\n}`, `6795123353585142000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Multiply two registers together and return</span>\n<span class="token comment">// the number of the register with the result</span>\n<span class="token keyword">int</span> <span class="token function">cgmul</span><span class="token punctuation">(</span><span class="token keyword">int</span> r1<span class="token punctuation">,</span> <span class="token keyword">int</span> r2<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\timulq\\t%s, %s\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r1<span class="token punctuation">]</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">free_register</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="减法寄存器"><a href="#%E5%87%8F%E6%B3%95%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>减法寄存器</h3>\n<p>减法不是可交换的：我们必须使顺序正确，从第一个寄存器减去第二个寄存器，因此我们返回第一个寄存器并释放第二个寄存器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26013796781656830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Subtract the second register from the first and\n// return the number of the register with the result\nint cgsub(int r1, int r2) {\n  fprintf(Outfile, &quot;\\tsubq\\t%s, %s\\n&quot;, reglist[r2], reglist[r1]);\n  free_register(r2);\n  return(r1);\n}`, `26013796781656830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Subtract the second register from the first and</span>\n<span class="token comment">// return the number of the register with the result</span>\n<span class="token keyword">int</span> <span class="token function">cgsub</span><span class="token punctuation">(</span><span class="token keyword">int</span> r1<span class="token punctuation">,</span> <span class="token keyword">int</span> r2<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tsubq\\t%s, %s\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">free_register</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="除法寄存器"><a href="#%E9%99%A4%E6%B3%95%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>除法寄存器</h3>\n<p>除法也不是可交换的，在 x86-64 上它比较复杂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86594394345407940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Divide the first register by the second and\n// return the number of the register with the result\nint cgdiv(int r1, int r2) {\n  // movq 完成 8 个字节的复制\n  fprintf(Outfile, &quot;\\tmovq\\t%s,%%rax\\n&quot;, reglist[r1]);\n  // 将字转换为双字/将双字转换为四字\n  fprintf(Outfile, &quot;\\tcqo\\n&quot;);\n  // idivq 除法，%rax保存商 %rdx保存余数\n  fprintf(Outfile, &quot;\\tidivq\\t%s\\n&quot;, reglist[r2]);\n  fprintf(Outfile, &quot;\\tmovq\\t%%rax,%s\\n&quot;, reglist[r1]);\n  free_register(r2);\n  return(r1);\n}`, `86594394345407940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Divide the first register by the second and</span>\n<span class="token comment">// return the number of the register with the result</span>\n<span class="token keyword">int</span> <span class="token function">cgdiv</span><span class="token punctuation">(</span><span class="token keyword">int</span> r1<span class="token punctuation">,</span> <span class="token keyword">int</span> r2<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// movq 完成 8 个字节的复制</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tmovq\\t%s,%%rax\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 将字转换为双字/将双字转换为四字</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tcqo\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// idivq 除法，%rax保存商 %rdx保存余数</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tidivq\\t%s\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tmovq\\t%%rax,%s\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">free_register</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="打印寄存器"><a href="#%E6%89%93%E5%8D%B0%E5%AF%84%E5%AD%98%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打印寄存器</h3>\n<p>没有 x86-64 指令可将寄存器输出为十进制数字。为了解决此问题，汇编程序包含一个 printint() 的函数，该函数带有一个寄存器参数，并调用 printf() 以十进制格式将其打印出来。</p>\n<p>我不会提供代码 cgpreamble()，但其中也包含开始代码 main()，以便我们可以汇编输出文件以获得完整的程序代码（cgpostamble() 此处也未提供）只是调用 exit(0) 以结束程序。</p>\n<p>但是，这里是 cgprintint()：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17093937713777142000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`void cgprintint(int r) {\n  fprintf(Outfile, &quot;\\tmovq\\t%s, %%rdi\\n&quot;, reglist[r]);\n  fprintf(Outfile, &quot;\\tcall\\tprintint\\n&quot;);\n  free_register(r);\n}`, `17093937713777142000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">void</span> <span class="token function">cgprintint</span><span class="token punctuation">(</span><span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tmovq\\t%s, %%rdi\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tcall\\tprintint\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">free_register</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Linux x86-64 期望函数的第一个参数在 %rdi 寄存器中，因此我们将寄存器移到 %rdi 之前调用 printint。</p>\n<h1 id="运行结果"><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行结果</h1>\n<h2 id="输入"><a href="#%E8%BE%93%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输入</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54098543870426960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`2 + 3 * 5 - 8 / 3`, `54098543870426960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">2 + 3 * 5 - 8 / 3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="输出"><a href="#%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输出</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45496738983227060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`cc -o comp1 -g cg.c expr.c gen.c interp.c main.c scan.c tree.c\n\n\\$ make test\n./comp1 input01\n15\ncc -o out out.s\n./out\n15`, `45496738983227060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">cc -o comp1 -g cg.c expr.c gen.c interp.c main.c scan.c tree.c\n\n$ make test\n./comp1 input01\n15\ncc -o out out.s\n./out\n15</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>生成的 out.s 文件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66188350383562770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`        .text\n.LC0:\n        .string &quot;%d\\n&quot;\nprintint:\n        pushq   %rbp\n        movq    %rsp, %rbp\n        subq    \\$16, %rsp\n        movl    %edi, -4(%rbp)\n        movl    -4(%rbp), %eax\n        movl    %eax, %esi\n        leaq    .LC0(%rip), %rdi\n        movl    \\$0, %eax\n        call    printf@PLT\n        nop\n        leave\n        ret\n\n        .globl  main\n        .type   main, @function\nmain:\n        pushq   %rbp\n        movq    %rsp, %rbp\n        movq    \\$13, %r8\n        movq    \\$6, %r9\n        subq    %r9, %r8\n        movq    \\$4, %r9\n        movq    \\$5, %r10\n        imulq   %r9, %r10\n        addq    %r8, %r10\n        movq    \\$8, %r8\n        movq    \\$3, %r9\n        movq    %r8,%rax\n        cqo\n        idivq   %r9\n        movq    %rax,%r8\n        addq    %r10, %r8\n        movq    %r8, %rdi\n        call    printint\n        movl    \\$0, %eax\n        popq    %rbp\n        ret`, `66188350383562770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">        .text\n.LC0:\n        .string &quot;%d\\n&quot;\nprintint:\n        pushq   %rbp\n        movq    %rsp, %rbp\n        subq    $16, %rsp\n        movl    %edi, -4(%rbp)\n        movl    -4(%rbp), %eax\n        movl    %eax, %esi\n        leaq    .LC0(%rip), %rdi\n        movl    $0, %eax\n        call    printf@PLT\n        nop\n        leave\n        ret\n\n        .globl  main\n        .type   main, @function\nmain:\n        pushq   %rbp\n        movq    %rsp, %rbp\n        movq    $13, %r8\n        movq    $6, %r9\n        subq    %r9, %r8\n        movq    $4, %r9\n        movq    $5, %r10\n        imulq   %r9, %r10\n        addq    %r8, %r10\n        movq    $8, %r8\n        movq    $3, %r9\n        movq    %r8,%rax\n        cqo\n        idivq   %r9\n        movq    %rax,%r8\n        addq    %r10, %r8\n        movq    %r8, %rdi\n        call    printint\n        movl    $0, %eax\n        popq    %rbp\n        ret</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>优秀！现在，我们有了一个合法的编译器：一个程序以一种语言输入并生成另一种语言的翻译。</p>\n<p>然后，我们仍然必须将输出组装成机器代码并将其与支持库链接，但这是我们现在可以手动执行的操作。稍后，我们将编写一些代码来自动执行此操作。</p>\n<h1 id="结论"><a href="#%E7%BB%93%E8%AE%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>结论</h1>\n<p>从解释器更改为通用代码生成器是微不足道的，但是随后我们不得不编写一些代码以生成实际的程序集输出，为此我们必须考虑如何分配寄存器：目前我们有一个幼稚的解决方案。我们还必须处理一些 x86-64 的怪异 idivq 指令。</p>\n<p>我还没有谈到的是：为什么要为表达式生成 AST 呢？当然，cgadd() 当我们在 Pratt 解析器中命中“+”令牌时，我们可能会调用，其他运算符也是如此。我要让您考虑一下，但是我将在一到两步之后再讲一遍。</p>\n<p>在编译器编写过程的下一部分中，我们将在语言中添加一些语句，以使其开始类似于适当的计算机语言。</p>',
excerpt:"需求 用生成 x86-64 汇编代码的代码替换程序中的解释器 核心逻辑 修改解释树 开始之前，先回顾以下解释器的代码： interp.c 该 interpretAST() 函数先走给定的 AST 树深度。它先遍历任何左子树，然后再遍历右子树，最后它使用 op…",timeToRead:6,tableOfContents:'<ul>\n<li><a href="/tour-of-compiler-real-compiler/#%E9%9C%80%E6%B1%82">需求</a></li>\n<li>\n<p><a href="/tour-of-compiler-real-compiler/#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91">核心逻辑</a></p>\n<ul>\n<li><a href="/tour-of-compiler-real-compiler/#%E4%BF%AE%E6%94%B9%E8%A7%A3%E9%87%8A%E6%A0%91">修改解释树</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E6%9B%B4%E6%94%B9%E4%B8%BA%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90">更改为汇编代码生成</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E8%B0%83%E7%94%A8-genast">调用 genAST()</a></li>\n<li>\n<p><a href="/tour-of-compiler-real-compiler/#x86-64-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8">x86-64 代码生成器</a></p>\n<ul>\n<li><a href="/tour-of-compiler-real-compiler/#%E5%88%86%E9%85%8D%E5%AF%84%E5%AD%98%E5%99%A8">分配寄存器</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E5%8A%A0%E8%BD%BD%E5%AF%84%E5%AD%98%E5%99%A8">加载寄存器</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E5%8A%A0%E6%B3%95%E5%AF%84%E5%AD%98%E5%99%A8">加法寄存器</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E7%9B%B8%E4%B9%98%E5%AF%84%E5%AD%98%E5%99%A8">相乘寄存器</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E5%87%8F%E6%B3%95%E5%AF%84%E5%AD%98%E5%99%A8">减法寄存器</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E9%99%A4%E6%B3%95%E5%AF%84%E5%AD%98%E5%99%A8">除法寄存器</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E6%89%93%E5%8D%B0%E5%AF%84%E5%AD%98%E5%99%A8">打印寄存器</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/tour-of-compiler-real-compiler/#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C">运行结果</a></p>\n<ul>\n<li><a href="/tour-of-compiler-real-compiler/#%E8%BE%93%E5%85%A5">输入</a></li>\n<li><a href="/tour-of-compiler-real-compiler/#%E8%BE%93%E5%87%BA">输出</a></li>\n</ul>\n</li>\n<li><a href="/tour-of-compiler-real-compiler/#%E7%BB%93%E8%AE%BA">结论</a></li>\n</ul>',wordCount:{words:230},frontmatter:{date:"2020-03-03 10:44:03",path:"/tour-of-compiler-real-compiler/",tags:"编译原理, 代码生成",title:"编译器之旅（四）——真正的编译器",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="需求"><a href="#%E9%9C%80%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求</h1>\n<p>我们在上一部分中看到，解析器不一定强制执行我们语言的语义，它仅强制执行语法的语法和结构规则。</p>\n<p>我们最终得到了计算表达式错误值（如 2 _ 3 + 4 _ 5）的代码，因为该代码创建了一个如下所示的 AST：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1498492448946975200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(` *\n/ \\\n2  +\n  / \\\n  3  *\n    / \\\n   4   5`, `1498492448946975200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text"> *\n/ \\\n2  +\n  / \\\n  3  *\n    / \\\n   4   5</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了解决这个问题，我们必须向解析器添加代码以执行运算符优先级。</p>\n<h1 id="准备"><a href="#%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>准备</h1>\n<p>有（至少）两种方法：</p>\n<ul>\n<li>在语言的语法中明确运算符的优先级</li>\n<li>用运算符优先级表影响现有解析器</li>\n</ul>\n<h2 id="明确运算符优先级"><a href="#%E6%98%8E%E7%A1%AE%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BC%98%E5%85%88%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>明确运算符优先级</h2>\n<p>这是旅程最后一部分的语法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19540716922908130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`expression: number\n          | expression \'*\' expression\n          | expression \'/\' expression\n          | expression \'+\' expression\n          | expression \'-\' expression\n          ;\n\nnumber:  T_INTLIT\n         ;`, `19540716922908130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">expression: number\n          | expression &#39;*&#39; expression\n          | expression &#39;/&#39; expression\n          | expression &#39;+&#39; expression\n          | expression &#39;-&#39; expression\n          ;\n\nnumber:  T_INTLIT\n         ;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意这四个数学运算符之间没有区别。让我们调整语法，以便有所不同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77093279539762660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`expression: additive_expression\n    ;\n\nadditive_expression:\n      multiplicative_expression\n    | additive_expression \'+\' multiplicative_expression\n    | additive_expression \'-\' multiplicative_expression\n    ;\n\nmultiplicative_expression:\n      number\n    | number \'*\' multiplicative_expression\n    | number \'/\' multiplicative_expression\n    ;\n\nnumber:  T_INTLIT\n         ;`, `77093279539762660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">expression: additive_expression\n    ;\n\nadditive_expression:\n      multiplicative_expression\n    | additive_expression &#39;+&#39; multiplicative_expression\n    | additive_expression &#39;-&#39; multiplicative_expression\n    ;\n\nmultiplicative_expression:\n      number\n    | number &#39;*&#39; multiplicative_expression\n    | number &#39;/&#39; multiplicative_expression\n    ;\n\nnumber:  T_INTLIT\n         ;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，我们有两种类型的表达式：加法表达式和乘法表达式。请注意，语法现在强制数字仅作为乘法表达式的一部分。这迫使’*‘和’/‘运算符更紧密地绑定到任一侧的数字，因此具有更高的优先级。</p>\n<p>任何加法表达式实际上要么本身就是乘法表达式，要么是加法（即乘法）表达式，后跟“ +”或“-”运算符，然后是另一个乘法表达式。现在，加性表达式的出现率比乘法表达式低得多。</p>\n<h1 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h1>\n<h2 id="在递归下降解析器中执行上述操作"><a href="#%E5%9C%A8%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E8%A7%A3%E6%9E%90%E5%99%A8%E4%B8%AD%E6%89%A7%E8%A1%8C%E4%B8%8A%E8%BF%B0%E6%93%8D%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在递归下降解析器中执行上述操作</h2>\n<p>我们如何将语法的上述版本实现到递归下降解析器中？我已在文件中完成此操作，expr2.c 下面将介绍代码。</p>\n<p>答案是拥有一个 multiplicative<em>expr()处理’*‘和’/‘运算符的 additive</em>expr()函数，以及一个处理优先级较低的’+‘和’-‘运算符的函数。</p>\n<p>这两个函数都将读入某些内容和一个运算符。然后，尽管后面的运算符具有相同的优先级，但是每个函数都会解析更多的输入，并将左半部分和右半部分与第一个运算符组合在一起。</p>\n<p>但是，additive<em>expr()必须遵循更高优先级的 multiplicative</em>expr()功能。这是如何完成的。</p>\n<h2 id="additive_expr"><a href="#additive_expr" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>additive_expr()</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53064114652661080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 返回一个AST树，其根是一个“+”或“-”二进制运算符\nstruct ASTnode *additive_expr(void) {\n  struct ASTnode *left, *right;\n  int tokentype;\n\n  // 获得比我们的左子树更高的优先级\n  left = multiplicative_expr();\n\n  // 如果没有剩余令牌，则仅返回左侧节点\n  tokentype = Token.token;\n  if (tokentype == T_EOF)\n    return (left);\n\n  // Cache the \'+\' or \'-\' token type\n\n  // 以优先级循环处理令牌\n  while (1) {\n    // 获取下一个整数文字\n    scan(&Token);\n\n    // 获得比我们的右子树更高的优先级\n    right = multiplicative_expr();\n\n    // 使用低优先级运算符将两个子树连接起来\n    left = mkastnode(arithop(tokentype), left, right, 0);\n\n    // 并以优先级获取下一个令牌\n    tokentype = Token.token;\n    if (tokentype == T_EOF)\n      break;\n  }\n\n  // Return whatever tree we have created\n  return (left);\n}`, `53064114652661080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// 返回一个AST树，其根是一个“+”或“-”二进制运算符</span>\n<span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span><span class="token function">additive_expr</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>left<span class="token punctuation">,</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>\n  <span class="token keyword">int</span> tokentype<span class="token punctuation">;</span>\n\n  <span class="token comment">// 获得比我们的左子树更高的优先级</span>\n  left <span class="token operator">=</span> <span class="token function">multiplicative_expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 如果没有剩余令牌，则仅返回左侧节点</span>\n  tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Cache the \'+\' or \'-\' token type</span>\n\n  <span class="token comment">// 以优先级循环处理令牌</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 获取下一个整数文字</span>\n    <span class="token function">scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 获得比我们的右子树更高的优先级</span>\n    right <span class="token operator">=</span> <span class="token function">multiplicative_expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 使用低优先级运算符将两个子树连接起来</span>\n    left <span class="token operator">=</span> <span class="token function">mkastnode</span><span class="token punctuation">(</span><span class="token function">arithop</span><span class="token punctuation">(</span>tokentype<span class="token punctuation">)</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 并以优先级获取下一个令牌</span>\n    tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Return whatever tree we have created</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从头开始，multiplicative_expr() 如果第一个运算符为高优先级’*‘或’/’ ，我们立即调用。该函数仅在遇到低优先级的“+”或“-”运算符时返回。</p>\n<p>在循环内部 multiplicative_expr()，如果将来有任何运算符的优先级高于现有的，我们将再次调用。</p>\n<p>一旦有了左右子树，我们就可以将它们与最后一次绕过循环的运算符结合起来。重复此操作，以便如果我们有表达式 2 + 4 + 6，我们将得到 AST 树：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37236337443148825000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`    +\n   / \\\n  +   6\n / \\\n2   4`, `37236337443148825000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">    +\n   / \\\n  +   6\n / \\\n2   4</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，如果 multiplicative_expr() 拥有自己的更高优先级运算符，我们将合并其中具有多个节点的子树。</p>\n<h2 id="multiplicative_expr"><a href="#multiplicative_expr" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>multiplicative_expr()</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11505177074920536000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 返回根为\'*\'或\'/\'二进制运算符的AST树\nstruct ASTnode *multiplicative_expr(void) {\n  struct ASTnode *left, *right;\n  int tokentype;\n\n  // 获取左侧的整数文字\n  // 同时获取下一个令牌\n  left = primary();\n\n  tokentype = Token.token;\n  if (tokentype == T_EOF)\n    return (left);\n\n  // While the token is a \'*\' or \'/\'\n  while ((tokentype == T_STAR) || (tokentype == T_SLASH)) {\n    // Fetch in the next integer literal\n    scan(&Token);\n    right = primary();\n\n    // Join that with the left integer literal\n    left = mkastnode(arithop(tokentype), left, right, 0);\n\n    // Update the details of the current token.\n    // If no tokens left, return just the left node\n    tokentype = Token.token;\n    if (tokentype == T_EOF)\n      break;\n  }\n\n  // Return whatever tree we have created\n  return (left);\n}`, `11505177074920536000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// 返回根为\'*\'或\'/\'二进制运算符的AST树</span>\n<span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span><span class="token function">multiplicative_expr</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>left<span class="token punctuation">,</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>\n  <span class="token keyword">int</span> tokentype<span class="token punctuation">;</span>\n\n  <span class="token comment">// 获取左侧的整数文字</span>\n  <span class="token comment">// 同时获取下一个令牌</span>\n  left <span class="token operator">=</span> <span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// While the token is a \'*\' or \'/\'</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_STAR<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_SLASH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Fetch in the next integer literal</span>\n    <span class="token function">scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    right <span class="token operator">=</span> <span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Join that with the left integer literal</span>\n    left <span class="token operator">=</span> <span class="token function">mkastnode</span><span class="token punctuation">(</span><span class="token function">arithop</span><span class="token punctuation">(</span>tokentype<span class="token punctuation">)</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Update the details of the current token.</span>\n    <span class="token comment">// If no tokens left, return just the left node</span>\n    tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Return whatever tree we have created</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该代码与 additive<em>expr() 相似，不同之处在于我们需要调用 primary() 以获得整数元素，我们也只有在具有较高优先级的运算符（即’*‘和’/‘运算符）时循环。遇到低优先级运算符后，我们只需返回到此为止构建的子树即可，再返回 additive</em>expr() 处理低优先级运算符。</p>\n<h2 id="上面的缺点"><a href="#%E4%B8%8A%E9%9D%A2%E7%9A%84%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>上面的缺点</h2>\n<p>由于要达到正确的优先级，需要进行所有的函数调用，因此以显式的运算符优先级构造递归下降解析器的上述方法效率低下，还必须有函数来处理每个级别的运算符优先级，因此我们最终需要编写许多行代码。</p>\n<h2 id="替代方案：pratt-解析"><a href="#%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88%EF%BC%9Apratt-%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>替代方案：Pratt 解析</h2>\n<p>减少代码量的一种方法是使用 Pratt 解析器 ，该解析器具有与每个标记关联的优先级值表，而不是使用具有在语法中复制显式优先级的函数。</p>\n<p>在这一点上，我强烈建议您阅读 Bob Nystrom 撰写的 Pratt Parsers：轻松进行表达式解析。</p>\n<h2 id="exprc-普拉特解析"><a href="#exprc-%E6%99%AE%E6%8B%89%E7%89%B9%E8%A7%A3%E6%9E%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>expr.c: 普拉特解析</h2>\n<p>我已经实现了 Pratt 解析，expr.c 是用来替代 expr2.c 的。</p>\n<p>首先，我们需要一些代码来确定每个令牌的优先级：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="436565204219308000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Operator precedence for each token\n// enum {\n//   A_ADD, A_SUBTRACT, A_MULTIPLY, A_DIVIDE, A_INTLIT\n// };\nstatic int OpPrec[] = { 0, 10, 10, 20, 20, 0 };\n\n// Check that we have a binary operator and\n// return its precedence.\nstatic int op_precedence(int tokentype) {\n  int prec = OpPrec[tokentype];\n  if (prec == 0) {\n    fprintf(stderr, &quot;syntax error on line %d, token %d\\n&quot;, Line, tokentype);\n    exit(1);\n  }\n  return (prec);\n}`, `436565204219308000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Operator precedence for each token</span>\n<span class="token comment">// enum {</span>\n<span class="token comment">//   A_ADD, A_SUBTRACT, A_MULTIPLY, A_DIVIDE, A_INTLIT</span>\n<span class="token comment">// };</span>\n<span class="token keyword">static</span> <span class="token keyword">int</span> OpPrec<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Check that we have a binary operator and</span>\n<span class="token comment">// return its precedence.</span>\n<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">op_precedence</span><span class="token punctuation">(</span><span class="token keyword">int</span> tokentype<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">int</span> prec <span class="token operator">=</span> OpPrec<span class="token punctuation">[</span>tokentype<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>prec <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"syntax error on line %d, token %d\\n"</span><span class="token punctuation">,</span> Line<span class="token punctuation">,</span> tokentype<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>prec<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>较高的数字（例如 20）表示优先级高于较低的数字（例如 10）。</p>\n<p>现在您可能会问：当您有一个查找表时，为什么要有一个函数 OpPrec[]？答案是：发现语法错误。</p>\n<p>考虑一个看起来像的输入 234 101 + 12。我们可以扫描前两个标记。但是，如果我们只是简单地获取第二个 101 令牌的优先级，我们不会注意到它不是运算符。因此，该 op_precedence() 函数强制执行正确的语法语法。</p>\n<p>现在，我们不再为每个优先级都拥有一个函数，而是拥有一个使用运算符优先级表的单一表达式函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61310497146701600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Return an AST tree whose root is a binary operator.\n// Parameter ptp is the previous token\'s precedence.\nstruct ASTnode *binexpr(int ptp) {\n  struct ASTnode *left, *right;\n  int tokentype;\n\n  // Get the integer literal on the left.\n  // Fetch the next token at the same time.\n  left = primary();\n\n  // If no tokens left, return just the left node\n  tokentype = Token.token;\n  if (tokentype == T_EOF)\n    return (left);\n\n  // While the precedence of this token is\n  // more than that of the previous token precedence\n  while (op_precedence(tokentype) > ptp) {\n    // Fetch in the next integer literal\n    scan(&Token);\n\n    // Recursively call binexpr() with the\n    // precedence of our token to build a sub-tree\n    // 优先级高的优先建立子树\n    right = binexpr(OpPrec[tokentype]);\n\n    // Join that sub-tree with ours. Convert the token\n    // into an AST operation at the same time.\n    // 同时转换左子树\n    left = mkastnode(arithop(tokentype), left, right, 0);\n\n    // Update the details of the current token.\n    // If no tokens left, return just the left node\n    tokentype = Token.token;\n    if (tokentype == T_EOF)\n      return (left);\n  }\n\n  // Return the tree we have when the precedence\n  // is the same or lower\n  return (left);\n}`, `61310497146701600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Return an AST tree whose root is a binary operator.</span>\n<span class="token comment">// Parameter ptp is the previous token\'s precedence.</span>\n<span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span><span class="token function">binexpr</span><span class="token punctuation">(</span><span class="token keyword">int</span> ptp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>left<span class="token punctuation">,</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>\n  <span class="token keyword">int</span> tokentype<span class="token punctuation">;</span>\n\n  <span class="token comment">// Get the integer literal on the left.</span>\n  <span class="token comment">// Fetch the next token at the same time.</span>\n  left <span class="token operator">=</span> <span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// If no tokens left, return just the left node</span>\n  tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// While the precedence of this token is</span>\n  <span class="token comment">// more than that of the previous token precedence</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">op_precedence</span><span class="token punctuation">(</span>tokentype<span class="token punctuation">)</span> <span class="token operator">></span> ptp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Fetch in the next integer literal</span>\n    <span class="token function">scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Recursively call binexpr() with the</span>\n    <span class="token comment">// precedence of our token to build a sub-tree</span>\n    <span class="token comment">// 优先级高的优先建立子树</span>\n    right <span class="token operator">=</span> <span class="token function">binexpr</span><span class="token punctuation">(</span>OpPrec<span class="token punctuation">[</span>tokentype<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Join that sub-tree with ours. Convert the token</span>\n    <span class="token comment">// into an AST operation at the same time.</span>\n    <span class="token comment">// 同时转换左子树</span>\n    left <span class="token operator">=</span> <span class="token function">mkastnode</span><span class="token punctuation">(</span><span class="token function">arithop</span><span class="token punctuation">(</span>tokentype<span class="token punctuation">)</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Update the details of the current token.</span>\n    <span class="token comment">// If no tokens left, return just the left node</span>\n    tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Return the tree we have when the precedence</span>\n  <span class="token comment">// is the same or lower</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>首先，请注意这仍然像以前的解析器函数一样是递归的。这次我们收到在调用之前找到的令牌的优先级。</p>\n<p>您还应该发现代码与 multiplicative_expr() 功能非常相似：读取整数文字，获取运算符的令牌类型，然后循环构建树。</p>\n<p>区别在于循环条件和主体：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45442482159206740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`multiplicative_expr():\n  while ((tokentype == T_STAR) || (tokentype == T_SLASH)) {\n    scan(&Token); right = primary();\n\n    left = mkastnode(arithop(tokentype), left, right, 0);\n\n    tokentype = Token.token;\n    if (tokentype == T_EOF) return (left);\n  }\n\nbinexpr():\n  while (op_precedence(tokentype) > ptp) {\n    scan(&Token); right = binexpr(OpPrec[tokentype]);\n\n    left = mkastnode(arithop(tokentype), left, right, 0);\n\n    tokentype = Token.token;\n    if (tokentype == T_EOF) return (left);\n  }`, `45442482159206740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token function">multiplicative_expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_STAR<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_SLASH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span> right <span class="token operator">=</span> <span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    left <span class="token operator">=</span> <span class="token function">mkastnode</span><span class="token punctuation">(</span><span class="token function">arithop</span><span class="token punctuation">(</span>tokentype<span class="token punctuation">)</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n<span class="token function">binexpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">op_precedence</span><span class="token punctuation">(</span>tokentype<span class="token punctuation">)</span> <span class="token operator">></span> ptp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span> right <span class="token operator">=</span> <span class="token function">binexpr</span><span class="token punctuation">(</span>OpPrec<span class="token punctuation">[</span>tokentype<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    left <span class="token operator">=</span> <span class="token function">mkastnode</span><span class="token punctuation">(</span><span class="token function">arithop</span><span class="token punctuation">(</span>tokentype<span class="token punctuation">)</span><span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 Pratt 解析器时，当下一个运算符的优先级高于我们当前的令牌时，我们不仅可以使用获取下一个整数文字 primary()，还可以调用自身 binexpr(OpPrec[tokentype]) 以提高运算符的优先级。</p>\n<p>一旦我们达到或低于优先级的令牌，我们将简单地返回 left。</p>\n<p>这将是一个具有许多节点和运算符的子树，其优先级高于调用我们的运算符，或者对于与我们相同的运算符，它可能是单个整数文字。</p>\n<p>现在，我们有一个函数来进行表达式解析。它使用一个小的辅助函数来强制运算符优先级，从而实现我们语言的语义。</p>\n<h1 id="运行结果"><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行结果</h1>\n<h2 id="输入"><a href="#%E8%BE%93%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输入</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2927919299283465700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`2 + 3 * 5 - 8 / 3`, `2927919299283465700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">2 + 3 * 5 - 8 / 3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85289022203157280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`13 -6+  4*\n5\n       +\n08 / 3`, `85289022203157280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">13 -6+  4*\n5\n       +\n08 / 3</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5230166964528737000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`12 34 + -56 * / - - 8 + * 2`, `5230166964528737000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">12 34 + -56 * / - - 8 + * 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34504054898940973000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`23 +\n18 -\n45.6 * 2\n/ 18`, `34504054898940973000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">23 +\n18 -\n45.6 * 2\n/ 18</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="输出"><a href="#%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输出</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25272535786982674000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ make test\ncc -o parser -g expr.c interp.c main.c scan.c tree.c\n(./parser input01; \\\n ./parser input02; \\\n ./parser input03; \\\n ./parser input04; \\\n ./parser input05)\nint 2\nint 3\nint 5\n3 * 5\n2 + 15\nint 8\nint 3\n8 / 3\n17 - 2\n15\nint 13\nint 6\n13 - 6\nint 4\nint 5\n4 * 5\n7 + 20\nint 8\nint 3\n8 / 3\n27 + 2\n29\nsyntax error on line 1, token 5\nUnrecognised character . on line 3\nUnrecognised character a on line 1`, `25272535786982674000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ make test\ncc -o parser -g expr.c interp.c main.c scan.c tree.c\n(./parser input01; \\\n ./parser input02; \\\n ./parser input03; \\\n ./parser input04; \\\n ./parser input05)\nint 2\nint 3\nint 5\n3 * 5\n2 + 15\nint 8\nint 3\n8 / 3\n17 - 2\n15\nint 13\nint 6\n13 - 6\nint 4\nint 5\n4 * 5\n7 + 20\nint 8\nint 3\n8 / 3\n27 + 2\n29\nsyntax error on line 1, token 5\nUnrecognised character . on line 3\nUnrecognised character a on line 1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82203544307227070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ make test2\n(./parser2 input01; \\\n ./parser2 input02; \\\n ./parser2 input03; \\\n ./parser2 input04; \\\n ./parser2 input05)\n15                                       # input01 result\n29                                       # input02 result\nsyntax error on line 1, token 5          # input03 result\nUnrecognised character . on line 3       # input04 result\nUnrecognised character a on line 1       # input05 result`, `82203544307227070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ make test2\n(./parser2 input01; \\\n ./parser2 input02; \\\n ./parser2 input03; \\\n ./parser2 input04; \\\n ./parser2 input05)\n15                                       # input01 result\n29                                       # input02 result\nsyntax error on line 1, token 5          # input03 result\nUnrecognised character . on line 3       # input04 result\nUnrecognised character a on line 1       # input05 result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="结论"><a href="#%E7%BB%93%E8%AE%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>结论</h1>\n<p>现在退后一步，看看我们要做什么。现在我们有：</p>\n<ul>\n<li>识别并以我们的语言返回令牌的扫描仪</li>\n<li>识别我们的语法，报告语法错误并构建抽象语法树的解析器</li>\n<li>解析器的优先级表，用于实现我们语言的语义</li>\n<li>深度优先遍历抽象语法树并在输入中计算表达式结果的解释器</li>\n</ul>\n<p>我们还没有一个编译器。但是，我们非常接近制作第一个编译器！</p>\n<p>在编译器编写过程的下一部分中，我们将替换解释器。取而代之的是我们将编写一个转换器，为具有数学运算符的每个 AST 节点生成 x86-64 汇编代码。我们还将生成一些汇编前同步码和后同步码，以支持生成器输出的汇编代码。</p>',
excerpt:"需求 我们在上一部分中看到，解析器不一定强制执行我们语言的语义，它仅强制执行语法的语法和结构规则。 我们最终得到了计算表达式错误值（如 2 _ 3 + 4 _ 5）的代码，因为该代码创建了一个如下所示的 AST…",frontmatter:{date:"2020-03-02 12:06:36",path:"/tour-of-compiler-operator-precedence/",tags:"编译原理, 语法分析",title:"编译器之旅（三）——运算符优先级",draft:null}},prePost:{html:'<h1 id="需求"><a href="#%E9%9C%80%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求</h1>\n<p>在语言中添加一些声明语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55548080144819780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print 2 + 3 * 5;\nprint 18 - 6/3 + 4*2;`, `55548080144819780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">print 2 + 3 * 5;\nprint 18 - 6/3 + 4*2;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h1 id="准备"><a href="#%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>准备</h1>\n<h2 id="bnf-语法说明"><a href="#bnf-%E8%AF%AD%E6%B3%95%E8%AF%B4%E6%98%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BNF 语法说明</h2>\n<p>我们已经看到了表达式的 BNF 表示法，现在让我们为以上语句定义 BNF 语法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98342481815383210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`statements: statement\n     | statement statements\n     ;\n\nstatement: \'print\' expression \';\'\n     ;`, `98342481815383210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">statements: statement\n     | statement statements\n     ;\n\nstatement: &#39;print&#39; expression &#39;;&#39;\n     ;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输入文件由几个语句组成，它们可以是一个语句，也可以是后面跟有更多语句的语句，每个语句均以关键字开头 print，然后是一个表达式，然后是分号。</p>\n<h1 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h1>\n<h2 id="词法扫描器的更改"><a href="#%E8%AF%8D%E6%B3%95%E6%89%AB%E6%8F%8F%E5%99%A8%E7%9A%84%E6%9B%B4%E6%94%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>词法扫描器的更改</h2>\n<p>在编写解析以上语法的代码之前，我们需要在现有代码中添加更多细节，让我们从词法扫描器开始。</p>\n<p>为分号添加 print 元素很容易，稍后我们将在该语言中有很多关键字，以及变量的标识符，因此我们需要添加一些代码来帮助我们处理它们。</p>\n<p>在 scan.c 中我添加了从 SubC 编译器搬来的这段代码，它将字母数字字符读入缓冲区，直到命中非字母数字字符为止。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64058540063002490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Scan an identifier from the input file and\n// store it in buf[]. Return the identifier\'s length\nstatic int scanident(int c, char *buf, int lim) {\n  int i = 0;\n\n  // Allow digits, alpha and underscores\n  while (isalpha(c) || isdigit(c) || \'_\' == c) {\n    // Error if we hit the identifier length limit,\n    // else append to buf[] and get next character\n    if (lim - 1 == i) {\n      printf(&quot;identifier too long on line %d\\n&quot;, Line);\n      exit(1);\n    } else if (i < lim - 1) {\n      buf[i++] = c;\n    }\n    c = next();\n  }\n  // We hit a non-valid character, put it back.\n  // NUL-terminate the buf[] and return the length\n  putback(c);\n  buf[i] = \'\\0\';\n  return (i);\n}`, `64058540063002490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Scan an identifier from the input file and</span>\n<span class="token comment">// store it in buf[]. Return the identifier\'s length</span>\n<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">scanident</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Allow digits, alpha and underscores</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isalpha</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isdigit</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">\'_\'</span> <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Error if we hit the identifier length limit,</span>\n    <span class="token comment">// else append to buf[] and get next character</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>lim <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"identifier too long on line %d\\n"</span><span class="token punctuation">,</span> Line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> lim <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      buf<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    c <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// We hit a non-valid character, put it back.</span>\n  <span class="token comment">// NUL-terminate the buf[] and return the length</span>\n  <span class="token function">putback</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'\\0\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还需要一个功能来识别语言中的关键字，一种方法是拥有一个关键字列表，并将该列表和每个关键字逐个对比之后放在缓冲区中，SubC 的代码经过优化：在执行之前，与第一个字母匹配可以加快对数十个关键字的比较。现在，我们不需要此优化，但稍后将其放入其中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38389286965777120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Given a word from the input, return the matching\n// keyword token number or 0 if it\'s not a keyword.\n// Switch on the first letter so that we don\'t have\n// to waste time strcmp()ing against all the keywords.\nstatic int keyword(char *s) {\n  switch (*s) {\n    case \'p\':\n      if (!strcmp(s, &quot;print&quot;))\n        return (T_PRINT);\n      break;\n  }\n  return (0);\n}`, `38389286965777120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Given a word from the input, return the matching</span>\n<span class="token comment">// keyword token number or 0 if it\'s not a keyword.</span>\n<span class="token comment">// Switch on the first letter so that we don\'t have</span>\n<span class="token comment">// to waste time strcmp()ing against all the keywords.</span>\n<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keyword</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token string">\'p\'</span><span class="token operator">:</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"print"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>T_PRINT<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 scan() 的 switch 语句的底部，我们添加以下代码以识别分号和关键字：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12659816587866302000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`case \';\':\n  t->token = T_SEMI;\n  break;\ndefault:\n\n  // If it\'s a digit, scan the\n  // literal integer value in\n  if (isdigit(c)) {\n    t->intvalue = scanint(c);\n    t->token = T_INTLIT;\n    break;\n  } else if (isalpha(c) || \'_\' == c) {\n    // Read in a keyword or identifier\n    scanident(c, Text, TEXTLEN);\n\n    // If it\'s a recognised keyword, return that token\n    if (tokentype = keyword(Text)) {\n      t->token = tokentype;\n      break;\n    }\n    // Not a recognised keyword, so an error for now\n    printf(&quot;Unrecognised symbol %s on line %d\\n&quot;, Text, Line);\n    exit(1);\n  }\n  // The character isn\'t part of any recognised token, error\n  printf(&quot;Unrecognised character %c on line %d\\n&quot;, c, Line);\n  exit(1);`, `12659816587866302000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">case</span> <span class="token string">\';\'</span><span class="token operator">:</span>\n  t<span class="token operator">-></span>token <span class="token operator">=</span> T_SEMI<span class="token punctuation">;</span>\n  <span class="token keyword">break</span><span class="token punctuation">;</span>\n<span class="token keyword">default</span><span class="token operator">:</span>\n\n  <span class="token comment">// If it\'s a digit, scan the</span>\n  <span class="token comment">// literal integer value in</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    t<span class="token operator">-></span>intvalue <span class="token operator">=</span> <span class="token function">scanint</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    t<span class="token operator">-></span>token <span class="token operator">=</span> T_INTLIT<span class="token punctuation">;</span>\n    <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isalpha</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">\'_\'</span> <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Read in a keyword or identifier</span>\n    <span class="token function">scanident</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> TEXTLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// If it\'s a recognised keyword, return that token</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">=</span> <span class="token function">keyword</span><span class="token punctuation">(</span>Text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      t<span class="token operator">-></span>token <span class="token operator">=</span> tokentype<span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// Not a recognised keyword, so an error for now</span>\n    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognised symbol %s on line %d\\n"</span><span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// The character isn\'t part of any recognised token, error</span>\n  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognised character %c on line %d\\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> Line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我还添加了一个全局 Text 缓冲区来存储关键字和标识符：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65453277225736500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#define TEXTLEN         512             // Length of symbols in input\nextern_ char Text[TEXTLEN + 1];         // Last identifier scanned`, `65453277225736500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> TEXTLEN         512             </span><span class="token comment">// Length of symbols in input</span>\nextern_ <span class="token keyword">char</span> Text<span class="token punctuation">[</span>TEXTLEN <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>         <span class="token comment">// Last identifier scanned</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="对表达式解析器的更改"><a href="#%E5%AF%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%A7%A3%E6%9E%90%E5%99%A8%E7%9A%84%E6%9B%B4%E6%94%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对表达式解析器的更改</h2>\n<p>到目前为止我们的输入文件只包含一个表达式，因此在 binexpr()（expr.c）中的 Pratt 解析器代码中，我们有以下代码退出解析器：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78879489505755480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// If no tokens left, return just the left node\ntokentype = Token.token;\nif (tokentype == T_EOF)\n  return (left);`, `78879489505755480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// If no tokens left, return just the left node</span>\ntokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用我们的新语法每个表达式都以分号结尾（不是以文件结尾即 T<em>EOF），因此我们需要在表达式解析器中更改代码以发现 T</em>SEMI 标记并退出表达式解析：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51262803219650000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Return an AST tree whose root is a binary operator.\n// Parameter ptp is the previous token\'s precedence.\nstruct ASTnode *binexpr(int ptp) {\n  struct ASTnode *left, *right;\n  int tokentype;\n\n  // Get the integer literal on the left.\n  // Fetch the next token at the same time.\n  left = primary();\n\n  // If we hit a semicolon, return just the left node\n  tokentype = Token.token;\n  if (tokentype == T_SEMI)\n    return (left);\n\n    while (op_precedence(tokentype) > ptp) {\n      ...\n\n    // Update the details of the current token.\n    // If we hit a semicolon, return just the left node\n    tokentype = Token.token;\n    if (tokentype == T_SEMI)\n      return (left);\n    }\n}`, `51262803219650000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Return an AST tree whose root is a binary operator.</span>\n<span class="token comment">// Parameter ptp is the previous token\'s precedence.</span>\n<span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span><span class="token function">binexpr</span><span class="token punctuation">(</span><span class="token keyword">int</span> ptp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>left<span class="token punctuation">,</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>\n  <span class="token keyword">int</span> tokentype<span class="token punctuation">;</span>\n\n  <span class="token comment">// Get the integer literal on the left.</span>\n  <span class="token comment">// Fetch the next token at the same time.</span>\n  left <span class="token operator">=</span> <span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// If we hit a semicolon, return just the left node</span>\n  tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_SEMI<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">op_precedence</span><span class="token punctuation">(</span>tokentype<span class="token punctuation">)</span> <span class="token operator">></span> ptp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token comment">// Update the details of the current token.</span>\n    <span class="token comment">// If we hit a semicolon, return just the left node</span>\n    tokentype <span class="token operator">=</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokentype <span class="token operator">==</span> T_SEMI<span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="对代码生成器的更改"><a href="#%E5%AF%B9%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E6%9B%B4%E6%94%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对代码生成器的更改</h2>\n<p>我想将通用代码生成器 gen.c 与 CPU 中的特定代码分开 cg.c，这也意味着其余的编译器只能调用 gen.c 的代码，并且 gen.c 只可以调用 cg.c 中的代码。</p>\n<p>为此我在 gen.c 中定义了一些新的函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19701584716759620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`void genpreamble()        { cgpreamble(); }\nvoid genpostamble()       { cgpostamble(); }\nvoid genfreeregs()        { freeall_registers(); }\nvoid genprintint(int reg) { cgprintint(reg); }`, `19701584716759620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">void</span> <span class="token function">genpreamble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span> <span class="token function">cgpreamble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token keyword">void</span> <span class="token function">genpostamble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token punctuation">{</span> <span class="token function">cgpostamble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token keyword">void</span> <span class="token function">genfreeregs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span> <span class="token function">freeall_registers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token keyword">void</span> <span class="token function">genprintint</span><span class="token punctuation">(</span><span class="token keyword">int</span> reg<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">cgprintint</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="为语句添加解析器"><a href="#%E4%B8%BA%E8%AF%AD%E5%8F%A5%E6%B7%BB%E5%8A%A0%E8%A7%A3%E6%9E%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为语句添加解析器</h2>\n<p>stmt.c 将保存我们语言中所有主要语句的解析代码，现在我们需要解析 BNF 语法通过此单个功能即可完成，我已经将递归定义转换为循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52451144462138250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Parse one or more statements\nvoid statements(void) {\n  struct ASTnode *tree;\n  int reg;\n\n  while (1) {\n    // Match a \'print\' as the first token\n    match(T_PRINT, &quot;print&quot;);\n\n    // Parse the following expression and\n    // generate the assembly code\n    tree = binexpr(0);\n    reg = genAST(tree);\n    genprintint(reg);\n    genfreeregs();\n\n    // Match the following semicolon\n    // and stop if we are at EOF\n    semi();\n    if (Token.token == T_EOF)\n      return;\n  }\n}`, `52451144462138250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Parse one or more statements</span>\n<span class="token keyword">void</span> <span class="token function">statements</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>tree<span class="token punctuation">;</span>\n  <span class="token keyword">int</span> reg<span class="token punctuation">;</span>\n\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Match a \'print\' as the first token</span>\n    <span class="token function">match</span><span class="token punctuation">(</span>T_PRINT<span class="token punctuation">,</span> <span class="token string">"print"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Parse the following expression and</span>\n    <span class="token comment">// generate the assembly code</span>\n    tree <span class="token operator">=</span> <span class="token function">binexpr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    reg <span class="token operator">=</span> <span class="token function">genAST</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">genprintint</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">genfreeregs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Match the following semicolon</span>\n    <span class="token comment">// and stop if we are at EOF</span>\n    <span class="token function">semi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>Token<span class="token punctuation">.</span>token <span class="token operator">==</span> T_EOF<span class="token punctuation">)</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在每个循环中代码都会找到一个 <code class="language-text">T_PRINT</code> 元素，然后它调用 <code class="language-text">binexpr()</code> 解析表达式，最后它找到 <code class="language-text">T_SEMI</code> 元素，如果紧跟着 <code class="language-text">T_EOF</code> 元素，我们就会跳出循环。</p>\n<p>在每个表达式树之后，将 gen.c 调用的代码以将树转换为汇编代码，并调用 printint() 函数以打印出最终值。</p>\n<h2 id="一些辅助功能"><a href="#%E4%B8%80%E4%BA%9B%E8%BE%85%E5%8A%A9%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一些辅助功能</h2>\n<p>上面的代码中有几个新的辅助函数，我将它们放入一个新文件中 misc.c：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35723518793958654000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Ensure that the current token is t,\n// and fetch the next token. Otherwise\n// throw an error\nvoid match(int t, char *what) {\n  if (Token.token == t) {\n    scan(&Token);\n  } else {\n    printf(&quot;%s expected on line %d\\n&quot;, what, Line);\n    exit(1);\n  }\n}\n\n// Match a semicon and fetch the next token\nvoid semi(void) {\n  match(T_SEMI, &quot;;&quot;);\n}`, `35723518793958654000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Ensure that the current token is t,</span>\n<span class="token comment">// and fetch the next token. Otherwise</span>\n<span class="token comment">// throw an error</span>\n<span class="token keyword">void</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Token<span class="token punctuation">.</span>token <span class="token operator">==</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s expected on line %d\\n"</span><span class="token punctuation">,</span> what<span class="token punctuation">,</span> Line<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// Match a semicon and fetch the next token</span>\n<span class="token keyword">void</span> <span class="token function">semi</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">match</span><span class="token punctuation">(</span>T_SEMI<span class="token punctuation">,</span> <span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些构成了解析器中语法检查的一部分，稍后我将添加更多简短函数 match() 以使我们的语法检查更加容易。</p>\n<h2 id="更改为-main"><a href="#%E6%9B%B4%E6%94%B9%E4%B8%BA-main" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更改为 main()</h2>\n<p>main() 用于 binexpr() 直接调用以解析旧输入文件中的单个表达式，现在执行此操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97123040391320760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`scan(&Token);                 // Get the first token from the input\ngenpreamble();                // Output the preamble\nstatements();                 // Parse the statements in the input\ngenpostamble();               // Output the postamble\nfclose(Outfile);              // Close the output file and exit\nexit(0);`, `97123040391320760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token function">scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// Get the first token from the input</span>\n<span class="token function">genpreamble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// Output the preamble</span>\n<span class="token function">statements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// Parse the statements in the input</span>\n<span class="token function">genpostamble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// Output the postamble</span>\n<span class="token function">fclose</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// Close the output file and exit</span>\n<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="运行结果"><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行结果</h1>\n<h2 id="输入"><a href="#%E8%BE%93%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输入</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83729049327687580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print 12 * 3;\nprint\n   18 - 2\n      * 4; print\n1 + 2 +\n  9 - 5/2 + 3*5;`, `83729049327687580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">print 12 * 3;\nprint\n   18 - 2\n      * 4; print\n1 + 2 +\n  9 - 5/2 + 3*5;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="输出"><a href="#%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输出</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41962652706702540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ make test\n# -o：编译可执行文件的地址 -g：便于调试\ncc -o comp1 -g cg.c expr.c gen.c main.c misc.c scan.c stmt.c tree.c\n# 执行并生成汇编文件\n./comp1 input01\n# 编译汇编文件 out.s 到可执行文件 out\ncc -o out out.s\n./out\n36\n10\n25`, `41962652706702540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">make</span> <span class="token builtin class-name">test</span>\n<span class="token comment"># -o：编译可执行文件的地址 -g：便于调试</span>\ncc -o comp1 -g cg.c expr.c gen.c main.c misc.c scan.c stmt.c tree.c\n<span class="token comment"># 执行并生成汇编文件</span>\n./comp1 input01\n<span class="token comment"># 编译汇编文件 out.s 到可执行文件 out</span>\ncc -o out out.s\n./out\n<span class="token number">36</span>\n<span class="token number">10</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>out.s</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="693171611101961500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\t.text\n.LC0:\n\t.string\t&quot;%d\\n&quot;\nprintint:\n\tpushq\t%rbp\n\tmovq\t%rsp, %rbp\n\tsubq\t\\$16, %rsp\n\tmovl\t%edi, -4(%rbp)\n\tmovl\t-4(%rbp), %eax\n\tmovl\t%eax, %esi\n\tleaq\t.LC0(%rip), %rdi\n\tmovl\t\\$0, %eax\n\tcall\tprintf@PLT\n\tnop\n\tleave\n\tret\n\n\t.globl\tmain\n\t.type\tmain, @function\nmain:\n\tpushq\t%rbp\n\tmovq\t%rsp, %rbp\n\tmovq\t\\$12, %r8\n\tmovq\t\\$3, %r9\n\timulq\t%r8, %r9\n\tmovq\t%r9, %rdi\n\tcall\tprintint\n\tmovq\t\\$18, %r8\n\tmovq\t\\$2, %r9\n\tmovq\t\\$4, %r10\n\timulq\t%r9, %r10\n\tsubq\t%r10, %r8\n\tmovq\t%r8, %rdi\n\tcall\tprintint\n\tmovq\t\\$1, %r8\n\tmovq\t\\$2, %r9\n\taddq\t%r8, %r9\n\tmovq\t\\$9, %r8\n\taddq\t%r9, %r8\n\tmovq\t\\$5, %r9\n\tmovq\t\\$2, %r10\n\tmovq\t%r9,%rax\n\tcqo\n\tidivq\t%r10\n\tmovq\t%rax,%r9\n\tsubq\t%r9, %r8\n\tmovq\t\\$3, %r9\n\tmovq\t\\$5, %r10\n\timulq\t%r9, %r10\n\taddq\t%r8, %r10\n\tmovq\t%r10, %rdi\n\tcall\tprintint\n\tmovl\t\\$0, %eax\n\tpopq\t%rbp\n\tret`, `693171611101961500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">\t.text\n.LC0:\n\t.string\t&quot;%d\\n&quot;\nprintint:\n\tpushq\t%rbp\n\tmovq\t%rsp, %rbp\n\tsubq\t$16, %rsp\n\tmovl\t%edi, -4(%rbp)\n\tmovl\t-4(%rbp), %eax\n\tmovl\t%eax, %esi\n\tleaq\t.LC0(%rip), %rdi\n\tmovl\t$0, %eax\n\tcall\tprintf@PLT\n\tnop\n\tleave\n\tret\n\n\t.globl\tmain\n\t.type\tmain, @function\nmain:\n\tpushq\t%rbp\n\tmovq\t%rsp, %rbp\n\tmovq\t$12, %r8\n\tmovq\t$3, %r9\n\timulq\t%r8, %r9\n\tmovq\t%r9, %rdi\n\tcall\tprintint\n\tmovq\t$18, %r8\n\tmovq\t$2, %r9\n\tmovq\t$4, %r10\n\timulq\t%r9, %r10\n\tsubq\t%r10, %r8\n\tmovq\t%r8, %rdi\n\tcall\tprintint\n\tmovq\t$1, %r8\n\tmovq\t$2, %r9\n\taddq\t%r8, %r9\n\tmovq\t$9, %r8\n\taddq\t%r9, %r8\n\tmovq\t$5, %r9\n\tmovq\t$2, %r10\n\tmovq\t%r9,%rax\n\tcqo\n\tidivq\t%r10\n\tmovq\t%rax,%r9\n\tsubq\t%r9, %r8\n\tmovq\t$3, %r9\n\tmovq\t$5, %r10\n\timulq\t%r9, %r10\n\taddq\t%r8, %r10\n\tmovq\t%r10, %rdi\n\tcall\tprintint\n\tmovl\t$0, %eax\n\tpopq\t%rbp\n\tret</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="结论"><a href="#%E7%BB%93%E8%AE%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>结论</h1>\n<p>我们已经在语言中添加了第一个 “真实” 语句语法，我已经用 BNF 表示法定义了它，但是通过循环而不是递归地实现它更容易。不用担心，我们将尽快返回递归解析。</p>\n<p>在此过程中，我们必须修改扫描程序，添加对关键字和标识符的支持，并更清晰地将通用代码生成器和特定于 CPU 的生成器分开。</p>\n<p>在编译器编写过程的下一部分中，我们将向语言添加变量。这将需要大量的工作。</p>',
excerpt:"需求 在语言中添加一些声明语句： 准备 BNF 语法说明 我们已经看到了表达式的 BNF 表示法，现在让我们为以上语句定义 BNF 语法： 输入文件由几个语句组成，它们可以是一个语句，也可以是后面跟有更多语句的语句，每个语句均以关键字开头 print…",frontmatter:{date:"2020-03-04 14:42:21",path:"/tour-of-compiler-declarative-statement/",tags:"编译原理, 声明语句",title:"编译器之旅（五）——声明语句",draft:null}}},pathContext:{mainPostPath:"/tour-of-compiler-real-compiler/",nextPostPath:"/tour-of-compiler-operator-precedence/",prePostPath:"/tour-of-compiler-declarative-statement/"}}}});
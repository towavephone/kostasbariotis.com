webpackJsonp([0xc553ded41ad2],{1316:function(n,s){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"项目架构 公司项目分为以下几种架构： 主项目-扩展项目：扩展项目前端独立，是以 npm 包的形式安装到主项目，后端可以独立编译，但不能独立运行，即后端与主项目共用一套，主项目需要对扩展项目编译出的后端代码进行监听来实现增量编译 主项目-子项目：微前端架构，子项目前、后端独立可运行 需求背景 需要解决主项目-扩展项目架构下主项目的后端不能增量编译的问题 技术选型 选型 优点 缺点 直接在 node_modules 目录下开发 主项目已实现对 node_modules 下扩展项目的监听 每次 npm…",html:'<h1 id="项目架构"><a href="#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目架构</h1>\n<p>公司项目分为以下几种架构：</p>\n<ol>\n<li>主项目-扩展项目：扩展项目前端独立，是以 npm 包的形式安装到主项目，后端可以独立编译，但不能独立运行，即后端与主项目共用一套，主项目需要对扩展项目编译出的后端代码进行监听来实现增量编译</li>\n<li>主项目-子项目：微前端架构，子项目前、后端独立可运行</li>\n</ol>\n<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>需要解决主项目-扩展项目架构下主项目的后端不能增量编译的问题</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<table>\n<thead>\n<tr>\n<th align="center">选型</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">直接在 node_modules 目录下开发</td>\n<td align="center">主项目已实现对 node_modules 下扩展项目的监听</td>\n<td align="center">每次 npm install 都要重新新建项目</td>\n</tr>\n<tr>\n<td align="center">gulp 文件同步</td>\n<td align="center">有第三方插件</td>\n<td align="center">需要多运行一个文件同步脚本</td>\n</tr>\n<tr>\n<td align="center">npm link</td>\n<td align="center">不需要多运行一个脚本</td>\n<td align="center">需要每次手动重启主项目来让后端代码生效</td>\n</tr>\n<tr>\n<td align="center">nodemon + npm link</td>\n<td align="center">监听到扩展项目变化自动重启</td>\n<td align="center">每次 npm install 都要重新 npm link</td>\n</tr>\n</tbody>\n</table>\n<h1 id="解决过程"><a href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决过程</h1>\n<h2 id="gulp-文件同步"><a href="#gulp-%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gulp 文件同步</h2>\n<p>核心逻辑：监听扩展项目编译出来的后端代码，发现改动时同步到 node_modules 下扩展项目的位置</p>\n<p>./config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54127023807999890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  //同步文件更改到指定目录\n  syncTo: \'../主项目/node_modules/扩展项目/extend\'\n};`, `54127023807999890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">//同步文件更改到指定目录</span>\n  syncTo<span class="token punctuation">:</span> <span class="token string">\'../主项目/node_modules/扩展项目/extend\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>./gulpfile.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93685592944135080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const gulp = require(\'gulp\');\nconst fileSync = require(\'gulp-file-sync\');\nconst { syncTo } = require(\'./config\');\nconst mkdirp = require(\'mkdirp\');\nconst fs = require(\'fs\');\nconst watch = require(\'gulp-watch\');\nconst run = require(\'run-sequence\');\n\ngulp.task(\'sync\', function() {\n  try {\n    let state = fs.statSync(syncTo);\n    if (!state.isDirectory()) {\n      mkdirp(syncTo);\n    }\n  } catch (e) {\n    console.log(e);\n    mkdirp(syncTo);\n  }\n\n  fileSync(\'extend\', syncTo);\n});\n\ngulp.task(\'watch-extend\', function() {\n  watch([\'./extend/**\'], function() {\n    run(\'sync\');\n  });\n});\n\ngulp.task(\'watch\', [\'watch-extend\']);\n\ngulp.task(\'default\', [\'sync\', \'watch\']);`, `93685592944135080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fileSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-file-sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> syncTo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'mkdirp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> watch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-watch\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'run-sequence\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'sync\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> state <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">mkdirp</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">mkdirp</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">fileSync</span><span class="token punctuation">(</span><span class="token string">\'extend\'</span><span class="token punctuation">,</span> syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'watch-extend\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'./extend/**\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'watch\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'watch-extend\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'default\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'sync\'</span><span class="token punctuation">,</span> <span class="token string">\'watch\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="nodemon--npm-link"><a href="#nodemon--npm-link" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nodemon + npm link</h2>\n<ol>\n<li>对扩展项目进行 npm link 操作，然后在主项目中 npm link 扩展项目，可以在主项目的 node_modules 下看到指向扩展项目的软链接</li>\n<li>主项目使用了 nodemon 来监听 node_modules 文件变化，鉴于每次重启主项目之后扩展项目的代码才会生效的问题，需要解决 nodemon 不能监听软链接下文件变化的问题</li>\n</ol>\n<p>核心逻辑：</p>\n<ol>\n<li>在不影响 nodemon 脚本调用逻辑的情况下，在 nodemon.json 添加 <code class="language-text">watchSymbolLink</code> 属性，明确监听软链接的文件位置</li>\n<li>利用 glob 三方库读取 watchSymbolLink 下的文件，当判断读到的文件是软链接文件时（isSymbolicLink），读取真实的文件路径（realpathSync）</li>\n<li>在监听原来文件的基础上，调用 nodemon 监听另外真实的文件路径</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77159057648057090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;scripts&quot;: {\n    &quot;dev:server&quot;: &quot;node bin/nodemon.js --config nodemon.json ./bin/www&quot;\n  }\n}`, `77159057648057090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                json 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"dev:server"</span><span class="token operator">:</span> <span class="token string">"node bin/nodemon.js --config nodemon.json ./bin/www"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bin\\nodemon.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43835257051347500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const nodemon = require(\'nodemon\');\nconst nodemonCli = require(\'nodemon/lib/cli\');\nconst options = nodemonCli.parse(process.argv);\nconst glob = require(\'glob\');\nconst fs = require(\'fs\');\nconst lodash = require(\'lodash\');\nconst path = require(\'path\');\n\n// &quot;watchSymbolLink&quot;: [\n//   {\n//     &quot;url&quot;: &quot;node_modules/sugo-analytics-extend-*&quot;,\n//     &quot;path&quot;: &quot;/extend/app/**/*&quot;\n//   },\n// ],\n// 或\n// &quot;watchSymbolLink&quot;: [\n//    &quot;node_modules/sugo-analytics-extend-*&quot;,\n// ],\nconst { configFile, ...optionsRest } = options;\n\nconst nodemonJsonPath = path.join(process.cwd(), configFile);\n\nconst nodemonJson = require(nodemonJsonPath);\n\nconst { watch, watchSymbolLink = [], ...nodemonJsonRest } = nodemonJson;\n\nconst dirs = [];\n\nwatchSymbolLink.forEach((item) => {\n  const { url, path: linkPath = \'\' } = lodash.isObject(item) ? item : { url: item };\n  const paths = glob\n    .sync(url)\n    .filter((a) => fs.lstatSync(a).isSymbolicLink())\n    .map((a) => path.join(fs.realpathSync(a), linkPath));\n  dirs.push(...paths);\n});\n\nconst opts = {\n  ...optionsRest,\n  ...nodemonJsonRest,\n  watch: [...watch, ...dirs]\n};\n\n// console.log(opts)\n\nnodemon(opts);\n\nnodemon.on(\'quit\', function() {\n  process.exit();\n});\n\nconst packageJsonPath = path.join(process.cwd(), \'package.json\');\n\n// checks for available update and returns an instance\nconst pkg = JSON.parse(fs.readFileSync(packageJsonPath));\n\nif (pkg.version.indexOf(\'0.0.0\') !== 0 && options.noUpdateNotifier !== true) {\n  require(\'update-notifier\')({ pkg }).notify();\n}`, `43835257051347500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> nodemon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'nodemon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> nodemonCli <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'nodemon/lib/cli\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> options <span class="token operator">=</span> nodemonCli<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'glob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// "watchSymbolLink": [</span>\n<span class="token comment">//   {</span>\n<span class="token comment">//     "url": "node_modules/sugo-analytics-extend-*",</span>\n<span class="token comment">//     "path": "/extend/app/**/*"</span>\n<span class="token comment">//   },</span>\n<span class="token comment">// ],</span>\n<span class="token comment">// 或</span>\n<span class="token comment">// "watchSymbolLink": [</span>\n<span class="token comment">//    "node_modules/sugo-analytics-extend-*",</span>\n<span class="token comment">// ],</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> configFile<span class="token punctuation">,</span> <span class="token operator">...</span>optionsRest <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> nodemonJsonPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> nodemonJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>nodemonJsonPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> watch<span class="token punctuation">,</span> watchSymbolLink <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>nodemonJsonRest <span class="token punctuation">}</span> <span class="token operator">=</span> nodemonJson<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> dirs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nwatchSymbolLink<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> path<span class="token punctuation">:</span> linkPath <span class="token operator">=</span> <span class="token string">\'\'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">?</span> item <span class="token punctuation">:</span> <span class="token punctuation">{</span> url<span class="token punctuation">:</span> item <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> paths <span class="token operator">=</span> glob\n    <span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> fs<span class="token punctuation">.</span><span class="token function">lstatSync</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSymbolicLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> linkPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token operator">...</span>optionsRest<span class="token punctuation">,</span>\n  <span class="token operator">...</span>nodemonJsonRest<span class="token punctuation">,</span>\n  watch<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>watch<span class="token punctuation">,</span> <span class="token operator">...</span>dirs<span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// console.log(opts)</span>\n\n<span class="token function">nodemon</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nnodemon<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'quit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageJsonPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// checks for available update and returns an instance</span>\n<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>packageJsonPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'0.0.0\'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>noUpdateNotifier <span class="token operator">!==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'update-notifier\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pkg <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nodemon.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99655733007392850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;restartable&quot;: &quot;rs&quot;,\n  &quot;ignore&quot;: [&quot;.git&quot;, &quot;node_modules&quot;, &quot;node_modules/**/node_modules&quot;],\n  &quot;verbose&quot;: true,\n  &quot;execMap&quot;: {\n    &quot;js&quot;: &quot;node --harmony&quot;\n  },\n  &quot;events&quot;: {\n    &quot;restart&quot;: &quot;osascript -e \'display notification \\&quot;App restarted due to:\\n\'\\$FILENAME\'\\&quot; with title \\&quot;nodemon\\&quot;\'&quot;\n  },\n  &quot;watch&quot;: [\n    &quot;src/server&quot;,\n    &quot;src/common&quot;,\n    &quot;config.default.js&quot;,\n    &quot;node_modules/sugo-analytics-extend-*/extend/app/**/*&quot;,\n    &quot;config.js&quot;\n  ],\n  &quot;watchSymbolLink&quot;: [\n    {\n      &quot;url&quot;: &quot;node_modules/sugo-analytics-extend-*&quot;,\n      &quot;path&quot;: &quot;extend/app/**/*&quot;\n    }\n  ],\n  &quot;env&quot;: {\n    &quot;NODE_ENV&quot;: &quot;development&quot;\n  },\n  &quot;delay&quot;: &quot;1000&quot;,\n  &quot;ext&quot;: &quot;js,json&quot;\n}`, `99655733007392850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                json{12-17} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"restartable"</span><span class="token operator">:</span> <span class="token string">"rs"</span><span class="token punctuation">,</span>\n  <span class="token property">"ignore"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">".git"</span><span class="token punctuation">,</span> <span class="token string">"node_modules"</span><span class="token punctuation">,</span> <span class="token string">"node_modules/**/node_modules"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">"verbose"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token property">"execMap"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"js"</span><span class="token operator">:</span> <span class="token string">"node --harmony"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"events"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"restart"</span><span class="token operator">:</span> <span class="token string">"osascript -e \'display notification \\"App restarted due to:\\n\'$FILENAME\'\\" with title \\"nodemon\\"\'"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"watch"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n<span class="gatsby-highlight-code-line">    <span class="token string">"src/server"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token string">"src/common"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token string">"config.default.js"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token string">"node_modules/sugo-analytics-extend-*/extend/app/**/*"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token string">"config.js"</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>  <span class="token property">"watchSymbolLink"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"node_modules/sugo-analytics-extend-*"</span><span class="token punctuation">,</span>\n      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"extend/app/**/*"</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"NODE_ENV"</span><span class="token operator">:</span> <span class="token string">"development"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"delay"</span><span class="token operator">:</span> <span class="token string">"1000"</span><span class="token punctuation">,</span>\n  <span class="token property">"ext"</span><span class="token operator">:</span> <span class="token string">"js,json"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/github/workspace/blog/基于nodemon实现监听文件链接变化/index.md absPath of file >>> MarkdownRemark",timeToRead:3,frontmatter:{date:"2021-01-05 10:02:54",path:"/nodemon-monitor-link-changes/",tags:"后端, nodejs, nodemon, 预研",title:"基于nodemon实现监听文件链接变化",draft:null}}],length:1,tag:"nodemon",pagesSum:1,page:1}}}});
webpackJsonp([0x668a6acfd844],{1413:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"需求背景 由于客服聊天组件需要支持以新窗口的形式打开，也就是以 window.open 的新窗口打开，同时需要支持嵌入公司自己的产品端，在技术攻关的过程中遇到很多问题，特此记录 问题及解决方案 标记为横线的为完成需求后发现现阶段不需要做的 跨域窗口间的通信： 编写底层通信库 、通过 url 传递 嵌入公司产品端：独立客服聊天组件的运行环境 设置新窗口位置：需要注意兼容分屏情况 监听新窗口打开情况： 通过底层库发消息 、获取 window.open 的 closed…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于客服聊天组件需要支持以新窗口的形式打开，也就是以 window.open 的新窗口打开，同时需要支持嵌入公司自己的产品端，在技术攻关的过程中遇到很多问题，特此记录</p>\n<h1 id="问题及解决方案"><a href="#%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题及解决方案</h1>\n<p>标记为横线的为完成需求后发现现阶段不需要做的</p>\n<ol>\n<li>跨域窗口间的通信：<s>编写底层通信库</s>、通过 url 传递</li>\n<li>嵌入公司产品端：独立客服聊天组件的运行环境</li>\n<li>设置新窗口位置：需要注意兼容分屏情况</li>\n<li>监听新窗口打开情况：<s>通过底层库发消息</s>、获取 window.open 的 closed 属性</li>\n<li><s>监听新窗口是否加载完成</s>：<s>通过底层库发消息</s></li>\n<li>聊天消息输入类 html 字符：匹配特定字符进行 html 渲染，其他字符按文本渲染</li>\n</ol>\n<h1 id="具体解决"><a href="#%E5%85%B7%E4%BD%93%E8%A7%A3%E5%86%B3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体解决</h1>\n<h2 id="跨域窗口间通信"><a href="#%E8%B7%A8%E5%9F%9F%E7%AA%97%E5%8F%A3%E9%97%B4%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域窗口间通信</h2>\n<h3 id="底层库编写"><a href="#%E5%BA%95%E5%B1%82%E5%BA%93%E7%BC%96%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>底层库编写</h3>\n<p>因为需要知道打开的是哪个技能组（相当于群），需要传递技能组的相关信息，首先需要编写底层库，核心代码如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97828011609908970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default class Bus {\n    private syncFns: Array<SyncFn> = []\n\n    constructor(public origin: string, syncFn: SyncFn | Array<SyncFn>) {\n        this.init()\n        this.syncFns = Array.isArray(syncFn) ? syncFn : [syncFn]\n    }\n\n    private init(): void {\n        window.addEventListener(&quot;message&quot;, this.receiveMsg.bind(this), false)\n    }\n\n    // 获取跨域消息\n    private receiveMsg(e) {\n        const { origin } = e\n        if (this.origin !== \'*\' && origin !== this.origin) return\n        const { name, data } = e.data\n        this.syncFns.forEach(item => {\n            if (item.name === name) {\n                item.fn(data, e)\n            }\n        })\n    }\n\n    // 发送跨域消息\n    postMessage(windowInstance: object, swMessage: SWMessage, targetOrigin: string) {\n        windowInstance && windowInstance.postMessage(swMessage, targetOrigin)\n    }\n}`, `97828011609908970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Bus</span> <span class="token punctuation">{</span>\n    <span class="token keyword">private</span> syncFns<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>SyncFn<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> origin<span class="token punctuation">:</span> string<span class="token punctuation">,</span> syncFn<span class="token punctuation">:</span> SyncFn <span class="token operator">|</span> Array<span class="token operator">&lt;</span>SyncFn<span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>syncFns <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>syncFn<span class="token punctuation">)</span> <span class="token operator">?</span> syncFn <span class="token punctuation">:</span> <span class="token punctuation">[</span>syncFn<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">private</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>\n        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">receiveMsg</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 获取跨域消息</span>\n    <span class="token keyword">private</span> <span class="token function">receiveMsg</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> origin <span class="token punctuation">}</span> <span class="token operator">=</span> e\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">!==</span> <span class="token string">\'*\'</span> <span class="token operator">&amp;&amp;</span> origin <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token keyword">return</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>data\n        <span class="token keyword">this</span><span class="token punctuation">.</span>syncFns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                item<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 发送跨域消息</span>\n    <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token parameter">windowInstance<span class="token punctuation">:</span> object<span class="token punctuation">,</span> swMessage<span class="token punctuation">:</span> SWMessage<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        windowInstance <span class="token operator">&amp;&amp;</span> windowInstance<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>swMessage<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="传递数据"><a href="#%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传递数据</h3>\n<p>注意加重部分，由于以上代码不知道什么时候新窗口加载完毕，提前发送消息会没效果，所以设置了延时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7421933989399277000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  setTimeout(() => {\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  }, 2000);\n});`, `7421933989399277000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56165510885003076000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html\nvar caller = new Bus(\'http://localhost:10001\', [\n  {\n    name: \'nickname\',\n    fn: (data, e) => {\n      console.log(\'收到主页面的消息\', data);\n      caller.postMessage(\n        e.source,\n        {\n          name: \'message\',\n          data: {\n            name: \\`hello \\${data.name}\\`\n          }\n        },\n        \'http://localhost:10001\'\n      );\n    }\n  }\n]);`, `56165510885003076000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://localhost:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到主页面的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>\n        e<span class="token punctuation">.</span>source<span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'http://localhost:10001\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行效果：</p>\n<p><img src="/static/cross-origin-1-12fef4bc58b79e2c34b6982487f764b8.gif" alt="跨域传输"></p>\n<h3 id="监听新窗口是否加载完成"><a href="#%E7%9B%91%E5%90%AC%E6%96%B0%E7%AA%97%E5%8F%A3%E6%98%AF%E5%90%A6%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听新窗口是否加载完成</h3>\n<p>setTimeout 设置的延时不够准确，需要采用以下方案</p>\n<h4 id="监听-windowopen-的-onload-事件（跨域下失效）"><a href="#%E7%9B%91%E5%90%AC-windowopen-%E7%9A%84-onload-%E4%BA%8B%E4%BB%B6%EF%BC%88%E8%B7%A8%E5%9F%9F%E4%B8%8B%E5%A4%B1%E6%95%88%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听 window.open 的 onload 事件（跨域下失效）</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34862034481319793000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  popup.onload = function() {\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  };\n});`, `34862034481319793000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  popup<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>刚开始打算监听 window.open 的 onload 事件，但是在不同域名下会报错</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-63438.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 13.785790031813361%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAlklEQVQI1zXGQQ6CMBBAUe5/ORQXJgIFKaVFhZmhtXSKpOLC5OXnZ+NYTXNHpAAkYk/YI0iCzpIiMq2SRgttmkGLx/MOqAEHmBXCcMhWUXB9CqLwoljbi2sKqvKpzo04v+5XVDcem6jKqGs+qJKN4LkPkwRVZsn5hEsimxaXyLH1YXGenCMb7HvnmHhLv/4nftK2H3bevrm4ptENSXdeAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 07 01 21 58 38"\n        title=""\n        src="/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-fee1c.png"\n        srcset="/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-a67b7.png 200w,\n/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-0b187.png 400w,\n/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-fee1c.png 800w,\n/static/2020-07-01-21-58-38-3f981e69c746207e6e9d847cff057bd9-63438.png 943w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h4 id="跨域发送消息检测加载完成"><a href="#%E8%B7%A8%E5%9F%9F%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%A3%80%E6%B5%8B%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跨域发送消息检测加载完成</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87988116941792720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 主页面 index.html，访问域名为 http://localhost:10001\nvar isLoaded = false;\nvar caller = new Bus(\'http://127.0.0.1:10001\', [\n  {\n    name: \'message\',\n    fn: (data) => {\n      console.log(\'收到新窗口的消息\', data);\n    }\n  },\n  {\n    name: \'newWindowLoad\',\n    fn: () => {\n      isLoaded = true;\n      console.log(\'新窗口加载完成\');\n    }\n  }\n]);\n\ndocument.querySelector(\'#button\').addEventListener(\'click\', function() {\n  var popup = window.open(\'http://127.0.0.1:10001/popup.html\', \'\', \'width=300,height=300,top=100,left=200\');\n  isLoaded = false;\n  var timer = setInterval(() => {\n    if (!isLoaded) {\n      return;\n    }\n    timer && clearInterval(timer);\n    caller.postMessage(\n      popup,\n      {\n        name: \'nickname\',\n        data: {\n          name: \'towavephone\'\n        }\n      },\n      \'http://127.0.0.1:10001\'\n    );\n  }, 0);\n});`, `87988116941792720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 主页面 index.html，访问域名为 http://localhost:10001</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">var</span> isLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到新窗口的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    name<span class="token punctuation">:</span> <span class="token string">\'newWindowLoad\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      isLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'新窗口加载完成\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndocument<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#button\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">\'http://127.0.0.1:10001/popup.html\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'width=300,height=300,top=100,left=200\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  isLoaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">      popup<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        data<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          name<span class="token punctuation">:</span> <span class="token string">\'towavephone\'</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token string">\'http://127.0.0.1:10001\'</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35078584237141830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html\nvar caller = new Bus(\'http://localhost:10001\', [\n  {\n    name: \'nickname\',\n    fn: (data, e) => {\n      console.log(\'收到主页面的消息\', data);\n      caller.postMessage(\n        e.source,\n        {\n          name: \'message\',\n          data: {\n            name: \\`hello \\${data.name}\\`\n          }\n        },\n        \'http://localhost:10001\'\n      );\n    }\n  }\n]);\n\ncaller.postMessage(\n  window.opener,\n  {\n    name: \'newWindowLoad\'\n  },\n  \'http://localhost:10001\'\n);`, `35078584237141830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 新窗口页面 popup.html，访问域名为 http://127.0.0.1:10001/popup.html</span>\n<span class="token keyword">var</span> caller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bus</span><span class="token punctuation">(</span><span class="token string">\'http://localhost:10001\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'nickname\'</span><span class="token punctuation">,</span>\n    <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'收到主页面的消息\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>\n        e<span class="token punctuation">.</span>source<span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          name<span class="token punctuation">:</span> <span class="token string">\'message\'</span><span class="token punctuation">,</span>\n          data<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token string">\'http://localhost:10001\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">caller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  window<span class="token punctuation">.</span>opener<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    name<span class="token punctuation">:</span> <span class="token string">\'newWindowLoad\'</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">  <span class="token string">\'http://localhost:10001\'</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当新窗口的页面加载完毕时会发出 <code class="language-text">newWindowLoad</code> 消息，主页面接收后，标志变量 <code class="language-text">isLoaded</code> 置为 <code class="language-text">true</code>，此时尚在轮询的消息就可以发出。</p>\n<p><img src="/static/cross-origin-2-4340a95c494c85d0372f941fff11e3c5.gif" alt="跨域传输"></p>\n<h3 id="通过-url-传递数据"><a href="#%E9%80%9A%E8%BF%87-url-%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通过 url 传递数据</h3>\n<p>之后由于新窗口需要刷新后也要保持当前技能组的打开，以上方案在刷新新窗口后数据会丢失，所以通过 url 来传递数据</p>\n<h2 id="独立客服组件运行环境"><a href="#%E7%8B%AC%E7%AB%8B%E5%AE%A2%E6%9C%8D%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>独立客服组件运行环境</h2>\n<p>由于客服组件需要嵌入公司产品端，因为采用的技术栈和公司产品端的技术栈一致，这时会遇到很多问题：</p>\n<ol>\n<li>react 和 react-lite 的冲突，react 16 与 react 15 不能同时引入到一个页面，具体见 <a href="https://github.com/facebook/react/issues/16029" target="_blank" rel="nofollow noreferrer noopener">https://github.com/facebook/react/issues/16029</a> \n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-50858.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 6.893106893106893%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAOElEQVQI1x2K2wkAIAwD3X9GH622I6jph2AUjsAdSWG+c0W3GMSflkZFU1ThskP600/o4A1qZ64LhWw20TUfTUwAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 07 01 22 25 58"\n        title=""\n        src="/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-fee1c.png"\n        srcset="/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-a67b7.png 200w,\n/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-0b187.png 400w,\n/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-fee1c.png 800w,\n/static/2020-07-01-22-25-58-e98b1ad55dac7a93c38bb211a45ce51f-50858.png 1001w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n<li>babel-polyfill 引入 2 次导致不能正常加载 \n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-8f59e.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 6.003937007874017%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAASElEQVQI1wE9AML/AObk5OnMxOrJwenIwOrLw+rLw+vKwurGv/ji2v/x5v3s4v7w5v727P727PDo3+nh2Oni2ebe1u7n3tbPxzAzNIILCc3LAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 07 01 22 30 23"\n        title=""\n        src="/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-fee1c.png"\n        srcset="/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-a67b7.png 200w,\n/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-0b187.png 400w,\n/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-fee1c.png 800w,\n/static/2020-07-01-22-30-23-240f70fa592e45206a6d2b2cfc5abd7a-8f59e.png 1016w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </li>\n</ol>\n<h3 id="独立运行环境"><a href="#%E7%8B%AC%E7%AB%8B%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>独立运行环境</h3>\n<p>由于在开发服本地是正常的，编译为生产版本后冲突，首先想到了是不是生成文件 js 编号的冲突，于是做出以下修改</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21396561939781500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`optimization: {\n  // 以模块文件路径作为要加载模块的 key，不设置时默认以递增数字为 key\n  namedModules: true,\n  // 分包文件同理\n  namedChunks: true,\n}`, `21396561939781500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 以模块文件路径作为要加载模块的 key，不设置时默认以递增数字为 key</span>\n  namedModules<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token comment">// 分包文件同理</span>\n  namedChunks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后发现 react 和 react-lite 的共存时还是会报错，除非能保证客服组件的脚本能先于公司产品端去加载，这样的话就需要动到各个产品端的 index.html 文件，然而这样的话改动影响面会比较大，也不好在 index.html 中去读取到环境变量</p>\n<p>最后理了下思路，发现应该是产品端所有加载文件默认都在 webpackJsonp 变量下，需要将客服组件项目加载到不同的变量下才能做到环境上的隔绝</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26472891382662690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: {\n  filename: \'[name].js\',\n  chunkFilename: \'[name].[chunkhash].chunk.js\',\n  // 关键的一步，使同一网页上的多个 webpack 运行，互不影响\n  jsonpFunction: \'ponyWebpackJsonp\',\n},`, `26472891382662690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n  chunkFilename<span class="token punctuation">:</span> <span class="token string">\'[name].[chunkhash].chunk.js\'</span><span class="token punctuation">,</span>\n  <span class="token comment">// 关键的一步，使同一网页上的多个 webpack 运行，互不影响</span>\n<span class="gatsby-highlight-code-line">  jsonpFunction<span class="token punctuation">:</span> <span class="token string">\'ponyWebpackJsonp\'</span><span class="token punctuation">,</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>具体的原理可参考：<a href="/module-federation-principle-research/">Module federation 原理研究</a></p>\n<h3 id="babel-polyfill-引入-2-次"><a href="#babel-polyfill-%E5%BC%95%E5%85%A5-2-%E6%AC%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel-polyfill 引入 2 次</h3>\n<p>这里的话因为引入了 babel-polyfil，所以需要将客服组件项目中的 <code class="language-text">global._babelPolyfill = true;</code> 这一行屏蔽掉，防止公司产品端报错，暂时未想到更好的办法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63023310026129285000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// global._babelPolyfill = true;`, `63023310026129285000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// global._babelPolyfill = true;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="设置新窗口位置"><a href="#%E8%AE%BE%E7%BD%AE%E6%96%B0%E7%AA%97%E5%8F%A3%E4%BD%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置新窗口位置</h2>\n<p>需要注意下分屏的情况，新窗口在副屏的定位是错的，需要做特殊处理，主屏上没问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37412559870265820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 兼容左右分屏情况\nconst { availTop, availLeft } = window.screen;\nif (availLeft) {\n  left += availLeft;\n}\nif (availTop) {\n  top += availTop;\n}`, `37412559870265820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 兼容左右分屏情况</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> availTop<span class="token punctuation">,</span> availLeft <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>availLeft<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  left <span class="token operator">+=</span> availLeft<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>availTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  top <span class="token operator">+=</span> availTop<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><a href="https://segmentfault.com/a/1190000017989734" target="_blank" rel="nofollow noreferrer noopener">chrome 弹窗在双屏情况下 left 居中定位异常分析</a></p>\n<h2 id="监听新窗口打开情况"><a href="#%E7%9B%91%E5%90%AC%E6%96%B0%E7%AA%97%E5%8F%A3%E6%89%93%E5%BC%80%E6%83%85%E5%86%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听新窗口打开情况</h2>\n<p>通过监听 window.open 的 closed 属性，因为有多个新窗口打开，需要遍历 window.open 数组</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74335670356157150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.popups = [];\nconst popup = window.open(url, \'\');\nthis.popups.push(popup);\n\n// 得到打开的新窗口\nthis.popups.filter((item) => !item.closed);`, `74335670356157150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>popups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> popup <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>popups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>popup<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 得到打开的新窗口</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>popups<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span>item<span class="token punctuation">.</span>closed<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="解决聊天框代码注入"><a href="#%E8%A7%A3%E5%86%B3%E8%81%8A%E5%A4%A9%E6%A1%86%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决聊天框代码注入</h2>\n<p>由于聊天表情是由有限的几个字符组成的，格式为 <code class="language-text">[高兴]</code>, 所以只要匹配这几个字符，然后以 dangerouslySetInnerHTML 渲染，其他字符以普通文本字符渲染就可以</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54669872367924000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// EmojiList：表情字符列表，symbolToHTML：特定字符转为 html 方法\nrenderText = (text) => {\n  const renderContent = [];\n  text.replace(/\\[([^[\\]]+?)\\]|./g, (symbol) => {\n    if (/\\[([^[\\]]+?)\\]/.test(symbol) && EmojiList.find((item) => item.symbol === symbol)) {\n      renderContent.push(<span dangerouslySetInnerHTML={{ __html: symbolToHTML(symbol) }} />);\n    } else {\n      renderContent.push(symbol);\n    }\n  });\n  return <div>{renderContent}</div>;\n};`, `54669872367924000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// EmojiList：表情字符列表，symbolToHTML：特定字符转为 html 方法</span>\n<span class="token function-variable function">renderText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> renderContent <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\[([^[\\]]+?)\\]|./g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">symbol</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\\[([^[\\]]+?)\\]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> EmojiList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>symbol <span class="token operator">===</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      renderContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>span dangerouslySetInnerHTML<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> <span class="token function">symbolToHTML</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      renderContent<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span><span class="token punctuation">{</span>renderContent<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="效果截图"><a href="#%E6%95%88%E6%9E%9C%E6%88%AA%E5%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>效果截图</h1>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-83c29.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 722px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 89.75069252077562%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACDElEQVQ4y5VTy27TQBT177Fo+QIeCQsk1E2rwqIViAUP0Q3rrlgWaIpAICTUDaACoSA1NCVqUGMjSGvXSuyMPTOZh2eGO7FqUmyBOD4ejaw5c8992EGEfdhzt3a+vm91Pra7zd1us225vfft9XZr61OLMWaM0cZCCBGGIULIftHa2e315+6tLt1duXp7Ze7GrYuLy7XF5fq165eXbsJm4c79JEnzo7BKKY7DsPjitPto/llw5emwvh6eXzuqPz6+8NCvPQourYe1xvDFjq84yZTOMgWUWSbgzfdSOZ9/0HPPs7NPzEzDzG6YmRPC/kzDPHjjcYK41FxkZTqUUiWZUUBuNIe87KqY1gq8ffdcjImpgrWdEgJOICPwpoDa0u61LVLP9TD5LZZSYozBd148hxDKOc/roU/DlMQgA6e5GAC2x8koJpRWil3vlHgaSikHE8q4Bdz3z8jTmNimFCfJYDCoFB/03DTFlWI4b8XsBOCkFBmqXS22OYOr0QjlR8v4S85WDNWGR3AuJpmrKVjbrjuMkZCKcfkH7ZBAwQbDSEporZHKdrjgdM66BJFJG1mMidECil825gcBnXSxmKpJk+0ARTy2OTe95GUn2dxPN7u44Kt9/M4lh36Q/5JFe6IIbEpt1JforQO5HUWkF6SH8bgf0YI/I+rHEJVW1hLG9wB1nNwMXGb+B3AhZeYXi9D0x5Aq08YAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 07 01 23 11 11"\n        title=""\n        src="/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-83c29.png"\n        srcset="/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-5b578.png 200w,\n/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-4dff0.png 400w,\n/static/2020-07-01-23-11-11-b7a7042d5dbfcceb1f5c9027847611dd-83c29.png 722w"\n        sizes="(max-width: 722px) 100vw, 722px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-a2194.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 750px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 84.39999999999999%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACMUlEQVQ4y31STWsUQRBtvfh3/A3eJQcPnlQEUUGQiEtEUBMXExD06kfOoh70pEtQTwY8KyQXzW52N9mdzM5Md093T3/OlzWbzbC7iT5qimGmX9WrfoUuN9cvNR5caTy8uvTo4u2l89cXF27euXCrsXBj8e7ac855eYSiKOoMyPMcvfw+fLXpPf3mrbT6zdbe8qfe8ud+c2N/ZcNb3xyI/5PPvbHXvpRnnpWnVkv0pESrVZxeK9Dj8uwLwRmVUhJCrLXlLNIsRx+3ktaf9P2WezcT9u12/uFn5HkeKGcszrKs7g/veYUMWcnL3BZOidDno4EIhhIHRaqgdEyjdqczHA4ojWvB1jlGyRCz1x2DQsqFsjzRIZW/PbnryyiWLNGJdn5Idto77XYnjHBRTz7O1JX3f2WIxFxpK5VJlA2YjTi8Wym1Ni6ISISx1hoGBpVHsqtMTHnvxxQZAhgQVSGpjU0PRuHe/kBrNfJ9pfR0Z5OVX7uz5DomZD/o9vpJklBKrTXThk2swrVsOR0V2fPD3W4vCEZCiPIYKqso4yAJhjTG1TEeM8UkZpynYxwng1+IcZEkQspk5keaQjDGCaFznBnZUqmqcpbVa1CfgKrs3+sJ5xEMN7c60PPQGGDGjIlE4Ag75+YkRIagCJOIwArFkMBVTCpvq4+YHPgjMgasdzHGdGeXOWSti4WE+4Ha8NgKkwzTwNHDfPKF5UVh0xyOQzsg1JdhjIEMJhd5ceLMXGV/AVIJsfFk9b2VAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 07 01 23 14 38"\n        title=""\n        src="/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-a2194.png"\n        srcset="/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-2e341.png 200w,\n/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-e3a06.png 400w,\n/static/2020-07-01-23-14-38-3bf55c2122dfcac2c11ced23e7dd4e39-a2194.png 750w"\n        sizes="(max-width: 750px) 100vw, 750px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>传递到新窗口的 url 过长需要编码</li>\n<li>独立运行环境部分的 react 冲突可能是作用域提升导致的冲突，待具体研究</li>\n<li>babel-polyfill 引入 2 次，如何复用 ployfill 的代码待研究</li>\n</ol>',
id:"/github/workspace/blog/客服新窗口技术探索/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2020-07-01 20:15:50",path:"/new-window-technology-research/",tags:"前端, 跨域通信, webpack, 预研",title:"客服新窗口技术探索",draft:null}}],length:1,tag:"跨域通信",pagesSum:1,page:1}}}});
webpackJsonp([0xde38df5eaa34],{1207:function(n,a){n.exports={data:{site:{siteMetadata:{description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"Fiber 的数据结构 此小节会通过两个   来展示   以及   的数据结构。 首先用代码表示上图节点间的关系。比如  下有  , 就可以把它们间的关系写成  ; Stack Reconciler 在   之前，节点之间的关系可以用数据结构中   来表示。 如下实现   函数, 将深度遍历的节点打印出来。 输出结果为:  Fiber Reconciler…",html:'<h1 id="fiber-的数据结构"><a href="#fiber-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber 的数据结构</h1>\n<p>此小节会通过两个 <code class="language-text">demo</code> 来展示 <code class="language-text">Stack Reconciler</code> 以及 <code class="language-text">Fiber Reconciler</code> 的数据结构。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-05-28-14-50-48-09d9e762f85f9e5c7638bf975d99727d-7027d.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 300px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 133.33333333333331%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB1klEQVQ4y5WU2Y6CUBBE5/9/SL/A+OCDPrivuCtq3FFUmDNU5sbcuTDYieYCXV3d1QVfcRxHURQEweVyeT6fURJxvvjiB6zf78/n88ViEX8SP+Dz+Tybzfb7faPRGI1Gk8nkM3Cz2RwOh+Px+PF4TKdT+s8L1tgmlsvl6/V6v/MP2ITv+8y/Xq/B52U2/CCRrdPpMDyFOO92u7xgxgaDZqvVCi2OxyPntC4cbdfrdcQ3o9ZqtTAMc4EJONFc5+12WywW05bnADOnqO73Oy1cr1fP86iiKXBUFhipxUwJlo/zWq0WVfwkEJKibjD24DFsukRqYSQn/6VSSfpzaYMHgwGC93o9g393EearVqvYURa0V4U2OIxtd7tdWvWSECcA7pxOJ3LUuc1MzzgEsFkPjYiHEkhAAsxuMH4gm9db2VwWCgXY9BQhAW82myy1RQshVHTRbrfNe8bObrdbKpiZBSaJPZHNkGaKcrmcqrbA2jM9o5bIZW8eVSoVZtZlFlh4zkqlc1ZFI6zTLZjlbUtLGmEE1uEGU54MyyEmMDafusPhoM3bYLzFkNQ2kub9ktAYXaEwq04jz3ol6RlVcMLfDwATUTH4DXRxOAwxnJ9e5mQWnoZJkPkNxuof2xgpx1gAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 05 28 14 50 48"\n        title=""\n        src="/static/2020-05-28-14-50-48-09d9e762f85f9e5c7638bf975d99727d-7027d.png"\n        srcset="/static/2020-05-28-14-50-48-09d9e762f85f9e5c7638bf975d99727d-55fa9.png 200w,\n/static/2020-05-28-14-50-48-09d9e762f85f9e5c7638bf975d99727d-7027d.png 300w"\n        sizes="(max-width: 300px) 100vw, 300px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>首先用代码表示上图节点间的关系。比如 <code class="language-text">a1 节点</code>下有 <code class="language-text">b1、b2、b3 节点</code>, 就可以把它们间的关系写成 <code class="language-text">a1.render = () =&gt; [b1, b2, b3]</code>;</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76351292650819260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a1 = { name: \'a1\', render = () => [b1, b2, b3] }\nvar b1 = { name: \'b1\', render = () => [c1] }\nvar b2 = { name: \'b2\', render = () => [c2] }\nvar b3 = { name: \'b3\', render = () => [] }\nvar c1 = { name: \'c1\', render = () => [d1] }\nvar c2 = { name: \'c2\', render = () => [] }\nvar d1 = { name: \'d1\', render = () => [d2] }\nvar d2 = { name: \'d2\', render = () => [] }`, `76351292650819260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'a1\'</span><span class="token punctuation">,</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token keyword">var</span> b1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'b1\'</span><span class="token punctuation">,</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>c1<span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token keyword">var</span> b2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'b2\'</span><span class="token punctuation">,</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>c2<span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token keyword">var</span> b3 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'b3\'</span><span class="token punctuation">,</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token keyword">var</span> c1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'c1\'</span><span class="token punctuation">,</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>d1<span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token keyword">var</span> c2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'c2\'</span><span class="token punctuation">,</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token keyword">var</span> d1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'d1\'</span><span class="token punctuation">,</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>d2<span class="token punctuation">]</span> <span class="token punctuation">}</span>\n<span class="token keyword">var</span> d2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">\'d2\'</span><span class="token punctuation">,</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="stack-reconciler"><a href="#stack-reconciler" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stack Reconciler</h2>\n<p>在 <code class="language-text">React 16</code> 之前，节点之间的关系可以用数据结构中 <code class="language-text">树的深度遍历</code> 来表示。</p>\n<p>如下实现 <code class="language-text">walk</code> 函数, 将深度遍历的节点打印出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27499986141323653000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`walk(a1);\n\nfunction walk(instance) {\n  if (!instance) return;\n  console.log(instance.name);\n  instance.render().map(walk);\n}`, `27499986141323653000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">walk</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>walk<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输出结果为: <code class="language-text">a1 b1 c1 d1 d2 b2 c2 b3</code></p>\n<h2 id="fiber-reconciler"><a href="#fiber-reconciler" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber Reconciler</h2>\n<p>在 <code class="language-text">React 16</code> 中，节点之间的关系可以用数据结构中的 <code class="language-text">链表</code> 来表示。</p>\n<p>节点之间的链表有三种情形, 用图表示如下:</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-05-28-14-52-10-62a31ae4097adb3c3b9f05ed0d77f9da-7027d.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 300px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 133.33333333333331%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADL0lEQVQ4y5VU2ZKcNhTt/89P5MFvSV5SqVT5JUulEtvjTs00PXRPL4CaHQlJSIDYBEQC3O01Ht8qiovQ0T0690grznkYhlEUIZSO4zgMw/jsWHmeByHEhByfdk1Zjt8SKwAucRQyip+2WwrcMiX9ROBZ4Jxn93v75d0Bo0TBmOfXYqr/DPxKPYcoe/G3PX8X5o78+lJjpfwqXoOZEK8Pbi07hNHe2FyMRxs4w9A/q3Im6gcAEWembSv9KOfHg439oOGsadrhy1vQ4KrpHpxEJX4YGdtNEtrf//LWOAZjLWgYlTkbvtBCDe46uQFx28teDownOLVJnruEzjPYel373mclXM2vvZ/CXIssZVUWsUpijGlREE6tV6+tN3cBQgtCLfFuldXM5xQiH+tSnSyLQm+hH2TC8reGyfKccH4+HPtKtKWQsruyWMAezewYq1R2Bef+1acny/ZcD6fwux//fTp5HcuyIGx4MU9YwCHN/DQt6z5Fx0fzp35YwDnnyvM8I3+ZzqO/MGf/vKoOx1tlBc6qcnuyT6e95zuObWmTjDeZuKhML87KEqrl12uwefDCcDX/SzkvqtYOAsuxEUL3m713dhpCRF4Ok0JN17mYoKLcHk8QQcqYcsQCVsJS0WYEb81t5J9/+M3YADTKhkMoIJ4JuKlOHABM8xE49vl8XmgrPojrVjEGk8QSVXVJ6dhrh8a//4kNQyWqnJomu47SCEJQ1+0CLusmokx3qK/VvlSCGEuUilEIDgfwdPB8v2q7AJPJVEKU+GYS7U2cyb6Xqs95PPPkVb3emoRSTKnjOLqjKZHDyBlIEuMDsJtm6ocC53k4UdCMwMVxXS8IArXDWZogIY51t9//kefVDRwSJZmqLfI8upqkrmsyRTndUGrozWZ/8bwEQi3YPKS7VeQpF2q+0m5u8EfHYPFiqNsZR5HrujcwLQtS1F1LITTev0aHKa4jaYoAAL7vqwv3RrvreyfElnX/sPmZMf5p5c+f5+uqxglYDkhTYllW27b/j9QH431wGCe73c6eommaj2ZLKYVQ9lmi67oPwOrAXYDqYaK29Om9o0aU+GrRdoq+7/8DKMcIrds8ZhQAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 05 28 14 52 10"\n        title=""\n        src="/static/2020-05-28-14-52-10-62a31ae4097adb3c3b9f05ed0d77f9da-7027d.png"\n        srcset="/static/2020-05-28-14-52-10-62a31ae4097adb3c3b9f05ed0d77f9da-55fa9.png 200w,\n/static/2020-05-28-14-52-10-62a31ae4097adb3c3b9f05ed0d77f9da-7027d.png 300w"\n        sizes="(max-width: 300px) 100vw, 300px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ol>\n<li>父节点到子节点(红色虚线)</li>\n<li>同层节点(黄色虚线)</li>\n<li>子节点到父节点(蓝色虚线)</li>\n</ol>\n<blockquote>\n<p>父节点指向第一个子节点, 每个子节点都指向父节点，同层节点间是单向链表。</p>\n</blockquote>\n<p>首先, 构建节点的数据结构, 如下所示:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53357077350723215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var FiberNode = function(instance) {\n  this.instance = instance;\n  this.parent = null;\n  this.sibling = null;\n  this.child = null;\n};`, `53357077350723215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">FiberNode</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>instance <span class="token operator">=</span> instance<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后创建一个将节点串联起来的 <code class="language-text">connect</code> 函数:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39414512289413660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var connect = function(parent, childList) {\n  parent.child = childList.reduceRight((prev, current) => {\n    const fiberNode = new FiberNode(current);\n    fiberNode.parent = parent;\n    fiberNode.sibling = prev;\n    return fiberNode;\n  }, null);\n\n  return parent.child;\n};`, `39414512289413660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">connect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> childList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  parent<span class="token punctuation">.</span>child <span class="token operator">=</span> childList<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> fiberNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberNode</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    fiberNode<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>\n    fiberNode<span class="token punctuation">.</span>sibling <span class="token operator">=</span> prev<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> fiberNode<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> parent<span class="token punctuation">.</span>child<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>在 JavaScript 中实现链表的数据结构可以巧用 reduceRight</p>\n</blockquote>\n<p><code class="language-text">connect</code> 函数中实现了上述链表关系。可以像这样使用它:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79077469801027320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var parent = new FiberNode(a1);\nvar childFirst = connect(\n  parent,\n  a1.render()\n);`, `79077469801027320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberNode</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> childFirst <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>\n  parent<span class="token punctuation">,</span>\n  a1<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样子便完成了 <code class="language-text">a1 节点</code>指向 <code class="language-text">b1 节点</code>的链表、<code class="language-text">b1、b2、b3 节点间</code>的单向链表以及 <code class="language-text">b1、b2、b3 节点</code>指向 <code class="language-text">a1 节点</code> 的链表。</p>\n<p>最后剩下 <code class="language-text">goWalk</code> 函数将全部节点给遍历完。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60081878935534650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 打印日志以及添加列表\nvar walk = function(node) {\n  console.log(node.instance.name);\n  const childLists = node.instance.render();\n  let child = null;\n  if (childLists.length > 0) {\n    child = connect(\n      node,\n      childLists\n    );\n  }\n  return child;\n};\n\nvar goWalk = function(root) {\n  let currentNode = root;\n\n  while (true) {\n    const child = walk(currentNode);\n    // 如果有子节点\n    if (child) {\n      currentNode = child;\n      continue;\n    }\n\n    // 如果没有相邻节点, 则返回到父节点\n    while (!currentNode.sibling) {\n      currentNode = currentNode.parent;\n      if (currentNode === root) {\n        return;\n      }\n    }\n\n    // 相邻节点\n    currentNode = currentNode.sibling;\n  }\n};\n\n// 调用\ngoWalk(new FiberNode(a1));`, `60081878935534650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 打印日志以及添加列表</span>\n<span class="token keyword">var</span> <span class="token function-variable function">walk</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> childLists <span class="token operator">=</span> node<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>childLists<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    child <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>\n      node<span class="token punctuation">,</span>\n      childLists\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> child<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> <span class="token function-variable function">goWalk</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> currentNode <span class="token operator">=</span> root<span class="token punctuation">;</span>\n\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>currentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 如果有子节点</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      currentNode <span class="token operator">=</span> child<span class="token punctuation">;</span>\n      <span class="token keyword">continue</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 如果没有相邻节点, 则返回到父节点</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentNode<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      currentNode <span class="token operator">=</span> currentNode<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentNode <span class="token operator">===</span> root<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 相邻节点</span>\n    currentNode <span class="token operator">=</span> currentNode<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 调用</span>\n<span class="token function">goWalk</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FiberNode</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>打印结果为 <code class="language-text">a1 b1 c1 d1 d2 b2 c2 b3</code></p>\n<p><code class="language-text">Fiber</code> 在一个节点上的执行流程总结如下:</p>\n<ul>\n<li>\n<p>在当前节点下寻找是否有子节点</p>\n<ul>\n<li>若有, 则进入子节点</li>\n<li>若没有, 则在当前节点下寻找是否有下一个相邻节点</li>\n<li>若有, 则进入下一个相邻节点</li>\n<li>若没有, 则返回它的父节点</li>\n</ul>\n</li>\n</ul>\n<h1 id="fiber-reconciler-的优势"><a href="#fiber-reconciler-%E7%9A%84%E4%BC%98%E5%8A%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber Reconciler 的优势</h1>\n<p>通过分析上述两种数据结构实现的代码，可以得出下面结论:</p>\n<ul>\n<li>基于树的深度遍历实现的 Reconciler: 一旦进入调用栈便无法暂停;</li>\n<li>基于链表实现的 Reconciler: 在 <code class="language-text">while(true) {}</code> 的循环中, 可以通过 <code class="language-text">currentNode</code> 的赋值重新得到需要操作的节点，而在赋值之前便可以’暂停’来执行其它逻辑, 这也是 <code class="language-text">requestIdleCallback</code> 能得以在 <code class="language-text">Fiber Reconciler</code> 的原因。</li>\n</ul>\n<h1 id="相关链接"><a href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>相关链接</h1>\n<ul>\n<li><a href="https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7" target="_blank" rel="nofollow noreferrer noopener">The how and why on React’s usage of linked list in Fiber to walk the component’s tree</a></li>\n<li><a href="https://github.com/facebook/react/issues/7942" target="_blank" rel="nofollow noreferrer noopener">Fiber Principles: Contributing To Fiber</a>: Fiber 设计思想相关 issue, 推荐。</li>\n</ul>',
id:"/github/workspace/blog/React Fiber数据结构/index.md absPath of file >>> MarkdownRemark",timeToRead:3,frontmatter:{date:"2020-05-28 14:32:24",path:"/react-fiber-data-struct/",tags:"前端, React Fiber, 数据结构",title:"React Fiber 数据结构",draft:null}},{excerpt:"需求背景 由于每个周末放假前都要给出代码量的统计，如果是手动统计的话需要到各个开发过的项目下运行相应的脚本，太过繁琐。故写出以下第一版统计代码量的脚本 代码展示 以下是统计 G:/project/tungee/ 目录下的代码量，其中标红部分需要修改为自己的项目路径和 git 邮箱 第一版 按项目统计 运行效果 以上更新于 第二版 增加按日期统计和 shell 参数输入 运行效果 第三版 增加按分支统计的功能，去掉 shell…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>由于每个周末放假前都要给出代码量的统计，如果是手动统计的话需要到各个开发过的项目下运行相应的脚本，太过繁琐。故写出以下第一版统计代码量的脚本</p>\n<h1 id="代码展示"><a href="#%E4%BB%A3%E7%A0%81%E5%B1%95%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码展示</h1>\n<p>以下是统计 G:/project/tungee/ 目录下的代码量，其中标红部分需要修改为自己的项目路径和 git 邮箱</p>\n<h2 id="第一版"><a href="#%E7%AC%AC%E4%B8%80%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第一版</h2>\n<h3 id="按项目统计"><a href="#%E6%8C%89%E9%A1%B9%E7%9B%AE%E7%BB%9F%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>按项目统计</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2747396335988949500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\nset -euo pipefail\ntrap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array(){\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n  echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n  read input\n  files=(\\$(to_array \\$input))\n  echo -e &quot;\\n&quot;\n  for file in \\${files[@]}\n  do\n    if [ ! -d &quot;G:/project/tungee/\\$file&quot; ]; then\n      echo -e &quot;\\$file 目录不存在。&quot;\n      continue;\n    fi\n    if [ ! -d &quot;G:/project/tungee/\\$file/.git&quot; ]; then\n      echo -e &quot;\\$file 不是git仓库。&quot;\n      continue;\n    fi\n    cd &quot;G:/project/tungee/\\$file&quot;\n    echo &quot;\\$file 代码量统计：&quot;\n    i=\\`date +%w\\`\n    while [ \\$i -ge 1 ]\n    do\n      sinceDate=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      untilDate=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      git log --author=&quot;634407147@qq.com&quot; --since=\\$sinceDate --until=\\$untilDate --pretty=tformat: --numstat | gawk \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$untilDate\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n      i=\\$((\\$i-1))\n    done\n    echo -e &quot;\\n&quot;\n  done\n}`, `2747396335988949500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash{25,29,33,40} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token builtin class-name">set</span> -euo pipefail\n<span class="token builtin class-name">trap</span> <span class="token string">"echo \'error: Script failed: see failed command above\'"</span> ERR\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>"</span>\n  <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${files<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n<span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"G:/project/tungee/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>      <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n      <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n    <span class="token keyword">fi</span>\n<span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"G:/project/tungee/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>      <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n      <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n    <span class="token keyword">fi</span>\n<span class="gatsby-highlight-code-line">    <span class="token builtin class-name">cd</span> <span class="token string">"G:/project/tungee/<span class="token variable">$file</span>"</span></span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$file</span> 代码量统计："</span>\n    <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> +%w<span class="token variable">`</span></span>\n    <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n    <span class="token keyword">do</span>\n      <span class="token assign-left variable">sinceDate</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token assign-left variable">untilDate</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n<span class="gatsby-highlight-code-line">      <span class="token function">git</span> log --author<span class="token operator">=</span><span class="token string">"634407147@qq.com"</span> --since<span class="token operator">=</span><span class="token variable">$sinceDate</span> --until<span class="token operator">=</span><span class="token variable">$untilDate</span> --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">gawk</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "\'</span><span class="token variable">$untilDate</span><span class="token string">\' 增加行总数：%s，删除行总数：%s，总代码行：%s<span class="token entity" title="\\n">\\n</span>", add, subs, loc }\'</span></span>      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>"</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-05-22-22-18-59-ca5128d9bf69c497af557dbc93c8cf74-d5813.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 443px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 68.62302483069978%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABq0lEQVQoz5VS2ZKbMBCUOcTh5RCHhITMjcE25MHr2vz/n6WNU1vrxFuVdFEjNFKrenqGGNqgHaWV4yiHMEIy8mbsD0THJN6/ESEIY2S3I68x9dPQjKfppAqlhNRK60oXuoiTWHCkDlKWlDqvyZxnaZ7leR5FUZokaZpmSOT5fc1Sz/Nc1zUMY7fhBR/Zx7Fpmjal36v8C0PftV1X17VS8jTP1+u17wfbtpMkgRZEhzq2bcUxYwkzTPO55mlqmkYWxdD367rO0x24/f5+PU7z7Xa7k+Locllw6nreE5kxFgQhKmNxjFJRKAyA/qIQOJJSomzf9+AFVFiW9US2bAuf47ggfOvqpzt/7EtV1tVhXX9czmfoJ/+FtmvLsmya+ufHxzCOYRRBp2lalNphGPr+HoBabJGHhWgH7PzdtuPxWFW14KJtmmVZ5nme5tn3/XEcTufzsqwHXbEkadt2GEapJJ7bXt9sF0LAoygM4ZXWuixVIWUQBJgQXWqlIKsMwpDz+xQJwXEZnkPUZphlYkA2YV/0/CPSLMUzaAnnHNF1vcfMPeLnVH7NbD937i9mWyf8SD5sHwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 05 22 22 18 59"\n        title=""\n        src="/static/2019-05-22-22-18-59-ca5128d9bf69c497af557dbc93c8cf74-d5813.png"\n        srcset="/static/2019-05-22-22-18-59-ca5128d9bf69c497af557dbc93c8cf74-bf07a.png 200w,\n/static/2019-05-22-22-18-59-ca5128d9bf69c497af557dbc93c8cf74-250cd.png 400w,\n/static/2019-05-22-22-18-59-ca5128d9bf69c497af557dbc93c8cf74-d5813.png 443w"\n        sizes="(max-width: 443px) 100vw, 443px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>以上更新于<code class="language-text">2019-5-22 22:17:24</code></p>\n<hr>\n<h2 id="第二版"><a href="#%E7%AC%AC%E4%BA%8C%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二版</h2>\n<h3 id="增加按日期统计和-shell-参数输入"><a href="#%E5%A2%9E%E5%8A%A0%E6%8C%89%E6%97%A5%E6%9C%9F%E7%BB%9F%E8%AE%A1%E5%92%8C-shell-%E5%8F%82%E6%95%B0%E8%BE%93%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加按日期统计和 shell 参数输入</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79679195655864170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\nset -euo pipefail\ntrap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array() {\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n\n  file_path=&quot;G:/project/tungee&quot;\n  git_email=&quot;634407147@qq.com&quot;\n  date_stat=&quot;date +%w&quot; # 今天是一周的第几天，可换成具体数字 date_stat=&quot;echo 5&quot; 以实现统计几天前代码的功能\n\n  if [ \\$# -lt 1 ]; then\n    echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n    read input\n    files=(\\$(to_array \\$input))\n  else\n    files=\\$*\n  fi\n\n  echo -e &quot;按日期统计：&quot;\n  i=\\$(\\$date_stat)\n  while [ \\$i -ge 1 ]\n  do\n    add_sum=0\n    subs_sum=0\n    loc_sum=0\n    for file in \\${files[@]}\n    do\n      if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n        echo -e &quot;\\$file 目录不存在。&quot;\n        continue;\n      fi\n      if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n        echo -e &quot;\\$file 不是git仓库。&quot;\n        continue;\n      fi\n      cd &quot;\\$file_path/\\$file&quot;\n      since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      eval \\$(git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;add=%s; subs=%s; loc=%s;&quot;, add, subs, loc }\')\n      add_sum=\\$((\\$add_sum + \\$add))\n      subs_sum=\\$((\\$subs_sum + \\$subs))\n      loc_sum=\\$((\\$loc_sum + \\$loc))\n    done\n    printf &quot;\\$until_date 增加行总数：\\$add_sum，删除行总数：\\$subs_sum，总代码行：\\$loc_sum\\n&quot;\n    i=\\$((\\$i-1))\n  done\n\n  echo -e &quot;\\n按项目统计：&quot;\n  for file in \\${files[@]}\n  do\n    if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n      echo -e &quot;\\$file 目录不存在。&quot;\n      continue;\n    fi\n    if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n      echo -e &quot;\\$file 不是git仓库。&quot;\n      continue;\n    fi\n    cd &quot;\\$file_path/\\$file&quot;\n    echo &quot;\\$file 代码量统计：&quot;\n    i=\\$(\\$date_stat)\n    while [ \\$i -ge 1 ]\n    do\n      since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n      i=\\$((\\$i-1))\n    done\n  done\n}`, `79679195655864170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash{21-22} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token builtin class-name">set</span> -euo pipefail\n<span class="token builtin class-name">trap</span> <span class="token string">"echo \'error: Script failed: see failed command above\'"</span> ERR\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token assign-left variable">file_path</span><span class="token operator">=</span><span class="token string">"G:/project/tungee"</span></span><span class="gatsby-highlight-code-line">  <span class="token assign-left variable">git_email</span><span class="token operator">=</span><span class="token string">"634407147@qq.com"</span></span>  <span class="token assign-left variable">date_stat</span><span class="token operator">=</span><span class="token string">"date +%w"</span> <span class="token comment"># 今天是一周的第几天，可换成具体数字 date_stat="echo 5" 以实现统计几天前代码的功能</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> -lt <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n    <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n    <span class="token builtin class-name">read</span> input\n    <span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token keyword">else</span>\n    <span class="token assign-left variable">files</span><span class="token operator">=</span><span class="token variable">$*</span>\n  <span class="token keyword">fi</span>\n\n  <span class="token builtin class-name">echo</span> -e <span class="token string">"按日期统计："</span>\n  <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$date_stat<span class="token variable">)</span></span>\n  <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n  <span class="token keyword">do</span>\n    <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token number">0</span>\n    <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token number">0</span>\n    <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token number">0</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${files<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n      <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> log --author<span class="token operator">=</span>$git_email --since<span class="token operator">=</span>$since_date --until<span class="token operator">=</span>$until_date --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "add=%s; subs=%s; loc=%s;", add, subs, loc }\'</span><span class="token variable">)</span></span>\n      <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$add_sum <span class="token operator">+</span> $add<span class="token variable">))</span></span>\n      <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$subs_sum <span class="token operator">+</span> $subs<span class="token variable">))</span></span>\n      <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$loc_sum <span class="token operator">+</span> $loc<span class="token variable">))</span></span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$until_date</span> 增加行总数：<span class="token variable">$add_sum</span>，删除行总数：<span class="token variable">$subs_sum</span>，总代码行：<span class="token variable">$loc_sum</span><span class="token entity" title="\\n">\\n</span>"</span>\n    <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n  <span class="token keyword">done</span>\n\n  <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>按项目统计："</span>\n  <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${files<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n      <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n    <span class="token keyword">fi</span>\n    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n      <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n    <span class="token keyword">fi</span>\n    <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$file</span> 代码量统计："</span>\n    <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$date_stat<span class="token variable">)</span></span>\n    <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n    <span class="token keyword">do</span>\n      <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n      <span class="token function">git</span> log --author<span class="token operator">=</span><span class="token variable">$git_email</span> --since<span class="token operator">=</span><span class="token variable">$since_date</span> --until<span class="token operator">=</span><span class="token variable">$until_date</span> --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "\'</span><span class="token variable">$until_date</span><span class="token string">\' 增加行总数：%s，删除行总数：%s，总代码行：%s<span class="token entity" title="\\n">\\n</span>", add, subs, loc }\'</span>\n      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n    <span class="token keyword">done</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-1"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-05-27-17-41-19-6e109b97f31386c105d585a5d20e1785-5032e.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 438px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 92.46575342465754%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACqklEQVQ4y3VT55KjMAzOklACphgIwZjiQoeUnX3/d7vPyV7u12lgBmEkfUUc6pbroR/mIS0yEgY0p2maJWESh3EYEUqjMDwfDoevL+vwCsuykCBMMg5jr3VTN03FpZB13VRV5QckjiOtFeeNEDKOE5rQorgopcqyJGEY+L4pllLyqrrkFym6bdvGcez7IaG0yPN934ah39Y1SdOyvDZN0/c9Pg4BiQSmeBhGDKwqPmj1eNzXdR2nKUkoen0/n8u8LMsaxzGv2DSN0zznWU4IsW3bFOMgBC3v7PtB+MKDM8dxff+M+TiNk8RxHM9zgRYzbRvP3pv/QYgOTDA8IARv8zz3weetx//jr2DjBNpd1+G+7fvPzw9wBkHAyhJScc5LVrmum2eZUvpSFHi2Pq2lVDXnxaVQQszzrPseHyU0bdv2dtunaQLpKIyaphZCKK2LogBHdDfFWveQEcWia7dtnaYZ10swcb/dIP68rKDa1DUaCangmQtJXPfNWUF9NP5+PJZ1RWNKKRSiNIF/GRaGUts+wfYsy8Iocmzn6wPbEKtMzC+EQMvgZBSZJVGqrmspRRQncRRnaQpdGWM4JW/Y8L1t2uv1CmP3zZAEbHgCnI/HYzKwF0JCzti+3zohQMFx7N/JWuu2aa7XUnat2ZDBbBi8NQu37+OIvR/Rq6rYMI5SKTQ6f3zusF6MQbPn8zHPS365ALLreSTw4Tk1kRp9XDdJ4jRNceR+it+Tse4T1njbwBPmBQEBeRBA0knpeWfOK6SMVf75bFl/BcN6gR5E7toGgg3DAPNomgEnfglQWBbjHCtZXXMcQTCYjBX+FazrBF5pKfbdCAZu0BMz77c7fEYa+AEqIYERjITH4/HXrdPpZBLLOh1PriFnbvzxjgn3nWMfX6nzr+wVfwAoYlosBX0uZQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 05 27 17 41 19"\n        title=""\n        src="/static/2019-05-27-17-41-19-6e109b97f31386c105d585a5d20e1785-5032e.png"\n        srcset="/static/2019-05-27-17-41-19-6e109b97f31386c105d585a5d20e1785-86481.png 200w,\n/static/2019-05-27-17-41-19-6e109b97f31386c105d585a5d20e1785-1ca59.png 400w,\n/static/2019-05-27-17-41-19-6e109b97f31386c105d585a5d20e1785-5032e.png 438w"\n        sizes="(max-width: 438px) 100vw, 438px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id="第三版"><a href="#%E7%AC%AC%E4%B8%89%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第三版</h2>\n<h3 id="增加按分支统计的功能，去掉-shell-参数输入（暂时不支持）"><a href="#%E5%A2%9E%E5%8A%A0%E6%8C%89%E5%88%86%E6%94%AF%E7%BB%9F%E8%AE%A1%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%8E%BB%E6%8E%89-shell-%E5%8F%82%E6%95%B0%E8%BE%93%E5%85%A5%EF%BC%88%E6%9A%82%E6%97%B6%E4%B8%8D%E6%94%AF%E6%8C%81%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加按分支统计的功能，去掉 shell 参数输入（暂时不支持）</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98123654277310760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\n# set -euo pipefail\n# trap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array() {\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n\n  file_path=&quot;G:/project/tungee&quot;\n  git_email=&quot;634407147@qq.com&quot;\n  date_stat=&quot;date +%w&quot; # 今天是一周的第几天，可换成具体数字如 date_stat=&quot;echo 5&quot; 以实现统计几天前代码的功能\n\n  echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n  read input\n  projects=(\\$(to_array \\$input))\n  echo &quot;输入分支名，以英文逗号分隔，不能有空格&quot;\n  read input\n  branches=(\\$(to_array \\$input))\n\n  for branch in \\${branches[@]}\n  do\n    exist_branch_projects=()\n    for file in \\${projects[@]}\n    do\n      if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n        echo -e &quot;\\$file 目录不存在。&quot;\n        continue;\n      fi\n      if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n        echo -e &quot;\\$file 不是git仓库。&quot;\n        continue;\n      fi\n      cd &quot;\\$file_path/\\$file&quot;\n      git checkout \\$branch -q >/dev/null 2>&1 # 重定向错误信息，即屏蔽错误信息\n      if [ \\$? -ne 0 ]; then\n        echo -e &quot;\\n\\$file 切换分支到 \\$branch 失败，可能不存在此分支&quot;\n      else\n        exist_branch_projects+=(\\$file)\n        git pull origin \\$branch -q\n      fi\n    done\n    echo -e &quot;\\n分支 \\$branch 上的代码统计：&quot;\n    {\n      echo -e &quot;按日期统计：&quot;\n      i=\\$(\\$date_stat)\n      while [ \\$i -ge 1 ]\n      do\n        add_sum=0\n        subs_sum=0\n        loc_sum=0\n        for file in \\${exist_branch_projects[@]}\n        do\n          if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n            echo -e &quot;\\$file 目录不存在。&quot;\n            continue;\n          fi\n          if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n            echo -e &quot;\\$file 不是git仓库。&quot;\n            continue;\n          fi\n          cd &quot;\\$file_path/\\$file&quot;\n          # git checkout master\n          since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n          until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n          eval \\$(git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;add=%s; subs=%s; loc=%s;&quot;, add, subs, loc }\')\n          add_sum=\\$((\\$add_sum + \\$add))\n          subs_sum=\\$((\\$subs_sum + \\$subs))\n          loc_sum=\\$((\\$loc_sum + \\$loc))\n        done\n        printf &quot;\\$until_date 增加行总数：\\$add_sum，删除行总数：\\$subs_sum，总代码行：\\$loc_sum\\n&quot;\n        i=\\$((\\$i-1))\n      done\n\n      echo -e &quot;按项目统计：&quot;\n      for file in \\${exist_branch_projects[@]}\n      do\n        if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n          echo -e &quot;\\$file 目录不存在。&quot;\n          continue;\n        fi\n        if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n          echo -e &quot;\\$file 不是git仓库。&quot;\n          continue;\n        fi\n        cd &quot;\\$file_path/\\$file&quot;\n        # git checkout master\n        echo &quot;\\$file 代码量统计：&quot;\n        i=\\$(\\$date_stat)\n        while [ \\$i -ge 1 ]\n        do\n          since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n          until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n          git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n          i=\\$((\\$i-1))\n        done\n      done\n    }\n  done\n}`, `98123654277310760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token comment"># set -euo pipefail</span>\n<span class="token comment"># trap "echo \'error: Script failed: see failed command above\'" ERR</span>\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token assign-left variable">file_path</span><span class="token operator">=</span><span class="token string">"G:/project/tungee"</span>\n  <span class="token assign-left variable">git_email</span><span class="token operator">=</span><span class="token string">"634407147@qq.com"</span>\n  <span class="token assign-left variable">date_stat</span><span class="token operator">=</span><span class="token string">"date +%w"</span> <span class="token comment"># 今天是一周的第几天，可换成具体数字如 date_stat="echo 5" 以实现统计几天前代码的功能</span>\n\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入分支名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">branches</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">for</span> <span class="token for-or-select variable">branch</span> <span class="token keyword">in</span> <span class="token variable">${branches<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n    <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n      <span class="token function">git</span> checkout <span class="token variable">$branch</span> -q <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token comment"># 重定向错误信息，即屏蔽错误信息</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span><span class="token variable">$file</span> 切换分支到 <span class="token variable">$branch</span> 失败，可能不存在此分支"</span>\n      <span class="token keyword">else</span>\n        <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>\n        <span class="token function">git</span> pull origin <span class="token variable">$branch</span> -q\n      <span class="token keyword">fi</span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>分支 <span class="token variable">$branch</span> 上的代码统计："</span>\n    <span class="token punctuation">{</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"按日期统计："</span>\n      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$date_stat<span class="token variable">)</span></span>\n      <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n      <span class="token keyword">do</span>\n        <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${exist_branch_projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n        <span class="token keyword">do</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n          <span class="token comment"># git checkout master</span>\n          <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> log --author<span class="token operator">=</span>$git_email --since<span class="token operator">=</span>$since_date --until<span class="token operator">=</span>$until_date --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "add=%s; subs=%s; loc=%s;", add, subs, loc }\'</span><span class="token variable">)</span></span>\n          <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$add_sum <span class="token operator">+</span> $add<span class="token variable">))</span></span>\n          <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$subs_sum <span class="token operator">+</span> $subs<span class="token variable">))</span></span>\n          <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$loc_sum <span class="token operator">+</span> $loc<span class="token variable">))</span></span>\n        <span class="token keyword">done</span>\n        <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$until_date</span> 增加行总数：<span class="token variable">$add_sum</span>，删除行总数：<span class="token variable">$subs_sum</span>，总代码行：<span class="token variable">$loc_sum</span><span class="token entity" title="\\n">\\n</span>"</span>\n        <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n      <span class="token keyword">done</span>\n\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"按项目统计："</span>\n      <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${exist_branch_projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n      <span class="token keyword">do</span>\n        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n          <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n          <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n        <span class="token keyword">fi</span>\n        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n          <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n          <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n        <span class="token keyword">fi</span>\n        <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n        <span class="token comment"># git checkout master</span>\n        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$file</span> 代码量统计："</span>\n        <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$date_stat<span class="token variable">)</span></span>\n        <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span>\n        <span class="token keyword">do</span>\n          <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token function">git</span> log --author<span class="token operator">=</span><span class="token variable">$git_email</span> --since<span class="token operator">=</span><span class="token variable">$since_date</span> --until<span class="token operator">=</span><span class="token variable">$until_date</span> --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "\'</span><span class="token variable">$until_date</span><span class="token string">\' 增加行总数：%s，删除行总数：%s，总代码行：%s<span class="token entity" title="\\n">\\n</span>", add, subs, loc }\'</span>\n          <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n        <span class="token keyword">done</span>\n      <span class="token keyword">done</span>\n    <span class="token punctuation">}</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-2"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-08-13-17-03-10-58491b105bbc6cb6b8465acbeca65cfa-aee79.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 563px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 74.06749555950266%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABjklEQVQoz41T2ZKkIBBsbW9OARXQ9r7m/39ws3si9klnpp4qiEryKHjELsl8llVZoIJABDo05aNkLDBVmCbB4+fq+34cR+d99SlTGS54KWVTN4TSX8DneY7jgCter5cB1BghpdZl27aMcwwEwT3/Z1qUZVkURZ4XhNAwDB9/rPPr6zwO61xdVc45rTVu4ZwTQpIkybKMMZ6m2TX/vu/D0AMG5W+pjAEPI+gpZUqprm1h5FrOuq7zPCOq1vvjODgXSRJTSuEhiqI4jr8lXMt+9b2zzbKsx3mAXAppvpk7qOAazF13y7wsS+sdbCN27z0AkIrsrbVFQaQQUHQLxqj8pG2tq+uaMw5m7x084xC7gKM8z68Dkygh3gsTIIBmwyiFVQAIgfH8GUU/PZJ92xprtVZ1XZVKfWAES3o+n+/AiiJN02vmdd3wvuBwGAZkg1UZo+d5woN7B6YVGnnnedv3eZqapvHObdvGuMCG8jz7z4wmulPetS/bQLU9dshfldK4CB1+CxcSP2WaRqX1JfM/AHop/RSDCV0AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 08 13 17 03 10"\n        title=""\n        src="/static/2019-08-13-17-03-10-58491b105bbc6cb6b8465acbeca65cfa-aee79.png"\n        srcset="/static/2019-08-13-17-03-10-58491b105bbc6cb6b8465acbeca65cfa-b3674.png 200w,\n/static/2019-08-13-17-03-10-58491b105bbc6cb6b8465acbeca65cfa-2063d.png 400w,\n/static/2019-08-13-17-03-10-58491b105bbc6cb6b8465acbeca65cfa-aee79.png 563w"\n        sizes="(max-width: 563px) 100vw, 563px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>以上更新于<code class="language-text">2019-8-15 20:49:40</code></p>\n<hr>\n<h2 id="第四版"><a href="#%E7%AC%AC%E5%9B%9B%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第四版</h2>\n<p>第三版的统计代码的数量对不上对应的时间，把昨天写的代码统计到今天了，做以下修复</p>\n<p>同时增加星期几的优化提示</p>\n<h3 id="修复代码统计对应不上错误的时间以及添加星期几的提示"><a href="#%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81%E7%BB%9F%E8%AE%A1%E5%AF%B9%E5%BA%94%E4%B8%8D%E4%B8%8A%E9%94%99%E8%AF%AF%E7%9A%84%E6%97%B6%E9%97%B4%E4%BB%A5%E5%8F%8A%E6%B7%BB%E5%8A%A0%E6%98%9F%E6%9C%9F%E5%87%A0%E7%9A%84%E6%8F%90%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复代码统计对应不上错误的时间以及添加星期几的提示</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82782070466068510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\n# set -euo pipefail\n# trap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array() {\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n\n  file_path=&quot;G:/project/tungee&quot;\n  git_email=&quot;634407147@qq.com&quot;\n  date_stat=&quot;date +%w&quot; # 今天是一周的第几天，可换成具体数字如 date_stat=&quot;echo 5&quot; 以实现统计几天前代码的功能\n\n  # if [ \\$date_stat -eq 0 ]; then\n  #   date_stat=7\n  # fi\n\n  echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n  read input\n  projects=(\\$(to_array \\$input))\n  echo &quot;输入分支名，以英文逗号分隔，不能有空格&quot;\n  read input\n  branches=(\\$(to_array \\$input))\n\n  for branch in \\${branches[@]}\n  do\n    exist_branch_projects=()\n    for file in \\${projects[@]}\n    do\n      if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n        echo -e &quot;\\$file 目录不存在。&quot;\n        continue;\n      fi\n      if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n        echo -e &quot;\\$file 不是git仓库。&quot;\n        continue;\n      fi\n      cd &quot;\\$file_path/\\$file&quot;\n      git checkout \\$branch -q >/dev/null 2>&1 # 重定向错误信息，即屏蔽错误信息\n      if [ \\$? -eq 0 ]; then\n        exist_branch_projects+=(\\$file)\n        git pull origin \\$branch -q\n      # else\n      #   # echo -e &quot;\\n\\$file 切换分支到 \\$branch 失败，可能不存在此分支&quot;\n      fi\n    done\n    echo -e &quot;\\n分支 \\$branch 上的代码统计：&quot;\n    {\n      echo -e &quot;按日期统计：&quot;\n      # 或 i=\\$((\\$(\\$date_stat)-1))\n      # \\$((\\$a+\\$b)) 用于整数运算，相当于 \\`expr \\$a + \\$b\\`\n      # \\$() 与 \\`\\` 相当于命令替换，执行结果替换\n      i=\\`expr \\$(\\$date_stat) - 1\\`\n      while [ \\$i -ge 0 ]\n      do\n        add_sum=0\n        subs_sum=0\n        loc_sum=0\n        for file in \\${exist_branch_projects[@]}\n        do\n          if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n            echo -e &quot;\\$file 目录不存在。&quot;\n            continue;\n          fi\n          if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n            echo -e &quot;\\$file 不是git仓库。&quot;\n            continue;\n          fi\n          cd &quot;\\$file_path/\\$file&quot;\n          # git checkout \\$branch\n          since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n          since_week=\\`date -d &quot;-\\$i day&quot; +%A\\`\n          until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n          eval \\$(git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;add=%s; subs=%s; loc=%s;&quot;, add, subs, loc }\')\n          add_sum=\\$((\\$add_sum + \\$add))\n          subs_sum=\\$((\\$subs_sum + \\$subs))\n          loc_sum=\\$((\\$loc_sum + \\$loc))\n        done\n        printf &quot;\\$since_date（\\$since_week） 增加行总数：\\$add_sum，删除行总数：\\$subs_sum，总代码行：\\$loc_sum\\n&quot;\n        i=\\$((\\$i-1))\n      done\n\n      # echo -e &quot;按项目统计：&quot;\n      # for file in \\${exist_branch_projects[@]}\n      # do\n      #   if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n      #     echo -e &quot;\\$file 目录不存在。&quot;\n      #     continue;\n      #   fi\n      #   if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n      #     echo -e &quot;\\$file 不是git仓库。&quot;\n      #     continue;\n      #   fi\n      #   cd &quot;\\$file_path/\\$file&quot;\n      #   # git checkout \\$branch\n      #   echo &quot;\\$file 代码量统计：&quot;\n      #   i=\\$(\\$date_stat)\n      #   while [ \\$i -ge 1 ]\n      #   do\n      #     since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      #     until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      #     git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n      #     i=\\$((\\$i-1))\n      #   done\n      # done\n    }\n  done\n}`, `82782070466068510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash{61-65,83,90} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token comment"># set -euo pipefail</span>\n<span class="token comment"># trap "echo \'error: Script failed: see failed command above\'" ERR</span>\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token assign-left variable">file_path</span><span class="token operator">=</span><span class="token string">"G:/project/tungee"</span>\n  <span class="token assign-left variable">git_email</span><span class="token operator">=</span><span class="token string">"634407147@qq.com"</span>\n  <span class="token assign-left variable">date_stat</span><span class="token operator">=</span><span class="token string">"date +%w"</span> <span class="token comment"># 今天是一周的第几天，可换成具体数字如 date_stat="echo 5" 以实现统计几天前代码的功能</span>\n\n  <span class="token comment"># if [ $date_stat -eq 0 ]; then</span>\n  <span class="token comment">#   date_stat=7</span>\n  <span class="token comment"># fi</span>\n\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入分支名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">branches</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">for</span> <span class="token for-or-select variable">branch</span> <span class="token keyword">in</span> <span class="token variable">${branches<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n    <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n      <span class="token function">git</span> checkout <span class="token variable">$branch</span> -q <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token comment"># 重定向错误信息，即屏蔽错误信息</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>\n        <span class="token function">git</span> pull origin <span class="token variable">$branch</span> -q\n      <span class="token comment"># else</span>\n      <span class="token comment">#   # echo -e "\\n$file 切换分支到 $branch 失败，可能不存在此分支"</span>\n      <span class="token keyword">fi</span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>分支 <span class="token variable">$branch</span> 上的代码统计："</span>\n    <span class="token punctuation">{</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"按日期统计："</span>\n<span class="gatsby-highlight-code-line">      <span class="token comment"># 或 i=$(($($date_stat)-1))</span></span><span class="gatsby-highlight-code-line">      <span class="token comment"># $(($a+$b)) 用于整数运算，相当于 `expr $a + $b`</span></span><span class="gatsby-highlight-code-line">      <span class="token comment"># $() 与 `` 相当于命令替换，执行结果替换</span></span><span class="gatsby-highlight-code-line">      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">expr</span> <span class="token punctuation">$(</span>$date_stat<span class="token punctuation">)</span> - <span class="token number">1</span><span class="token variable">`</span></span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">0</span> <span class="token punctuation">]</span></span>      <span class="token keyword">do</span>\n        <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${exist_branch_projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n        <span class="token keyword">do</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n          <span class="token comment"># git checkout $branch</span>\n          <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n<span class="gatsby-highlight-code-line">          <span class="token assign-left variable">since_week</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%A<span class="token variable">`</span></span></span>          <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n          <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> log --author<span class="token operator">=</span>$git_email --since<span class="token operator">=</span>$since_date --until<span class="token operator">=</span>$until_date --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "add=%s; subs=%s; loc=%s;", add, subs, loc }\'</span><span class="token variable">)</span></span>\n          <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$add_sum <span class="token operator">+</span> $add<span class="token variable">))</span></span>\n          <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$subs_sum <span class="token operator">+</span> $subs<span class="token variable">))</span></span>\n          <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$loc_sum <span class="token operator">+</span> $loc<span class="token variable">))</span></span>\n        <span class="token keyword">done</span>\n<span class="gatsby-highlight-code-line">        <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$since_date</span>（<span class="token variable">$since_week</span>） 增加行总数：<span class="token variable">$add_sum</span>，删除行总数：<span class="token variable">$subs_sum</span>，总代码行：<span class="token variable">$loc_sum</span><span class="token entity" title="\\n">\\n</span>"</span></span>        <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n      <span class="token keyword">done</span>\n\n      <span class="token comment"># echo -e "按项目统计："</span>\n      <span class="token comment"># for file in ${exist_branch_projects[@]}</span>\n      <span class="token comment"># do</span>\n      <span class="token comment">#   if [ ! -d "$file_path/$file" ]; then</span>\n      <span class="token comment">#     echo -e "$file 目录不存在。"</span>\n      <span class="token comment">#     continue;</span>\n      <span class="token comment">#   fi</span>\n      <span class="token comment">#   if [ ! -d "$file_path/$file/.git" ]; then</span>\n      <span class="token comment">#     echo -e "$file 不是git仓库。"</span>\n      <span class="token comment">#     continue;</span>\n      <span class="token comment">#   fi</span>\n      <span class="token comment">#   cd "$file_path/$file"</span>\n      <span class="token comment">#   # git checkout $branch</span>\n      <span class="token comment">#   echo "$file 代码量统计："</span>\n      <span class="token comment">#   i=$($date_stat)</span>\n      <span class="token comment">#   while [ $i -ge 1 ]</span>\n      <span class="token comment">#   do</span>\n      <span class="token comment">#     since_date=`date -d "-$i day" +%Y-%m-%d`</span>\n      <span class="token comment">#     until_date=`date -d "-$(($i-1)) day" +%Y-%m-%d`</span>\n      <span class="token comment">#     git log --author=$git_email --since=$since_date --until=$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += $1 ; subs += $2 ; loc += $1 - $2 } END { printf "\'$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n", add, subs, loc }\'</span>\n      <span class="token comment">#     i=$(($i-1))</span>\n      <span class="token comment">#   done</span>\n      <span class="token comment"># done</span>\n    <span class="token punctuation">}</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-3"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-03-07-12-12-03-2caad29e486eada9378d7c44986d3a3f-72de5.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 648px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 65.74074074074075%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABh0lEQVQoz4WS2XKrMBBE2RMDvgJJGG1gCSHCEv//76XtPMXXVZ4HUJXo6ZnTRKUsyUhOvIxJQj4alrB/JKUsT9Ikeluz8955LbUb7dVeG952XW/08Pl5ei/uLh1llHf80l+00nVV53lenk5pmr4XG22GYTzfq26aJsuzOI7iOE6SJH1UHEU4Z1mW/N9unoOUalkW7+e+v4QQpmlijH09ilGG3s45QkhR5M/iJQStzXEc0+S1Vvu+Q9/34tj32+1b484M1lq8MVdZVX/E3ns4b9u2bpsxZl1XiDnnYZ4hHseB4QymGAcZ5H/NRS8IaSDDeIzSYRjgBRPIYIhpOe+UUnVdPytRUgilFb7GdVVVeFLKzvUZvOJHgRmAvaaNJa11y52TF0KAFgwppUBoH5wwC8YqPopXUZmBMT7P8zheRd//0oZ43+7kmqZFr3Eci+KVGGCw0rauy/KllEQ8k/eI6vZ9wLxtW+cs2r3+4Zx1UsgQZvhIKdDrN2fwD0ugDDkb5AwW2P9J+wME1TBgSiwCAQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 03 07 12 12 03"\n        title=""\n        src="/static/2020-03-07-12-12-03-2caad29e486eada9378d7c44986d3a3f-72de5.png"\n        srcset="/static/2020-03-07-12-12-03-2caad29e486eada9378d7c44986d3a3f-bb436.png 200w,\n/static/2020-03-07-12-12-03-2caad29e486eada9378d7c44986d3a3f-c5634.png 400w,\n/static/2020-03-07-12-12-03-2caad29e486eada9378d7c44986d3a3f-72de5.png 648w"\n        sizes="(max-width: 648px) 100vw, 648px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>以上更新于<code class="language-text">2020-3-7 11:57:55</code></p>\n<hr>\n<h2 id="第五版"><a href="#%E7%AC%AC%E4%BA%94%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第五版</h2>\n<p>第四版的代码统计今天的代码有 2 个问题：</p>\n<ol>\n<li>当 i 循环到 0 时，<code class="language-text">-$(($i-1))</code> 这一行代码有问题，统计到的 <code class="language-text">until_date</code> 比 <code class="language-text">since_date</code> 反而早了一天，造成脚本统计错误</li>\n<li>统计今天的代码时，只传年月日会默认带上当前时分秒的时间导致统计不上，即还要加上时分秒，否则不能统计到今天的代码</li>\n</ol>\n<h3 id="修复统计今天代码"><a href="#%E4%BF%AE%E5%A4%8D%E7%BB%9F%E8%AE%A1%E4%BB%8A%E5%A4%A9%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复统计今天代码</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18505497659007910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/bin/sh\n# 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入\n# 能够检测一些错误，并在错误发生时中断程序并输出信息\n# 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。\n# set -euo pipefail\n# trap &quot;echo \'error: Script failed: see failed command above\'&quot; ERR\n# {} 防止下载不完全代码被执行\n{\n  function to_array() {\n    x=\\$1\n    OLD_IFS=&quot;\\$IFS&quot;\n    IFS=&quot;,&quot;\n    array=(\\$x)\n    IFS=&quot;\\$OLD_IFS&quot;\n    for each in \\${array[*]}\n    do\n    echo \\$each\n    done\n  }\n\n  file_path=&quot;G:/project/tungee&quot;\n  git_email=&quot;634407147@qq.com&quot;\n  date_stat=&quot;echo 9&quot; # 今天是一周的第几天，可换成具体数字如 date_stat=&quot;echo 5&quot; 以实现统计几天前代码的功能\n\n  # if [ \\$date_stat -eq 0 ]; then\n  #   date_stat=7\n  # fi\n\n  echo &quot;输入项目名，以英文逗号分隔，不能有空格&quot;\n  read input\n  projects=(\\$(to_array \\$input))\n  echo &quot;输入分支名，以英文逗号分隔，不能有空格&quot;\n  read input\n  branches=(\\$(to_array \\$input))\n\n  for branch in \\${branches[@]}\n  do\n    exist_branch_projects=()\n    for file in \\${projects[@]}\n    do\n      if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n        echo -e &quot;\\$file 目录不存在。&quot;\n        continue;\n      fi\n      if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n        echo -e &quot;\\$file 不是git仓库。&quot;\n        continue;\n      fi\n      cd &quot;\\$file_path/\\$file&quot;\n      git checkout \\$branch -q >/dev/null 2>&1 # 重定向错误信息，即屏蔽错误信息\n      if [ \\$? -eq 0 ]; then\n        exist_branch_projects+=(\\$file)\n        # git pull origin \\$branch -q\n      # else\n      #   # echo -e &quot;\\n\\$file 切换分支到 \\$branch 失败，可能不存在此分支&quot;\n      fi\n    done\n    echo -e &quot;\\n分支 \\$branch 上的代码统计：&quot;\n    {\n      echo -e &quot;按日期统计：&quot;\n      # 或 i=\\$((\\$(\\$date_stat)-1))\n      # \\$((\\$a+\\$b)) 用于整数运算，相当于 \\`expr \\$a + \\$b\\`\n      # \\$() 与 \\`\\` 相当于命令替换，执行结果替换\n      i=\\`expr \\$(\\$date_stat) - 1\\`\n      while [ \\$i -ge 0 ]\n      do\n        add_sum=0\n        subs_sum=0\n        loc_sum=0\n        for file in \\${exist_branch_projects[@]}\n        do\n          if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n            echo -e &quot;\\$file 目录不存在。&quot;\n            continue;\n          fi\n          if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n            echo -e &quot;\\$file 不是git仓库。&quot;\n            continue;\n          fi\n          cd &quot;\\$file_path/\\$file&quot;\n          # git checkout \\$branch\n          since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n          if [ \\$i -ge 1 ]; then\n            until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n          else\n            until_date=\\`date -d &quot;+\\$((0-\\$i+1)) day&quot; +%Y-%m-%d\\`\n          fi\n          eval \\$(git log --author=\\$git_email --since=&quot;\\$since_date 00:00:00&quot; --until=&quot;\\$until_date 00:00:00&quot; --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;add=%s; subs=%s; loc=%s;&quot;, add, subs, loc }\')\n          add_sum=\\$((\\$add_sum + \\$add))\n          subs_sum=\\$((\\$subs_sum + \\$subs))\n          loc_sum=\\$((\\$loc_sum + \\$loc))\n        done\n        since_week=\\`date -d &quot;-\\$i day&quot; +%A\\`\n        printf &quot;\\$since_date（\\$since_week） 增加行总数：\\$add_sum，删除行总数：\\$subs_sum，总代码行：\\$loc_sum\\n&quot;\n        i=\\$((\\$i-1))\n      done\n\n      # echo -e &quot;按项目统计：&quot;\n      # for file in \\${exist_branch_projects[@]}\n      # do\n      #   if [ ! -d &quot;\\$file_path/\\$file&quot; ]; then\n      #     echo -e &quot;\\$file 目录不存在。&quot;\n      #     continue;\n      #   fi\n      #   if [ ! -d &quot;\\$file_path/\\$file/.git&quot; ]; then\n      #     echo -e &quot;\\$file 不是git仓库。&quot;\n      #     continue;\n      #   fi\n      #   cd &quot;\\$file_path/\\$file&quot;\n      #   # git checkout \\$branch\n      #   echo &quot;\\$file 代码量统计：&quot;\n      #   i=\\$(\\$date_stat)\n      #   while [ \\$i -ge 1 ]\n      #   do\n      #     since_date=\\`date -d &quot;-\\$i day&quot; +%Y-%m-%d\\`\n      #     until_date=\\`date -d &quot;-\\$((\\$i-1)) day&quot; +%Y-%m-%d\\`\n      #     git log --author=\\$git_email --since=\\$since_date --until=\\$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += \\$1 ; subs += \\$2 ; loc += \\$1 - \\$2 } END { printf &quot;\'\\$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n&quot;, add, subs, loc }\'\n      #     i=\\$((\\$i-1))\n      #   done\n      # done\n    }\n  done\n}`, `18505497659007910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash{83-88} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>\n<span class="token comment"># 周一到今天的代码量统计，使用方式：./git.bash mockingbird robin koala 或 执行 ./git.bash 后自行输入</span>\n<span class="token comment"># 能够检测一些错误，并在错误发生时中断程序并输出信息</span>\n<span class="token comment"># 使用 set -e 令脚本在发生错误时退出而不是继续运行；使用 set -u 来检查是否使用了未赋值的变量；试试 set -o pipefail，它可以监测管道中的错误。</span>\n<span class="token comment"># set -euo pipefail</span>\n<span class="token comment"># trap "echo \'error: Script failed: see failed command above\'" ERR</span>\n<span class="token comment"># {} 防止下载不完全代码被执行</span>\n<span class="token punctuation">{</span>\n  <span class="token keyword">function</span> <span class="token function-name function">to_array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token variable">$1</span>\n    <span class="token assign-left variable">OLD_IFS</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$IFS</span>"</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">","</span>\n    <span class="token assign-left variable">array</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span>\n    <span class="token assign-left variable"><span class="token environment constant">IFS</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$OLD_IFS</span>"</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable">${array<span class="token punctuation">[</span>*<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span>\n    <span class="token keyword">done</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token assign-left variable">file_path</span><span class="token operator">=</span><span class="token string">"G:/project/tungee"</span>\n  <span class="token assign-left variable">git_email</span><span class="token operator">=</span><span class="token string">"634407147@qq.com"</span>\n  <span class="token assign-left variable">date_stat</span><span class="token operator">=</span><span class="token string">"echo 9"</span> <span class="token comment"># 今天是一周的第几天，可换成具体数字如 date_stat="echo 5" 以实现统计几天前代码的功能</span>\n\n  <span class="token comment"># if [ $date_stat -eq 0 ]; then</span>\n  <span class="token comment">#   date_stat=7</span>\n  <span class="token comment"># fi</span>\n\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入项目名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n  <span class="token builtin class-name">echo</span> <span class="token string">"输入分支名，以英文逗号分隔，不能有空格"</span>\n  <span class="token builtin class-name">read</span> input\n  <span class="token assign-left variable">branches</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token variable"><span class="token variable">$(</span>to_array $input<span class="token variable">)</span></span><span class="token punctuation">)</span>\n\n  <span class="token keyword">for</span> <span class="token for-or-select variable">branch</span> <span class="token keyword">in</span> <span class="token variable">${branches<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n  <span class="token keyword">do</span>\n    <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n    <span class="token keyword">do</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n        <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n      <span class="token keyword">fi</span>\n      <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n      <span class="token function">git</span> checkout <span class="token variable">$branch</span> -q <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token comment"># 重定向错误信息，即屏蔽错误信息</span>\n      <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token assign-left variable">exist_branch_projects</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>\n        <span class="token comment"># git pull origin $branch -q</span>\n      <span class="token comment"># else</span>\n      <span class="token comment">#   # echo -e "\\n$file 切换分支到 $branch 失败，可能不存在此分支"</span>\n      <span class="token keyword">fi</span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\\n">\\n</span>分支 <span class="token variable">$branch</span> 上的代码统计："</span>\n    <span class="token punctuation">{</span>\n      <span class="token builtin class-name">echo</span> -e <span class="token string">"按日期统计："</span>\n      <span class="token comment"># 或 i=$(($($date_stat)-1))</span>\n      <span class="token comment"># $(($a+$b)) 用于整数运算，相当于 `expr $a + $b`</span>\n      <span class="token comment"># $() 与 `` 相当于命令替换，执行结果替换</span>\n      <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">expr</span> <span class="token punctuation">$(</span>$date_stat<span class="token punctuation">)</span> - <span class="token number">1</span><span class="token variable">`</span></span>\n      <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">0</span> <span class="token punctuation">]</span>\n      <span class="token keyword">do</span>\n        <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token number">0</span>\n        <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">${exist_branch_projects<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>\n        <span class="token keyword">do</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 目录不存在。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>/.git"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n            <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$file</span> 不是git仓库。"</span>\n            <span class="token builtin class-name">continue</span><span class="token punctuation">;</span>\n          <span class="token keyword">fi</span>\n          <span class="token builtin class-name">cd</span> <span class="token string">"<span class="token variable">$file_path</span>/<span class="token variable">$file</span>"</span>\n          <span class="token comment"># git checkout $branch</span>\n          <span class="token assign-left variable">since_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span>\n<span class="gatsby-highlight-code-line">          <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span><span class="gatsby-highlight-code-line">            <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">else</span></span><span class="gatsby-highlight-code-line">            <span class="token assign-left variable">until_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"+<span class="token variable"><span class="token variable">$((</span><span class="token number">0</span><span class="token operator">-</span>$i<span class="token operator">+</span><span class="token number">1</span><span class="token variable">))</span></span> day"</span> +%Y-%m-%d<span class="token variable">`</span></span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">fi</span></span><span class="gatsby-highlight-code-line">          <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> log --author<span class="token operator">=</span>$git_email --since<span class="token operator">=</span><span class="token string">"<span class="token variable">$since_date</span> 00:00:00"</span> --until<span class="token operator">=</span><span class="token string">"<span class="token variable">$until_date</span> 00:00:00"</span> --pretty<span class="token operator">=</span>tformat: --numstat <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">add</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">subs</span><span class="token operator">=</span><span class="token number">0</span> -v <span class="token assign-left variable">loc</span><span class="token operator">=</span><span class="token number">0</span> <span class="token string">\'{ add += <span class="token variable">$1</span> ; subs += <span class="token variable">$2</span> ; loc += <span class="token variable">$1</span> - <span class="token variable">$2</span> } END { printf "add=%s; subs=%s; loc=%s;", add, subs, loc }\'</span><span class="token variable">)</span></span></span>          <span class="token assign-left variable">add_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$add_sum <span class="token operator">+</span> $add<span class="token variable">))</span></span>\n          <span class="token assign-left variable">subs_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$subs_sum <span class="token operator">+</span> $subs<span class="token variable">))</span></span>\n          <span class="token assign-left variable">loc_sum</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$loc_sum <span class="token operator">+</span> $loc<span class="token variable">))</span></span>\n        <span class="token keyword">done</span>\n        <span class="token assign-left variable">since_week</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"-<span class="token variable">$i</span> day"</span> +%A<span class="token variable">`</span></span>\n        <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token variable">$since_date</span>（<span class="token variable">$since_week</span>） 增加行总数：<span class="token variable">$add_sum</span>，删除行总数：<span class="token variable">$subs_sum</span>，总代码行：<span class="token variable">$loc_sum</span><span class="token entity" title="\\n">\\n</span>"</span>\n        <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$i<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>\n      <span class="token keyword">done</span>\n\n      <span class="token comment"># echo -e "按项目统计："</span>\n      <span class="token comment"># for file in ${exist_branch_projects[@]}</span>\n      <span class="token comment"># do</span>\n      <span class="token comment">#   if [ ! -d "$file_path/$file" ]; then</span>\n      <span class="token comment">#     echo -e "$file 目录不存在。"</span>\n      <span class="token comment">#     continue;</span>\n      <span class="token comment">#   fi</span>\n      <span class="token comment">#   if [ ! -d "$file_path/$file/.git" ]; then</span>\n      <span class="token comment">#     echo -e "$file 不是git仓库。"</span>\n      <span class="token comment">#     continue;</span>\n      <span class="token comment">#   fi</span>\n      <span class="token comment">#   cd "$file_path/$file"</span>\n      <span class="token comment">#   # git checkout $branch</span>\n      <span class="token comment">#   echo "$file 代码量统计："</span>\n      <span class="token comment">#   i=$($date_stat)</span>\n      <span class="token comment">#   while [ $i -ge 1 ]</span>\n      <span class="token comment">#   do</span>\n      <span class="token comment">#     since_date=`date -d "-$i day" +%Y-%m-%d`</span>\n      <span class="token comment">#     until_date=`date -d "-$(($i-1)) day" +%Y-%m-%d`</span>\n      <span class="token comment">#     git log --author=$git_email --since=$since_date --until=$until_date --pretty=tformat: --numstat | awk -v add=0 -v subs=0 -v loc=0 \'{ add += $1 ; subs += $2 ; loc += $1 - $2 } END { printf "\'$until_date\' 增加行总数：%s，删除行总数：%s，总代码行：%s\\n", add, subs, loc }\'</span>\n      <span class="token comment">#     i=$(($i-1))</span>\n      <span class="token comment">#   done</span>\n      <span class="token comment"># done</span>\n    <span class="token punctuation">}</span>\n  <span class="token keyword">done</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="运行效果-4"><a href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行效果</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-04-24-12-11-28-922ecf0ff70467d63f01bfc83dfac087-ad786.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 457px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 55.57986870897156%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABqElEQVQoz3VS23KbMBQUJdhggwSSAF24g3GwDZlx4zw04/TN//9J3ZI+1vug0eWc3T0LxFXuttnump2vAyII4YQ7whKzfwm4JEKQrU+eoqtaq4umbmIWi4SLRMhM0oQFu53ENldxnDxtPp9OXPyF72/TNJVpaoyVUoZhqLUqihJPT5uzLOOcG63TLNPaFIXVxoRh5Lou6Hzf32w2KHMc57veWfGvOYU5KY01lLF4BY0ixlgQ7ILAxx3Ysf5feTwchmGoqzKkFD6jMNzv97DKKP2mwCwYG8SwsPE8SkEevXjeD9clQz/0fb+OVzwej1xhY28fH5fLuev7iNJlni/zfL1eldZC8GmacAE7mIjUVYVRpRTGmNvtHWpIDRVd2xhrEVvXtWCHO2QZRWFVVUPfcS48bwPlA96stWVRfv3+ghT215/v0+tr27YsZvM8T9NpWZYsy+OYHY9HHBENpiN1XaMNmSmlPj9/JUmi8hw+h6EvimpV7sYVSmkEgj9iHI/4QH4QkKZpyrJEKhC83+9qxfL2No6Hum4Qz3HF6XxGcxLHSAjHhHPE9wdxxTPTv9OxngAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 04 24 12 11 28"\n        title=""\n        src="/static/2020-04-24-12-11-28-922ecf0ff70467d63f01bfc83dfac087-ad786.png"\n        srcset="/static/2020-04-24-12-11-28-922ecf0ff70467d63f01bfc83dfac087-aaeb0.png 200w,\n/static/2020-04-24-12-11-28-922ecf0ff70467d63f01bfc83dfac087-4d187.png 400w,\n/static/2020-04-24-12-11-28-922ecf0ff70467d63f01bfc83dfac087-ad786.png 457w"\n        sizes="(max-width: 457px) 100vw, 457px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>',
id:"/github/workspace/blog/git代码统计脚本/index.md absPath of file >>> MarkdownRemark",timeToRead:11,frontmatter:{date:"2020-04-24 11:17:09",path:"/git-code-statistics-script/",tags:"Git, git 代码统计, 预研",title:"git代码统计脚本",draft:null}},{excerpt:"需求背景 如下图所示，由于多个产品共存，当初设计产品架构时，侧边栏、打电话组件是存在于每个项目的子模块中的。迫于产品越来越多，需要动到侧边栏的时候越来越频繁，随着产品的不断增加导致了需要编译每个项目的工作越来越重，急需一种新的架构来分离侧边栏与各自产品端。 技术方案 基本原理类似于之前的文章  记一次组件打包为链接的实践 ，也就是主框架也就是侧边栏项目提前设定好元素的位置，再用 ReactDOM.render…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>如下图所示，由于多个产品共存，当初设计产品架构时，侧边栏、打电话组件是存在于每个项目的子模块中的。迫于产品越来越多，需要动到侧边栏的时候越来越频繁，随着产品的不断增加导致了需要编译每个项目的工作越来越重，急需一种新的架构来分离侧边栏与各自产品端。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-04-01-11-05-14-5a6b0a65c26cd7517c48041183467750-8b0e1.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 294px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 117.68707482993197%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADKUlEQVQ4y41US08TURi9wMr4CmoCCSiKxPAQFLDY8lACpAIigeBKTFwYF+pKCW5EXPj4Mxp8ENQqBYuPhCUsSOgT2pJCSzud0k5n5s7M9cwUEwGr/fLlZu69Od/jfOcOOWO6bOq8Vt7QNu34wRhTFIXlbGTkyfOlZdfDsWeTNrsoCF6v1+PxuN3uFdjq6sbGhqZpWcGjT1+4PSsPHutgWRK9Ph9Qbo8HazgcjsVimqZmBZ9uaK2xdJ6otdhmv2MvK2omEVaAsMHJny5SfVVU3Un5+eaKhrbSatPrT46EyoKcuMbTFY4G4jSU0H39t+M7vEWdEXk1JqsKFSVKLFcGb90baekeevXxK8/Yz4Di4pgjwGxe5oqxaJpFhG0PCyyWZs6oFuD1mqhMSW2Ltf/G7bpW64RtTmTMzyvhNINvAJBmMVEHZByB4iJbiWuhLZWpiiRJ5OS55tKzF4srL9jn9FFRKisKTafTkiRSRSdA2+k4wjEmqoMb268ODN+pb+/5PDsHMBiOx+NOpxNsr6+vy7K8i2FMTlNVxBUBbu29fu/RODq32R165v+JxMBuD4ScqjPXXLxUUtU47fiGA0EQUE8ikdgybK/gAE4JYlKQkoJICvIL8vcdJoRMTU3hbtVQ1eLi4vLy8tLSUjKZ3AVWNS0WTwKZxqjyCsvyK3vJ/pLJtxO5aBtgjk/qIlEoIQeK8o5VkoJD79+9wR3P86Ca47iEYXtj6Zl5zIrxcY4UFpceKS49eLTINm3Xy/b7o9Goy+Xy+XzBYHAv25nMGV5JfXvfzbsjzT3XbTOO3MumKJtCntaB+6Njpo6+DBhpQTgeEyqPRCJgPlvPkBNeVVuVueNErXnGUFgwuAZYIBAA52AegbKUrWLc5Iypvamrv6zOYnd8z7FsnTDNIKyle3B0/GXX4PCHLzO4M1QtQR7IuZdtbFVVzWRG06TG0mUdGq42d04bmUHy5uYm1lAo5Pf7d/WMiOCZSxg9yzIpr29F2yU1TZlXlSvbhkoIfiMVjZeO15ozYFSF2aLgVCqFFrD915xP7wTDwPP8/PzCwgJ+o5TSvxGWTImSKNNfS47GKYR+jf4AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 04 01 11 05 14"\n        title=""\n        src="/static/2020-04-01-11-05-14-5a6b0a65c26cd7517c48041183467750-8b0e1.png"\n        srcset="/static/2020-04-01-11-05-14-5a6b0a65c26cd7517c48041183467750-2d2ea.png 200w,\n/static/2020-04-01-11-05-14-5a6b0a65c26cd7517c48041183467750-8b0e1.png 294w"\n        sizes="(max-width: 294px) 100vw, 294px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1 id="技术方案"><a href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术方案</h1>\n<p>基本原理类似于之前的文章 <a href="/components-pack-as-library/">记一次组件打包为链接的实践</a>，也就是主框架也就是侧边栏项目提前设定好元素的位置，再用 ReactDOM.render 方法去渲染结点，当然还有许多其他要注意的地方，比如链接的缓存规则、路由之间的跳转、子框架应用间的通信、样式和脚本的隔离等等。</p>\n<p>参考市面上已有的解决的方案，发现比较符合微前端框架的适用场景，于是开始用以下微前端框架来做出一个 demo 级别的应用</p>\n<ol>\n<li><a href="https://github.com/ice-lab/icestark" target="_blank" rel="nofollow noreferrer noopener">ice-stark</a></li>\n<li><a href="https://github.com/single-spa/single-spa" target="_blank" rel="nofollow noreferrer noopener">single-spa</a></li>\n<li><a href="https://github.com/umijs/qiankun" target="_blank" rel="nofollow noreferrer noopener">qiankun</a></li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="ice-stark"><a href="#ice-stark" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ice-stark</h2>\n<h3 id="主框架"><a href="#%E4%B8%BB%E6%A1%86%E6%9E%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主框架</h3>\n<p>以路径作为识别子应用的方式，子应用需要配置 publicPath，否则访问不到</p>\n<p>这里假设产品 1 是采用了旧框架的子应用，产品 2 采用了新的</p>\n<p>以下是在 ice/stark 1.4.1 的版本上开始做的，需要添加代码如下：</p>\n<p>src\\platform\\layout\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6539794007969468000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { AppRouter, AppRoute } from \'@ice/stark\';\n<AppRouter\n  NotFoundComponent={<div>未找到</div>}\n  LoadingComponent={<div>加载中</div>}\n  onRouteChange={this.handleRouteChange}\n>\n  <AppRoute path=\'/product1\' basename=\'/product1\' title=\'产品1\' entry=\'产品1的域名/index.html\' />\n  <AppRoute path=\'/product2\' basename=\'/product2\' title=\'产品2\' entry=\'产品2的域名/index.html\' />\n</AppRouter>;`, `6539794007969468000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> AppRouter<span class="token punctuation">,</span> AppRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ice/stark\'</span><span class="token punctuation">;</span>\n<span class="token operator">&lt;</span>AppRouter\n  NotFoundComponent<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">></span>未找到<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span>\n  LoadingComponent<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">></span>加载中<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span>\n  onRouteChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleRouteChange<span class="token punctuation">}</span>\n<span class="token operator">></span>\n  <span class="token operator">&lt;</span>AppRoute path<span class="token operator">=</span><span class="token string">\'/product1\'</span> basename<span class="token operator">=</span><span class="token string">\'/product1\'</span> title<span class="token operator">=</span><span class="token string">\'产品1\'</span> entry<span class="token operator">=</span><span class="token string">\'产品1的域名/index.html\'</span> <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span>AppRoute path<span class="token operator">=</span><span class="token string">\'/product2\'</span> basename<span class="token operator">=</span><span class="token string">\'/product2\'</span> title<span class="token operator">=</span><span class="token string">\'产品2\'</span> entry<span class="token operator">=</span><span class="token string">\'产品2的域名/index.html\'</span> <span class="token operator">/</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>AppRouter<span class="token operator">></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结合公司实际的应用场景，不同产品对应着不同的域名，这就不能用路径的方式来识别子应用的加载，需要作出如下改动</p>\n<p>当然对应的子应用就不需要路径别名的配置了，这样实现的缺点是 onRouteChange 这个函数不再起作用，而且不能控制子应用的缓存，这些不同域名的缓存全部交给对应的 nginx 来做了</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26987548032113650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { AppRouter, AppRoute } from \'@ice/stark\';\n<AppRouter\n  NotFoundComponent={<div>未找到</div>}\n  LoadingComponent={<div>加载中</div>}\n  onRouteChange={this.handleRouteChange}\n>\n  {产品1的域名 ? <AppRoute path=\'/\' basename=\'/\' title=\'产品1\' entry=\'产品1的域名/index.html\' /> : null}\n\n  {产品2的域名 ? <AppRoute path=\'/\' basename=\'/\' title=\'产品2\' entry=\'产品2的域名/index.html\' /> : null}\n</AppRouter>;`, `26987548032113650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> AppRouter<span class="token punctuation">,</span> AppRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ice/stark\'</span><span class="token punctuation">;</span>\n<span class="token operator">&lt;</span>AppRouter\n  NotFoundComponent<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">></span>未找到<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span>\n  LoadingComponent<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">></span>加载中<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">}</span>\n  onRouteChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleRouteChange<span class="token punctuation">}</span>\n<span class="token operator">></span>\n  <span class="token punctuation">{</span>产品<span class="token number">1</span>的域名 <span class="token operator">?</span> <span class="token operator">&lt;</span>AppRoute path<span class="token operator">=</span><span class="token string">\'/\'</span> basename<span class="token operator">=</span><span class="token string">\'/\'</span> title<span class="token operator">=</span><span class="token string">\'产品1\'</span> entry<span class="token operator">=</span><span class="token string">\'产品1的域名/index.html\'</span> <span class="token operator">/</span><span class="token operator">></span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span>\n\n  <span class="token punctuation">{</span>产品<span class="token number">2</span>的域名 <span class="token operator">?</span> <span class="token operator">&lt;</span>AppRoute path<span class="token operator">=</span><span class="token string">\'/\'</span> basename<span class="token operator">=</span><span class="token string">\'/\'</span> title<span class="token operator">=</span><span class="token string">\'产品2\'</span> entry<span class="token operator">=</span><span class="token string">\'产品2的域名/index.html\'</span> <span class="token operator">/</span><span class="token operator">></span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>AppRouter<span class="token operator">></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="子框架"><a href="#%E5%AD%90%E6%A1%86%E6%9E%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>子框架</h3>\n<h4 id="老项目"><a href="#%E8%80%81%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>老项目</h4>\n<p>老项目采用了 react-router 3.2.1，区别于新项目</p>\n<p>以下是在 ice/stark-app 1.2.0 的版本上开始做的，需要添加代码如下：</p>\n<h5 id="入口文件"><a href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入口文件</h5>\n<p>app\\app.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64057797908597180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { applyRouterMiddleware, Router, browserHistory, useRouterHistory } from \'react-router\';\nimport { createHistory } from \'history\';\nimport { isInIcestark, getMountNode, registerAppEnter, registerAppLeave, getBasename } from \'@ice/stark-app\';\n\nconst baseHistory = useRouterHistory(createHistory)({\n  basename: getBasename()\n});\n\nconst isIE9 = utils.getBrowserInfo().msie && utils.getBrowserInfo().version === \'9.0\';\n\nconst history = syncHistoryWithStore(baseHistory, store, {\n  selectLocationState: makeSelectLocationState(),\n  adjustUrlOnReplay: isIE9 ? false : undefined\n});\n\nconst router = () => (\n  <ConfigProvider locale={zhCN}>\n    <Provider store={store}>\n      <Router\n        history={history}\n        routes={rootRoute}\n        render={\n          // Scroll to top when going to a new page, imitating default browser behaviour\n          applyRouterMiddleware(useScroll())\n        }\n      />\n    </Provider>\n  </ConfigProvider>\n);\n\nif (isInIcestark()) {\n  registerAppEnter(() => {\n    ReactDOM.render(router(), getMountNode());\n  });\n  registerAppLeave(() => {\n    ReactDOM.unmountComponentAtNode(getMountNode());\n  });\n} else {\n  ReactDOM.render(router(), document.getElementById(\'app\'));\n}`, `64057797908597180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{1-3,5-7,11,16-38} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> applyRouterMiddleware<span class="token punctuation">,</span> Router<span class="token punctuation">,</span> browserHistory<span class="token punctuation">,</span> useRouterHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'history\'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> isInIcestark<span class="token punctuation">,</span> getMountNode<span class="token punctuation">,</span> registerAppEnter<span class="token punctuation">,</span> registerAppLeave<span class="token punctuation">,</span> getBasename <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ice/stark-app\'</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> baseHistory <span class="token operator">=</span> <span class="token function">useRouterHistory</span><span class="token punctuation">(</span>createHistory<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  basename<span class="token punctuation">:</span> <span class="token function">getBasename</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token keyword">const</span> isIE9 <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">getBrowserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>msie <span class="token operator">&amp;&amp;</span> utils<span class="token punctuation">.</span><span class="token function">getBrowserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version <span class="token operator">===</span> <span class="token string">\'9.0\'</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token function">syncHistoryWithStore</span><span class="token punctuation">(</span>baseHistory<span class="token punctuation">,</span> store<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>  selectLocationState<span class="token punctuation">:</span> <span class="token function">makeSelectLocationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  adjustUrlOnReplay<span class="token punctuation">:</span> isIE9 <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token punctuation">:</span> <span class="token keyword">undefined</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> <span class="token function-variable function">router</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">  <span class="token operator">&lt;</span>ConfigProvider locale<span class="token operator">=</span><span class="token punctuation">{</span>zhCN<span class="token punctuation">}</span><span class="token operator">></span></span><span class="gatsby-highlight-code-line">    <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">></span></span><span class="gatsby-highlight-code-line">      <span class="token operator">&lt;</span>Router</span><span class="gatsby-highlight-code-line">        history<span class="token operator">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        routes<span class="token operator">=</span><span class="token punctuation">{</span>rootRoute<span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        render<span class="token operator">=</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// Scroll to top when going to a new page, imitating default browser behaviour</span></span><span class="gatsby-highlight-code-line">          <span class="token function">applyRouterMiddleware</span><span class="token punctuation">(</span><span class="token function">useScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token operator">/</span><span class="token operator">></span></span><span class="gatsby-highlight-code-line">    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">></span></span><span class="gatsby-highlight-code-line">  <span class="token operator">&lt;</span><span class="token operator">/</span>ConfigProvider<span class="token operator">></span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInIcestark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token function">registerAppEnter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMountNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token function">registerAppLeave</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    ReactDOM<span class="token punctuation">.</span><span class="token function">unmountComponentAtNode</span><span class="token punctuation">(</span><span class="token function">getMountNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'app\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="网络请求"><a href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>网络请求</h5>\n<p>网络请求、资源都需要绝对路径，这就涉及到资源的跨域，需要处理</p>\n<p>app\\utils\\httpFetch.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26918469441010730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export default function httpFetch(url, options) {\n  const newUrl = __COMMON_VARS__.robots + url;\n  // already forced sign out and has shown modal, cancel fetch\n  if (hasShownForcedSignOutModal) {\n    return new Promise((resolve, reject) => {\n      const error = new Error();\n      error.status = 401;\n      reject(error);\n    });\n  }\n  // eslint-disable-next-line no-param-reassign\n  options = {\n    ...options,\n    credentials: \'include\'\n  };\n  return runFetch(newUrl, options).then((response) => checkStatus(response, newUrl, options));\n}`, `26918469441010730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{2,12-17} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">httpFetch</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> newUrl <span class="token operator">=</span> __COMMON_VARS__<span class="token punctuation">.</span>robots <span class="token operator">+</span> url<span class="token punctuation">;</span></span>  <span class="token comment">// already forced sign out and has shown modal, cancel fetch</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasShownForcedSignOutModal<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      error<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// eslint-disable-next-line no-param-reassign</span>\n<span class="gatsby-highlight-code-line">  options <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token operator">...</span>options<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    credentials<span class="token punctuation">:</span> <span class="token string">\'include\'</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token function">runFetch</span><span class="token punctuation">(</span>newUrl<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">checkStatus</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> newUrl<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="webpack-配置"><a href="#webpack-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 配置</h5>\n<p>internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44615056376398220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: Object.assign({ // Compile into js/build.js\n  path: path.resolve(process.cwd(), \'build\'),\n  publicPath: \\`\\${globalVars.robots}/product1/\\`,\n}, options.output), // Merge with env dependent settings`, `44615056376398220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{3} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// Compile into js/build.js</span>\n  path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">  publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>globalVars<span class="token punctuation">.</span>robots<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/product1/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Merge with env dependent settings</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h5 id="nodejs-服务器配置"><a href="#nodejs-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nodejs 服务器配置</h5>\n<p>server\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48446055838048890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 设置允许资源文件跨域访问该服务\napp.all(\'*\', (req, res, next) => {\n  res.header(\'Access-Control-Allow-Origin\', \'*\');\n  next();\n});\n\n// Copy proxy.config.example.json to proxy.config.json to setup proxy\nconst proxy = require(\'http-proxy-middleware\');\nconfig.proxies.forEach((item) => {\n  app.use(\n    item.match,\n    proxy({\n      target: item.host,\n      changeOrigin: true,\n      // 修改响应头信息，实现跨域并允许带cookie\n      onProxyRes(proxyRes, req, res) {\n        res.header(\'Access-Control-Allow-Origin\', req.headers.origin);\n        res.header(\'Access-Control-Allow-Credentials\', \'true\');\n        res.header(\n          \'Access-Control-Allow-Headers\',\n          \'Content-Type, Content-Length, Authorization, Accept, X-Requested-With, Pragma, Cache-Control\'\n        );\n      }\n      // 修改响应信息中的cookie域名\n      // cookieDomainRewrite: \'www.domain1.com\', // 可以为false，表示不修改\n    })\n  );\n});\n\n// In production we need to pass these values in instead of relying on webpack\nsetup(app, {\n  outputPath: resolve(process.cwd(), \'build\'),\n  publicPath: \'/product1\'\n});`, `48446055838048890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{2-5,13-20,27} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 设置允许资源文件跨域访问该服务</span>\n<span class="gatsby-highlight-code-line">app<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">\'Access-Control-Allow-Origin\'</span><span class="token punctuation">,</span> <span class="token string">\'*\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="token comment">// Copy proxy.config.example.json to proxy.config.json to setup proxy</span>\n<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http-proxy-middleware\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconfig<span class="token punctuation">.</span>proxies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>\n    item<span class="token punctuation">.</span>match<span class="token punctuation">,</span>\n    <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">      target<span class="token punctuation">:</span> item<span class="token punctuation">.</span>host<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      changeOrigin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 修改响应头信息，实现跨域并允许带cookie</span></span><span class="gatsby-highlight-code-line">      <span class="token function">onProxyRes</span><span class="token punctuation">(</span><span class="token parameter">proxyRes<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">\'Access-Control-Allow-Origin\'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">\'Access-Control-Allow-Credentials\'</span><span class="token punctuation">,</span> <span class="token string">\'true\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">          <span class="token string">\'Access-Control-Allow-Headers\'</span><span class="token punctuation">,</span></span>          <span class="token string">\'Content-Type, Content-Length, Authorization, Accept, X-Requested-With, Pragma, Cache-Control\'</span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 修改响应信息中的cookie域名</span>\n      <span class="token comment">// cookieDomainRewrite: \'www.domain1.com\', // 可以为false，表示不修改</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// In production we need to pass these values in instead of relying on webpack</span>\n<span class="token function">setup</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  outputPath<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'build\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  publicPath<span class="token punctuation">:</span> <span class="token string">\'/product1\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="新项目"><a href="#%E6%96%B0%E9%A1%B9%E7%9B%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新项目</h4>\n<p>新项目采用了 react-router 3.2.1，相同的部分不再阐述，只有入口文件不同于老项目</p>\n<h5 id="入口文件-1"><a href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>入口文件</h5>\n<p>src\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54212695184118580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { BrowserRouter, Router } from \'react-router-dom\';\nimport { isInIcestark, getMountNode, registerAppEnter, registerAppLeave, getBasename } from \'@ice/stark-app\';\n\nconst router = () => (\n  <Provider {...stores}>\n    <Router history={history}>\n      <BrowserRouter basename={getBasename()}>\n        <ConfigProvider locale={zhCN}>\n          <App />\n        </ConfigProvider>\n      </BrowserRouter>\n    </Router>\n  </Provider>\n);\n\nif (isInIcestark()) {\n  registerAppEnter(() => {\n    ReactDOM.render(router(), getMountNode());\n  });\n  registerAppLeave(() => {\n    ReactDOM.unmountComponentAtNode(getMountNode());\n  });\n} else {\n  ReactDOM.render(router(), document.getElementById(\'app\'), renderCallback);\n}`, `54212695184118580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter<span class="token punctuation">,</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react-router-dom\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> isInIcestark<span class="token punctuation">,</span> getMountNode<span class="token punctuation">,</span> registerAppEnter<span class="token punctuation">,</span> registerAppLeave<span class="token punctuation">,</span> getBasename <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ice/stark-app\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">router</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>Provider <span class="token punctuation">{</span><span class="token operator">...</span>stores<span class="token punctuation">}</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span>Router history<span class="token operator">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>BrowserRouter basename<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getBasename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span>ConfigProvider locale<span class="token operator">=</span><span class="token punctuation">{</span>zhCN<span class="token punctuation">}</span><span class="token operator">></span>\n          <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>ConfigProvider<span class="token operator">></span>\n      <span class="token operator">&lt;</span><span class="token operator">/</span>BrowserRouter<span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>Router<span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInIcestark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">registerAppEnter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMountNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">registerAppLeave</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    ReactDOM<span class="token punctuation">.</span><span class="token function">unmountComponentAtNode</span><span class="token punctuation">(</span><span class="token function">getMountNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'app\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> renderCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="single-spa"><a href="#single-spa" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>single-spa</h2>\n<p>待研究，不过这个框架只兼容 IE 10</p>\n<h2 id="qiankun"><a href="#qiankun" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>qiankun</h2>\n<p>待研究，不过这个框架不兼容 IE</p>\n<h1 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h1>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-04-01-15-21-23-c6a39b5a4d7756feb3fd70033eed98a2-a54b5.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 64.7457627118644%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB0klEQVQoz5WRyW4UMRCG/SbcQEoEXEBKJBCCIHgZDlzgEBIQiiagsDwCNyTEgQsvlJlJL7N0e+m221vZ/DOBMCxCovSrVN32V/XbZsaYEIIZrJSdNuasrCdFeTqZjqdFUc2KqobKej5fNsitUMa6Tg+QHixzRoiWR9eKtqpnS6vnSsyKYmFUyZuyqhbOzLE0npSmn4mmLNd/rOF1vWD7R68/ffkag9N91/U6UaAYfIgphRj9RWGdT+Sx4pyn6GldsUdPDz98/MzbZrmYIef/CXbp6s7jZyMZ85mgShE31Bpaaiq46zqtevMPse3dvScvTxqfT1uaiiRs5jY3Qx43Vsiulf0vElC3ziuxrd29w+O38NArpfs+/bCE++eyx1HdhjxOHcn54NxK7PKNO/tHJ9jNOW9x7USbcESEn2GMxi5rbc7JU2bXbz88GL1ZwwI8/Q4TGL8OFMMwSCmtc4AD4Cs37x6MVraFEEqplNImPFg8FlHKIZCFVR/xDcOr2nl27daD58fvckogpZCweQHjboz1aDoeT+ALbdEHXtAMipTY1s6988m619Cm7UZ0gwtSiOlkCrd/eeft3fsvXr1HQxwYk89hZG2+T3YOD6601n/C3wCE+so4n29eigAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 04 01 15 21 23"\n        title=""\n        src="/static/2020-04-01-15-21-23-c6a39b5a4d7756feb3fd70033eed98a2-a54b5.png"\n        srcset="/static/2020-04-01-15-21-23-c6a39b5a4d7756feb3fd70033eed98a2-33798.png 200w,\n/static/2020-04-01-15-21-23-c6a39b5a4d7756feb3fd70033eed98a2-27c47.png 400w,\n/static/2020-04-01-15-21-23-c6a39b5a4d7756feb3fd70033eed98a2-a54b5.png 590w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-04-01-15-20-24-5fc1161188a447c99aad5a6563b39c06-b3c03.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 534px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 80.5243445692884%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACU0lEQVQoz41TS2sUQRCeX+HFswb0Ij4SvGgCCShCvAheRFHBJKhgoh5C8OJB0Ls3vejBvxLwEBJxQQj7mumZ3Z1n9/Rz+jHW7LJx11Oaj6a6ar6prqqvvZKUldZcyDzHjPNRnHS6/W6vf9zutHtBPwj7Pur5YRAOosEQRUMfDQpSMi4IFV5tJAeTpaJE/T7CODMiyrNsOIw1j9IkCqOR4jEnUbcXgLtiAQrCOE6MQN67D5++fPuhtdIVZ4xXVeWM1LpSqnJWVUpKqaxRRkvOhVJgSyEEeK0R3u77j5+/fvd9P0Qh7PBFXdeuPtXyrizf3tjepUxAHYRyJiSX6gRMqNnjfyHv0o1bT16+zTHNCYM9Kxo0x1PAW1hcebi1g0uekwaY8mJqAzLMi+anbEpgs/CW1tY3X+9BIMEiKN3voevmdSrciLlE1Ee9NE7zylilLexS6Vl4567efLDxCkMSIjLhImJjakrlaFULW/86DoBMCf65v394eGSMnWvY0trdZ9u7GaYlkzCgIkt63Q4t6TjqggCN4lRoF+clpaWx8+SFxeXHz99AYaAYOMNUK1U1PNfMyw9QliZ/ivog0pLhApOJf5p5dX1zZw86PCETQkADJ2TIDNcG5eLxXdy8ALyL11fHo2J4TGaUDqJowp+Qh0nGYfxTz7xIVu5At08yg+4wxiDSSRihEA3iST6oF2qahXfm/OV7j7aASVgjWiiryAtrzL/McSalaLfbKIystW5meWcvXLv/9AWIBPgGXoBqnoKddrXpdpILxlutVqfTtfPd/gsAAGL9y/8pXQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 04 01 15 20 24"\n        title=""\n        src="/static/2020-04-01-15-20-24-5fc1161188a447c99aad5a6563b39c06-b3c03.png"\n        srcset="/static/2020-04-01-15-20-24-5fc1161188a447c99aad5a6563b39c06-52a8d.png 200w,\n/static/2020-04-01-15-20-24-5fc1161188a447c99aad5a6563b39c06-3dc4b.png 400w,\n/static/2020-04-01-15-20-24-5fc1161188a447c99aad5a6563b39c06-b3c03.png 534w"\n        sizes="(max-width: 534px) 100vw, 534px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>',
id:"/github/workspace/blog/微前端适配demo的实践/index.md absPath of file >>> MarkdownRemark",timeToRead:5,frontmatter:{date:"2020-04-01 09:59:12",path:"/micro-front-end-demo-practice/",tags:"前端, 微前端, 预研",title:"微前端适配demo的实践",draft:null}},{excerpt:"IOS fix 定位不准 现象 在有输入框的情况下尽量不要用 fixed 定位，用 absolute，否则在 IOS 下会出现很多问题，比如输入法收起时 fixed 定位的元素其实还在未收起的地方，会造成在输入法收起时输入框不能点击 解决方案 当然在用 absolute 的时候，需要注意 body、html 的定位（设置为 relative 或者不设），放在 body 的下面等等问题 微信下 IOS13 输入法不恢复 现象 在 IOS1…",html:'<h1 id="ios-fix-定位不准"><a href="#ios-fix-%E5%AE%9A%E4%BD%8D%E4%B8%8D%E5%87%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IOS fix 定位不准</h1>\n<h2 id="现象"><a href="#%E7%8E%B0%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>在有输入框的情况下尽量不要用 fixed 定位，用 absolute，否则在 IOS 下会出现很多问题，比如输入法收起时 fixed 定位的元素其实还在未收起的地方，会造成在输入法收起时输入框不能点击</p>\n<h2 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<p>当然在用 absolute 的时候，需要注意 body、html 的定位（设置为 relative 或者不设），放在 body 的下面等等问题</p>\n<h1 id="微信下-ios13-输入法不恢复"><a href="#%E5%BE%AE%E4%BF%A1%E4%B8%8B-ios13-%E8%BE%93%E5%85%A5%E6%B3%95%E4%B8%8D%E6%81%A2%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微信下 IOS13 输入法不恢复</h1>\n<h2 id="现象-1"><a href="#%E7%8E%B0%E8%B1%A1-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>在 IOS13 系统下，点击输入框弹出输入法，再收起输入法时会发现输入法回去了，整个页面留下输入法的空白，上下滑动一下布局恢复正常</p>\n<h2 id="解决方案-1"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<p>在微信端的输入法键盘收起时滑动一下页面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28898165520876320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let currentPosition;\nconst speed = 1; // 页面滚动距离\nconst timer = setInterval(() => {\n  currentPosition = document.documentElement.scrollTop || document.body.scrollTop;\n  currentPosition -= speed;\n  window.scrollTo(0, currentPosition); // 页面向上滚动\n  currentPosition += speed; // speed变量\n  window.scrollTo(0, currentPosition); // 页面向下滚动\n  clearInterval(timer);\n}, 1);`, `28898165520876320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> currentPosition<span class="token punctuation">;</span>\n<span class="token keyword">const</span> speed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 页面滚动距离</span>\n<span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  currentPosition <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>\n  currentPosition <span class="token operator">-=</span> speed<span class="token punctuation">;</span>\n  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> currentPosition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 页面向上滚动</span>\n  currentPosition <span class="token operator">+=</span> speed<span class="token punctuation">;</span> <span class="token comment">// speed变量</span>\n  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> currentPosition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 页面向下滚动</span>\n  <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="移动端输入法收起时布局不恢复"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E8%BE%93%E5%85%A5%E6%B3%95%E6%94%B6%E8%B5%B7%E6%97%B6%E5%B8%83%E5%B1%80%E4%B8%8D%E6%81%A2%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端输入法收起时布局不恢复</h1>\n<h2 id="现象-2"><a href="#%E7%8E%B0%E8%B1%A1-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>移动端网站打开输入法后再收起，此时还会保持在打开输入法时的布局</p>\n<h2 id="产生原因"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>我们在 app 布局中会有个固定的底部，安卓一些版本中，输入弹窗出来，将挤压 absolute 和 fixed 定位的元素，导致可视区域变小，布局错乱。</p>\n<h2 id="解决方案-2"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="收起时置为初始位置"><a href="#%E6%94%B6%E8%B5%B7%E6%97%B6%E7%BD%AE%E4%B8%BA%E5%88%9D%E5%A7%8B%E4%BD%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>收起时置为初始位置</h3>\n<p>在输入法键盘收起时将窗口置为初始位置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71328175579285990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`setTimeout(() => {\n  if (document.body) {\n    document.body.scrollTop = 0;\n  }\n}, 100);`, `71328175579285990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="监听页面高度变化，强制恢复成弹出前的高度"><a href="#%E7%9B%91%E5%90%AC%E9%A1%B5%E9%9D%A2%E9%AB%98%E5%BA%A6%E5%8F%98%E5%8C%96%EF%BC%8C%E5%BC%BA%E5%88%B6%E6%81%A2%E5%A4%8D%E6%88%90%E5%BC%B9%E5%87%BA%E5%89%8D%E7%9A%84%E9%AB%98%E5%BA%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听页面高度变化，强制恢复成弹出前的高度</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4734347836089548000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 记录原有的视口高度\nconst originalHeight = document.body.clientHeight || document.documentElement.clientHeight;\n\nwindow.onresize = function() {\n  var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;\n  if (resizeHeight < originalHeight) {\n    // 恢复内容区域高度\n    // const container = document.getElementById(&quot;container&quot;)\n    // 例如 container.style.height = originalHeight;\n  }\n};`, `4734347836089548000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 记录原有的视口高度</span>\n<span class="token keyword">const</span> originalHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n\nwindow<span class="token punctuation">.</span><span class="token function-variable function">onresize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> resizeHeight <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight <span class="token operator">||</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>resizeHeight <span class="token operator">&lt;</span> originalHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 恢复内容区域高度</span>\n    <span class="token comment">// const container = document.getElementById("container")</span>\n    <span class="token comment">// 例如 container.style.height = originalHeight;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>键盘不能回落问题出现在 iOS 12+ 和 wechat 6.7.4+ 中，而在微信 H5 开发中是比较常见的 Bug。</p>\n<p>兼容原理：</p>\n<ol>\n<li>判断版本类型</li>\n<li>更改滚动的可视区域</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23039291837934070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const isWechat = window.navigator.userAgent.match(/MicroMessenger\\/([\\d\\.]+)/i);\nif (!isWechat) return;\nconst wechatVersion = wechatInfo[1];\nconst version = navigator.appVersion.match(/OS (\\d+)_(\\d+)_?(\\d+)?/);\n\n// 如果设备类型为iOS 12+ 和wechat 6.7.4+，恢复成原来的视口\nif (+wechatVersion.replace(/\\./g, \'\') >= 674 && +version[1] >= 12) {\n  window.scrollTo(0, Math.max(document.body.clientHeight, document.documentElement.clientHeight));\n}`, `23039291837934070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> isWechat <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/MicroMessenger\\/([\\d\\.]+)/i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isWechat<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> wechatVersion <span class="token operator">=</span> wechatInfo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> version <span class="token operator">=</span> navigator<span class="token punctuation">.</span>appVersion<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/OS (\\d+)_(\\d+)_?(\\d+)?/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 如果设备类型为iOS 12+ 和wechat 6.7.4+，恢复成原来的视口</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">+</span>wechatVersion<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\./g</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">674</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>version<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight<span class="token punctuation">,</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>window.scrollTo(x-coord, y-coord)，其中 window.scrollTo(0, clientHeight)恢复成原来的视口</p>\n</blockquote>\n<h1 id="ios-第三方输入法会遮挡（不完美）"><a href="#ios-%E7%AC%AC%E4%B8%89%E6%96%B9%E8%BE%93%E5%85%A5%E6%B3%95%E4%BC%9A%E9%81%AE%E6%8C%A1%EF%BC%88%E4%B8%8D%E5%AE%8C%E7%BE%8E%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IOS 第三方输入法会遮挡（不完美）</h1>\n<h2 id="现象-3"><a href="#%E7%8E%B0%E8%B1%A1-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>IOS 第三方输入法比如搜狗，打开输入法时工具栏会遮挡输入框</p>\n<h2 id="解决方案-3"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<p>在输入法键盘打开时，强制滚动到输入框的焦点，此方案在移动端浏览器会造成布局的错乱</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22867052613689600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 会造成移动端bug，暂时不用\nconst timer = setInterval(function() {\n  element.scrollIntoView(true);\n  clearInterval(timer);\n}, 100);`, `22867052613689600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 会造成移动端bug，暂时不用</span>\n<span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  element<span class="token punctuation">.</span><span class="token function">scrollIntoView</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="ios-滑动不流畅"><a href="#ios-%E6%BB%91%E5%8A%A8%E4%B8%8D%E6%B5%81%E7%95%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IOS 滑动不流畅</h1>\n<h2 id="现象-4"><a href="#%E7%8E%B0%E8%B1%A1-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>上下滑动页面会产生卡顿，手指离开页面，页面立即停止运动，整体表现就是滑动不流畅，没有滑动惯性。</p>\n<h2 id="产生原因-1"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>在 iOS 5.0 以及之后的版本，滑动有定义有两个值 auto 和 touch，默认值为 auto。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93118275196653940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-webkit-overflow-scrolling: touch; /* 当手指从触摸屏上移开，会保持一段时间的滚动 */\n-webkit-overflow-scrolling: auto; /* 当手指从触摸屏上移开，滚动会立即停止 */`, `93118275196653940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                css 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token property">-webkit-overflow-scrolling</span><span class="token punctuation">:</span> touch<span class="token punctuation">;</span> <span class="token comment">/* 当手指从触摸屏上移开，会保持一段时间的滚动 */</span>\n<span class="token property">-webkit-overflow-scrolling</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span> <span class="token comment">/* 当手指从触摸屏上移开，滚动会立即停止 */</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="解决方案-4"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="在滚动容器上增加滚动-touch-方法"><a href="#%E5%9C%A8%E6%BB%9A%E5%8A%A8%E5%AE%B9%E5%99%A8%E4%B8%8A%E5%A2%9E%E5%8A%A0%E6%BB%9A%E5%8A%A8-touch-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在滚动容器上增加滚动 touch 方法</h3>\n<p>将 -webkit-overflow-scrolling 值设置为 touch，同时要设置滚动条隐藏 .container ::-webkit-scrollbar {display: none;}</p>\n<p>可能会导致使用 position:fixed; 固定定位的元素，随着页面一起滚动</p>\n<h3 id="设置-overflow"><a href="#%E8%AE%BE%E7%BD%AE-overflow" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置 overflow</h3>\n<p>设置外部 overflow 为 hidden,设置内容元素 overflow 为 auto。内部元素超出 body 即产生滚动，超出的部分 body 隐藏。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76320625316999540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`body {\n  overflow-y: hidden;\n}\n\n.wrapper {\n  overflow-y: auto;\n}`, `76320625316999540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                css 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span>\n  <span class="token property">overflow-y</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token selector">.wrapper</span> <span class="token punctuation">{</span>\n  <span class="token property">overflow-y</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="ios-上拉边界下拉出现白色空白"><a href="#ios-%E4%B8%8A%E6%8B%89%E8%BE%B9%E7%95%8C%E4%B8%8B%E6%8B%89%E5%87%BA%E7%8E%B0%E7%99%BD%E8%89%B2%E7%A9%BA%E7%99%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>iOS 上拉边界下拉出现白色空白</h1>\n<h2 id="现象-5"><a href="#%E7%8E%B0%E8%B1%A1-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>手指按住屏幕下拉，屏幕顶部会多出一块白色区域。手指按住屏幕上拉，底部多出一块白色区域。</p>\n<h2 id="产生原因-2"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>在 iOS 中，手指按住屏幕上下拖动，会触发 touchmove 事件。这个事件触发的对象是整个 webview 容器，容器自然会被拖动，剩下的部分会成空白。</p>\n<h2 id="解决方案-5"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="监听事件禁止滑动"><a href="#%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6%E7%A6%81%E6%AD%A2%E6%BB%91%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>监听事件禁止滑动</h3>\n<p>移动端触摸事件有三个，分别定义为</p>\n<ol>\n<li>touchstart ：手指放在一个 DOM 元素上。</li>\n<li>touchmove ：手指拖曳一个 DOM 元素。</li>\n<li>touchend ：手指从一个 DOM 元素上移开。</li>\n</ol>\n<p>touchmove 事件的速度是可以实现定义的，取决于硬件性能和其他实现细节，同时 preventDefault 方法，阻止同一触点上所有默认行为，比如滚动。</p>\n<p>由此我们找到解决方案，通过监听 touchmove，让需要滑动的地方滑动，不需要滑动的地方禁止滑动。</p>\n<blockquote>\n<p>值得注意的是我们要过滤掉具有滚动容器的元素。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23442584674982904000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`document.body.addEventListener(\n  \'touchmove\',\n  function(e) {\n    if (e._isScroller) return;\n    // 阻止默认事件\n    e.preventDefault();\n  },\n  {\n    // 防止 treated as passive 报错\n    passive: false\n  }\n);`, `23442584674982904000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>\n  <span class="token string">\'touchmove\'</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>_isScroller<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token comment">// 阻止默认事件</span>\n    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span>\n    <span class="token comment">// 防止 treated as passive 报错</span>\n    passive<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="滚动妥协填充空白，装饰成其他功能"><a href="#%E6%BB%9A%E5%8A%A8%E5%A6%A5%E5%8D%8F%E5%A1%AB%E5%85%85%E7%A9%BA%E7%99%BD%EF%BC%8C%E8%A3%85%E9%A5%B0%E6%88%90%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>滚动妥协填充空白，装饰成其他功能</h3>\n<p>在很多时候，我们可以不去解决这个问题，换思路。根据场景，我们可以将下拉作为一个功能性的操作。</p>\n<p>比如下拉后刷新页面</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-01-20-12-01-46-72b152555ca59af37680155ecd785250-dcb0e.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 614px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 31.27035830618893%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA90lEQVQY06XKy0rDQAAF0HGhHyCTLM043bnoZ5RU0I1+gAsVdCWtttbUJ4Lv7MQPE1HB1ge0TWxM4rynK2cqaHHr5XC5iwvoPwIol6MIE1zqTi++f3xqPb+2X95u7x6SNGdC/XkagH3E9Fs6ZMf7ZxJlcTfv9/J+N4s7JInoz20EUKcFfYLVMZJHnnXoCQsZ/MBj+0jsIb7rMWuaNTENEA1MYxJgIJeBXBrTG+O6Makbrt6Gqm44qubILWhtQlF1hlxRcXnFYWsTZBWQFQDSeRgVIV3H+mZRXS/osDQI/UE4q6/K6tI35Hn515kvL+Z4cybdKWS1qS+clwd2nR5FowAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 01 20 12 01 46"\n        title=""\n        src="/static/2020-01-20-12-01-46-72b152555ca59af37680155ecd785250-dcb0e.png"\n        srcset="/static/2020-01-20-12-01-46-72b152555ca59af37680155ecd785250-2d24e.png 200w,\n/static/2020-01-20-12-01-46-72b152555ca59af37680155ecd785250-fa3d3.png 400w,\n/static/2020-01-20-12-01-46-72b152555ca59af37680155ecd785250-dcb0e.png 614w"\n        sizes="(max-width: 614px) 100vw, 614px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1 id="页面放大或缩小不确定性行为"><a href="#%E9%A1%B5%E9%9D%A2%E6%94%BE%E5%A4%A7%E6%88%96%E7%BC%A9%E5%B0%8F%E4%B8%8D%E7%A1%AE%E5%AE%9A%E6%80%A7%E8%A1%8C%E4%B8%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面放大或缩小不确定性行为</h1>\n<h2 id="现象-6"><a href="#%E7%8E%B0%E8%B1%A1-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>双击或者双指张开手指页面元素，页面会放大或缩小。</p>\n<h2 id="产生原因-3"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>HTML 本身会产生放大或缩小的行为，比如在 PC 浏览器上，可以自由控制页面的放大缩小。但是在移动端，我们是不需要这个行为的。所以，我们需要禁止该不确定性行为，来提升用户体验。</p>\n<h2 id="解决方案-6"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<p>HTML meta 元标签标准中有个 viewport 属性，用来控制页面的缩放，一般用于移动端。</p>\n<p>移动端常用写法</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43497562561466240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; />`, `43497562561466240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                html 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>因此我们可以设置 maximum-scale、minimum-scale 与 user-scalable=no 用来避免这个问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28998971336183878000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<meta\n  name=&quot;viewport&quot;\n  content=&quot;width=device-width, initial-scale=1.0, minimum-scale=1.0 maximum-scale=1.0, user-scalable=no&quot;\n/>`, `28998971336183878000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                html 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>\n  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>\n  <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0, minimum-scale=1.0 maximum-scale=1.0, user-scalable=no<span class="token punctuation">"</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="click-点击事件延时与穿透"><a href="#click-%E7%82%B9%E5%87%BB%E4%BA%8B%E4%BB%B6%E5%BB%B6%E6%97%B6%E4%B8%8E%E7%A9%BF%E9%80%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>click 点击事件延时与穿透</h1>\n<h2 id="现象-7"><a href="#%E7%8E%B0%E8%B1%A1-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>监听元素 click 事件，点击元素触发时间延迟约 300ms。</p>\n<p>点击蒙层，蒙层消失后，下层元素点击触发。</p>\n<h2 id="产生原因-4"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<h3 id="点击延时"><a href="#%E7%82%B9%E5%87%BB%E5%BB%B6%E6%97%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>点击延时</h3>\n<p>iOS 中的 safari，为了实现双击缩放操作，在单击 300ms 之后，如果未进行第二次点击，则执行 click 单击操作。也就是说来判断用户行为是否为双击产生的。但是，在 App 中，无论是否需要双击缩放这种行为，click 单击都会产生 300ms 延迟。</p>\n<h3 id="点击穿透"><a href="#%E7%82%B9%E5%87%BB%E7%A9%BF%E9%80%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>点击穿透</h3>\n<p>双层元素叠加时，在上层元素上绑定 touch 事件，下层元素绑定 click 事件。由于 click 发生在 touch 之后，点击上层元素，元素消失，下层元素会触发 click 事件，由此产生了点击穿透的效果。</p>\n<h2 id="解决方案-7"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="使用-touchstart-替换-click"><a href="#%E4%BD%BF%E7%94%A8-touchstart-%E6%9B%BF%E6%8D%A2-click" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 touchstart 替换 click</h3>\n<p>移动设备不仅支持点击，还支持几个触摸事件。那么我们现在基本思路就是用 touch 事件代替 click 事件。将 click 替换成 touchstart 不仅解决了 click 事件都延时问题，还解决了穿透问题。因为穿透问题是在 touch 和 click 混用时产生。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58633789603460090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`el.addEventListener(\n  \'touchstart\',\n  () => {\n    console.log(\'ok\');\n  },\n  false\n);`, `58633789603460090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>\n  <span class="token string">\'touchstart\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'ok\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token boolean">false</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么，是否可以将 click 事件全部替换成 touchstart 呢？为什么开源框架还会给出 click 事件呢？</p>\n<p>我们想象一种情景，同时需要点击和滑动的场景下。如果将 click 替换成 touchstart 会怎样？</p>\n<blockquote>\n<p>事件触发顺序: touchstart, touchmove, touchend, click。</p>\n</blockquote>\n<p>很容易想象，在我需要 touchmove 滑动时候，优先触发了 touchstart 的点击事件，是不是已经产生了冲突呢？</p>\n<p>所以呢，在具有滚动的情况下，还是建议使用 click 处理。</p>\n<p>在接下来的 fastclick 开源库中也做了如下处理。 针对 touchstart 和 touchend，截取了部分源码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11189942749483573000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// If the target element is a child of a scrollable layer (using -webkit-overflow-scrolling: touch) and:\n// 1) the user does a fling scroll on the scrollable layer\n// 2) the user stops the fling scroll with another tap\n// then the event.target of the last \'touchend\' event will be the element that was under the user\'s finger\n// when the fling scroll was started, causing FastClick to send a click event to that layer - unless a check\n// is made to ensure that a parent layer was not scrolled before sending a synthetic click (issue #42).\nthis.updateScrollParent(targetElement);`, `11189942749483573000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// If the target element is a child of a scrollable layer (using -webkit-overflow-scrolling: touch) and:</span>\n<span class="token comment">// 1) the user does a fling scroll on the scrollable layer</span>\n<span class="token comment">// 2) the user stops the fling scroll with another tap</span>\n<span class="token comment">// then the event.target of the last \'touchend\' event will be the element that was under the user\'s finger</span>\n<span class="token comment">// when the fling scroll was started, causing FastClick to send a click event to that layer - unless a check</span>\n<span class="token comment">// is made to ensure that a parent layer was not scrolled before sending a synthetic click (issue #42).</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateScrollParent</span><span class="token punctuation">(</span>targetElement<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="263118334609235840"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Don\'t send a synthetic click event if the target element is contained within a parent layer that was scrolled\n// and this tap is being used to stop the scrolling (usually initiated by a fling - issue #42).\nscrollParent = targetElement.fastClickScrollParent;\nif (scrollParent && scrollParent.fastClickLastScrollTop !== scrollParent.scrollTop) {\n  return true;\n}`, `263118334609235840`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Don\'t send a synthetic click event if the target element is contained within a parent layer that was scrolled</span>\n<span class="token comment">// and this tap is being used to stop the scrolling (usually initiated by a fling - issue #42).</span>\nscrollParent <span class="token operator">=</span> targetElement<span class="token punctuation">.</span>fastClickScrollParent<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>scrollParent <span class="token operator">&amp;&amp;</span> scrollParent<span class="token punctuation">.</span>fastClickLastScrollTop <span class="token operator">!==</span> scrollParent<span class="token punctuation">.</span>scrollTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>主要目的就是，在使用 touchstart 合成 click 事件时，保证其不在滚动的父元素之下。</p>\n<h3 id="使用-fastclick-库"><a href="#%E4%BD%BF%E7%94%A8-fastclick-%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 fastclick 库</h3>\n<p>使用 npm/yarn 安装后使用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10217764575669830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import FastClick from \'fastclick\';\nFastClick.attach(document.body, options);`, `10217764575669830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> FastClick <span class="token keyword">from</span> <span class="token string">\'fastclick\'</span><span class="token punctuation">;</span>\nFastClick<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>同样，使用 fastclick 库后，click 延时和穿透问题都没了</p>\n<h1 id="iphone-x-系列安全区域适配问题"><a href="#iphone-x-%E7%B3%BB%E5%88%97%E5%AE%89%E5%85%A8%E5%8C%BA%E5%9F%9F%E9%80%82%E9%85%8D%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>iPhone X 系列安全区域适配问题</h1>\n<h2 id="现象-8"><a href="#%E7%8E%B0%E8%B1%A1-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>头部刘海两侧区域或者底部区域，出现刘海遮挡文字，或者呈现黑底或白底空白区域。</p>\n<h2 id="产生原因-5"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<p>iPhone X 以及它以上的系列，都采用刘海屏设计和全面屏手势。头部、底部、侧边都需要做特殊处理。才能适配 iPhone X 的特殊情况。</p>\n<h2 id="解决方案-8"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="设置安全区域"><a href="#%E8%AE%BE%E7%BD%AE%E5%AE%89%E5%85%A8%E5%8C%BA%E5%9F%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置安全区域</h3>\n<p>设置安全区域，填充危险区域，危险区域不做操作和内容展示。</p>\n<blockquote>\n<p>危险区域指头部不规则区域，底部横条区域，左右触发区域。</p>\n</blockquote>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-01-20-15-07-08-ee372196cc2e9b0a7e7613d77ed7904b-b1028.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 622px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 55.30546623794211%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABe0lEQVQoz42SyW7CMBCG8/7vUygEaC8tm8Sh9EJVkTjEjvclQRA7VOokLK2EKnXyaw5jf54tUWkdmDFGa+2s3VdVaJrwP4syhGdYTgv1WqhFxgUVzek33LRv3Su0d6Jtkg+RGGI1IHqcMFbwE8C+5WoP3zHUR39sfajrmzzI+2i73Y0yMcIqJvopZQWmzRluglN6ndE55vOcLYm4aU7Eesc0l1Ga4hYm+gzzQpy+TpDWB19K/ZLQPtEDDFJnDzX2sJoioSmPECIA9z7zXkImKaOEWWerdmwBjmcpjbGaQF0Zf/hA4Ccdv0D8AseZiHMZYwkwpwKwGloKodL2JWGPxAyxHuZqsBOD9prqYzXLhGHiAp97BphB2deBGak3OX0rxLrgK4SXyW6VkXcq1lRuMBOUXTNDMR3MO9h38OFwKKEFZ8GX1krOK+f2ZQkqnYPTdmATxMdYgp4TysjPqprrVsEgUFaV76LXVYfIKKOsIxxSSmUgg/vrD2vu4t9hu13UN8it5AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 01 20 15 07 08"\n        title=""\n        src="/static/2020-01-20-15-07-08-ee372196cc2e9b0a7e7613d77ed7904b-b1028.png"\n        srcset="/static/2020-01-20-15-07-08-ee372196cc2e9b0a7e7613d77ed7904b-2de4f.png 200w,\n/static/2020-01-20-15-07-08-ee372196cc2e9b0a7e7613d77ed7904b-73fe9.png 400w,\n/static/2020-01-20-15-07-08-ee372196cc2e9b0a7e7613d77ed7904b-b1028.png 622w"\n        sizes="(max-width: 622px) 100vw, 622px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>具体操作为：viewport-fit meta 标签设置为 cover，获取所有区域填充。 判断设备是否属于 iPhone X，给头部底部增加适配层</p>\n<p>viewport-fit 有 3 个值分别为：</p>\n<ul>\n<li>auto：此值不影响初始布局视图端口，并且整个 web 页面都是可查看的。</li>\n<li>contain：视图端口按比例缩放，以适合显示内嵌的最大矩形。</li>\n<li>cover：视图端口被缩放以填充设备显示。强烈建议使用 safe-area-inset 变量，以确保重要内容不会出现在显示之外。</li>\n</ul>\n<h4 id="设置-viewport-fit-为-cover"><a href="#%E8%AE%BE%E7%BD%AE-viewport-fit-%E4%B8%BA-cover" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置 viewport-fit 为 cover</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99547327571641040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover&quot; />`, `99547327571641040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                html 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="增加适配层"><a href="#%E5%A2%9E%E5%8A%A0%E9%80%82%E9%85%8D%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>增加适配层</h4>\n<p>使用 safe-area-inset 变量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59703150854242920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* 适配 iPhone X 顶部填充*/\n@supports (top: env(safe-area-inset-top)) {\n  body,\n  .header {\n    padding-top: constant(safe-area-inset-top, 40px);\n    padding-top: env(safe-area-inset-top, 40px);\n    padding-top: var(safe-area-inset-top, 40px);\n  }\n}\n\n/* 判断 iPhoneX 将 footer 的 padding-bottom 填充到最底部 */\n@supports (bottom: env(safe-area-inset-bottom)) {\n  body,\n  .footer {\n    padding-bottom: constant(safe-area-inset-bottom, 20px);\n    padding-bottom: env(safe-area-inset-bottom, 20px);\n    padding-top: var(safe-area-inset-bottom, 20px);\n  }\n}`, `59703150854242920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                css 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* 适配 iPhone X 顶部填充*/</span>\n<span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token property">top</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">)</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n  <span class="token selector">body,\n  .header</span> <span class="token punctuation">{</span>\n    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">,</span> 40px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">,</span> 40px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">,</span> 40px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/* 判断 iPhoneX 将 footer 的 padding-bottom 填充到最底部 */</span>\n<span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token property">bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>\n  <span class="token selector">body,\n  .footer</span> <span class="token punctuation">{</span>\n    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">,</span> 20px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">,</span> 20px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">,</span> 20px<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>safe-area-inset-top, safe-area-inset-right, safe-area-inset-bottom, safe-area-inset-left, safe-area-inset-*由四个定义了视口边缘内矩形的 top, right, bottom 和 left 的环境变量组成，这样可以安全地放入内容，而不会有被非矩形的显示切断的风险。对于矩形视口，例如普通的笔记本电脑显示器，其值等于零。 对于非矩形显示器（如圆形表盘，iPhoneX 屏幕），在用户代理设置的四个值形成的矩形内，所有内容均可见。</p>\n</blockquote>\n<p>其中 env() 用法为 <code class="language-text">env( &lt;custom-ident&gt; , &lt;declaration-value&gt;? )</code>，第一个参数为自定义的区域，第二个为备用值。</p>\n<p>其中 var() 用法为 <code class="language-text">var( &lt;custom-property-name&gt; , &lt;declaration-value&gt;? )</code>，作用是在 env() 不生效的情况下，给出一个备用值。</p>\n<p><code class="language-text">constant()</code> 被 css 2017-2018 年为草稿阶段，是否已被标准化未知。而其他 iOS 浏览器版本中是否有此函数未知，作为兼容处理而添加进去。</p>\n<h1 id="页面生成为图片和二维码问题"><a href="#%E9%A1%B5%E9%9D%A2%E7%94%9F%E6%88%90%E4%B8%BA%E5%9B%BE%E7%89%87%E5%92%8C%E4%BA%8C%E7%BB%B4%E7%A0%81%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面生成为图片和二维码问题</h1>\n<h2 id="现象-9"><a href="#%E7%8E%B0%E8%B1%A1-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>在工作中有需要将页面生成图片或者二维码的需求。可能我们第一想到的，交给后端来生成更简单。但是这样我们需要把页面代码全部传给后端，网络性能消耗太大。</p>\n<h2 id="解决方案-9"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="生成二维码"><a href="#%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成二维码</h3>\n<p>使用 QRCode 生成二维码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27782798579721458000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import QRCode from \'qrcode\';\n// 使用 async 生成图片\nconst options = {};\nconst url = window.location.href;\nasync (url) => {\n  try {\n    console.log(await QRCode.toDataURL(url, options));\n  } catch (err) {\n    console.error(err);\n  }\n};`, `27782798579721458000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> QRCode <span class="token keyword">from</span> <span class="token string">\'qrcode\'</span><span class="token punctuation">;</span>\n<span class="token comment">// 使用 async 生成图片</span>\n<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">;</span>\n<span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> QRCode<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将 await QRCode.toDataURL(url, options) 赋值给 图片 url 即可</p>\n<h3 id="生成图片"><a href="#%E7%94%9F%E6%88%90%E5%9B%BE%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成图片</h3>\n<p>主要是使用 htmlToCanvas 生成 canvas 画布</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28367594736697123000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import html2canvas from \'html2canvas\';\n\nhtml2canvas(document.body).then(function(canvas) {\n  document.body.appendChild(canvas);\n});`, `28367594736697123000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> html2canvas <span class="token keyword">from</span> <span class="token string">\'html2canvas\'</span><span class="token punctuation">;</span>\n\n<span class="token function">html2canvas</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是不单单在此处就完了，由于是 canvas 的原因。移动端生成出来的图片比较模糊。</p>\n<p>我们使用一个新的 canvas 方法多倍生成，放入一倍容器里面，达到更加清晰的效果，通过超链接下载图片</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99998664587975790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const scaleSize = 2;\nconst newCanvas = document.createElement(&quot;canvas&quot;);\nconst target = document.querySelector(\'div\');\nconst width = parseInt(window.getComputedStyle(target).width);\nconst height = parseInt(window.getComputedStyle(target).height);\nnewCanvas.width = width * scaleSize;\nnewCanvas.height = widthh * scaleSize;\nnewCanvas.style.width = width + &quot;px&quot;;\nnewCanvas.style.height = width + &quot;px&quot;;\nconst context = newCanvas.getContext(&quot;2d&quot;);\ncontext.scale(scaleSize, scaleSize);\nhtml2canvas(document.querySelector(\'.demo\'), { canvas: newCanvas }).then(function(canvas) {\n  // 简单的通过超链接设置下载功能\n  document.querySelector(&quot;.btn&quot;).setAttribute(\'href\', canvas.toDataURL());\n}`, `99998664587975790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> scaleSize <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> newCanvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> target <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'div\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getComputedStyle</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> height <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">getComputedStyle</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>\nnewCanvas<span class="token punctuation">.</span>width <span class="token operator">=</span> width <span class="token operator">*</span> scaleSize<span class="token punctuation">;</span>\nnewCanvas<span class="token punctuation">.</span>height <span class="token operator">=</span> widthh <span class="token operator">*</span> scaleSize<span class="token punctuation">;</span>\nnewCanvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> width <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>\nnewCanvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> width <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> context <span class="token operator">=</span> newCanvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ncontext<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>scaleSize<span class="token punctuation">,</span> scaleSize<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">html2canvas</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'.demo\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> canvas<span class="token punctuation">:</span> newCanvas <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">canvas</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 简单的通过超链接设置下载功能</span>\n  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".btn"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">\'href\'</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>根据需要设置 scaleSize 大小</p>\n</blockquote>\n<h1 id="微信公众号分享问题"><a href="#%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%88%86%E4%BA%AB%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微信公众号分享问题</h1>\n<h2 id="现象-10"><a href="#%E7%8E%B0%E8%B1%A1-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>在微信公众号 H5 开发中，页面内部点击分享按钮调用 SDK，方法不生效。</p>\n<h2 id="解决方案-10"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="添加一层蒙层做分享引导"><a href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E5%B1%82%E8%92%99%E5%B1%82%E5%81%9A%E5%88%86%E4%BA%AB%E5%BC%95%E5%AF%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>添加一层蒙层做分享引导</h3>\n<p>因为页面内部点击分享按钮无法直接调用，而分享功能需要点击右上角更多来操作。</p>\n<p>然后用户可能不知道通过右上角小标里面的功能分享。又想引导用户分享，这时应该怎么做呢？</p>\n<p>技术无法实现的，从产品出发。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-01-20-15-30-58-974c088ad0c258bc1e783936f06b98e0-48439.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 325px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 58.46153846153847%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACtklEQVQoz2O4devWnTt3/vz5/fPHjy8w8PXrVyD5+fNnCPfVq1e3b9++efMmUPHly5eB6q9du7Z7926GT58+vf/w/tLlq/fuP/z48RMcfPn8BWTC589A9ocPHz4i5IDMDyCZT58YHj1+8vz5q0VL1/RPnj1t5qKeCbM6e6d39Ezr6p0+Zcb8Fy9f//7z7/uP399//v7+4ycY/fr58zfQ8Ddv3jE8uHvz4d0b925fvnnt/KnjB7du3jBn1qwpEyfNnTVr/+6dd29eevLgxsO71x7du/74we3H9+HoFpBkyI/TKk0zqSmNAKL6ipjG6qTmmuTm2pTmmqT6yoTqkqjKwoiqoqiKHO+SJL3yVL3yNL2yVJ2yVN3ydB2GWCejWEejBFf7ODe7aFfraCfLcAfTMHvjCEeTWDeLOC/rOC/bJD+nZD+nBDfjFC+TWHud2rTwutSIOBttBlvxWE/tdHfNVHfNFHetZHetVA/tFA+dZBflBFPuKFOuaDCKNOGMMuOONuGMNBONDLDL9TDLMFOMZHCQiPM1yvYxyPTRz/Q2zPY2yAEyfA2zPTXTzDhjzDjjzLhigaQpR2ygVpGzXJpKUJhzU6ZWdohOQQSDKWeMMVu0MVuUMWuUEUekBW+EBU+EBW+kJW+0vWiYg2QICEkAGaExVrmB2rl2Dkm6DhFyhv6KJoEM5ryx5nxx5gIxJsLR1kKRbsqBvto+bkp+7kq+0Q6exZGWBUHW+SE2xVHODSleuaExbnJJVhxRdlzh1pzRDGY8seZcsaZC0YaSMVZ84SFGsSmeMRneaZEW0Wl+ERPLQzpzgzqzA9qy/JtTHRLcXA3Yos154mz5w635wkGaQYg3yoIrxoonMkAnNtIyI94pO1A/MdoqPss/Kd0nKd03Mc03MTMg0Uc7zJQ73II71pw33kIgBgAEOVdfe6TtgQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 01 20 15 30 58"\n        title=""\n        src="/static/2020-01-20-15-30-58-974c088ad0c258bc1e783936f06b98e0-48439.png"\n        srcset="/static/2020-01-20-15-30-58-974c088ad0c258bc1e783936f06b98e0-39b9b.png 200w,\n/static/2020-01-20-15-30-58-974c088ad0c258bc1e783936f06b98e0-48439.png 325w"\n        sizes="(max-width: 325px) 100vw, 325px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<hr>\n<p>更新于 <code class="language-text">2020-1-20 11:27:54</code></p>\n<h1 id="第三方-cookie-失效"><a href="#%E7%AC%AC%E4%B8%89%E6%96%B9-cookie-%E5%A4%B1%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第三方 cookie 失效</h1>\n<h2 id="现象-11"><a href="#%E7%8E%B0%E8%B1%A1-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>现象</h2>\n<p>第三方 cookie 在苹果浏览器失效，在 windows 最新版本的 chrome（版本号：80.0.3987.132）也有这个问题</p>\n<h2 id="产生原因-6"><a href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>产生原因</h2>\n<h3 id="苹果浏览器"><a href="#%E8%8B%B9%E6%9E%9C%E6%B5%8F%E8%A7%88%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>苹果浏览器</h3>\n<p>在苹果浏览器失效是由于默认开启阻止跨站跟踪导致的，具体表现为最新的 IOS 系统下的 safari，chrome 都有这个问题</p>\n<h3 id="谷歌浏览器"><a href="#%E8%B0%B7%E6%AD%8C%E6%B5%8F%E8%A7%88%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>谷歌浏览器</h3>\n<p>至于最新版本的 chrome 是由于默认开启了 SameSite: Lax</p>\n<blockquote>\n<p>Chrome 计划将 Lax 变为默认设置。这时网站可以选择显式关闭 SameSite 属性，将其设为 None。不过前提是必须同时设置 Secure 属性（Cookie 只能通过 HTTPS 协议发送），否则无效。</p>\n</blockquote>\n<p>下面的设置无效：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5125327795002743000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Set-Cookie: widget_session=abc123; SameSite=None`, `5125327795002743000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Set-Cookie: widget_session=abc123; SameSite=None</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>下面的设置有效：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31794944616439103000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Set-Cookie: widget_session=abc123; SameSite=None; Secure`, `31794944616439103000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Set-Cookie: widget_session=abc123; SameSite=None; Secure</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>相同二级域名的子域名下是没有 SameSite 的限制的，举例来说 www.web.dev 和 static.web.dev 之间就没有限制，注意跨站与跨域的区别</p>\n<p>具体可查看 <a href="https://juejin.im/post/5e7097b4518825496452cef9?utm_source=gold_browser_extension" target="_blank" rel="nofollow noreferrer noopener">当 CORS 遇到 SameSite</a></p>\n<p>不过经过具体实践，即使设置了也没有用，有可能是我们公司后台的 flask 版本过低，设置 SameSite 没什么效果</p>\n<p><a href="https://stackoverflow.com/questions/56828663/how-to-explicitly-set-samesite-none-on-a-flask-response" target="_blank" rel="nofollow noreferrer noopener">如何在 flask 中显式设置 samesite = None</a></p>\n<h2 id="解决方案-11"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h2>\n<h3 id="手动关闭"><a href="#%E6%89%8B%E5%8A%A8%E5%85%B3%E9%97%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>手动关闭</h3>\n<p>用户手动关闭阻止跨站跟踪或者 SameSite 限制，并在产品上予以提示</p>\n<h3 id="重定向页面"><a href="#%E9%87%8D%E5%AE%9A%E5%90%91%E9%A1%B5%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重定向页面</h3>\n<p>重定向到第三方域中托管的登录页面，授权后返回到原始页面或者直接打开新窗口展示，不过这样会造成用户体验不佳</p>\n<h3 id="存储到-localstorage"><a href="#%E5%AD%98%E5%82%A8%E5%88%B0-localstorage" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>存储到 localstorage</h3>\n<p>后端接口明确返回 token 相关信息保存到 localstorage 中，并在下次判断 localstorage 有相关 token 信息时，在全局方法中随请求发出，不过有被 xss（跨站脚本攻击）的风险</p>',
id:"/github/workspace/blog/移动端适配汇总/index.md absPath of file >>> MarkdownRemark",timeToRead:15,frontmatter:{date:"2020-03-16 17:47:42",path:"/mobile-adaptation-summary/",tags:"前端, 移动端, 兼容性, 预研",title:"移动端适配汇总",draft:null}},{excerpt:"需求 现在我们可以比较值了，是时候在我们的语言中添加 IF 语句了，因此让我们看一下 IF 语句的一般语法以及如何将它们转换为汇编语言。 准备 IF 语法 IF 语句的语法为： 通常如何将其转换为汇编语言？事实证明如果相反的比较成立，我们将执行相反的比较并跳转： 其中 L1 和 L2 是汇编语言标签。 在我们的编译器中生成程序集 现在我们输出代码以基于比较来设置寄存器，例如 变成 但是对于 IF 语句，我们需要进行相反的比较： 应该变成： 因此在这一部分中，我已经实现了 IF…",html:'<h1 id="需求"><a href="#%E9%9C%80%E6%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求</h1>\n<p>现在我们可以比较值了，是时候在我们的语言中添加 IF 语句了，因此让我们看一下 IF 语句的一般语法以及如何将它们转换为汇编语言。</p>\n<h1 id="准备"><a href="#%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>准备</h1>\n<h2 id="if-语法"><a href="#if-%E8%AF%AD%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IF 语法</h2>\n<p>IF 语句的语法为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82584340017742600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (condition is true)\n  perform this first block of code\nelse\n  perform this other block of code`, `82584340017742600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">if (condition is true)\n  perform this first block of code\nelse\n  perform this other block of code</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通常如何将其转换为汇编语言？事实证明如果相反的比较成立，我们将执行相反的比较并跳转：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8914586978100747000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`       perform the opposite comparison\n       jump to L1 if true\n       perform the first block of code\n       jump to L2\nL1:\n       perform the other block of code\nL2:`, `8914586978100747000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">       perform the opposite comparison\n       jump to L1 if true\n       perform the first block of code\n       jump to L2\nL1:\n       perform the other block of code\nL2:</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 L1 和 L2 是汇编语言标签。</p>\n<h2 id="在我们的编译器中生成程序集"><a href="#%E5%9C%A8%E6%88%91%E4%BB%AC%E7%9A%84%E7%BC%96%E8%AF%91%E5%99%A8%E4%B8%AD%E7%94%9F%E6%88%90%E7%A8%8B%E5%BA%8F%E9%9B%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在我们的编译器中生成程序集</h2>\n<p>现在我们输出代码以基于比较来设置寄存器，例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19306767620658217000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int x; x= 7 < 9;         From input04`, `19306767620658217000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">int</span> x<span class="token punctuation">;</span> x<span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>         From input04</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>变成</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60607809005980820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`movq    \\$7, %r8\nmovq    \\$9, %r9\ncmpq    %r9, %r8\nsetl    %r9b        Set if less than\nandq    \\$255,%r9`, `60607809005980820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">movq    $7, %r8\nmovq    $9, %r9\ncmpq    %r9, %r8\nsetl    %r9b        Set if less than\nandq    $255,%r9</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是对于 IF 语句，我们需要进行相反的比较：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31978069903381746000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (7 < 9)`, `31978069903381746000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>应该变成：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23895102584565064000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`        movq    \\$7, %r8\n        movq    \\$9, %r9\n        cmpq    %r9, %r8\n        jge     L1         Jump if greater then or equal to\n        ....\nL1:`, `23895102584565064000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">        movq    $7, %r8\n        movq    $9, %r9\n        cmpq    %r9, %r8\n        jge     L1         Jump if greater then or equal to\n        ....\nL1:</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因此在这一部分中，我已经实现了 IF 语句。作为旅程的一部分，由于这是一个正在工作的项目，因此我确实必须撤消一些操作并将其重构。在此过程中，我将尝试介绍所做的更改以及添加的内容。</p>\n<h2 id="新元素和其他悬空元素"><a href="#%E6%96%B0%E5%85%83%E7%B4%A0%E5%92%8C%E5%85%B6%E4%BB%96%E6%82%AC%E7%A9%BA%E5%85%83%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新元素和其他悬空元素</h2>\n<p>我们将需要使用我们的语言的一堆新元素，我暂时也想避免其他问题。为此我更改了语法，以便所有语句组都用 <code class="language-text">{...}</code> 大括号括起来；我称这种分组为 <code class="language-text">复合语句</code>。我们还需要使用括号 <code class="language-text">(...)</code> 来容纳 IF 表达式以及关键字 if 和 else，因此新元素为（defs.h 中的代码）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52565525758052024000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`T_LBRACE, T_RBRACE, T_LPAREN, T_RPAREN,\n// Keywords\n..., T_IF, T_ELSE`, `52565525758052024000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">T_LBRACE, T_RBRACE, T_LPAREN, T_RPAREN,\n// Keywords\n..., T_IF, T_ELSE</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="核心逻辑"><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心逻辑</h1>\n<h2 id="扫描令牌"><a href="#%E6%89%AB%E6%8F%8F%E4%BB%A4%E7%89%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>扫描令牌</h2>\n<p>单字符元素应该很明显，我不会给出扫描它们的代码。关键字也应该是很明显的，但我会从 scan.c 中给出扫描代码 keyword()：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58503337678132120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`switch (*s) {\n  case \'e\':\n    if (!strcmp(s, &quot;else&quot;))\n      return (T_ELSE);\n    break;\n  case \'i\':\n    if (!strcmp(s, &quot;if&quot;))\n      return (T_IF);\n    if (!strcmp(s, &quot;int&quot;))\n      return (T_INT);\n    break;\n  case \'p\':\n    if (!strcmp(s, &quot;print&quot;))\n      return (T_PRINT);\n    break;\n}`, `58503337678132120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">case</span> <span class="token string">\'e\'</span><span class="token operator">:</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"else"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>T_ELSE<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token keyword">case</span> <span class="token string">\'i\'</span><span class="token operator">:</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"if"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>T_IF<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"int"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>T_INT<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token keyword">case</span> <span class="token string">\'p\'</span><span class="token operator">:</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"print"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>T_PRINT<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">break</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="新的-bnf-语法"><a href="#%E6%96%B0%E7%9A%84-bnf-%E8%AF%AD%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新的 BNF 语法</h2>\n<p>我们的语法开始变得越来越大，因此我对其进行了一些重写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46063201466073550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`compound_statement: \'{\' \'}\'          // empty, i.e. no statement\n    |      \'{\' statement \'}\'\n    |      \'{\' statement statements \'}\'\n    ;\n\nstatement: print_statement\n    |     declaration\n    |     assignment_statement\n    |     if_statement\n    ;\n\nprint_statement: \'print\' expression \';\'  ;\n\ndeclaration: \'int\' identifier \';\'  ;\n\nassignment_statement: identifier \'=\' expression \';\'   ;\n\nif_statement: if_head\n    |        if_head \'else\' compound_statement\n    ;\n\nif_head: \'if\' \'(\' true_false_expression \')\' compound_statement  ;\n\nidentifier: T_IDENT ;`, `46063201466073550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">compound_statement: &#39;{&#39; &#39;}&#39;          // empty, i.e. no statement\n    |      &#39;{&#39; statement &#39;}&#39;\n    |      &#39;{&#39; statement statements &#39;}&#39;\n    ;\n\nstatement: print_statement\n    |     declaration\n    |     assignment_statement\n    |     if_statement\n    ;\n\nprint_statement: &#39;print&#39; expression &#39;;&#39;  ;\n\ndeclaration: &#39;int&#39; identifier &#39;;&#39;  ;\n\nassignment_statement: identifier &#39;=&#39; expression &#39;;&#39;   ;\n\nif_statement: if_head\n    |        if_head &#39;else&#39; compound_statement\n    ;\n\nif_head: &#39;if&#39; &#39;(&#39; true_false_expression &#39;)&#39; compound_statement  ;\n\nidentifier: T_IDENT ;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我省略了定义 true<em>false</em>expression，但是在某些时候我们添加了更多运算符时我会添加它。</p>\n<p>请注意 IF 语句的语法：它是 if<em>head（没有 else 子句），或 if</em>head 后跟 else 和 a compound_statement。</p>\n<p>我已经分离出所有不同的语句类型以拥有自己的非终端名称，而且以前的 statements 非终结点现在 compound_statement 是非终结点，这要求在语句周围使用 <code class="language-text">{...}</code>。</p>\n<p>这意味着 compound<em>statement 头部中的被 <code class="language-text">{...}</code> 包围，compound</em>statement else 关键字之后的任何字符也被包围。因此如果我们嵌套了 IF 语句，它们必须看起来像：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23075909474991006000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (condition1 is true) {\n  if (condition2 is true) {\n    statements;\n  } else {\n    statements;\n  }\n} else {\n  statements;\n}`, `23075909474991006000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>condition1 is true<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>condition2 is true<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    statements<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    statements<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  statements<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并且每个 else 属于哪个 if 没有任何歧义，这解决了悬而未决的问题，稍后我将使 <code class="language-text">{...}</code> 为可选。</p>\n<h2 id="解析复合语句"><a href="#%E8%A7%A3%E6%9E%90%E5%A4%8D%E5%90%88%E8%AF%AD%E5%8F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解析复合语句</h2>\n<p>现在的旧 void statements() 函数 compound_statement() 如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36966798978605195000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Parse a compound statement\n// and return its AST\nstruct ASTnode *compound_statement(void) {\n  struct ASTnode *left = NULL;\n  struct ASTnode *tree;\n\n  // Require a left curly bracket\n  lbrace();\n\n  while (1) {\n    switch (Token.token) {\n      case T_PRINT:\n        tree = print_statement();\n        break;\n      case T_INT:\n        var_declaration();\n        tree = NULL;            // No AST generated here\n        break;\n      case T_IDENT:\n        tree = assignment_statement();\n        break;\n      case T_IF:\n        tree = if_statement();\n        break;\n    case T_RBRACE:\n        // When we hit a right curly bracket,\n        // skip past it and return the AST\n        rbrace();\n        return (left);\n      default:\n        fatald(&quot;Syntax error, token&quot;, Token.token);\n    }\n\n    // For each new tree, either save it in left\n    // if left is empty, or glue the left and the\n    // new tree together\n    if (tree) {\n      if (left == NULL)\n        left = tree;\n      else\n        left = mkastnode(A_GLUE, left, NULL, tree, 0);\n    }\n  }`, `36966798978605195000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Parse a compound statement</span>\n<span class="token comment">// and return its AST</span>\n<span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span><span class="token function">compound_statement</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>left <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>tree<span class="token punctuation">;</span>\n\n  <span class="token comment">// Require a left curly bracket</span>\n  <span class="token function">lbrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Token<span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">case</span> T_PRINT<span class="token operator">:</span>\n        tree <span class="token operator">=</span> <span class="token function">print_statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">case</span> T_INT<span class="token operator">:</span>\n        <span class="token function">var_declaration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        tree <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>            <span class="token comment">// No AST generated here</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">case</span> T_IDENT<span class="token operator">:</span>\n        tree <span class="token operator">=</span> <span class="token function">assignment_statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">case</span> T_IF<span class="token operator">:</span>\n        tree <span class="token operator">=</span> <span class="token function">if_statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> T_RBRACE<span class="token operator">:</span>\n        <span class="token comment">// When we hit a right curly bracket,</span>\n        <span class="token comment">// skip past it and return the AST</span>\n        <span class="token function">rbrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">default</span><span class="token operator">:</span>\n        <span class="token function">fatald</span><span class="token punctuation">(</span><span class="token string">"Syntax error, token"</span><span class="token punctuation">,</span> Token<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// For each new tree, either save it in left</span>\n    <span class="token comment">// if left is empty, or glue the left and the</span>\n    <span class="token comment">// new tree together</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>\n        left <span class="token operator">=</span> tree<span class="token punctuation">;</span>\n      <span class="token keyword">else</span>\n        left <span class="token operator">=</span> <span class="token function">mkastnode</span><span class="token punctuation">(</span>A_GLUE<span class="token punctuation">,</span> left<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> tree<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>首先请注意代码强制解析器在复合语句的开头与 lbrace() 匹配，而我们仅在将结尾的 <code class="language-text">}</code> 与匹配时退出 rbrace()。</p>\n<p>其次请注意 print<em>statement()、assignment</em>statement() 和 if<em>statement() 一样都返回 AST 树 compound</em>statement()。在我们的旧代码中，print<em>statement() 本身调用 genAST() 来求值表达式然后调用 genprintint()，类似地 assignment</em>statement() 也调用 genAST() 来执行赋值。</p>\n<p>这意味着我们在这里有 AST 树，在那儿还有其他树。只生成一个 AST 树，并调用 genAST() 一次性为其生成汇编代码是有意义的。</p>\n<p>这不是强制性的，例如 SubC 只为表达式生成 AST，对于语言的结构部分（如语句），SubC 像在以前版本的编译器中一样，对代码生成器进行特定的调用。</p>\n<p>我现在决定使用解析器为整个输入生成一个 AST 树，解析输入后就可以从一棵 AST 树中生成程序集输出。</p>\n<p>稍后我可能会为每个函数生成一个 AST 树。</p>\n<h2 id="解析-if-语法"><a href="#%E8%A7%A3%E6%9E%90-if-%E8%AF%AD%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解析 IF 语法</h2>\n<p>因为我们是递归下降解析器，所以解析 IF 语句还不错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70986696118326890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Parse an IF statement including\n// any optional ELSE clause\n// and return its AST\nstruct ASTnode *if_statement(void) {\n  struct ASTnode *condAST, *trueAST, *falseAST = NULL;\n\n  // Ensure we have \'if\' \'(\'\n  match(T_IF, &quot;if&quot;);\n  lparen();\n\n  // Parse the following expression\n  // and the \')\' following. Ensure\n  // the tree\'s operation is a comparison.\n  condAST = binexpr(0);\n\n  if (condAST->op < A_EQ || condAST->op > A_GE)\n    fatal(&quot;Bad comparison operator&quot;);\n  rparen();\n\n  // Get the AST for the compound statement\n  trueAST = compound_statement();\n\n  // If we have an \'else\', skip it\n  // and get the AST for the compound statement\n  if (Token.token == T_ELSE) {\n    scan(&Token);\n    falseAST = compound_statement();\n  }\n  // Build and return the AST for this statement\n  return (mkastnode(A_IF, condAST, trueAST, falseAST, 0));\n}`, `70986696118326890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Parse an IF statement including</span>\n<span class="token comment">// any optional ELSE clause</span>\n<span class="token comment">// and return its AST</span>\n<span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span><span class="token function">if_statement</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>condAST<span class="token punctuation">,</span> <span class="token operator">*</span>trueAST<span class="token punctuation">,</span> <span class="token operator">*</span>falseAST <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Ensure we have \'if\' \'(\'</span>\n  <span class="token function">match</span><span class="token punctuation">(</span>T_IF<span class="token punctuation">,</span> <span class="token string">"if"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">lparen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Parse the following expression</span>\n  <span class="token comment">// and the \')\' following. Ensure</span>\n  <span class="token comment">// the tree\'s operation is a comparison.</span>\n  condAST <span class="token operator">=</span> <span class="token function">binexpr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>condAST<span class="token operator">-></span>op <span class="token operator">&lt;</span> A_EQ <span class="token operator">||</span> condAST<span class="token operator">-></span>op <span class="token operator">></span> A_GE<span class="token punctuation">)</span>\n    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"Bad comparison operator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">rparen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Get the AST for the compound statement</span>\n  trueAST <span class="token operator">=</span> <span class="token function">compound_statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// If we have an \'else\', skip it</span>\n  <span class="token comment">// and get the AST for the compound statement</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Token<span class="token punctuation">.</span>token <span class="token operator">==</span> T_ELSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    falseAST <span class="token operator">=</span> <span class="token function">compound_statement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// Build and return the AST for this statement</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">mkastnode</span><span class="token punctuation">(</span>A_IF<span class="token punctuation">,</span> condAST<span class="token punctuation">,</span> trueAST<span class="token punctuation">,</span> falseAST<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我不想处理类似的输入 if (x-2)，因此我已经限制了二进制表达式 binexpr() 只能具有一个根，该根是六个比较运算符 A<em>EQ，A</em>NE，A<em>LT，A</em>GT，A<em>LE 或 A</em>GE 之一。</p>\n<h2 id="三个子树"><a href="#%E4%B8%89%E4%B8%AA%E5%AD%90%E6%A0%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三个子树</h2>\n<p>在 if_statement() 我的最后一行中，我建立了一个 AST 节点：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34119784565134115000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mkastnode(A_IF, condAST, trueAST, falseAST, 0);`, `34119784565134115000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token function">mkastnode</span><span class="token punctuation">(</span>A_IF<span class="token punctuation">,</span> condAST<span class="token punctuation">,</span> trueAST<span class="token punctuation">,</span> falseAST<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>那是三个 AST 子树！这里发生了什么？如您所见，IF 语句将具有三个子树：</p>\n<ul>\n<li>执行条件的子树</li>\n<li>紧随其后的复合语句</li>\n<li>else 关键字之后的可选复合语句</li>\n</ul>\n<p>因此我们现在需要具有三个子节点的 AST 节点结构（在 defs.h 中）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15709345253405594000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// AST node types.\nenum {\n  ...\n  A_GLUE, A_IF\n};\n\n// Abstract Syntax Tree structure\nstruct ASTnode {\n  int op;                       // &quot;Operation&quot; to be performed on this tree\n  struct ASTnode *left;         // Left, middle and right child trees\n  struct ASTnode *mid;\n  struct ASTnode *right;\n  union {\n    int intvalue;               // For A_INTLIT, the integer value\n    int id;                     // For A_IDENT, the symbol slot number\n  } v;\n};`, `15709345253405594000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// AST node types.</span>\n<span class="token keyword">enum</span> <span class="token punctuation">{</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n  A_GLUE<span class="token punctuation">,</span> A_IF\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Abstract Syntax Tree structure</span>\n<span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token punctuation">{</span>\n  <span class="token keyword">int</span> op<span class="token punctuation">;</span>                       <span class="token comment">// "Operation" to be performed on this tree</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>left<span class="token punctuation">;</span>         <span class="token comment">// Left, middle and right child trees</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>mid<span class="token punctuation">;</span>\n  <span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>\n  <span class="token keyword">union</span> <span class="token punctuation">{</span>\n    <span class="token keyword">int</span> intvalue<span class="token punctuation">;</span>               <span class="token comment">// For A_INTLIT, the integer value</span>\n    <span class="token keyword">int</span> id<span class="token punctuation">;</span>                     <span class="token comment">// For A_IDENT, the symbol slot number</span>\n  <span class="token punctuation">}</span> v<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因此 A_IF 树如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39033276547574735000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`                      IF\n                    / |  \\\n                   /  |   \\\n                  /   |    \\\n                 /    |     \\\n                /     |      \\\n               /      |       \\\n      condition   statements   statements`, `39033276547574735000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">                      IF\n                    / |  \\\n                   /  |   \\\n                  /   |    \\\n                 /    |     \\\n                /     |      \\\n               /      |       \\\n      condition   statements   statements</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="组装-ast-节点"><a href="#%E7%BB%84%E8%A3%85-ast-%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组装 AST 节点</h2>\n<p>还有一个新的 A_GLUE AST 节点类型，这是做什么用的？现在我们用很多语句构建一个 AST 树，因此我们需要一种将它们组装在一起的方法。</p>\n<p>查看 compound_statement() 循环代码的结尾：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64001862304037060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (left != NULL)\n  left = mkastnode(A_GLUE, left, NULL, tree, 0);`, `64001862304037060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>\n  left <span class="token operator">=</span> <span class="token function">mkastnode</span><span class="token punctuation">(</span>A_GLUE<span class="token punctuation">,</span> left<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> tree<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>每次获得新的子树时，我们会将其粘贴到现有树上。因此，对于此语句序列：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34898402238855807000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stmt1;\nstmt2;\nstmt3;\nstmt4;`, `34898402238855807000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">stmt1;\nstmt2;\nstmt3;\nstmt4;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们最终得到：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9124462531767419000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`             A_GLUE\n              /  \\\n          A_GLUE stmt4\n            /  \\\n        A_GLUE stmt3\n          /  \\\n      stmt1  stmt2`, `9124462531767419000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">             A_GLUE\n              /  \\\n          A_GLUE stmt4\n            /  \\\n        A_GLUE stmt3\n          /  \\\n      stmt1  stmt2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而且当我们从左到右先深度遍历树时，这仍然会以正确的顺序生成汇编代码。</p>\n<h2 id="通用代码生成器"><a href="#%E9%80%9A%E7%94%A8%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>通用代码生成器</h2>\n<p>现在我们的 AST 节点有多个子节点，我们的通用代码生成器将变得更加复杂。另外对于比较运算符，我们需要知道是否要在 IF 语句（相反的比较中为跳转）或正则表达式（正常的比较中将寄存器设置为 1 或 0）的一部分中进行比较。</p>\n<p>为此我进行了修改 getAST() 以便我们可以传递父 AST 节点操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64925590572523274000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Given an AST, the register (if any) that holds\n// the previous rvalue, and the AST op of the parent,\n// generate assembly code recursively.\n// Return the register id with the tree\'s final value\nint genAST(struct ASTnode *n, int reg, int parentASTop) {\n   ...\n}`, `64925590572523274000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Given an AST, the register (if any) that holds</span>\n<span class="token comment">// the previous rvalue, and the AST op of the parent,</span>\n<span class="token comment">// generate assembly code recursively.</span>\n<span class="token comment">// Return the register id with the tree\'s final value</span>\n<span class="token keyword">int</span> <span class="token function">genAST</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>n<span class="token punctuation">,</span> <span class="token keyword">int</span> reg<span class="token punctuation">,</span> <span class="token keyword">int</span> parentASTop<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="处理特定的-ast-节点"><a href="#%E5%A4%84%E7%90%86%E7%89%B9%E5%AE%9A%E7%9A%84-ast-%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>处理特定的 AST 节点</h3>\n<p>现在 genAST() 中的代码必须处理特定的 AST 节点：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35134438009281245000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// We now have specific AST node handling at the top\nswitch (n->op) {\n  case A_IF:\n    return (genIFAST(n));\n  case A_GLUE:\n    // Do each child statement, and free the\n    // registers after each child\n    genAST(n->left, NOREG, n->op);\n    genfreeregs();\n    genAST(n->right, NOREG, n->op);\n    genfreeregs();\n    return (NOREG);\n}`, `35134438009281245000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// We now have specific AST node handling at the top</span>\n<span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">case</span> A_IF<span class="token operator">:</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">genIFAST</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">case</span> A_GLUE<span class="token operator">:</span>\n    <span class="token comment">// Do each child statement, and free the</span>\n    <span class="token comment">// registers after each child</span>\n    <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">,</span> NOREG<span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">genfreeregs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">,</span> NOREG<span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">genfreeregs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>NOREG<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果不返回则继续执行普通的二进制运算符 AST 节点，但有一个例外比较节点：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45399078747962120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`case A_EQ:\ncase A_NE:\ncase A_LT:\ncase A_GT:\ncase A_LE:\ncase A_GE:\n  // If the parent AST node is an A_IF, generate a compare\n  // followed by a jump. Otherwise, compare registers and\n  // set one to 1 or 0 based on the comparison.\n  if (parentASTop == A_IF)\n    return (cgcompare_and_jump(n->op, leftreg, rightreg, reg));\n  else\n    return (cgcompare_and_set(n->op, leftreg, rightreg));`, `45399078747962120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">case</span> A_EQ<span class="token operator">:</span>\n<span class="token keyword">case</span> A_NE<span class="token operator">:</span>\n<span class="token keyword">case</span> A_LT<span class="token operator">:</span>\n<span class="token keyword">case</span> A_GT<span class="token operator">:</span>\n<span class="token keyword">case</span> A_LE<span class="token operator">:</span>\n<span class="token keyword">case</span> A_GE<span class="token operator">:</span>\n  <span class="token comment">// If the parent AST node is an A_IF, generate a compare</span>\n  <span class="token comment">// followed by a jump. Otherwise, compare registers and</span>\n  <span class="token comment">// set one to 1 or 0 based on the comparison.</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>parentASTop <span class="token operator">==</span> A_IF<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">cgcompare_and_jump</span><span class="token punctuation">(</span>n<span class="token operator">-></span>op<span class="token punctuation">,</span> leftreg<span class="token punctuation">,</span> rightreg<span class="token punctuation">,</span> reg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">else</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">cgcompare_and_set</span><span class="token punctuation">(</span>n<span class="token operator">-></span>op<span class="token punctuation">,</span> leftreg<span class="token punctuation">,</span> rightreg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我将介绍新的功能 cgcompare<em>and</em>jump() 和 cgcompare<em>and</em>set()。</p>\n<h3 id="生成-if-汇编代码"><a href="#%E7%94%9F%E6%88%90-if-%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成 IF 汇编代码</h3>\n<p>我们使用特定函数处理 A_IF AST 节点，并使用一个函数来生成新标签号：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58296901043386630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Generate and return a new label number\nstatic int label(void) {\n  static int id = 1;\n  return (id++);\n}\n\n// Generate the code for an IF statement\n// and an optional ELSE clause\nstatic int genIFAST(struct ASTnode *n) {\n  int Lfalse, Lend;\n\n  // Generate two labels: one for the\n  // false compound statement, and one\n  // for the end of the overall IF statement.\n  // When there is no ELSE clause, Lfalse _is_\n  // the ending label!\n  Lfalse = label();\n  if (n->right)\n    Lend = label();\n\n  // Generate the condition code followed\n  // by a zero jump to the false label.\n  // We cheat by sending the Lfalse label as a register.\n  genAST(n->left, Lfalse, n->op);\n  genfreeregs();\n\n  // Generate the true compound statement\n  genAST(n->mid, NOREG, n->op);\n  genfreeregs();\n\n  // If there is an optional ELSE clause,\n  // generate the jump to skip to the end\n  if (n->right)\n    cgjump(Lend);\n\n  // Now the false label\n  cglabel(Lfalse);\n\n  // Optional ELSE clause: generate the\n  // false compound statement and the\n  // end label\n  if (n->right) {\n    genAST(n->right, NOREG, n->op);\n    genfreeregs();\n    cglabel(Lend);\n  }\n\n  return (NOREG);\n}`, `58296901043386630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Generate and return a new label number</span>\n<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">label</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">static</span> <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>id<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// Generate the code for an IF statement</span>\n<span class="token comment">// and an optional ELSE clause</span>\n<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">genIFAST</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ASTnode</span> <span class="token operator">*</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">int</span> Lfalse<span class="token punctuation">,</span> Lend<span class="token punctuation">;</span>\n\n  <span class="token comment">// Generate two labels: one for the</span>\n  <span class="token comment">// false compound statement, and one</span>\n  <span class="token comment">// for the end of the overall IF statement.</span>\n  <span class="token comment">// When there is no ELSE clause, Lfalse _is_</span>\n  <span class="token comment">// the ending label!</span>\n  Lfalse <span class="token operator">=</span> <span class="token function">label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span>\n    Lend <span class="token operator">=</span> <span class="token function">label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Generate the condition code followed</span>\n  <span class="token comment">// by a zero jump to the false label.</span>\n  <span class="token comment">// We cheat by sending the Lfalse label as a register.</span>\n  <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">,</span> Lfalse<span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">genfreeregs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Generate the true compound statement</span>\n  <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>mid<span class="token punctuation">,</span> NOREG<span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">genfreeregs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// If there is an optional ELSE clause,</span>\n  <span class="token comment">// generate the jump to skip to the end</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span>\n    <span class="token function">cgjump</span><span class="token punctuation">(</span>Lend<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Now the false label</span>\n  <span class="token function">cglabel</span><span class="token punctuation">(</span>Lfalse<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Optional ELSE clause: generate the</span>\n  <span class="token comment">// false compound statement and the</span>\n  <span class="token comment">// end label</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">,</span> NOREG<span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">genfreeregs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">cglabel</span><span class="token punctuation">(</span>Lend<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>NOREG<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际上，代码正在执行以下操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20952130177135440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`genAST(n->left, Lfalse, n->op);       // Condition and jump to Lfalse\ngenAST(n->mid, NOREG, n->op);         // Statements after \'if\'\ncgjump(Lend);                         // Jump to Lend\ncglabel(Lfalse);                      // Lfalse: label\ngenAST(n->right, NOREG, n->op);       // Statements after \'else\'\ncglabel(Lend);`, `20952130177135440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>left<span class="token punctuation">,</span> Lfalse<span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// Condition and jump to Lfalse</span>\n<span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>mid<span class="token punctuation">,</span> NOREG<span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// Statements after \'if\'</span>\n<span class="token function">cgjump</span><span class="token punctuation">(</span>Lend<span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// Jump to Lend</span>\n<span class="token function">cglabel</span><span class="token punctuation">(</span>Lfalse<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// Lfalse: label</span>\n<span class="token function">genAST</span><span class="token punctuation">(</span>n<span class="token operator">-></span>right<span class="token punctuation">,</span> NOREG<span class="token punctuation">,</span> n<span class="token operator">-></span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// Statements after \'else\'</span>\n<span class="token function">cglabel</span><span class="token punctuation">(</span>Lend<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="x86-64-代码生成功能"><a href="#x86-64-%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>x86-64 代码生成功能</h2>\n<p>因此，我们现在有了一些新的 x86-64 代码生成功能，其中一些替代了 cgXXX() 我们在旅程的最后部分中创建的六个比较功能。</p>\n<p>对于正常的比较功能，我们现在传递 AST 操作以选择相关的 x86-64 set 指令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3496487901716860400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// List of comparison instructions,\n// in AST order: A_EQ, A_NE, A_LT, A_GT, A_LE, A_GE\nstatic char *cmplist[] =\n  { &quot;sete&quot;, &quot;setne&quot;, &quot;setl&quot;, &quot;setg&quot;, &quot;setle&quot;, &quot;setge&quot; };\n\n// Compare two registers and set if true.\nint cgcompare_and_set(int ASTop, int r1, int r2) {\n\n  // Check the range of the AST operation\n  if (ASTop < A_EQ || ASTop > A_GE)\n    fatal(&quot;Bad ASTop in cgcompare_and_set()&quot;);\n\n  fprintf(Outfile, &quot;\\tcmpq\\t%s, %s\\n&quot;, reglist[r2], reglist[r1]);\n  fprintf(Outfile, &quot;\\t%s\\t%s\\n&quot;, cmplist[ASTop - A_EQ], breglist[r2]);\n  fprintf(Outfile, &quot;\\tmovzbq\\t%s, %s\\n&quot;, breglist[r2], reglist[r2]);\n  free_register(r1);\n  return (r2);\n}`, `3496487901716860400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// List of comparison instructions,</span>\n<span class="token comment">// in AST order: A_EQ, A_NE, A_LT, A_GT, A_LE, A_GE</span>\n<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmplist<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>\n  <span class="token punctuation">{</span> <span class="token string">"sete"</span><span class="token punctuation">,</span> <span class="token string">"setne"</span><span class="token punctuation">,</span> <span class="token string">"setl"</span><span class="token punctuation">,</span> <span class="token string">"setg"</span><span class="token punctuation">,</span> <span class="token string">"setle"</span><span class="token punctuation">,</span> <span class="token string">"setge"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Compare two registers and set if true.</span>\n<span class="token keyword">int</span> <span class="token function">cgcompare_and_set</span><span class="token punctuation">(</span><span class="token keyword">int</span> ASTop<span class="token punctuation">,</span> <span class="token keyword">int</span> r1<span class="token punctuation">,</span> <span class="token keyword">int</span> r2<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n  <span class="token comment">// Check the range of the AST operation</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ASTop <span class="token operator">&lt;</span> A_EQ <span class="token operator">||</span> ASTop <span class="token operator">></span> A_GE<span class="token punctuation">)</span>\n    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"Bad ASTop in cgcompare_and_set()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tcmpq\\t%s, %s\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\t%s\\t%s\\n"</span><span class="token punctuation">,</span> cmplist<span class="token punctuation">[</span>ASTop <span class="token operator">-</span> A_EQ<span class="token punctuation">]</span><span class="token punctuation">,</span> breglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tmovzbq\\t%s, %s\\n"</span><span class="token punctuation">,</span> breglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">free_register</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我还发现了一条 x86-64 指令 movzbq，该指令将一个寄存器中的最低字节移出并将其扩展为适合 64 位寄存器，我现在正在使用它而不是旧代码中的 and $255。</p>\n<p>我们需要一个函数来生成标签并跳转到它：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52784685688546600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Generate a label\nvoid cglabel(int l) {\n  fprintf(Outfile, &quot;L%d:\\n&quot;, l);\n}\n\n// Generate a jump to a label\nvoid cgjump(int l) {\n  fprintf(Outfile, &quot;\\tjmp\\tL%d\\n&quot;, l);\n}`, `52784685688546600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// Generate a label</span>\n<span class="token keyword">void</span> <span class="token function">cglabel</span><span class="token punctuation">(</span><span class="token keyword">int</span> l<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"L%d:\\n"</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// Generate a jump to a label</span>\n<span class="token keyword">void</span> <span class="token function">cgjump</span><span class="token punctuation">(</span><span class="token keyword">int</span> l<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tjmp\\tL%d\\n"</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后我们需要一个函数进行比较并根据相反的比较跳转，因此使用 AST 比较节点类型，我们进行相反的比较：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4869848016516932000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// List of inverted jump instructions,\n// in AST order: A_EQ, A_NE, A_LT, A_GT, A_LE, A_GE\nstatic char *invcmplist[] = { &quot;jne&quot;, &quot;je&quot;, &quot;jge&quot;, &quot;jle&quot;, &quot;jg&quot;, &quot;jl&quot; };\n\n// Compare two registers and jump if false.\nint cgcompare_and_jump(int ASTop, int r1, int r2, int label) {\n\n  // Check the range of the AST operation\n  if (ASTop < A_EQ || ASTop > A_GE)\n    fatal(&quot;Bad ASTop in cgcompare_and_set()&quot;);\n\n  fprintf(Outfile, &quot;\\tcmpq\\t%s, %s\\n&quot;, reglist[r2], reglist[r1]);\n  fprintf(Outfile, &quot;\\t%s\\tL%d\\n&quot;, invcmplist[ASTop - A_EQ], label);\n  freeall_registers();\n  return (NOREG);\n}`, `4869848016516932000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// List of inverted jump instructions,</span>\n<span class="token comment">// in AST order: A_EQ, A_NE, A_LT, A_GT, A_LE, A_GE</span>\n<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>invcmplist<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"jne"</span><span class="token punctuation">,</span> <span class="token string">"je"</span><span class="token punctuation">,</span> <span class="token string">"jge"</span><span class="token punctuation">,</span> <span class="token string">"jle"</span><span class="token punctuation">,</span> <span class="token string">"jg"</span><span class="token punctuation">,</span> <span class="token string">"jl"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Compare two registers and jump if false.</span>\n<span class="token keyword">int</span> <span class="token function">cgcompare_and_jump</span><span class="token punctuation">(</span><span class="token keyword">int</span> ASTop<span class="token punctuation">,</span> <span class="token keyword">int</span> r1<span class="token punctuation">,</span> <span class="token keyword">int</span> r2<span class="token punctuation">,</span> <span class="token keyword">int</span> label<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n  <span class="token comment">// Check the range of the AST operation</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ASTop <span class="token operator">&lt;</span> A_EQ <span class="token operator">||</span> ASTop <span class="token operator">></span> A_GE<span class="token punctuation">)</span>\n    <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token string">"Bad ASTop in cgcompare_and_set()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\tcmpq\\t%s, %s\\n"</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r2<span class="token punctuation">]</span><span class="token punctuation">,</span> reglist<span class="token punctuation">[</span>r1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">fprintf</span><span class="token punctuation">(</span>Outfile<span class="token punctuation">,</span> <span class="token string">"\\t%s\\tL%d\\n"</span><span class="token punctuation">,</span> invcmplist<span class="token punctuation">[</span>ASTop <span class="token operator">-</span> A_EQ<span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">freeall_registers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>NOREG<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="运行结果"><a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>运行结果</h1>\n<h2 id="输入"><a href="#%E8%BE%93%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输入</h2>\n<p>input05</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13751854167090016000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  int i; int j;\n  i=6; j=12;\n  if (i < j) {\n    print i;\n  } else {\n    print j;\n  }\n}`, `13751854167090016000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">{\n  int i; int j;\n  i=6; j=12;\n  if (i &lt; j) {\n    print i;\n  } else {\n    print j;\n  }\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="输出"><a href="#%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输出</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57834106644862796000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ make test\ncc -o comp1 -g cg.c decl.c expr.c gen.c main.c misc.c scan.c stmt.c sym.c tree.c\n./comp1 input05\ncc -o out out.s\n./out\n6`, `57834106644862796000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">make</span> <span class="token builtin class-name">test</span>\ncc -o comp1 -g cg.c decl.c expr.c gen.c main.c misc.c scan.c stmt.c sym.c tree.c\n./comp1 input05\ncc -o out out.s\n./out\n<span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>out.s</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56073774218788080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`        .text\n.LC0:\n        .string &quot;%d\\n&quot;\nprintint:\n        pushq   %rbp\n        movq    %rsp, %rbp\n        subq    \\$16, %rsp\n        movl    %edi, -4(%rbp)\n        movl    -4(%rbp), %eax\n        movl    %eax, %esi\n        leaq    .LC0(%rip), %rdi\n        movl    \\$0, %eax\n        call    printf@PLT\n        nop\n        leave\n        ret\n\n        .globl  main\n        .type   main, @function\nmain:\n        pushq   %rbp\n        movq    %rsp, %rbp\n        .comm   i,8,8\n        .comm   j,8,8\n        movq    \\$6, %r8\n        movq    %r8, i(%rip)\n        movq    \\$12, %r8\n        movq    %r8, j(%rip)\n        movq    i(%rip), %r8\n        movq    j(%rip), %r9\n        cmpq    %r9, %r8\n        jge     L1\n        movq    i(%rip), %r8\n        movq    %r8, %rdi\n        call    printint\n        jmp     L2\nL1:\n        movq    j(%rip), %r8\n        movq    %r8, %rdi\n        call    printint\nL2:\n        movl    \\$0, %eax\n        popq    %rbp\n        ret`, `56073774218788080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">        .text\n.LC0:\n        .string &quot;%d\\n&quot;\nprintint:\n        pushq   %rbp\n        movq    %rsp, %rbp\n        subq    $16, %rsp\n        movl    %edi, -4(%rbp)\n        movl    -4(%rbp), %eax\n        movl    %eax, %esi\n        leaq    .LC0(%rip), %rdi\n        movl    $0, %eax\n        call    printf@PLT\n        nop\n        leave\n        ret\n\n        .globl  main\n        .type   main, @function\nmain:\n        pushq   %rbp\n        movq    %rsp, %rbp\n        .comm   i,8,8\n        .comm   j,8,8\n        movq    $6, %r8\n        movq    %r8, i(%rip)\n        movq    $12, %r8\n        movq    %r8, j(%rip)\n        movq    i(%rip), %r8\n        movq    j(%rip), %r9\n        cmpq    %r9, %r8\n        jge     L1\n        movq    i(%rip), %r8\n        movq    %r8, %rdi\n        call    printint\n        jmp     L2\nL1:\n        movq    j(%rip), %r8\n        movq    %r8, %rdi\n        call    printint\nL2:\n        movl    $0, %eax\n        popq    %rbp\n        ret</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="结论"><a href="#%E7%BB%93%E8%AE%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>结论</h1>\n<p>我们已经使用 IF 语句在我们的语言中添加了第一个控制结构，在此过程中我不得不重写一些现有的内容，而且由于我脑子里还没有完整的架构计划，因此将来可能需要重写更多内容。</p>\n<p>这段旅程的难处在于，对于 IF 决策我们必须执行与对普通比较运算符相反的比较，我的解决方案是通知每个 AST 节点其父节点的节点类型，比较节点现在可以查看父节点是否为 A_IF 节点。</p>\n<p>我知道 Nils Holm 在实现 SubC 时选择了不同的方法，因此您应该查看他的代码，以便看到针对同一问题的不同解决方案。</p>\n<p>在编译器编写过程的下一部分中，我们将添加另一个控制结构：WHILE 循环。</p>',
id:"/github/workspace/blog/编译器之旅（八）——IF语句/index.md absPath of file >>> MarkdownRemark",timeToRead:11,frontmatter:{date:"2020-03-16 17:22:09",path:"/tour-of-compiler-if-statements/",tags:"编译原理, IF语句",title:"编译器之旅（八）——IF语句",draft:null}}],page:8,pagesSum:37,length:184,prevPath:"/page/7",nextPath:"/page/9"}}}});
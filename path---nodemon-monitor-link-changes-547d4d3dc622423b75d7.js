webpackJsonp([0xb48b6c514cac],{1161:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlUlEQVRIx11WaWxU1xWewbQlrdofkSIhGiBpMPZ4Vs/2lpm3zupZPOOZ8Sz2YGzANkaAKaYQUrMkLYgiIlxCQjCYQAwYEoMQNJAIFBxaQgUhoCopYceBJo1pKFVDCbOc0/fesOZKV+fM1Tvf/c56R0VYOZW8lvAxtSybvbExAu1+mndGuaDQ2F4rNHVFhCZJZlMeZ1Qrf9Mt+H+qur/ihFORAFA64J0pVTcXVcDmcKFfruIzZ7rY1H89fAZivjbM1MzFxkAnZqWd9M7KJcTmv7zCN44sY+tflm12C79WLxLCqidWN9cwWpYvsfXL13vasZudgm4mgX4hW6h1teRjnrZCwjOzWO/twIR/FjZ7WnEZ35JvcUSeU4gwSXV7W1sJzEH6R8nSRArlXjr6r7S1DqNUvMAzCXCzSfDxDRAUmyDkaoawtEPi1LxHyGLMkby5gEqUy7atjnq1roosAXqE6Yq7DBXa7RLS6HRG8y4hhbwzDiJbj4IkXUwS5e1h07IOorMePUL6ruiKGmRblg2PesJlq9nxrJMMfydIbhIWP9jMPrBLkrIHgXfG0CdmgKMjwFARFKVvHEQo5xUyKDDRN2T7aE17mV5rfZQYm1lM0EQYWUe0aNTxoKl0Qnk5jVqNA/VaFu3SBS7SB7Ju0ougr2KKWg2DBi17mbCaxyghMzgeMTTp2W7CGkTKHshZqn0Q5Osg6opBhAmAzcADY/NheyQJBi2D8mXVehYMOgEsJg9aTIxSN2YTO+ohQ62G6rGZa5AmAjmj0YvzG5vhVP8f4fTO12FtVxfMjTfC6zPbwOsIQNybhK6GlmLCm5DA6cu2aoeSaaOeVheLxRKgpoJcZ5UAly94MeeiQ+jnQtBCcTBTZ8Ght9fDfy58DDdOHIRj2zdA/4uzYWBpZ6Fr6jR8/lfWP8n2usqA2mQgH7msr3Ks0WgEfGvN6lz/q6tgXqgZjgpZOGSLwsldA4CFG4j3rmP/osU47xkdrm5pLfjdETm+p64cf0fJME34HiVFV+VYajF50UGGc/Nnz4XDfW/ArQ09+M++XsCblwD+fQEL356HswuWwdedS+Dg2p5ilZQwa7VrpCHZ9nOl7Ojg44B0hxxg0hbMjx2rh2iwDk4feReKI58hfn8V8c5lwNyXiF+dRbz4Z1jY1g4TJ1rQbnHfc/ORihJDr5q0kw8AyVqDjpeSEpJLAyaMN6HRwMDuTa/B1fcPwcfbBuHc8SPw+cnDsGvzeim7HOg0DpAYoouPBWUMJxUo65y18X4MtbYJOo3zjgQoxwWen1iNDdPmwPu9+2BvfCXsXbQRehf9Hly0B8aN04OuioGqCipvt/hQ5GLzS4Dh0Tdv3+/nvm0qVVUlfUouboOWK8jxmaznMBXIwpbfroWN63th384tcHTfDpj0gg21lQxoK+m8TQGMb5UxAt6OUYSVkUuGK5MPKiuIHicZwWqDmNNqpE6pIFBjpGDxsqXwuxUroWtBN5w4NgSbNvcDIRW61CUFu9UrtV/si7Fjf/ajUmICSvxKgJMtdQxVK2XOU9RpGNBL3VBeQWIqPR3SjR3QOW8xrFmxCnrWbYJMaobEkr1HE/4zIpv4nrK7NIrbpF+tspoYZdpMLte+wNPRu6S1Bs1GqV/1DOqMPFjIMFbq3dg6cyFkGmagqZqHaoOAHF2XZ6ngWg+XBM4RVoLHOWrLVG4uWpo4FvsvfHz6NktFkbT6QafnQGsUoFLHYm1dFj44cgwYPgQVkymkbP6RWl+LNIRjL/uFhltuNjEoYySCXaNUojOsMPSw4aqwa+o9ga5DggiC1RFDmyMG1bYQVlTSIIhRMJq9RaPZJ4VF+DQZ6MCAmOkLurJ/DYiNt/R67VMKs4hrqjL+o+6mjrj0hjBEOG+1h8FOxcFO1oHVFgazPYQGqdfNthBYpUqwEME78nsT4tP7o96WwWSwA1nKb35iyCZ8M85EXE3oYBO3ab4RKWcSKCaFJJMCQprSpPQcUFwKzWQUKo1+lC9x0r7Fcc+0OVOj8zEkNrY8BAuLDV11ruZvDXrhuJ3NIu+bAYK/FXjfdOA8zegUp6DdmQKNMQD+8HTseW1LYeijE/jB4Q+/Wry8a5L01B6MeaetUcDSjfVjjOVM7da+bTMPvHfkbmrKb5DksjkLncmZqXTe6siAnWmAmkhbYUPvQP7cufO5L69fxyvD/8Ctb+/aI2PU8AmvRGqZAoiIityzb8/T165d3X3t2vD/Pjr+KW7b+R6u2/AOrli9CQfePYQXLg3jpSvDeOLkWTxw6Oh3uwYPrJTMlNHlFcLPeNk6/UOXZ7cuGP1A397fP/7v584vvzJ8o+dvn33+Zm/v9q9X/2EDbN+19+ybm3ds33/ww5f63uovf/D9woVL1A90P5dQqYaGhpQfg4N71BJbteoHqyk7Z+e8zlfuSupPHj+/eO2bso5ZcxQ9Fsiqgny6ZOv3+VTfjIwo+iefnFYN7BxQf3FxuEwGH1c+fgxBuIZnTFuIIh9U2qt3844fb9y0Vf0gXPKm7bzKzYZ+wGTKFFWNz1/6v8OLUiuaFKMJz00yEvaa/RQZnK086s6MutpEqRLx+kcT+rH1f+YikeeNfqnwAAAAAElFTkSuQmCC",aspectRatio:.6666666666666666,src:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png",srcSet:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-8a97b.png 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-0fdf3.png 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png 600w",srcWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp",srcSetWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-5d70e.webp 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-d1677.webp 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="项目架构"><a href="#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目架构</h1>\n<p>公司项目分为以下几种架构：</p>\n<ol>\n<li>主项目-扩展项目：扩展项目前端独立，是以 npm 包的形式安装到主项目，后端可以独立编译，但不能独立运行，即后端与主项目共用一套，主项目需要对扩展项目编译出的后端代码进行监听来实现增量编译</li>\n<li>主项目-子项目：微前端架构，子项目前、后端独立可运行</li>\n</ol>\n<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>需要解决主项目-扩展项目架构下主项目的后端不能增量编译的问题</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<table>\n<thead>\n<tr>\n<th align="center">选型</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">直接在 node_modules 目录下开发</td>\n<td align="center">主项目已实现对 node_modules 下扩展项目的监听</td>\n<td align="center">每次 npm install 都要重新新建项目</td>\n</tr>\n<tr>\n<td align="center">gulp 文件同步</td>\n<td align="center">有第三方插件</td>\n<td align="center">需要多运行一个文件同步脚本</td>\n</tr>\n<tr>\n<td align="center">npm link</td>\n<td align="center">不需要多运行一个脚本</td>\n<td align="center">需要每次手动重启主项目来让后端代码生效</td>\n</tr>\n<tr>\n<td align="center">nodemon + npm link</td>\n<td align="center">监听到扩展项目变化自动重启</td>\n<td align="center">每次 npm install 都要重新 npm link</td>\n</tr>\n</tbody>\n</table>\n<h1 id="解决过程"><a href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决过程</h1>\n<h2 id="gulp-文件同步"><a href="#gulp-%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gulp 文件同步</h2>\n<p>核心逻辑：监听扩展项目编译出来的后端代码，发现改动时同步到 node_modules 下扩展项目的位置</p>\n<p>./config.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36840263036610390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports = {\n  //同步文件更改到指定目录\n  syncTo: \'../主项目/node_modules/扩展项目/extend\'\n};`, `36840263036610390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">//同步文件更改到指定目录</span>\n  syncTo<span class="token punctuation">:</span> <span class="token string">\'../主项目/node_modules/扩展项目/extend\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>./gulpfile.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39913175996829780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const gulp = require(\'gulp\');\nconst fileSync = require(\'gulp-file-sync\');\nconst { syncTo } = require(\'./config\');\nconst mkdirp = require(\'mkdirp\');\nconst fs = require(\'fs\');\nconst watch = require(\'gulp-watch\');\nconst run = require(\'run-sequence\');\n\ngulp.task(\'sync\', function() {\n  try {\n    let state = fs.statSync(syncTo);\n    if (!state.isDirectory()) {\n      mkdirp(syncTo);\n    }\n  } catch (e) {\n    console.log(e);\n    mkdirp(syncTo);\n  }\n\n  fileSync(\'extend\', syncTo);\n});\n\ngulp.task(\'watch-extend\', function() {\n  watch([\'./extend/**\'], function() {\n    run(\'sync\');\n  });\n});\n\ngulp.task(\'watch\', [\'watch-extend\']);\n\ngulp.task(\'default\', [\'sync\', \'watch\']);`, `39913175996829780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fileSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-file-sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> syncTo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'mkdirp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> watch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-watch\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'run-sequence\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'sync\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> state <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">mkdirp</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">mkdirp</span><span class="token punctuation">(</span>syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">fileSync</span><span class="token punctuation">(</span><span class="token string">\'extend\'</span><span class="token punctuation">,</span> syncTo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'watch-extend\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'./extend/**\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'watch\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'watch-extend\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ngulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">\'default\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'sync\'</span><span class="token punctuation">,</span> <span class="token string">\'watch\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="nodemon--npm-link"><a href="#nodemon--npm-link" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nodemon + npm link</h2>\n<ol>\n<li>对扩展项目进行 npm link 操作，然后在主项目中 npm link 扩展项目，可以在主项目的 node_modules 下看到指向扩展项目的软链接</li>\n<li>主项目使用了 nodemon 来监听 node_modules 文件变化，鉴于每次重启主项目之后扩展项目的代码才会生效的问题，需要解决 nodemon 不能监听软链接下文件变化的问题</li>\n</ol>\n<p>核心逻辑：</p>\n<ol>\n<li>在不影响 nodemon 脚本调用逻辑的情况下，在 nodemon.json 添加 <code class="language-text">watchSymbolLink</code> 属性，明确监听软链接的文件位置</li>\n<li>利用 glob 三方库读取 watchSymbolLink 下的文件，当判断读到的文件是软链接文件时（isSymbolicLink），读取真实的文件路径（realpathSync）</li>\n<li>在监听原来文件的基础上，调用 nodemon 监听另外真实的文件路径</li>\n</ol>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36740510066744324000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;scripts&quot;: {\n    &quot;dev:server&quot;: &quot;node bin/nodemon.js --config nodemon.json ./bin/www&quot;\n  }\n}`, `36740510066744324000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"dev:server"</span><span class="token operator">:</span> <span class="token string">"node bin/nodemon.js --config nodemon.json ./bin/www"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bin\\nodemon.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26527418978604556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const nodemon = require(\'nodemon\');\nconst nodemonCli = require(\'nodemon/lib/cli\');\nconst options = nodemonCli.parse(process.argv);\nconst glob = require(\'glob\');\nconst fs = require(\'fs\');\nconst lodash = require(\'lodash\');\nconst path = require(\'path\');\n\n// &quot;watchSymbolLink&quot;: [\n//   {\n//     &quot;url&quot;: &quot;node_modules/sugo-analytics-extend-*&quot;,\n//     &quot;path&quot;: &quot;/extend/app/**/*&quot;\n//   },\n// ],\n// 或\n// &quot;watchSymbolLink&quot;: [\n//    &quot;node_modules/sugo-analytics-extend-*&quot;,\n// ],\nconst { configFile, ...optionsRest } = options;\n\nconst nodemonJsonPath = path.join(process.cwd(), configFile);\n\nconst nodemonJson = require(nodemonJsonPath);\n\nconst { watch, watchSymbolLink = [], ...nodemonJsonRest } = nodemonJson;\n\nconst dirs = [];\n\nwatchSymbolLink.forEach((item) => {\n  const { url, path: linkPath = \'\' } = lodash.isObject(item) ? item : { url: item };\n  const paths = glob\n    .sync(url)\n    .filter((a) => fs.lstatSync(a).isSymbolicLink())\n    .map((a) => path.join(fs.realpathSync(a), linkPath));\n  dirs.push(...paths);\n});\n\nconst opts = {\n  ...optionsRest,\n  ...nodemonJsonRest,\n  watch: [...watch, ...dirs]\n};\n\n// console.log(opts)\n\nnodemon(opts);\n\nnodemon.on(\'quit\', function() {\n  process.exit();\n});\n\nconst packageJsonPath = path.join(process.cwd(), \'package.json\');\n\n// checks for available update and returns an instance\nconst pkg = JSON.parse(fs.readFileSync(packageJsonPath));\n\nif (pkg.version.indexOf(\'0.0.0\') !== 0 && options.noUpdateNotifier !== true) {\n  require(\'update-notifier\')({ pkg }).notify();\n}`, `26527418978604556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> nodemon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'nodemon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> nodemonCli <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'nodemon/lib/cli\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> options <span class="token operator">=</span> nodemonCli<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'glob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// "watchSymbolLink": [</span>\n<span class="token comment">//   {</span>\n<span class="token comment">//     "url": "node_modules/sugo-analytics-extend-*",</span>\n<span class="token comment">//     "path": "/extend/app/**/*"</span>\n<span class="token comment">//   },</span>\n<span class="token comment">// ],</span>\n<span class="token comment">// 或</span>\n<span class="token comment">// "watchSymbolLink": [</span>\n<span class="token comment">//    "node_modules/sugo-analytics-extend-*",</span>\n<span class="token comment">// ],</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> configFile<span class="token punctuation">,</span> <span class="token operator">...</span>optionsRest <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> nodemonJsonPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> nodemonJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>nodemonJsonPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> watch<span class="token punctuation">,</span> watchSymbolLink <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>nodemonJsonRest <span class="token punctuation">}</span> <span class="token operator">=</span> nodemonJson<span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> dirs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nwatchSymbolLink<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> path<span class="token punctuation">:</span> linkPath <span class="token operator">=</span> <span class="token string">\'\'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">?</span> item <span class="token punctuation">:</span> <span class="token punctuation">{</span> url<span class="token punctuation">:</span> item <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> paths <span class="token operator">=</span> glob\n    <span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> fs<span class="token punctuation">.</span><span class="token function">lstatSync</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSymbolicLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> linkPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  dirs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token operator">...</span>optionsRest<span class="token punctuation">,</span>\n  <span class="token operator">...</span>nodemonJsonRest<span class="token punctuation">,</span>\n  watch<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>watch<span class="token punctuation">,</span> <span class="token operator">...</span>dirs<span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// console.log(opts)</span>\n\n<span class="token function">nodemon</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nnodemon<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'quit\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> packageJsonPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'package.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// checks for available update and returns an instance</span>\n<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>packageJsonPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'0.0.0\'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>noUpdateNotifier <span class="token operator">!==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'update-notifier\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pkg <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nodemon.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28902782381401137000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;restartable&quot;: &quot;rs&quot;,\n  &quot;ignore&quot;: [&quot;.git&quot;, &quot;node_modules&quot;, &quot;node_modules/**/node_modules&quot;],\n  &quot;verbose&quot;: true,\n  &quot;execMap&quot;: {\n    &quot;js&quot;: &quot;node --harmony&quot;\n  },\n  &quot;events&quot;: {\n    &quot;restart&quot;: &quot;osascript -e \'display notification \\&quot;App restarted due to:\\n\'\\$FILENAME\'\\&quot; with title \\&quot;nodemon\\&quot;\'&quot;\n  },\n  &quot;watch&quot;: [\n    &quot;src/server&quot;,\n    &quot;src/common&quot;,\n    &quot;config.default.js&quot;,\n    &quot;node_modules/sugo-analytics-extend-*/extend/app/**/*&quot;,\n    &quot;config.js&quot;\n  ],\n  &quot;watchSymbolLink&quot;: [\n    {\n      &quot;url&quot;: &quot;node_modules/sugo-analytics-extend-*&quot;,\n      &quot;path&quot;: &quot;extend/app/**/*&quot;\n    }\n  ],\n  &quot;env&quot;: {\n    &quot;NODE_ENV&quot;: &quot;development&quot;\n  },\n  &quot;delay&quot;: &quot;1000&quot;,\n  &quot;ext&quot;: &quot;js,json&quot;\n}`, `28902782381401137000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>\n  <span class="token property">"restartable"</span><span class="token operator">:</span> <span class="token string">"rs"</span><span class="token punctuation">,</span>\n  <span class="token property">"ignore"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">".git"</span><span class="token punctuation">,</span> <span class="token string">"node_modules"</span><span class="token punctuation">,</span> <span class="token string">"node_modules/**/node_modules"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">"verbose"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token property">"execMap"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"js"</span><span class="token operator">:</span> <span class="token string">"node --harmony"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"events"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"restart"</span><span class="token operator">:</span> <span class="token string">"osascript -e \'display notification \\"App restarted due to:\\n\'$FILENAME\'\\" with title \\"nodemon\\"\'"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"watch"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n<span class="gatsby-highlight-code-line">    <span class="token string">"src/server"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token string">"src/common"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token string">"config.default.js"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token string">"node_modules/sugo-analytics-extend-*/extend/app/**/*"</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token string">"config.js"</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>  <span class="token property">"watchSymbolLink"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"node_modules/sugo-analytics-extend-*"</span><span class="token punctuation">,</span>\n      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"extend/app/**/*"</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">"NODE_ENV"</span><span class="token operator">:</span> <span class="token string">"development"</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token property">"delay"</span><span class="token operator">:</span> <span class="token string">"1000"</span><span class="token punctuation">,</span>\n  <span class="token property">"ext"</span><span class="token operator">:</span> <span class="token string">"js,json"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"项目架构 公司项目分为以下几种架构： 主项目-扩展项目：扩展项目前端独立，是以 npm…",timeToRead:3,tableOfContents:'<ul>\n<li><a href="/nodemon-monitor-link-changes/#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84">项目架构</a></li>\n<li><a href="/nodemon-monitor-link-changes/#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF">需求背景</a></li>\n<li><a href="/nodemon-monitor-link-changes/#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B">技术选型</a></li>\n<li>\n<p><a href="/nodemon-monitor-link-changes/#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B">解决过程</a></p>\n<ul>\n<li><a href="/nodemon-monitor-link-changes/#gulp-%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5">gulp 文件同步</a></li>\n<li><a href="/nodemon-monitor-link-changes/#nodemon--npm-link">nodemon + npm link</a></li>\n</ul>\n</li>\n</ul>',wordCount:{words:89},frontmatter:{date:"2021-01-05 10:02:54",path:"/nodemon-monitor-link-changes/",tags:"后端, nodejs, nodemon, 预研",title:"基于nodemon实现监听文件链接变化",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="简化版"><a href="#%E7%AE%80%E5%8C%96%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简化版</h1>\n<h2 id="代码"><a href="#%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码</h2>\n<p>这个 Promise 的实现不考虑任何异常情况，只考虑代码最简短，从而便于读者理解核心的异步链式调用原理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95004070395825780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Promise(fn) {\n  this.cbs = [];\n\n  const resolve = (value) => {\n    setTimeout(() => {\n      this.data = value;\n      this.cbs.forEach((cb) => cb(value));\n    });\n  };\n\n  fn(resolve);\n}\n\nPromise.prototype.then = function(onResolved) {\n  return new Promise((resolve) => {\n    this.cbs.push(() => {\n      const res = onResolved(this.data);\n      if (res instanceof Promise) {\n        res.then(resolve);\n      } else {\n        resolve(res);\n      }\n    });\n  });\n};`, `95004070395825780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>cbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> value<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>cbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">cb</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>cbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="核心案例"><a href="#%E6%A0%B8%E5%BF%83%E6%A1%88%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心案例</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84139679938308200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new Promise((resolve) => {\n  setTimeout(() => {\n    resolve(1);\n  }, 500);\n})\n  .then((res) => {\n    console.log(res);\n    return new Promise((resolve) => {\n      setTimeout(() => {\n        resolve(2);\n      }, 500);\n    });\n  })\n  .then(console.log);`, `84139679938308200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>本文将围绕这个最核心的案例来讲，这段代码的表现如下：</p>\n<ol>\n<li>500ms 后输出 1</li>\n<li>500ms 后输出 2</li>\n</ol>\n<h2 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h2>\n<h3 id="构造函数"><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构造函数</h3>\n<p>首先来实现 Promise 构造函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61260990496869380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Promise(fn) {\n  // Promise resolve 时的回调函数集\n  this.cbs = [];\n\n  // 传递给 Promise 处理函数的 resolve\n  // 这里直接往实例上挂个 data\n  // 然后把 onResolvedCallback 数组里的函数依次执行一遍就可以\n  const resolve = (value) => {\n    // 注意 promise 的 then 函数需要异步执行\n    setTimeout(() => {\n      this.data = value;\n      this.cbs.forEach((cb) => cb(value));\n    });\n  };\n\n  // 执行用户传入的函数\n  // 并且把 resolve 方法交给用户执行\n  fn(resolve);\n}`, `61260990496869380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Promise resolve 时的回调函数集</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>cbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 传递给 Promise 处理函数的 resolve</span>\n  <span class="token comment">// 这里直接往实例上挂个 data</span>\n  <span class="token comment">// 然后把 onResolvedCallback 数组里的函数依次执行一遍就可以</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 注意 promise 的 then 函数需要异步执行</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> value<span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>cbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">cb</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 执行用户传入的函数</span>\n  <span class="token comment">// 并且把 resolve 方法交给用户执行</span>\n  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>好，写到这里先回过头来看案例</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66782225266246935000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fn = (resolve) => {\n  setTimeout(() => {\n    resolve(1);\n  }, 500);\n};\n\nnew Promise(fn);`, `66782225266246935000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>分开来看，fn 就是用户传的函数，这个函数内部调用了 resolve 函数后，就会把 promise 实例上的 cbs 全部执行一遍。</p>\n<p>到此为止我们还不知道 cbs 这个数组里的函数是从哪里来的，接着往下看。</p>\n<h3 id="then"><a href="#then" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>then</h3>\n<p>这里是最重要的 then 实现，链式调用全靠它：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85962889094103940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Promise.prototype.then = function(onResolved) {\n  // 这里叫做 promise2\n  return new Promise((resolve) => {\n    this.cbs.push(() => {\n      const res = onResolved(this.data);\n      if (res instanceof Promise) {\n        // resolve 的权力被交给了 user promise\n        res.then(resolve);\n      } else {\n        // 如果是普通值就直接 resolve\n        // 依次执行 cbs 里的函数，并且把值传递给 cbs\n        resolve(res);\n      }\n    });\n  });\n};`, `85962889094103940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 这里叫做 promise2</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>cbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// resolve 的权力被交给了 user promise</span>\n        res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 如果是普通值就直接 resolve</span>\n        <span class="token comment">// 依次执行 cbs 里的函数，并且把值传递给 cbs</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再回到案例里</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87060198852630600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fn = (resolve) => {\n  setTimeout(() => {\n    resolve(1);\n  }, 500);\n};\n\nconst promise1 = new Promise(fn);\n\npromise1.then((res) => {\n  console.log(res);\n  // user promise\n  return new Promise((resolve) => {\n    setTimeout(() => {\n      resolve(2);\n    }, 500);\n  });\n});`, `87060198852630600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> promise1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\npromise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// user promise</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意这里的命名：</p>\n<ol>\n<li>我们把 new Promise 返回的实例叫做 promise1</li>\n<li>在 Promise.prototype.then 的实现中，我们构造了一个新的 promise 返回，叫它 promise2</li>\n<li>在用户调用 then 方法的时候，用户手动构造了一个 promise 并且返回，用来做异步的操作，叫它 user promise</li>\n</ol>\n<p>那么在 then 的实现中，内部的 this 其实就指向 promise1</p>\n<p>而 promise2 的传入的 fn 函数执行了一个 this.cbs.push()，其实是往 promise1 的 cbs 数组中 push 了一个函数，等待后续执行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30314510279211217000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Promise.prototype.then = function(onResolved) {\n  // 这里叫做promise2\n  return new Promise((resolve) => {\n    // 这里的this其实是promise1\n    this.cbs.push(() => {});\n  });\n};`, `30314510279211217000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onResolved</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 这里叫做promise2</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 这里的this其实是promise1</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>cbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么重点看这个 push 的函数，注意，这个函数在 promise1 被 resolve 了以后才会执行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29325173804766290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// promise2\nreturn new Promise((resolve) => {\n  this.cbs.push(() => {\n    // onResolved 就对应 then 传入的函数\n    const res = onResolved(this.data);\n    // 例子中的情况 用户自己返回了一个user promise\n    if (res instanceof Promise) {\n      // user promise 的情况\n      // 用户会自己决定何时 resolve promise2\n      // 只有 promise2 被 resolve 以后\n      // then 下面的链式调用函数才会继续执行\n      res.then(resolve);\n    } else {\n      resolve(res);\n    }\n  });\n});`, `29325173804766290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// promise2</span>\n<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>cbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// onResolved 就对应 then 传入的函数</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 例子中的情况 用户自己返回了一个user promise</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// user promise 的情况</span>\n      <span class="token comment">// 用户会自己决定何时 resolve promise2</span>\n      <span class="token comment">// 只有 promise2 被 resolve 以后</span>\n      <span class="token comment">// then 下面的链式调用函数才会继续执行</span>\n      res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果用户传入给 then 的 onResolved 方法返回的是个 user promise，那么这个 user promise 里用户会自己去在合适的时机 resolve promise2，那么进而这里的 res.then(resolve) 中的 resolve 就会被执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60328479245470020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (res instanceof Promise) {\n  res.then(resolve);\n}`, `60328479245470020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>结合下面这个例子来看：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94626362368965020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new Promise((resolve) => {\n  setTimeout(() => {\n    // resolve1\n    resolve(1);\n  }, 500);\n})\n  // then1\n  .then((res) => {\n    console.log(res);\n    // user promise\n    return new Promise((resolve) => {\n      setTimeout(() => {\n        // resolve2\n        resolve(2);\n      }, 500);\n    });\n  })\n  // then2\n  .then(console.log);`, `94626362368965020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// resolve1</span>\n    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// then1</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// user promise</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// resolve2</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// then2</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>then1 这一整块其实返回的是 promise2，那么 then2 其实本质上是 promise2.then(console.log)，也就是说 then2 注册的回调函数，其实进入了 promise2 的 cbs 回调数组里，又因为我们刚刚知道，resolve2 调用了之后，user promise 会被 resolve，进而触发 promise2 被 resolve，进而 promise2 里的 cbs 数组被依次触发。</p>\n<p>这样就实现了用户自己写的 resolve2 执行完毕后，then2 里的逻辑才会继续执行，也就是异步链式调用。</p>\n<h1 id="完整版"><a href="#%E5%AE%8C%E6%95%B4%E7%89%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>完整版</h1>\n<h2 id="promise-标准解读"><a href="#promise-%E6%A0%87%E5%87%86%E8%A7%A3%E8%AF%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 标准解读</h2>\n<ol>\n<li>\n<p>只有一个 then 方法，没有 catch，race，all 等方法，甚至没有构造函数</p>\n<p>Promise 标准中仅指定了 Promise 对象的 then 方法的行为，其它一切我们常见的方法/函数都并没有指定，包括 catch，race，all 等常用方法，甚至也没有指定该如何构造出一个 Promise 对象，另外 then 也没有一般实现中（Q, $q 等）所支持的第三个参数，一般称 onProgress</p>\n</li>\n<li>\n<p>then 方法返回一个新的 Promise</p>\n<p>Promise 的 then 方法返回一个新的 Promise，而不是返回 this，此处在下文会有更多解释</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38318301085370400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`promise2 = promise1.then(alert);\npromise2 != promise1; // true`, `38318301085370400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>alert<span class="token punctuation">)</span><span class="token punctuation">;</span>\npromise2 <span class="token operator">!=</span> promise1<span class="token punctuation">;</span> <span class="token comment">// true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>不同 Promise 的实现需要可以相互调用(interoperable)</p>\n</li>\n<li>\n<p>Promise 的初始状态为 pending，它可以由此状态转换为 fulfilled（本文为了一致把此状态叫做 resolved）或者 rejected，一旦状态确定，就不可以再次转换为其它状态，状态确定的过程称为 settle</p>\n</li>\n</ol>\n<h2 id="构造函数-1"><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构造函数</h2>\n<p>因为标准并没有指定如何构造一个 Promise 对象，所以我们同样以目前一般 Promise 实现中通用的方法来构造一个 Promise 对象，也是 ES6 原生 Promise 里所使用的方式，即：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26474246170779468000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Promise 构造函数接收一个 executor 函数，executor 函数执行完同步或异步操作后，调用它的两个参数 resolve 和 reject\nvar promise = new Promise(function(resolve, reject) {\n  /*\n    如果操作成功，调用 resolve 并传入 value\n    如果操作失败，调用 reject 并传入 reason\n  */\n});`, `26474246170779468000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Promise 构造函数接收一个 executor 函数，executor 函数执行完同步或异步操作后，调用它的两个参数 resolve 和 reject</span>\n<span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">/*\n    如果操作成功，调用 resolve 并传入 value\n    如果操作失败，调用 reject 并传入 reason\n  */</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们先实现构造函数的框架如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86814641961938110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Promise(executor) {\n  var self = this;\n  self.status = \'pending\'; // Promise 当前的状态\n  self.data = undefined; // Promise 的值\n  self.onResolvedCallback = []; // Promise resolve 时的回调函数集，因为在 Promise 结束之前有可能有多个回调添加到它上面\n  self.onRejectedCallback = []; // Promise reject 时的回调函数集，因为在 Promise 结束之前有可能有多个回调添加到它上面\n\n  executor(resolve, reject); // 执行 executor 并传入相应的参数\n}`, `86814641961938110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">\'pending\'</span><span class="token punctuation">;</span> <span class="token comment">// Promise 当前的状态</span>\n  self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// Promise 的值</span>\n  self<span class="token punctuation">.</span>onResolvedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Promise resolve 时的回调函数集，因为在 Promise 结束之前有可能有多个回调添加到它上面</span>\n  self<span class="token punctuation">.</span>onRejectedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Promise reject 时的回调函数集，因为在 Promise 结束之前有可能有多个回调添加到它上面</span>\n\n  <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行 executor 并传入相应的参数</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码基本实现了 Promise 构造函数的主体，但目前还有两个问题：</p>\n<ol>\n<li>\n<p>我们给 executor 函数传了两个参数：resolve 和 reject，这两个参数目前还没有定义</p>\n</li>\n<li>\n<p>executor 有可能会出错（throw），类似下面这样，而如果 executor 出错，Promise 应该被其 throw 出的值 reject：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="704691859486716900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new Promise(function(resolve, reject) {\n throw 2;\n});`, `704691859486716900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">throw</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>所以我们需要在构造函数里定义 resolve 和 reject 这两个函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30561898282703925000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Promise(executor) {\n  var self = this;\n  self.status = \'pending\'; // Promise 当前的状态\n  self.data = undefined; // Promise 的值\n  self.onResolvedCallback = []; // Promise resolve 时的回调函数集，因为在 Promise 结束之前有可能有多个回调添加到它上面\n  self.onRejectedCallback = []; // Promise reject 时的回调函数集，因为在 Promise 结束之前有可能有多个回调添加到它上面\n\n  function resolve(value) {}\n\n  function reject(reason) {}\n\n  try {\n    // 考虑到执行 executor 的过程中有可能出错，所以我们用 try/catch 块给包起来，并且在出错后以 catch 到的值 reject 掉这个 Promise\n    executor(resolve, reject); // 执行executor\n  } catch (e) {\n    reject(e);\n  }\n}`, `30561898282703925000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">\'pending\'</span><span class="token punctuation">;</span> <span class="token comment">// Promise 当前的状态</span>\n  self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// Promise 的值</span>\n  self<span class="token punctuation">.</span>onResolvedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Promise resolve 时的回调函数集，因为在 Promise 结束之前有可能有多个回调添加到它上面</span>\n  self<span class="token punctuation">.</span>onRejectedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Promise reject 时的回调函数集，因为在 Promise 结束之前有可能有多个回调添加到它上面</span>\n\n  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 考虑到执行 executor 的过程中有可能出错，所以我们用 try/catch 块给包起来，并且在出错后以 catch 到的值 reject 掉这个 Promise</span>\n    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行executor</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有人可能会问，resolve 和 reject 这两个函数能不能不定义在构造函数里呢？考虑到我们在 executor 函数里是以 resolve(value)，reject(reason) 的形式调用的这两个函数，而不是以 resolve.call(promise, value)，reject.call(promise, reason) 这种形式调用的，所以这两个函数在调用时的内部也必然有一个隐含的 this，也就是说，要么这两个函数是经过 bind 后传给了 executor，要么它们定义在构造函数的内部，使用 self 来访问所属的 Promise 对象。所以如果我们想把这两个函数定义在构造函数的外部，确实是可以这么写的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82614050998211460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function resolve() {}\nfunction reject() {}\nfunction Promise(executor) {\n  try {\n    executor(resolve.bind(this), reject.bind(this));\n  } catch (e) {\n    reject.bind(this)(e);\n  }\n}`, `82614050998211460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token function">executor</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">reject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">reject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是众所周知，bind 也会返回一个新的函数，这么一来还是相当于每个 Promise 对象都有一对属于自己的 resolve 和 reject 函数，就跟写在构造函数内部没什么区别了，所以我们就直接把这两个函数定义在构造函数里面了。不过话说回来，如果浏览器对 bind 有优化，使用后一种形式应该可以提升一下内存使用效率。</p>\n<p>另外我们这里的实现并没有考虑隐藏 this 上的变量，这使得这个 Promise 的状态可以在 executor 函数外部被改变，在一个靠谱的实现里，构造出的 Promise 对象的状态和最终结果应当是无法从外部更改的。</p>\n<p>接下来，我们实现 resolve 和 reject 这两个函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32798264621669036000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Promise(executor) {\n  // ...\n\n  function resolve(value) {\n    if (self.status === \'pending\') {\n      self.status = \'resolved\';\n      self.data = value;\n      for (var i = 0; i < self.onResolvedCallback.length; i++) {\n        self.onResolvedCallback[i](value);\n      }\n    }\n  }\n\n  function reject(reason) {\n    if (self.status === \'pending\') {\n      self.status = \'rejected\';\n      self.data = reason;\n      for (var i = 0; i < self.onRejectedCallback.length; i++) {\n        self.onRejectedCallback[i](reason);\n      }\n    }\n  }\n\n  // ...\n}`, `32798264621669036000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">\'pending\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">\'resolved\'</span><span class="token punctuation">;</span>\n      self<span class="token punctuation">.</span>data <span class="token operator">=</span> value<span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>onResolvedCallback<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        self<span class="token punctuation">.</span>onResolvedCallback<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">\'pending\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">\'rejected\'</span><span class="token punctuation">;</span>\n      self<span class="token punctuation">.</span>data <span class="token operator">=</span> reason<span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        self<span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基本上就是在判断状态为 pending 之后把状态改为相应的值，并把对应的 value 和 reason 存在 self 的 data 属性上面，之后执行相应的回调函数，逻辑很简单，这里就不多解释了。</p>\n<p>// TODO <a href="https://github.com/xieranmaya/blog/issues/3" target="_blank" rel="nofollow noreferrer noopener">https://github.com/xieranmaya/blog/issues/3</a></p>',
excerpt:"简化版 代码 这个 Promise 的实现不考虑任何异常情况，只考虑代码最简短，从而便于读者理解核心的异步链式调用原理。 核心案例 本文将围绕这个最核心的案例来讲，这段代码的表现如下： 500ms 后输出 1 500ms 后输出 2 实现 构造函数 首先来实现 Promise…",frontmatter:{date:"2020-12-25 10:59:33",path:"/promise-implementation-principle/",tags:"前端, JS, 高级前端",title:"Promise 实现原理",draft:null}},prePost:{html:'<h1 id="前置知识"><a href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前置知识</h1>\n<p><div class="gatsby-highlight">\n        <pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">database</span>  <span class="token keyword">if</span> <span class="token keyword">exists</span> Student_Course_Database <span class="token punctuation">;</span>\r\n<span class="token keyword">create</span> <span class="token keyword">database</span> Student_Course_Database<span class="token punctuation">;</span>\r\n<span class="token keyword">alter</span> <span class="token keyword">database</span> Student_Course_Database <span class="token keyword">character</span> <span class="token keyword">set</span> utf8<span class="token punctuation">;</span>\r\n<span class="token keyword">use</span> Student_Course_Database<span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">create</span> <span class="token keyword">table</span> student\r\n<span class="token punctuation">(</span>sno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>\r\n sname <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unique</span><span class="token punctuation">,</span>\r\n ssex <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n sage <span class="token keyword">smallint</span><span class="token punctuation">,</span>\r\n sdept <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>\r\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">create</span> <span class="token keyword">table</span> course\r\n<span class="token punctuation">(</span>cno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>\r\n cname <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n cpno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n ccredit <span class="token keyword">smallint</span><span class="token punctuation">,</span>\r\n <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>cpno<span class="token punctuation">)</span> <span class="token keyword">references</span> course<span class="token punctuation">(</span>cno<span class="token punctuation">)</span>\r\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">create</span> <span class="token keyword">table</span> sc\r\n<span class="token punctuation">(</span>sno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\ncno <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\ngrade <span class="token keyword">smallint</span> <span class="token punctuation">,</span>\r\n<span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>sno<span class="token punctuation">,</span>cno<span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n<span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>sno<span class="token punctuation">)</span> <span class="token keyword">references</span> student<span class="token punctuation">(</span>sno<span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n<span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>cno<span class="token punctuation">)</span> <span class="token keyword">references</span> course<span class="token punctuation">(</span>cno<span class="token punctuation">)</span>\r\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'李勇\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215122\'</span><span class="token punctuation">,</span><span class="token string">\'刘晨\'</span><span class="token punctuation">,</span><span class="token string">\'女\'</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215123\'</span><span class="token punctuation">,</span><span class="token string">\'王敏\'</span><span class="token punctuation">,</span><span class="token string">\'女\'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">\'MA\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215125\'</span><span class="token punctuation">,</span><span class="token string">\'张立\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">\'IS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215124\'</span><span class="token punctuation">,</span><span class="token string">\'刘武汉\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token string">\'PE\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215126\'</span><span class="token punctuation">,</span><span class="token string">\'李四\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">\'MA\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215128\'</span><span class="token punctuation">,</span><span class="token string">\'欧阳雨\'</span><span class="token punctuation">,</span><span class="token string">\'女\'</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215127\'</span><span class="token punctuation">,</span><span class="token string">\'欧阳杰\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string">\'PY\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course<span class="token punctuation">(</span>Cno<span class="token punctuation">,</span>Cname<span class="token punctuation">,</span>Ccredit<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token string">\'数据处理\'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course<span class="token punctuation">(</span>Cno<span class="token punctuation">,</span>Cname<span class="token punctuation">,</span>Ccredit<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'2\'</span><span class="token punctuation">,</span><span class="token string">\'数学\'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'8\'</span><span class="token punctuation">,</span><span class="token string">\'数字系统设计\'</span><span class="token punctuation">,</span><span class="token string">\'2\'</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'7\'</span><span class="token punctuation">,</span><span class="token string">\'PASCAL语言\'</span><span class="token punctuation">,</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'5\'</span><span class="token punctuation">,</span><span class="token string">\'数据结构\'</span><span class="token punctuation">,</span><span class="token string">\'7\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'4\'</span><span class="token punctuation">,</span><span class="token string">\'操作系统\'</span><span class="token punctuation">,</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token string">\'数据库\'</span><span class="token punctuation">,</span><span class="token string">\'5\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'3\'</span><span class="token punctuation">,</span><span class="token string">\'信息系统\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> course <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'9\'</span><span class="token punctuation">,</span><span class="token string">\'DB_Design\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token number">92</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'2\'</span><span class="token punctuation">,</span><span class="token number">85</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'3\'</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'4\'</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215121\'</span><span class="token punctuation">,</span><span class="token string">\'5\'</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215122\'</span><span class="token punctuation">,</span><span class="token string">\'2\'</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215122\'</span><span class="token punctuation">,</span><span class="token string">\'4\'</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215122\'</span><span class="token punctuation">,</span><span class="token string">\'3\'</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215123\'</span><span class="token punctuation">,</span><span class="token string">\'6\'</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215123\'</span><span class="token punctuation">,</span><span class="token string">\'5\'</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>cno<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">\'200215127\'</span><span class="token punctuation">,</span><span class="token string">\'2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token comment">#1</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#2</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sno<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#3</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#4</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span><span class="token number">2004</span><span class="token operator">-</span>sage <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#5</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span><span class="token string">\'Year of Birth:\'</span><span class="token punctuation">,</span><span class="token number">2004</span><span class="token operator">-</span>sage<span class="token punctuation">,</span>lower<span class="token punctuation">(</span>sdept<span class="token punctuation">)</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname NAME<span class="token punctuation">,</span><span class="token string">\'Year of Birth:\'</span> BIRTH<span class="token punctuation">,</span><span class="token number">2004</span><span class="token operator">-</span>sage BIRTHDAY<span class="token punctuation">,</span>lower<span class="token punctuation">(</span>sdept<span class="token punctuation">)</span> DEPARTMENT <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#6</span>\r\n<span class="token keyword">select</span> <span class="token keyword">all</span> sno <span class="token keyword">from</span> sc<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> <span class="token keyword">distinct</span> sno <span class="token keyword">from</span> sc<span class="token punctuation">;</span>\r\n<span class="token comment">#7</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#8</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>\r\n<span class="token comment">#9</span>\r\n<span class="token keyword">select</span> <span class="token keyword">distinct</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> grade<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>\r\n<span class="token comment">#10</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage <span class="token operator">between</span> <span class="token number">20</span> <span class="token operator">and</span> <span class="token number">23</span><span class="token punctuation">;</span>\r\n<span class="token comment">#11</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage <span class="token operator">not</span> <span class="token operator">between</span> <span class="token number">20</span> <span class="token operator">and</span> <span class="token number">23</span><span class="token punctuation">;</span>\r\n<span class="token comment">#12</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">\'CS\'</span><span class="token punctuation">,</span><span class="token string">\'MA\'</span><span class="token punctuation">,</span><span class="token string">\'IS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#13</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">\'CS\'</span><span class="token punctuation">,</span><span class="token string">\'MA\'</span><span class="token punctuation">,</span><span class="token string">\'IS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#14</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sno <span class="token operator">like</span> <span class="token string">\'200215121\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#15</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sno<span class="token punctuation">,</span>ssex <span class="token keyword">from</span> student <span class="token keyword">where</span> sname <span class="token operator">like</span> <span class="token string">\'刘%\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#16</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> sname <span class="token operator">like</span> <span class="token string">\'欧阳_\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#17</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sno <span class="token keyword">from</span> student <span class="token keyword">where</span> sname <span class="token operator">like</span> <span class="token string">\'_阳%\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#18</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sno<span class="token punctuation">,</span>ssex <span class="token keyword">from</span> student <span class="token keyword">where</span> sname <span class="token operator">not</span> <span class="token operator">like</span> <span class="token string">\'刘%\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#19</span>\r\n<span class="token keyword">select</span> cno<span class="token punctuation">,</span>ccredit <span class="token keyword">from</span> course <span class="token keyword">where</span> cname <span class="token operator">like</span> <span class="token string">\'DB@_Design\'</span> <span class="token keyword">escape</span> <span class="token string">\'@\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> cno<span class="token punctuation">,</span>ccredit <span class="token keyword">from</span> course <span class="token keyword">where</span> cname <span class="token operator">=</span> <span class="token string">\'DB_Design\'</span> <span class="token punctuation">;</span>\r\n<span class="token comment">#20</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> course <span class="token keyword">where</span> cname <span class="token operator">like</span> <span class="token string">\'DB@_%i__\'</span><span class="token keyword">escape</span> <span class="token string">\'@\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#21</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>cno <span class="token keyword">from</span> sc <span class="token keyword">where</span> grade <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span>\r\n#<span class="token number">22</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>cno <span class="token keyword">from</span> sc <span class="token keyword">where</span> grade <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>\r\n#<span class="token number">23</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> sage<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept <span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">or</span> sdept<span class="token operator">=</span><span class="token string">\'MA\'</span> <span class="token operator">or</span> sdept<span class="token operator">=</span><span class="token string">\'IS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#24</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'2\'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> grade <span class="token keyword">desc</span><span class="token punctuation">;</span>\r\n<span class="token comment">#25</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">order</span> <span class="token keyword">by</span> sdept<span class="token punctuation">,</span>sage <span class="token keyword">desc</span><span class="token punctuation">;</span>\r\n<span class="token comment">#26</span>\r\n<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#27</span>\r\n<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> sno<span class="token punctuation">)</span> <span class="token keyword">from</span> sc<span class="token punctuation">;</span>\r\n<span class="token comment">#28</span>\r\n<span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'3\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#29</span>\r\n<span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span><span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'3\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#30</span>\r\n<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>ccredit<span class="token punctuation">)</span> <span class="token keyword">from</span> sc<span class="token punctuation">,</span>course <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215122\'</span> <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span>course<span class="token punctuation">.</span>cno<span class="token punctuation">;</span>\r\n<span class="token comment">#31</span>\r\n<span class="token keyword">select</span> cno<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>sno<span class="token punctuation">)</span> <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> cno<span class="token punctuation">;</span>\r\n<span class="token comment">#32</span>\r\n<span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> sno <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">3</span><span class="token punctuation">;</span>\r\n<span class="token comment">#33 在使用 join 时，on 和 where 条件的区别: on 条件是在生成临时表时使用的条件，它不管 on 中的条件是否为真，都会返回左边表中的记录。where 条件是在临时表生成好后，再对临时表进行过滤的条件。</span>\r\n<span class="token comment"># 同 join</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 在表中存在至少一个匹配时返回行，即求交集</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 同 join</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">inner</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 即使右表中没有匹配，也从左表返回所有的行</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">left</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 即使左表中没有匹配，也从右表返回所有的行</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">right</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment"># 只要其中一个表中存在匹配，就返回行，mysql 不支持</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>sc<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment">#34</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">;</span>\r\n<span class="token comment">#35</span>\r\n<span class="token keyword">select</span> <span class="token keyword">first</span><span class="token punctuation">.</span>cno<span class="token punctuation">,</span><span class="token keyword">second</span><span class="token punctuation">.</span>cpno <span class="token keyword">from</span> course <span class="token keyword">first</span><span class="token punctuation">,</span>course <span class="token keyword">second</span> <span class="token keyword">where</span> <span class="token keyword">first</span><span class="token punctuation">.</span>cpno<span class="token operator">=</span><span class="token keyword">second</span><span class="token punctuation">.</span>cno<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> <span class="token keyword">first</span><span class="token punctuation">.</span>cno<span class="token punctuation">,</span><span class="token keyword">second</span><span class="token punctuation">.</span>cpno <span class="token keyword">from</span> course <span class="token keyword">first</span><span class="token punctuation">,</span>course <span class="token keyword">second</span> <span class="token keyword">where</span> <span class="token keyword">first</span><span class="token punctuation">.</span>cpno<span class="token operator">=</span><span class="token keyword">second</span><span class="token punctuation">.</span>cno <span class="token operator">and</span> <span class="token keyword">second</span><span class="token punctuation">.</span>cpno <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">;</span>\r\n<span class="token comment">#36</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student <span class="token keyword">left</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student <span class="token keyword">left</span> <span class="token keyword">join</span> sc <span class="token keyword">using</span><span class="token punctuation">(</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student <span class="token keyword">right</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>cno<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student <span class="token keyword">right</span> <span class="token keyword">join</span> sc <span class="token keyword">on</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#37</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span> <span class="token operator">and</span> grade<span class="token operator">></span><span class="token number">90</span><span class="token punctuation">;</span>\r\n<span class="token comment">#38</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>cname<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc<span class="token punctuation">,</span>course <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span>course<span class="token punctuation">.</span>cno<span class="token punctuation">;</span>\r\n<span class="token comment">#39 和刘晨是相同专业的同学，一对多查询模板</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> sname<span class="token operator">=</span><span class="token string">\'刘晨\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> s1<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>s1<span class="token punctuation">.</span>sname<span class="token punctuation">,</span>s1<span class="token punctuation">.</span>sdept <span class="token keyword">from</span> student s1<span class="token punctuation">,</span>student s2 <span class="token keyword">where</span> s1<span class="token punctuation">.</span>sdept<span class="token operator">=</span>s2<span class="token punctuation">.</span>sdept <span class="token operator">and</span> s2<span class="token punctuation">.</span>sname<span class="token operator">=</span><span class="token string">\'刘晨\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sdept <span class="token keyword">from</span> student s1 <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student s2 <span class="token keyword">where</span> s2<span class="token punctuation">.</span>sdept<span class="token operator">=</span>s1<span class="token punctuation">.</span>sdept <span class="token operator">and</span> s2<span class="token punctuation">.</span>sname<span class="token operator">=</span><span class="token string">\'刘晨\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#40 学信息系统课程的有谁</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> student <span class="token keyword">where</span> sno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> cno <span class="token keyword">from</span> course <span class="token keyword">where</span> cname<span class="token operator">=</span><span class="token string">\'信息系统\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc<span class="token punctuation">,</span>course <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span>course<span class="token punctuation">.</span>cno <span class="token operator">and</span> cname<span class="token operator">=</span><span class="token string">\'信息系统\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#41 每位同学成绩大于所选课程平均分的课程</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>cno <span class="token keyword">from</span> sc x <span class="token keyword">where</span> grade<span class="token operator">>=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">from</span> sc y <span class="token keyword">where</span> y<span class="token punctuation">.</span>sno<span class="token operator">=</span>x<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sc<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>cno <span class="token keyword">from</span> sc<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> sno<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> A_G <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> sno<span class="token punctuation">)</span> y <span class="token keyword">where</span> sc<span class="token punctuation">.</span>sno<span class="token operator">=</span>y<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>grade<span class="token operator">>=</span>y<span class="token punctuation">.</span>A_G<span class="token punctuation">;</span>\r\n<span class="token comment">#42 非 CS 专业下年龄小于 CS 的最大年龄的</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token punctuation">(</span><span class="token keyword">select</span> sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span> <span class="token operator">and</span> sdept<span class="token operator">&lt;></span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>sage<span class="token punctuation">)</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token operator">and</span> sdept<span class="token operator">&lt;></span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#43 非 CS 专业下年龄小于 CS 的最小年龄的</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token keyword">all</span><span class="token punctuation">(</span><span class="token keyword">select</span> sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token operator">and</span> sdept<span class="token operator">&lt;></span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>sage<span class="token punctuation">)</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token operator">and</span> sdept<span class="token operator">&lt;></span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#44 学数据库的同学有谁</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> sno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student<span class="token punctuation">,</span> sc <span class="token keyword">where</span> sc<span class="token punctuation">.</span>sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#45 不学数据库的同学有谁</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#46 </span>\r\n<span class="token comment"># 查询选修了全部课程的学生姓名</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> course <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> cno<span class="token operator">=</span>course<span class="token punctuation">.</span>cno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment"># 查询选修了全部已开课程的学生姓名</span>\r\n<span class="token keyword">select</span> sname <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc x <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc y <span class="token keyword">where</span> sno<span class="token operator">=</span>student<span class="token punctuation">.</span>sno <span class="token operator">and</span> x<span class="token punctuation">.</span>cno<span class="token operator">=</span>y<span class="token punctuation">.</span>cno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#47</span>\r\n<span class="token comment"># 查询至少选修了学生200215122选修的全部课程的学生号码</span>\r\n<span class="token keyword">select</span> <span class="token keyword">distinct</span> sno <span class="token keyword">from</span> sc scx <span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc scy <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215122\'</span> <span class="token operator">and</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sc scz <span class="token keyword">where</span> scz<span class="token punctuation">.</span>sno<span class="token operator">=</span>scx<span class="token punctuation">.</span>sno <span class="token operator">and</span> scz<span class="token punctuation">.</span>cno<span class="token operator">=</span>scy<span class="token punctuation">.</span>cno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#48</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sage<span class="token operator">&lt;=</span><span class="token number">19</span><span class="token punctuation">;</span>\r\n<span class="token comment">#49</span>\r\n<span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span> <span class="token keyword">union</span> <span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'2\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#50 学cs同时不小于19岁的</span>\r\n<span class="token comment">-- select * from student where sdept=\'CS\' intersect select * from student where sage&lt;=19;</span>\r\n<span class="token keyword">select</span> s1<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> student s1 <span class="token keyword">left</span> <span class="token keyword">join</span> student s2 <span class="token keyword">on</span> s1<span class="token punctuation">.</span>sno<span class="token operator">=</span>s2<span class="token punctuation">.</span>sno <span class="token keyword">where</span> s1<span class="token punctuation">.</span>sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> s1<span class="token punctuation">.</span>sage<span class="token operator">&lt;=</span><span class="token number">19</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> sage<span class="token operator">&lt;=</span><span class="token number">19</span><span class="token punctuation">;</span>\r\n<span class="token comment">#51</span>\r\n<span class="token comment">#select sno from sc where cno=\'1\' intersect select sno from sc where cno=\'2\';</span>\r\n<span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'1\'</span> <span class="token operator">and</span> sno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sno <span class="token keyword">from</span> sc <span class="token keyword">where</span> cno<span class="token operator">=</span><span class="token string">\'2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> scx<span class="token punctuation">.</span>sno <span class="token keyword">from</span> sc scx<span class="token punctuation">,</span>sc scy <span class="token keyword">where</span> scx<span class="token punctuation">.</span>sno<span class="token operator">=</span>scy<span class="token punctuation">.</span>sno <span class="token operator">and</span> scx<span class="token punctuation">.</span>cno<span class="token operator">=</span><span class="token string">\'1\'</span> <span class="token operator">and</span> scy<span class="token punctuation">.</span>cno<span class="token operator">=</span><span class="token string">\'2\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#52</span>\r\n<span class="token comment">#select * from student where sdept=\'CS\' except select * from student where sage&lt;=19;</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> sage<span class="token operator">></span><span class="token number">19</span><span class="token punctuation">;</span>\r\n<span class="token comment">#53</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>ssex<span class="token punctuation">,</span>sdept<span class="token punctuation">,</span>sage<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215129\'</span><span class="token punctuation">,</span><span class="token string">\'陈东\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token string">\'IS\'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#54</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215130\'</span><span class="token punctuation">,</span><span class="token string">\'张成民\'</span><span class="token punctuation">,</span><span class="token string">\'男\'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#55</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token punctuation">(</span>sno<span class="token punctuation">,</span>cno<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215128\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> sc <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215129\'</span><span class="token punctuation">,</span><span class="token string">\'1\'</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#56</span>\r\n<span class="token keyword">create</span> <span class="token keyword">table</span> dept_age\r\n<span class="token punctuation">(</span>\r\n sdept <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\r\n avg_age <span class="token keyword">smallint</span>\r\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> dept_age <span class="token punctuation">(</span>sdept<span class="token punctuation">,</span>avg_age<span class="token punctuation">)</span> <span class="token keyword">select</span> sdept<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>sage<span class="token punctuation">)</span> <span class="token keyword">from</span> student <span class="token keyword">group</span> <span class="token keyword">by</span> sdept<span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_age<span class="token punctuation">;</span>\r\n<span class="token comment">#57</span>\r\n<span class="token keyword">update</span> student <span class="token keyword">set</span> sage<span class="token operator">=</span><span class="token number">22</span> <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215121\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#58</span>\r\n<span class="token keyword">update</span> student <span class="token keyword">set</span> sage<span class="token operator">=</span>sage<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>\r\n<span class="token comment">#59</span>\r\n<span class="token keyword">update</span> sc <span class="token keyword">set</span> grade<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">where</span> <span class="token string">\'CS\'</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">select</span> sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">update</span> sc <span class="token keyword">set</span> grade<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> sno <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> sno <span class="token keyword">from</span>  student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#60\t建立计算机系学生的视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> CS_Student <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#61\t建立计算机系学生的视图，并按要求进行修改和插入时仍需保证该视图只有计算机系的学生</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> CS_Student_Check <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sage <span class="token keyword">from</span> student <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token keyword">with</span> <span class="token keyword">check</span> <span class="token keyword">option</span><span class="token punctuation">;</span>\r\n<span class="token comment">#62\t建立计算机系选修了1号课程的学生的视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> CS_S1<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>grade<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">select</span> student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>grade <span class="token keyword">from</span> student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span> <span class="token operator">and</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#63\t建立计算机系选修了1号课程且成绩在90分以上的学生的视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> CS_S2 <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>grade <span class="token keyword">from</span> CS_S1 <span class="token keyword">where</span> grade<span class="token operator">>=</span><span class="token number">90</span><span class="token punctuation">;</span>\r\n<span class="token comment">#64\t定义一个反映学生出生年份的视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> BT_S<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sbirth<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span><span class="token number">2004</span><span class="token operator">-</span>sage <span class="token keyword">from</span> student<span class="token punctuation">;</span>\r\n<span class="token comment">#65 将学生的学号及他的平均成绩定义为一个视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> S_G<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>gavg<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">select</span> sno<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> sno<span class="token punctuation">;</span>\r\n<span class="token comment">#66\t将student表中的所有女生记录定义为一个视图</span>\r\n<span class="token keyword">create</span> <span class="token keyword">view</span> F_Student <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> ssex<span class="token operator">=</span><span class="token string">\'女\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#67\t在计算机系学生的视图中找出年龄小于20岁的学生</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span>sage <span class="token keyword">from</span> CS_Student <span class="token keyword">where</span> sage<span class="token operator">&lt;=</span><span class="token number">20</span><span class="token punctuation">;</span>\r\n<span class="token comment">#68\t查询选修了1号课程的计算机系的学生</span>\r\n<span class="token keyword">select</span> CS_Student<span class="token punctuation">.</span>sno<span class="token punctuation">,</span>sname <span class="token keyword">from</span> CS_Student<span class="token punctuation">,</span>sc <span class="token keyword">where</span> CS_Student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno <span class="token operator">and</span> sc<span class="token punctuation">.</span>cno<span class="token operator">=</span><span class="token string">\'1\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#69\t在S_G视图中查询平均成绩在90分以上的学生学号和平均成绩</span>\r\n<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> S_G <span class="token keyword">where</span> gavg<span class="token operator">>=</span><span class="token number">90</span><span class="token punctuation">;</span>\r\n<span class="token keyword">select</span> sno<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span> <span class="token keyword">from</span> sc <span class="token keyword">group</span> <span class="token keyword">by</span> sno <span class="token keyword">having</span> <span class="token function">avg</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">90</span><span class="token punctuation">;</span>\r\n<span class="token comment">#70\t将计算机系学生视图CS_Student中学号为200215122的学生姓名改为刘辰</span>\r\n<span class="token keyword">update</span> CS_Student <span class="token keyword">set</span> sname<span class="token operator">=</span><span class="token string">\'刘辰\'</span> <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215122\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">update</span> student <span class="token keyword">set</span> sname<span class="token operator">=</span><span class="token string">\'刘辰\'</span> <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215122\'</span> <span class="token operator">and</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#71\t向计算机系的学生视图CS_Student中插入一个新的学生记录，其中学号为200215129，姓名为赵新，年龄为20岁</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> CS_Student <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215131\'</span><span class="token punctuation">,</span><span class="token string">\'赵新\'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">insert</span> <span class="token keyword">into</span> student<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>sdept<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">\'200215131\'</span><span class="token punctuation">,</span><span class="token string">\'赵新\'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">\'CS\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#72\t删除计算机学生视图CS_Student中学号为200215129的记录</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> CS_Student <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215131\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215131\'</span> <span class="token operator">and</span> sdept<span class="token operator">=</span><span class="token string">\'CS\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#60</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215128\'</span><span class="token punctuation">;</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">\'200215128\'</span><span class="token punctuation">;</span>\r\n<span class="token comment">#61</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> sc <span class="token keyword">where</span> <span class="token string">\'CS\'</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">select</span> sdept <span class="token keyword">from</span> student <span class="token keyword">where</span> student<span class="token punctuation">.</span>sno<span class="token operator">=</span>sc<span class="token punctuation">.</span>sno<span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token comment">#62</span>\r\n<span class="token keyword">delete</span> <span class="token keyword">from</span> sc<span class="token punctuation">;</span>\r\n<span class="token comment">#67 删除视图</span>\r\n<span class="token keyword">drop</span> <span class="token keyword">view</span>\tBT_S<span class="token punctuation">;</span>\r\n<span class="token keyword">drop</span> <span class="token keyword">view</span> CS_S1 <span class="token keyword">cascade</span><span class="token punctuation">;</span></code></pre>\n        </div></p>\n<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>已知始发站、终点站，如何查出满足条件的方案线路？即根据一个表关联多个表时如何查询相关字段？</p>\n<h1 id="sql-语句"><a href="#sql-%E8%AF%AD%E5%8F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sql 语句</h1>\n<p>根据以上的前置知识可得出一对多下的查询应该这样写：</p>\n<p><div class="gatsby-highlight">\n        <pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>sugo_train_scheme<span class="token punctuation">`</span><span class="token punctuation">;</span>\r\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>sugo_train_scheme<span class="token punctuation">`</span>  <span class="token punctuation">(</span>\r\n  <span class="token punctuation">`</span>created_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'创建时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>updated_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'更新时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>deleted_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'删除时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'主键ID\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'方案名称\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'方案报告状态，生成中：generating，已生成：generated\'</span><span class="token punctuation">,</span>\r\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\r\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">\'车次方案列表 \'</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'32\'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">,</span> <span class="token string">\'sfaf\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span><span class="token punctuation">;</span>\r\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span>  <span class="token punctuation">(</span>\r\n  <span class="token punctuation">`</span>created_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'创建时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>updated_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'更新时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>deleted_at<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'删除时间\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'主键ID\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>scheme_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'方案ID\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>zm<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'站名\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>zmdm<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'站名代码\'</span><span class="token punctuation">,</span>\r\n  <span class="token punctuation">`</span>zmlx<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">\'站名类型\'</span><span class="token punctuation">,</span>\r\n  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>\r\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">\'车次方案查询条件站点信息 \'</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span>\r\n\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'23\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'长沙\'</span><span class="token punctuation">,</span> <span class="token string">\'23\'</span><span class="token punctuation">,</span> <span class="token string">\'start\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'24\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'武汉\'</span><span class="token punctuation">,</span> <span class="token string">\'555\'</span><span class="token punctuation">,</span> <span class="token string">\'pass\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'25\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'湘潭\'</span><span class="token punctuation">,</span> <span class="token string">\'666\'</span><span class="token punctuation">,</span> <span class="token string">\'end\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'3\'</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">,</span> <span class="token string">\'武汉\'</span><span class="token punctuation">,</span> <span class="token string">\'555\'</span><span class="token punctuation">,</span> <span class="token string">\'start\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>sugo_train_scheme_ponit_info<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">\'4\'</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">,</span> <span class="token string">\'湘潭\'</span><span class="token punctuation">,</span> <span class="token string">\'666\'</span><span class="token punctuation">,</span> <span class="token string">\'end\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token comment"># 查一对多的方法，使用 in</span>\r\n<span class="token keyword">SELECT</span>\r\n\t<span class="token operator">*</span> \r\n<span class="token keyword">FROM</span>\r\n\tsugo_train_scheme a<span class="token punctuation">,</span>\r\n\tsugo_train_scheme_ponit_info b \r\n<span class="token keyword">WHERE</span>\r\n\ta<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>scheme_id \r\n\t<span class="token operator">AND</span> a<span class="token punctuation">.</span>id <span class="token operator">IN</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> scheme_id <span class="token keyword">FROM</span> sugo_train_scheme_ponit_info <span class="token keyword">WHERE</span> zmdm <span class="token operator">=</span> <span class="token string">\'23\'</span> <span class="token operator">AND</span> zmlx <span class="token operator">=</span> <span class="token string">\'start\'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>\r\n\r\n<span class="token comment"># 查一对多的方法，使用自连接</span>\r\n<span class="token keyword">SELECT</span>\r\n\ta<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>\r\n\tb<span class="token punctuation">.</span><span class="token operator">*</span> \r\n<span class="token keyword">FROM</span>\r\n\tsugo_train_scheme a<span class="token punctuation">,</span>\r\n\tsugo_train_scheme_ponit_info b<span class="token punctuation">,</span>\r\n\tsugo_train_scheme_ponit_info c \r\n<span class="token keyword">WHERE</span>\r\n\ta<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>scheme_id \r\n\t<span class="token operator">AND</span> b<span class="token punctuation">.</span>scheme_id <span class="token operator">=</span> c<span class="token punctuation">.</span>scheme_id \r\n\t<span class="token operator">AND</span> c<span class="token punctuation">.</span>zmdm <span class="token operator">=</span> <span class="token string">\'23\'</span> \r\n\t<span class="token operator">AND</span> c<span class="token punctuation">.</span>zmlx <span class="token operator">=</span> <span class="token string">\'start\'</span><span class="token punctuation">;</span>\r\n\r\n<span class="token comment"># 查一对多的方法，使用 exists，一次查询不能顺带查出线路表</span>\r\n<span class="token keyword">SELECT</span>\r\n\t<span class="token operator">*</span> \r\n<span class="token keyword">FROM</span>\r\n\tsugo_train_scheme a\r\n<span class="token keyword">WHERE</span>\r\n\t<span class="token keyword">EXISTS</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sugo_train_scheme_ponit_info b <span class="token keyword">WHERE</span> b<span class="token punctuation">.</span>scheme_id<span class="token operator">=</span>a<span class="token punctuation">.</span>id <span class="token operator">and</span> b<span class="token punctuation">.</span>zmdm <span class="token operator">=</span> <span class="token string">\'23\'</span> <span class="token operator">AND</span> b<span class="token punctuation">.</span>zmlx <span class="token operator">=</span> <span class="token string">\'start\'</span> <span class="token punctuation">)</span></code></pre>\n        </div></p>\n<h1 id="sequelize-下的解决方案"><a href="#sequelize-%E4%B8%8B%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sequelize 下的解决方案</h1>\n<ol>\n<li>从表的设计上考虑：将始发站、终点站写在主表中，无需考虑一对多的问题</li>\n<li>根据以上的 sql 语句利用 Sequelize 去关联</li>\n</ol>\n<p>最终为了实现上的简便，直接使用方案 1</p>',
excerpt:"前置知识 需求背景 已知始发站、终点站，如何查出满足条件的方案线路？即根据一个表关联多个表时如何查询相关字段？ sql 语句 根据以上的前置知识可得出一对多下的查询应该这样写： Sequelize…",frontmatter:{date:"2021-01-05 13:55:57",path:"/sequelize-one-to-many-find-solution/",tags:"后端, nodejs, Sequelize, SQL",title:"Sequelize一对多查询解决方案",draft:null}}},pathContext:{mainPostPath:"/nodemon-monitor-link-changes/",nextPostPath:"/promise-implementation-principle/",prePostPath:"/sequelize-one-to-many-find-solution/"}}}});
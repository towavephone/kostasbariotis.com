<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
</head>
<body>
  <button id="btn1">加1</button>
  <button id="btn2">加3</button>
  <span id="console"></span>
  <script>
    let workInProgressHook;
    let isMount = true;

    const fiber = {
      memoizedState: null,
      stateNode: App
    };

    function schedule() {
      workInProgressHook = fiber.memoizedState;
      const app = fiber.stateNode();
      isMount = false;
      return app;
    }

    function dispatchAction(queue, action) {
      const update = {
        action,
        next: null
      }
      if (queue.pending === null) {
        update.next = update;
      } else {
        update.next = queue.pending.next;
        queue.pending.next = update;
      }
      queue.pending = update;

      schedule();
    }

    function useState(initialState) {
      let hook;

      if (isMount) {
        hook = {
          queue: {
            pending: null
          },
          memoizedState: initialState,
          next: null
        }
        if (!fiber.memoizedState) {
          fiber.memoizedState = hook;
        } else {
          workInProgressHook.next = hook;
        }
        workInProgressHook = hook;
      } else {
        hook = workInProgressHook;
        workInProgressHook = workInProgressHook.next;
      }

      let baseState = hook.memoizedState;
      if (hook.queue.pending) {
        let firstUpdate = hook.queue.pending.next;
        do {
          const action = firstUpdate.action;
          baseState = action(baseState);
          firstUpdate = firstUpdate.next;
        } while (firstUpdate !== hook.queue.pending)
        hook.queue.pending = null;
      }
      hook.memoizedState = baseState;

      return [baseState, dispatchAction.bind(null, hook.queue)];
    }

    function App() {
      const [num, updateNum] = useState(0);
      const consoleDOM = document.querySelector('#console')
      const textDOM = document.createRange().createContextualFragment(`<div>${isMount ? 'mount' : 'update'} num: ${num}</div>`);
      consoleDOM.appendChild(textDOM)

      return {
        clickOne() {
          updateNum(num => num + 1);
        },
        clickThree() {
          updateNum(num => num + 3);
        }
      }
    }

    window.app = schedule();

    document.querySelector('#btn1').addEventListener('click', () => {
      window.app.clickOne()
    })

    document.querySelector('#btn2').addEventListener('click', () => {
      window.app.clickThree()
    })
  </script>
</body>
</html>
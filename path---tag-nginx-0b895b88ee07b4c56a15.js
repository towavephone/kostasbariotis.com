webpackJsonp([0x8276a965f803],{1304:function(n,a){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"一个站点配置多个域名 server_name 后跟多个域名即可，多个域名之间用空格分隔 一个服务配置多个站点 基于 nginx 虚拟主机配置实现，nginx 有三种类型的虚拟主机 基于 ip 的虚拟主机：需要你的服务器上有多个地址，每个站点对应不同的地址，这种方式使用的比较少 基于端口的虚拟主机：每个站点对应不同的端口，访问的时候使用 ip:port 的方式访问，可以修改 listen…",html:'<h1 id="一个站点配置多个域名"><a href="#%E4%B8%80%E4%B8%AA%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个站点配置多个域名</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31857302984392643000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n}`, `31857302984392643000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n    listen       <span class="token number">80</span><span class="token punctuation">;</span>\n    server_name  ops-coffee.cn b.ops-coffee.cn<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>server_name 后跟多个域名即可，多个域名之间用空格分隔</p>\n<h1 id="一个服务配置多个站点"><a href="#%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E7%AB%99%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个服务配置多个站点</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4649836760162174"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80;\n    server_name  a.ops-coffee.cn;\n\n    location / {\n        root /home/project/pa;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  ops-coffee.cn b.ops-coffee.cn;\n\n    location / {\n        root /home/project/pb;\n        index index.html;\n    }\n}\n\nserver {\n    listen       80;\n    server_name  c.ops-coffee.cn;\n\n    location / {\n        root /home/project/pc;\n        index index.html;\n    }\n}`, `4649836760162174`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n    listen       <span class="token number">80</span><span class="token punctuation">;</span>\n    server_name  a.ops-coffee.cn<span class="token punctuation">;</span>\n\n    location / <span class="token punctuation">{</span>\n        root /home/project/pa<span class="token punctuation">;</span>\n        index index.html<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nserver <span class="token punctuation">{</span>\n    listen       <span class="token number">80</span><span class="token punctuation">;</span>\n    server_name  ops-coffee.cn b.ops-coffee.cn<span class="token punctuation">;</span>\n\n    location / <span class="token punctuation">{</span>\n        root /home/project/pb<span class="token punctuation">;</span>\n        index index.html<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nserver <span class="token punctuation">{</span>\n    listen       <span class="token number">80</span><span class="token punctuation">;</span>\n    server_name  c.ops-coffee.cn<span class="token punctuation">;</span>\n\n    location / <span class="token punctuation">{</span>\n        root /home/project/pc<span class="token punctuation">;</span>\n        index index.html<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>基于 nginx 虚拟主机配置实现，nginx 有三种类型的虚拟主机</p>\n<p>基于 ip 的虚拟主机：需要你的服务器上有多个地址，每个站点对应不同的地址，这种方式使用的比较少</p>\n<p>基于端口的虚拟主机：每个站点对应不同的端口，访问的时候使用 ip:port 的方式访问，可以修改 listen 的端口来使用</p>\n<p>基于域名的虚拟主机：使用最广的方式，上边例子中就是用了基于域名的虚拟主机，前提条件是你有多个域名分别对应每个站点，server_name 填写不同的域名即可</p>\n<h1 id="nginx-添加账号密码验证"><a href="#nginx-%E6%B7%BB%E5%8A%A0%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 添加账号密码验证</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81422601752264400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location / {\n        auth_basic &quot;please input user&passwd&quot;;\n        auth_basic_user_file key/auth.key;\n    }\n}`, `81422601752264400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n    location / <span class="token punctuation">{</span>\n        auth_basic <span class="token string">"please input user&amp;passwd"</span><span class="token punctuation">;</span>\n        auth_basic_user_file key/auth.key<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有很多服务通过 nginx 访问，但本身没有提供账号认证的功能，就可以通过 nginx 提供的 authbase 账号密码认证来实现，可以用以下脚本来生成账号的密码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96596350985339910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# cat pwd.pl\n#!/usr/bin/perl\nuse strict;\n\nmy \\$pw=\\$ARGV[0] ;\nprint crypt(\\$pw,\\$pw).&quot;\\n&quot;;`, `96596350985339910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># cat pwd.pl</span>\n<span class="token comment">#!/usr/bin/perl</span>\nuse strict<span class="token punctuation">;</span>\n\nmy <span class="token variable">$pw</span><span class="token operator">=</span><span class="token variable">$ARGV</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>\nprint crypt<span class="token punctuation">(</span><span class="token variable">$pw</span>,<span class="token variable">$pw</span><span class="token punctuation">)</span>.<span class="token string">"<span class="token entity" title="\\n">\\n</span>"</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4678847244538354000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# perl pwd.pl ops-coffee.cn\nopf8BImqCAXww\n# echo &quot;admin:opf8BImqCAXww&quot; > key/auth.key`, `4678847244538354000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># perl pwd.pl ops-coffee.cn</span>\nopf8BImqCAXww\n<span class="token comment"># echo "admin:opf8BImqCAXww" > key/auth.key</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="nginx-开启列目录"><a href="#nginx-%E5%BC%80%E5%90%AF%E5%88%97%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 开启列目录</h1>\n<p>当你想让 nginx 作为文件下载服务器存在时，需要开启 nginx 列目录</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68208365477447885000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location download {\n        autoindex on;\n\n        autoindex_exact_size off;\n        autoindex_localtime on;\n    }\n}`, `68208365477447885000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n    location download <span class="token punctuation">{</span>\n        autoindex on<span class="token punctuation">;</span>\n\n        autoindex_exact_size off<span class="token punctuation">;</span>\n        autoindex_localtime on<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>autoindex<em>exact</em>size：为 on（默认）时显示文件的确切大小，单位是 byte；改为 off 显示文件大概大小，单位 KB 或 MB 或 GB</p>\n<p>autoindex_localtime：为 off（默认）时显示的文件时间为 GMT 时间；改为 on 后，显示的文件时间为服务器时间</p>\n<p>默认当访问列出的 txt 等文件时会在浏览器上显示文件的内容，如果你想让浏览器直接下载，加上下边的配置</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68646193102586530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (\\$request_filename ~* ^.*?\\.(txt|pdf|jpg|png)\\$) {\n    add_header Content-Disposition \'attachment\';\n}`, `68646193102586530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_filename</span> ~* ^.*?<span class="token punctuation">\\</span>.<span class="token punctuation">(</span>txt<span class="token operator">|</span>pdf<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token punctuation">)</span>$<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    add_header Content-Disposition <span class="token string">\'attachment\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="配置默认站点"><a href="#%E9%85%8D%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%AB%99%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置默认站点</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97207199209777710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen 80 default;\n}`, `97207199209777710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n    listen <span class="token number">80</span> default<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当一个 nginx 服务上创建了多个虚拟主机时默认会从上到下查找，如果匹配不到虚拟主机则会返回第一个虚拟主机的内容，如果你想指定一个默认站点时，可以将这个站点的虚拟主机放在配置文件中第一个虚拟主机的位置，或者在这个站点的虚拟主机上配置 listen default</p>\n<h1 id="不允许通过-ip-访问"><a href="#%E4%B8%8D%E5%85%81%E8%AE%B8%E9%80%9A%E8%BF%87-ip-%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不允许通过 IP 访问</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="770285449906582500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    listen       80 default;\n    server_name  _;\n\n    return      404;\n}`, `770285449906582500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n    listen       <span class="token number">80</span> default<span class="token punctuation">;</span>\n    server_name  _<span class="token punctuation">;</span>\n\n    <span class="token builtin class-name">return</span>      <span class="token number">404</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可能有一些未备案的域名或者你不希望的域名将服务器地址指向了你的服务器，这时候就会对你的站点造成一定的影响，需要禁止 IP 或未配置的域名访问，我们利用上边所说的 default 规则，将默认流量都转到 404 去</p>\n<p>上边这个方法比较粗暴，当然你也可以配置下所有未配置的地址访问时直接 301 重定向到你的网站去，也能为你的网站带来一定的流量</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61112957707678530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    rewrite ^/(.*)\\$ https://ops-coffee.cn/\\$1    permanent;\n}`, `61112957707678530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n    rewrite ^/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ https://ops-coffee.cn/<span class="token variable">$1</span>    permanent<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="直接返回验证文件"><a href="#%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E9%AA%8C%E8%AF%81%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直接返回验证文件</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93328710935915040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location = /XDFyle6tNA.txt {\n    default_type text/plain;\n    return 200 \'d6296a84657eb275c05c31b10924f6ea\';\n}`, `93328710935915040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">location <span class="token operator">=</span> /XDFyle6tNA.txt <span class="token punctuation">{</span>\n    default_type text/plain<span class="token punctuation">;</span>\n    <span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">\'d6296a84657eb275c05c31b10924f6ea\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很多时候微信等程序都需要我们放一个 txt 的文件到项目里以验证项目归属，我们可以直接通过上边这种方式修改 nginx 即可，无需真正的把文件给放到服务器上</p>\n<h1 id="nginx-配置-upstream-反向代理"><a href="#nginx-%E9%85%8D%E7%BD%AE-upstream-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 配置 upstream 反向代理</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8870455440111624000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`http {\n    ...\n    upstream tomcats {\n        server 192.168.106.176 weight=1;\n        server 192.168.106.177 weight=1;\n    }\n\n    server {\n        location /ops-coffee/ {\n            proxy_pass http://tomcats;\n\n            proxy_set_header Host \\$host;\n            proxy_set_header X-Real-IP \\$remote_addr;\n            proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto \\$scheme;\n        }\n    }\n\n}`, `8870455440111624000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">http <span class="token punctuation">{</span>\n    <span class="token punctuation">..</span>.\n    upstream tomcats <span class="token punctuation">{</span>\n        server <span class="token number">192.168</span>.106.176 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>\n        server <span class="token number">192.168</span>.106.177 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    server <span class="token punctuation">{</span>\n        location /ops-coffee/ <span class="token punctuation">{</span>\n            proxy_pass http://tomcats<span class="token punctuation">;</span>\n\n            proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>\n            proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>\n            proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>\n            proxy_set_header X-Forwarded-Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>稍不注意可能会落入一个 proxy<em>pass 加杠不加杠的陷阱，这里详细说下 proxy</em>pass <code class="language-text">http://tomcats</code> 与 proxy_pass <code class="language-text">http://tomcats/</code> 的区别：</p>\n<p>虽然只是一个 / 的区别但结果确千差万别。分为以下两种情况：</p>\n<ol>\n<li>\n<p>目标地址中不带 uri(proxy_pass <code class="language-text">http://tomcats</code>)。此时新的目标 url 中，匹配的 uri 部分不做修改，原来是什么就是什么。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42490061987598550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181;\n}\n\nhttp://domain/ops-coffee/   -->     http://192.168.106.135:8181/ops-coffee/\nhttp://domain/ops-coffee/action/abc   -->     http://192.168.106.135:8181/ops-coffee/action/abc`, `42490061987598550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">location /ops-coffee/ <span class="token punctuation">{</span>\n   proxy_pass  http://192.168.106.135:8181<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nhttp://domain/ops-coffee/   --<span class="token operator">></span>     http://192.168.106.135:8181/ops-coffee/\nhttp://domain/ops-coffee/action/abc   --<span class="token operator">></span>     http://192.168.106.135:8181/ops-coffee/action/abc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>目标地址中带 uri (proxy_pass <code class="language-text">http://tomcats/</code>，/也是 uri) ,此时新的目标 url 中，匹配的 uri 部分将会被修改为该参数中的 uri。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17576017378524166000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location /ops-coffee/ {\n   proxy_pass  http://192.168.106.135:8181/;\n}\n\nhttp://domain/ops-coffee/   -->     http://192.168.106.135:8181\nhttp://domain/ops-coffee/action/abc   -->     http://192.168.106.135:8181/action/abc`, `17576017378524166000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">location /ops-coffee/ <span class="token punctuation">{</span>\n   proxy_pass  http://192.168.106.135:8181/<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nhttp://domain/ops-coffee/   --<span class="token operator">></span>     http://192.168.106.135:8181\nhttp://domain/ops-coffee/action/abc   --<span class="token operator">></span>     http://192.168.106.135:8181/action/abc</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h1 id="nginx-upstream-开启-keepalive"><a href="#nginx-upstream-%E5%BC%80%E5%90%AF-keepalive" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx upstream 开启 keepalive</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83741568779577590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`upstream tomcat {\n    server ops-coffee.cn:8080;\n    keepalive 1024;\n}\n\nserver {\n    location / {\n        proxy_http_version 1.1;\n        proxy_set_header Connection &quot;&quot;;\n\n        proxy_pass http://tomcat;\n    }\n}`, `83741568779577590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">upstream tomcat <span class="token punctuation">{</span>\n    server ops-coffee.cn:8080<span class="token punctuation">;</span>\n    keepalive <span class="token number">1024</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nserver <span class="token punctuation">{</span>\n    location / <span class="token punctuation">{</span>\n        proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>\n        proxy_set_header Connection <span class="token string">""</span><span class="token punctuation">;</span>\n\n        proxy_pass http://tomcat<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nginx 在项目中大多数情况下会作为反向代理使用，例如 nginx 后接 tomcat，nginx 后接 php 等，这时我们开启 nginx 和后端服务之间的 keepalive 能够减少频繁创建 TCP 连接造成的资源消耗，配置如上</p>\n<p>keepalive: 指定每个 nginxworker 可以保持的最大连接数量为 1024，默认不设置，即 nginx 作为 client 时 keepalive 未生效</p>\n<p><code class="language-text">proxy_http_version 1.1</code>: 开启 keepalive 要求 HTTP 协议版本为 HTTP 1.1</p>\n<p><code class="language-text">proxy_set_header Connection &quot;&quot;</code>: 为了兼容老的协议以及防止 http 头中有 Connection close 导致的 keepalive 失效，这里需要及时清掉 HTTP 头部的 Connection</p>\n<h1 id="404-自动跳转到首页"><a href="#404-%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC%E5%88%B0%E9%A6%96%E9%A1%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>404 自动跳转到首页</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18167799931264140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`server {\n    location / {\n       error_page 404 =  @ops-coffee;\n    }\n\n    location @ops-coffee {\n       rewrite  .*  / permanent;\n    }\n}`, `18167799931264140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                data-tooltip="复制"\n              >\n                <svg class="gatsby-code-button-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z"/></svg>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">server <span class="token punctuation">{</span>\n    location / <span class="token punctuation">{</span>\n       error_page <span class="token number">404</span> <span class="token operator">=</span>  @ops-coffee<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    location @ops-coffee <span class="token punctuation">{</span>\n       rewrite  .*  / permanent<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>网站出现 404 页面不是特别友好，我们可以通过上边的配置在出现 404 之后给自动跳转到首页去</p>',
id:"/github/workspace/blog/nginx常用配置和技巧/index.md absPath of file >>> MarkdownRemark",timeToRead:4,frontmatter:{date:"2019-06-06 15:03:49",path:"/nginx-common-configurations-techniques/",tags:"后端, nginx",title:"nginx常用配置和技巧",draft:null}}],length:1,tag:"nginx",pagesSum:1,page:1}}}});
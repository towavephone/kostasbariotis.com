webpackJsonp([0x789861cecd75],{1055:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlUlEQVRIx11WaWxU1xWewbQlrdofkSIhGiBpMPZ4Vs/2lpm3zupZPOOZ8Sz2YGzANkaAKaYQUrMkLYgiIlxCQjCYQAwYEoMQNJAIFBxaQgUhoCopYceBJo1pKFVDCbOc0/fesOZKV+fM1Tvf/c56R0VYOZW8lvAxtSybvbExAu1+mndGuaDQ2F4rNHVFhCZJZlMeZ1Qrf9Mt+H+qur/ihFORAFA64J0pVTcXVcDmcKFfruIzZ7rY1H89fAZivjbM1MzFxkAnZqWd9M7KJcTmv7zCN44sY+tflm12C79WLxLCqidWN9cwWpYvsfXL13vasZudgm4mgX4hW6h1teRjnrZCwjOzWO/twIR/FjZ7WnEZ35JvcUSeU4gwSXV7W1sJzEH6R8nSRArlXjr6r7S1DqNUvMAzCXCzSfDxDRAUmyDkaoawtEPi1LxHyGLMkby5gEqUy7atjnq1roosAXqE6Yq7DBXa7RLS6HRG8y4hhbwzDiJbj4IkXUwS5e1h07IOorMePUL6ruiKGmRblg2PesJlq9nxrJMMfydIbhIWP9jMPrBLkrIHgXfG0CdmgKMjwFARFKVvHEQo5xUyKDDRN2T7aE17mV5rfZQYm1lM0EQYWUe0aNTxoKl0Qnk5jVqNA/VaFu3SBS7SB7Ju0ougr2KKWg2DBi17mbCaxyghMzgeMTTp2W7CGkTKHshZqn0Q5Osg6opBhAmAzcADY/NheyQJBi2D8mXVehYMOgEsJg9aTIxSN2YTO+ohQ62G6rGZa5AmAjmj0YvzG5vhVP8f4fTO12FtVxfMjTfC6zPbwOsIQNybhK6GlmLCm5DA6cu2aoeSaaOeVheLxRKgpoJcZ5UAly94MeeiQ+jnQtBCcTBTZ8Ght9fDfy58DDdOHIRj2zdA/4uzYWBpZ6Fr6jR8/lfWP8n2usqA2mQgH7msr3Ks0WgEfGvN6lz/q6tgXqgZjgpZOGSLwsldA4CFG4j3rmP/osU47xkdrm5pLfjdETm+p64cf0fJME34HiVFV+VYajF50UGGc/Nnz4XDfW/ArQ09+M++XsCblwD+fQEL356HswuWwdedS+Dg2p5ilZQwa7VrpCHZ9nOl7Ojg44B0hxxg0hbMjx2rh2iwDk4feReKI58hfn8V8c5lwNyXiF+dRbz4Z1jY1g4TJ1rQbnHfc/ORihJDr5q0kw8AyVqDjpeSEpJLAyaMN6HRwMDuTa/B1fcPwcfbBuHc8SPw+cnDsGvzeim7HOg0DpAYoouPBWUMJxUo65y18X4MtbYJOo3zjgQoxwWen1iNDdPmwPu9+2BvfCXsXbQRehf9Hly0B8aN04OuioGqCipvt/hQ5GLzS4Dh0Tdv3+/nvm0qVVUlfUouboOWK8jxmaznMBXIwpbfroWN63th384tcHTfDpj0gg21lQxoK+m8TQGMb5UxAt6OUYSVkUuGK5MPKiuIHicZwWqDmNNqpE6pIFBjpGDxsqXwuxUroWtBN5w4NgSbNvcDIRW61CUFu9UrtV/si7Fjf/ajUmICSvxKgJMtdQxVK2XOU9RpGNBL3VBeQWIqPR3SjR3QOW8xrFmxCnrWbYJMaobEkr1HE/4zIpv4nrK7NIrbpF+tspoYZdpMLte+wNPRu6S1Bs1GqV/1DOqMPFjIMFbq3dg6cyFkGmagqZqHaoOAHF2XZ6ngWg+XBM4RVoLHOWrLVG4uWpo4FvsvfHz6NktFkbT6QafnQGsUoFLHYm1dFj44cgwYPgQVkymkbP6RWl+LNIRjL/uFhltuNjEoYySCXaNUojOsMPSw4aqwa+o9ga5DggiC1RFDmyMG1bYQVlTSIIhRMJq9RaPZJ4VF+DQZ6MCAmOkLurJ/DYiNt/R67VMKs4hrqjL+o+6mjrj0hjBEOG+1h8FOxcFO1oHVFgazPYQGqdfNthBYpUqwEME78nsT4tP7o96WwWSwA1nKb35iyCZ8M85EXE3oYBO3ab4RKWcSKCaFJJMCQprSpPQcUFwKzWQUKo1+lC9x0r7Fcc+0OVOj8zEkNrY8BAuLDV11ruZvDXrhuJ3NIu+bAYK/FXjfdOA8zegUp6DdmQKNMQD+8HTseW1LYeijE/jB4Q+/Wry8a5L01B6MeaetUcDSjfVjjOVM7da+bTMPvHfkbmrKb5DksjkLncmZqXTe6siAnWmAmkhbYUPvQP7cufO5L69fxyvD/8Ctb+/aI2PU8AmvRGqZAoiIityzb8/T165d3X3t2vD/Pjr+KW7b+R6u2/AOrli9CQfePYQXLg3jpSvDeOLkWTxw6Oh3uwYPrJTMlNHlFcLPeNk6/UOXZ7cuGP1A397fP/7v584vvzJ8o+dvn33+Zm/v9q9X/2EDbN+19+ybm3ds33/ww5f63uovf/D9woVL1A90P5dQqYaGhpQfg4N71BJbteoHqyk7Z+e8zlfuSupPHj+/eO2bso5ZcxQ9Fsiqgny6ZOv3+VTfjIwo+iefnFYN7BxQf3FxuEwGH1c+fgxBuIZnTFuIIh9U2qt3844fb9y0Vf0gXPKm7bzKzYZ+wGTKFFWNz1/6v8OLUiuaFKMJz00yEvaa/RQZnK086s6MutpEqRLx+kcT+rH1f+YikeeNfqnwAAAAAElFTkSuQmCC",aspectRatio:.6666666666666666,src:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png",srcSet:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-8a97b.png 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-0fdf3.png 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png 600w",srcWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp",srcSetWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-5d70e.webp 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-d1677.webp 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<p>我们需要一个健全的架构捕获所有同步、异步的异常。业务方不处理异常时，中断函数执行并启用默认处理，业务方也可以随时捕获异常自己处理。</p>\n<p>优雅的异常处理方式就像冒泡事件，任何元素可以自由拦截，也可以放任不管交给顶层处理。</p>\n<h1 id="回调"><a href="#%E5%9B%9E%E8%B0%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回调</h1>\n<p>如果在回调函数中直接处理了异常，是最不明智的选择，因为业务方完全失去了对异常的控制能力。</p>\n<p>下方的函数请求处理不但永远不会执行，还无法在异常时做额外的处理，也无法阻止异常产生时笨拙的 console.log(‘请求失败’) 行为。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52770166280942730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  setTimeout(() => {\n    console.log(\'请求失败\');\n  });\n}\n\nfetch(() => {\n  console.log(\'请求处理\'); // 永远不会执行\n});`, `52770166280942730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求失败\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="回调，无法捕获的异常"><a href="#%E5%9B%9E%E8%B0%83%EF%BC%8C%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回调，无法捕获的异常</h1>\n<p>回调函数有同步和异步之分，区别在于对方执行回调函数的时机，异常一般出现在请求、数据库连接等操作中，这些操作大多是异步的。</p>\n<p>异步回调中，回调函数的执行栈与原函数分离开，导致外部无法抓住异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51459621673428020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  setTimeout(() => {\n    throw Error(\'请求失败\');\n  });\n}\n\ntry {\n  fetch(() => {\n    console.log(\'请求处理\'); // 永远不会执行\n  });\n} catch (error) {\n  console.log(\'触发异常\', error); // 永远不会执行\n}\n\n// 程序崩溃\n// Uncaught Error: 请求失败`, `51459621673428020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'请求失败\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">try</span> <span class="token punctuation">{</span>\n  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'触发异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 程序崩溃</span>\n<span class="token comment">// Uncaught Error: 请求失败</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="回调，不可控的异常"><a href="#%E5%9B%9E%E8%B0%83%EF%BC%8C%E4%B8%8D%E5%8F%AF%E6%8E%A7%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回调，不可控的异常</h1>\n<p>我们变得谨慎，不敢再随意抛出异常，这已经违背了异常处理的基本原则。</p>\n<p>虽然使用了 error-first 约定，使异常看起来变得可处理，但业务方依然没有对异常的控制权，是否调用错误处理取决于回调函数是否执行，我们无法知道调用的函数是否可靠。</p>\n<p>更糟糕的问题是，业务方必须处理异常，否则程序挂掉就会什么都不做，这对大部分不用特殊处理异常的场景造成了很大的精神负担。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9494696211488995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(handleError, callback) {\n  setTimeout(() => {\n    handleError(\'请求失败\');\n  });\n}\n\nfetch(\n  () => {\n    console.log(\'失败处理\'); // 失败处理\n  },\n  (error) => {\n    console.log(\'请求处理\'); // 永远不会执行\n  }\n);`, `9494696211488995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">handleError<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token string">\'请求失败\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">fetch</span><span class="token punctuation">(</span>\n  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'失败处理\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 失败处理</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="promise-异常处理"><a href="#promise-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 异常处理</h1>\n<p>不仅是 reject，抛出的异常也会被作为拒绝状态被 Promise 捕获。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63161860970388850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  return new Promise((resolve, reject) => {\n    throw Error(\'用户不存在\');\n  });\n}\n\nfetch()\n  .then((result) => {\n    console.log(\'请求处理\', result); // 永远不会执行\n  })\n  .catch((error) => {\n    console.log(\'请求处理异常\', error); // 请求处理异常 用户不存在\n  });`, `63161860970388850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'用户不存在\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 请求处理异常 用户不存在</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="promise-无法捕获的异常"><a href="#promise-%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 无法捕获的异常</h1>\n<p>但是，永远不要在 macrotask 队列中抛出异常，因为 macrotask 队列脱离了运行上下文环境，异常无法被当前作用域捕获。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65791334063684670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      throw Error(\'用户不存在\');\n    });\n  });\n}\n\nfetch()\n  .then((result) => {\n    console.log(\'请求处理\', result); // 永远不会执行\n  })\n  .catch((error) => {\n    console.log(\'请求处理异常\', error); // 永远不会执行\n  });\n\n// 程序崩溃\n// Uncaught Error: 用户不存在`, `65791334063684670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'用户不存在\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 程序崩溃</span>\n<span class="token comment">// Uncaught Error: 用户不存在</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不过 microtask 中抛出的异常可以被捕获，说明 microtask 队列并没有离开当前作用域，我们通过以下例子来证明：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40012047999520720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Promise.resolve(true)\n  .then((resolve, reject) => {\n    throw Error(\'microtask 中的异常\');\n  })\n  .catch((error) => {\n    console.log(\'捕获异常\', error); // 捕获异常 Error: microtask 中的异常\n  });`, `40012047999520720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'microtask 中的异常\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'捕获异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获异常 Error: microtask 中的异常</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>至此，Promise 的异常处理有了比较清晰的答案，只要注意在 macrotask 级别回调中使用 reject，就没有抓不住的异常。</p>\n<h1 id="promise-异常追问"><a href="#promise-%E5%BC%82%E5%B8%B8%E8%BF%BD%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 异常追问</h1>\n<p>如果第三方函数在 macrotask 回调中以 throw Error 的方式抛出异常怎么办？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64553676986874400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function thirdFunction() {\n  setTimeout(() => {\n    throw Error(\'就是任性\');\n  });\n}\n\nPromise.resolve(true)\n  .then((resolve, reject) => {\n    thirdFunction();\n  })\n  .catch((error) => {\n    console.log(\'捕获异常\', error);\n  });\n\n// 程序崩溃\n// Uncaught Error: 就是任性`, `64553676986874400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">\'就是任性\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'捕获异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 程序崩溃</span>\n<span class="token comment">// Uncaught Error: 就是任性</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>值得欣慰的是，由于不在同一个调用栈，虽然这个异常无法被捕获，但也不会影响当前调用栈的执行。</p>\n<p>我们必须正视这个问题，唯一的解决办法，是第三方函数不要做这种傻事，一定要在 macrotask 抛出异常的话，请改为 reject 的方式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88918014141492170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function thirdFunction() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject(\'收敛一些\');\n    });\n  });\n}\n\nPromise.resolve(true)\n  .then((resolve, reject) => {\n    return thirdFunction();\n  })\n  .catch((error) => {\n    console.log(\'捕获异常\', error); // 捕获异常 收敛一些\n  });`, `88918014141492170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'收敛一些\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'捕获异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获异常 收敛一些</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，如果 <code class="language-text">return thirdFunction()</code> 这行缺少了 return 的话，依然无法抓住这个错误，这是因为没有将对方返回的 Promise 传递下去，错误也不会继续传递。</p>\n<p>我们发现，这样还不是完美的办法，不但容易忘记 return，而且当同时含有多个第三方函数时，处理方式不太优雅：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66822520833295516000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function thirdFunction() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject(\'收敛一些\');\n    });\n  });\n}\n\nPromise.resolve(true)\n  .then((resolve, reject) => {\n    return thirdFunction()\n      .then(() => {\n        return thirdFunction();\n      })\n      .then(() => {\n        return thirdFunction();\n      })\n      .then(() => {});\n  })\n  .catch((error) => {\n    console.log(\'捕获异常\', error);\n  });`, `66822520833295516000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'收敛一些\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'捕获异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>是的，我们还有更好的处理方式。</p>\n<h1 id="async-await-异常"><a href="#async-await-%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Async Await 异常</h1>\n<p>不论是同步、异步的异常，await 都不会自动捕获，但好处是可以自动中断函数，我们大可放心编写业务逻辑，而不用担心异步异常后会被执行引发雪崩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="331946886614353800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject();\n    });\n  });\n}\n\nasync function main() {\n  const result = await fetch();\n  console.log(\'请求处理\', result); // 永远不会执行\n}\n\nmain();`, `331946886614353800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="async-await-捕获异常"><a href="#async-await-%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Async Await 捕获异常</h1>\n<p>我们使用 try catch 捕获异常，为什么此时异步的异常可以通过 try catch 来捕获。</p>\n<p>因为此时的异步其实在一个作用域中，通过 generator 控制执行顺序，所以可以将异步看做同步的代码去编写，包括使用 try catch 捕获异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65559335762346090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function fetch(callback) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject(\'no\');\n    });\n  });\n}\n\nasync function main() {\n  try {\n    const result = await fetch();\n    console.log(\'请求处理\', result); // 永远不会执行\n  } catch (error) {\n    console.log(\'异常\', error); // 异常 no\n  }\n}\n\nmain();`, `65559335762346090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'no\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常 no</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="async-await-无法捕获的异常"><a href="#async-await-%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Async Await 无法捕获的异常</h1>\n<p>和 <code class="language-text">Promise 无法捕获的异常</code> 一样，这也是 await 的软肋，不过依然可以通过 <code class="language-text">Promise 异常追问</code> 的方案解决：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61966323456887840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function thirdFunction() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      reject(\'收敛一些\');\n    });\n  });\n}\n\nasync function main() {\n  try {\n    const result = await thirdFunction();\n    console.log(\'请求处理\', result); // 永远不会执行\n  } catch (error) {\n    console.log(\'异常\', error); // 异常 收敛一些\n  }\n}\n\nmain();`, `61966323456887840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'收敛一些\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常 收敛一些</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在解答 <code class="language-text">Promise 异常追问</code> 尾部的问题，为什么 await 是更加优雅的方案：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92469084757949460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function main() {\n  try {\n    const result1 = await secondFunction(); // 如果不抛出异常，后续继续执行\n    const result2 = await thirdFunction(); // 抛出异常\n    const result3 = await thirdFunction(); // 永远不会执行\n    console.log(\'请求处理\', result); // 永远不会执行\n  } catch (error) {\n    console.log(\'异常\', error); // 异常 收敛一些\n  }\n}\n\nmain();`, `92469084757949460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">secondFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果不抛出异常，后续继续执行</span>\n    <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出异常</span>\n    <span class="token keyword">const</span> result3 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'请求处理\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'异常\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异常 收敛一些</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="业务场景"><a href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>业务场景</h1>\n<p>在如今 action 概念成为标配的时代，我们大可以将所有异常处理收敛到 action 中。</p>\n<p>我们以如下业务代码为例，默认不捕获错误的话，错误会一直冒泡到顶层，最后抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13720432253916015000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const successRequest = () => Promise.resolve(\'a\');\nconst failRequest = () => Promise.reject(\'b\');\n\nclass Action {\n  async successReuqest() {\n    const result = await successRequest();\n    console.log(\'successReuqest\', \'处理返回值\', result); // successReuqest 处理返回值 a\n  }\n\n  async failReuqest() {\n    const result = await failRequest();\n    console.log(\'failReuqest\', \'处理返回值\', result); // 永远不会执行\n  }\n\n  async allReuqest() {\n    const result1 = await successRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result1); // allReuqest 处理返回值 success a\n    const result2 = await failRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result2); // 永远不会执行\n  }\n}\n\nconst action = new Action();\naction.successReuqest();\naction.failReuqest();\naction.allReuqest();\n\n// 程序崩溃\n// Uncaught (in promise) b\n// Uncaught (in promise) b`, `13720432253916015000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>\n  <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'successReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// successReuqest 处理返回值 a</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'failReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// allReuqest 处理返回值 success a</span>\n    <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 程序崩溃</span>\n<span class="token comment">// Uncaught (in promise) b</span>\n<span class="token comment">// Uncaught (in promise) b</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了防止程序崩溃，需要业务线在所有 async 函数中包裹 try catch。</p>\n<p>我们需要一种机制捕获 action 最顶层的错误进行统一处理。</p>\n<h1 id="业务场景-统一异常捕获"><a href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF-%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>业务场景 统一异常捕获</h1>\n<p>我们来编写类级别装饰器，专门捕获 async 函数抛出的异常：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47653648078710686000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const asyncClass = (errorHandler?: (error?: Error) => void) => (target: any) => {\n  Object.getOwnPropertyNames(target.prototype).forEach((key) => {\n    const func = target.prototype[key];\n    target.prototype[key] = async (...args: any[]) => {\n      try {\n        await func.apply(this, args);\n      } catch (error) {\n        errorHandler && errorHandler(error);\n      }\n    };\n  });\n  return target;\n};`, `47653648078710686000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">asyncClass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">errorHandler<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">?</span><span class="token punctuation">:</span> Error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> func <span class="token operator">=</span> target<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    target<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token punctuation">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">await</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        errorHandler <span class="token operator">&amp;&amp;</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> target<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>将类所有方法都用 try catch 包裹住，将异常交给业务方统一的 errorHandler 处理：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9069785544742292000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const successRequest = () => Promise.resolve(\'a\');\nconst failRequest = () => Promise.reject(\'b\');\n\nconst iAsyncClass = asyncClass((error) => {\n  console.log(\'统一异常处理\', error); // 统一异常处理 b\n});\n\n@iAsyncClass\nclass Action {\n  async successReuqest() {\n    const result = await successRequest();\n    console.log(\'successReuqest\', \'处理返回值\', result);\n  }\n\n  async failReuqest() {\n    const result = await failRequest();\n    console.log(\'failReuqest\', \'处理返回值\', result); // 永远不会执行\n  }\n\n  async allReuqest() {\n    const result1 = await successRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result1);\n    const result2 = await failRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result2); // 永远不会执行\n  }\n}\n\nconst action = new Action();\naction.successReuqest();\naction.failReuqest();\naction.allReuqest();`, `9069785544742292000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> iAsyncClass <span class="token operator">=</span> <span class="token function">asyncClass</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'统一异常处理\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统一异常处理 b</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n@iAsyncClass\n<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>\n  <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'successReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'failReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们也可以编写方法级别的异常处理：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20892447583939555000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const asyncMethod = (errorHandler?: (error?: Error) => void) => (\n  target: any,\n  propertyKey: string,\n  descriptor: PropertyDescriptor\n) => {\n  const func = descriptor.value;\n  return {\n    get() {\n      return (...args: any[]) => {\n        return Promise.resolve(func.apply(this, args)).catch((error) => {\n          errorHandler && errorHandler(error);\n        });\n      };\n    },\n    set(newValue: any) {\n      return newValue;\n    }\n  };\n};`, `20892447583939555000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">asyncMethod</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">errorHandler<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">?</span><span class="token punctuation">:</span> Error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n  <span class="token parameter">target<span class="token punctuation">:</span> any<span class="token punctuation">,</span>\n  propertyKey<span class="token punctuation">:</span> string<span class="token punctuation">,</span>\n  descriptor<span class="token punctuation">:</span> PropertyDescriptor</span>\n<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> func <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>value<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token punctuation">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          errorHandler <span class="token operator">&amp;&amp;</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token keyword">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> newValue<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>业务方用法类似，只是装饰器需要放在函数上：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55268017484620510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const successRequest = () => Promise.resolve(\'a\');\nconst failRequest = () => Promise.reject(\'b\');\n\nconst asyncAction = asyncMethod((error) => {\n  console.log(\'统一异常处理\', error); // 统一异常处理 b\n});\n\nclass Action {\n  @asyncAction async successReuqest() {\n    const result = await successRequest();\n    console.log(\'successReuqest\', \'处理返回值\', result);\n  }\n\n  @asyncAction async failReuqest() {\n    const result = await failRequest();\n    console.log(\'failReuqest\', \'处理返回值\', result); // 永远不会执行\n  }\n\n  @asyncAction async allReuqest() {\n    const result1 = await successRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result1);\n    const result2 = await failRequest();\n    console.log(\'allReuqest\', \'处理返回值 success\', result2); // 永远不会执行\n  }\n}\n\nconst action = new Action();\naction.successReuqest();\naction.failReuqest();\naction.allReuqest();`, `55268017484620510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> asyncAction <span class="token operator">=</span> <span class="token function">asyncMethod</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'统一异常处理\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统一异常处理 b</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>\n  @asyncAction <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'successReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  @asyncAction <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'failReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n\n  @asyncAction <span class="token keyword">async</span> <span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'allReuqest\'</span><span class="token punctuation">,</span> <span class="token string">\'处理返回值 success\'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会执行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\naction<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="业务场景-没有后顾之忧的主动权"><a href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF-%E6%B2%A1%E6%9C%89%E5%90%8E%E9%A1%BE%E4%B9%8B%E5%BF%A7%E7%9A%84%E4%B8%BB%E5%8A%A8%E6%9D%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>业务场景 没有后顾之忧的主动权</h1>\n<p>在上面这种场景下，业务方是不用担心异常导致的 crash，因为所有异常都会在顶层统一捕获，可能表现为弹出一个提示框，告诉用户请求发送失败。</p>\n<p>业务方也不需要判断程序中是否存在异常，而战战兢兢的到处 try catch，因为程序中任何异常都会立刻终止函数的后续执行，不会再引发更恶劣的结果。</p>\n<blockquote>\n<p>像 golang 中异常处理方式，就存在这个问题通过 err, result := func() 的方式，虽然固定了第一个参数是错误信息，但下一行代码免不了要以 if error {…} 开头，整个程序的业务代码充斥着巨量的不必要错误处理，而大部分时候，我们还要为如何处理这些错误想的焦头烂额。</p>\n</blockquote>\n<p>而 js 异常冒泡的方式，在前端可以用提示框兜底，nodejs 端可以返回 500 错误兜底，并立刻中断后续请求代码，等于在所有危险代码身后加了一层隐藏的 return。</p>\n<p>同时业务方也握有绝对的主动权，比如登录失败后，如果账户不存在，那么直接跳转到注册页，而不是傻瓜的提示用户帐号不存在，可以这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6362238238565832000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async login(nickname, password) {\n    try {\n        const user = await userService.login(nickname, password)\n        // 跳转到首页，登录失败后不会执行到这，所以不用担心用户看到奇怪的跳转\n    } catch (error) {\n        if (error.no === -1) {\n            // 跳转到登录页\n        } else {\n            throw Error(error) // 其他错误不想管，把球继续踢走\n        }\n    }\n}`, `6362238238565832000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">nickname<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>nickname<span class="token punctuation">,</span> password<span class="token punctuation">)</span>\n        <span class="token comment">// 跳转到首页，登录失败后不会执行到这，所以不用担心用户看到奇怪的跳转</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>no <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 跳转到登录页</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// 其他错误不想管，把球继续踢走</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="补充"><a href="#%E8%A1%A5%E5%85%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>补充</h1>\n<p>在 nodejs 端，记得监听全局错误，兜住落网之鱼：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35451618190657253000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`process.on(\'uncaughtException\', (error: any) => {\n  logger.error(\'uncaughtException\', error);\n});\n\nprocess.on(\'unhandledRejection\', (error: any) => {\n  logger.error(\'unhandledRejection\', error);\n});`, `35451618190657253000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'uncaughtException\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'uncaughtException\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nprocess<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'unhandledRejection\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'unhandledRejection\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在浏览器端，记得监听 window 全局错误，兜住漏网之鱼：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46027530317867370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`window.addEventListener(\'unhandledrejection\', (event: any) => {\n  logger.error(\'unhandledrejection\', event);\n});\nwindow.addEventListener(\'onrejectionhandled\', (event: any) => {\n  logger.error(\'onrejectionhandled\', event);\n});`, `46027530317867370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'unhandledrejection\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'unhandledrejection\'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nwindow<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'onrejectionhandled\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'onrejectionhandled\'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"…",timeToRead:7,tableOfContents:'<ul>\n<li><a href="/async-exception-throw-evolution/#%E5%9B%9E%E8%B0%83">回调</a></li>\n<li><a href="/async-exception-throw-evolution/#%E5%9B%9E%E8%B0%83%EF%BC%8C%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8">回调，无法捕获的异常</a></li>\n<li><a href="/async-exception-throw-evolution/#%E5%9B%9E%E8%B0%83%EF%BC%8C%E4%B8%8D%E5%8F%AF%E6%8E%A7%E7%9A%84%E5%BC%82%E5%B8%B8">回调，不可控的异常</a></li>\n<li><a href="/async-exception-throw-evolution/#promise-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">Promise 异常处理</a></li>\n<li><a href="/async-exception-throw-evolution/#promise-%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8">Promise 无法捕获的异常</a></li>\n<li><a href="/async-exception-throw-evolution/#promise-%E5%BC%82%E5%B8%B8%E8%BF%BD%E9%97%AE">Promise 异常追问</a></li>\n<li><a href="/async-exception-throw-evolution/#async-await-%E5%BC%82%E5%B8%B8">Async Await 异常</a></li>\n<li><a href="/async-exception-throw-evolution/#async-await-%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8">Async Await 捕获异常</a></li>\n<li><a href="/async-exception-throw-evolution/#async-await-%E6%97%A0%E6%B3%95%E6%8D%95%E8%8E%B7%E7%9A%84%E5%BC%82%E5%B8%B8">Async Await 无法捕获的异常</a></li>\n<li><a href="/async-exception-throw-evolution/#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF">业务场景</a></li>\n<li><a href="/async-exception-throw-evolution/#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF-%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7">业务场景 统一异常捕获</a></li>\n<li><a href="/async-exception-throw-evolution/#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF-%E6%B2%A1%E6%9C%89%E5%90%8E%E9%A1%BE%E4%B9%8B%E5%BF%A7%E7%9A%84%E4%B8%BB%E5%8A%A8%E6%9D%83">业务场景 没有后顾之忧的主动权</a></li>\n<li><a href="/async-exception-throw-evolution/#%E8%A1%A5%E5%85%85">补充</a></li>\n</ul>',wordCount:{words:267},frontmatter:{date:"2021-01-11 15:34:15",path:"/async-exception-throw-evolution/",tags:"前端, JS, 高级前端",title:"异步异常处理的演进",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="示例"><a href="#%E7%A4%BA%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>示例</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66293425011830284000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const getData = () => new Promise((resolve) => setTimeout(() => resolve(\'data\'), 1000));\n\nasync function test() {\n  const data = await getData();\n  console.log(\'data: \', data);\n  const data2 = await getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n}\n\n// 这样的一个函数 应该再1秒后打印data 再过一秒打印data2 最后打印success\ntest().then((res) => console.log(res));`, `66293425011830284000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">getData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 这样的一个函数 应该再1秒后打印data 再过一秒打印data2 最后打印success</span>\n<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="思路"><a href="#%E6%80%9D%E8%B7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>思路</h1>\n<p>对于这个简单的案例来说，如果我们把它用 generator 函数表达，会是怎么样的呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2638640449816454000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* testG() {\n  // await被编译成了yield\n  const data = yield getData();\n  console.log(\'data: \', data);\n  const data2 = yield getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n}`, `2638640449816454000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// await被编译成了yield</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们知道，generator 函数是不会自动执行的，每一次调用它的 next 方法，会停留在下一个 yield 的位置。</p>\n<p>利用这个特性，我们只要编写一个自动执行的函数，就可以让这个 generator 函数完全实现 async 函数的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88266867712384190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const getData = () => new Promise((resolve) => setTimeout(() => resolve(\'data\'), 1000));\n\nvar test = asyncToGenerator(function* testG() {\n  // await被编译成了yield\n  const data = yield getData();\n  console.log(\'data: \', data);\n  const data2 = yield getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n});\n\ntest().then((res) => console.log(res));`, `88266867712384190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">getData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token function">asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// await被编译成了yield</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么大体上的思路已经确定了，asyncToGenerator 接受一个 generator 函数，返回一个 promise，</p>\n<p>关键就在于，里面用 yield 来划分的异步流程，应该如何自动执行。</p>\n<h1 id="如果是手动执行"><a href="#%E5%A6%82%E6%9E%9C%E6%98%AF%E6%89%8B%E5%8A%A8%E6%89%A7%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如果是手动执行</h1>\n<p>在编写这个函数之前，我们先模拟手动去调用这个 generator 函数去一步步的把流程走完，有助于后面的思考。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8338890657421838000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* testG() {\n  // await被编译成了yield\n  const data = yield getData();\n  console.log(\'data: \', data);\n  const data2 = yield getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n}`, `8338890657421838000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// await被编译成了yield</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们先调用 testG 生成一个迭代器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85246272894734100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 返回了一个迭代器\nvar gen = testG();`, `85246272894734100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 返回了一个迭代器</span>\n<span class="token keyword">var</span> gen <span class="token operator">=</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后开始执行第一次 next</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68276249754620854000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 第一次调用next 停留在第一个yield的位置\n// 返回的promise里 包含了data需要的数据\nvar dataPromise = gen.next();`, `68276249754620854000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 第一次调用next 停留在第一个yield的位置</span>\n<span class="token comment">// 返回的promise里 包含了data需要的数据</span>\n<span class="token keyword">var</span> dataPromise <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里返回了一个 promise，就是第一次 getData()所返回的 promise，注意</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77692531911542930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const data = yield getData()`, `77692531911542930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这段代码要切割成左右两部分来看，第一次调用 next，其实只是停留在了 yield getData()这里，data 的值并没有被确定。</p>\n<p>那么什么时候 data 的值会被确定呢？</p>\n<p>下一次调用 next 的时候，传的参数会被作为上一个 yield 前面接受的值，也就是说，我们再次调用 gen.next(‘这个参数才会被赋给 data 变量’)的时候，data 的值才会被确定为’这个参数才会被赋给 data 变量’</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41170302742017340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`gen.next(\'这个参数才会被赋给data变量\')\n\n// 然后这里的data才有值\nconst data = yield getData()\n\n// 然后打印出data\nconsole.log(\'data: \', data);\n\n// 然后继续走到下一个yield\nconst data2 = yield getData()`, `41170302742017340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">\'这个参数才会被赋给data变量\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 然后这里的data才有值</span>\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 然后打印出data</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 然后继续走到下一个yield</span>\n<span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后往下执行，直到遇到下一个 yield，继续这样的流程…</p>\n<p>这是 generator 函数设计的一个比较难理解的点，但是为了实现我们的目标，还是得去学习它~</p>\n<p>借助这个特性，如果我们这样去控制 yield 的流程，是不是就能实现异步串行了？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12057620139573477000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* testG() {\n  // await被编译成了yield\n  const data = yield getData();\n  console.log(\'data: \', data);\n  const data2 = yield getData();\n  console.log(\'data2: \', data2);\n  return \'success\';\n}\n\nvar gen = testG();\n\nvar dataPromise = gen.next();\n\ndataPromise.then((value1) => {\n  // data1的value被拿到了 继续调用next并且传递给data\n  var data2Promise = gen.next(value1);\n\n  // console.log(\'data: \', data);\n  // 此时就会打印出data\n\n  data2Promise.value.then((value2) => {\n    // data2的value拿到了 继续调用next并且传递value2\n    gen.next(value2);\n\n    // console.log(\'data2: \', data2);\n    // 此时就会打印出data2\n  });\n});`, `12057620139573477000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// await被编译成了yield</span>\n  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'data2: \'</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'success\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> gen <span class="token operator">=</span> <span class="token function">testG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> dataPromise <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndataPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// data1的value被拿到了 继续调用next并且传递给data</span>\n  <span class="token keyword">var</span> data2Promise <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// console.log(\'data: \', data);</span>\n  <span class="token comment">// 此时就会打印出data</span>\n\n  data2Promise<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// data2的value拿到了 继续调用next并且传递value2</span>\n    gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// console.log(\'data2: \', data2);</span>\n    <span class="token comment">// 此时就会打印出data2</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样的一个看着像 callback hell 的调用，就可以让我们的 generator 函数把异步安排的明明白白。</p>\n<h1 id="实现"><a href="#%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现</h1>\n<p>有了这样的思路，实现这个高阶函数就变得很简单了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58058999523536680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function asyncToGenerator(generatorFunc) {\n  // 返回的是一个新的函数\n  return function() {\n    // 先调用 generator 函数 生成迭代器\n    // 对应 var gen = testG()\n    const gen = generatorFunc.apply(this, arguments);\n\n    // 返回一个 promise 因为外部是用 .then 的方式 或者 await 的方式去使用这个函数的返回值的\n    // var test = asyncToGenerator(testG)\n    // test().then(res => console.log(res))\n    return new Promise((resolve, reject) => {\n      // 内部定义一个 step 函数，用来一步一步的跨过 yield 的阻碍\n      // key 有 next 和 throw 两种取值，分别对应了 gen 的 next 和 throw 方法\n      // arg 参数则是用来把 promise resolve 出来的值交给下一个 yield\n      function step(key, arg) {\n        let generatorResult;\n\n        // 这个方法需要包裹在 try catch 中\n        // 如果报错了 就把 promise 给 reject 掉 外部通过 .catch 可以获取到错误\n        try {\n          generatorResult = gen[key](arg);\n        } catch (error) {\n          return reject(error);\n        }\n\n        // gen.next() 得到的结果是一个 { value, done } 的结构\n        const { value, done } = generatorResult;\n\n        if (done) {\n          // 如果已经完成了，就直接 resolve 这个 promise\n          // 这个 done 是在最后一次调用 next 后才会为 true\n          // 以本文的例子来说，此时的结果是 { done: true, value: \'success\' }\n          // 这个 value 也就是 generator 函数最后的返回值\n          return resolve(value);\n        } else {\n          // 除了最后结束的时候外，每次调用 gen.next()\n          // 其实是返回 { value: Promise, done: false } 的结构\n          // 这里要注意的是 Promise.resolve 可以接受一个 promise 为参数\n          // 并且这个 promise 参数被 resolve 的时候，这个 then 才会被调用\n          return Promise.resolve(\n            // 这个 value 对应的是 yield 后面的 promise\n            value\n          ).then(\n            // value 这个 promise 被 resolve 的时候，就会执行 next\n            // 并且只要 done 不是 true 的时候，就会递归的往下解开 promise，对应\n            // gen.next().value.then(value => {\n            //    gen.next(value).value.then(value2 => {\n            //       gen.next()\n            //\n            //      // 此时 done 为 true 了，整个 promise 被 resolve 了\n            //      // 最外部的 test().then(res => console.log(res)) 的 then 就开始执行了\n            //    })\n            // })\n            function onResolve(val) {\n              step(\'next\', val);\n            },\n            // 如果 promise 被 reject 了，就再次进入 step 函数\n            // 不同的是，这次的 try catch 中调用的是 gen.throw(err)\n            // 那么自然就被 catch 到，然后把 promise 给 reject 掉啦\n            function onReject(err) {\n              step(\'throw\', err);\n            }\n          );\n        }\n      }\n      step(\'next\');\n    });\n  };\n}`, `58058999523536680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">asyncToGenerator</span><span class="token punctuation">(</span><span class="token parameter">generatorFunc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 返回的是一个新的函数</span>\n  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 先调用 generator 函数 生成迭代器</span>\n    <span class="token comment">// 对应 var gen = testG()</span>\n    <span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">generatorFunc</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 返回一个 promise 因为外部是用 .then 的方式 或者 await 的方式去使用这个函数的返回值的</span>\n    <span class="token comment">// var test = asyncToGenerator(testG)</span>\n    <span class="token comment">// test().then(res => console.log(res))</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 内部定义一个 step 函数，用来一步一步的跨过 yield 的阻碍</span>\n      <span class="token comment">// key 有 next 和 throw 两种取值，分别对应了 gen 的 next 和 throw 方法</span>\n      <span class="token comment">// arg 参数则是用来把 promise resolve 出来的值交给下一个 yield</span>\n      <span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">let</span> generatorResult<span class="token punctuation">;</span>\n\n        <span class="token comment">// 这个方法需要包裹在 try catch 中</span>\n        <span class="token comment">// 如果报错了 就把 promise 给 reject 掉 外部通过 .catch 可以获取到错误</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n          generatorResult <span class="token operator">=</span> gen<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// gen.next() 得到的结果是一个 { value, done } 的结构</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> generatorResult<span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 如果已经完成了，就直接 resolve 这个 promise</span>\n          <span class="token comment">// 这个 done 是在最后一次调用 next 后才会为 true</span>\n          <span class="token comment">// 以本文的例子来说，此时的结果是 { done: true, value: \'success\' }</span>\n          <span class="token comment">// 这个 value 也就是 generator 函数最后的返回值</span>\n          <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 除了最后结束的时候外，每次调用 gen.next()</span>\n          <span class="token comment">// 其实是返回 { value: Promise, done: false } 的结构</span>\n          <span class="token comment">// 这里要注意的是 Promise.resolve 可以接受一个 promise 为参数</span>\n          <span class="token comment">// 并且这个 promise 参数被 resolve 的时候，这个 then 才会被调用</span>\n          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>\n            <span class="token comment">// 这个 value 对应的是 yield 后面的 promise</span>\n            value\n          <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n            <span class="token comment">// value 这个 promise 被 resolve 的时候，就会执行 next</span>\n            <span class="token comment">// 并且只要 done 不是 true 的时候，就会递归的往下解开 promise，对应</span>\n            <span class="token comment">// gen.next().value.then(value => {</span>\n            <span class="token comment">//    gen.next(value).value.then(value2 => {</span>\n            <span class="token comment">//       gen.next()</span>\n            <span class="token comment">//</span>\n            <span class="token comment">//      // 此时 done 为 true 了，整个 promise 被 resolve 了</span>\n            <span class="token comment">//      // 最外部的 test().then(res => console.log(res)) 的 then 就开始执行了</span>\n            <span class="token comment">//    })</span>\n            <span class="token comment">// })</span>\n            <span class="token keyword">function</span> <span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token function">step</span><span class="token punctuation">(</span><span class="token string">\'next\'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token comment">// 如果 promise 被 reject 了，就再次进入 step 函数</span>\n            <span class="token comment">// 不同的是，这次的 try catch 中调用的是 gen.throw(err)</span>\n            <span class="token comment">// 那么自然就被 catch 到，然后把 promise 给 reject 掉啦</span>\n            <span class="token keyword">function</span> <span class="token function">onReject</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token function">step</span><span class="token punctuation">(</span><span class="token string">\'throw\'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token function">step</span><span class="token punctuation">(</span><span class="token string">\'next\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"示例 思路 对于这个简单的案例来说，如果我们把它用 generator 函数表达，会是怎么样的呢？ 我们知道，generator 函数是不会自动执行的，每一次调用它的 next 方法，会停留在下一个 yield…",frontmatter:{date:"2021-01-10 11:30:16",path:"/async-await-simplest-implementation/",tags:"前端, JS, 高级前端",title:"手写 async await 的最简实现",draft:null}},prePost:{html:'<h1 id="前言"><a href="#%E5%89%8D%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前言</h1>\n<p>前端中的库很多，开发这些库的作者会尽可能的覆盖到大家在业务中千奇百怪的需求，但是总有无法预料到的，所以优秀的库就需要提供一种机制，让开发者可以干预插件中间的一些环节，从而完成自己的一些需求。</p>\n<p>本文将从 koa、axios、vuex 和 redux 的实现来教你怎么编写属于自己的插件机制。</p>\n<h1 id="axios"><a href="#axios" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>axios</h1>\n<p>首先我们模拟一个简单的 axios，这里不涉及请求的逻辑，只是简单的返回一个 Promise，可以通过 config 中的 error 参数控制 Promise 的状态。</p>\n<p>axios 的拦截器机制用流程图来表示其实就是这样的：</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-13-11-28-36-e6ed09152e3ec30c7e230eff1b3d0c28-ad8d8.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 121.06430155210643%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABhElEQVQ4y6WU3W6CQBSEff8nM3hjShD5VUSkQBTQCgho+2U3oS0hAdpzQeDAsDNzZnfx+Y9a9J7v93ue51mWXa/XD1G3240r/XEwGN/3NU1br9e2bXNvGMbhcKA/Di7LsiiKqqpY6nw+R1F0uVy4pzMOpl6vV9M03IB8FzVVM4VISG42G0VRdF3HAuhMBT8eD3gmSYJgz/PSNG3bdioY2lIh+KOoGbTlhLAa2qZpImHQrWEwn8qBua7LkNBc1/VUsGTOFbWRqK4zDsYtZks2yInjOGEYYuHUlRkM8XRF7ff7OI7/Qps1sToIgkHOw2DiiWG73Q7almUR0hm0ARMyRrXdbvkFFswAP59PmUdoAyZkdGYYRkjYD+qbCm1GNcMweR6wMVRVhTkSZtDu3GZNEnY6ncbdRhg7AQCDJSQsTrADPzj6xyROUMGr3l++wRwAtigcIh7L5XK1WslpERX4s7d7zv0C41MjioTxKSsTUpoYRpMRyhNmWDObntetqJ9yun5P8xcD/XLkCRiddwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 13 11 28 36"\n        title=""\n        src="/static/2021-01-13-11-28-36-e6ed09152e3ec30c7e230eff1b3d0c28-fee1c.png"\n        srcset="/static/2021-01-13-11-28-36-e6ed09152e3ec30c7e230eff1b3d0c28-a67b7.png 200w,\n/static/2021-01-13-11-28-36-e6ed09152e3ec30c7e230eff1b3d0c28-0b187.png 400w,\n/static/2021-01-13-11-28-36-e6ed09152e3ec30c7e230eff1b3d0c28-fee1c.png 800w,\n/static/2021-01-13-11-28-36-e6ed09152e3ec30c7e230eff1b3d0c28-ad8d8.png 902w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94265060893254630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const axios = (config) => {\n  if (config.error) {\n    return Promise.reject({\n      error: \'error in axios\'\n    });\n  } else {\n    return Promise.resolve({\n      ...config,\n      result: config.result\n    });\n  }\n};`, `94265060893254630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">axios</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      error<span class="token punctuation">:</span> <span class="token string">\'error in axios\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token operator">...</span>config<span class="token punctuation">,</span>\n      result<span class="token punctuation">:</span> config<span class="token punctuation">.</span>result\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果传入的 config 中有 error 参数，就返回一个 rejected 的 promise，反之则返回 resolved 的 promise。</p>\n<p>先简单看一下 axios 官方提供的拦截器示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60912918126347780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`axios.interceptors.request.use(\n  function(config) {\n    // 在发送请求之前做些什么\n    return config;\n  },\n  function(error) {\n    // 对请求错误做些什么\n    return Promise.reject(error);\n  }\n);\n\n// 添加响应拦截器\naxios.interceptors.response.use(\n  function(response) {\n    // 对响应数据做点什么\n    return response;\n  },\n  function(error) {\n    // 对响应错误做点什么\n    return Promise.reject(error);\n  }\n);`, `60912918126347780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 在发送请求之前做些什么</span>\n    <span class="token keyword">return</span> config<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对请求错误做些什么</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 添加响应拦截器</span>\naxios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对响应数据做点什么</span>\n    <span class="token keyword">return</span> response<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对响应错误做点什么</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看出，不管是 request 还是 response 的拦截请求，都会接受两个函数作为参数，一个是用来处理正常流程，一个是处理失败流程，这让人想到了什么？</p>\n<p>没错，promise.then 接受的同样也是这两个参数。</p>\n<p>axios 内部正是利用了 promise 的这个机制，把 use 传入的两个函数作为一个 intercetpor，每一个 intercetpor 都有 resolved 和 rejected 两个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45115449592541300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 把\naxios.interceptors.response.use(func1, func2)\n\n// 在内部存储为\n{\n    resolved: func1,\n    rejected: func2\n}`, `45115449592541300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 把</span>\naxios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>func1<span class="token punctuation">,</span> func2<span class="token punctuation">)</span>\n\n<span class="token comment">// 在内部存储为</span>\n<span class="token punctuation">{</span>\n    resolved<span class="token punctuation">:</span> func1<span class="token punctuation">,</span>\n    rejected<span class="token punctuation">:</span> func2\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来简单实现一下，这里我们简化一下，把 axios.interceptor.request.use 转为 axios.useRequestInterceptor 来简单实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15180488436083150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 先构造一个对象 存放拦截器\naxios.interceptors = {\n  request: [],\n  response: []\n};\n\n// 注册请求拦截器\naxios.useRequestInterceptor = (resolved, rejected) => {\n  axios.interceptors.request.push({ resolved, rejected });\n};\n\n// 注册响应拦截器\naxios.useResponseInterceptor = (resolved, rejected) => {\n  axios.interceptors.response.push({ resolved, rejected });\n};\n\n// 运行拦截器\naxios.run = (config) => {\n  const chain = [\n    {\n      resolved: axios,\n      rejected: undefined\n    }\n  ];\n\n  // 把请求拦截器往数组头部推\n  axios.interceptors.request.forEach((interceptor) => {\n    chain.unshift(interceptor);\n  });\n\n  // 把响应拦截器往数组尾部推\n  axios.interceptors.response.forEach((interceptor) => {\n    chain.push(interceptor);\n  });\n\n  // 把 config 也包装成一个 promise\n  let promise = Promise.resolve(config);\n\n  // 暴力 while 循环解忧愁\n  // 利用 promise.then 的能力递归执行所有的拦截器\n  while (chain.length) {\n    const { resolved, rejected } = chain.shift();\n    promise = promise.then(resolved, rejected);\n  }\n\n  // 最后暴露给用户的就是响应拦截器处理过后的 promise\n  return promise;\n};`, `15180488436083150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 先构造一个对象 存放拦截器</span>\naxios<span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">{</span>\n  request<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  response<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 注册请求拦截器</span>\naxios<span class="token punctuation">.</span><span class="token function-variable function">useRequestInterceptor</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> resolved<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 注册响应拦截器</span>\naxios<span class="token punctuation">.</span><span class="token function-variable function">useResponseInterceptor</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> resolved<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 运行拦截器</span>\naxios<span class="token punctuation">.</span><span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> chain <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      resolved<span class="token punctuation">:</span> axios<span class="token punctuation">,</span>\n      rejected<span class="token punctuation">:</span> <span class="token keyword">undefined</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 把请求拦截器往数组头部推</span>\n  axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    chain<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 把响应拦截器往数组尾部推</span>\n  axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    chain<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 把 config 也包装成一个 promise</span>\n  <span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 暴力 while 循环解忧愁</span>\n  <span class="token comment">// 利用 promise.then 的能力递归执行所有的拦截器</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> resolved<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span> <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolved<span class="token punctuation">,</span> rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 最后暴露给用户的就是响应拦截器处理过后的 promise</span>\n  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从 axios.run 这个函数看运行时的机制，首先构造一个 chain 作为 promise 链，并且把正常的请求也就是我们的请求参数 axios 也构造为一个拦截器的结构，接下来</p>\n<ul>\n<li>把 request 的 interceptor 给 unshift 到 chain 顶部</li>\n<li>把 response 的 interceptor 给 push 到 chain 尾部</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30304379808636027000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 请求拦截器1\naxios.useRequestInterceptor(resolved1, rejected1);\n// 请求拦截器2\naxios.useRequestInterceptor(resolved2, rejected2);\n// 响应拦截器1\naxios.useResponseInterceptor(resolved1, rejected1);\n// 响应拦截器\naxios.useResponseInterceptor(resolved2, rejected2);`, `30304379808636027000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 请求拦截器1</span>\naxios<span class="token punctuation">.</span><span class="token function">useRequestInterceptor</span><span class="token punctuation">(</span>resolved1<span class="token punctuation">,</span> rejected1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 请求拦截器2</span>\naxios<span class="token punctuation">.</span><span class="token function">useRequestInterceptor</span><span class="token punctuation">(</span>resolved2<span class="token punctuation">,</span> rejected2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 响应拦截器1</span>\naxios<span class="token punctuation">.</span><span class="token function">useResponseInterceptor</span><span class="token punctuation">(</span>resolved1<span class="token punctuation">,</span> rejected1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 响应拦截器</span>\naxios<span class="token punctuation">.</span><span class="token function">useResponseInterceptor</span><span class="token punctuation">(</span>resolved2<span class="token punctuation">,</span> rejected2<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样子构造出来的 promise 链就是这样的 chain 结构：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75562380440413680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n    请求拦截器2，// ↓config\n    请求拦截器1，// ↓config\n    axios请求核心方法, // ↓response\n    响应拦截器1, // ↓response\n    响应拦截器// ↓response\n]`, `75562380440413680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n    请求拦截器<span class="token number">2</span>，<span class="token comment">// ↓config</span>\n    请求拦截器<span class="token number">1</span>，<span class="token comment">// ↓config</span>\n    axios请求核心方法<span class="token punctuation">,</span> <span class="token comment">// ↓response</span>\n    响应拦截器<span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// ↓response</span>\n    响应拦截器<span class="token comment">// ↓response</span>\n<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个 chain 之后，只需要一句简短的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63664308835307000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let promise = Promise.resolve(config);\n\nwhile (chain.length) {\n  const { resolved, rejected } = chain.shift();\n  promise = promise.then(resolved, rejected);\n}\n\nreturn promise;`, `63664308835307000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">while</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> resolved<span class="token punctuation">,</span> rejected <span class="token punctuation">}</span> <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolved<span class="token punctuation">,</span> rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">return</span> promise<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>promise 就会把这个链从上而下的执行了。</p>\n<p>以这样的一段测试代码为例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9963704216421720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`axios.useRequestInterceptor((config) => {\n  return {\n    ...config,\n    extraParams1: \'extraParams1\'\n  };\n});\n\naxios.useRequestInterceptor((config) => {\n  return {\n    ...config,\n    extraParams2: \'extraParams2\'\n  };\n});\n\naxios.useResponseInterceptor(\n  (resp) => {\n    const {\n      extraParams1,\n      extraParams2,\n      result: { code, message }\n    } = resp;\n    return \\`\\${extraParams1} \\${extraParams2} \\${message}\\`;\n  },\n  (error) => {\n    console.log(\'error\', error);\n  }\n);`, `9963704216421720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">axios<span class="token punctuation">.</span><span class="token function">useRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token operator">...</span>config<span class="token punctuation">,</span>\n    extraParams1<span class="token punctuation">:</span> <span class="token string">\'extraParams1\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\naxios<span class="token punctuation">.</span><span class="token function">useRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token operator">...</span>config<span class="token punctuation">,</span>\n    extraParams2<span class="token punctuation">:</span> <span class="token string">\'extraParams2\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\naxios<span class="token punctuation">.</span><span class="token function">useResponseInterceptor</span><span class="token punctuation">(</span>\n  <span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span>\n      extraParams1<span class="token punctuation">,</span>\n      extraParams2<span class="token punctuation">,</span>\n      result<span class="token punctuation">:</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> message <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token operator">=</span> resp<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extraParams1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extraParams2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ol>\n<li>\n<p>成功的调用</p>\n<p>在成功的调用下输出 <code class="language-text">result1: extraParams1 extraParams2 message1</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73093566782291910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(async function() {\n const result = await axios.run({\n   message: \'message1\'\n });\n console.log(\'result1: \', result);\n})();`, `73093566782291910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   message<span class="token punctuation">:</span> <span class="token string">\'message1\'</span>\n <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'result1: \'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>失败的调用</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44198278143261230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(async function() {\n const result = await axios.run({\n   error: true\n });\n console.log(\'result3: \', result);\n})();`, `44198278143261230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   error<span class="token punctuation">:</span> <span class="token boolean">true</span>\n <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'result3: \'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>在失败的调用下，则进入响应拦截器的 rejected 分支：</p>\n<p>首先打印出拦截器定义的错误日志：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9986023522571786000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`error { error: \'error in axios\' }`, `9986023522571786000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">error { error: &#39;error in axios&#39; }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后由于失败的拦截器</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39630463936047860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`error => {\n  console.log(\'error\', error)\n},`, `39630463936047860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>没有返回任何东西，打印出 <code class="language-text">result3: undefined</code></p>\n<p>可以看出，axios 的拦截器是非常灵活的，可以在请求阶段任意的修改 config，也可以在响应阶段对 response 做各种处理，这也是因为用户对于请求数据的需求就是非常灵活的，没有必要干涉用户的自由度。</p>\n<h1 id="vuex"><a href="#vuex" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>vuex</h1>\n<p>vuex 提供了一个 api 用来在 action 被调用前后插入一些逻辑：</p>\n<p><a href="https://vuex.vuejs.org/zh/api/#subscribeaction" target="_blank" rel="nofollow noreferrer noopener">https://vuex.vuejs.org/zh/api/#subscribeaction</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93152849629707080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`store.subscribeAction({\n  before: (action, state) => {\n    console.log(\\`before action \\${action.type}\\`);\n  },\n  after: (action, state) => {\n    console.log(\\`after action \\${action.type}\\`);\n  }\n});`, `93152849629707080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">store<span class="token punctuation">.</span><span class="token function">subscribeAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token function-variable function">before</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before action </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function-variable function">after</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">after action </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其实这有点像 AOP（面向切面编程）的编程思想。</p>\n<p>在调用 <code class="language-text">store.dispatch({ type: &#39;add&#39; })</code> 的时候，会在执行前后打印出日志</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34466100746342908000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`before action add\nadd\nafter action add`, `34466100746342908000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">before action add\nadd\nafter action add</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>来简单实现一下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53756048084783560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { Actions, ActionSubscribers, ActionSubscriber, ActionArguments } from \'./vuex.type\';\n\nclass Vuex {\n  state = {};\n\n  action = {};\n\n  _actionSubscribers = [];\n\n  constructor({ state, action }) {\n    this.state = state;\n    this.action = action;\n    this._actionSubscribers = [];\n  }\n\n  dispatch(action) {\n    // action前置监听器\n    this._actionSubscribers.forEach((sub) => sub.before(action, this.state));\n\n    const { type, payload } = action;\n\n    // 执行action\n    this.action[type](this.state, payload).then(() => {\n      // action后置监听器\n      this._actionSubscribers.forEach((sub) => sub.after(action, this.state));\n    });\n  }\n\n  subscribeAction(subscriber) {\n    // 把监听者推进数组\n    this._actionSubscribers.push(subscriber);\n  }\n}\n\nconst store = new Vuex({\n  state: {\n    count: 0\n  },\n  action: {\n    async add(state, payload) {\n      state.count += payload;\n    }\n  }\n});\n\nstore.subscribeAction({\n  before: (action, state) => {\n    console.log(\\`before action \\${action.type}, before count is \\${state.count}\\`);\n  },\n  after: (action, state) => {\n    console.log(\\`after action \\${action.type},  after count is \\${state.count}\\`);\n  }\n});\n\nstore.dispatch({\n  type: \'add\',\n  payload: 2\n});`, `53756048084783560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Actions<span class="token punctuation">,</span> ActionSubscribers<span class="token punctuation">,</span> ActionSubscriber<span class="token punctuation">,</span> ActionArguments <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./vuex.type\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Vuex</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  action <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  _actionSubscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state<span class="token punctuation">,</span> action <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>action <span class="token operator">=</span> action<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// action前置监听器</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=></span> sub<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> payload <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>\n\n    <span class="token comment">// 执行action</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>action<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// action后置监听器</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=></span> sub<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">subscribeAction</span><span class="token punctuation">(</span><span class="token parameter">subscriber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 把监听者推进数组</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    count<span class="token punctuation">:</span> <span class="token number">0</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  action<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      state<span class="token punctuation">.</span>count <span class="token operator">+=</span> payload<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nstore<span class="token punctuation">.</span><span class="token function">subscribeAction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token function-variable function">before</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before action </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, before count is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function-variable function">after</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">after action </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,  after count is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nstore<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  type<span class="token punctuation">:</span> <span class="token string">\'add\'</span><span class="token punctuation">,</span>\n  payload<span class="token punctuation">:</span> <span class="token number">2</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此时控制台会打印如下内容：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91471485685395980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`before action add, before count is 0\nafter action add, after count is 2`, `91471485685395980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">before action add, before count is 0\nafter action add, after count is 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>轻松实现了日志功能。</p>\n<p>当然 Vuex 在实现插件功能的时候，选择性的将 type payload 和 state 暴露给外部，而不再提供进一步的修改能力，这也是框架内部的一种权衡，当然我们可以对 state 进行直接修改，但是不可避免的会得到 Vuex 内部的警告，因为在 Vuex 中，所有 state 的修改都应该通过 mutations 来进行，但是 Vuex 没有选择把 commit 也暴露出来，这也约束了插件的能力。</p>\n<h1 id="redux"><a href="#redux" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>redux</h1>\n<p>想要理解 redux 中的中间件机制，需要先理解一个方法：compose</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14888528459847584000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function compose(...funcs: Function[]) {\n  return funcs.reduce((a, b) => (...args: any) => a(b(...args)));\n}`, `14888528459847584000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs<span class="token punctuation">:</span> Function<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>简单理解的话，就是 <code class="language-text">compose(fn1, fn2, fn3) (...args) = &gt; fn1(fn2(fn3(...args)))</code> 它是一种高阶聚合函数，相当于把 fn3 先执行，然后把结果传给 fn2 再执行，再把结果交给 fn1 去执行。</p>\n<p>有了这个前置知识，就可以很轻易的实现 redux 的中间件机制了。</p>\n<p>虽然 redux 源码里写的很少，各种高阶函数各种柯里化，但是抽丝剥茧以后，redux 中间件的机制可以用一句话来解释：</p>\n<p><strong>把 dispatch 这个方法不断用高阶函数包装，最后返回一个强化过后的 dispatch</strong></p>\n<p>以 logMiddleware 为例，这个 middleware 接受原始的 redux dispatch，返回的是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43668127988228430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const typeLogMiddleware = (dispatch) => {\n  // 返回的其实还是一个结构相同的dispatch，接受的参数也相同\n  // 只是把原始的dispatch包在里面了而已。\n  return ({ type, ...args }) => {\n    console.log(\\`type is \\${type}\\`);\n    return dispatch({ type, ...args });\n  };\n};`, `43668127988228430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">typeLogMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 返回的其实还是一个结构相同的dispatch，接受的参数也相同</span>\n  <span class="token comment">// 只是把原始的dispatch包在里面了而已。</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">type is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个思路，就来实现这个 mini-redux 吧：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47524579912043330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function compose(...funcs) {\n  return funcs.reduce((a, b) => (...args) => a(b(...args)));\n}\n\nfunction createStore(reducer, middlewares) {\n  let currentState;\n\n  function dispatch(action) {\n    currentState = reducer(currentState, action);\n  }\n\n  function getState() {\n    return currentState;\n  }\n\n  // 初始化一个随意的 dispatch，要求外部在 type 匹配不到的时候返回初始状态\n  // 在这个 dispatch 后 currentState 就有值了。\n  dispatch({\n    type: \'INIT\'\n  });\n\n  let enhancedDispatch = dispatch;\n  // 如果第二个参数传入了 middlewares\n  if (middlewares) {\n    // 用 compose 把 middlewares 包装成一个函数\n    enhancedDispatch = compose(...middlewares)(dispatch);\n  }\n\n  return {\n    dispatch: enhancedDispatch,\n    getState\n  };\n}`, `47524579912043330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> currentState<span class="token punctuation">;</span>\n\n  <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    currentState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> currentState<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 初始化一个随意的 dispatch，要求外部在 type 匹配不到的时候返回初始状态</span>\n  <span class="token comment">// 在这个 dispatch 后 currentState 就有值了。</span>\n  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> <span class="token string">\'INIT\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> enhancedDispatch <span class="token operator">=</span> dispatch<span class="token punctuation">;</span>\n  <span class="token comment">// 如果第二个参数传入了 middlewares</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 用 compose 把 middlewares 包装成一个函数</span>\n    enhancedDispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    dispatch<span class="token punctuation">:</span> enhancedDispatch<span class="token punctuation">,</span>\n    getState\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接着写两个中间件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38697120325154490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 使用\n\nconst otherDummyMiddleware = (dispatch) => {\n  // 返回一个新的 dispatch\n  return (action) => {\n    console.log(\\`type in dummy is \\${type}\\`);\n    return dispatch(action);\n  };\n};\n\n// 这个 dispatch 其实是 otherDummyMiddleware 执行后返回 otherDummyDispatch\nconst typeLogMiddleware = (dispatch) => {\n  // 返回一个新的 dispatch\n  return ({ type, ...args }) => {\n    console.log(\\`type is \\${type}\\`);\n    return dispatch({ type, ...args });\n  };\n};\n\n// 中间件从右往左执行，相当于 typeLogMiddleware(otherDummyMiddleware(dispatch))\nconst counterStore = createStore(counterReducer, [typeLogMiddleware, otherDummyMiddleware]);\n\nconsole.log(counterStore.getState().count);\ncounterStore.dispatch({ type: \'add\', payload: 2 });\nconsole.log(counterStore.getState().count);\n\n// 输出：\n// 0\n// type is add\n// type in dummy is add\n// 2`, `38697120325154490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 使用</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">otherDummyMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 返回一个新的 dispatch</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">type in dummy is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 这个 dispatch 其实是 otherDummyMiddleware 执行后返回 otherDummyDispatch</span>\n<span class="token keyword">const</span> <span class="token function-variable function">typeLogMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// 返回一个新的 dispatch</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">type is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> <span class="token operator">...</span>args <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 中间件从右往左执行，相当于 typeLogMiddleware(otherDummyMiddleware(dispatch))</span>\n<span class="token keyword">const</span> counterStore <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>counterReducer<span class="token punctuation">,</span> <span class="token punctuation">[</span>typeLogMiddleware<span class="token punctuation">,</span> otherDummyMiddleware<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counterStore<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>\ncounterStore<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'add\'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counterStore<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 输出：</span>\n<span class="token comment">// 0</span>\n<span class="token comment">// type is add</span>\n<span class="token comment">// type in dummy is add</span>\n<span class="token comment">// 2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="koa"><a href="#koa" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>koa</h1>\n<p>koa 的洋葱模型想必各位都听说过，这种灵活的中间件机制也让 koa 变得非常强大，本文也会实现一个简单的洋葱中间件机制。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-14-10-26-26-ebfe4008e2cb2c601479e5e0b806122c-b4044.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 478px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 91.00418410041841%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACzElEQVQ4y4VUTU8aURQFFFSgDMjHgHyIMILalIbwBzTRxODKhXFBQdpua2IpWiXG0m1dsjHwB2xSrAlu1Bg3LhRcFCHxI4ASIUZCJIoKG01PGYqUxPQu3tx5886959573jAYf43JZLa2topEIoPBYDabBwcHBwYGhEIh/YnxX9PpdMAMDQ2ZTCbgx8bGHA5Hc3Pzs4Cmpqaaj3NcLreWSqVSzc3NyeXyZ5PLZDKFQiEWi6VSKXwWi4VzdDYEAthoND4Lxrm2tjZU29LSAqf+UH9/v9frRUT4CMrhcJh1hp1qqwiCoF/YbLbFYnG5XH6/f3t7OxQKkSRJVwdqSqWyo6NDIpHAh1MFq5RKJEefFr8tHhwcnJ6enp+fp1KpbDZrs9loMJ0NBJHgKTNMSBAj1pGfq6sXFxfHx8fpdPru7u76+hrgra2t9vb2WtmkVAb803ixSsTizzMzxZubk5MTAG5vb4vF4v39ffrsLJfL2e32PxVx2ApS3qXRMuq1gRXcJt7YnXbH5eVlqVzK5/NAlkqlQqHw+Pi4/H2ZIIRUl6632/CCz2/s+fz8fPBH8PXLV+/fvovH4uVyOZlMgn8kEgkGgx+nprr1VC9lEFf4N2Z2u92gCs4IsbmxAeZu16cJu2Pyw+RXr/fLwgKl12PsjdOmmzY6OopUyUTiqnD18PCAKCvBlc2NzbW1NSTf29uDcmnZYNqYS1WX1R6S5Pr6Ok0VdWYymV8V29nZ2d3dXVpagkh1FYNme3p6MOQqC/oxPj6eSCTi8fjh4SHA+/v7SBiLxRDC6XTy+XzAgNFqtVAIRPV0KTA6KHx2djYcDkMh6PnR0VE0GgUemxAWj8cDUqPRQOp45df3XCAQ4PZardbh4eHp6WmfzxcIBDweD3ZQEYoEuLNiFEX19fXB+adzEB0Kwze9Xg+GuCT4MYAeVogZ146uWa1WIxySAfIbroMTBYgint4AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 14 10 26 26"\n        title=""\n        src="/static/2021-01-14-10-26-26-ebfe4008e2cb2c601479e5e0b806122c-b4044.png"\n        srcset="/static/2021-01-14-10-26-26-ebfe4008e2cb2c601479e5e0b806122c-061d7.png 200w,\n/static/2021-01-14-10-26-26-ebfe4008e2cb2c601479e5e0b806122c-51120.png 400w,\n/static/2021-01-14-10-26-26-ebfe4008e2cb2c601479e5e0b806122c-b4044.png 478w"\n        sizes="(max-width: 478px) 100vw, 478px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>对应这张图来看，洋葱的每一个圈就是一个中间件，它既可以掌管请求进入，也可以掌管响应返回。</p>\n<p>它和 redux 的中间件机制有点类似，本质上都是高阶函数的嵌套，外层的中间件嵌套着内层的中间件，这种机制的好处是可以自己控制中间件的能力（外层的中间件可以影响内层的请求和响应阶段，内层的中间件只能影响外层的响应阶段）</p>\n<p>首先我们写出 Koa 这个类</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20209410416115770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Koa {\n  constructor() {\n    this.middlewares = [];\n  }\n  use(middleware) {\n    this.middlewares.push(middleware);\n  }\n  start({ req }) {\n    const composed = composeMiddlewares(this.middlewares);\n    const ctx = { req, res: undefined };\n    return composed(ctx);\n  }\n}`, `20209410416115770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Koa</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>middlewares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>middlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> req <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> composed <span class="token operator">=</span> <span class="token function">composeMiddlewares</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token punctuation">{</span> req<span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">composed</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里的 use 就是简单的把中间件推入中间件队列中，那核心就是怎样去把这些中间件组合起来了，下面看 <code class="language-text">composeMiddlewares</code> 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27918249534348603000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function composeMiddlewares(middlewares) {\n  return function wrapMiddlewares(ctx) {\n    // 记录当前运行的 middleware 的下标\n    let index = -1;\n    function dispatch(i) {\n      // index 向后移动\n      index = i;\n\n      // 找出数组中存放的相应的中间件\n      const fn = middlewares[i];\n\n      // 最后一个中间件调用 next 也不会报错\n      if (!fn) {\n        return Promise.resolve();\n      }\n\n      return Promise.resolve(\n        fn(\n          // 继续传递 ctx\n          ctx,\n          // next 方法，允许进入下一个中间件。\n          () => dispatch(i + 1)\n        )\n      );\n    }\n    // 开始运行第一个中间件\n    return dispatch(0);\n  };\n}`, `27918249534348603000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">composeMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">wrapMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 记录当前运行的 middleware 的下标</span>\n    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// index 向后移动</span>\n      index <span class="token operator">=</span> i<span class="token punctuation">;</span>\n\n      <span class="token comment">// 找出数组中存放的相应的中间件</span>\n      <span class="token keyword">const</span> fn <span class="token operator">=</span> middlewares<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 最后一个中间件调用 next 也不会报错</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>\n        <span class="token function">fn</span><span class="token punctuation">(</span>\n          <span class="token comment">// 继续传递 ctx</span>\n          ctx<span class="token punctuation">,</span>\n          <span class="token comment">// next 方法，允许进入下一个中间件。</span>\n          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n        <span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 开始运行第一个中间件</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>简单来说 <code class="language-text">dispatch(n)</code> 对应着第 n 个中间件的执行，而 <code class="language-text">dispatch(n)</code> 又拥有执行 <code class="language-text">dispatch(n + 1)</code> 的权力，</p>\n<p>所以在真正运行的时候，中间件并不是在平级的运行，而是嵌套的高阶函数：</p>\n<p><code class="language-text">dispatch(0)</code> 包含着 <code class="language-text">dispatch(1)</code>，而 <code class="language-text">dispatch(1)</code> 又包含着 <code class="language-text">dispatch(2)</code>，在这个模式下，我们很容易联想到 try catch 的机制，它可以 catch 住函数以及函数内部继续调用的函数的所有 error。</p>\n<p>那么我们的第一个中间件就可以做一个错误处理中间件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31990074611234288000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 最外层：管控全局错误\napp.use(async (ctx, next) => {\n  try {\n    // 这里的 next 包含了第二层以及第三层的运行\n    await next();\n  } catch (error) {\n    console.log(\\`[koa error]: \\${error.message}\\`);\n  }\n});`, `31990074611234288000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 最外层：管控全局错误</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 这里的 next 包含了第二层以及第三层的运行</span>\n    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[koa error]: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这个错误处理中间件中，我们把 next 包裹在 try catch 中运行，调用了 next 后会进入第二层的中间件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10024381528476156000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 第二层：日志中间件\napp.use(async (ctx, next) => {\n  const { req } = ctx;\n  console.log(\\`req is \\${JSON.stringify(req)}\\`);\n  await next();\n  // next 过后已经能拿到第三层写进 ctx 的数据了\n  console.log(\\`res is \\${JSON.stringify(ctx.res)}\\`);\n});`, `10024381528476156000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 第二层：日志中间件</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> req <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">req is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// next 过后已经能拿到第三层写进 ctx 的数据了</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">res is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在第二层中间件的 next 调用后，进入第三层，业务逻辑处理中间件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85455904517446390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 第三层：核心服务中间件\n// 在真实场景中，这一层一般用来构造真正需要返回的数据，写入ctx中\napp.use(async (ctx, next) => {\n  const { req } = ctx;\n  console.log(\\`calculating the res of \\${req}...\\`);\n  const res = {\n    code: 200,\n    result: \\`req \\${req} success\\`\n  };\n  // 写入ctx\n  ctx.res = res;\n  await next();\n});`, `85455904517446390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 第三层：核心服务中间件</span>\n<span class="token comment">// 在真实场景中，这一层一般用来构造真正需要返回的数据，写入ctx中</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> req <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">calculating the res of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span>\n    code<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>\n    result<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">req </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> success</span><span class="token template-punctuation string">`</span></span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// 写入ctx</span>\n  ctx<span class="token punctuation">.</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span>\n  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这一层把 res 写入 ctx 后，函数出栈，又会回到第二层中间件的 <code class="language-text">await next()</code> 后面</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53417947618593440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`console.log(\\`req is \\${JSON.stringify(req)}\\`);\nawait next();\n// <- 回到这里\nconsole.log(\\`res is \\${JSON.stringify(ctx.res)}\\`);`, `53417947618593440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">req is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// &lt;- 回到这里</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">res is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这时候日志中间件就可以拿到 ctx.res 的值了。</p>\n<p>想要测试错误处理中间件，就在最后加入这个中间件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94461694176258160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 用来测试全局错误中间件\n// 注释掉这一个中间件 服务才能正常响应\napp.use(async (ctx, next) => {\n  throw new Error(\'oops! error!\');\n});`, `94461694176258160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 用来测试全局错误中间件</span>\n<span class="token comment">// 注释掉这一个中间件 服务才能正常响应</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'oops! error!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后要调用启动函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86077790940893360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`app.start({ req: \'ssh\' });`, `86077790940893360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span> req<span class="token punctuation">:</span> <span class="token string">\'ssh\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>控制台打印出结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61790320332618285000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`req is &quot;ssh&quot;\ncalculating the res of ssh...\nres is {&quot;code&quot;:200,&quot;result&quot;:&quot;req ssh success&quot;}`, `61790320332618285000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">req is &quot;ssh&quot;\ncalculating the res of ssh...\nres is {&quot;code&quot;:200,&quot;result&quot;:&quot;req ssh success&quot;}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h1>\n<ol>\n<li>\n<p>axios 把用户注册的每个拦截器构造成一个 promise.then 所接受的参数，在运行时把所有的拦截器按照一个 promise 链的形式以此执行。</p>\n<ol>\n<li>在发送到服务端之前，config 已经是请求拦截器处理过后的结果</li>\n<li>服务器响应结果后，response 会经过响应拦截器，最后用户拿到的就是处理过后的结果了。</li>\n</ol>\n</li>\n<li>vuex 的实现最为简单，就是提供了两个回调函数，vuex 内部在合适的时机去调用（我个人感觉大部分的库提供这样的机制也足够了）。</li>\n<li>redux 的源码里写的最复杂最绕，它的中间件机制本质上就是用高阶函数不断的把 dispatch 包装再包装，形成套娃。本文实现的已经是精简了 n 倍以后的结果了，不过复杂的实现也是为了很多权衡和考量，Dan 对于闭包和高阶函数的运用已经炉火纯青了，只是外人去看源码有点头秃…</li>\n<li>koa 的洋葱模型实现的很精妙，和 redux 有相似之处，但是在源码理解和使用上个人感觉更优于 redux 的中间件。</li>\n</ol>\n<p>中间件机制其实是非框架强相关的，请求库一样可以加入 koa 的洋葱中间件机制（如 umi-request），不同的框架可能适合不同的中间件机制，这还是取决于你编写的框架想要解决什么问题，想给用户什么样的自由度。</p>\n<p>希望看了这篇文章的你，能对于前端库中的中间件机制有进一步的了解，进而为你自己的前端库加入合适的中间件能力。</p>\n<p>本文示例代码：<a href="https://github.com/towavephone/tiny-middlewares" target="_blank" rel="nofollow noreferrer noopener">https://github.com/towavephone/tiny-middlewares</a></p>',
excerpt:"前言 前端中的库很多，开发这些库的作者会尽可能的覆盖到大家在业务中千奇百怪的需求，但是总有无法预料到的，所以优秀的库就需要提供一种机制，让开发者可以干预插件中间的一些环节，从而完成自己的一些需求。 本文将从 koa、axios、vuex 和 redux…",frontmatter:{date:"2021-01-13 11:21:46",path:"/plug-interceptor-middleware/",tags:"前端, JS, 高级前端",title:"插件机制、拦截器、中间件",draft:null}}},pathContext:{mainPostPath:"/async-exception-throw-evolution/",nextPostPath:"/async-await-simplest-implementation/",prePostPath:"/plug-interceptor-middleware/"}}}});
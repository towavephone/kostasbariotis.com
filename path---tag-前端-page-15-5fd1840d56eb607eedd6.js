webpackJsonp([0xe8ce1f67335a],{1343:function(n,s){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"需求背景 最近在做表单分享的需求，类似于问卷调查，需要在三端（桌面端、移动端、微信端）同时兼容 技术方案 我出的方案：采用原生语法新框架写，考虑到首屏渲染的问题未采用 主管出的方案：采用后端渲染模板的方式，最大化首屏加载速度，但有以下问题： 后端渲染对服务器 CPU 的要求较高 本来打算用 oss 来减少后端渲染，但考虑到表单经常变化，且分享的链接要尽可能的保持不变，这就限制了 oss…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>最近在做表单分享的需求，类似于问卷调查，需要在三端（桌面端、移动端、微信端）同时兼容</p>\n<h1 id="技术方案"><a href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术方案</h1>\n<ol>\n<li>我出的方案：采用原生语法新框架写，考虑到首屏渲染的问题未采用</li>\n<li>\n<p>主管出的方案：采用后端渲染模板的方式，最大化首屏加载速度，但有以下问题：</p>\n<ol>\n<li>后端渲染对服务器 CPU 的要求较高</li>\n<li>本来打算用 oss 来减少后端渲染，但考虑到表单经常变化，且分享的链接要尽可能的保持不变，这就限制了 oss 的使用</li>\n<li>同样由于分享的链接要尽可能的保持不变，在新的表单分享模板加入后需要后端刷数据，容错性较低</li>\n</ol>\n</li>\n<li>最终讨论结果：采用前后端分离的方式，用原生语法新框架写，需要考虑到版本兼容（新的模板数据和旧的模板数据要同时兼容，在接口里面加一个版本号）、模板枚举 wiki 的命名（减少沟通成本同时缩短分享链接的长度）、loading 页（首屏加载时间可能较长）</li>\n</ol>\n<h1 id="方案调研"><a href="#%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案调研</h1>\n<p>刚开始考虑到用官网的框架，但是由于官网的框架构建过程有太多冗余的东西、以及只能在 node v9.11.2 里面使用的原因，决定自己在 <a href="https://github.com/yeoman/generator-webapp" target="_blank" rel="nofollow noreferrer noopener">generator-webapp</a> 生成的框架上做一下改造，以下是改造的要点：</p>\n<ol>\n<li>资源文件 hash</li>\n<li>接口代理</li>\n<li>模板功能</li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="构建框架搭建"><a href="#%E6%9E%84%E5%BB%BA%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>构建框架搭建</h2>\n<h3 id="gulp-打包优化"><a href="#gulp-%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>gulp 打包优化</h3>\n<p>gulpfile.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82107206857840210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// generated on 2019-11-07 using generator-webapp 4.0.0-6\nconst { src, dest, watch, series, parallel, lastRun } = require(\'gulp\');\nconst gulpLoadPlugins = require(\'gulp-load-plugins\');\nconst browserSync = require(\'browser-sync\');\nconst del = require(\'del\');\n// const autoprefixer = require(\'autoprefixer\');\nconst cssnano = require(\'cssnano\');\nconst { argv } = require(\'yargs\');\nconst proxy = require(\'http-proxy-middleware\');\nconst postcssPresetEnv = require(\'postcss-preset-env\');\n\nconst config = require(\'./proxy.json\');\nconst globalJSON = require(\'./global.json\');\n\nconst \\$ = gulpLoadPlugins();\nconst server = browserSync.create();\n\nconst port = argv.port || config.port || 9000;\nconst buildPath = argv.buildPath || \'build\';\nconst varsEnv = argv.server || \'master\';\nconst globalVars = globalJSON.runtime[varsEnv];\nconst publicPath = argv.publicPath || \'/form\';\n\nconst isProd = process.env.NODE_ENV === \'production\';\nconst isTest = process.env.NODE_ENV === \'test\';\nconst isDev = !isProd && !isTest;\n\n// 配置反向代理\nconst middleware = config.proxies.map((item) =>\n  proxy(item.match, {\n    target: item.host,\n    changeOrigin: true\n  })\n);\n\nfunction styles() {\n  return src(\'app/styles/*.css\')\n    .pipe(\\$.if(!isProd, \\$.sourcemaps.init()))\n    .pipe(\n      \\$.postcss([\n        // autoprefixer(),\n        // 采用 postcss 最新语法\n        postcssPresetEnv({\n          stage: 0\n        })\n      ])\n    )\n    .pipe(\\$.if(!isProd, \\$.sourcemaps.write()))\n    .pipe(dest(\'.tmp/styles\'))\n    .pipe(server.reload({ stream: true }));\n}\n\nfunction scripts() {\n  return (\n    src(\'app/scripts/**/*.js\')\n      // plumber 插件防止 gulp 报错崩溃\n      .pipe(\\$.plumber())\n      .pipe(\\$.if(!isProd, \\$.sourcemaps.init()))\n      .pipe(\\$.babel())\n      .pipe(\\$.if(!isProd, \\$.sourcemaps.write(\'.\')))\n      .pipe(dest(\'.tmp/scripts\'))\n      .pipe(server.reload({ stream: true }))\n  );\n}\n\nconst lintBase = (files) => {\n  return src(files)\n    .pipe(\\$.eslint({ fix: true }))\n    .pipe(server.reload({ stream: true, once: true }))\n    .pipe(\\$.eslint.format())\n    .pipe(\\$.if(!server.active, \\$.eslint.failAfterError()));\n};\n\nfunction lint() {\n  return lintBase(\'app/scripts/**/*.js\').pipe(dest(\'app/scripts\'));\n}\n\nfunction lintTest() {\n  return lintBase(\'test/spec/**/*.js\').pipe(dest(\'test/spec\'));\n}\n\nfunction html() {\n  // 合成 js、css 过程中，要过滤掉模板编译文件夹的代码\n  // 注意这里的 useref 插件合成 js、css 有一个问题文件行尾必须为 crlf，否则此文件不能正常合成\n  // 可用 .editorconfig 来限制文件行尾符\n  return src([\'app/**/*.html\', \'.tmp/**/*.html\', \'!app/common/**/*.html\', \'!.tmp/common/**/*.html\'])\n    .pipe(\\$.useref({ searchPath: [\'.tmp\', \'app\', \'.\'] }))\n    .pipe(\\$.if(/\\.js\\$/, \\$.uglify({ compress: { drop_console: true } })))\n    .pipe(\\$.if(/\\.css\\$/, \\$.postcss([cssnano({ safe: true, autoprefixer: false })])))\n    .pipe(\n      \\$.if(\n        /\\.html\\$/,\n        \\$.htmlmin({\n          collapseWhitespace: true,\n          minifyCSS: true,\n          minifyJS: { compress: { drop_console: true } },\n          processConditionalComments: true,\n          removeComments: true,\n          removeEmptyAttributes: true,\n          removeScriptTypeAttributes: true,\n          removeStyleLinkTypeAttributes: true\n        })\n      )\n    )\n    .pipe(dest(buildPath));\n}\n\nfunction images() {\n  return src(\'app/images/**/*\', { since: lastRun(images) }).pipe(dest(\\`\\${buildPath}/images\\`));\n}\n\nfunction fonts() {\n  return src(\'app/fonts/**/*.{eot,svg,ttf,woff,woff2}\').pipe(\n    \\$.if(!isProd, dest(\'.tmp/fonts\'), dest(\\`\\${buildPath}/fonts\\`))\n  );\n}\n\nfunction extras() {\n  // 过滤掉模板编译文件夹的代码与 html 代码\n  return src([\'app/*\', \'!app/**/*.html\', \'!app/common\'], {\n    dot: true\n  }).pipe(dest(buildPath));\n}\n\nfunction clean() {\n  return del([\'.tmp\', \\`\\${buildPath}/*\\`]);\n}\n\nfunction measureSize() {\n  return src(\\`\\${buildPath}/**/*\\`).pipe(\\$.size({ title: \'build\', gzip: true }));\n}\n\nconst build = series(\n  clean,\n  parallel(lint, series(parallel(styles, scripts, fileVarInclude), html), images, fonts, extras),\n  revAll,\n  measureSize\n);\n\nfunction startAppServer() {\n  server.init({\n    notify: false,\n    port,\n    server: {\n      baseDir: [\'.tmp\', \'app\'],\n      routes: {\n        \'/node_modules\': \'node_modules\'\n      },\n      middleware\n    }\n  });\n\n  watch([\'app/**/*.html\', \'app/images/**/*\', \'.tmp/fonts/**/*\']).on(\'change\', server.reload);\n\n  watch(\'app/styles/*.css\', styles);\n  watch(\'app/scripts/**/*.js\', scripts);\n  watch(\'app/fonts/**/*\', fonts);\n  // 监控 html 编译模板改动\n  watch(\'app/**/*.html\', fileVarInclude);\n}\n\nfunction startTestServer() {\n  server.init({\n    notify: false,\n    port,\n    ui: false,\n    server: {\n      baseDir: \'test\',\n      routes: {\n        \'/scripts\': \'.tmp/scripts\',\n        \'/node_modules\': \'node_modules\'\n      }\n    }\n  });\n\n  watch(\'app/scripts/**/*.js\', scripts);\n  watch([\'test/spec/**/*.js\', \'test/index.html\']).on(\'change\', server.reload);\n  watch(\'test/spec/**/*.js\', lintTest);\n}\n\nfunction startDistServer() {\n  server.init({\n    notify: false,\n    port,\n    server: {\n      baseDir: buildPath,\n      routes: {\n        \'/node_modules\': \'node_modules\',\n        // 注意这里的别名也要配置，否则资源访问不到\n        [publicPath]: buildPath\n      },\n      middleware\n    }\n  });\n}\n\n// 资源 hash，注意要在最后一步，同时配置路径别名，注意所有的资源引用必须以 &quot;/&quot; 开头，否则别名替换不成功\nfunction revAll() {\n  return src(\\`\\${buildPath}/**\\`)\n    .pipe(\n      \\$.revAll.revision({\n        prefix: publicPath,\n        dontRenameFile: [/^\\/favicon.ico\\$/g, \'.html\', \'robots.txt\']\n      })\n    )\n    .pipe(\\$.revDeleteOriginal())\n    .pipe(dest(buildPath));\n}\n\nfunction fileVarInclude() {\n  return src(\'app/**/*.html\')\n    .pipe(\\$.plumber())\n    .pipe(\n      \\$.fileInclude({\n        prefix: \'@@\',\n        basepath: \'@root\',\n        // 环境变量注入\n        // 需要在公共的模板文件中注入此变量\n        // <script>\n        //   window.GLOBAL_VARS = @@GLOBAL_VARS;\n        // </script>\n        context: {\n          GLOBAL_VARS: JSON.stringify(globalVars)\n        }\n      })\n    )\n    .pipe(dest(\'.tmp\'))\n    .pipe(server.reload({ stream: true }));\n}\n\nlet serve;\nif (isDev) {\n  serve = series(clean, parallel(styles, scripts, fonts, fileVarInclude), startAppServer);\n} else if (isTest) {\n  serve = series(clean, scripts, startTestServer);\n} else if (isProd) {\n  serve = series(build, startDistServer);\n}\n\nexports.serve = serve;\nexports.build = build;\nexports.default = build;`, `82107206857840210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// generated on 2019-11-07 using generator-webapp 4.0.0-6</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> watch<span class="token punctuation">,</span> series<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> lastRun <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> gulpLoadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gulp-load-plugins\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'browser-sync\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'del\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// const autoprefixer = require(\'autoprefixer\');</span>\n<span class="token keyword">const</span> cssnano <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'cssnano\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http-proxy-middleware\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> postcssPresetEnv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'postcss-preset-env\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./proxy.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">gulpLoadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> server <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> port <span class="token operator">=</span> argv<span class="token punctuation">.</span>port <span class="token operator">||</span> config<span class="token punctuation">.</span>port <span class="token operator">||</span> <span class="token number">9000</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> buildPath <span class="token operator">=</span> argv<span class="token punctuation">.</span>buildPath <span class="token operator">||</span> <span class="token string">\'build\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> varsEnv <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalVars <span class="token operator">=</span> globalJSON<span class="token punctuation">.</span>runtime<span class="token punctuation">[</span>varsEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> publicPath <span class="token operator">=</span> argv<span class="token punctuation">.</span>publicPath <span class="token operator">||</span> <span class="token string">\'/form\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> isTest <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">\'test\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> isDev <span class="token operator">=</span> <span class="token operator">!</span>isProd <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isTest<span class="token punctuation">;</span>\n\n<span class="token comment">// 配置反向代理</span>\n<span class="token keyword">const</span> middleware <span class="token operator">=</span> config<span class="token punctuation">.</span>proxies<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n  <span class="token function">proxy</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>match<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    target<span class="token punctuation">:</span> item<span class="token punctuation">.</span>host<span class="token punctuation">,</span>\n    changeOrigin<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">styles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/styles/*.css\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span><span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n        <span class="token comment">// autoprefixer(),</span>\n        <span class="token operator">/</span><span class="token operator">/</span> 采用 postcss 最新语法\n        <span class="token function">postcssPresetEnv</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          stage<span class="token punctuation">:</span> <span class="token number">0</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/styles\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">scripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">)</span>\n      <span class="token comment">// plumber 插件防止 gulp 报错崩溃</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">plumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> $<span class="token punctuation">.</span>sourcemaps<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/scripts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">lintBase</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">eslint</span><span class="token punctuation">(</span><span class="token punctuation">{</span> fix<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> once<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span>eslint<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>active<span class="token punctuation">,</span> $<span class="token punctuation">.</span>eslint<span class="token punctuation">.</span><span class="token function">failAfterError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">lint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">lintBase</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'app/scripts\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">lintTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">lintBase</span><span class="token punctuation">(</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'test/spec\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 合成 js、css 过程中，要过滤掉模板编译文件夹的代码</span>\n  <span class="token comment">// 注意这里的 useref 插件合成 js、css 有一个问题文件行尾必须为 crlf，否则此文件不能正常合成</span>\n  <span class="token comment">// 可用 .editorconfig 来限制文件行尾符</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'.tmp/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/common/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!.tmp/common/**/*.html\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token string">\'app\'</span><span class="token punctuation">,</span> <span class="token string">\'.\'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\\.js$/</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> compress<span class="token punctuation">:</span> <span class="token punctuation">{</span> drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\\.css$/</span><span class="token punctuation">,</span> $<span class="token punctuation">.</span><span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">cssnano</span><span class="token punctuation">(</span><span class="token punctuation">{</span> safe<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoprefixer<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span>\n        <span class="token regex">/\\.html$/</span><span class="token punctuation">,</span>\n        $<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          minifyCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          minifyJS<span class="token punctuation">:</span> <span class="token punctuation">{</span> compress<span class="token punctuation">:</span> <span class="token punctuation">{</span> drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          processConditionalComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          removeEmptyAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          removeScriptTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n          removeStyleLinkTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/images/**/*\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> since<span class="token punctuation">:</span> <span class="token function">lastRun</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/images</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">fonts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/fonts/**/*.{eot,svg,ttf,woff,woff2}\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n    $<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">,</span> <span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp/fonts\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dest</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/fonts</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">extras</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 过滤掉模板编译文件夹的代码与 html 代码</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/*\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'!app/common\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    dot<span class="token punctuation">:</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">measureSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">\'build\'</span><span class="token punctuation">,</span> gzip<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>\n  clean<span class="token punctuation">,</span>\n  <span class="token function">parallel</span><span class="token punctuation">(</span>lint<span class="token punctuation">,</span> <span class="token function">series</span><span class="token punctuation">(</span><span class="token function">parallel</span><span class="token punctuation">(</span>styles<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">,</span> images<span class="token punctuation">,</span> fonts<span class="token punctuation">,</span> extras<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  revAll<span class="token punctuation">,</span>\n  measureSize\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">startAppServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">,</span>\n    server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      baseDir<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'.tmp\'</span><span class="token punctuation">,</span> <span class="token string">\'app\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      middleware\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> <span class="token string">\'app/images/**/*\'</span><span class="token punctuation">,</span> <span class="token string">\'.tmp/fonts/**/*\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'change\'</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>reload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/styles/*.css\'</span><span class="token punctuation">,</span> styles<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">,</span> scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/fonts/**/*\'</span><span class="token punctuation">,</span> fonts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 监控 html 编译模板改动</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">startTestServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">,</span>\n    ui<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      baseDir<span class="token punctuation">:</span> <span class="token string">\'test\'</span><span class="token punctuation">,</span>\n      routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'/scripts\'</span><span class="token punctuation">:</span> <span class="token string">\'.tmp/scripts\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'app/scripts/**/*.js\'</span><span class="token punctuation">,</span> scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">,</span> <span class="token string">\'test/index.html\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'change\'</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>reload<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">\'test/spec/**/*.js\'</span><span class="token punctuation">,</span> lintTest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">startDistServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    notify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    port<span class="token punctuation">,</span>\n    server<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      baseDir<span class="token punctuation">:</span> buildPath<span class="token punctuation">,</span>\n      routes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">\'/node_modules\'</span><span class="token punctuation">:</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">,</span>\n        <span class="token comment">// 注意这里的别名也要配置，否则资源访问不到</span>\n        <span class="token punctuation">[</span>publicPath<span class="token punctuation">]</span><span class="token punctuation">:</span> buildPath\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      middleware\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 资源 hash，注意要在最后一步，同时配置路径别名，注意所有的资源引用必须以 "/" 开头，否则别名替换不成功</span>\n<span class="token keyword">function</span> <span class="token function">revAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span>revAll<span class="token punctuation">.</span><span class="token function">revision</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        prefix<span class="token punctuation">:</span> publicPath<span class="token punctuation">,</span>\n        dontRenameFile<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/^\\/favicon.ico$/g</span><span class="token punctuation">,</span> <span class="token string">\'.html\'</span><span class="token punctuation">,</span> <span class="token string">\'robots.txt\'</span><span class="token punctuation">]</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">revDeleteOriginal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>buildPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">fileVarInclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">\'app/**/*.html\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">plumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>\n      $<span class="token punctuation">.</span><span class="token function">fileInclude</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        prefix<span class="token punctuation">:</span> <span class="token string">\'@@\'</span><span class="token punctuation">,</span>\n        basepath<span class="token punctuation">:</span> <span class="token string">\'@root\'</span><span class="token punctuation">,</span>\n        <span class="token comment">// 环境变量注入</span>\n        <span class="token comment">// 需要在公共的模板文件中注入此变量</span>\n        <span class="token comment">// &lt;script></span>\n        <span class="token comment">//   window.GLOBAL_VARS = @@GLOBAL_VARS;</span>\n        <span class="token comment">// &lt;/script></span>\n        context<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          <span class="token constant">GLOBAL_VARS</span><span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>globalVars<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">\'.tmp\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">let</span> serve<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>isDev<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>styles<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> fonts<span class="token punctuation">,</span> fileVarInclude<span class="token punctuation">)</span><span class="token punctuation">,</span> startAppServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isTest<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> scripts<span class="token punctuation">,</span> startTestServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  serve <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>build<span class="token punctuation">,</span> startDistServer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nexports<span class="token punctuation">.</span>serve <span class="token operator">=</span> serve<span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>build <span class="token operator">=</span> build<span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span>default <span class="token operator">=</span> build<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="文件目录结构"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录结构</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-0f2f0.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 455px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 154.2857142857143%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAfCAIAAABoLHqZAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACVklEQVQ4y5WVSW7cMBBFdRH3pJmUOFOkRM1St9pT2okRIIvkALn/BVINeB3TQC318ate/aKCKMwP55fj+kwKHiN2jLF/BblofvTrr8trv90wNYgazKxnBWFOlXLb45sbL7ado4zeK/eq4BghxE338k6EqeoeE3WIkGcFhxgTom7jZtzYDqvQzSkpfGc+JgUl8nfbgy2V9e6YfgFYGBcRVdH3d2W6cbkiovZh7u0c45Kb7fWnaYZx3rhuYBhfMUyYl9L0i6raupsTxL4gDhOcs1q//TXNCMyg5684xzjBont67sbV9WvBqiSn/jMXSYYvKlbGVc3o+gVTYIZ8gcU5dbypbAd7tu3kDxzEKMEyW/+oeoDO63byZxY8xPhbN7+NS0pknJGHY7q/R89v5v0Jz9d6e13SXFBhSl4xVUcZ8TEPohNKnq7sdtOyDrMSzBNEPeMdHEOc1lpOTWV6sAXOD97xDnYhYoxJKdvhAnsqWZVi7g3slBnjrO3qdoZV9dPFuslXvIsLlSQNxlW7wFVaNxJuvJ0jXGV5S8hwhoSemW5g8wDMh1mwDzGjSEmq7AAJgcPcnTIon5DdxZQgrbltF+sGUw+67qGosJ82D7QxZ6gy8ArM0na6GbhqICdwHv8XQwqDfYQLhGVJtTCNNJTKXfh52/BsxmkR7GOcp4Ut6MD1KLQo2MGDM3yTpmVwgIRRLBxc5DqcH4flCi8hNPwp7Y+2AZippHFT004QsmHe7juTtQ+wgpNMiRIRTXiVlwI0YVp6heQQZrFwedVRrsGNSQt/HM+r+gcaZzZfDs4qsgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 15 48 13"\n        title=""\n        src="/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-0f2f0.png"\n        srcset="/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-f5c73.png 200w,\n/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-799a4.png 400w,\n/static/2019-11-15-15-48-13-26481053e92ef2ababdfbeb52c0758f8-0f2f0.png 455w"\n        sizes="(max-width: 455px) 100vw, 455px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id="代码优化"><a href="#%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码优化</h2>\n<ol>\n<li>除了在使用大量原生语法外，利用 gulp-file-include 插件大量复用了模板代码，确保多次使用的 html 代码在模板代码文件夹下。</li>\n<li>\n<p>同时为了首屏加载速度，图片需要压缩，这里用了阿里云的 oss 图片压缩服务，代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42191113853819085000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 参数的功能分别是调整宽度、质量、是否是渐进式、格式转换为 jpg\nfunction compressImg(oss, width = window.innerWidth) {\n return \\`\\${oss}?x-oss-process=image/resize,w_\\${width}/quality,q_50/interlace,1/format,jpg\\`;\n}`, `42191113853819085000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 参数的功能分别是调整宽度、质量、是否是渐进式、格式转换为 jpg</span>\n<span class="token keyword">function</span> <span class="token function">compressImg</span><span class="token punctuation">(</span><span class="token parameter">oss<span class="token punctuation">,</span> width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oss<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?x-oss-process=image/resize,w_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/quality,q_50/interlace,1/format,jpg</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>尽量在各自对应的平台加载相应的代码，比如微信分享脚本只在微信端加载，背景图只在桌面端加载，图片压缩的宽度尽可能的小</li>\n</ol>\n<h1 id="加载效果"><a href="#%E5%8A%A0%E8%BD%BD%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>加载效果</h1>\n<p>加载大小非自定义图片部分 28.4kb，自定义图片部分 57.5kb。</p>\n<p>加载速度（不限速）264ms，3g low（限速 120 kb/s）1.01s。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-c26ee.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 38.22505800464037%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABp0lEQVQY002Nj0vicBjG919fgdNCzQvKHwcHB0Ed1JVkRdN2rZmpc9bMzFrmlGbrh0xvszWnc23f9e2+GkUfXh6eF97nebGV5ZXE5laW2mfT9Nrv5WDAHwoGv4fmgn5/KBDw4bgP9/hmZn3+QCIeZ9PpzN+9PJViqFSOJDCOImunXDa5wzOZxMafb1PTHo8Hx3GkXq8XGaTvntiMn5C7VyUWTY1jrwp5jCFT60u/WHK7miFocndhMRyNRmOxWCQSCYfDSKMTkKWJbTa50SwzzYuyWCk1uCJ2nD38Oe8tFw5a9aqhdQFwHccBAFiWpaqqMwGttm2fc0fCZUmWBEngqyfF2jGLlXK5ev2sXi1IfNHsKxC+ffLFjrm/vRbK2ae2IN/fHFE0sZPE8vR+q8UPtEdDFZ0Xw3Vf4QcoDj8qkJqG2lfFF0PWtQ5N7a0ltjDm+lxRJMeQbf3BtY3x3eS7BSDXfq+YhOEbMDVHf7AHcrf3yEsNoX2H/VhdP6xU5KHWVDrKyER/wSsEEFrA/TcEQ9McDMdjjkbdwbPY64ha71Z/Fvv9hm78B0R1gs7qLKXOAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 16 27 42"\n        title=""\n        src="/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-fee1c.png"\n        srcset="/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-a67b7.png 200w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-0b187.png 400w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-fee1c.png 800w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-b1a91.png 1200w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-95179.png 1600w,\n/static/2019-11-15-16-27-42-46c87a87681f16c070037c0124d46f06-c26ee.png 1724w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-5fe3e.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 24.685314685314683%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAvElEQVQY021P2Y7EIAzr//9lpUIp5SyQhGOk9Y5m92ksZEUJjuPNO5dStPZOKd23U0qZU+f8jD7mnOMb/vsbCfU5ZQ6awkMaU2USrpmewsQivXd586cQ+TDzprS21p7G6BNkzHXhXcaEGBpRTKm1VkrBJOfMRBV4nuJcuOymldr3HTPvfQwhRhAQa22vtWopMGTm4ziwE8Lfo3sv3mfnNtghJwLPP6y1cBTcUIOhJCL8gd45h6h9DCzNKf0ArA0cKACop4UAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 16 28 14"\n        title=""\n        src="/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-fee1c.png"\n        srcset="/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-a67b7.png 200w,\n/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-0b187.png 400w,\n/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-fee1c.png 800w,\n/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-b1a91.png 1200w,\n/static/2019-11-15-16-28-14-4f975f8c28183d9577aadf2c3c6b4d5e-5fe3e.png 1430w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-4cbd1.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 41.47582697201018%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABFUlEQVQY01WRi26EIBBF/f9PbLJZH7AgCCqowG676RHbpL2AmbnzuAM2s1drWEKMgbVF752drPEWt5SUnjmVXMqzcP4Dpsk5HQf72FkXUkq5pGP3i5m2NRx73I8Ml/O2bcRzBVmN1mqaJpzyFznTO4SI6uv1ijHu+47hnLMVy7KQ0IihGwZB8VfF5y+w17DS5ypGEFJr3XVd3/fowTft/Y4vpcQ3xrgK7MvIPyMEhiSbhLZtkcU+7yyF6CrGcaQxZUxlKii+3oaZ6YIyISEEIWY5lfU4KnVem+d7v9/n6Hzr5nnIgCAVZaLeeyqRQRy++bjd7m0rldLQ/CXnjHyYQVrxYCRrJ+fnh9KjsW6eByF6jjwJ3G+x1cS1cLEYUwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 16 30 09"\n        title=""\n        src="/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-fee1c.png"\n        srcset="/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-a67b7.png 200w,\n/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-0b187.png 400w,\n/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-fee1c.png 800w,\n/static/2019-11-15-16-30-09-4b6fd09d0de380a0692b6b9f19a6ccf0-4cbd1.png 1179w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-28530.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 54.91559086395233%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABiklEQVQoz11S25ajIBDk/39wzz6sSYwakQACzV3NFPqwM1OnT1M2tH1lqxAUklbqNU3DOM5dJ7tOCCGl0lpLKY0x/hvI0yXg7Ph8jhP7th17Ayxb3XZ846jQW7uF/dS11pxLBlJiec8heJvdGp0vZfXO52KCo1w1BZfpHY2KaaGkYhWUZIzCWxUzt4EJbY1P0nppSbmoCZK0b1pBrOfaKIqrz2Kltw3aJ+XCAq9Q2Z/b+PfBu0mN0gu3SX9Iv7+paXBuSs+tCh9wPOi5AV/s9m+Q3aTZOD7RKjTirLF8l32rOUVydm/Fl+BB7WWcpnHhMxufj6HvrbHoRPkJWEIIqzG1/bZYBxBojPFxv/e3G5PPp+26ME2JqPzyR2Nj9PNcnAPHA/S2GUNwfe9fL/YcRvwGgpH+D35OA2eLrBSGgyvkDEEWiHy/NTC+zHzm2AciOie74d3WxoqBHwnZXvZaryUBTynxZUEwxjlf19XaVhGW6ayLzCzE4yWHxQ6jFQL7gKW4nJEOnJERyBdhznPZL6HixAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 11 15 16 32 29"\n        title=""\n        src="/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-fee1c.png"\n        srcset="/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-a67b7.png 200w,\n/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-0b187.png 400w,\n/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-fee1c.png 800w,\n/static/2019-11-15-16-32-29-fce276c77308f4105fbcf2e23ccfa98e-28530.png 1007w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>',
id:"/github/workspace/blog/轻量级网站构建实践/index.md absPath of file >>> MarkdownRemark",timeToRead:5,frontmatter:{date:"2019-11-15 15:04:04",path:"/lightweight-website-construction/",tags:"前端, 轻量级网站, 预研",title:"轻量级网站构建实践",draft:null}},{excerpt:"需求背景 需求背景接上文  记一次组件打包为链接的实践 框架搭建接上文  Webpack 脚手架搭建笔记——记一次新项目搭建 组件轻量化 在将客服组件上线后，由于未考虑到加载的组件包的大小，尤其是初始加载的包比较大，即使是压缩过初始加载也有 600 多 k…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>需求背景接上文 <a href="/components-pack-as-library/">记一次组件打包为链接的实践</a></p>\n<p>框架搭建接上文 <a href="/webpack-template-new-project/">Webpack 脚手架搭建笔记——记一次新项目搭建</a></p>\n<h2 id="组件轻量化"><a href="#%E7%BB%84%E4%BB%B6%E8%BD%BB%E9%87%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件轻量化</h2>\n<p>在将客服组件上线后，由于未考虑到加载的组件包的大小，尤其是初始加载的包比较大，即使是压缩过初始加载也有 600 多 k，严重影响首页加载，导致加载此脚本的网站需要很长时间才能响应，所以有了这次的优化任务</p>\n<h2 id="移动端适配"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端适配</h2>\n<p>根据产品要求，此客服组件还需要兼容到移动端，微信端（微信网页、小程序）</p>\n<h1 id="方案调研"><a href="#%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方案调研</h1>\n<ol>\n<li>组件异步加载，减少首屏加载大小，非首屏且较大的组件预加载，这里需要 nginx 的配合</li>\n<li>去除较大的库，改用轻量级的替代库或者不用</li>\n<li>所有用到的组件最好都由自己编写，有利于定制化功能、减小组件大小</li>\n<li>移动端可以和桌面端项目写在一起分开打包</li>\n<li>代码的分层尤其是 IM 层要分离出来，便于切换不同的 IM 提供商</li>\n<li>小程序端用 webview 加载的网页，需要注意在第三方小程序上配置 nginx</li>\n</ol>\n<h1 id="具体实施"><a href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E6%96%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体实施</h1>\n<h2 id="组件异步加载"><a href="#%E7%BB%84%E4%BB%B6%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件异步加载</h2>\n<p>需要修改 webpack 配置，由于之前是在 webpack2 上开发，不能很完美的做到异步加载。此时将框架升级到和本文 <a href="/webpack-template-new-project/">Webpack 脚手架搭建笔记——记一次新项目搭建</a> 的同一版本，具体修改如下：</p>\n<ol>\n<li>\n<p>去除 mini-css-extract-plugin，防止 css 单独抽离</p>\n</li>\n<li>\n<p>聚合初始加载脚本到一个文件，异步加载的在其他文件，且对异步加载的做 hash 处理</p>\n<p>boot\\internals\\webpack\\webpack.prod.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14690619964719763000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`entry: {\n bundle: [\'runtime/polyfill\', path.join(process.cwd(), buildMap.indexEntry)],\n},\n\noutput: {\n filename: \'[name].js\',\n chunkFilename: \'[name].[chunkhash].chunk.js\',\n},\n\n// 关闭代码切割，防止首页产生除 bundle.js 外的其他文件\n// runtimeChunk: \'single\',\nsplitChunks: false,`, `14690619964719763000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n bundle<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'runtime/polyfill\'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\noutput<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n filename<span class="token punctuation">:</span> <span class="token string">\'[name].js\'</span><span class="token punctuation">,</span>\n chunkFilename<span class="token punctuation">:</span> <span class="token string">\'[name].[chunkhash].chunk.js\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 关闭代码切割，防止首页产生除 bundle.js 外的其他文件</span>\n<span class="token comment">// runtimeChunk: \'single\',</span>\nsplitChunks<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>生成构建文件如下：</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 539px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 34.137291280148425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA7ElEQVQY03WQ2W7DIBBF/SnOZmzMDDuG9rEPVZQ2iqqm//8pvUCk9qGVrq6AmTMLQ3x6OV9vLj4rW1adF05/i355k+Q0jEd1v4gQPQHmsJ/UARJ0EKqJ/tPutA67ie9v0nkrlNduI5vYbdplpSPbRG7D1fhsY4HXkM/KJLhYTYU/L9IHN1MACVXShF6ITDS+IBWyoZiAc0EJZSKiFf56ly7YWTXYpFUHeG9IrQlGQIneHxPhcSE3HuWwn/jjdcHY+ADAkr2qcM3oKyC7lrOp+2lmYFi47Swoz9Joz3XaiA8bWwAZD/2c8f7Aur4Bl0hM5Y3OZe0AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 11 25 49"\n        title=""\n        src="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png"\n        srcset="/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-e7723.png 200w,\n/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-61f03.png 400w,\n/static/2019-10-29-11-25-49-52973421bbd67ac1dffeb36422f56687-b043c.png 539w"\n        sizes="(max-width: 539px) 100vw, 539px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-b1a91.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 38.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA8klEQVQY033Q227DIAwG4DzLtuYA2GDAxpAmat//pUrSVdsuVumTZS7gNx50vSOV0cbL7C+L/5zwvY8RF0gY9WvGIVHdyy51c0GBdAGeXX5vsnk0qTcDexUqQDJDHm2aTJrst9nmw/+vDDnULTVujbYWWYOoP6GoS6UzyH9jj8zpNHCoShVTgazYSQ1JQ1QX1QBb4AWk/2VBMSeL5ajApl8OoTbeGzVt91RvmjepN77eO1lvm1y17Z5Xii2kFag+eV8A5ViYeHVBXDxYz44EcrFJ7Dk2cDEkCGLOmX820pOJVu/rDGV5wrO619G9ejwY1N8ehLJaU7IJP7EAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 11 26 45"\n        title=""\n        src="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-fee1c.png"\n        srcset="/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-a67b7.png 200w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-0b187.png 400w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-fee1c.png 800w,\n/static/2019-10-29-11-26-45-856737e302518cc91ca426b14af2d2a5-b1a91.png 1200w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>首页只会引入 bundle.js 文件，且异步组件在其他文件</p>\n<h2 id="较大组件预加载"><a href="#%E8%BE%83%E5%A4%A7%E7%BB%84%E4%BB%B6%E9%A2%84%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>较大组件预加载</h2>\n<p>这里为了打开聊天组件时不会卡顿，使用了预加载，一定要注意要在主入口加载完成，也就是请求加载完成后在进行预加载，否则同样会造成首页加载时间过长</p>\n<p>这里采取的方案是请求完成后要提前知道加载哪个组件就立即预加载此组件（需要后端配合，不适用于点击后才知道加载哪个组件的情况。当然也可以全部预加载所有较大组件，不过为了省流就没这么做），不用等到点击后加载</p>\n<h2 id="精简依赖库"><a href="#%E7%B2%BE%E7%AE%80%E4%BE%9D%E8%B5%96%E5%BA%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>精简依赖库</h2>\n<h3 id="打包前依赖"><a href="#%E6%89%93%E5%8C%85%E5%89%8D%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包前依赖</h3>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5025180235954085000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;dependencies&quot;: {\n &quot;antd&quot;: &quot;^3.11.0&quot;,\n &quot;babel-polyfill&quot;: &quot;6.26.0&quot;,\n &quot;classnames&quot;: &quot;^2.2.5&quot;,\n &quot;element-resize-event&quot;: &quot;^2.0.9&quot;,\n &quot;immutable&quot;: &quot;3.8.1&quot;,\n &quot;invariant&quot;: &quot;2.2.2&quot;,\n &quot;lodash&quot;: &quot;4.17.2&quot;,\n &quot;md5&quot;: &quot;^2.2.1&quot;,\n &quot;moment&quot;: &quot;^2.18.1&quot;,\n &quot;prop-types&quot;: &quot;^15.6.2&quot;,\n &quot;raf&quot;: &quot;^3.4.1&quot;,\n &quot;react&quot;: &quot;16.6.0&quot;,\n &quot;react-dom&quot;: &quot;16.6.0&quot;,\n &quot;react-helmet&quot;: &quot;5.2.0&quot;,\n &quot;react-player&quot;: &quot;^1.6.4&quot;,\n &quot;react-redux&quot;: &quot;5.1.0&quot;,\n &quot;react-router&quot;: &quot;3.2.1&quot;,\n &quot;react-router-redux&quot;: &quot;4.0.6&quot;,\n &quot;react-router-scroll&quot;: &quot;0.4.4&quot;,\n &quot;redux&quot;: &quot;3.6.0&quot;,\n &quot;redux-immutable&quot;: &quot;3.0.8&quot;,\n &quot;redux-saga&quot;: &quot;0.16.2&quot;,\n &quot;reselect&quot;: &quot;2.5.4&quot;,\n &quot;rxjs&quot;: &quot;5.5.3&quot;,\n &quot;smoothscroll-polyfill&quot;: &quot;^0.3.6&quot;,\n &quot;warning&quot;: &quot;3.0.0&quot;,\n &quot;whatwg-fetch&quot;: &quot;2.0.1&quot;\n},`, `5025180235954085000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"antd"</span><span class="token punctuation">:</span> <span class="token string">"^3.11.0"</span><span class="token punctuation">,</span>\n <span class="token string">"babel-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"6.26.0"</span><span class="token punctuation">,</span>\n <span class="token string">"classnames"</span><span class="token punctuation">:</span> <span class="token string">"^2.2.5"</span><span class="token punctuation">,</span>\n <span class="token string">"element-resize-event"</span><span class="token punctuation">:</span> <span class="token string">"^2.0.9"</span><span class="token punctuation">,</span>\n <span class="token string">"immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.8.1"</span><span class="token punctuation">,</span>\n <span class="token string">"invariant"</span><span class="token punctuation">:</span> <span class="token string">"2.2.2"</span><span class="token punctuation">,</span>\n <span class="token string">"lodash"</span><span class="token punctuation">:</span> <span class="token string">"4.17.2"</span><span class="token punctuation">,</span>\n <span class="token string">"md5"</span><span class="token punctuation">:</span> <span class="token string">"^2.2.1"</span><span class="token punctuation">,</span>\n <span class="token string">"moment"</span><span class="token punctuation">:</span> <span class="token string">"^2.18.1"</span><span class="token punctuation">,</span>\n <span class="token string">"prop-types"</span><span class="token punctuation">:</span> <span class="token string">"^15.6.2"</span><span class="token punctuation">,</span>\n <span class="token string">"raf"</span><span class="token punctuation">:</span> <span class="token string">"^3.4.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react"</span><span class="token punctuation">:</span> <span class="token string">"16.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-dom"</span><span class="token punctuation">:</span> <span class="token string">"16.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-helmet"</span><span class="token punctuation">:</span> <span class="token string">"5.2.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-player"</span><span class="token punctuation">:</span> <span class="token string">"^1.6.4"</span><span class="token punctuation">,</span>\n <span class="token string">"react-redux"</span><span class="token punctuation">:</span> <span class="token string">"5.1.0"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router"</span><span class="token punctuation">:</span> <span class="token string">"3.2.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router-redux"</span><span class="token punctuation">:</span> <span class="token string">"4.0.6"</span><span class="token punctuation">,</span>\n <span class="token string">"react-router-scroll"</span><span class="token punctuation">:</span> <span class="token string">"0.4.4"</span><span class="token punctuation">,</span>\n <span class="token string">"redux"</span><span class="token punctuation">:</span> <span class="token string">"3.6.0"</span><span class="token punctuation">,</span>\n <span class="token string">"redux-immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.0.8"</span><span class="token punctuation">,</span>\n <span class="token string">"redux-saga"</span><span class="token punctuation">:</span> <span class="token string">"0.16.2"</span><span class="token punctuation">,</span>\n <span class="token string">"reselect"</span><span class="token punctuation">:</span> <span class="token string">"2.5.4"</span><span class="token punctuation">,</span>\n <span class="token string">"rxjs"</span><span class="token punctuation">:</span> <span class="token string">"5.5.3"</span><span class="token punctuation">,</span>\n <span class="token string">"smoothscroll-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"^0.3.6"</span><span class="token punctuation">,</span>\n <span class="token string">"warning"</span><span class="token punctuation">:</span> <span class="token string">"3.0.0"</span><span class="token punctuation">,</span>\n <span class="token string">"whatwg-fetch"</span><span class="token punctuation">:</span> <span class="token string">"2.0.1"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="打包后依赖"><a href="#%E6%89%93%E5%8C%85%E5%90%8E%E4%BE%9D%E8%B5%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打包后依赖</h3>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28600676300484840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;dependencies&quot;: {\n &quot;array-tree-filter&quot;: &quot;^2.1.0&quot;,\n &quot;babel-polyfill&quot;: &quot;6.26.0&quot;,\n &quot;classnames&quot;: &quot;2.2.5&quot;,\n &quot;immutable&quot;: &quot;3.8.2&quot;,\n &quot;lodash&quot;: &quot;4.17.2&quot;,\n &quot;prop-types&quot;: &quot;15.6.2&quot;,\n &quot;rc-dialog&quot;: &quot;^7.5.7&quot;,\n &quot;rc-notification&quot;: &quot;^3.3.1&quot;,\n &quot;rc-select&quot;: &quot;^9.2.0&quot;,\n &quot;rc-tooltip&quot;: &quot;^3.7.3&quot;,\n &quot;rc-upload&quot;: &quot;^2.8.1&quot;,\n &quot;react-lite&quot;: &quot;^0.15.40&quot;,\n &quot;react-loadable&quot;: &quot;5.5.0&quot;,\n &quot;rmc-cascader&quot;: &quot;^5.0.3&quot;,\n &quot;rmc-feedback&quot;: &quot;^2.0.0&quot;,\n &quot;rmc-picker&quot;: &quot;^5.0.10&quot;,\n &quot;whatwg-fetch&quot;: &quot;3.0.0&quot;\n},`, `28600676300484840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"dependencies"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"array-tree-filter"</span><span class="token punctuation">:</span> <span class="token string">"^2.1.0"</span><span class="token punctuation">,</span>\n <span class="token string">"babel-polyfill"</span><span class="token punctuation">:</span> <span class="token string">"6.26.0"</span><span class="token punctuation">,</span>\n <span class="token string">"classnames"</span><span class="token punctuation">:</span> <span class="token string">"2.2.5"</span><span class="token punctuation">,</span>\n <span class="token string">"immutable"</span><span class="token punctuation">:</span> <span class="token string">"3.8.2"</span><span class="token punctuation">,</span>\n <span class="token string">"lodash"</span><span class="token punctuation">:</span> <span class="token string">"4.17.2"</span><span class="token punctuation">,</span>\n <span class="token string">"prop-types"</span><span class="token punctuation">:</span> <span class="token string">"15.6.2"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-dialog"</span><span class="token punctuation">:</span> <span class="token string">"^7.5.7"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-notification"</span><span class="token punctuation">:</span> <span class="token string">"^3.3.1"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-select"</span><span class="token punctuation">:</span> <span class="token string">"^9.2.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-tooltip"</span><span class="token punctuation">:</span> <span class="token string">"^3.7.3"</span><span class="token punctuation">,</span>\n <span class="token string">"rc-upload"</span><span class="token punctuation">:</span> <span class="token string">"^2.8.1"</span><span class="token punctuation">,</span>\n <span class="token string">"react-lite"</span><span class="token punctuation">:</span> <span class="token string">"^0.15.40"</span><span class="token punctuation">,</span>\n <span class="token string">"react-loadable"</span><span class="token punctuation">:</span> <span class="token string">"5.5.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-cascader"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.3"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-feedback"</span><span class="token punctuation">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>\n <span class="token string">"rmc-picker"</span><span class="token punctuation">:</span> <span class="token string">"^5.0.10"</span><span class="token punctuation">,</span>\n <span class="token string">"whatwg-fetch"</span><span class="token punctuation">:</span> <span class="token string">"3.0.0"</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="主要变化"><a href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主要变化</h3>\n<ol>\n<li>\n<p>去除比较大的依赖库 antd、moment、rxjs</p>\n</li>\n<li>\n<p>替换 react 为 react-lite</p>\n<p>其中需要对 react-lite 做下兼容处理，不影响之前依赖 react 的代码</p>\n<p>boot\\internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60847415271470700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'react\': path.resolve(process.cwd(), \'node_modules/react-lite\'),\n\'react-dom\': path.resolve(process.cwd(), \'node_modules/react-lite\'),`, `60847415271470700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'react\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/react-lite\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token string">\'react-dom\'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/react-lite\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h2 id="组件自编写"><a href="#%E7%BB%84%E4%BB%B6%E8%87%AA%E7%BC%96%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件自编写</h2>\n<p>此项目的所有组件使用 antd、antd-mobile 的底层组件，以便优化包大小、自定义功能，组件接口尽量保持一致</p>\n<h3 id="antd-引入方式兼容"><a href="#antd-%E5%BC%95%E5%85%A5%E6%96%B9%E5%BC%8F%E5%85%BC%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>antd 引入方式兼容</h3>\n<p>之前的项目用到 antd，这里采用了和 antd 一样的引用方式。</p>\n<p>作用：有利于代码分割，不会将 antd 的组件代码分割到主入口，antd-mobile 同理。</p>\n<p>.babelrc</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10140600543027190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[\n   &quot;import&quot;,\n   {\n     &quot;libraryName&quot;: &quot;antd&quot;,\n     &quot;libraryDirectory&quot;: &quot;components&quot;,\n     &quot;camel2DashComponentName&quot;: false\n   },\n   &quot;antd&quot;\n],\n[\n   &quot;import&quot;,\n   {\n     &quot;libraryName&quot;: &quot;antd-mobile&quot;,\n     &quot;libraryDirectory&quot;: &quot;components&quot;,\n     &quot;camel2DashComponentName&quot;: false\n   },\n   &quot;antd-mobile&quot;\n],`, `10140600543027190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">[</span>\n   <span class="token string">"import"</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n     <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n     <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"components"</span><span class="token punctuation">,</span>\n     <span class="token string">"camel2DashComponentName"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token string">"antd"</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">[</span>\n   <span class="token string">"import"</span><span class="token punctuation">,</span>\n   <span class="token punctuation">{</span>\n     <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd-mobile"</span><span class="token punctuation">,</span>\n     <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"components"</span><span class="token punctuation">,</span>\n     <span class="token string">"camel2DashComponentName"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n   <span class="token punctuation">}</span><span class="token punctuation">,</span>\n   <span class="token string">"antd-mobile"</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>文件目录如下</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 323px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 169.3498452012384%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAiCAIAAADQyG7qAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC+ElEQVRIx5VV2W7TQBTNbwBq0tSJHdvjbbyNd3sSr4mzlbRViApVEUKIF9545Rf4Yq7TAuIB25Xu6/FZ5tzrgayT/f0nnYTxPF8UK5pW2PKGV7MrFo2nYvsMkGK5cR6XO5NEfpyrhseJOi8ZMDOkt88AqbYdpEm1t9wkTApeMsesxHAKDCtg+FDLDFhBhXn84iw3ETajtGyUJ2mVFmse4dFEaJM9mSlTXqFZlNc1Ui3bi8AzUkxBNhhO6vDMcDInqEhzl7cf3HAe0yJZlDOEL8Zcd2CTmczyimK41duTqjuAlzG5bFX7D5gTVYTJYn1oZLuRpFl9kH/B2Pa3p4+2F6fFyiDBC8AgW8KELvdINb1wDuG/hFlQwfPy5l7RCU1LCPn1aNrH9pm5AXvF/mg6YZKWxE8imkPgnfhnZpCdbm4V3QG85UZBkk55uRvMnAPTILB3j7YLgdXzbAm16bMbfwJz4Kk00zVsXzO9nq/17FnW3Xx3pxku0Ppx5sdpr5V8Ttv0y6e0s4p4yXA8ewGzqpnbqkZa0zBseuC5H5iTppJuC9rPdWg4ARyTRb5qyPsEBk8ymqD310JGsWqEbkhhJUFOL2bo05ARH65ZGsqmO08WhRvMR4wwYvhuMA+vBPEWd5oZeCHV7QAaVtU7CA+UQ09aBsCGZodZnXsxdcKU+HM3SoOk0EnEinr7DLAVaWb87Xt+e6q9uF7vj/nqsCj3q+3RcKigEDgy/5vmAPKSrpjB8nAPmv0ohZIEcSZrNsQBR6pl4J0lTtTOi3ED9QySjHgxbDU09LwYbdOUBE4sXIH67kExHCegry4mb0bTXmk/1VNUrajYADPQKphw/Y7Jb2bL3xwfwDNtzn3d83fVgOFoNGfocNIsD26IbvuXE/Hsqp9sGdvZ5qAaDkQFYDB8yfCdthuwgLCIo83pM6iF3wUEXiy35WoHKtqVD847IK0zFEcWUh1YSeCHzsL7sV2L2YAvGPHH19l1pQa0Xm328H8Ew8MrkN1h+xe7D2/fwFmjrAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 14 30 51"\n        title=""\n        src="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png"\n        srcset="/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-82faf.png 200w,\n/static/2019-10-29-14-30-51-7a34d3ab5fc0be9415083ee34a975851-d9a6c.png 323w"\n        sizes="(max-width: 323px) 100vw, 323px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id="桌面移动端分离打包"><a href="#%E6%A1%8C%E9%9D%A2%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>桌面移动端分离打包</h2>\n<p>考虑到桌面移动端的复用逻辑较多，所以将桌面移动端写在一个项目中，这里就涉及到了多平台分离打包</p>\n<h3 id="文件目录"><a href="#%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件目录</h3>\n<p>总体上来说分为 3 个文件夹，分别是公用组件、移动端组件、桌面端组件</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 355px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 147.88732394366195%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAIAAACjcKk8AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACmklEQVQ4y42UWW/bMBCE/S+KJqlt2bpFUhJ1UyKp247TxEkQJ216IEALBEXQvrY/v+s2zzaBfR1pZvZbTmyb0muW3ogsq3WbvNOs2dLRDE9lJiDwaFz0YxAzEmY+zZGfLC2sKMYuibuLO5rxvKx5Mxa8Nd1griJemMiwcSb6YXsfxkUpuneaeTY3pwtrrruHZ+KSlFDG2s1wtWNiaMcrmoqs7JKisVFyeCagDFMuV9erm0+yuxgv7trV9vL28fxyh2mJwuLATJYW2I7bET99ZwVfeX50MtWh8+nCPp4ZijVsPxfV9v46jMukEChIDJsotQ1i2wvSahSrWyhMNKNsV/u2dVdFjCwniluy/VbnrE+ZgKqVIbGwg6Jq6Pkg44xnZW04PuwPRokwCCnXdw6uRDOAZ8sLzzRTBdK9bc0Ixw3+8VO6hIl2zKsGkleyh+8eTr4vzHJ8Kpvxw4MfZLweMrb3j8P0qHPAEzsunsfvteY5ipJSDoB3KXtIftT5ZAGrchDqH6qvf9K0kN0aZCczQ3FVWDNREGQd7xImGW99mkGFRwO/iqcmDnSr1peU1SVvGe/aYeNgetw23PPbGVq31q8nh8S1bAe4aqhKcVVYt4OSFzUP/KikCaNJaThEFRLYSn/1SPPBJfTN6eJ0ZsBVwahkRguA5Bw/v3CARLZjxmomuqJqlCCBk4zqev1xF9Ac2AIZEB7EhRIkroe1ZLvsXuI4qWoAc4CXDGKrQIJcJ5jLijzcsFzIfg2/BbdKhf0jjBjVGN5+CYJEtCt4wDUF5avYsj3S7OTn30VRAZ7Qk+J78J8wBIR1ppnwDtRwFXW3dpAKYSDWUU69rfBIUhVVHWUVPGZQ2PE9A54nc7wZXMAzyoduPIeTVsTzL9kaOuxEzI+RAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 14 31 53"\n        title=""\n        src="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png"\n        srcset="/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-d1052.png 200w,\n/static/2019-10-29-14-31-53-f1c8ab42fab29060ac4b2dbdc4198d64-32723.png 355w"\n        sizes="(max-width: 355px) 100vw, 355px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3 id="优化环境变量配置"><a href="#%E4%BC%98%E5%8C%96%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化环境变量配置</h3>\n<p>将所有的环境变量整合到一个文件</p>\n<p>boot\\internals\\scripts\\get-build-map.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22381654892661240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\nconst prodEnv = process.env.PROD_ENV || \'pc\';\nconst globalJSON = require(path.resolve(process.cwd(), \'global.json\'));\n\nconst varsEnv = process.env.SERVER || \'master\';\nconst globalVars = globalJSON.runtime[varsEnv];\n\nconst RESOLVE_MODULES_MAP = {\n  pc: [\'src/common\', \'src/pc\', \'node_modules\'],\n  mobile: [\'src/common\', \'src/mobile\', \'node_modules\']\n};\n\nconst OUTPUT_PATH_MAP = {\n  pc: \'build/pc\',\n  mobile: \'build/mobile\'\n};\n\nconst resolveModules = RESOLVE_MODULES_MAP[prodEnv];\nconst outputPath = OUTPUT_PATH_MAP[prodEnv];\n\nconst INDEX_ENTRY_MAP = {\n  pc: \'src/pc/index.js\',\n  mobile: \'src/mobile/index.js\'\n};\n\nconst INDEX_HTML_MAP = {\n  pc: \'src/pc/index.html\',\n  mobile: \'src/mobile/index.html\'\n};\n\nconst indexEntry = INDEX_ENTRY_MAP[prodEnv];\nconst indexHtml = INDEX_HTML_MAP[prodEnv];\n\nmodule.exports = {\n  resolveModules,\n  outputPath,\n  indexEntry,\n  indexHtml,\n  globalVars\n};`, `22381654892661240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> prodEnv <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROD_ENV</span> <span class="token operator">||</span> <span class="token string">\'pc\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalJSON <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> varsEnv <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SERVER</span> <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> globalVars <span class="token operator">=</span> globalJSON<span class="token punctuation">.</span>runtime<span class="token punctuation">[</span>varsEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">RESOLVE_MODULES_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'src/common\'</span><span class="token punctuation">,</span> <span class="token string">\'src/pc\'</span><span class="token punctuation">,</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'src/common\'</span><span class="token punctuation">,</span> <span class="token string">\'src/mobile\'</span><span class="token punctuation">,</span> <span class="token string">\'node_modules\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">OUTPUT_PATH_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'build/pc\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'build/mobile\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> resolveModules <span class="token operator">=</span> <span class="token constant">RESOLVE_MODULES_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> outputPath <span class="token operator">=</span> <span class="token constant">OUTPUT_PATH_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">INDEX_ENTRY_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'src/pc/index.js\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'src/mobile/index.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">INDEX_HTML_MAP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  pc<span class="token punctuation">:</span> <span class="token string">\'src/pc/index.html\'</span><span class="token punctuation">,</span>\n  mobile<span class="token punctuation">:</span> <span class="token string">\'src/mobile/index.html\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> indexEntry <span class="token operator">=</span> <span class="token constant">INDEX_ENTRY_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> indexHtml <span class="token operator">=</span> <span class="token constant">INDEX_HTML_MAP</span><span class="token punctuation">[</span>prodEnv<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  resolveModules<span class="token punctuation">,</span>\n  outputPath<span class="token punctuation">,</span>\n  indexEntry<span class="token punctuation">,</span>\n  indexHtml<span class="token punctuation">,</span>\n  globalVars\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用环境变量进行分离打包"><a href="#%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用环境变量进行分离打包</h3>\n<p>boot\\internals\\webpack\\webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9852469093965976000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\noutput: Object.assign({ // Compile into js/build.js\n // 根据环境变量输出到不同平台\n path: path.resolve(process.cwd(), buildMap.outputPath),\n publicPath: \\`\\${buildMap.globalVars.customerServiceOrigin}/im/\\`,\n}, options.output), // Merge with env dependent settings\n\nresolve: {\n  // 根据环境变量决定相对路径的查找方式\n  modules: buildMap.resolveModules,\n},`, `9852469093965976000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\noutput<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// Compile into js/build.js</span>\n <span class="token comment">// 根据环境变量输出到不同平台</span>\n path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">,</span>\n publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMap<span class="token punctuation">.</span>globalVars<span class="token punctuation">.</span>customerServiceOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/im/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Merge with env dependent settings</span>\n\nresolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 根据环境变量决定相对路径的查找方式</span>\n  modules<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>resolveModules<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以下都是根据环境变量输出到不同平台的文件夹下</p>\n<p>boot\\internals\\webpack\\webpack.dev.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96919907214663390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\n// Add hot reloading in development\nentry: [\n  \'eventsource-polyfill\', // Necessary for hot reloading with IE\n  \'webpack-hot-middleware/client?reload=true\',\n  path.join(process.cwd(), buildMap.indexEntry), // Start with src/index.js\n],\n\nnew HtmlWebpackPlugin({\n   inject: true, // Inject all files that are generated by webpack, e.g. bundle.js\n   template: buildMap.indexHtml,\n}),`, `96919907214663390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Add hot reloading in development</span>\nentry<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n  <span class="token string">\'eventsource-polyfill\'</span><span class="token punctuation">,</span> <span class="token comment">// Necessary for hot reloading with IE</span>\n  <span class="token string">\'webpack-hot-middleware/client?reload=true\'</span><span class="token punctuation">,</span>\n  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Start with src/index.js</span>\n<span class="token punctuation">]</span><span class="token punctuation">,</span>\n\n<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n   inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Inject all files that are generated by webpack, e.g. bundle.js</span>\n   template<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>indexHtml<span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>boot\\internals\\webpack\\webpack.prod.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93807730645939590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const buildMap = require(\'../scripts/get-build-map\');\n\nentry: {\n   bundle: [\'runtime/polyfill\', path.join(process.cwd(), buildMap.indexEntry)],\n},\n\nnew HtmlWebpackPlugin({\n  template: buildMap.indexHtml,\n  minify: {\n    removeComments: true,\n    collapseWhitespace: true,\n    removeRedundantAttributes: true,\n    useShortDoctype: true,\n    removeEmptyAttributes: true,\n    removeStyleLinkTypeAttributes: true,\n    keepClosingSlash: true,\n    minifyJS: true,\n    minifyCSS: true,\n    minifyURLs: true,\n  },\n  inject: true,\n}),`, `93807730645939590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> buildMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'../scripts/get-build-map\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nentry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n   bundle<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'runtime/polyfill\'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>indexEntry<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  template<span class="token punctuation">:</span> buildMap<span class="token punctuation">.</span>indexHtml<span class="token punctuation">,</span>\n  minify<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeRedundantAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    useShortDoctype<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeEmptyAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    removeStyleLinkTypeAttributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    keepClosingSlash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyJS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    minifyURLs<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  inject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="优化打包脚本"><a href="#%E4%BC%98%E5%8C%96%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化打包脚本</h3>\n<h4 id="优化编译脚本"><a href="#%E4%BC%98%E5%8C%96%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化编译脚本</h4>\n<p>以下是其中一个脚本，主要是根据参数传递来进行打包</p>\n<p>boot/scripts/build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42831663842773240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst argv = require(\'yargs\').argv;\nconst \\$_SERVER = argv.server || \'master\';\nconst \\$_NODE_ENV = argv.env || \'production\';\nconst \\$_PROD_ENV = argv.prod || \'pc\';\n\nshelljs.exec(\n  \\`rimraf ./build/\\${\\$_PROD_ENV}/* && cross-env NODE_ENV=\\${\\$_NODE_ENV} SERVER=\\${\\$_SERVER} PROD_ENV=\\${\\$_PROD_ENV} webpack --config boot/internals/webpack/webpack.prod.babel.js --color --progress\\`,\n  { stdio: \'inherit\' }\n);`, `42831663842773240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_SERVER <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_NODE_ENV <span class="token operator">=</span> argv<span class="token punctuation">.</span>env <span class="token operator">||</span> <span class="token string">\'production\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_PROD_ENV <span class="token operator">=</span> argv<span class="token punctuation">.</span>prod <span class="token operator">||</span> <span class="token string">\'pc\'</span><span class="token punctuation">;</span>\n\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>\n  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rimraf ./build/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_PROD_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/* &amp;&amp; cross-env NODE_ENV=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_NODE_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> SERVER=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> PROD_ENV=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_PROD_ENV<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> webpack --config boot/internals/webpack/webpack.prod.babel.js --color --progress</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span> <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="多平台并行编译"><a href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%B9%B6%E8%A1%8C%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多平台并行编译</h4>\n<p>采用 concurrently 三方库进行多平台的编译，唯一的缺点就是进度会刷屏，暂时未找到解决方案</p>\n<p>global.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31448007308312187000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;APPS&quot;: {\n &quot;dev&quot;: [\n   &quot;pc&quot;, &quot;mobile&quot;\n ],\n}`, `31448007308312187000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">"APPS"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n   <span class="token string">"pc"</span><span class="token punctuation">,</span> <span class="token string">"mobile"</span>\n <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>boot\\scripts\\pre-build.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6432452202494354000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\nconst argv = require(\'yargs\').argv;\nconst path = require(\'path\');\nconst \\$_SERVER = argv.server || \'master\';\nconst APPS = require(path.resolve(process.cwd(), \'global.json\')).APPS[\\$_SERVER];\n\nconsole.log(\\`build environment: \\${\\$_SERVER}\\`, \\`build apps: \\${APPS}\\`);\n\nconst cmd = APPS.map((APP) => \\`&quot;node boot/scripts/build --server=\\${\\$_SERVER} --prod=\\${APP}&quot;\\`);\n\n// 进度输出刷屏，待优化\n// https://github.com/kimmobrunfeldt/concurrently/issues/188\n// https://github.com/kimmobrunfeldt/concurrently/issues/85\nshelljs.exec(\\`concurrently \\${cmd.join(\' \')}\\`, { stdio: \'inherit\' });`, `6432452202494354000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argv<span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> $_SERVER <span class="token operator">=</span> argv<span class="token punctuation">.</span>server <span class="token operator">||</span> <span class="token string">\'master\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token constant">APPS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'global.json\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">APPS</span><span class="token punctuation">[</span>$_SERVER<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">build environment: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">build apps: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APPS</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token constant">APPS</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">APP</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"node boot/scripts/build --server=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$_SERVER<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> --prod=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 进度输出刷屏，待优化</span>\n<span class="token comment">// https://github.com/kimmobrunfeldt/concurrently/issues/188</span>\n<span class="token comment">// https://github.com/kimmobrunfeldt/concurrently/issues/85</span>\nshelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">concurrently </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cmd<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里调用会并行编译 pc、mobile 两个平台的代码</p>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66766790698208060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;scripts&quot;: {\n &quot;build:dev&quot;: &quot;node boot/scripts/pre-build --server=dev&quot;,\n}`, `66766790698208060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                json 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n <span class="token property">"build:dev"</span><span class="token operator">:</span> <span class="token string">"node boot/scripts/pre-build --server=dev"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>编译速度：2 个平台同时编译的情况下第一次 30~40s，第二次 8~10s</p>\n<h2 id="分离打包的-nginx-配置"><a href="#%E5%88%86%E7%A6%BB%E6%89%93%E5%8C%85%E7%9A%84-nginx-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分离打包的 nginx 配置</h2>\n<h3 id="nginx-配置"><a href="#nginx-%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nginx 配置</h3>\n<p>由于之前第三方平台只用引入一个文件，这里的异步加载需要引入不止一个文件，所以要改下 nginx 配置，这里和主产品在一个域名下，故这里用前缀 /im/ 来代表加载客服组件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53834105356047426000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`set \\$root_dir &quot;/home/frontend/pony/pc/&quot;;\n# 根据 \\$http_user_agent 来判断加载哪个目录下的脚本\nif ( \\$http_user_agent ~ &quot;(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)&quot; )\n{\n   set \\$root_dir &quot;/home/frontend/pony/mobile/&quot;;\n}\n\n# 不缓存 bundle.js 入口文件，防止页面刷新后不是最新代码\nlocation = /im/bundle.js {\n   expires -1;\n   add_header Pragma no-cache;\n   alias &quot;\\${root_dir}/bundle.js&quot;;\n}\n\n# 其他文件照常做缓存处理，并映射到 /im 路径\nlocation ^~ /im {\n alias \\$root_dir;\n}`, `53834105356047426000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token variable">$root_dir</span> <span class="token string">"/home/frontend/pony/pc/"</span><span class="token punctuation">;</span>\n<span class="token comment"># 根据 $http_user_agent 来判断加载哪个目录下的脚本</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$http_user_agent</span> ~ <span class="token string">"(MIDP)|(WAP)|(UP.Browser)|(Smartphone)|(Obigo)|(Mobile)|(AU.Browser)|(wxd.Mms)|(WxdB.Browser)|(CLDC)|(UP.Link)|(KM.Browser)|(UCWEB)|(SEMC-Browser)|(Mini)|(Symbian)|(Palm)|(Nokia)|(Panasonic)|(MOT-)|(SonyEricsson)|(NEC-)|(Alcatel)|(Ericsson)|(BENQ)|(BenQ)|(Amoisonic)|(Amoi-)|(Capitel)|(PHILIPS)|(SAMSUNG)|(Lenovo)|(Mitsu)|(Motorola)|(SHARP)|(WAPPER)|(LG-)|(LG/)|(EG900)|(CECT)|(Compal)|(kejian)|(Bird)|(BIRD)|(G900/V1.0)|(Arima)|(CTL)|(TDG)|(Daxian)|(DAXIAN)|(DBTEL)|(Eastcom)|(EASTCOM)|(PANTECH)|(Dopod)|(Haier)|(HAIER)|(KONKA)|(KEJIAN)|(LENOVO)|(Soutec)|(SOUTEC)|(SAGEM)|(SEC-)|(SED-)|(EMOL-)|(INNO55)|(ZTE)|(iPhone)|(Android)|(Windows CE)|(Wget)|(Java)|(curl)|(Opera)"</span> <span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n   <span class="token builtin class-name">set</span> <span class="token variable">$root_dir</span> <span class="token string">"/home/frontend/pony/mobile/"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 不缓存 bundle.js 入口文件，防止页面刷新后不是最新代码</span>\nlocation <span class="token operator">=</span> /im/bundle.js <span class="token punctuation">{</span>\n   expires -1<span class="token punctuation">;</span>\n   add_header Pragma no-cache<span class="token punctuation">;</span>\n   <span class="token builtin class-name">alias</span> <span class="token string">"<span class="token variable">${root_dir}</span>/bundle.js"</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># 其他文件照常做缓存处理，并映射到 /im 路径</span>\nlocation ^~ /im <span class="token punctuation">{</span>\n <span class="token builtin class-name">alias</span> <span class="token variable">$root_dir</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="webpack-配合修改"><a href="#webpack-%E9%85%8D%E5%90%88%E4%BF%AE%E6%94%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 配合修改</h3>\n<p>webpack 也需要做下 public 的映射，否则资源访问不到，注意这里的 <code class="language-text">buildMap.globalVars.customerServiceOrigin</code> 代表主产品的域名</p>\n<p>webpack.base.babel.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33504612683136516000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`output: Object.assign({\n path: path.resolve(process.cwd(), buildMap.outputPath),\n publicPath: \\`\\${buildMap.globalVars.customerServiceOrigin}/im/\\`,\n}, options.output),`, `33504612683136516000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">output<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildMap<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">,</span>\n publicPath<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buildMap<span class="token punctuation">.</span>globalVars<span class="token punctuation">.</span>customerServiceOrigin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/im/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="代码分层"><a href="#%E4%BB%A3%E7%A0%81%E5%88%86%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代码分层</h2>\n<p>这里主要对 IM 层、消息提醒功能做了分层。其他的桌面与移动端复用率不高，没有分层</p>\n<h3 id="im-层"><a href="#im-%E5%B1%82" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IM 层</h3>\n<p>主要把所有与第三方提供商、调用后台的接口整合到一个类中，各种消息的回调采用消息订阅的方式进行分发调用</p>\n<h3 id="消息提醒类"><a href="#%E6%B6%88%E6%81%AF%E6%8F%90%E9%86%92%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息提醒类</h3>\n<p>将公共的消息提醒逻辑抽成一个类</p>\n<p>src\\common\\utils\\TitleMessage\\index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27053069785672460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import utils from \'utils\';\nimport { filePrefix } from \'containers/App/constants\';\n\nimport tungeeLogo from \'./images/tungee-logo.jpg\';\n\nclass TitleMessage {\n  constructor() {\n    // 闪烁前标题\n    this.originTitle = document.title;\n    // 计数\n    this.count = 0;\n    // 计时器\n    this.timer = null;\n    // 提示音\n    this.alertPlayer = document.createElement(\'audio\');\n    this.alertPlayer.src = \\`\\${filePrefix}message_alert.wav\\`;\n    this.alertPlayer.style.display = \'none\';\n    document.body.appendChild(this.alertPlayer);\n  }\n\n  start(msg) {\n    // 提示音\n    this.alertPlayer.play();\n    // 网页提示\n    utils.showNotification(msg, {\n      icon: tungeeLogo\n    });\n    this.stop();\n    this.timer = setInterval(() => {\n      if (this.count % 2 === 0) {\n        document.title = msg;\n      } else {\n        document.title = this.originTitle;\n      }\n      this.count += 1;\n    }, 1000);\n  }\n\n  stop() {\n    if (this.timer) {\n      clearInterval(this.timer);\n      this.timer = null;\n      this.count = 0;\n    }\n    document.title = this.originTitle;\n  }\n}\n\nexport default TitleMessage;`, `27053069785672460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">\'utils\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> filePrefix <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'containers/App/constants\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> tungeeLogo <span class="token keyword">from</span> <span class="token string">\'./images/tungee-logo.jpg\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">TitleMessage</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 闪烁前标题</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle <span class="token operator">=</span> document<span class="token punctuation">.</span>title<span class="token punctuation">;</span>\n    <span class="token comment">// 计数</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token comment">// 计时器</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token comment">// 提示音</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">\'audio\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">message_alert.wav</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 提示音</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>alertPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 网页提示</span>\n    utils<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      icon<span class="token punctuation">:</span> tungeeLogo\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        document<span class="token punctuation">.</span>title <span class="token operator">=</span> msg<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>originTitle<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> TitleMessage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="小程序部署代理配置"><a href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小程序部署代理配置</h2>\n<p>小程序用到 webview 限制了接口调用必须是第三方的域名，需要更改第三方域名指向的服务器配置</p>\n<p>这里以 nginx 为例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37602121280548690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location ^~ /im {\n  # 反代到组件所在的域名，并把参数传递过去\n  proxy_pass 组件所在的域名/im/\\$1;\n  # 传递 http_user_agent 参数，否则不能判断移动端\n  proxy_set_header User-Agent \\$http_user_agent;\n}`, `37602121280548690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">location ^~ /im <span class="token punctuation">{</span>\n  <span class="token comment"># 反代到组件所在的域名，并把参数传递过去</span>\n  proxy_pass 组件所在的域名/im/<span class="token variable">$1</span><span class="token punctuation">;</span>\n  <span class="token comment"># 传递 http_user_agent 参数，否则不能判断移动端</span>\n  proxy_set_header User-Agent <span class="token variable">$http_user_agent</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="优化效果"><a href="#%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化效果</h1>\n<h2 id="优化前"><a href="#%E4%BC%98%E5%8C%96%E5%89%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化前</h2>\n<p>优化前包大小如下图，首页/全部加载大小都为 644.58kb。</p>\n<p>加载速度（不限速）540ms，3g low（限速 120 kb/s）40.75s。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-72d75.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 48.645833333333336%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB8klEQVQoz02Q23OaYBDF/cf7kIe+Ne1Dm5e00bHqNE2LRo03vGuEIkQLKqLggILcRKMoiCi2X9KpyZkzszs785vdPb6l3HGthbMxds725IO78/bu42I+HDDdDiVPJcu2wNyx7b3rAIPeNE2fvV54B3d/8GaarIi8IgnieNTCUapNPDRRpF7huf6YZ/nRUBaFAd1u1PL3VXjYbxvGzPfnWUfPMwxFngq9bpumycmEk6djXVc1TVktF7IE2C5Dt+rlZDwajEPBRjWla8p/+Hh03d1z9TzvACZb27KstWVtTHOlqxLLkARWzqevs8kIcCHzXTvBQK7r4jhOEATHcYIgOFvLmOnmajmgWy2iht7DpRyUgIKxH1exmy/peFiTxRfYcZweTVMURZIkwzC2vZnPZ8ZMxdHiA1bB0VIlH7u7/ZqAAnHIn05ENGny+mznX+8dns7WVKnzG+v3WuyAAjxSTRdzPzOJyF0smIQCcOqb9vrn1SPIT9HVqSqLI7YLyBHbHzIUhuSbSIH4VcYacDjw4fLibejqPOx/Pz1tBri9tddrkJClKRJSzxbhqMCzDN0uZG4atQxazzbRAoaWMvFQAvJ/PH8j8KOXzTvnSSBzcczVyoly4bZLYul4CE5dl+AogFvNKlLPhf3vLj+dfb44k8TxX9Ge/9+DNMidAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 10 25 53"\n        title=""\n        src="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-fee1c.png"\n        srcset="/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-a67b7.png 200w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-0b187.png 400w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-fee1c.png 800w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-b1a91.png 1200w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-95179.png 1600w,\n/static/2019-10-29-10-25-53-6a845b8ebf16d6aad140f7727e0aae63-72d75.png 1920w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-ad506.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 38.81278538812785%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/klEQVQY06WQy07FMAxE8///w5JfYIMQlwVXLPoiTdqmsfPsg2nCAiR2HFXuWPFIHouUs1FKdt04jm3bNk1zf/+4Pz13r7e+76WUwzDgSSk1z/P6G3GeJ1kL0yilKszTNGk1afwmGKbCZ8EYY61d7Tfi8UG9vawxO2LywccUz784jmPfd9TSnFWIURoL1xZjDBQ9xUwhccwxpW3bcs61gpRSTpmDp+DROOeE80S8Yh9XYOed9/OyMDNSQWPnZVmgsScRLcasREjjmAUxIzOe4Qze1w9zaGvFFbTWiI5pjMFvClhVnP/gMiMV8lyhQ/gpqr5uGGIYdWKHqDV9vcIXe7DLvuDDBk0AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 25 47"\n        title=""\n        src="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-fee1c.png"\n        srcset="/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-a67b7.png 200w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-0b187.png 400w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-fee1c.png 800w,\n/static/2019-10-29-15-25-47-f472aa775bcf205ed5b5fc6dd00c7d54-ad506.png 1095w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-74b93.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 31.74366616989568%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA5ElEQVQY01WQ627DIAyF8/5vN2lTtU7aqi3N6CWEAL4CzYyWPzUf1sFY5ohh27ZHa/PF3a/Xafodx/Hz8H4+fjjnLracu91ufvbrc8R19X4Zph8ZT3y/eu9nK1qk2O9M5JyJ6L+biZhpz50uh8NreHtZQiJgBNpJiBkhI4oqixALSxesalpFqm2mQRRYcohpBYpICXlJOXRgiem+BDt2Ymc2T4DfczwHcCENRIJoz2VhLqqGCRsr3RhZc4ZsJhEAESyr6inIMehX4KG21qlNS3miVrOoGQugTdzbWiulPh61f3Ipf9oPVumHRIeSAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 14 46 52"\n        title=""\n        src="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-fee1c.png"\n        srcset="/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-a67b7.png 200w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-0b187.png 400w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-fee1c.png 800w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-b1a91.png 1200w,\n/static/2019-10-29-14-46-52-f0b72fa0b4486e6fd49cc465c8f6a28e-74b93.png 1342w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id="优化后"><a href="#%E4%BC%98%E5%8C%96%E5%90%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化后</h2>\n<h3 id="桌面端"><a href="#%E6%A1%8C%E9%9D%A2%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>桌面端</h3>\n<p>优化后，首页加载 107.08kb，全部加载 356.46kb。</p>\n<p>加载速度（不限速） 246ms，3g low （限速 120 kb/s）7s。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a0f42.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 48.42271293375394%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNklEQVQoz2WP209SARzH+Tt6rZ7aury4HnqqLVdrqd1zri22VsEEq9mgFplT09IWyzZZcXB0IkWkYgQEHRBIhHO4g1yEIFoIR87hcD+icE7EQ7X87rfvvi+f/b5fBkEUarkQ1dyiaJqiG2Tux5pC6ZVKvdI3fhCExQACSFoZAQAPCCJiYBV4LX6R5PDL/KE8I08UyWqhSVGNJt2kabJYTMwvJOfk3+WKCPjWB8y280JqURl4JnQ9nli5x5vguZkD9SvXiwwURTGcqNXIarVGbtbJQmEdMqUNUMvjak1So1uHjD/1hhgo+3rnrm2Q94XVLxMujzzf7OzGGKVSCcMwvK08QZRyORRGMnZHBoYzDjjrQFCnK21acgkeGW+w9NdYEJs1dAs+cqp8+NgGg/4jqrWa3q5UQwaDV6MJ6HR+rTao+xzU60Mqlevh8Lvus+CFyyYO+wEX7jhe2nsw/D+8VangTg+OuHHEk3e2z+VFTVaEL5g70fXxXJ/6Yi+fZTvaU95zwP8XpujfcLVessbfW+NKa0Jpjiug8BwUnLfGFiHPrNYuklueqJCpvpvuXbtD+zq+7YAbZUd+ybihhgkznLU6UDOYnBYlxsSpKWFCMBzhDPjOcF8ae65iJy/B/9Ruw2SjGi36LLlPvpx9Ne0N4R5ZanomOiKJTo55uPddzK6ZQ/1OS2+qEUCcOz5vl6HsB0nyqSmtdqM2N7b8KjY+7r0tWhudjAwyTZ2nxfvZ4ZXzeCPstP8CuQTKZbxKTaYAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 14 38 30"\n        title=""\n        src="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-fee1c.png"\n        srcset="/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a67b7.png 200w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-0b187.png 400w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-fee1c.png 800w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-b1a91.png 1200w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-95179.png 1600w,\n/static/2019-10-29-14-38-30-30860e3323a82eec8c3fb1373db02860-a0f42.png 1902w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-e4a38.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 34.08736349453978%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABAklEQVQY021QW27DIBD0sXuZnqVH6Gf7k0iJmsh2eJhdXgu4dHDUr3aEBhjNLrNMvXcy5jHPy7Lcbl+Xy/X28Tmfz7iu6wpWSllr3X+YUMzk4NoOMBE5B2ZmzwPmQAzxD8LkS2epSWIuOZfS9r1974OPNdD22mquRcANjgodvtb26eWtv75L75FSzlnQ0EWmECgkjnlIIi762SnF2+KN9s75yCGllKc19uuyOauRKxywxo64hK8w9/tda83EG0Qi9VApJqbtpLUhP2YOnvArGBg+FGBqvIfGUKC31qQW6OgLQ61VikQpmnkUIxj/wnv/ZGxOWfPYSNlkzDP/EzhXEUT4AQlZjkeKWe+qAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 36 51"\n        title=""\n        src="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-fee1c.png"\n        srcset="/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-a67b7.png 200w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-0b187.png 400w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-fee1c.png 800w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-b1a91.png 1200w,\n/static/2019-10-29-15-36-51-470dbf55ea22b0aa05e2a1eb0be47793-e4a38.png 1282w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-166cd.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 37.20728534258456%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABGElEQVQY001Q7W7DIAzMo+4h97PPME390WnqtC6pugSS8GliTAKZqVStJ2TdYRt8bvZ910KMfT8MQ9d117b9fDv+vB9/21ZI2fe9lHKeZ2OMfYJzVk664WajtRjEf5rJnXvv+ZIfVUqFBwDgQUJtRiIIkLdtLyXnXEphwqyKe9y2LT+BFR+uaF5ey+GylZwcJo8EkWMcHPiYQkwsA61QSU05pIVSXlMkSuvWHC776WaCd0uMGKMHUFob5xyAHMdpmrVhW+zCKaXBgzDuS9pMuOJSx7Z6kqJ6Zm/TNHJFdQbQXa/WWUo0K8UrGAZBcbFIH6P/Nnjz1OSyIyL4Cv6PI8t4n8Jqg2EhjME5XBZeEqU6MyGeTTzb9Q9bC42MbmEgJwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 38 36"\n        title=""\n        src="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-fee1c.png"\n        srcset="/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-a67b7.png 200w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-0b187.png 400w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-fee1c.png 800w,\n/static/2019-10-29-15-38-36-d514d000336f0a9536b665993ca2fc56-166cd.png 1153w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3 id="移动端"><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>移动端</h3>\n<p>优化后，首页加载 105.89kb，全部加载 306.3kb。</p>\n<p>加载速度（不限速）236ms，3g low（限速 120 kb/s）6.98s。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-c3264.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 48.454688318491364%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACLElEQVQoz2WR3U9SARjG+Wf6A7pok3lTa627WtLUlWuGAw1lwNxcGFg6kSA+jthFBRMRQUSPWcSHIIgnioOCgMCBwznEOJRaCK44TtnoEGZX9Ox99179nj3PXtrJjyRVP6OoBkX9rp9WimlbBn6NhfVoSJeGtUhQm4bfYGGD2ZBXKUrPJYhoFJZJMUD53Wk/pp2dklSToxoXU0wtoZ9keEi955fFfFIcVmNBJR6aNuqz0klifCytkKOAEn8mJub1JVqpdESSJ9VqlSTJWq1WiOvRLVHcOwatDu84hGhgAtl8ErGxP3qx+bmjkWF8bfXQbitxH2GSCZxWLpePz1VpbtMiH9UhvpGY+3HgrSADiRC/KGwbCIK9oAV9KjroZiBiYYE/mGM+yJgXDmiNf6IuDr6tiTrY8XVezMVNePhBsGdz4a7PeHvRkFApCNlUjsNG73Ume3vSs9r9Vji3Mx13shJu7t76YNLDC1gYq0CbFbgOLsVNpqJl8SunP9vZkexipGaAb61wAlJ4TfehZRZk7QuA/T7jHRCga8RXzdrUS3lFMrrf14kybkTplz9PjqOtcBZWb79j7to5kQ8DUccQtNgBqq9IBG3L8PZckHixlhW8irI0+akZzL2O/Rc7pIrZmX9jD513Xum2qtp1U9fkua2Hh7s3CxtdqEf5qxFKJ+p5pBUmkpYM1HzPaMzFj7l44fdMp+6WfbZbmvXTI/ZLG4b2Fa2w2vChX34SxB86lbnYVroPKgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 40 29"\n        title=""\n        src="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-fee1c.png"\n        srcset="/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-a67b7.png 200w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-0b187.png 400w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-fee1c.png 800w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-b1a91.png 1200w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-95179.png 1600w,\n/static/2019-10-29-15-40-29-942e8458374be71d879f36230cb28203-c3264.png 1909w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-7169a.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 34.113712374581944%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABC0lEQVQY01VQ2Y7EIAzr/3/haHdfVppuL0oIRzgCdEJH87AWVFWMLTtTSimGcMzzsW3rtj2fz795nh+P9ftn33el1LIs67oCAP6HMThd19Va0wDGmHyjyGXOXMRX/ikEa22MkYtgsOWDt7gWFkHpvTNz7Y2rzFpvLQvTKtcxLJW5DWqwrddahzjmit65SGJKKVoKGCKllFOa4VhQaQsnIZJHT44SuDDYnCexM6GMVlo756SMPrVFlKjSReobDRatOg7QcCqVYlRofkGTD5NE55INnPd7K81FL7ZEJF7nqboE5mwsvq0LsxwJ+GWW6V5C8V5yD4j+8x0TtB58hgO80tE7WaH4jkWmjMG/AM88kKE+GpBtAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 43 18"\n        title=""\n        src="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-fee1c.png"\n        srcset="/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-a67b7.png 200w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-0b187.png 400w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-fee1c.png 800w,\n/static/2019-10-29-15-43-18-0fea674c90a00b2c83571ddec1d4628a-7169a.png 1196w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-29961.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 36.02329450915141%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABAklEQVQY002Q227DIAxA8//ftodJ0x47bavWZCVAYoJvQDqTVlOPLLCNrwybkcCN0+zcNE3f5/Pn6ePr7f3ndBqnzjiO3vsQwvoEwOp8HG63277vS4wWAQCpAwlgOzSrPBtuNgUx3/lXHslailaj1faQUhuLsgixZEJWOZy1y/Haau3JWttGlIgTyUYCyIB3s0tmjRljttYMmVImZdpVRHjYW12wTL/XdYmIfaIYQ58fwBYZL5cYgnkM72eLWVJ6uayvjpYNB6tQVIO3vWaLcs5uT9YQ0b7p6pwNaB8QjwLWXlRXUo/yHmhQVbNZuM/xhPntpBUYkp1KpAfWqZVSiwLpHxBlj9DumN8wAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 10 29 15 44 43"\n        title=""\n        src="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-fee1c.png"\n        srcset="/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-a67b7.png 200w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-0b187.png 400w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-fee1c.png 800w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-b1a91.png 1200w,\n/static/2019-10-29-15-44-43-e8afddb91b0c6ec715c218f0a1a94657-29961.png 1202w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1 id="优化总结"><a href="#%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优化总结</h1>\n<p>待优化的点：组件化复用做的不够好、以原生方式写客服组件体积会更小等等</p>',
id:"/github/workspace/blog/构建多平台轻量化组件的实践/index.md absPath of file >>> MarkdownRemark",timeToRead:12,frontmatter:{date:"2019-10-29 09:51:53",path:"/building-platform-lightweight-components/",tags:"前端, 组件轻量化, webpack, 预研",title:"构建多平台轻量化组件的实践",draft:null}},{excerpt:"接上文 Webpack 升级优化——记一次产品端升级 最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点 babel 编译兼容 IE 在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错 脚本运行颜色 在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上 参数 webpack 加速构建 在 webpack.base.babel.js 文件中添加 hard…",html:'<p>接上文<a href="/webpack-upgrade-about-product/">Webpack 升级优化——记一次产品端升级</a></p>\n<p>最近需要开发一个新产品，此时需要一个新框架来承载新产品的开发，根据前端主管的建议，建议我在他已经开发出的新框架上进行改造，这里记录一下改造的关键点</p>\n<h1 id="babel-编译兼容-ie"><a href="#babel-%E7%BC%96%E8%AF%91%E5%85%BC%E5%AE%B9-ie" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>babel 编译兼容 IE</h1>\n<p>在 .babelrc 文件里加上标红代码，防止 ie 某些方法报错</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29079999636074815000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  &quot;env&quot;: {\n    &quot;production&quot;: {\n      &quot;only&quot;: [\n        &quot;src&quot;,\n        &quot;unicorn&quot;\n      ],\n      &quot;plugins&quot;: [\n        &quot;transform-react-remove-prop-types&quot;,\n        &quot;transform-react-constant-elements&quot;,\n        &quot;transform-react-inline-elements&quot;\n      ]\n    },\n  },\n  &quot;plugins&quot;: [\n    [\n      &quot;import&quot;,\n      {\n        &quot;libraryName&quot;: &quot;antd&quot;,\n        &quot;libraryDirectory&quot;: &quot;es&quot;,\n        &quot;style&quot;: true\n      }\n    ],\n    &quot;transform-decorators-legacy&quot;,\n    &quot;lodash&quot;\n  ],\n  &quot;presets&quot;: [\n    [\n      &quot;latest&quot;,\n      {\n        &quot;es2015&quot;: {\n          &quot;modules&quot;: false\n        }\n      }\n    ],\n    &quot;es2015-ie&quot;,\n    &quot;react&quot;,\n    &quot;stage-0&quot;\n  ]\n}`, `29079999636074815000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{36} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token string">"production"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token string">"only"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"src"</span><span class="token punctuation">,</span>\n        <span class="token string">"unicorn"</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n        <span class="token string">"transform-react-remove-prop-types"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-constant-elements"</span><span class="token punctuation">,</span>\n        <span class="token string">"transform-react-inline-elements"</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"import"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"libraryName"</span><span class="token punctuation">:</span> <span class="token string">"antd"</span><span class="token punctuation">,</span>\n        <span class="token string">"libraryDirectory"</span><span class="token punctuation">:</span> <span class="token string">"es"</span><span class="token punctuation">,</span>\n        <span class="token string">"style"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token string">"transform-decorators-legacy"</span><span class="token punctuation">,</span>\n    <span class="token string">"lodash"</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span>\n      <span class="token string">"latest"</span><span class="token punctuation">,</span>\n      <span class="token punctuation">{</span>\n        <span class="token string">"es2015"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          <span class="token string">"modules"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span><span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">    <span class="token string">"es2015-ie"</span><span class="token punctuation">,</span></span>    <span class="token string">"react"</span><span class="token punctuation">,</span>\n    <span class="token string">"stage-0"</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="脚本运行颜色"><a href="#%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C%E9%A2%9C%E8%89%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本运行颜色</h1>\n<p>在将 npm script 写成 nodejs 脚本时，脚本颜色是灰色，此时需要加上<code class="language-text">--color</code>参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17273164100883954000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shelljs = require(\'shelljs\');\n\nshelljs.exec(\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\', {\n  stdio: \'inherit\'\n});`, `17273164100883954000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{3} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shelljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'shelljs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">shelljs<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">\'cross-env NODE_ENV=development node boot/internals/scripts/analyze.js --color\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>  stdio<span class="token punctuation">:</span> <span class="token string">\'inherit\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-加速构建"><a href="#webpack-%E5%8A%A0%E9%80%9F%E6%9E%84%E5%BB%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 加速构建</h1>\n<p>在 webpack.base.babel.js 文件中添加 hard-source-webpack-plugin 插件，启用了之后构建速度由第二次的 30~40s 缩短到第二次的 3~5s 左右</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65761752013821240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new HardSourceWebpackPlugin({\n  // Either an absolute path or relative to webpack\'s options.context.\n  cacheDirectory: path.resolve(process.cwd(), \'node_modules/.cache/hard-source/[confighash]\'),\n  // Either a string of object hash function given a webpack config.\n  configHash(webpackConfig) {\n    // node-object-hash on npm can be used to build this.\n    return require(\'node-object-hash\')({ sort: false }).hash({\n      webpackConfig,\n      globalVars,\n    });\n  },\n  // Either false, a string, an object, or a project hashing function.\n  environmentHash: {\n    root: process.cwd(),\n    directories: [],\n    files: [\'package-lock.json\', \'yarn.lock\'],\n  },\n  // An object.\n  info: {\n    // \'none\' or \'test\'.\n    mode: \'none\',\n    // \'debug\', \'log\', \'info\', \'warn\', or \'error\'.\n    level: \'debug\',\n  },\n  // Clean up large, old caches automatically.\n  cachePrune: {\n    // Caches younger than \\`maxAge\\` are not considered for deletion. They must\n    // be at least this (default: 2 days) old in milliseconds.\n    maxAge: 2 * 24 * 60 * 60 * 1000,\n    // All caches together must be larger than \\`sizeThreshold\\` before any\n    // caches will be deleted. Together they must be at least this\n    // (default: 50 MB) big in bytes.\n    sizeThreshold: 50 * 1024 * 1024,\n  },\n}),\n\n// 这里会对 svg 生成造成影响，暂时关闭\n// You can optionally exclude items that may not be working with HardSource\n// or items with custom loaders while you are actively developing the\n// loader.\n// new HardSourceWebpackPlugin.ExcludeModulePlugin([\n//   {\n//     // HardSource works with mini-css-extract-plugin but due to how\n//     // mini-css emits assets, assets are not emitted on repeated builds with\n//     // mini-css and hard-source together. Ignoring the mini-css loader\n//     // modules, but not the other css loader modules, excludes the modules\n//     // that mini-css needs rebuilt to output assets every time.\n//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,\n//   },\n// ]),`, `65761752013821240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  <span class="token comment">// Either an absolute path or relative to webpack\'s options.context.</span>\n  cacheDirectory<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/.cache/hard-source/[confighash]\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either a string of object hash function given a webpack config.</span>\n  <span class="token function">configHash</span><span class="token punctuation">(</span><span class="token parameter">webpackConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// node-object-hash on npm can be used to build this.</span>\n    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'node-object-hash\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      webpackConfig<span class="token punctuation">,</span>\n      globalVars<span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Either false, a string, an object, or a project hashing function.</span>\n  environmentHash<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    directories<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'package-lock.json\'</span><span class="token punctuation">,</span> <span class="token string">\'yarn.lock\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// An object.</span>\n  info<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// \'none\' or \'test\'.</span>\n    mode<span class="token punctuation">:</span> <span class="token string">\'none\'</span><span class="token punctuation">,</span>\n    <span class="token comment">// \'debug\', \'log\', \'info\', \'warn\', or \'error\'.</span>\n    level<span class="token punctuation">:</span> <span class="token string">\'debug\'</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// Clean up large, old caches automatically.</span>\n  cachePrune<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Caches younger than `maxAge` are not considered for deletion. They must</span>\n    <span class="token comment">// be at least this (default: 2 days) old in milliseconds.</span>\n    maxAge<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>\n    <span class="token comment">// All caches together must be larger than `sizeThreshold` before any</span>\n    <span class="token comment">// caches will be deleted. Together they must be at least this</span>\n    <span class="token comment">// (default: 50 MB) big in bytes.</span>\n    sizeThreshold<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n\n<span class="token comment">// 这里会对 svg 生成造成影响，暂时关闭</span>\n<span class="token comment">// You can optionally exclude items that may not be working with HardSource</span>\n<span class="token comment">// or items with custom loaders while you are actively developing the</span>\n<span class="token comment">// loader.</span>\n<span class="token comment">// new HardSourceWebpackPlugin.ExcludeModulePlugin([</span>\n<span class="token comment">//   {</span>\n<span class="token comment">//     // HardSource works with mini-css-extract-plugin but due to how</span>\n<span class="token comment">//     // mini-css emits assets, assets are not emitted on repeated builds with</span>\n<span class="token comment">//     // mini-css and hard-source together. Ignoring the mini-css loader</span>\n<span class="token comment">//     // modules, but not the other css loader modules, excludes the modules</span>\n<span class="token comment">//     // that mini-css needs rebuilt to output assets every time.</span>\n<span class="token comment">//     test: /mini-css-extract-plugin[\\\\/]dist[\\\\/]loader/,</span>\n<span class="token comment">//   },</span>\n<span class="token comment">// ]),</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="webpack-进度显示异常"><a href="#webpack-%E8%BF%9B%E5%BA%A6%E6%98%BE%E7%A4%BA%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>webpack 进度显示异常</h1>\n<p>在 npm run build 执行时 simple-progress-webpack-plugin 插件会不停的刷屏显示，造成不好的体验，所以暂时只把它写在 webpack.dev.babel.js 中</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84005309417610950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`new SimpleProgressWebpackPlugin({\n  format: \'minimal\',\n}),`, `84005309417610950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">SimpleProgressWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  format<span class="token punctuation">:</span> <span class="token string">\'minimal\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h1 id="lodash-插件优化异常"><a href="#lodash-%E6%8F%92%E4%BB%B6%E4%BC%98%E5%8C%96%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>lodash 插件优化异常</h1>\n<p>在开启 lodash-webpack-plugin 插件后，lodash.get 不能正常执行，加入 <code class="language-text">paths: true</code> 即可</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65343242352710760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Deep property path support for methods like _.get, _.has, & _.set.\n// lodash优化由592.53k到240k\nnew LodashModuleReplacementPlugin({\n  paths: true,\n}),`, `65343242352710760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Deep property path support for methods like _.get, _.has, &amp; _.set.</span>\n<span class="token comment">// lodash优化由592.53k到240k</span>\n<span class="token keyword">new</span> <span class="token class-name">LodashModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  paths<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上更新于<code class="language-text">2019-9-17 20:43:04</code></p>\n<hr>\n<h1 id="react-loadable-优化"><a href="#react-loadable-%E4%BC%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-loadable 优化</h1>\n<h2 id="withref-方法报错"><a href="#withref-%E6%96%B9%E6%B3%95%E6%8A%A5%E9%94%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>withRef 方法报错</h2>\n<p>当 react-loadable 应用到组件为 function 类型，此时 withRef 方法会报错，因为 function 组件是没有 ref 的，此时要做下兼容处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10489926053071485000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        const { isPureReactComponent, isReactComponent } = Component.prototype;\n        let refProps = null;\n        if (isPureReactComponent || isReactComponent) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `10489926053071485000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{22-28,30} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> isPureReactComponent<span class="token punctuation">,</span> isReactComponent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>isPureReactComponent <span class="token operator">||</span> isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          refProps <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>            <span class="token punctuation">}</span>\n<span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span><span class="token punctuation">;</span></span>        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="阻止-setstate"><a href="#%E9%98%BB%E6%AD%A2-setstate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>阻止 setState</h2>\n<p>因为组件卸载时继续网络请求会导致 setState 报错，因为采用的是 promise 方法，不能取消请求，所以需要在卸载时将 setState 置空，以下分别针对页面、组件级别将其置空</p>\n<h3 id="页面级别"><a href="#%E9%A1%B5%E9%9D%A2%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>页面级别</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43730807274945850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/* eslint-disable no-param-reassign */\nimport React from \'react\';\nimport Loadable from \'react-loadable\';\n\nconst LoaderCache = new Map();\nexport default function loadComponent(loader, options) {\n  let component = LoaderCache.get(loader);\n  if (!component) {\n    component = Loadable({\n      loader,\n      loading: (props) => {\n        if (props.error) {\n          // eslint-disable-line\n          if (window.location.host.indexOf(\'-dev\') >= 0 && window.TURKEY && window.TURKEY.getProperty(\'serverUpdate\')) {\n            window.TURKEY.run(\'serverUpdate\');\n          }\n          console.error(\'[chunk loader]\', props.error); // eslint-disable-line\n        }\n        return <div />;\n      },\n      render: (loaded, props) => {\n        const Component = loaded.default;\n        const { withRef, ...rest } = props; // eslint-disable-line\n        let refProps = null;\n        // 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空\n        if (Component.prototype && (Component.prototype.isPureReactComponent || Component.prototype.isReactComponent)) {\n          refProps = {\n            ref: (r) => {\n              withRef && withRef(r);\n              if (!r) {\n                return;\n              }\n              const cb = r.componentWillUnmount;\n              r.componentWillUnmount = () => {\n                r.setState = () => {\n                  // eslint-disable-next-line no-useless-return\n                  return;\n                };\n                cb && cb.call(r);\n              };\n            }\n          };\n        }\n        return <Component {...refProps} {...rest} />;\n      },\n      ...options\n    });\n    LoaderCache.set(loader, component);\n    // component.preload();\n  }\n  return component;\n}`, `43730807274945850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{29-39} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/* eslint-disable no-param-reassign */</span>\n<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">\'react-loadable\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> LoaderCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> component <span class="token operator">=</span> LoaderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    component <span class="token operator">=</span> <span class="token function">Loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      loader<span class="token punctuation">,</span>\n      <span class="token function-variable function">loading</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// eslint-disable-line</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'-dev\'</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            window<span class="token punctuation">.</span><span class="token constant">TURKEY</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">\'serverUpdate\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'[chunk loader]\'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loaded<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> Component <span class="token operator">=</span> loaded<span class="token punctuation">.</span>default<span class="token punctuation">;</span>\n        <span class="token keyword">const</span> <span class="token punctuation">{</span> withRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>\n        <span class="token keyword">let</span> refProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token comment">// 只有 PureReactComponent 和 ReactComponent 才有生命周期，注意在 react-hook 的情况下 Component.prototype 为空</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isPureReactComponent <span class="token operator">||</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          refProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n            <span class="token function-variable function">ref</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">              withRef <span class="token operator">&amp;&amp;</span> <span class="token function">withRef</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">              <span class="token keyword">const</span> cb <span class="token operator">=</span> r<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">              r<span class="token punctuation">.</span><span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                r<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">                  <span class="token comment">// eslint-disable-next-line no-useless-return</span></span><span class="gatsby-highlight-code-line">                  <span class="token keyword">return</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">                cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>              <span class="token punctuation">}</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>refProps<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token operator">...</span>options\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    LoaderCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// component.preload();</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> component<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="组件级别"><a href="#%E7%BB%84%E4%BB%B6%E7%BA%A7%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件级别</h3>\n<p>src\\runtime\\preventSetState.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70243962113403940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\n\nexport default function preventSetState(WrappedComponent) {\n  return class Hoc extends React.PureComponent {\n    componentWillUnmount = () => {\n      this.wrappedComponent.setState = () => {\n        // eslint-disable-next-line no-useless-return\n        return;\n      };\n    };\n\n    render() {\n      return (\n        <WrappedComponent\n          ref={(r) => {\n            this.wrappedComponent = r;\n          }}\n          {...this.props}\n        />\n      );\n    }\n  };\n}`, `70243962113403940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Hoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">componentWillUnmount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// eslint-disable-next-line no-useless-return</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token operator">&lt;</span>WrappedComponent\n          ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedComponent <span class="token operator">=</span> r<span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">}</span>\n          <span class="token punctuation">{</span><span class="token operator">...</span>this<span class="token punctuation">.</span>props<span class="token punctuation">}</span>\n        <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用时</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20635103312944960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\n@preventSetState\nexport default class Component extends React.PureComponent {}`, `20635103312944960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n@preventSetState\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90161760212891570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import preventSetState from \'runtime/preventSetState\';\n\nclass Component extends React.PureComponent {}\n\nexport default preventSetState(Component);`, `90161760212891570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> preventSetState <span class="token keyword">from</span> <span class="token string">\'runtime/preventSetState\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">preventSetState</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>待拓展的功能：react-hook 替换 mobx、HTML 内实现 Loading 态或者骨架屏、动态 polyfill、编译到 ES2015+（提高运行效率）、LazyLoad、三方库 external 化</p>\n<h1 id="重置报错状态"><a href="#%E9%87%8D%E7%BD%AE%E6%8A%A5%E9%94%99%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>重置报错状态</h1>\n<p>单个组件报错时不影响其他页面的加载</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23607381216660660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { Component } from \'react\';\nimport PropTypes from \'prop-types\';\n\nimport styles from \'./styles.css\';\n\nclass ErrorBoundary extends Component {\n  state = {\n    hasError: false\n  };\n\n  componentWillReceiveProps() {\n    // 重置未报错状态\n    this.setState({\n      hasError: false\n    });\n  }\n\n  componentDidCatch(error) {\n    this.setState({\n      hasError: true\n    });\n\n    console.error(error);\n    if (window.__bl) {\n      window.__bl.error(error);\n    }\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className={styles.error}>\n          <div className={styles.title}>抱歉，页面出错了！</div>\n        </div>\n      );\n    }\n    return this.props.children;\n  }\n}\n\nErrorBoundary.propTypes = {\n  children: PropTypes.node\n};\n\nexport default ErrorBoundary;`, `23607381216660660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{11-16} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">\'prop-types\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.css\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    hasError<span class="token punctuation">:</span> <span class="token boolean">false</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">// 重置未报错状态</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      hasError<span class="token punctuation">:</span> <span class="token boolean">false</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span>\n  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      hasError<span class="token punctuation">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__bl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>__bl<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">(</span>\n        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>error<span class="token punctuation">}</span><span class="token operator">></span>\n          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">></span>抱歉，页面出错了！<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\nErrorBoundary<span class="token punctuation">.</span>propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>\n  children<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>node\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> ErrorBoundary<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="stylelint-无效"><a href="#stylelint-%E6%97%A0%E6%95%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stylelint 无效</h1>\n<p>package.json</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4410693240662944000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint src/**/*.css&quot;`, `4410693240662944000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint src/**/*.css"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当在苹果电脑上运行以上命令时，没有任何效果，即使 css 格式错误也直接通过，同时提交代码前的报错信息也没有颜色，需要做下特殊处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50115957036704550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`&quot;lint:css&quot;: &quot;stylelint \\&quot;src/**/*.css\\&quot; --color&quot; # src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色\n&quot;lint&quot;: &quot;npm run lint:js && npm run lint:css&quot;,\n&quot;pre-commit&quot;: &quot;lint&quot;,`, `50115957036704550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token string">"lint:css"</span><span class="token builtin class-name">:</span> <span class="token string">"stylelint <span class="token entity" title="\\&quot;">\\"</span>src/**/*.css<span class="token entity" title="\\&quot;">\\"</span> --color"</span> <span class="token comment"># src/**/*.css 双引号转义为了兼容苹果，--color 是为了执行 pre-commit 钩子即提交代码前也能让错误的信息有颜色</span>\n<span class="token string">"lint"</span><span class="token builtin class-name">:</span> <span class="token string">"npm run lint:js &amp;&amp; npm run lint:css"</span>,\n<span class="token string">"pre-commit"</span><span class="token builtin class-name">:</span> <span class="token string">"lint"</span>,</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>',
id:"/github/workspace/blog/Webpack脚手架搭建笔记——记一次新项目搭建/index.md absPath of file >>> MarkdownRemark",timeToRead:6,frontmatter:{date:"2019-10-10 21:46:40",path:"/webpack-template-new-project/",tags:"前端, 前端构建工具, webpack, 预研",title:"Webpack脚手架搭建笔记——记一次新项目搭建",draft:null}},{excerpt:"出发点 主要是为了弥补当前 JS 没有标准的缺陷，以达到像 Python、Ruby 和 Java 具备开发大型应用的基础能力。CommonJS API 是以在浏览器环境之外构建 JS 生态系统为目标而产生的项目，比如服务器端 JS 应用程序、命令行工具、桌面图形界面应用程序等。如今，规范涵盖了模块、二进制、Buffer、字符集编码、I/O 流、进程环境、文件系统、套接字，单元测试、Web 服务器网管接口、包管理等。 CommonJS 的模块规范 CommonJS…",html:'<h1 id="出发点"><a href="#%E5%87%BA%E5%8F%91%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>出发点</h1>\n<p>主要是为了弥补当前 JS 没有标准的缺陷，以达到像 Python、Ruby 和 Java 具备开发大型应用的基础能力。CommonJS API 是以在浏览器环境之外构建 JS 生态系统为目标而产生的项目，比如服务器端 JS 应用程序、命令行工具、桌面图形界面应用程序等。如今，规范涵盖了模块、二进制、Buffer、字符集编码、I/O 流、进程环境、文件系统、套接字，单元测试、Web 服务器网管接口、包管理等。</p>\n<h1 id="commonjs-的模块规范"><a href="#commonjs-%E7%9A%84%E6%A8%A1%E5%9D%97%E8%A7%84%E8%8C%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CommonJS 的模块规范</h1>\n<p>CommonJS 对模块的定义主要分为模块引用、模块定义和模块标识 3 个部分</p>\n<h2 id="模块引用"><a href="#%E6%A8%A1%E5%9D%97%E5%BC%95%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块引用</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3658371190236598000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var math = require(\'math\');`, `3658371190236598000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> math <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'math\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在 CommonJS 规范中，存在一个<code class="language-text">require()</code>方法，这个方法接收模块标识，一次引入一个模块的 API 到当前上下文中。</p>\n<h2 id="模块定义"><a href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块定义</h2>\n<p>在模块中，上下文提供<code class="language-text">require()</code>方法引入外部模块。对应引入的功能，上下文提供一个<code class="language-text">exports</code>对象导出当前模块的方法或变量，并且它是唯一的导出出口，同时模块中还存在一个<code class="language-text">module</code>对象，它代表的是当前模块，<code class="language-text">exports</code>是<code class="language-text">module</code>的属性。所以，在 Node 中，一个文件就是一个模块，将方法或属性挂载在<code class="language-text">exports</code>对象上作为属性即可定义导出的方式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22158351893314544000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// math.js\nexports.add = function() {\n  var sum = 0,\n    i = 0,\n    args = arguments,\n    l = args.length;\n  while (i < 1) {\n    sum += args[i++];\n  }\n  return sum;\n};`, `22158351893314544000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// math.js</span>\nexports<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    args <span class="token operator">=</span> arguments<span class="token punctuation">,</span>\n    l <span class="token operator">=</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    sum <span class="token operator">+=</span> args<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> sum<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他文件中，通过<code class="language-text">require()</code>方法引入模块</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95257708458119050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// program.js\nvar math = require(\'math\');\nexports.increment = function(val) {\n  return math.add(val, 1);\n};`, `95257708458119050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// program.js</span>\n<span class="token keyword">var</span> math <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'math\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nexports<span class="token punctuation">.</span><span class="token function-variable function">increment</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="模块标识"><a href="#%E6%A8%A1%E5%9D%97%E6%A0%87%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块标识</h2>\n<p>模块标识就是传递给<code class="language-text">require()</code>方法的参数，采用小驼峰命名，或者以<code class="language-text">.</code>、<code class="language-text">..</code>开头的相对路径或绝对路径。它可以不加文件后缀.js。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-09-24-14-41-43-27eea99fa3b798045719775e8a4014b6-bf330.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 347px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 44.38040345821326%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA40lEQVQoz42R2wqDMBBE8/9/KCpeQEHxUjXWW9SeZksQ24fOwxIzM5vZVVVVNQxD13Va66eFtjgtjuOgzvPctu3DwsmAKooijmPf98dxFMO+76iv5nVdy7IMwzCKIkcBRUt6TNO0LMts0fe9ayRmKNJBcaARB/RoVNM00HVde56XpqkxhlvioJNsSCUwsizLgiBIkoR0CBS327bRSebhPFrcZuZlKLcdnFgUH0ih4eQ1YlNvsUlrLkBMfcdGQc3znK1I7Nu2MaM+v/Ax88OYhFER8ez3wn6bZY1w6HhWkjPPP+YXWK8JxSBx7JoAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 09 24 14 41 43"\n        title=""\n        src="/static/2019-09-24-14-41-43-27eea99fa3b798045719775e8a4014b6-bf330.png"\n        srcset="/static/2019-09-24-14-41-43-27eea99fa3b798045719775e8a4014b6-637d1.png 200w,\n/static/2019-09-24-14-41-43-27eea99fa3b798045719775e8a4014b6-bf330.png 347w"\n        sizes="(max-width: 347px) 100vw, 347px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>CommonJS 对模块的定义意义主要在于将类聚的方法或变量等限定在私有的作用域内，同时支持引入和导出功能以顺畅的连接上下游依赖。</p>\n<ul>\n<li>模块内所有的变量或方法都运行在模块作用域内，不会污染全局作用域</li>\n<li>模块可以多次加载，但每次加载只会运行一次，并将运行结果缓存，以待下次使用，如果想要模块再次运行，则需要清除缓存</li>\n<li>模块加载顺序和代码运行顺序一致</li>\n</ul>\n<p>CommonJS 构建的这套模块导出或引用机制使得用户完全不必考虑变量污染，命名空间等方案与之相比相形见绌。</p>\n<h1 id="module-对象"><a href="#module-%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>module 对象</h1>\n<h2 id="module"><a href="#module" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>module</h2>\n<p>通常一个<code class="language-text">module</code>有以下几个属性</p>\n<ul>\n<li>\n<p>module.id 模块的识别符，通常是带有绝对路径的模块文件名</p>\n</li>\n<li>\n<p>module.filename 模块文件名，带有绝对路径</p>\n</li>\n<li>\n<p>module.loaded 返回一个 boolean 值，标识模块是否已经加载完成</p>\n</li>\n<li>\n<p>module.parent 返回调用该模块的对象</p>\n</li>\n<li>\n<p>module.children 返回该模块调用的其他模块数组</p>\n</li>\n<li>\n<p>module.exports 返回该模块对外的输出</p>\n</li>\n<li>\n<p>module.paths 模块的搜索路径例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42334693094165450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// math.js\nexports.add = function() {\nvar sum = 0,\n  i = 0,\n  args = arguments,\n  l = args.length;\nwhile (i < 1) {\n  sum += args[i++];\n}\nreturn sum;\n};\nconsole.log(module);`, `42334693094165450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// math.js</span>\nexports<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>\n  args <span class="token operator">=</span> arguments<span class="token punctuation">,</span>\n  l <span class="token operator">=</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  sum <span class="token operator">+=</span> args<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">return</span> sum<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它的输出是:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54613664266911924000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Module {\nid: \'/Users/a123/Desktop/Study/wx/server/math.js\',\nexports: { add: [Function] },\nparent:\n Module {\n   id: \'.\',\n   exports: {},\n   parent: null,\n   filename: \'/Users/a123/Desktop/Study/wx/server/app.js\',\n   loaded: false,\n   children: [ [Module], [Module], [Module], [Module], [Module], [Circular] ],\n   paths:\n    [ \'/Users/a123/Desktop/Study/wx/server/node_modules\',\n      \'/Users/a123/Desktop/Study/wx/node_modules\',\n      \'/Users/a123/Desktop/Study/node_modules\',\n      \'/Users/a123/Desktop/node_modules\',\n      \'/Users/a123/node_modules\',\n      \'/Users/node_modules\',\n      \'/node_modules\' ] },\nfilename: \'/Users/a123/Desktop/Study/wx/server/math.js\',\nloaded: false,\nchildren: [],\npaths:\n [ \'/Users/a123/Desktop/Study/wx/server/node_modules\',\n   \'/Users/a123/Desktop/Study/wx/node_modules\',\n   \'/Users/a123/Desktop/Study/node_modules\',\n   \'/Users/a123/Desktop/node_modules\',\n   \'/Users/a123/node_modules\',\n   \'/Users/node_modules\',\n   \'/node_modules\' ] }`, `54613664266911924000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">Module <span class="token punctuation">{</span>\nid<span class="token punctuation">:</span> <span class="token string">\'/Users/a123/Desktop/Study/wx/server/math.js\'</span><span class="token punctuation">,</span>\nexports<span class="token punctuation">:</span> <span class="token punctuation">{</span> add<span class="token punctuation">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\nparent<span class="token punctuation">:</span>\n Module <span class="token punctuation">{</span>\n   id<span class="token punctuation">:</span> <span class="token string">\'.\'</span><span class="token punctuation">,</span>\n   exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n   parent<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n   filename<span class="token punctuation">:</span> <span class="token string">\'/Users/a123/Desktop/Study/wx/server/app.js\'</span><span class="token punctuation">,</span>\n   loaded<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n   children<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span>Module<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Module<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Module<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Module<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Module<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Circular<span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>\n   paths<span class="token punctuation">:</span>\n    <span class="token punctuation">[</span> <span class="token string">\'/Users/a123/Desktop/Study/wx/server/node_modules\'</span><span class="token punctuation">,</span>\n      <span class="token string">\'/Users/a123/Desktop/Study/wx/node_modules\'</span><span class="token punctuation">,</span>\n      <span class="token string">\'/Users/a123/Desktop/Study/node_modules\'</span><span class="token punctuation">,</span>\n      <span class="token string">\'/Users/a123/Desktop/node_modules\'</span><span class="token punctuation">,</span>\n      <span class="token string">\'/Users/a123/node_modules\'</span><span class="token punctuation">,</span>\n      <span class="token string">\'/Users/node_modules\'</span><span class="token punctuation">,</span>\n      <span class="token string">\'/node_modules\'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\nfilename<span class="token punctuation">:</span> <span class="token string">\'/Users/a123/Desktop/Study/wx/server/math.js\'</span><span class="token punctuation">,</span>\nloaded<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\nchildren<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\npaths<span class="token punctuation">:</span>\n <span class="token punctuation">[</span> <span class="token string">\'/Users/a123/Desktop/Study/wx/server/node_modules\'</span><span class="token punctuation">,</span>\n   <span class="token string">\'/Users/a123/Desktop/Study/wx/node_modules\'</span><span class="token punctuation">,</span>\n   <span class="token string">\'/Users/a123/Desktop/Study/node_modules\'</span><span class="token punctuation">,</span>\n   <span class="token string">\'/Users/a123/Desktop/node_modules\'</span><span class="token punctuation">,</span>\n   <span class="token string">\'/Users/a123/node_modules\'</span><span class="token punctuation">,</span>\n   <span class="token string">\'/Users/node_modules\'</span><span class="token punctuation">,</span>\n   <span class="token string">\'/node_modules\'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当 Node.js 直接运行一个文件时，<code class="language-text">require.main</code> 会被设为它的 <code class="language-text">module</code>。 这意味着可以通过 <code class="language-text">require.main === module</code> 来判断一个文件是否被直接运行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1139308830863750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// node app.js\nmath---require.main === module :  false\napp---require.main === module :  true`, `1139308830863750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// node app.js</span>\nmath<span class="token operator">--</span><span class="token operator">-</span>require<span class="token punctuation">.</span>main <span class="token operator">===</span> module <span class="token punctuation">:</span>  <span class="token boolean">false</span>\napp<span class="token operator">--</span><span class="token operator">-</span>require<span class="token punctuation">.</span>main <span class="token operator">===</span> module <span class="token punctuation">:</span>  <span class="token boolean">true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h2 id="moduleexports"><a href="#moduleexports" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>module.exports</h2>\n<p>module.exports 对象是由模块系统创建的，表示当前文件对外输出的接口。</p>\n<p><strong>注意，对 <code class="language-text">module.exports</code> 的赋值必须立即完成。 不能在任何回调中完成。</strong></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11649731918588580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建a.js文件\nconst EventEmitter = require(\'events\');\nmodule.exports = new EventEmitter(); // 赋值\n// 处理一些工作，并在一段时间后从模块自身触发 \'ready\' 事件。\nsetTimeout(() => {\n  module.exports.emit(\'ready\');\n}, 1000);`, `11649731918588580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建a.js文件</span>\n<span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'events\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 赋值</span>\n<span class="token comment">// 处理一些工作，并在一段时间后从模块自身触发 \'ready\' 事件。</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'ready\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85229405647143830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 创建b.js文件\nsetTimeout(() => {\n  module.exports = { a: \'hello\' };\n}, 0);`, `85229405647143830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 创建b.js文件</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token string">\'hello\'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97078058680773480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// app.js 文件中分别调用a、b模块\n\n// 引入a模块\nconst a = require(\'./a\');\na.on(\'ready\', () => {\n  console.log(\'模块 a 已准备好\');\n});\n\n// 引入b模块\nconst b = require(\'./b\');\nconsole.log(b.a);`, `97078058680773480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// app.js 文件中分别调用a、b模块</span>\n\n<span class="token comment">// 引入a模块</span>\n<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\na<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'ready\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'模块 a 已准备好\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 引入b模块</span>\n<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行 app.js 结果是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32733855808241574000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`undefined\n模块 a 已准备好`, `32733855808241574000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">undefined</span>\n模块 a 已准备好</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="exports"><a href="#exports" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>exports</h2>\n<p><code class="language-text">exports</code> 变量是在模块的文件级别作用域内有效的，它在模块被执行前被赋予 <code class="language-text">module.exports</code> 的值。</p>\n<p>例如： <code class="language-text">module.exports.fun = …</code>，相当于<code class="language-text">exports.fun = ...</code></p>\n<p><strong>但注意，不能将一个值赋值给<code class="language-text">exports</code>，这样它将不在绑定到<code class="language-text">module.exports</code></strong></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14221618067242180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`module.exports.hello = true; // 从对模块的引用中导出\nexports = { hello: false }; // 不导出，只在模块内有效`, `14221618067242180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>hello <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 从对模块的引用中导出</span>\nexports <span class="token operator">=</span> <span class="token punctuation">{</span> hello<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 不导出，只在模块内有效</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="moduleexports-与-exports"><a href="#moduleexports-%E4%B8%8E-exports" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>module.exports 与 exports</h2>\n<p>在上述介绍中，<code class="language-text">module.exports</code> 与<code class="language-text">exports</code>很容易混淆，下面介绍<code class="language-text">module.exports</code> 与<code class="language-text">exports</code>内部的实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93338943479778180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 1. 模块引用\nvar module = require(\'./a\');\nmodule.a; // 重要的是 module 这里，module 是 Node 独有的一个变量\n\n// 2. 模块定义\nmodule.exports = {\n  a: 1\n};\n\n// 3.模块内部实现\nfunction require(/* ... */) {\n  const module = {\n    exports: {} // exports 就是一个空对象\n  }(\n    // 这里其实就是包装了一层立即执行函数，这样就不会污染全局变量了\n    (module, exports) => {\n      // 模块代码在这\n      var a = 1; // 如果定义了一个函数。则为 function someFunc() {}\n      exports = a;\n      // 此时，exports 不再是一个 module.exports 的快捷方式，\n      // 且这个模块依然导出一个空的默认对象。\n      module.exports = a; // 这个是为什么 exports 和 module.exports 用法相似的原因\n      // 此时，该模块导出 a，而不是默认对象。\n    }\n  )(module, module.exports);\n  return module.exports;\n}`, `93338943479778180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 1. 模块引用</span>\n<span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./a\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 重要的是 module 这里，module 是 Node 独有的一个变量</span>\n\n<span class="token comment">// 2. 模块定义</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  a<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 3.模块内部实现</span>\n<span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token punctuation">{</span>\n    exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// exports 就是一个空对象</span>\n  <span class="token punctuation">}</span><span class="token punctuation">(</span>\n    <span class="token comment">// 这里其实就是包装了一层立即执行函数，这样就不会污染全局变量了</span>\n    <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 模块代码在这</span>\n      <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 如果定义了一个函数。则为 function someFunc() {}</span>\n      exports <span class="token operator">=</span> a<span class="token punctuation">;</span>\n      <span class="token comment">// 此时，exports 不再是一个 module.exports 的快捷方式，</span>\n      <span class="token comment">// 且这个模块依然导出一个空的默认对象。</span>\n      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> a<span class="token punctuation">;</span> <span class="token comment">// 这个是为什么 exports 和 module.exports 用法相似的原因</span>\n      <span class="token comment">// 此时，该模块导出 a，而不是默认对象。</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="require"><a href="#require" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>require</h2>\n<p><code class="language-text">require</code>命令的功能是，引入模块。</p>\n<p><code class="language-text">require</code>命令用于加载文件，后缀名默认为<code class="language-text">.js</code>。</p>\n<p><code class="language-text">require</code>的加载顺序是：</p>\n<ul>\n<li>\n<p>以<code class="language-text">/</code>开头，加载绝对路径模块文件</p>\n</li>\n<li>\n<p>以<code class="language-text">./</code>开头，加载相对路径模块文件</p>\n</li>\n<li>\n<p>除以上两种情况外，加载的是一个默认提供的核心模块（位于 Node 的系统安装目录中），或者一个位于各级 node_modules 目录的已安装模块（全局安装或局部安装）。举例来说，脚本/Users/a123/projects/foo.js<code class="language-text">执行了</code>require(‘bar.js’)`命令，Node 会依次搜索以下文件。</p>\n<ul>\n<li>/usr/local/lib/node/bar.js</li>\n<li>/Users/a123/projects/node_modules/bar.js</li>\n<li>/Users/a123/node_modules/bar.js</li>\n<li>/Users/node_modules/bar.js</li>\n<li>/node_modules/bar.js</li>\n</ul>\n</li>\n<li>\n<p>如果指定的模块文件没有发现，Node 会尝试为文件名添加<code class="language-text">.js</code>、<code class="language-text">.json</code>、<code class="language-text">.node</code>后，再去搜索。<code class="language-text">.js</code>件会以文本格式的 JavaScript 脚本文件解析，<code class="language-text">.json</code>文件会以 JSON 格式的文本文件解析，<code class="language-text">.node</code>文件会以编译后的二进制文件解析。</p>\n</li>\n<li>\n<p>如果想得到<code class="language-text">require</code>命令加载的确切文件名，使用<code class="language-text">require.resolve()</code>方法。</p>\n</li>\n</ul>\n<p>通常，我们会把相关的文件放在一个目录里面，便于组织，这就需要给该目录设置一个入口文件，可以让<code class="language-text">require</code>方法通过这个入口文件，加载整个目录，例如<code class="language-text">package.json</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30699104236133003000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n    &quot;name&quot;: &quot;wx_backend&quot;,\n    &quot;version&quot;: &quot;1.0.0&quot;,\n    &quot;description&quot;: &quot;&quot;,\n    &quot;main&quot;: &quot;app.js&quot;,\n    &quot;scripts&quot;: {\n        &quot;start:node-dev&quot;: &quot;pm2 start process.prod.json --no-daemon  --env development&quot;,\n        &quot;start:node-prod&quot;: &quot;pm2 start process.prod.json --no-daemon  --env production&quot;,\n        &quot;dev&quot;: &quot;nodemon --config nodemon.json app.js&quot;,\n        &quot;initdb&quot;: &quot;npm install && node tools/initdb.js&quot;\n    },\n...\n}`, `30699104236133003000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"wx_backend"</span><span class="token punctuation">,</span>\n    <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>\n    <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>\n    <span class="token string">"main"</span><span class="token punctuation">:</span> <span class="token string">"app.js"</span><span class="token punctuation">,</span>\n    <span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token string">"start:node-dev"</span><span class="token punctuation">:</span> <span class="token string">"pm2 start process.prod.json --no-daemon  --env development"</span><span class="token punctuation">,</span>\n        <span class="token string">"start:node-prod"</span><span class="token punctuation">:</span> <span class="token string">"pm2 start process.prod.json --no-daemon  --env production"</span><span class="token punctuation">,</span>\n        <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token string">"nodemon --config nodemon.json app.js"</span><span class="token punctuation">,</span>\n        <span class="token string">"initdb"</span><span class="token punctuation">:</span> <span class="token string">"npm install &amp;&amp; node tools/initdb.js"</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token operator">...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">require</code>发现参数字符串指向一个目录时，就会自动查看该目录下的<code class="language-text">package.json</code>文件，然后加载<code class="language-text">main</code>指定的入口文件，如果<code class="language-text">package.json</code>中没有<code class="language-text">main</code>字段，或者根本没有<code class="language-text">package.json</code>文件，则会加载该目录下的<code class="language-text">index.js</code>文件或<code class="language-text">index.node</code>文件。</p>\n<p><a href="https://nodejs.org/api/modules.html" target="_blank" rel="nofollow noreferrer noopener">具体可查阅 nodeJS</a></p>\n<h1 id="扩展"><a href="#%E6%89%A9%E5%B1%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>扩展</h1>\n<p>前后端 JS 分别搁置在 HTTP 的两端，它们扮演的角色不同，侧重点也不一样。 <strong>浏览器端的 JS 需要经历从一个服务器端分发到多个客户端执行，而服务器端 JS 则是相同的代码需要多次执行。前者的瓶颈在于带宽，后者的瓶颈则在于 CPU 等内存资源。前者需要通过网络加载代码，后者则需要从磁盘中加载，</strong> 两者的加载速度也不是在一个数量级上的。</p>\n<p>纵观 Node 的模块引入过程，几乎全都是同步的，尽管与 Node 强调异步的行为有些相反，但它是合理的，但前端如果也用同步方式引入，试想一下，在 UI 加载的过程中需要花费很多时间来等待脚本加载完成，这会造成用户体验的很大问题。</p>\n<p>鉴于网络的原因， CommonJS 为后端 JS 制定的规范并不完全适合与前端的应用场景，下面来介绍 JS 前端的规范。</p>\n<h2 id="amd"><a href="#amd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AMD</h2>\n<p>AMD 是由 RequireJS 提出的，相对于 CommonJS 同步加载来说，AMD 是”Asynchronous Module Definition”（异步模块定义）的缩写。是为浏览器环境专门设计的。</p>\n<p>RequireJS 即为遵循 AMD 规范的模块化工具。 RequireJS 的基本思想是，通过一个函数来将所有所需要的或者说所依赖的模块实现装载进来，然后返回一个新的函数（模块），我们所有的关于新模块的业务代码都在这个函数内部操作，其内部也可无限制的使用已经加载进来的以来的模块。</p>\n<p><strong>define(id?, dependencies?, factory)</strong></p>\n<ul>\n<li>\n<p>id 为字符串类型，表示了模块标识，为可选参数。若不存在则模块标识应该默认定义为在加载器中被请求脚本的标识。如果存在，那么模块标识必须为顶层的或者一个绝对的标识。</p>\n</li>\n<li>\n<p>dependencies ，是一个当前模块依赖的，已被模块定义的模块标识的数组字面量。</p>\n</li>\n<li>\n<p>factory，是一个需要进行实例化的函数或者一个对象。</p>\n</li>\n<li>\n<p>定义模块</p>\n<ul>\n<li>\n<p>定义无依赖模块</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10860332893422830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`define({\nsum: function(x, y) {\n return x + y;\n}\n});`, `10860332893422830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n<span class="token function-variable function">sum</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>定义有依赖模块</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49680036779323890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`define([\'some\'], function(alpha) {\nreturn {\n add: function() {\n   return some.sum() + 1;\n }\n};\n});`, `49680036779323890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'some\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">alpha</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token keyword">return</span> <span class="token punctuation">{</span>\n <span class="token function-variable function">add</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">return</span> some<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>定义数据对象模块</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51774643086604090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`define({\nadd: [],\nsub: []\n});`, `51774643086604090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\nadd<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\nsub<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>具名模块</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17024061517239185000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`define(&quot;alpha&quot;, [ &quot;require&quot;, &quot;exports&quot;, &quot;beta&quot; ], function( require, exports, beta ){\n export.verb = function(){\n     return beta.verb();\n     // or:\n     return require(&quot;beta&quot;).verb();\n }\n});`, `17024061517239185000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"alpha"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">"require"</span><span class="token punctuation">,</span> <span class="token string">"exports"</span><span class="token punctuation">,</span> <span class="token string">"beta"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> beta</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>\n <span class="token keyword">export</span><span class="token punctuation">.</span><span class="token function-variable function">verb</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n     <span class="token keyword">return</span> beta<span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n     <span class="token comment">// or:</span>\n     <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"beta"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>包装模块</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34963207960657550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`define(function(require, exports, module) {\n  var a = require(\'a\'),\n    b = require(\'b\');\n\n  exports.action = function() {};\n});`, `34963207960657550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  exports<span class="token punctuation">.</span><span class="token function-variable function">action</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p> 不考虑多了一层函数外，格式和 Node.js 是一样的：使用 require 获取依赖模块，使用 exports 导出 API。除了 define 外，AMD 还保留一个关键字 require。require 作为规范保留的全局标识符，可以实现为 module loader，也可以不实现。</p>\n</li>\n<li>\n<p>模块加载</p>\n<p><strong>require([module], callback)</strong></p>\n<ul>\n<li>[module]：是一个数组，里面的成员就是要加载的模块</li>\n<li>callback：是模块加载完成之后的回调函数</li>\n<li>require 方法允许添加第三个参数，即错误处理的回调函数。</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73734708912234320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`require([\'math\'], function(math) {\n math.add(2, 3);\n});`, `73734708912234320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'math\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">math</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n math<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h2 id="cmd"><a href="#cmd" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMD</h2>\n<p>CMD 的规范由国内的玉伯提出，与 AMD 的区别主要在于 <strong>定义模块与依赖引入</strong> 的部分。</p>\n<ol>\n<li>\n<p>CMD 更接近与 Node 对 CommonJS 规范的定义： <strong>define(factory)</strong></p>\n</li>\n<li>\n<p>在依赖部分，CMD 支持动态引入</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14803000189289660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`define(function(require, exports, module) {\n   // 模块内容\n}`, `14803000189289660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 模块内容</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>require、exports、module 通过形参传递给模块，在需要依赖模块时，可以通过 <code class="language-text">require()</code> 引入。</p>\n</li>\n</ol>\n<h2 id="es6-模块化"><a href="#es6-%E6%A8%A1%E5%9D%97%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES6 模块化</h2>\n<p>ES6 正式提出了内置的模块化语法。</p>\n<p>ES6 的模块自动采用严格模式，不管你有没有在模块头部加上<code class="language-text">&quot;use strict&quot;;</code>。</p>\n<p>模块功能主要由两个命令构成：<code class="language-text">export</code>和<code class="language-text">import</code>。<code class="language-text">export</code>命令用于规定模块的对外接口，<code class="language-text">import</code>命令用于输入其他模块提供的功能。</p>\n<ol>\n<li>\n<p>export</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44568169726248440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`//导出变量\nexport var a = 1;\n\n//导出函数\nexport function fun(){\n  ...\n}\n\n//导出类\nexport class Rectangle {\n   ...\n}\n\nfunction fun1() { ... }\nfunction fun2() { ... }\n//导出对象，即导出引用\nexport {fun1 as f1, fun2 as f2} // 重命名模块\n\n// 导出默认值\nexport default function fun3() { ... }\n\n// 错误, 后面不能跟变量声明语句。\nexport default var a = 1\n\n// 正确\nexport default 42`, `44568169726248440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">//导出变量</span>\n<span class="token keyword">export</span> <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n<span class="token comment">//导出函数</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n  <span class="token operator">...</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">//导出类</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>\n   <span class="token operator">...</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>\n<span class="token comment">//导出对象，即导出引用</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span>fun1 <span class="token keyword">as</span> f1<span class="token punctuation">,</span> fun2 <span class="token keyword">as</span> f2<span class="token punctuation">}</span> <span class="token comment">// 重命名模块</span>\n\n<span class="token comment">// 导出默认值</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">fun3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>\n\n<span class="token comment">// 错误, 后面不能跟变量声明语句。</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>\n\n<span class="token comment">// 正确</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">42</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，<code class="language-text">export</code>语句输出的接口，与其对应的值是动态绑定关系，即通过该接口，可以取到模块内部实时的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87306802952481720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export var foo = \'bar\';\nsetTimeout(() => (foo = \'baz\'), 500);`, `87306802952481720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token string">\'bar\'</span><span class="token punctuation">;</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>foo <span class="token operator">=</span> <span class="token string">\'baz\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>上面代码输出变量<code class="language-text">foo</code>，值为<code class="language-text">bar</code>，500 毫秒之后变成<code class="language-text">baz</code>。</p>\n</li>\n<li>\n<p>import</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82930691393830600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 第一组 example.js\nexport default function fun() {\n // 输出\n // ...\n}\n// app.js\nimport fun from \'./example\';\n\n// 第二组 example.js\nexport function fun() {\n // 输出\n // ...\n}\n// app.js\nimport { fun } from \'./example\'; // 输入\n// 或\nimport * as allFun from \'./example\';\n//allFun.fun`, `82930691393830600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 第一组 example.js</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token comment">// 输出</span>\n <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// app.js</span>\n<span class="token keyword">import</span> fun <span class="token keyword">from</span> <span class="token string">\'./example\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 第二组 example.js</span>\n<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token comment">// 输出</span>\n <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// app.js</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> fun <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./example\'</span><span class="token punctuation">;</span> <span class="token comment">// 输入</span>\n<span class="token comment">// 或</span>\n<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> allFun <span class="token keyword">from</span> <span class="token string">\'./example\'</span><span class="token punctuation">;</span>\n<span class="token comment">//allFun.fun</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">export default</code>命令用于指定模块的默认输出。显然，一个模块只能有一个默认输出，因此<code class="language-text">export default</code>命令只能使用一次。所以，<code class="language-text">import</code>命令后面才不用加大括号，因为只可能对应一个方法。本质上，<code class="language-text">export default</code>就是输出一个叫做<code class="language-text">default</code>的变量或方法，然后系统允许你为它取任意名字。所以，下面的写法是有效的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41744453386097754000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// modules.js\nfunction fun() {\n ...\n}\nexport {fun as default};\n// 等同于\n// export default fun;\n\n// app.js\nimport { default as fun } from \'./modules\';\n// 等同于\n// import fun from \'modules\';`, `41744453386097754000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// modules.js</span>\n<span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token operator">...</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">export</span> <span class="token punctuation">{</span>fun <span class="token keyword">as</span> <span class="token keyword">default</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 等同于</span>\n<span class="token comment">// export default fun;</span>\n\n<span class="token comment">// app.js</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> fun <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./modules\'</span><span class="token punctuation">;</span>\n<span class="token comment">// 等同于</span>\n<span class="token comment">// import fun from \'modules\';</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p><code class="language-text">CommonJS</code>和 ES6 中模块化的两者区别</p>\n<ul>\n<li>前者支持动态导入，也就是 <code class="language-text">require(${path}/xx.js)</code>，后者目前不支持，但是已有提案</li>\n<li>前者是同步导入，因为用于服务端，文件都在本地，同步导入即使卡住主线程影响也不大。而后者是异步导入，因为用于浏览器，需要下载文件，如果也采用同步导入会对渲染有很大影响</li>\n<li>前者在导出时都是值拷贝，就算导出的值变了，导入的值也不会改变，所以如果想更新值，必须重新导入一次。但是后者采用实时绑定的方式，导入导出的值都指向同一个内存地址，所以导入值会跟随导出值变化</li>\n<li>后者会编译成 <code class="language-text">require/exports</code> 来执行的</li>\n</ul>\n</li>\n</ol>',
id:"/github/workspace/blog/CommonJS规范总结与扩展/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2019-09-24 14:32:18",path:"/commonjs-summary-extension/",tags:"前端, commonjs",title:"CommonJS规范总结与扩展",draft:null}},{excerpt:"初识 context 在典型的 React 应用中，  数据  是通过 props 属性显式的由父及子进行  传递  的，但这种方式，对于复杂情况（例如，跨多级传递，多个组件共享）来说，是极其繁琐的。 第一种解决方式是：  组件的封装与组合，将组件自身传递下去 在项目中，我们在父层获取数据，不同层级的子组件访问时，我们可以使用  将子组件的公共组件封装，将公共组件传递下去  。例如 这种对组件的  控制反转  减少了在应用中要传递的 props…",html:'<h1 id="初识-context"><a href="#%E5%88%9D%E8%AF%86-context" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>初识 context</h1>\n<p>在典型的 React 应用中， <strong>数据</strong> 是通过 props 属性显式的由父及子进行 <strong>传递</strong> 的，但这种方式，对于复杂情况（例如，跨多级传递，多个组件共享）来说，是极其繁琐的。</p>\n<ul>\n<li>\n<p>第一种解决方式是： <strong>组件的封装与组合，将组件自身传递下去</strong></p>\n<p>在项目中，我们在父层获取数据，不同层级的子组件访问时，我们可以使用 <strong>将子组件的公共组件封装，将公共组件传递下去</strong> 。例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81821425481790900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Page(props) {\n// 你可以传递多个子组件，甚至会为这些子组件（children）封装多个单独的接口（slots）\nconst localeCom = <span>{props.locale}</span>;\nreturn <Content localeCom={localeCom} />;\n} // 这种情况下，只有顶层 Page 才知道 localeCom 的具体实现，实现了组件的控制反转\n\nfunction Content(props) {\nreturn (\n  <div>\n    <FirstComponent localeCom={localeCom} />\n  </div>\n);\n}\n\nclass FirstComponent extends React.Component {\nrender() {\n  return <div>FirstComponent: {this.props.localeCom}</div>;\n}\n}`, `81821425481790900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token comment">// 你可以传递多个子组件，甚至会为这些子组件（children）封装多个单独的接口（slots）</span>\n<span class="token keyword">const</span> localeCom <span class="token operator">=</span> <span class="token operator">&lt;</span>span<span class="token operator">></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>locale<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token keyword">return</span> <span class="token operator">&lt;</span>Content localeCom<span class="token operator">=</span><span class="token punctuation">{</span>localeCom<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token comment">// 这种情况下，只有顶层 Page 才知道 localeCom 的具体实现，实现了组件的控制反转</span>\n\n<span class="token keyword">function</span> <span class="token function">Content</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>FirstComponent localeCom<span class="token operator">=</span><span class="token punctuation">{</span>localeCom<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">class</span> <span class="token class-name">FirstComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>FirstComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>localeCom<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种对组件的 <strong>控制反转</strong> 减少了在应用中要传递的 props 数量，这在很多场景下会使得你的 <strong>代码更加干净</strong> ，使你对根组件有更多的把控。但是，这并不适用于每一个场景： <strong>将逻辑提升到组件树的更高层次来处理，会使得这些高层组件变得更复杂，并且会强行将低层组件提到高层实现，这很多时候有违常理</strong>。</p>\n</li>\n<li>\n<p>第二种解决方式是：<strong>context</strong></p>\n<p><strong>context</strong> 提供了一种在 <strong>组件之间共享此类值</strong> 的方式，使得我们无需每层显式添加 props 或传递组件 ，就能够实现在 <strong>组件树中传递数据</strong> 。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5575630378920326000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Context 可以让我们无须显式地传遍每一个组件，就能将值深入传递进组件树。\n// 为当前的 locale 创建一个 context（默认值为 anan）。\n// context 会在每一个创建或使用 context 的组件上引入，所以，最好在单独一个文件中定义\n// 这里只做演示\nconst LocaleContext = React.createContext(\'anan\');\n\nclass App extends React.Component {\nrender() {\n  // 使用一个 Provider 来将当前的 name 传递给以下的组件树。\n  // 无论多深，任何组件都能读取这个值。\n  // 在这个例子中，我们将 “ananGe” 作为当前的值传递下去。\n  return (\n    // Provider 接收一个 value 属性，传递给消费组件\n    <LocaleContext.Provider value=\'ananGe\'>\n      <Content />\n    </LocaleContext.Provider>\n  );\n}\n}\n\n// 中间的组件再也不必指明往下传递 locale 了。\n// LocaleContext 分别在 FirstComponent 组件与 SecondComponent 的子组件 SubComponent 中使用\nfunction Content(props) {\nreturn (\n  <div>\n    <FirstComponent />\n    <SecondComponent />\n  </div>\n);\n}\n\n// 第一个子组件\nclass FirstComponent extends React.Component {\n// 指定 contextType 读取当前的 locale context。\n// React 会往上找到最近的 locale Provider，然后使用它的值。\n// 在这个例子中，当前的 locale 值为 ananGe\nstatic contextType = LocaleContext;\nrender() {\n  return (\n    <div>\n      FirstComponent: <span>{this.context}</span>\n    </div>\n  );\n}\n}\n\n// 第二个子组件（中间件）\nfunction SecondComponent(props) {\nreturn (\n  <div>\n    <SubComponent />\n  </div>\n);\n}\n// SecondComponent 的子组件\nclass SubComponent extends React.Component {\nstatic contextType = LocaleContext;\nrender() {\n  return (\n    <div>\n      SubComponent: <span>{this.context}</span>\n    </div>\n  ); // this.context 为传递过来的 value 值\n}\n}`, `5575630378920326000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Context 可以让我们无须显式地传遍每一个组件，就能将值深入传递进组件树。</span>\n<span class="token comment">// 为当前的 locale 创建一个 context（默认值为 anan）。</span>\n<span class="token comment">// context 会在每一个创建或使用 context 的组件上引入，所以，最好在单独一个文件中定义</span>\n<span class="token comment">// 这里只做演示</span>\n<span class="token keyword">const</span> LocaleContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token string">\'anan\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 使用一个 Provider 来将当前的 name 传递给以下的组件树。</span>\n  <span class="token comment">// 无论多深，任何组件都能读取这个值。</span>\n  <span class="token comment">// 在这个例子中，我们将 “ananGe” 作为当前的值传递下去。</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token comment">// Provider 接收一个 value 属性，传递给消费组件</span>\n    <span class="token operator">&lt;</span>LocaleContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token string">\'ananGe\'</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Content <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>LocaleContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 中间的组件再也不必指明往下传递 locale 了。</span>\n<span class="token comment">// LocaleContext 分别在 FirstComponent 组件与 SecondComponent 的子组件 SubComponent 中使用</span>\n<span class="token keyword">function</span> <span class="token function">Content</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>FirstComponent <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token operator">&lt;</span>SecondComponent <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 第一个子组件</span>\n<span class="token keyword">class</span> <span class="token class-name">FirstComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n<span class="token comment">// 指定 contextType 读取当前的 locale context。</span>\n<span class="token comment">// React 会往上找到最近的 locale Provider，然后使用它的值。</span>\n<span class="token comment">// 在这个例子中，当前的 locale 值为 ananGe</span>\n<span class="token keyword">static</span> contextType <span class="token operator">=</span> LocaleContext<span class="token punctuation">;</span>\n<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div<span class="token operator">></span>\n      FirstComponent<span class="token punctuation">:</span> <span class="token operator">&lt;</span>span<span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 第二个子组件（中间件）</span>\n<span class="token keyword">function</span> <span class="token function">SecondComponent</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>div<span class="token operator">></span>\n    <span class="token operator">&lt;</span>SubComponent <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// SecondComponent 的子组件</span>\n<span class="token keyword">class</span> <span class="token class-name">SubComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n<span class="token keyword">static</span> contextType <span class="token operator">=</span> LocaleContext<span class="token punctuation">;</span>\n<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div<span class="token operator">></span>\n      SubComponent<span class="token punctuation">:</span> <span class="token operator">&lt;</span>span<span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this.context 为传递过来的 value 值</span>\n<span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><strong>注意：在大多数情况下，context 一般用来做 中间件 的方式使用，例如 redux。</strong></p>\n<ul>\n<li><strong>React.createContext</strong></li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36027883278954830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const LocaleContext = React.createContext(defaultValue);\n// 创建一个 Context 对象。当 React 渲染一个订阅了这个 Context 对象的组件，这个组件会从组件树中 离自身最近 的那个匹配的 Provider 中读取到当前的 context 值。`, `36027883278954830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> LocaleContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 创建一个 Context 对象。当 React 渲染一个订阅了这个 Context 对象的组件，这个组件会从组件树中 离自身最近 的那个匹配的 Provider 中读取到当前的 context 值。</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<ul>\n<li><strong>Context.Provider</strong></li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49004507836269860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<LocaleContext.Provider value={/* 某个值 */}>`, `49004507836269860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token operator">&lt;</span>LocaleContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token comment">/* 某个值 */</span><span class="token punctuation">}</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<ul>\n<li>\n<p>Provider 接收一个 <strong>value</strong> 属性，传递给消费组件。</p>\n</li>\n<li>\n<p>一个 Provider 可以和 <strong>多个消费组件</strong> 有对应关系。多个 Provider 可以 <strong>嵌套使用</strong> ，里层的会覆盖外层的数据。</p>\n</li>\n<li>\n<p>当 Provider 的 value 值发生变化时，它内部的所有消费组件都会 <strong>重新渲染</strong> 。</p>\n</li>\n<li>\n<p>Provider 及其内部 consumer 组件都 <strong>不受制于 shouldComponentUpdate</strong> 函数，因此当 consumer 组件在其祖先组件退出更新的情况下也能更新。</p>\n</li>\n<li>\n<p>通过新旧值检测来确定变化，使用了与 <strong>Object.is</strong> （<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is" target="_blank" rel="nofollow noreferrer noopener">Object.is MDN</a>） 相同的算法。</p>\n</li>\n<li>\n<p><strong>Class.contextType</strong></p>\n</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78844551169827600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 挂载在 SubComponent 上的 contextType 属性会被重赋值为 LocaleContext\nSubComponent.contextType = LocaleContext;\n// 使用 this.context 来消费最近 Context 上的那个值\nlet value = this.context;\n\n// 你可以使用这种方式来获取 context value，也可以使用 Context.Consumer 函数式订阅获取`, `78844551169827600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 挂载在 SubComponent 上的 contextType 属性会被重赋值为 LocaleContext</span>\nSubComponent<span class="token punctuation">.</span>contextType <span class="token operator">=</span> LocaleContext<span class="token punctuation">;</span>\n<span class="token comment">// 使用 this.context 来消费最近 Context 上的那个值</span>\n<span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>\n\n<span class="token comment">// 你可以使用这种方式来获取 context value，也可以使用 Context.Consumer 函数式订阅获取</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li><strong>Context.Consumer</strong></li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78523474741604860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 在函数式组件中完成订阅 context\n<LocaleContext.Consumer>\n  {value => /* 基于 context 值进行渲染*/}\n</LocaleContext.Consumer>`, `78523474741604860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 在函数式组件中完成订阅 context</span>\n<span class="token operator">&lt;</span>LocaleContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>\n  <span class="token punctuation">{</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token comment">/* 基于 context 值进行渲染*/</span><span class="token punctuation">}</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>LocaleContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h1 id="深入-context"><a href="#%E6%B7%B1%E5%85%A5-context" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>深入 context</h1>\n<ul>\n<li>当 Provider 的 value 值发生变化时，它内部的所有消费组件都会 <strong>重新渲染</strong></li>\n<li>当需要在 <strong>Consumer 中触发 Provider 执行更新 context value 操作</strong> 时，可以通过 context 传递一个 <strong>函数</strong> ，使得 consumer 组件触发更新 context</li>\n<li>多个 context 可以 <strong>嵌套使用</strong></li>\n<li>注意： <strong>不要在 Provider value 直接赋值</strong> （<code class="language-text">&lt;LocaleProvider.Provider value={{name: &#39;AnGe&#39;}}&gt;</code>），因为这样会导致，每次 Provider 的父组件进行重渲染时，都会导致 Consumer 组件中重新渲染，因为 <code class="language-text">value</code> 属性总是被赋值为新的对象（Object.is 新旧值检测）</li>\n</ul>\n<p><strong>locale-context.js</strong></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13330338920777996000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export const locales = {\n  An: {\n    name: \'an\',\n    color: \'red\'\n  },\n  AnGe: {\n    name: \'anGe\',\n    color: \'green\'\n  }\n};\n\nexport const LocaleContext = React.createContext(\n  locales.An // 默认值\n);\n\n// 确保传递给 createContext 的默认值数据结构是调用的组件（consumers）所能匹配的！\nexport const AddressContext = React.createContext({\n  address: \'Shanghai\',\n  updateAddress: () => {} // Consumer 更新 Provider value 函数\n});`, `13330338920777996000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> locales <span class="token operator">=</span> <span class="token punctuation">{</span>\n  An<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'an\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token string">\'red\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  AnGe<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    name<span class="token punctuation">:</span> <span class="token string">\'anGe\'</span><span class="token punctuation">,</span>\n    color<span class="token punctuation">:</span> <span class="token string">\'green\'</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> LocaleContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>\n  locales<span class="token punctuation">.</span>An <span class="token comment">// 默认值</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 确保传递给 createContext 的默认值数据结构是调用的组件（consumers）所能匹配的！</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> AddressContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  address<span class="token punctuation">:</span> <span class="token string">\'Shanghai\'</span><span class="token punctuation">,</span>\n  <span class="token function-variable function">updateAddress</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// Consumer 更新 Provider value 函数</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><strong>app.js</strong></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15979614195318393000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { locales, LocaleContext, AddressContext } from \'./locale-context\';\nimport SubComponent from \'./SubComponent\';\n\nclass App extends React.Component {\n  state = {\n    locale: locales.An,\n    address: \'Beijing\'\n  };\n  // 更新 locale 函数\n  changePerson = () => {\n    this.setState((state) => ({\n      locale: state.locale === locales.An ? locales.AnGe : locales.An\n    }));\n  };\n  // 更新 address 函数\n  updateAddress = () => {\n    this.setState((state) => ({\n      address: state.address === \'Beijing\' ? \'Shanghai\' : \'Beijing\'\n    }));\n  };\n\n  render() {\n    const { locale, address } = this.state;\n\n    // addressValue 包含了 updateAddress 更新函数\n    const addressValue = {\n      address: \'Beijing\',\n      updateAddress: this.updateAddress\n    };\n    return (\n      <div>\n        // 在 LocaleProvider 内部的 SubComponent 组件使用 state 中的 locale 值 // 当 LocaleProvider 的 value\n        值发生变化时，它内部的所有消费组件都会重新渲染\n        <LocaleProvider.Provider value={locale}>\n          // addressValue 都被传递进 AddressContext.Provider\n          <AddressContext.Provider value={addressValue}>\n            <Toolbar changePerson={this.changePerson} />\n          </AddressContext.Provider>\n        </LocaleProvider.Provider>\n        // 而外部的组件，没有被 LocaleProvider.Provider 包裹，则使用默认的 locale 值\n        <div>\n          <SubComponent />\n        </div>\n      </div>\n    );\n  }\n}\n\n// 一个使用 SubComponent 的中间组件\nfunction Toolbar(props) {\n  return <SubComponent onClick={props.changePerson}>Change Person</SubComponent>;\n}\n\nReactDOM.render(<App />, document.root);`, `15979614195318393000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> locales<span class="token punctuation">,</span> LocaleContext<span class="token punctuation">,</span> AddressContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./locale-context\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> SubComponent <span class="token keyword">from</span> <span class="token string">\'./SubComponent\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  state <span class="token operator">=</span> <span class="token punctuation">{</span>\n    locale<span class="token punctuation">:</span> locales<span class="token punctuation">.</span>An<span class="token punctuation">,</span>\n    address<span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// 更新 locale 函数</span>\n  <span class="token function-variable function">changePerson</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n      locale<span class="token punctuation">:</span> state<span class="token punctuation">.</span>locale <span class="token operator">===</span> locales<span class="token punctuation">.</span>An <span class="token operator">?</span> locales<span class="token punctuation">.</span>AnGe <span class="token punctuation">:</span> locales<span class="token punctuation">.</span>An\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token comment">// 更新 address 函数</span>\n  <span class="token function-variable function">updateAddress</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n      address<span class="token punctuation">:</span> state<span class="token punctuation">.</span>address <span class="token operator">===</span> <span class="token string">\'Beijing\'</span> <span class="token operator">?</span> <span class="token string">\'Shanghai\'</span> <span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> locale<span class="token punctuation">,</span> address <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>\n\n    <span class="token comment">// addressValue 包含了 updateAddress 更新函数</span>\n    <span class="token keyword">const</span> addressValue <span class="token operator">=</span> <span class="token punctuation">{</span>\n      address<span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span>\n      updateAddress<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>updateAddress\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token operator">&lt;</span>div<span class="token operator">></span>\n        <span class="token comment">// 在 LocaleProvider 内部的 SubComponent 组件使用 state 中的 locale 值 // 当 LocaleProvider 的 value</span>\n        值发生变化时，它内部的所有消费组件都会重新渲染\n        <span class="token operator">&lt;</span>LocaleProvider<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>locale<span class="token punctuation">}</span><span class="token operator">></span>\n          <span class="token comment">// addressValue 都被传递进 AddressContext.Provider</span>\n          <span class="token operator">&lt;</span>AddressContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>addressValue<span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>Toolbar changePerson<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>changePerson<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n          <span class="token operator">&lt;</span><span class="token operator">/</span>AddressContext<span class="token punctuation">.</span>Provider<span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>LocaleProvider<span class="token punctuation">.</span>Provider<span class="token operator">></span>\n        <span class="token comment">// 而外部的组件，没有被 LocaleProvider.Provider 包裹，则使用默认的 locale 值</span>\n        <span class="token operator">&lt;</span>div<span class="token operator">></span>\n          <span class="token operator">&lt;</span>SubComponent <span class="token operator">/</span><span class="token operator">></span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 一个使用 SubComponent 的中间组件</span>\n<span class="token keyword">function</span> <span class="token function">Toolbar</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>SubComponent onClick<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>changePerson<span class="token punctuation">}</span><span class="token operator">></span>Change Person<span class="token operator">&lt;</span><span class="token operator">/</span>SubComponent<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><strong>SubComponent.js</strong></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61485071189755350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { LocaleContext, AddressContext } from \'./locale-context\';\n\nclass SubComponent extends React.Component {\n  render() {\n    const props = this.props;\n    return (\n      // 一个组件可能会消费多个 context\n      <LocaleContext.Consumer>\n        {(locale) => (\n          <div {...props} style={{ color: locale.color }}>\n            {locale.name}\n            <AddressContext.Consumer>\n              {\' \'}\n              // AddressContext.Consumer 可以从 context 中获取到 address 值 与 updateAddress 函数\n              {(\n                address,\n                updateAddress // 点击 button，执行 AddressContext.Provider 的 updateAddress 函数，更新 address\n              ) => <button onClick={updateAddress}>{address}</button>}\n            </AddressContext.Consumer>\n          </div>\n        )}\n      </LocaleContext.Consumer>\n    );\n  }\n}\n\nexport default SubComponent;`, `61485071189755350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> LocaleContext<span class="token punctuation">,</span> AddressContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./locale-context\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name">SubComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token comment">// 一个组件可能会消费多个 context</span>\n      <span class="token operator">&lt;</span>LocaleContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>\n        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">locale</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n          <span class="token operator">&lt;</span>div <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> color<span class="token punctuation">:</span> locale<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token punctuation">{</span>locale<span class="token punctuation">.</span>name<span class="token punctuation">}</span>\n            <span class="token operator">&lt;</span>AddressContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>\n              <span class="token punctuation">{</span><span class="token string">\' \'</span><span class="token punctuation">}</span>\n              <span class="token comment">// AddressContext.Consumer 可以从 context 中获取到 address 值 与 updateAddress 函数</span>\n              <span class="token punctuation">{</span><span class="token punctuation">(</span>\n                address<span class="token punctuation">,</span>\n                updateAddress <span class="token comment">// 点击 button，执行 AddressContext.Provider 的 updateAddress 函数，更新 address</span>\n              <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>updateAddress<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>address<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">}</span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>AddressContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>\n          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token punctuation">)</span><span class="token punctuation">}</span>\n      <span class="token operator">&lt;</span><span class="token operator">/</span>LocaleContext<span class="token punctuation">.</span>Consumer<span class="token operator">></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> SubComponent<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="源码解读"><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码解读</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66635725631194060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function createContext<T>(\n  defaultValue: T, // context 默认值\n  calculateChangedBits: ?(a: T, b: T) => number // 计算新老 context 变化函数\n): ReactContext<T> {\n  if (calculateChangedBits === undefined) {\n    calculateChangedBits = null;\n  } else {\n    if (__DEV__) {\n      warningWithoutStack(\n        calculateChangedBits === null || typeof calculateChangedBits === \'function\',\n        \'createContext: Expected the optional second argument to be a \' + \'function. Instead received: %s\',\n        calculateChangedBits\n      );\n    }\n  }\n\n  // 声明了一个 context 对象\n  const context: ReactContext<T> = {\n    \\$\\$typeof: REACT_CONTEXT_TYPE,\n    _calculateChangedBits: calculateChangedBits,\n    // As a workaround to support multiple concurrent renderers, we categorize\n    // some renderers as primary and others as secondary. We only expect\n    // there to be two concurrent renderers at most: React Native (primary) and\n    // Fabric (secondary); React DOM (primary) and React ART (secondary).\n    // Secondary renderers store their context values on separate fields.\n    _currentValue: defaultValue, // 用来记录 context 最新值，当 Provider value 更新时，同步到 _currentValue 上\n    _currentValue2: defaultValue,\n    // Used to track how many concurrent renderers this context currently\n    // supports within in a single renderer. Such as parallel server rendering.\n    _threadCount: 0,\n    // These are circular\n    Provider: (null: any), // context Provider\n    Consumer: (null: any) // context Consumer\n  };\n\n  context.Provider = {\n    // context.Provider 的 _context 为 context\n    \\$\\$typeof: REACT_PROVIDER_TYPE,\n    _context: context\n  };\n\n  let hasWarnedAboutUsingNestedContextConsumers = false;\n  let hasWarnedAboutUsingConsumerProvider = false;\n\n  if (__DEV__) {\n    // A separate object, but proxies back to the original context object for\n    // backwards compatibility. It has a different \\$\\$typeof, so we can properly\n    // warn for the incorrect usage of Context as a Consumer.\n    const Consumer = {\n      //Consumer 的 _context 也为 context\n      \\$\\$typeof: REACT_CONTEXT_TYPE,\n      _context: context,\n      _calculateChangedBits: context._calculateChangedBits\n    };\n    // \\$FlowFixMe: Flow complains about not setting a value, which is intentional here\n    Object.defineProperties(Consumer, {\n      Provider: {\n        get() {\n          if (!hasWarnedAboutUsingConsumerProvider) {\n            hasWarnedAboutUsingConsumerProvider = true;\n            warning(\n              false,\n              \'Rendering <Context.Consumer.Provider> is not supported and will be removed in \' +\n                \'a future major release. Did you mean to render <Context.Provider> instead?\'\n            );\n          }\n          return context.Provider;\n        },\n        set(_Provider) {\n          context.Provider = _Provider;\n        }\n      },\n      _currentValue: {\n        get() {\n          return context._currentValue;\n        },\n        set(_currentValue) {\n          context._currentValue = _currentValue;\n        }\n      },\n      _currentValue2: {\n        get() {\n          return context._currentValue2;\n        },\n        set(_currentValue2) {\n          context._currentValue2 = _currentValue2;\n        }\n      },\n      _threadCount: {\n        get() {\n          return context._threadCount;\n        },\n        set(_threadCount) {\n          context._threadCount = _threadCount;\n        }\n      },\n      Consumer: {\n        get() {\n          if (!hasWarnedAboutUsingNestedContextConsumers) {\n            hasWarnedAboutUsingNestedContextConsumers = true;\n            warning(\n              false,\n              \'Rendering <Context.Consumer.Consumer> is not supported and will be removed in \' +\n                \'a future major release. Did you mean to render <Context.Consumer> instead?\'\n            );\n          }\n          return context.Consumer;\n        }\n      }\n    });\n    // \\$FlowFixMe: Flow complains about missing properties because it doesn\'t understand defineProperty\n    context.Consumer = Consumer;\n  } else {\n    context.Consumer = context;\n  }\n  // Provider 与 Consumer 均指向 context，也就是说，Provider 与 Consumer 使用同一个变量 _currentValue，当 Consumer 需要渲染时，直接从自身取得 context 最新值 _currentValue 去渲染\n  if (__DEV__) {\n    context._currentRenderer = null;\n    context._currentRenderer2 = null;\n  }\n\n  return context;\n}`, `66635725631194060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> createContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span>\n  defaultValue<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> <span class="token comment">// context 默认值</span>\n  calculateChangedBits<span class="token punctuation">:</span> <span class="token operator">?</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token constant">T</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> number <span class="token comment">// 计算新老 context 变化函数</span>\n<span class="token punctuation">)</span><span class="token punctuation">:</span> ReactContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>calculateChangedBits <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    calculateChangedBits <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">warningWithoutStack</span><span class="token punctuation">(</span>\n        calculateChangedBits <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> calculateChangedBits <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">,</span>\n        <span class="token string">\'createContext: Expected the optional second argument to be a \'</span> <span class="token operator">+</span> <span class="token string">\'function. Instead received: %s\'</span><span class="token punctuation">,</span>\n        calculateChangedBits\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 声明了一个 context 对象</span>\n  <span class="token keyword">const</span> context<span class="token punctuation">:</span> ReactContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">REACT_CONTEXT_TYPE</span><span class="token punctuation">,</span>\n    _calculateChangedBits<span class="token punctuation">:</span> calculateChangedBits<span class="token punctuation">,</span>\n    <span class="token comment">// As a workaround to support multiple concurrent renderers, we categorize</span>\n    <span class="token comment">// some renderers as primary and others as secondary. We only expect</span>\n    <span class="token comment">// there to be two concurrent renderers at most: React Native (primary) and</span>\n    <span class="token comment">// Fabric (secondary); React DOM (primary) and React ART (secondary).</span>\n    <span class="token comment">// Secondary renderers store their context values on separate fields.</span>\n    _currentValue<span class="token punctuation">:</span> defaultValue<span class="token punctuation">,</span> <span class="token comment">// 用来记录 context 最新值，当 Provider value 更新时，同步到 _currentValue 上</span>\n    _currentValue2<span class="token punctuation">:</span> defaultValue<span class="token punctuation">,</span>\n    <span class="token comment">// Used to track how many concurrent renderers this context currently</span>\n    <span class="token comment">// supports within in a single renderer. Such as parallel server rendering.</span>\n    _threadCount<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    <span class="token comment">// These are circular</span>\n    Provider<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// context Provider</span>\n    Consumer<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">:</span> any<span class="token punctuation">)</span> <span class="token comment">// context Consumer</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  context<span class="token punctuation">.</span>Provider <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// context.Provider 的 _context 为 context</span>\n    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">REACT_PROVIDER_TYPE</span><span class="token punctuation">,</span>\n    _context<span class="token punctuation">:</span> context\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> hasWarnedAboutUsingNestedContextConsumers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> hasWarnedAboutUsingConsumerProvider <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// A separate object, but proxies back to the original context object for</span>\n    <span class="token comment">// backwards compatibility. It has a different $$typeof, so we can properly</span>\n    <span class="token comment">// warn for the incorrect usage of Context as a Consumer.</span>\n    <span class="token keyword">const</span> Consumer <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">//Consumer 的 _context 也为 context</span>\n      $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">REACT_CONTEXT_TYPE</span><span class="token punctuation">,</span>\n      _context<span class="token punctuation">:</span> context<span class="token punctuation">,</span>\n      _calculateChangedBits<span class="token punctuation">:</span> context<span class="token punctuation">.</span>_calculateChangedBits\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token comment">// $FlowFixMe: Flow complains about not setting a value, which is intentional here</span>\n    Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>Consumer<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      Provider<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasWarnedAboutUsingConsumerProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            hasWarnedAboutUsingConsumerProvider <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token function">warning</span><span class="token punctuation">(</span>\n              <span class="token boolean">false</span><span class="token punctuation">,</span>\n              <span class="token string">\'Rendering &lt;Context.Consumer.Provider> is not supported and will be removed in \'</span> <span class="token operator">+</span>\n                <span class="token string">\'a future major release. Did you mean to render &lt;Context.Provider> instead?\'</span>\n            <span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">return</span> context<span class="token punctuation">.</span>Provider<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token keyword">set</span><span class="token punctuation">(</span>_Provider<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          context<span class="token punctuation">.</span>Provider <span class="token operator">=</span> _Provider<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      _currentValue<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> context<span class="token punctuation">.</span>_currentValue<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token keyword">set</span><span class="token punctuation">(</span>_currentValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          context<span class="token punctuation">.</span>_currentValue <span class="token operator">=</span> _currentValue<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      _currentValue2<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> context<span class="token punctuation">.</span>_currentValue2<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token keyword">set</span><span class="token punctuation">(</span>_currentValue2<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          context<span class="token punctuation">.</span>_currentValue2 <span class="token operator">=</span> _currentValue2<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      _threadCount<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span> context<span class="token punctuation">.</span>_threadCount<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token keyword">set</span><span class="token punctuation">(</span>_threadCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          context<span class="token punctuation">.</span>_threadCount <span class="token operator">=</span> _threadCount<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      Consumer<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasWarnedAboutUsingNestedContextConsumers<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            hasWarnedAboutUsingNestedContextConsumers <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n            <span class="token function">warning</span><span class="token punctuation">(</span>\n              <span class="token boolean">false</span><span class="token punctuation">,</span>\n              <span class="token string">\'Rendering &lt;Context.Consumer.Consumer> is not supported and will be removed in \'</span> <span class="token operator">+</span>\n                <span class="token string">\'a future major release. Did you mean to render &lt;Context.Consumer> instead?\'</span>\n            <span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">return</span> context<span class="token punctuation">.</span>Consumer<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// $FlowFixMe: Flow complains about missing properties because it doesn\'t understand defineProperty</span>\n    context<span class="token punctuation">.</span>Consumer <span class="token operator">=</span> Consumer<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    context<span class="token punctuation">.</span>Consumer <span class="token operator">=</span> context<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// Provider 与 Consumer 均指向 context，也就是说，Provider 与 Consumer 使用同一个变量 _currentValue，当 Consumer 需要渲染时，直接从自身取得 context 最新值 _currentValue 去渲染</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    context<span class="token punctuation">.</span>_currentRenderer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    context<span class="token punctuation">.</span>_currentRenderer2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> context<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
id:"/github/workspace/blog/React之createContext入门学习/index.md absPath of file >>> MarkdownRemark",timeToRead:6,frontmatter:{date:"2019-09-22 01:16:10",path:"/react-createContext-practice-learn/",tags:"前端, React, createContext",title:"React之createContext入门学习",draft:null}}],length:131,tag:"前端",pagesSum:27,page:15}}}});
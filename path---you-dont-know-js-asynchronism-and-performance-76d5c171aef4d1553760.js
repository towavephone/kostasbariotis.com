webpackJsonp([0xaca3d108fba4],{1473:function(n,a){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlUlEQVRIx11WaWxU1xWewbQlrdofkSIhGiBpMPZ4Vs/2lpm3zupZPOOZ8Sz2YGzANkaAKaYQUrMkLYgiIlxCQjCYQAwYEoMQNJAIFBxaQgUhoCopYceBJo1pKFVDCbOc0/fesOZKV+fM1Tvf/c56R0VYOZW8lvAxtSybvbExAu1+mndGuaDQ2F4rNHVFhCZJZlMeZ1Qrf9Mt+H+qur/ihFORAFA64J0pVTcXVcDmcKFfruIzZ7rY1H89fAZivjbM1MzFxkAnZqWd9M7KJcTmv7zCN44sY+tflm12C79WLxLCqidWN9cwWpYvsfXL13vasZudgm4mgX4hW6h1teRjnrZCwjOzWO/twIR/FjZ7WnEZ35JvcUSeU4gwSXV7W1sJzEH6R8nSRArlXjr6r7S1DqNUvMAzCXCzSfDxDRAUmyDkaoawtEPi1LxHyGLMkby5gEqUy7atjnq1roosAXqE6Yq7DBXa7RLS6HRG8y4hhbwzDiJbj4IkXUwS5e1h07IOorMePUL6ruiKGmRblg2PesJlq9nxrJMMfydIbhIWP9jMPrBLkrIHgXfG0CdmgKMjwFARFKVvHEQo5xUyKDDRN2T7aE17mV5rfZQYm1lM0EQYWUe0aNTxoKl0Qnk5jVqNA/VaFu3SBS7SB7Ju0ougr2KKWg2DBi17mbCaxyghMzgeMTTp2W7CGkTKHshZqn0Q5Osg6opBhAmAzcADY/NheyQJBi2D8mXVehYMOgEsJg9aTIxSN2YTO+ohQ62G6rGZa5AmAjmj0YvzG5vhVP8f4fTO12FtVxfMjTfC6zPbwOsIQNybhK6GlmLCm5DA6cu2aoeSaaOeVheLxRKgpoJcZ5UAly94MeeiQ+jnQtBCcTBTZ8Ght9fDfy58DDdOHIRj2zdA/4uzYWBpZ6Fr6jR8/lfWP8n2usqA2mQgH7msr3Ks0WgEfGvN6lz/q6tgXqgZjgpZOGSLwsldA4CFG4j3rmP/osU47xkdrm5pLfjdETm+p64cf0fJME34HiVFV+VYajF50UGGc/Nnz4XDfW/ArQ09+M++XsCblwD+fQEL356HswuWwdedS+Dg2p5ilZQwa7VrpCHZ9nOl7Ojg44B0hxxg0hbMjx2rh2iwDk4feReKI58hfn8V8c5lwNyXiF+dRbz4Z1jY1g4TJ1rQbnHfc/ORihJDr5q0kw8AyVqDjpeSEpJLAyaMN6HRwMDuTa/B1fcPwcfbBuHc8SPw+cnDsGvzeim7HOg0DpAYoouPBWUMJxUo65y18X4MtbYJOo3zjgQoxwWen1iNDdPmwPu9+2BvfCXsXbQRehf9Hly0B8aN04OuioGqCipvt/hQ5GLzS4Dh0Tdv3+/nvm0qVVUlfUouboOWK8jxmaznMBXIwpbfroWN63th384tcHTfDpj0gg21lQxoK+m8TQGMb5UxAt6OUYSVkUuGK5MPKiuIHicZwWqDmNNqpE6pIFBjpGDxsqXwuxUroWtBN5w4NgSbNvcDIRW61CUFu9UrtV/si7Fjf/ajUmICSvxKgJMtdQxVK2XOU9RpGNBL3VBeQWIqPR3SjR3QOW8xrFmxCnrWbYJMaobEkr1HE/4zIpv4nrK7NIrbpF+tspoYZdpMLte+wNPRu6S1Bs1GqV/1DOqMPFjIMFbq3dg6cyFkGmagqZqHaoOAHF2XZ6ngWg+XBM4RVoLHOWrLVG4uWpo4FvsvfHz6NktFkbT6QafnQGsUoFLHYm1dFj44cgwYPgQVkymkbP6RWl+LNIRjL/uFhltuNjEoYySCXaNUojOsMPSw4aqwa+o9ga5DggiC1RFDmyMG1bYQVlTSIIhRMJq9RaPZJ4VF+DQZ6MCAmOkLurJ/DYiNt/R67VMKs4hrqjL+o+6mjrj0hjBEOG+1h8FOxcFO1oHVFgazPYQGqdfNthBYpUqwEME78nsT4tP7o96WwWSwA1nKb35iyCZ8M85EXE3oYBO3ab4RKWcSKCaFJJMCQprSpPQcUFwKzWQUKo1+lC9x0r7Fcc+0OVOj8zEkNrY8BAuLDV11ruZvDXrhuJ3NIu+bAYK/FXjfdOA8zegUp6DdmQKNMQD+8HTseW1LYeijE/jB4Q+/Wry8a5L01B6MeaetUcDSjfVjjOVM7da+bTMPvHfkbmrKb5DksjkLncmZqXTe6siAnWmAmkhbYUPvQP7cufO5L69fxyvD/8Ctb+/aI2PU8AmvRGqZAoiIityzb8/T165d3X3t2vD/Pjr+KW7b+R6u2/AOrli9CQfePYQXLg3jpSvDeOLkWTxw6Oh3uwYPrJTMlNHlFcLPeNk6/UOXZ7cuGP1A397fP/7v584vvzJ8o+dvn33+Zm/v9q9X/2EDbN+19+ybm3ds33/ww5f63uovf/D9woVL1A90P5dQqYaGhpQfg4N71BJbteoHqyk7Z+e8zlfuSupPHj+/eO2bso5ZcxQ9Fsiqgny6ZOv3+VTfjIwo+iefnFYN7BxQf3FxuEwGH1c+fgxBuIZnTFuIIh9U2qt3844fb9y0Vf0gXPKm7bzKzYZ+wGTKFFWNz1/6v8OLUiuaFKMJz00yEvaa/RQZnK086s6MutpEqRLx+kcT+rH1f+YikeeNfqnwAAAAAElFTkSuQmCC",aspectRatio:.6666666666666666,src:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png",srcSet:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-8a97b.png 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-0fdf3.png 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-25c91.png 600w",srcWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp",srcSetWebp:"/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-5d70e.webp 200w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-d1677.webp 400w,\n/static/avatar-a4ccbab8e7381acb89452773ce94d5a0-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="异步：现在与将来"><a href="#%E5%BC%82%E6%AD%A5%EF%BC%9A%E7%8E%B0%E5%9C%A8%E4%B8%8E%E5%B0%86%E6%9D%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步：现在与将来</h1>\n<h2 id="分块的程序"><a href="#%E5%88%86%E5%9D%97%E7%9A%84%E7%A8%8B%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分块的程序</h2>\n<ul>\n<li>程序是由多个块组成，只有一个是现在执行，其余的则会在将来执行，最常见的块单位是函数</li>\n<li>程序中将来执行的部分并不一定在现在运行的部分执行完后就立即执行，也就是现在无法完成的任务将会异步完成</li>\n<li>从现在到将来的等待最简单的方法是使用一个通常称为回调函数的函数</li>\n<li>可以同步发送 ajax 请求，但是建议在任何情况都不应该使用这种方式，因为它会被锁定器 UI（按钮、菜单、滚动条等），并阻塞所有用户交互</li>\n</ul>\n<p>考虑以下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25200805802195280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function now() {\n  return 21;\n}\nfunction later() {\n  answer = answer * 2;\n  console.log(\'Meaning of life:\', answer);\n}\nvar answer = now();\nsetTimeout(later, 1000);`, `25200805802195280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token number">21</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">later</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  answer <span class="token operator">=</span> answer <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Meaning of life:\'</span><span class="token punctuation">,</span> answer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> answer <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span>later<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上代码可以拆分现在和将来部分：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14481950815783428000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 现在\nfunction now() {\n  return 21;\n}\nfunction later() {\n  /*...*/\n}\nvar answer = now();\nsetTimeout(later, 1000);`, `14481950815783428000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 现在</span>\n<span class="token keyword">function</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token number">21</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">later</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">/*...*/</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> answer <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span>later<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92859469832655630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 将来\nanswer = answer * 2;\nconsole.log(\'Meaning of life:\', answer);`, `92859469832655630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 将来</span>\nanswer <span class="token operator">=</span> answer <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Meaning of life:\'</span><span class="token punctuation">,</span> answer<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="异步控制台"><a href="#%E5%BC%82%E6%AD%A5%E6%8E%A7%E5%88%B6%E5%8F%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步控制台</h3>\n<ul>\n<li>宿主环境添加到 js 中的，在某些条件下某些浏览器的 console.log(…) 并不会把传入的内容立即输出</li>\n<li>出现以上情况的原因是，在许多程序中，I/O 是非常低速阻塞部分，所以浏览器在后台异步处理控制台 I/O 能够提高性能</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60935268532781910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a = {\n  index: 1\n};\nconsole.log(a); //可能为 2，由 I/O 异步化造成\na.index++;`, `60935268532781910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>\n  index<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//可能为 2，由 I/O 异步化造成</span>\na<span class="token punctuation">.</span>index<span class="token operator">++</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="解决方法"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方法</h4>\n<ul>\n<li>在控制台中使用断点</li>\n<li>把对象序列化到一个字符串中，以强制指向一次快照，比如通过 JSON.stringify()</li>\n</ul>\n<h2 id="事件循环"><a href="#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事件循环</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96538903245896700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`//eventLoop 是一个用作队列的数组\nvar eventLoop = [];\nvar event;\nwhile (true) {\n  // 一次 tick\n  if (eventLoop.length > 0) {\n    // 拿到队列中的下一个事件\n    event = eventLoop.shift();\n    try {\n      // 执行下一个事件\n      event();\n    } catch (err) {\n      reportError(err);\n    }\n  }\n}`, `96538903245896700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">//eventLoop 是一个用作队列的数组</span>\n<span class="token keyword">var</span> eventLoop <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> event<span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 一次 tick</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 拿到队列中的下一个事件</span>\n    event <span class="token operator">=</span> eventLoop<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 执行下一个事件</span>\n      <span class="token function">event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">reportError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>事件循环理解：有一个 while 循环实现的持续运行的循环，循环的每一轮称为一个 tick。对每个 tick 而言，如果在队列中有等待事件，那么就会在队列中摘下一个事件并执行，这些事件就是你的回调函数</p>\n<p>setTimeout 并没有把你的回调函数挂在事件循环队列中，它所作的是设定一个定时器，当定时器到时后，环境会把你的回调函数放在事件循环中，这样在未来的某个时刻 tick 会摘下并执行这个回调</p>\n<p>回调函数不会再指定的时间间隔之前执行，很可能会在那个时刻运行，也有可能在那之后运行，要根据事件队列的状态来决定</p>\n<h2 id="并行线程"><a href="#%E5%B9%B6%E8%A1%8C%E7%BA%BF%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并行线程</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12010422169223123000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a = 20;\nfunction foo() {\n  a = a + 1;\n}\nfunction bar() {\n  a = a * 2;\n}\najax(\'http://some.url.1\', foo);\najax(\'http://some.url.2\', bar);`, `12010422169223123000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  a <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>根据 js 单线程运行特性，如果 foo() 运行在 bar() 之前，a 的结果是 42，而如果 bar() 运行在 foo() 之前，a 的结果是 41。</p>\n<p>如果共享同一数据的 js 事件并行执行的话，那么问题会变得非常复杂</p>\n<p>例如线程 a（X 和 Y 是临时内存地址）</p>\n<p>foo():</p>\n<ol>\n<li>把 a 的值加载到 X</li>\n<li>把 1 保存在 Y</li>\n<li>执行 X 加 Y，结果保存在 X</li>\n<li>把 X 的值保存在 a</li>\n</ol>\n<p>线程 b（X 和 Y 是临时内存地址）</p>\n<p>bar():</p>\n<ol>\n<li>把 a 的值加载到 X</li>\n<li>把 2 保存在 Y</li>\n<li>执行 X 乘 Y，结果保存在 X</li>\n<li>把 X 的值保存在 a</li>\n</ol>\n<p>假如按照以下步骤执行</p>\n<table>\n<thead>\n<tr>\n<th align="center">步骤</th>\n<th align="center">执行方法</th>\n<th align="center">结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">1</td>\n<td align="center">a1</td>\n<td align="center">20</td>\n</tr>\n<tr>\n<td align="center">2</td>\n<td align="center">b1</td>\n<td align="center">20</td>\n</tr>\n<tr>\n<td align="center">3</td>\n<td align="center">a2</td>\n<td align="center">1</td>\n</tr>\n<tr>\n<td align="center">4</td>\n<td align="center">b2</td>\n<td align="center">2</td>\n</tr>\n<tr>\n<td align="center">5</td>\n<td align="center">a3</td>\n<td align="center">22</td>\n</tr>\n<tr>\n<td align="center">6</td>\n<td align="center">a4</td>\n<td align="center">22</td>\n</tr>\n<tr>\n<td align="center">7</td>\n<td align="center">b3</td>\n<td align="center">44</td>\n</tr>\n<tr>\n<td align="center">8</td>\n<td align="center">b4</td>\n<td align="center">44</td>\n</tr>\n</tbody>\n</table>\n<p>按另一种方式运行：</p>\n<table>\n<thead>\n<tr>\n<th align="center">步骤</th>\n<th align="center">执行方法</th>\n<th align="center">结果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">1</td>\n<td align="center">a1</td>\n<td align="center">20</td>\n</tr>\n<tr>\n<td align="center">2</td>\n<td align="center">b1</td>\n<td align="center">20</td>\n</tr>\n<tr>\n<td align="center">3</td>\n<td align="center">b2</td>\n<td align="center">2</td>\n</tr>\n<tr>\n<td align="center">4</td>\n<td align="center">a2</td>\n<td align="center">1</td>\n</tr>\n<tr>\n<td align="center">5</td>\n<td align="center">b3</td>\n<td align="center">20</td>\n</tr>\n<tr>\n<td align="center">6</td>\n<td align="center">a3</td>\n<td align="center">21</td>\n</tr>\n<tr>\n<td align="center">7</td>\n<td align="center">a4</td>\n<td align="center">21</td>\n</tr>\n<tr>\n<td align="center">8</td>\n<td align="center">b4</td>\n<td align="center">21</td>\n</tr>\n</tbody>\n</table>\n<p>所以多线程是非常复杂的，如果不通过特殊的步骤来防止中断和交错运行，可能会得到不确定的行为</p>\n<p>js 从不跨线程共享数据，但并不保证 js 总是确定性的，foo 和 bar 的相对顺序的改变可能会导致不同的结果</p>\n<h3 id="完整运行"><a href="#%E5%AE%8C%E6%95%B4%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>完整运行</h3>\n<p>由于 js 单线程特性，foo 以及 bar 中的代码具有原子性，也就是说一旦 foo 开始运行，它的所有代码都会在 bar 中的任意代码运行之前完成，或者相反，这称为完整运行特性</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35505876734644515000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a = 1;\nvar b = 2;\nfunction foo() {\n  a++;\n  b = b * a;\n  a = b + 3;\n}\nfunction bar() {\n  b--;\n  a = 8 + b;\n  b = a * 2;\n}\najax(\'http://some.url.1\', foo);\najax(\'http://some.url.2\', bar);`, `35505876734644515000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  a<span class="token operator">++</span><span class="token punctuation">;</span>\n  b <span class="token operator">=</span> b <span class="token operator">*</span> a<span class="token punctuation">;</span>\n  a <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  b<span class="token operator">--</span><span class="token punctuation">;</span>\n  a <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">+</span> b<span class="token punctuation">;</span>\n  b <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>会被解析为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63732927049384310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`//块 1\nvar a = 1;\nvar b = 2;\n//块 2\na++;\nb = b * a;\na = b + 3;\n//块 3\nb--;\na = 8 + b;\nb = a * 2;`, `63732927049384310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">//块 1</span>\n<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token comment">//块 2</span>\na<span class="token operator">++</span><span class="token punctuation">;</span>\nb <span class="token operator">=</span> b <span class="token operator">*</span> a<span class="token punctuation">;</span>\na <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>\n<span class="token comment">//块 3</span>\nb<span class="token operator">--</span><span class="token punctuation">;</span>\na <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">+</span> b<span class="token punctuation">;</span>\nb <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>块 2 和块 3 哪个都有可能先运行，所以有两种输出，是函数顺序级别的不确定，而不是多线程下语句的顺序级别</p>\n<p>在 js 的特性中，这种函数顺序的不确定性就是通常所说的竞态条件，foo 和 bar 相互竞争，看谁先运行</p>\n<h2 id="并发"><a href="#%E5%B9%B6%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并发</h2>\n<p>单线程事件循环是并发的一种形式</p>\n<h3 id="非交互"><a href="#%E9%9D%9E%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>非交互</h3>\n<p>如果进程间没有相互影响的话，不确定性是完全可以接受的，如以下代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46679661516669560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var res = {};\nfunction foo(results) {\n  res.foo = results;\n}\nfunction bar(result) {\n  res.bar = results;\n}\najax(\'http://some.url.1\', foo);\najax(\'http://some.url.2\', bar);`, `46679661516669560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  res<span class="token punctuation">.</span>foo <span class="token operator">=</span> results<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  res<span class="token punctuation">.</span>bar <span class="token operator">=</span> results<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不管如何执行，结果一样，这就是非交互</p>\n<h3 id="交互"><a href="#%E4%BA%A4%E4%BA%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>交互</h3>\n<p>更常见的情况是，并发的进程需要交流，通过作用域或 DOM 间接交互，正如前面介绍的，如果出现这样的交互，就需要对他们的交互进行协调以避免竞态的出现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56672338711266710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var res = {};\nfunction response(data) {\n  res.push(data);\n}\najax(\'http://some.url.1\', response);\najax(\'http://some.url.2\', response);`, `56672338711266710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不同的调用顺序会导致数组顺序的不同，这种不确定性很有可能就是竞态条件的 bug</p>\n<p>需要协调交互顺序来处理竞态条件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37193956991659520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var res = [];\nfunction response(data) {\n  if (data.url == \'http://some.url.1\') {\n    res[0] = data;\n  } else {\n    res[1] = data;\n  }\n}\najax(\'http://some.url.1\', response);\najax(\'http://some.url.2\', response);`, `37193956991659520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>url <span class="token operator">==</span> <span class="token string">\'http://some.url.1\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有些并发场景不做协调，就总是出错，考虑</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39481128546511000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a, b;\nfunction foo(x) {\n  a = x * 2;\n  baz();\n}\nfunction bar(y) {\n  b = y * 2;\n  baz();\n}\nfunction baz() {\n  console.log(a + b);\n}\najax(\'http://some.url.1\', foo);\najax(\'http://some.url.2\', bar);`, `39481128546511000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  a <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  b <span class="token operator">=</span> y <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这个例子中，无论 bar 与 foo 哪一个先触发，总会使 baz 过早运行（a 或者 b 处于未定义状态）；但对 baz 的第二次调用就没有问题，因为这时候 a,b 都已经可用了</p>\n<p>解决方法如下</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26811263580860390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a, b;\nfunction foo(x) {\n  a = x * 2;\n  if (a && b) {\n    baz();\n  }\n}\nfunction bar(y) {\n  b = y * 2;\n  if (a && b) {\n    baz();\n  }\n}\nfunction baz() {\n  console.log(a + b);\n}\najax(\'http://some.url.1\', foo);\najax(\'http://some.url.2\', bar);`, `26811263580860390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  a <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  b <span class="token operator">=</span> y <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另一种可能遇到的并发交互条件有时称为竞态 (race)，但更精确的叫法是门闩 (latch)，它的特性可以描述为只有第一名取胜，不确定性是可以接受的</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33858425496300003000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a;\nfunction foo(x) {\n  a = x * 2;\n  baz();\n}\nfunction bar(x) {\n  a = x / 2;\n  baz();\n}\nfunction baz() {\n  console.log(a);\n}\najax(\'http://some.url.1\', foo);\najax(\'http://some.url.2\', bar);`, `33858425496300003000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a<span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  a <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  a <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不管哪一个先触发，都会覆盖另外一个给 a 赋的值，也会重复调用 baz</p>\n<p>可以通过一个简单的门闩协调这个过程，只让第一个通过</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87205777887758140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a;\nfunction foo(x) {\n  if (!a) {\n    a = x * 2;\n    baz();\n  }\n}\nfunction bar(x) {\n  if (!a) {\n    a = x / 2;\n    baz();\n  }\n}\nfunction baz() {\n  console.log(a);\n}\najax(\'http://some.url.1\', foo);\najax(\'http://some.url.2\', bar);`, `87205777887758140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a<span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    a <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    a <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上例子只会让第一个运行的通过</p>\n<h3 id="协作"><a href="#%E5%8D%8F%E4%BD%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>协作</h3>\n<p>并发协作：取到一个长期运行的进程，并将其分割成多个步骤或多批任务，使得其他并发进程有机会将自己的运算插入到事件循环队列中交替运行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80546525007425080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var res=[];\nfunction response(data){\n    res=res.concat(data.map(function(val){\n        return val*2;\n    })\n}\najax(&quot;http://some.url.1&quot;,response);\najax(&quot;http://some.url.2&quot;,response);`, `80546525007425080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> res<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n    res<span class="token operator">=</span>res<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token keyword">return</span> val<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">"http://some.url.1"</span><span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">"http://some.url.2"</span><span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设 ajax 请求的数据规模达到上千万，那么就会阻塞 UI 事件的运行，所以需要创建一个协作性更强且不会阻塞事件循环队列的并发系统，可以分批处理这些结果，每次处理后返回事件循环，让其他等待事件有机会运行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82354111796866430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var res = [];\nfunction response(data) {\n  var chunk = data.splice(0, 1000);\n  res = res.concat(\n    chunk.map(function(val) {\n      return val * 2;\n    })\n  );\n  if (data.length > 0) {\n    //异步调度下一次批处理\n    setTimeout(function() {\n      response(data);\n    }, 0);\n  }\n}\najax(\'http://some.url.1\', response);\najax(\'http://some.url.2\', response);`, `82354111796866430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> chunk <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  res <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>\n    chunk<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> val <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">//异步调度下一次批处理</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">response</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每次只处理 1000 条数据，确保运行时间会很短，即使这意味着更多的后续进程，因为事件循环队列的交替运行会提高响应</p>\n<p>当然这些结果的顺序是不可预测的，使用 setTimeout 进行异步调度，其意义在于把这个函数插入到当前事件循环队列的结尾处</p>\n<h2 id="任务"><a href="#%E4%BB%BB%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>任务</h2>\n<p>在 ES6 中，promise 的异步建立在事件循环队列之上，叫做任务队列</p>\n<p>它是挂在事件循环队列的每个 tick 之后的一个队列，任务循环可能无限循环，进而导致程序卡死，无法转移到下一个事件循环 tick</p>\n<p>设想一个调度任务的 API，称之为 schedule，考虑</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5562223052312798000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`console.log(\'A\');\nsetTimeout(function() {\n  console.log(\'B\');\n}, 0);\nschedule(function() {\n  console.log(\'C\');\n  schedule(function() {\n    console.log(\'D\');\n  });\n});`, `5562223052312798000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'B\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'C\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'D\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际打印的结果是 ACDB，因为任务处理是在当前事件循环 tick 结尾处，且定时器触发是为了调度下一个事件循环 tick（如果可用的话）</p>\n<h2 id="语句顺序"><a href="#%E8%AF%AD%E5%8F%A5%E9%A1%BA%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语句顺序</h2>\n<p>代码中语句的顺序和 js 引擎执行语句的顺序并不一定要一致</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41521620027659600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a, b;\na = 10;\nb = 30;\na = a + 1;\nb = b + 1;\nconsole.log(a + b); //42`, `41521620027659600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>\na <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\nb <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\na <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\nb <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//42</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>js 引擎会这样优化以提高执行速度</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17196420597923480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a, b;\na = 11;\nb = 31;\nconsole.log(42);`, `17196420597923480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>\na <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>\nb <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60566138058329330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`console.log(42);`, `60566138058329330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>但是有一种场景其中特定的优化是不安全的，因此也是不允许的</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1727169209332601900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var a, b;\na = 10;\nb = 30;\n// 我们需要 a 和 b 处于递增之前的状态\nconsole.log(a * b);\na = a + 1;\nb = b + 1;\nconsole.log(a + b);`, `1727169209332601900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>\na <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\nb <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\n<span class="token comment">// 我们需要 a 和 b 处于递增之前的状态</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">*</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>\na <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\nb <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有其他一些例子，其中编译器排序会产生可见的副作用（因此必须禁止），比如会产生副作用的函数调用或 ES6 代理对象</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46474503359701530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function foo() {\n  console.log(b);\n  return 1;\n}\nvar a, b, c;\n// ES5.1 getter 字面量语法\nc = {\n  get bar() {\n    console.log(a);\n    return 1;\n  }\n};\na = 10;\nb = 30;\na += foo(); //30\nb += c.bar; //11\nconsole.log(a + b); //42`, `46474503359701530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">;</span>\n<span class="token comment">// ES5.1 getter 字面量语法</span>\nc <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token keyword">get</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\na <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\nb <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>\na <span class="token operator">+=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//30</span>\nb <span class="token operator">+=</span> c<span class="token punctuation">.</span>bar<span class="token punctuation">;</span> <span class="token comment">//11</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//42</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果不是代码片段中的语句 console.log，js 引擎如果愿意的话，本来可以自由的把代码重新排序</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42854284520842900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`//...\na = 10 + foo();\nb = 30 + c.bar;\n//...`, `42854284520842900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">//...</span>\na <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nb <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">+</span> c<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>\n<span class="token comment">//...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编译器语句的重排序几乎就是并发和交互的微型隐喻，作为一个一般性的概念，理解后有助于理清异步 js 的代码流问题</p>\n<h1 id="回调"><a href="#%E5%9B%9E%E8%B0%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回调</h1>\n<h2 id="continuation"><a href="#continuation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>continuation</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74010309101223920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// A\najax( &quot;..&quot;, function(..){\n// C\n} );\n// B`, `74010309101223920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// A</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">.</span><span class="token punctuation">.</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n<span class="token comment">// C</span>\n<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// B</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>// A 和 // B 表示程序的前半部分（也就是现在的部分），而 // C 标识了程序的后半部分（也就是将来的部分）。前半部分立刻执行，然后是一段时间不确定的停顿。在未来的某个时刻，如果 Ajax 调用完成，程序就会从停下的位置继续执行后半部分。</p>\n<h3 id="嵌套回调与链式回调"><a href="#%E5%B5%8C%E5%A5%97%E5%9B%9E%E8%B0%83%E4%B8%8E%E9%93%BE%E5%BC%8F%E5%9B%9E%E8%B0%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>嵌套回调与链式回调</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51295444759025074000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`listen(\'click\', function handler(evt) {\n  setTimeout(function request() {\n    ajax(\'http://some.url.1\', function response(text) {\n      if (text == \'hello\') {\n        handler();\n      } else if (text == \'world\') {\n        request();\n      }\n    });\n  }, 500);\n});`, `51295444759025074000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">==</span> <span class="token string">\'hello\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">==</span> <span class="token string">\'world\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种代码常常被称为回调地狱（callback hell），有时也被称为毁灭金字塔</p>\n<p>一开始我们在等待 click 事件，然后等待定时器启动，然后等待 Ajax 响应返回，之后可能再重头开始。</p>\n<p>一眼看去，这段代码似乎很自然地将其异步性映射到了顺序大脑计划。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49073591551471575000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`doA(function() {\n  doB();\n  doC(function() {\n    doD();\n  });\n  doE();\n});\ndoF();`, `49073591551471575000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">doA</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">doB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">doC</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">doD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">doE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">doF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际运行顺序：doA()、doF()、doB()、doC()、doE()、doD()</p>\n<p>我们的顺序阻塞式的大脑计划行为无法很好地映射到面向回调的异步代码，这就是回调方式最主要的缺陷</p>\n<h2 id="信任问题"><a href="#%E4%BF%A1%E4%BB%BB%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>信任问题</h2>\n<p>顺序的人脑计划和回调驱动的异步 JavaScript 代码之间的不匹配只是回调问题的一部分。还有一些更深入的问题需要考虑</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84903766420093570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// A\najax( &quot;..&quot;, function(..){\n// C\n} );\n// B`, `84903766420093570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// A</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">.</span><span class="token punctuation">.</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n<span class="token comment">// C</span>\n<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// B</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有时候 ajax(..) （也就是你交付回调 continuation 的第三方）不是你编写的代码，也不在你的直接控制下。多数情况下，它是某个第三方提供的工具</p>\n<p>我们把这称为控制反转（inversion of control），也就是把自己程序一部分的执行控制交给某个第三方。在你的代码和第三方工具（一组你希望有人维护的东西）之间有一份并没有明确表达的契约</p>\n<h3 id="五个回调的故事"><a href="#%E4%BA%94%E4%B8%AA%E5%9B%9E%E8%B0%83%E7%9A%84%E6%95%85%E4%BA%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>五个回调的故事</h3>\n<p>假设你是一名开发人员，为某个销售昂贵电视的网站建立商务结账系统。你已经做好了结账系统的各个界面。在最后一页，当用户点击“确定”就可以购买电视时，你需要调用（假设由某个分析追踪公司提供的）第三方函数以便跟踪这个交易。</p>\n<p>代码可能是这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49372722820061460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`analytics.trackPurchase(purchaseData, function() {\n  chargeCreditCard();\n  displayThankyouPage();\n});`, `49372722820061460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">analytics<span class="token punctuation">.</span><span class="token function">trackPurchase</span><span class="token punctuation">(</span>purchaseData<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">chargeCreditCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">displayThankyouPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>唯一的解释就是那个分析工具出于某种原因把你的回调调用了五次而不是一次。他们的文档中完全没有提到这种情况</p>\n<p>经过修补之后，你实现了像下面这样的简单临时代码，大家似乎也很满意：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95595022475869490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var tracked = false;\nanalytics.trackPurchase(purchaseData, function() {\n  if (!tracked) {\n    tracked = true;\n    chargeCreditCard();\n    displayThankyouPage();\n  }\n});`, `95595022475869490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> tracked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\nanalytics<span class="token punctuation">.</span><span class="token function">trackPurchase</span><span class="token punctuation">(</span>purchaseData<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tracked<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    tracked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token function">chargeCreditCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">displayThankyouPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，后来有一个 QA 工程师问道：“如果他们根本不调用这个回调怎么办？”哎呦！之前你们双方都没有想到这一点。</p>\n<p>然后，你开始沿着这个兔子洞深挖下去，考虑着他们调用你的回调时所有可能的出错情况。这里粗略列出了你能想到的分析工具可能出错的情况：</p>\n<ul>\n<li>调用回调过早（在追踪之前）；</li>\n<li>调用回调过晚（或没有调用）；</li>\n<li>调用回调的次数太少或太多（就像你遇到过的问题！）；</li>\n<li>没有把所需的环境 / 参数成功传给你的回调函数；</li>\n<li>吞掉可能出现的错误或异常；</li>\n</ul>\n<p>这感觉就像是一个麻烦列表，实际上它就是。你可能已经开始慢慢意识到，对于被传给你无法信任的工具的每个回调，你都将不得不创建大量的混乱逻辑。</p>\n<h3 id="不只是别人的代码"><a href="#%E4%B8%8D%E5%8F%AA%E6%98%AF%E5%88%AB%E4%BA%BA%E7%9A%84%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不只是别人的代码</h3>\n<p>回调并没有为我们提供任何东西来支持类型的检查 / 规范化。我们不得不自己构建全部的机制，而且通常为每个异步回调重复这样的工作最后都成了负担。</p>\n<p>回调最大的问题是控制反转，它会导致信任链的完全断裂。</p>\n<p>如果你的代码中使用了回调，尤其是但也不限于使用第三方工具，而且你还没有应用某种逻辑来解决所有这些控制反转导致的信任问题，那你的代码现在已经有了 bug，即使它们还没有给你造成损害，隐藏的 bug 也是 bug。</p>\n<h2 id="省点回调"><a href="#%E7%9C%81%E7%82%B9%E5%9B%9E%E8%B0%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>省点回调</h2>\n<p>回调设计存在几个变体，意在解决前面讨论的一些信任问题（不是全部！）。这种试图从回调模式内部挽救它的意图是勇敢的，但却注定要失败。</p>\n<p>举例来说，为了更优雅地处理错误，有些 API 设计提供了分离回调（一个用于成功通知，一个用于出错通知）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5159870993373251000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function success(data) {\n  console.log(data);\n}\nfunction failure(err) {\n  console.error(err);\n}\najax(\'http://some.url.1\', success, failure);`, `5159870993373251000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> success<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这种设计下，API 的出错处理函数 failure() 常常是可选的，如果没有提供的话，就是假定这个错误可以吞掉。</p>\n<p>还有一种常见的回调模式叫作“error-first 风格”（有时候也称为“Node 风格”，因为几乎所有 Node.js API 都采用这种风格），其中回调的第一个参数保留用作错误对象（如果有的话）。如果成功的话，这个参数就会被清空 / 置假（后续的参数就是成功数据）。不过，如果产生了错误结果，那么第一个参数就会被置起 / 置真（通常就不会再传递其他结果）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6405960538836775000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function response(err, data) {\n  // 出错？\n  if (err) {\n    console.error(err);\n  }\n  // 否则认为成功\n  else {\n    console.log(data);\n  }\n}\najax(\'http://some.url.1\', response);`, `6405960538836775000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 出错？</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 否则认为成功</span>\n  <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这两种情况下，都应该注意到以下几点。</p>\n<p>这并没有像表面看上去那样真正解决主要的信任问题。这并没有涉及阻止或过滤不想要的重复调用回调的问题，因为现在你可能同时得到成功或者失败的结果，或者都没有，并且你还是不得不编码处理所有这些情况</p>\n<p>那么完全不调用这个信任问题又会怎样呢？如果这是个问题的话（可能应该是个问题！），你可能需要设置一个超时来取消事件。可以构造一个工具（这里展示的只是一个“验证概念”版本）来帮助实现这一点</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96701871135901450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function timeoutify(fn, delay) {\n  var intv = setTimeout(function() {\n    intv = null;\n    fn(new Error(\'Timeout!\'));\n  }, delay);\n\n  return function() {\n    // 还没有超时？\n    if (intv) {\n      clearTimeout(intv);\n      fn.apply(this, arguments);\n    }\n  };\n}`, `96701871135901450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">timeoutify</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> intv <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    intv <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Timeout!\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 还没有超时？</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>intv<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>intv<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以下是使用方式：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26485152254755918000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 使用&quot;error-first 风格&quot; 回调设计\nfunction foo(err, data) {\n  if (err) {\n    console.error(err);\n  } else {\n    console.log(data);\n  }\n}\najax(\'http://some.url.1\', timeoutify(foo, 500));`, `26485152254755918000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 使用"error-first 风格" 回调设计</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> <span class="token function">timeoutify</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一个信任问题是调用过早。在特定应用的术语中，这可能实际上是指在某个关键任务完成之前调用回调。但是更通用地来说，对于既可能在现在（同步）也可能在将来（异步）调用你的回调的工具来说，这个问题是明显的。</p>\n<p>这种由同步或异步行为引起的不确定性几乎总会带来极大的 bug 追踪难度</p>\n<p>这也引出了一条非常有效的建议：永远异步调用回调，即使就在事件循环的下一轮，这样，所有回调就都是可预测的异步调用了</p>\n<p>考虑：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41171413238063860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function result(data) {\n  console.log(a);\n}\nvar a = 0;\najax(\'..pre-cached-url..\', result);\na++;`, `41171413238063860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'..pre-cached-url..\'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\na<span class="token operator">++</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段代码会打印出 0 （同步回调调用）还是 1 （异步回调调用）呢？这要视情况而定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69075449609808180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function asyncify(fn) {\n  var orig_fn = fn,\n    intv = setTimeout(function() {\n      intv = null;\n      if (fn) fn();\n    }, 0);\n  fn = null;\n  return function() {\n    // 触发太快，在定时器 intv 触发指示异步转换发生之前？\n    if (intv) {\n      fn = orig_fn.bind.apply(\n        orig_fn,\n        // 把封装器的 this 添加到 bind(..) 调用的参数中，\n        // 以及克里化（currying）所有传入参数\n        [this].concat([].slice.call(arguments))\n      );\n    }\n    // 已经是异步\n    else {\n      // 调用原来的函数\n      orig_fn.apply(this, arguments);\n    }\n  };\n}`, `69075449609808180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">asyncify</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> orig_fn <span class="token operator">=</span> fn<span class="token punctuation">,</span>\n    intv <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      intv <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  fn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 触发太快，在定时器 intv 触发指示异步转换发生之前？</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>intv<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      fn <span class="token operator">=</span> orig_fn<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>\n        orig_fn<span class="token punctuation">,</span>\n        <span class="token comment">// 把封装器的 this 添加到 bind(..) 调用的参数中，</span>\n        <span class="token comment">// 以及克里化（currying）所有传入参数</span>\n        <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// 已经是异步</span>\n    <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 调用原来的函数</span>\n      <span class="token function">orig_fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以像这样使用 asyncify(..) ：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31512963244646896000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function result(data) {\n  console.log(a);\n}\nvar a = 0;\najax(\'..pre-cached-url..\', asyncify(result));\na++;`, `31512963244646896000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">\'..pre-cached-url..\'</span><span class="token punctuation">,</span> <span class="token function">asyncify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\na<span class="token operator">++</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>不管这个 Ajax 请求已经在缓存中并试图对回调立即调用，还是要从网络上取得，进而在将来异步完成，这段代码总是会输出 1 ，而不是 0 —— result(..) 只能异步调用，这意味着 a++ 有机会在 result(..) 之前运行。</p>\n<p>可能现在你希望有内建的 API 或其他语言机制来解决这些问题。最终，ES6 带着一些极好的答案登场了，所以，继续读下去吧！</p>\n<h1 id="promise"><a href="#promise" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise</h1>\n<h2 id="什么是-promise"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-promise" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是 Promise</h2>\n<p>事实证明，只了解 API 会丢失很多抽象的细节。Promise 属于这样一类工具：通过某人使用它的方式，很容易分辨他是真正理解了这门技术，还是仅仅学习和使用 API 而已</p>\n<h3 id="未来值"><a href="#%E6%9C%AA%E6%9D%A5%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>未来值</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46836075237282220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function add(getX, getY, cb) {\n  var x, y;\n  getX(function(xVal) {\n    x = xVal;\n    // 两个都准备好了？\n    if (y != undefined) {\n      cb(x + y); // 发送和\n    }\n  });\n  getY(function(yVal) {\n    y = yVal;\n    // 两个都准备好了？\n    if (x != undefined) {\n      cb(x + y); // 发送和\n    }\n  });\n}\n\n// fetchX() 和 fetchY() 是同步或者异步函数\nadd(fetchX, fetchY, function(sum) {\n  console.log(sum); // 是不是很容易？\n});`, `46836075237282220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">getX<span class="token punctuation">,</span> getY<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>\n  <span class="token function">getX</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">xVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    x <span class="token operator">=</span> xVal<span class="token punctuation">;</span>\n    <span class="token comment">// 两个都准备好了？</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">cb</span><span class="token punctuation">(</span>x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送和</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">getY</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">yVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    y <span class="token operator">=</span> yVal<span class="token punctuation">;</span>\n    <span class="token comment">// 两个都准备好了？</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">cb</span><span class="token punctuation">(</span>x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送和</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// fetchX() 和 fetchY() 是同步或者异步函数</span>\n<span class="token function">add</span><span class="token punctuation">(</span>fetchX<span class="token punctuation">,</span> fetchY<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 是不是很容易？</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这段代码中，我们把 x 和 y 当作未来值，并且表达了一个运算 add(..) 。这个运算（从外部看）不在意 x 和 y 现在是否都已经可用。换句话说，它把现在和将来归一化了，因此我们可以确保这个 add(..) 运算的输出是可预测的</p>\n<p>为了统一处理现在和将来，我们把它们都变成了将来，即所有的操作都成了异步的</p>\n<p>通过 Promise 函数表达这个 x + y 的例子</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69484940178094810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function add(xPromise, yPromise) {\n  // Promise.all([ .. ]) 接受一个 promise 数组并返回一个新的 promise，\n  // 这个新 promise 等待数组中的所有 promise 完成\n  return (\n    Promise.all([xPromise, yPromise])\n      // 这个 promise 决议之后，我们取得收到的 X 和 Y 值并加在一起\n      .then(function(values) {\n        // values 是来自于之前决议的 promise 的消息数组\n        return values[0] + values[1];\n      })\n  );\n}\n// fetchX() 和 fetchY() 返回相应值的 promise，可能已经就绪，\n// 也可能以后就绪\nadd(fetchX(), fetchY())\n  // 我们得到一个这两个数组的和的 promise\n  // 现在链式调用 then(..) 来等待返回 promise 的决议\n  .then(function(sum) {\n    console.log(sum); // 这更简单！\n  });`, `69484940178094810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">xPromise<span class="token punctuation">,</span> yPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Promise.all([ .. ]) 接受一个 promise 数组并返回一个新的 promise，</span>\n  <span class="token comment">// 这个新 promise 等待数组中的所有 promise 完成</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>xPromise<span class="token punctuation">,</span> yPromise<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token comment">// 这个 promise 决议之后，我们取得收到的 X 和 Y 值并加在一起</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// values 是来自于之前决议的 promise 的消息数组</span>\n        <span class="token keyword">return</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// fetchX() 和 fetchY() 返回相应值的 promise，可能已经就绪，</span>\n<span class="token comment">// 也可能以后就绪</span>\n<span class="token function">add</span><span class="token punctuation">(</span><span class="token function">fetchX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fetchY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token comment">// 我们得到一个这两个数组的和的 promise</span>\n  <span class="token comment">// 现在链式调用 then(..) 来等待返回 promise 的决议</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这更简单！</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>fetchX() 和 fetchY() 是直接调用的，它们的返回值（promise）被传给 add(..) 。这些 promise 代表的底层值的可用时间可能是现在或将来，但不管怎样，promise 归一保证了行为的一致性。我们可以按照不依赖于时间的方式追踪值 X 和 Y 。它们是未来值。</p>\n<p>第二层是 add(..) （通过 Promise.all([ .. ]) ）创建并返回的 promise。我们通过调用 then(..) 等待这个 promise。 add(..) 运算完成后，未来值 sum 就准备好了，可以打印出来。我们把等待未来值 X 和 Y 的逻辑隐藏在了 add(..) 内部。</p>\n<p>通过 Promise，调用 then(..) 实际上可以接受两个函数，第一个用于完成情况（如前所示），第二个用于拒绝情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55790353384186140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`add(fetchX(), fetchY()).then(\n  // 完成处理函数\n  function(sum) {\n    console.log(sum);\n  },\n  // 拒绝处理函数\n  function(err) {\n    console.error(err); // 烦！\n  }\n);`, `55790353384186140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">fetchX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">fetchY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token comment">// 完成处理函数</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// 拒绝处理函数</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 烦！</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果在获取 X 或 Y 的过程中出错，或者在加法过程中出错， add(..) 返回的就是一个被拒绝的 promise，传给 then(..) 的第二个错误处理回调就会从这个 promise 中得到拒绝值。</p>\n<p>Promise 是一种封装和组合未来值的易于复用的机制。</p>\n<h3 id="完成事件"><a href="#%E5%AE%8C%E6%88%90%E4%BA%8B%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>完成事件</h3>\n<p>如前所述，单独的 Promise 展示了未来值的特性。但是，也可以从另外一个角度看待 Promise 的决议：一种在异步任务中作为两个或更多步骤的流程控制机制，时序上的 this-then-that。</p>\n<p>使用回调的话，通知就是任务 (foo(..)) 调用的回调。而使用 Promise 的话，我们把这个关系反转了过来，侦听来自 foo(..) 的事件，然后在得到通知的时候，根据情况继续。</p>\n<p>首先，考虑以下伪代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32883172956152550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`foo(x) {\n    // 开始做点可能耗时的工作\n}\nfoo(42)\non (foo &quot;completion&quot;) {\n    // 可以进行下一步了！\n}\non (foo &quot;error&quot;) {\n    // 啊，foo(..) 中出错了\n}`, `32883172956152550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 开始做点可能耗时的工作</span>\n<span class="token punctuation">}</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>\n<span class="token function">on</span> <span class="token punctuation">(</span>foo <span class="token string">"completion"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 可以进行下一步了！</span>\n<span class="token punctuation">}</span>\n<span class="token function">on</span> <span class="token punctuation">(</span>foo <span class="token string">"error"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 啊，foo(..) 中出错了</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们调用 foo(..) ，然后建立了两个事件侦听器，一个用于 ” completion” ，一个用于”error” —— foo(..) 调用的两种可能结果。从本质上讲， foo(..) 并不需要了解调用代码订阅了这些事件，这样就很好地实现了关注点分离。</p>\n<p>遗憾的是，这样的代码需要 JavaScript 环境提供某种魔法，而这种环境并不存在（实际上也有点不实际）。以下是在 JavaScript 中更自然的表达方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5516497634150142000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function foo(x) {\n  // 开始做点可能耗时的工作\n  // 构造一个 listener 事件通知处理对象来返回\n  return listener;\n}\nvar evt = foo(42);\nevt.on(\'completion\', function() {\n  // 可以进行下一步了！\n});\nevt.on(\'failure\', function(err) {\n  // 啊，foo(..) 中出错了\n});`, `5516497634150142000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 开始做点可能耗时的工作</span>\n  <span class="token comment">// 构造一个 listener 事件通知处理对象来返回</span>\n  <span class="token keyword">return</span> listener<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> evt <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nevt<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'completion\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 可以进行下一步了！</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nevt<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'failure\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 啊，foo(..) 中出错了</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>foo(..) 显式创建并返回了一个事件订阅对象，调用代码得到这个对象，并在其上注册了两个事件处理函数。</p>\n<p>相对于面向回调的代码，这里的反转是显而易见的，而且这也是有意为之。这里没有把回调传给 foo(..) ，而是返回一个名为 evt 的事件注册对象，由它来接受回调。</p>\n<p>回调本身就表达了一种控制反转。所以对回调模式的反转实际上是对反转的反转，或者称为反控制反转——把控制返还给调用代码，这也是我们最开始想要的效果。</p>\n<p>一个很重要的好处是，可以把这个事件侦听对象提供给代码中多个独立的部分；在 foo(..) 完成的时候，它们都可以独立地得到通知，以执行下一步：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89088555803370080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var evt = foo(42);\n// 让 bar(..) 侦听 foo(..) 的完成\nbar(evt);\n// 并且让 baz(..) 侦听 foo(..) 的完成\nbaz(evt);`, `89088555803370080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> evt <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 让 bar(..) 侦听 foo(..) 的完成</span>\n<span class="token function">bar</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 并且让 baz(..) 侦听 foo(..) 的完成</span>\n<span class="token function">baz</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对控制反转的恢复实现了更好的关注点分离，其中 bar(..) 和 baz(..) 不需要牵扯到 foo(..) 的调用细节。类似地， foo(..) 不需要知道或关注 bar(..) 和 baz(..) 是否存在，或者是否在等待 foo(..) 的完成通知。</p>\n<p>从本质上说， evt 对象就是分离的关注点之间一个中立的第三方协商机制。</p>\n<p>事件侦听对象 evt 就是 Promise 的一个模拟。</p>\n<p>在基于 Promise 的方法中，前面的代码片段会让 foo(..) 创建并返回一个 Promise 实例，而且这个 Promise 会被传递到 bar(..) 和 baz(..)</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32924181082235890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function foo(x) {\n  // 可是做一些可能耗时的工作\n  // 构造并返回一个 promise\n  return new Promise(function(resolve, reject) {\n    // 最终调用 resolve(..) 或者 reject(..)\n    // 这是这个 promise 的决议回调\n  });\n}\nvar p = foo(42);\nbar(p);\nbaz(p);`, `32924181082235890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 可是做一些可能耗时的工作</span>\n  <span class="token comment">// 构造并返回一个 promise</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 最终调用 resolve(..) 或者 reject(..)</span>\n    <span class="token comment">// 这是这个 promise 的决议回调</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">bar</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">baz</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能会猜测 bar(..) 和 baz(..) 的内部实现或许如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8361450040602847000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function bar(fooPromise) {\n  // 侦听 foo(..) 完成\n  fooPromise.then(\n    function() {\n      // foo(..) 已经完毕，所以执行 bar(..) 的任务\n    },\n    function() {\n      // 啊，foo(..) 中出错了！\n    }\n  );\n}`, `8361450040602847000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">fooPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 侦听 foo(..) 完成</span>\n  fooPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// foo(..) 已经完毕，所以执行 bar(..) 的任务</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 啊，foo(..) 中出错了！</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外一种实现方式是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38600750133865546000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function bar() {\n  // foo(..) 肯定已经完成，所以执行 bar(..) 的任务\n}\nfunction oopsBar() {\n  // 啊，foo(..) 中出错了，所以 bar(..) 没有运行\n}\n// 对于 baz() 和 oopsBaz() 也是一样\nvar p = foo(42);\np.then(bar, oopsBar);\np.then(baz, oopsBaz);`, `38600750133865546000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// foo(..) 肯定已经完成，所以执行 bar(..) 的任务</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">oopsBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 啊，foo(..) 中出错了，所以 bar(..) 没有运行</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 对于 baz() 和 oopsBaz() 也是一样</span>\n<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>bar<span class="token punctuation">,</span> oopsBar<span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>baz<span class="token punctuation">,</span> oopsBaz<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里没有把 promise p 传给 bar(..) 和 baz(..) ，而是使用 promise 控制 bar(..) 和 baz(..) 何时执行，如果执行的话。最主要的区别在于错误处理部分。</p>\n<p>在第一段代码的方法里，不论 foo(..) 成功与否， bar(..) 都会被调用。并且如果收到了 foo(..) 失败的通知，它会亲自处理自己的回退逻辑。显然， baz(..) 也是如此。</p>\n<p>在第二段代码中， bar(..) 只有在 foo(..) 成功时才会被调用，否则就会调用 oppsBar(..) 。baz(..) 也是如此。</p>\n<p>不管哪种情况，都是从 foo(..) 返回的 promise p 来控制接下来的步骤。</p>\n<p>另外，两段代码都以使用 promise p 调用 then(..) 两次结束。这个事实说明了前面的观点，就是 Promise（一旦决议）一直保持其决议结果（完成或拒绝）不变，可以按照需要多次查看</p>\n<p>一旦 p 决议，不论是现在还是将来，下一个步骤总是相同的。</p>\n<h3 id="具有-then-方法的鸭子类型"><a href="#%E5%85%B7%E6%9C%89-then-%E6%96%B9%E6%B3%95%E7%9A%84%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具有 then 方法的鸭子类型</h3>\n<p>在 Promise 领域，一个重要的细节是如何确定某个值是不是真正的 Promise。或者更直接地说，它是不是一个行为方式类似于 Promise 的值</p>\n<p>因此，识别 Promise（或者行为类似于 Promise 的东西）就是定义某种称为 thenable 的东西，将其定义为任何具有 then(..) 方法的对象和函数。我们认为，任何这样的值就是 Promise 一致的 thenable。</p>\n<p>根据一个值的形态（具有哪些属性）对这个值的类型做出一些假定。这种类型检查（typecheck）一般用术语鸭子类型（duck typing）来表示——“如果它看起来像只鸭子，叫起来像只鸭子，那它一定就是只鸭子”（参见本书的“类型和语法”部分）。于是，对 thenable 值的鸭子类型检测就大致类似于</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17042325405789493000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (p !== null && (typeof p === \'object\' || typeof p === \'function\') && typeof p.then === \'function\') {\n  // 假定这是一个 thenable!\n} else {\n  // 不是 thenable\n}`, `17042325405789493000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> p <span class="token operator">===</span> <span class="token string">\'object\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> p <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> p<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 假定这是一个 thenable!</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 不是 thenable</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你试图使用恰好有 then(..) 函数的一个对象或函数值完成一个 Promise，但并不希望它被当作 Promise 或 thenable，那就有点麻烦了，因为它会自动被识别为 thenable，并被按照特定的规则处理（参见本章后面的内容）。</p>\n<p>即使你并没有意识到这个值有 then(..) 函数也是这样。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38698787505930360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var o = { then: function() {} };\n// 让 v [[Prototype]]-link 到 o\nvar v = Object.create(o);\nv.someStuff = \'cool\';\nv.otherStuff = \'not so cool\';\nv.hasOwnProperty(\'then\'); // false`, `38698787505930360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function-variable function">then</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 让 v [[Prototype]]-link 到 o</span>\n<span class="token keyword">var</span> v <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>\nv<span class="token punctuation">.</span>someStuff <span class="token operator">=</span> <span class="token string">\'cool\'</span><span class="token punctuation">;</span>\nv<span class="token punctuation">.</span>otherStuff <span class="token operator">=</span> <span class="token string">\'not so cool\'</span><span class="token punctuation">;</span>\nv<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">\'then\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22640216417762103000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Object.prototype.then = function() {};\nArray.prototype.then = function() {};\nvar v1 = { hello: \'world\' };\nvar v2 = [\'Hello\', \'World\'];`, `22640216417762103000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> v1 <span class="token operator">=</span> <span class="token punctuation">{</span> hello<span class="token punctuation">:</span> <span class="token string">\'world\'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> v2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token string">\'World\'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>v1 和 v2 都会被认作 thenable</p>\n<p>如果 thenable 鸭子类型误把不是 Promise 的东西识别为了 Promise，可能就是有害的</p>\n<h2 id="promise-信任问题"><a href="#promise-%E4%BF%A1%E4%BB%BB%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 信任问题</h2>\n<h3 id="调用过早"><a href="#%E8%B0%83%E7%94%A8%E8%BF%87%E6%97%A9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用过早</h3>\n<p>这个问题主要就是担心代码是否会引入类似 Zalgo 这样的副作用（参见第 2 章）。在这类问题中，一个任务有时同步完成，有时异步完成，这可能会导致竞态条件。</p>\n<p>根据定义，Promise 就不必担心这种问题，因为即使是立即完成的 Promise（类似于 new Promise(function(resolve){ resolve(42); })）也无法被同步观察到。</p>\n<p>也就是说，对一个 Promise 调用 then(..) 的时候，即使这个 Promise 已经决议，提供给 then(..) 的回调也总会被异步调用（对此的更多讨论，请参见 1.5 节）。</p>\n<p>不再需要插入你自己的 setTimeout(..,0) hack，Promise 会自动防止 Zalgo 出现。</p>\n<h3 id="调用过晚"><a href="#%E8%B0%83%E7%94%A8%E8%BF%87%E6%99%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用过晚</h3>\n<p>和前面一点类似，Promise 创建对象调用 resolve(..) 或 reject(..) 时，这个 Promise 的 then(..) 注册的观察回调就会被自动调度。可以确信，这些被调度的回调在下一个异步事件点上一定会被触发</p>\n<p>同步查看是不可能的，所以一个同步任务链无法以这种方式运行来实现按照预期有效延迟另一个回调的发生。也就是说，一个 Promise 决议后，这个 Promise 上所有的通过 then(..) 注册的回调都会在下一个异步时机点上依次被立即调用（再次提醒，请参见 1.5 节）。这些回调中的任意一个都无法影响或延误对其他回调的调用。</p>\n<p>举例来说</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87735748909755370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`p.then(function() {\n  p.then(function() {\n    console.log(\'C\');\n  });\n  console.log(\'A\');\n});\np.then(function() {\n  console.log(\'B\');\n});\n// A B C`, `87735748909755370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'C\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'B\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// A B C</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里， “C” 无法打断或抢占 “B” ，这是因为 Promise 的运作方式。</p>\n<p>但是，还有很重要的一点需要指出，有很多调度的细微差别。在这种情况下，两个独立 Promise 上链接的回调的相对顺序无法可靠预测。</p>\n<p>如果两个 promise p1 和 p2 都已经决议，那么 p1.then(..) ; p2.then(..) 应该最终会先调用 p1 的回调，然后是 p2 的那些。但还有一些微妙的场景可能不是这样的，比如以下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8581838713363444000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p3 = new Promise(function(resolve, reject) {\n  resolve(\'B\');\n});\nvar p1 = new Promise(function(resolve, reject) {\n  resolve(p3);\n});\np2 = new Promise(function(resolve, reject) {\n  resolve(\'A\');\n});\np1.then(function(v) {\n  console.log(v);\n});\np2.then(function(v) {\n  console.log(v);\n});\n// A B <-- 而不是像你可能认为的 B A`, `8581838713363444000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'B\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// A B &lt;-- 而不是像你可能认为的 B A</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>后面我们还会深入介绍，但目前你可以看到， p1 不是用立即值而是用另一个 promise p3 决议，后者本身决议为值 “B” 。规定的行为是把 p3 展开到 p1 ，但是是异步地展开。所以，在异步任务队列中， p1 的回调排在 p2 的回调之后（参见 1.5 节）。</p>\n<p>要避免这样的细微区别带来的噩梦，你永远都不应该依赖于不同 Promise 间回调的顺序和调度。实际上，好的编码实践方案根本不会让多个回调的顺序有丝毫影响，可能的话就要避免。</p>\n<h3 id="回调未调用"><a href="#%E5%9B%9E%E8%B0%83%E6%9C%AA%E8%B0%83%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>回调未调用</h3>\n<p>这个问题很常见，Promise 可以通过几种途径解决。</p>\n<p>首先，没有任何东西（甚至 JavaScript 错误）能阻止 Promise 向你通知它的决议（如果它决议了的话）。如果你对一个 Promise 注册了一个完成回调和一个拒绝回调，那么 Promise 在决议时总是会调用其中的一个</p>\n<p>当然，如果你的回调函数本身包含 JavaScript 错误，那可能就会看不到你期望的结果，但实际上回调还是被调用了。后面我们会介绍如何在回调出错时得到通知，因为就连这些错误也不会被吞掉</p>\n<p>但是，如果 Promise 本身永远不被决议呢？即使这样，Promise 也提供了解决方案，其使用了一种称为竞态的高级抽象机制：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14439285780480594000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 用于超时一个 Promise 的工具\nfunction timeoutPromise(delay) {\n  return new Promise(function(resolve, reject) {\n    setTimeout(function() {\n      reject(\'Timeout!\');\n    }, delay);\n  });\n}\n// 设置 foo() 超时\nPromise.race([\n  foo(), // 试着开始 foo()\n  timeoutPromise(3000) // 给它 3 秒钟\n]).then(\n  function() {\n    // foo(..) 及时完成！\n  },\n  function(err) {\n    // 或者 foo() 被拒绝，或者只是没能按时完成\n    // 查看 err 来了解是哪种情况\n  }\n);`, `14439285780480594000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 用于超时一个 Promise 的工具</span>\n<span class="token keyword">function</span> <span class="token function">timeoutPromise</span><span class="token punctuation">(</span><span class="token parameter">delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'Timeout!\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 设置 foo() 超时</span>\nPromise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 试着开始 foo()</span>\n  <span class="token function">timeoutPromise</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 给它 3 秒钟</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// foo(..) 及时完成！</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 或者 foo() 被拒绝，或者只是没能按时完成</span>\n    <span class="token comment">// 查看 err 来了解是哪种情况</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>很重要的一点是，我们可以保证一个 foo() 有一个输出信号，防止其永久挂住程序。</p>\n<h3 id="调用次数过少或过多"><a href="#%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E8%BF%87%E5%B0%91%E6%88%96%E8%BF%87%E5%A4%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用次数过少或过多</h3>\n<p>根据定义，回调被调用的正确次数应该是 1，“过少”的情况就是调用 0 次，和前面解释过的“未被”调用是同一种情况。</p>\n<p>过多的情况很容易解释，Promise 的定义方式使得它只能被决议一次。如果出于某种原因，Promise 创建代码试图调用 resolve(..) 或 reject(..) 多次，或者试图两者都调用，那么这个 Promise 将只会接受第一次决议，并默默地忽略任何后续调用。</p>\n<p>由于 Promise 只能被决议一次，所以任何通过 then(..) 注册的（每个）回调就只会被调用一次。</p>\n<p>当然，如果你把同一个回调注册了不止一次（比如 p.then(f); p.then(f);），那它被调用的次数就会和注册次数相同。响应函数只会被调用一次，但这个保证并不能预防你搬起石头砸自己的脚。</p>\n<h3 id="未能传递参数--环境值"><a href="#%E6%9C%AA%E8%83%BD%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0--%E7%8E%AF%E5%A2%83%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>未能传递参数 / 环境值</h3>\n<p>Promise 至多只能有一个决议值（完成或拒绝）</p>\n<p>如果你没有用任何值显式决议，那么这个值就是 undefined ，这是 JavaScript 常见的处理方式。但不管这个值是什么，无论当前或未来，它都会被传给所有注册的（且适当的完成或拒绝）回调。</p>\n<p>还有一点需要清楚：如果使用多个参数调用 resovle(..) 或者 reject(..) ，第一个参数之后的所有参数都会被默默忽略。这看起来似乎违背了我们前面介绍的保证，但实际上并没有，因为这是对 Promise 机制的无效使用。对于这组 API 的其他无效使用（比如多次重复调用 resolve(..) ），也是类似的保护处理，所以这里的 Promise 行为是一致的（如果不是有点令人沮丧的话）。</p>\n<p>对环境来说，JavaScript 中的函数总是保持其定义所在的作用域的闭包（参见《你不知道的 JavaScript（上卷）》的“作用域和闭包”部分），所以它们当然可以继续访问你提供的环境状态。当然，对于只用回调的设计也是这样，因此这并不是 Promise 特有的优点——但不管怎样，这仍是我们可以依靠的一个保证。</p>\n<h3 id="吞掉错误或异常"><a href="#%E5%90%9E%E6%8E%89%E9%94%99%E8%AF%AF%E6%88%96%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>吞掉错误或异常</h3>\n<p>基本上，这部分是上个要点的再次说明。如果拒绝一个 Promise 并给出一个理由（也就是一个出错消息），这个值就会被传给拒绝回调。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81692460460388400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = new Promise(function(resolve, reject) {\n  foo.bar(); // foo 未定义，所以会出错！\n  resolve(42); // 永远不会到达这里 :(\n});\np.then(\n  function fulfilled() {\n    // 永远不会到达这里 :(\n  },\n  function rejected(err) {\n    // err 将会是一个 TypeError 异常对象来自 foo.bar() 这一行\n  }\n);`, `81692460460388400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  foo<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// foo 未定义，所以会出错！</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会到达这里 :(</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 永远不会到达这里 :(</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// err 将会是一个 TypeError 异常对象来自 foo.bar() 这一行</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>foo.bar() 中发生的 JavaScript 异常导致了 Promise 拒绝，你可以捕捉并对其作出响应</p>\n<p>这是一个重要的细节，因为其有效解决了另外一个潜在的 Zalgo 风险，即出错可能会引起同步响应，而不出错则会是异步的。Promise 甚至把 JavaScript 异常也变成了异步行为，进而极大降低了竞态条件出现的可能</p>\n<p>但是，如果 Promise 完成后在查看结果时（ then(..) 注册的回调中）出现了 JavaScript 异常错误会怎样呢？即使这些异常不会被丢弃，但你会发现，对它们的处理方式还是有点出乎意料，需要进行一些深入研究才能理解：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1023546941154740500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = new Promise(function(resolve, reject) {\n  resolve(42);\n});\np.then(\n  function fulfilled(msg) {\n    foo.bar();\n    console.log(msg); // 永远不会到达这里 :(\n  },\n  function rejected(err) {\n    // 永远也不会到达这里 :(\n  }\n);`, `1023546941154740500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    foo<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 永远不会到达这里 :(</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 永远也不会到达这里 :(</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="是可信任的-promise-吗"><a href="#%E6%98%AF%E5%8F%AF%E4%BF%A1%E4%BB%BB%E7%9A%84-promise-%E5%90%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>是可信任的 Promise 吗</h3>\n<p>你肯定已经注意到 Promise 并没有完全摆脱回调。它们只是改变了传递回调的位置。我们并不是把回调传递给 foo(..) ，而是从 foo(..) 得到某个东西（外观上看是一个真正的 Promise），然后把回调传给这个东西。</p>\n<p>但是，为什么这就比单纯使用回调更值得信任呢？如何能够确定返回的这个东西实际上就是一个可信任的 Promise 呢？这难道不是一个（脆弱的）纸牌屋，在里面只能信任我们已经信任的？</p>\n<p>关于 Promise 的很重要但是常常被忽略的一个细节是，Promise 对这个问题已经有一个解决方案。包含在原生 ES6 Promise 实现中的解决方案就是 Promise.resolve(..) 。</p>\n<p>如果向 Promise.resolve(..) 传递一个非 Promise、非 thenable 的立即值，就会得到一个用这个值填充的 promise。下面这种情况下，promise p1 和 promise p2 的行为是完全一样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63365824074422990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p1 = new Promise(function(resolve, reject) {\n  resolve(42);\n});\nvar p2 = Promise.resolve(42);`, `63365824074422990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而如果向 Promise.resolve(..) 传递一个真正的 Promise，就只会返回同一个 promise：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60812306457782900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p1 = Promise.resolve(42);\nvar p2 = Promise.resolve(p1);\np1 === p2; // true`, `60812306457782900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>\np1 <span class="token operator">===</span> p2<span class="token punctuation">;</span> <span class="token comment">// true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>更重要的是，如果向 Promise.resolve(..) 传递了一个非 Promise 的 thenable 值，前者就会试图展开这个值，而且展开过程会持续到提取出一个具体的非类 Promise 的最终值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28788485501792740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = {\n  then: function(cb) {\n    cb(42);\n  }\n};\n// 这可以工作，但只是因为幸运而已\np.then(\n  function fulfilled(val) {\n    console.log(val); // 42\n  },\n  function rejected(err) {\n    // 永远不会到达这里\n  }\n);`, `28788485501792740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">then</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token comment">// 这可以工作，但只是因为幸运而已</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 永远不会到达这里</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个 p 是一个 thenable，但并不是一个真正的 Promise。幸运的是，和绝大多数值一样，它是可追踪的。但是，如果得到的是如下这样的值又会怎样呢：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43461403876350440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = {\n  then: function(cb, errcb) {\n    cb(42);\n    errcb(\'evil laugh\');\n  }\n};\np.then(\n  function fulfilled(val) {\n    console.log(val); // 42\n  },\n  function rejected(err) {\n    // 啊，不应该运行！\n    console.log(err); // 邪恶的笑\n  }\n);`, `43461403876350440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">then</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">,</span> errcb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">errcb</span><span class="token punctuation">(</span><span class="token string">\'evil laugh\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 啊，不应该运行！</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 邪恶的笑</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个 p 是一个 thenable，但是其行为和 promise 并不完全一致。这是恶意的吗？还只是因为它不知道 Promise 应该如何运作？说实话，这并不重要。不管是哪种情况，它都是不可信任的。</p>\n<p>尽管如此，我们还是都可以把这些版本的 p 传给 Promise.resolve(..) ，然后就会得到期望中的规范化后的安全结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33572044278884827000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Promise.resolve(p).then(\n  function fulfilled(val) {\n    console.log(val); // 42\n  },\n  function rejected(err) {\n    // 永远不会到达这里\n  }\n);`, `33572044278884827000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 永远不会到达这里</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Promise.resolve(..) 可以接受任何 thenable，将其解封为它的非 thenable 值。从 Promise.resolve(..) 得到的是一个真正的 Promise，是一个可以信任的值。如果你传入的已经是真正的 Promise，那么你得到的就是它本身，所以通过 Promise.resolve(..) 过滤来获得可信任性完全没有坏处。</p>\n<p>假设我们要调用一个工具 foo(..) ，且并不确定得到的返回值是否是一个可信任的行为良好的 Promise，但我们可以知道它至少是一个 thenable。 Promise.resolve(..) 提供了可信任的 Promise 封装工具，可以链接使用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2361474931551854600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 不要只是这么做：\nfoo(42).then(function(v) {\n  console.log(v);\n});\n// 而要这么做：\nPromise.resolve(foo(42)).then(function(v) {\n  console.log(v);\n});`, `2361474931551854600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 不要只是这么做：</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 而要这么做：</span>\nPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于用 Promise.resolve(..) 为所有函数的返回值（不管是不是 thenable）都封装一层。另一个好处是，这样做很容易把函数调用规范为定义良好的异步任务。如果 foo(42) 有时会返回一个立即值，有时会返回 Promise，那么 Promise.resolve( foo(42) ) 就能够保证总会返回一个 Promise 结果，而且避免 Zalgo 就能得到更好的代码。</p>\n<h3 id="建立信任"><a href="#%E5%BB%BA%E7%AB%8B%E4%BF%A1%E4%BB%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>建立信任</h3>\n<p>可以用 JavaScript 编写异步代码而无需信任吗？当然可以。JavaScript 开发者近二十年来一直都只用回调编写异步代码。</p>\n<p>可一旦开始思考你在其上构建代码的机制具有何种程度的可预见性和可靠性时，你就会开始意识到回调的可信任基础是相当不牢靠。</p>\n<p>Promise 这种模式通过可信任的语义把回调作为参数传递，使得这种行为更可靠更合理。通过把回调的控制反转反转回来，我们把控制权放在了一个可信任的系统（Promise）中，这种系统的设计目的就是为了使异步编码更清晰。</p>\n<h2 id="链式流"><a href="#%E9%93%BE%E5%BC%8F%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>链式流</h2>\n<p>我们可以把多个 Promise 连接到一起以表示一系列异步步骤</p>\n<p>这种方式可以实现的关键在于以下两个 Promise 固有行为特性：</p>\n<ul>\n<li>每次你对 Promise 调用 then(..) ，它都会创建并返回一个新的 Promise，我们可以将其链接起来；</li>\n<li>不管从 then(..) 调用的完成回调（第一个参数）返回的值是什么，它都会被自动设置为被链接 Promise（第一点中的）的完成。</li>\n</ul>\n<p>考虑如下代码</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42176213890495100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = Promise.resolve(21);\nvar p2 = p.then(function(v) {\n  console.log(v); // 21\n  // 用值 42 填充 p2\n  return v * 2;\n});\n// 连接 p2\np2.then(function(v) {\n  console.log(v); // 42\n});`, `42176213890495100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p2 <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 21</span>\n  <span class="token comment">// 用值 42 填充 p2</span>\n  <span class="token keyword">return</span> v <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 连接 p2</span>\np2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们通过返回 v _ 2 ( 即 42 )，完成了第一个调用 then(..) 创建并返回的 promise p2 。 p2 的 then(..) 调用在运行时会从 return v _ 2 语句接受完成值。当然， p2.then(..) 又创建了另一个新的 promise，可以用变量 p3 存储</p>\n<p>但是，如果必须创建一个临时变量 p2 （或 p3 等），还是有一点麻烦的。谢天谢地，我们很容易把这些链接到一起：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71543643656131576000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = Promise.resolve(21);\np.then(function(v) {\n  console.log(v); // 21\n  // 用值 42 完成连接的 promise\n  return v * 2;\n})\n  // 这里是链接的 promise\n  .then(function(v) {\n    console.log(v); // 42\n  });`, `71543643656131576000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 21</span>\n  <span class="token comment">// 用值 42 完成连接的 promise</span>\n  <span class="token keyword">return</span> v <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// 这里是链接的 promise</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在第一个 then(..) 就是异步序列中的第一步，第二个 then(..) 就是第二步。这可以一直任意扩展下去。只要保持把先前的 then(..) 连到自动创建的每一个 Promise 即可。</p>\n<p>如果需要步骤 2 等待步骤 1 异步来完成一些事情怎么办？我们使用了立即返回 return 语句，这会立即完成链接的 promise</p>\n<p>使 Promise 序列真正能够在每一步有异步能力的关键是，回忆一下当传递给 Promise.resolve(..) 的 是 一 个 Promise 或 thenable 而不是最终值时的运作方式。Promise.resolve(..) 会直接返回接收到的真正 Promise，或展开接收到的 thenable 值，并在持续展开 thenable 的同时递归地前进</p>\n<p>从完成（或拒绝）处理函数返回 thenable 或者 Promise 的时候也会发生同样的展开。考虑：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57895186092225320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = Promise.resolve(21);\np.then(function(v) {\n  console.log(v); // 21\n  // 创建一个 promise 并将其返回\n  return new Promise(function(resolve, reject) {\n    // 用值 42 填充\n    resolve(v * 2);\n  });\n}).then(function(v) {\n  console.log(v); // 42\n});`, `57895186092225320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 21</span>\n  <span class="token comment">// 创建一个 promise 并将其返回</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 用值 42 填充</span>\n    <span class="token function">resolve</span><span class="token punctuation">(</span>v <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然我们把 42 封装到了返回的 promise 中，但它仍然会被展开并最终成为链接的 promise 的决议，因此第二个 then(..) 得到的仍然是 42 。如果我们向封装的 promise 引入异步，一切都仍然会同样工作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15796285239904440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = Promise.resolve(21);\np.then(function(v) {\n  console.log(v); // 21\n  // 创建一个 promise 并返回\n  return new Promise(function(resolve, reject) {\n    // 引入异步！\n    setTimeout(function() {\n      // 用值 42 填充\n      resolve(v * 2);\n    }, 100);\n  });\n}).then(function(v) {\n  // 在前一步中的 100ms 延迟之后运行\n  console.log(v); // 42\n});`, `15796285239904440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 21</span>\n  <span class="token comment">// 创建一个 promise 并返回</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 引入异步！</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 用值 42 填充</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span>v <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 在前一步中的 100ms 延迟之后运行</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种强大实在不可思议！现在我们可以构建这样一个序列：不管我们想要多少个异步步骤，每一步都能够根据需要等待下一步（或者不等！）。</p>\n<p>当然，在这些例子中，一步步传递的值是可选的。如果不显式返回一个值，就会隐式返回 undefined ，并且这些 promise 仍然会以同样的方式链接在一起。这样，每个 Promise 的决议就成了继续下一个步骤的信号。</p>\n<p>为了进一步阐释链接，让我们把延迟 Promise 创建（没有决议消息）过程一般化到一个工具中，以便在多个步骤中复用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18270366171423724000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function delay(time) {\n  return new Promise(function(resolve, reject) {\n    setTimeout(resolve, time);\n  });\n}\ndelay(100) // 步骤 1\n  .then(function STEP2() {\n    console.log(\'step 2 (after 100ms)\');\n    return delay(200);\n  })\n  .then(function STEP3() {\n    console.log(\'step 3 (after another 200ms)\');\n  })\n  .then(function STEP4() {\n    console.log(\'step 4 (next Job)\');\n    return delay(50);\n  })\n  .then(function STEP5() {\n    console.log(\'step 5 (after another 50ms)\');\n  });`, `18270366171423724000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// 步骤 1</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">STEP2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'step 2 (after 100ms)\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">STEP3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'step 3 (after another 200ms)\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">STEP4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'step 4 (next Job)\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token constant">STEP5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'step 5 (after another 50ms)\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 delay(200) 创建了一个将在 200ms 后完成的 promise，然后我们从第一个 then(..) 完成回调中返回这个 promise，这会导致第二个 then(..) 的 promise 等待这个 200ms 的 promise。</p>\n<p>但说实话，没有消息传递的延迟序列对于 Promise 流程控制来说并不是一个很有用的示例。我们来考虑如下这样一个更实际的场景。</p>\n<p>这里不用定时器，而是构造 Ajax 请求：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9652446432111895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 假定工具 ajax( {url}, {callback} ) 存在\n// Promise-aware ajax\nfunction request(url) {\n  return new Promise(function(resolve, reject) {\n    // ajax(..) 回调应该是我们这个 promise 的 resolve(..) 函数\n    ajax(url, resolve);\n  });\n}`, `9652446432111895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 假定工具 ajax( {url}, {callback} ) 存在</span>\n<span class="token comment">// Promise-aware ajax</span>\n<span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ajax(..) 回调应该是我们这个 promise 的 resolve(..) 函数</span>\n    <span class="token function">ajax</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们首先定义一个工具 request(..) ，用来构造一个表示 ajax(..) 调用完成的 promise：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52741004477369560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`request(\'http://some.url.1/\')\n  .then(function(response1) {\n    return request(\'http://some.url.2/?v=\' + response1);\n  })\n  .then(function(response2) {\n    console.log(response2);\n  });`, `52741004477369560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1/\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2/?v=\'</span> <span class="token operator">+</span> response1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>利用返回 Promise 的 request(..) ，我们通过使用第一个 URL 调用它来创建链接中的第一步，并且把返回的 promise 与第一个 then(..) 链接起来。</p>\n<p>我们构建的这个 Promise 链不仅是一个表达多步异步序列的流程控制，还是一个从一个步骤到下一个步骤传递消息的消息通道。</p>\n<p>如果这个 Promise 链中的某个步骤出错了怎么办？错误和异常是基于每个 Promise 的，这意味着可能在链的任意位置捕捉到这样的错误，而这个捕捉动作在某种程度上就相当于在这一位置将整条链“重置”回了正常运作</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71061760448686790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 步骤 1：\nrequest(\'http://some.url.1/\')\n  // 步骤 2：\n  .then(function(response1) {\n    foo.bar(); // undefined，出错！\n    // 永远不会到达这里\n    return request(\'http://some.url.2/?v=\' + response1);\n  })\n  // 步骤 3：\n  .then(\n    function fulfilled(response2) {\n      // 永远不会到达这里\n    },\n    // 捕捉错误的拒绝处理函数\n    function rejected(err) {\n      console.log(err);\n      // 来自 foo.bar() 的错误 TypeError\n      return 42;\n    }\n  )\n  // 步骤 4：\n  .then(function(msg) {\n    console.log(msg); // 42\n  });`, `71061760448686790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 步骤 1：</span>\n<span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1/\'</span><span class="token punctuation">)</span>\n  <span class="token comment">// 步骤 2：</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    foo<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined，出错！</span>\n    <span class="token comment">// 永远不会到达这里</span>\n    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2/?v=\'</span> <span class="token operator">+</span> response1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// 步骤 3：</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n    <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">response2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 永远不会到达这里</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// 捕捉错误的拒绝处理函数</span>\n    <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 来自 foo.bar() 的错误 TypeError</span>\n      <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span>\n  <span class="token comment">// 步骤 4：</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第 2 步出错后，第 3 步的拒绝处理函数会捕捉到这个错误。拒绝处理函数的返回值（这段代码中是 42 ），如果有的话，会用来完成交给下一个步骤（第 4 步）的 promise，这样，这个链现在就回到了完成状态。</p>\n<p>如果你调用 promise 的 then(..) ，并且只传入一个完成处理函数，一个默认拒绝处理函数就会顶替上来：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43561985940317680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = new Promise(function(resolve, reject) {\n  reject(\'Oops\');\n});\nvar p2 = p.then(\n  function fulfilled() {\n    // 永远不会达到这里\n  }\n  // 假定的拒绝处理函数，如果省略或者传入任何非函数值\n  // function(err) {\n  // throw err;\n  // }\n);`, `43561985940317680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'Oops\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p2 <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 永远不会达到这里</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 假定的拒绝处理函数，如果省略或者传入任何非函数值</span>\n  <span class="token comment">// function(err) {</span>\n  <span class="token comment">// throw err;</span>\n  <span class="token comment">// }</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如你所见，默认拒绝处理函数只是把错误重新抛出，这最终会使得 p2 （链接的 promise）用同样的错误理由拒绝。从本质上说，这使得错误可以继续沿着 Promise 链传播下去，直到遇到显式定义的拒绝处理函数。</p>\n<p>如果没有给 then(..) 传递一个适当有效的函数作为完成处理函数参数，还是会有作为替代的一个默认处理函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75981057710100410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p = Promise.resolve(42);\np.then(\n  // 假设的完成处理函数，如果省略或者传入任何非函数值\n  // function(v) {\n  // return v;\n  // }\n  null,\n  function rejected(err) {\n    // 永远不会到达这里\n  }\n);`, `75981057710100410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token comment">// 假设的完成处理函数，如果省略或者传入任何非函数值</span>\n  <span class="token comment">// function(v) {</span>\n  <span class="token comment">// return v;</span>\n  <span class="token comment">// }</span>\n  <span class="token keyword">null</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 永远不会到达这里</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以看到，默认的完成处理函数只是把接收到的任何传入值传递给下一个步骤（Promise）而已。</p>\n<p>then(null,function(err){ .. }) 这个模式——只处理拒绝（如果有的话），但又把完成值传递下去——有一个缩写形式的 API：catch(function(err){ .. })。下一小节会详细介绍 catch(..)。</p>\n<p>让我们来简单总结一下使链式流程控制可行的 Promise 固有特性。</p>\n<ul>\n<li>调用 Promise 的 then(..) 会自动创建一个新的 Promise 从调用返回。</li>\n<li>在完成或拒绝处理函数内部，如果返回一个值或抛出一个异常，新返回的（可链接的）Promise 就相应地决议。</li>\n<li>如果完成或拒绝处理函数返回一个 Promise，它将会被展开，这样一来，不管它的决议值是什么，都会成为当前 then(..) 返回的链接 Promise 的决议值。</li>\n</ul>\n<p>尽管链式流程控制是有用的，但是对其最精确的看法是把它看作 Promise 组合到一起的一个附加益处，而不是主要目的。正如前面已经多次深入讨论的，Promise 规范化了异步，并封装了时间相关值的状态，使得我们能够把它们以这种有用的方式链接到一起。</p>\n<p>当然，相对于第 2 章讨论的回调的一团乱麻，链接的顺序表达（this-then-this-then-this…）已经是一个巨大的进步。但是，仍然有大量的重复样板代码（ then(..) 以及 function(){ … } ）。在第 4 章，我们将会看到在顺序流程控制表达方面提升巨大的优美模式，通过生成器实现。</p>\n<h3 id="术语：决议、完成以及拒绝"><a href="#%E6%9C%AF%E8%AF%AD%EF%BC%9A%E5%86%B3%E8%AE%AE%E3%80%81%E5%AE%8C%E6%88%90%E4%BB%A5%E5%8F%8A%E6%8B%92%E7%BB%9D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>术语：决议、完成以及拒绝</h3>\n<p>术语决议（resolve）、完成（fulfill）和拒绝（reject）</p>\n<p>构造器 Promise(..) 的第一个参数，特指完成这个 Promise，为什么不用使用 fulfill(..) 来代替 resolve(..) 以求表达更精确的原因：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38395296727238430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var rejectedTh = {\n  then: function(resolved, rejected) {\n    rejected(\'Oops\');\n  }\n};\nvar rejectedPr = Promise.resolve(rejectedTh);`, `38395296727238430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> rejectedTh <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function-variable function">then</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolved<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token string">\'Oops\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> rejectedPr <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>rejectedTh<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Promise.resolve(..) 会将传入的真正 Promise 直接返回，对传入的 thenable 则会展开，如果这个 thenable 展开得到一个拒绝状态，那么从 Promise.resolve(..) 返回的 Promise 实际上就是这同一个拒绝状态</p>\n<p>所以对这个 API 方法来说， Promise.resolve(..) 是一个精确的好名字，因为它实际上的结果可能是完成或拒绝</p>\n<p>Promise(..) 构造器的第一个参数回调会展开 thenable（和 Promise.resolve(..) 一样）或真正的 Promise：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94297450237136360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var rejectedPr = new Promise(function(resolve, reject) {\n  // 用一个被拒绝的 promise 完成这个 promise, 注意 reject(..) 不会像 resolve(..) 一样进行展开\n  resolve(Promise.reject(\'Oops\'));\n});\nrejectedPr.then(\n  function fulfilled() {\n    // 永远不会到达这里\n  },\n  function rejected(err) {\n    console.log(err); // &quot;Oops&quot;\n  }\n);`, `94297450237136360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{2} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> rejectedPr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="gatsby-highlight-code-line">  <span class="token comment">// 用一个被拒绝的 promise 完成这个 promise, 注意 reject(..) 不会像 resolve(..) 一样进行展开</span></span>  <span class="token function">resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'Oops\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nrejectedPr<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 永远不会到达这里</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Oops"</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>then 的回调建议是 fulfilled(..) 和 rejected(..)</p>\n<h2 id="promise-模式"><a href="#promise-%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 模式</h2>\n<p>前面使用了 Promise 链的顺序模式（this-then-this-then-that 流程控制），</p>\n<h3 id="promiseall--"><a href="#promiseall--" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise.all([ .. ])</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39461257022162140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// request(..) 是一个 Promise-aware Ajax 工具\n// 就像我们在本章前面定义的一样\nvar p1 = request(\'http://some.url.1/\');\nvar p2 = request(\'http://some.url.2/\');\nPromise.all([p1, p2])\n  .then(function(msgs) {\n    // 这里，p1 和 p2 完成并把它们的消息传入\n    return request(\'http://some.url.3/?v=\' + msgs.join(\',\'));\n  })\n  .then(function(msg) {\n    console.log(msg);\n  });`, `39461257022162140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// request(..) 是一个 Promise-aware Ajax 工具</span>\n<span class="token comment">// 就像我们在本章前面定义的一样</span>\n<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nPromise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 这里，p1 和 p2 完成并把它们的消息传入</span>\n    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.3/?v=\'</span> <span class="token operator">+</span> msgs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\',\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>严格说来，传给 Promise.all([ .. ]) 的数组中的值可以是 Promise、thenable，甚至是立即值。就本质而言，列表中的每个值都会通过 Promise.resolve(..) 过滤，以确保要等待的是一个真正的 Promise，所以立即值会被规范化为为这个值构建的 Promise。如果数组是空的，主 Promise 就会立即完成</p>\n</blockquote>\n<h3 id="promiserace--"><a href="#promiserace--" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise.race([ .. ])</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72078630355340410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// request(..) 是一个支持 Promise 的 Ajax 工具\n// 就像我们在本章前面定义的一样\nvar p1 = request(\'http://some.url.1/\');\nvar p2 = request(\'http://some.url.2/\');\nPromise.race([p1, p2])\n  .then(function(msg) {\n    // p1 或者 p2 将赢得这场竞赛\n    return request(\'http://some.url.3/?v=\' + msg);\n  })\n  .then(function(msg) {\n    console.log(msg);\n  });`, `72078630355340410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// request(..) 是一个支持 Promise 的 Ajax 工具</span>\n<span class="token comment">// 就像我们在本章前面定义的一样</span>\n<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2/\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nPromise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// p1 或者 p2 将赢得这场竞赛</span>\n    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.3/?v=\'</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="超时竞赛"><a href="#%E8%B6%85%E6%97%B6%E7%AB%9E%E8%B5%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>超时竞赛</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31601143005109432000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// foo() 是一个支持 Promise 的函数\n// 前面定义的 timeoutPromise(..) 返回一个 promise，\n// 这个 promise 会在指定延时之后拒绝\n// 为 foo() 设定超时\nPromise.race([\n  foo(), // 启动 foo()\n  timeoutPromise(3000) // 给它 3 秒钟\n]).then(\n  function() {\n    // foo(..) 按时完成！\n  },\n  function(err) {\n    // 要么 foo() 被拒绝，要么只是没能够按时完成，\n    // 因此要查看 err 了解具体原因\n  }\n);`, `31601143005109432000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// foo() 是一个支持 Promise 的函数</span>\n<span class="token comment">// 前面定义的 timeoutPromise(..) 返回一个 promise，</span>\n<span class="token comment">// 这个 promise 会在指定延时之后拒绝</span>\n<span class="token comment">// 为 foo() 设定超时</span>\nPromise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 启动 foo()</span>\n  <span class="token function">timeoutPromise</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 给它 3 秒钟</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// foo(..) 按时完成！</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 要么 foo() 被拒绝，要么只是没能够按时完成，</span>\n    <span class="token comment">// 因此要查看 err 了解具体原因</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="finally"><a href="#finally" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>finally</h4>\n<p>允许你执行任何必要的清理工作，我们可以构建一个静态辅助工具来支持查看（而不影响）Promise 的决议：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80117646398823370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// polyfill 安全的 guard 检查\nif (!Promise.observe) {\n  Promise.observe = function(pr, cb) {\n    // 观察 pr 的决议\n    pr.then(\n      function fulfilled(msg) {\n        // 安排异步回调（作为 Job）\n        Promise.resolve(msg).then(cb);\n      },\n      function rejected(err) {\n        // 安排异步回调（作为 Job）\n        Promise.resolve(err).then(cb);\n      }\n    );\n    // 返回最初的 promise\n    return pr;\n  };\n}`, `80117646398823370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// polyfill 安全的 guard 检查</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Promise<span class="token punctuation">.</span>observe<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  Promise<span class="token punctuation">.</span><span class="token function-variable function">observe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">pr<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 观察 pr 的决议</span>\n    pr<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n      <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 安排异步回调（作为 Job）</span>\n        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 安排异步回调（作为 Job）</span>\n        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 返回最初的 promise</span>\n    <span class="token keyword">return</span> pr<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面是如何在前面的超时例子中使用这个工具：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46387315347209410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Promise.race([\n  Promise.observe(\n    foo(), // 试着运行 foo()\n    function cleanup(msg) {\n      // 在 foo() 之后清理，即使它没有在超时之前完成\n    }\n  ),\n  timeoutPromise(3000) // 给它 3 秒钟\n]);`, `46387315347209410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  Promise<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>\n    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 试着运行 foo()</span>\n    <span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在 foo() 之后清理，即使它没有在超时之前完成</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token function">timeoutPromise</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 给它 3 秒钟</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="all---和-race---的变体"><a href="#all---%E5%92%8C-race---%E7%9A%84%E5%8F%98%E4%BD%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>all([ .. ]) 和 race([ .. ]) 的变体</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37178687438966260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// polyfill 安全的 guard 检查\nif (!Promise.first) {\n  Promise.first = function(prs) {\n    return new Promise(function(resolve, reject) {\n      // 在所有 promise 上循环\n      prs.forEach(function(pr) {\n        // 把值规整化\n        Promise.resolve(pr)\n          // 不管哪个最先完成，就决议主 promise\n          .then(resolve);\n      });\n    });\n  };\n}`, `37178687438966260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// polyfill 安全的 guard 检查</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Promise<span class="token punctuation">.</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  Promise<span class="token punctuation">.</span><span class="token function-variable function">first</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 在所有 promise 上循环</span>\n      prs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">pr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 把值规整化</span>\n        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>pr<span class="token punctuation">)</span>\n          <span class="token comment">// 不管哪个最先完成，就决议主 promise</span>\n          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="并发迭代"><a href="#%E5%B9%B6%E5%8F%91%E8%BF%AD%E4%BB%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并发迭代</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58041782026148780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (!Promise.map) {\n  Promise.map = function(vals, cb) {\n    // 一个等待所有 map 的 promise 的新 promise\n    return Promise.all(\n      // 注：一般数组 map(..) 把值数组转换为 promise 数组\n      vals.map(function(val) {\n        // 用 val 异步 map 之后决议的新 promise 替换 val\n        return new Promise(function(resolve) {\n          cb(val, resolve);\n        });\n      })\n    );\n  };\n}`, `58041782026148780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Promise<span class="token punctuation">.</span>map<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  Promise<span class="token punctuation">.</span><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">vals<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 一个等待所有 map 的 promise 的新 promise</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>\n      <span class="token comment">// 注：一般数组 map(..) 把值数组转换为 promise 数组</span>\n      vals<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 用 val 异步 map 之后决议的新 promise 替换 val</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">cb</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面展示如何在一组 Promise（而非简单的值）上使用 map(..)</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8770407801477464000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var p1 = Promise.resolve(21);\nvar p2 = Promise.resolve(42);\nvar p3 = Promise.reject(\'Oops\');\n// 把列表中的值加倍，即使是在 Promise 中\nPromise.map([p1, p2, p3], function(pr, done) {\n  // 保证这一条本身是一个 Promise\n  Promise.resolve(pr).then(\n    // 提取值作为 v\n    function(v) {\n      // map 完成的 v 到新值\n      done(v * 2);\n    },\n    // 或者 map 到 promise 拒绝消息\n    done\n  );\n}).then(function(vals) {\n  console.log(vals); // [42,84,&quot;Oops&quot;]\n});`, `8770407801477464000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">\'Oops\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 把列表中的值加倍，即使是在 Promise 中</span>\nPromise<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">pr<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 保证这一条本身是一个 Promise</span>\n  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>pr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n    <span class="token comment">// 提取值作为 v</span>\n    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// map 完成的 v 到新值</span>\n      <span class="token function">done</span><span class="token punctuation">(</span>v <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// 或者 map 到 promise 拒绝消息</span>\n    done\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">vals</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vals<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [42,84,"Oops"]</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="promise-局限性"><a href="#promise-%E5%B1%80%E9%99%90%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 局限性</h2>\n<h3 id="顺序错误处理"><a href="#%E9%A1%BA%E5%BA%8F%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顺序错误处理</h3>\n<p>Promise 链中的错误很容易被无意中默默忽略掉</p>\n<h3 id="单一值"><a href="#%E5%8D%95%E4%B8%80%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单一值</h3>\n<p>根据定义，Promise 只能有一个完成值或一个拒绝理由，有时是一种局限</p>\n<h4 id="分裂值"><a href="#%E5%88%86%E8%A3%82%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分裂值</h4>\n<p>有时候你可以把这一点当作提示你应该把问题分解为两个或更多 Promise 的信号</p>\n<p>设想你有一个工具 foo(..) ，它可以异步产生两个值（ x 和 y ）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29592409995648295000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getY(x) {\n  return new Promise(function(resolve, reject) {\n    setTimeout(function() {\n      resolve(3 * x - 1);\n    }, 5000);\n  });\n}\nfunction foo(bar, baz) {\n  var x = bar * baz;\n  return getY(x).then(function(y) {\n    // 把两个值封装到容器中\n    return [x, y];\n  });\n}\nfoo(10, 20).then(function(msgs) {\n  var x = msgs[0];\n  var y = msgs[1];\n  console.log(x, y); // 200 599\n});`, `29592409995648295000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getY</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">bar<span class="token punctuation">,</span> baz</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> x <span class="token operator">=</span> bar <span class="token operator">*</span> baz<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">getY</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 把两个值封装到容器中</span>\n    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> x <span class="token operator">=</span> msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> y <span class="token operator">=</span> msgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 200 599</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>重构之后：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56163544768834585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function foo(bar, baz) {\n  var x = bar * baz;\n  // 返回两个 promise\n  return [Promise.resolve(x), getY(x)];\n}\nPromise.all(foo(10, 20)).then(function(msgs) {\n  var x = msgs[0];\n  var y = msgs[1];\n  console.log(x, y);\n});`, `56163544768834585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">bar<span class="token punctuation">,</span> baz</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> x <span class="token operator">=</span> bar <span class="token operator">*</span> baz<span class="token punctuation">;</span>\n  <span class="token comment">// 返回两个 promise</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getY</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\nPromise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> x <span class="token operator">=</span> msgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> y <span class="token operator">=</span> msgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一个 promise 数组真的要优于传递给单个 promise 的一个值数组吗？从语法的角度来说，这算不上是一个改进</p>\n<p>但是，这种方法更符合 Promise 的设计理念。如果以后需要重构代码把对 x 和 y 的计算分开，这种方法就简单得多。由调用代码来决定如何安排这两个 promise，而不是把这种细节放在 foo(..) 内部抽象，这样更整洁也更灵活。这里使用了 Promise.all([ .. ]) ，当然，这并不是唯一的选择。</p>\n<h4 id="展开--传递参数"><a href="#%E5%B1%95%E5%BC%80--%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>展开 / 传递参数</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73573903912222515000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Promise.all(foo(10, 20)).then(function([x, y]) {\n  console.log(x, y); // 200 599\n});`, `73573903912222515000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 200 599</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="单决议"><a href="#%E5%8D%95%E5%86%B3%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单决议</h3>\n<p>你可能要启动一系列异步步骤以响应某种可能多次发生的激励（就像是事件），比如按钮点击</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31598977634392010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// click(..) 把&quot;click&quot;事件绑定到一个 DOM 元素\n// request(..) 是前面定义的支持 Promise 的 Ajax\nvar p = new Promise(function(resolve, reject) {\n  click(\'#mybtn\', resolve);\n});\np.then(function(evt) {\n  var btnID = evt.currentTarget.id;\n  return request(\'http://some.url.1/?id=\' + btnID);\n}).then(function(text) {\n  console.log(text);\n});`, `31598977634392010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// click(..) 把"click"事件绑定到一个 DOM 元素</span>\n<span class="token comment">// request(..) 是前面定义的支持 Promise 的 Ajax</span>\n<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">click</span><span class="token punctuation">(</span><span class="token string">\'#mybtn\'</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\np<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> btnID <span class="token operator">=</span> evt<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>id<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1/?id=\'</span> <span class="token operator">+</span> btnID<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有在你的应用只需要响应按钮点击一次的情况下，这种方式才能工作，只有为每个事件的发生创建一整个新的 Promise 链才能正常工作</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54579139146729670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`click(\'#mybtn\', function(evt) {\n  var btnID = evt.currentTarget.id;\n  request(\'http://some.url.1/?id=\' + btnID).then(function(text) {\n    console.log(text);\n  });\n});`, `54579139146729670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">click</span><span class="token punctuation">(</span><span class="token string">\'#mybtn\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> btnID <span class="token operator">=</span> evt<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>id<span class="token punctuation">;</span>\n  <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1/?id=\'</span> <span class="token operator">+</span> btnID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于需要在事件处理函数中定义整个 Promise 链，这很丑陋。除此之外，这个设计在某种程度上破坏了关注点与功能分离（SoC）的思想。这需要一些辅助机制来实现，其中 rxjs 做出了一些抽象</p>\n<h3 id="惯性（封装回调代码）"><a href="#%E6%83%AF%E6%80%A7%EF%BC%88%E5%B0%81%E8%A3%85%E5%9B%9E%E8%B0%83%E4%BB%A3%E7%A0%81%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>惯性（封装回调代码）</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9641398589337745000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// polyfill 安全的 guard 检查\nif (!Promise.wrap) {\n  Promise.wrap = function(fn) {\n    return function() {\n      var args = [].slice.call(arguments);\n      return new Promise(function(resolve, reject) {\n        fn.apply(\n          null,\n          args.concat(function(err, v) {\n            if (err) {\n              reject(err);\n            } else {\n              resolve(v);\n            }\n          })\n        );\n      });\n    };\n  };\n}\n\nvar request = Promise.wrap(ajax);\nrequest(\'http://some.url.1/\').then();`, `9641398589337745000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// polyfill 安全的 guard 检查</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Promise<span class="token punctuation">.</span>wrap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  Promise<span class="token punctuation">.</span><span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>\n          <span class="token keyword">null</span><span class="token punctuation">,</span>\n          args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n              <span class="token function">resolve</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> request <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>ajax<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1/\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26992693294438253000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 为 ajax(..) 构造一个 promisory\nvar request = Promise.wrap(ajax);\n// 重构 foo(..)，但使其外部成为基于外部回调的，\n// 与目前代码的其他部分保持通用\n// ——只在内部使用 request(..) 的 promise\nfunction foo(x, y, cb) {\n  request(\'http://some.url.1/?x=\' + x + \'&y=\' + y).then(function fulfilled(text) {\n    cb(null, text);\n  }, cb);\n}\n// 现在，为了这段代码的目的，为 foo(..) 构造一个 promisory\nvar betterFoo = Promise.wrap(foo);\n// 并使用这个 promisory\nbetterFoo(11, 31).then(\n  function fulfilled(text) {\n    console.log(text);\n  },\n  function rejected(err) {\n    console.error(err);\n  }\n);`, `26992693294438253000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 为 ajax(..) 构造一个 promisory</span>\n<span class="token keyword">var</span> request <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>ajax<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 重构 foo(..)，但使其外部成为基于外部回调的，</span>\n<span class="token comment">// 与目前代码的其他部分保持通用</span>\n<span class="token comment">// ——只在内部使用 request(..) 的 promise</span>\n<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1/?x=\'</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">\'&amp;y=\'</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 现在，为了这段代码的目的，为 foo(..) 构造一个 promisory</span>\n<span class="token keyword">var</span> betterFoo <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 并使用这个 promisory</span>\n<span class="token function">betterFoo</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span> <span class="token function">fulfilled</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="无法取消的-promise"><a href="#%E6%97%A0%E6%B3%95%E5%8F%96%E6%B6%88%E7%9A%84-promise" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>无法取消的 Promise</h3>\n<p>一旦创建了一个 Promise 并为其注册了完成和 / 或拒绝处理函数，如果出现某种情况使得这个任务悬而未决的话，你也没有办法从外部停止它的进程。</p>\n<p>单独的一个 Promise 并不是一个真正的流程控制机制（至少不是很有意义），这正是取消所涉及的层次（流程控制）。这就是为什么 Promise 取消总是让人感觉很别扭。</p>\n<p>相比之下，集合在一起的 Promise 构成的链，我喜欢称之为一个“序列”，就是一个流程控制的表达，因此将取消定义在这个抽象层次上是合适的。</p>\n<h3 id="promise-性能"><a href="#promise-%E6%80%A7%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise 性能</h3>\n<p>几乎所有那些你可能认为 Promise 性能会慢到需要担心的情况，实际上都是通过绕开 Promise 可信任性和可组合性优化掉了它们带来的好处的反模式</p>\n<h1 id="生成器"><a href="#%E7%94%9F%E6%88%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成器</h1>\n<h2 id="打破完整运行"><a href="#%E6%89%93%E7%A0%B4%E5%AE%8C%E6%95%B4%E8%BF%90%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>打破完整运行</h2>\n<p>一个函数一旦开始执行，就会运行到结束，期间不会有其他代码能够打断它并插入其间。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81022603812502630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var x = 1;\nfunction* foo() {\n  x++;\n  yield; // 暂停！\n  console.log(\'x:\', x);\n}\nfunction bar() {\n  x++;\n}`, `81022603812502630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  x<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span><span class="token punctuation">;</span> <span class="token comment">// 暂停！</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'x:\'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  x<span class="token operator">++</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35654065551606330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 构造一个迭代器 it 来控制这个生成器\nvar it = foo();\n// 这里启动 foo()，执行到 yield 处或生成器结束\nit.next();\nx; // 2\nbar();\nx; // 3\nit.next(); // x: 3，恢复执行`, `35654065551606330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 构造一个迭代器 it 来控制这个生成器</span>\n<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 这里启动 foo()，执行到 yield 处或生成器结束</span>\nit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nx<span class="token punctuation">;</span> <span class="token comment">// 2</span>\n<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nx<span class="token punctuation">;</span> <span class="token comment">// 3</span>\nit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x: 3，恢复执行</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="输入和输出"><a href="#%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>输入和输出</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87092987528004340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo(x, y) {\n  return x * y;\n}\nvar it = foo(6, 7);\nvar res = it.next();\nres.value; // 42`, `87092987528004340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> x <span class="token operator">*</span> y<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nres<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 42</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="迭代消息传递"><a href="#%E8%BF%AD%E4%BB%A3%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>迭代消息传递</h4>\n<p>除了能够接受参数并提供返回值之外，生成器甚至提供了更强大更引人注目的内建消息输入输出能力，通过 yield 和 next(..) 实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60188080655524570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo(x) {\n  var y = x * (yield);\n  return y;\n}\nvar it = foo(6);\n// 启动 foo(..)\nit.next();\nvar res = it.next(7);\nres.value; // 42`, `60188080655524570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> y <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> y<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 启动 foo(..)</span>\nit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nres<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 42</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="两个问题的故事"><a href="#%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98%E7%9A%84%E6%95%85%E4%BA%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>两个问题的故事</h4>\n<p>只考虑生成器代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44465247123716510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var y = x * yield;\nreturn y;`, `44465247123716510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> y <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token keyword">yield</span><span class="token punctuation">;</span>\n<span class="token keyword">return</span> y<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>必须由第二个 next(..) 调用回答第一个 yield 提出的这个问题，第二个对第一个？</p>\n<p>消息是双向传递的，yield 作为一个表达式可以发出消息响应 next(..) 调用，next(..) 也可以向暂停的 yield 表达式发送值，考虑下面这段稍稍调整过的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34205013449601806000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo(x) {\n  var y = x * (yield \'Hello\'); // <-- yield 一个值！\n  return y;\n}\nvar it = foo(6);\nvar res = it.next(); // 第一个 next()，并不传入任何东西\nres.value; // &quot;Hello&quot;\nres = it.next(7); // 向等待的 yield 传入 7\nres.value; // 42`, `34205013449601806000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> y <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token string">\'Hello\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;-- yield 一个值！</span>\n  <span class="token keyword">return</span> y<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一个 next()，并不传入任何东西</span>\nres<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// "Hello"</span>\nres <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向等待的 yield 传入 7</span>\nres<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 42</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>yield .. 和 next(..) 这一对组合起来，在生成器的执行过程中构成了一个双向消息传递系统。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87925374711902110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var res = it.next(); // 第一个 next()，并不传入任何东西\nres.value; // &quot;Hello&quot;\nres = it.next(7); // 向等待的 yield 传入 7\nres.value; // 42`, `87925374711902110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一个 next()，并不传入任何东西</span>\nres<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// "Hello"</span>\nres <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 向等待的 yield 传入 7</span>\nres<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 42</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="多个迭代器"><a href="#%E5%A4%9A%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多个迭代器</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75328610006952770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo() {\n  var x = yield 2;\n  z++;\n  var y = yield x * z;\n  console.log(x, y, z);\n}\nvar z = 1;\nvar it1 = foo();\nvar it2 = foo();\nvar val1 = it1.next().value; // 2 <-- yield 2\nvar val2 = it2.next().value; // 2 <-- yield 2\nval1 = it1.next(val2 * 10).value; // 40 <-- x:20, z:2\nval2 = it2.next(val1 * 5).value; // 600 <-- x:200, z:3\nit1.next(val2 / 2); // y:300\n// 20 300 3\nit2.next(val1 / 4); // y:10\n// 200 10 3`, `75328610006952770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  z<span class="token operator">++</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token keyword">yield</span> x <span class="token operator">*</span> z<span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> z <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> it1 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> it2 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> val1 <span class="token operator">=</span> it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 2 &lt;-- yield 2</span>\n<span class="token keyword">var</span> val2 <span class="token operator">=</span> it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 2 &lt;-- yield 2</span>\nval1 <span class="token operator">=</span> it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val2 <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 40 &lt;-- x:20, z:2</span>\nval2 <span class="token operator">=</span> it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val1 <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 600 &lt;-- x:200, z:3</span>\nit1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val2 <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// y:300</span>\n<span class="token comment">// 20 300 3</span>\nit2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>val1 <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// y:10</span>\n<span class="token comment">// 200 10 3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="生成器产生值"><a href="#%E7%94%9F%E6%88%90%E5%99%A8%E4%BA%A7%E7%94%9F%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成器产生值</h2>\n<h3 id="生成者与迭代器"><a href="#%E7%94%9F%E6%88%90%E8%80%85%E4%B8%8E%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成者与迭代器</h3>\n<p>假定你要产生一系列值，其中每个值都与前面一个有特定的关系。要实现这一点，需要一个有状态的生产者能够记住其生成的最后一个值。</p>\n<p>可以实现一个直接使用函数闭包的版本：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19578083864893702000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var gimmeSomething = (function() {\n  var nextVal;\n  return function() {\n    if (nextVal === undefined) {\n      nextVal = 1;\n    } else {\n      nextVal = 3 * nextVal + 6;\n    }\n    return nextVal;\n  };\n})();\ngimmeSomething(); // 1\ngimmeSomething(); // 9\ngimmeSomething(); // 33\ngimmeSomething(); // 105`, `19578083864893702000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> gimmeSomething <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> nextVal<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextVal <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      nextVal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      nextVal <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> nextVal <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> nextVal<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">gimmeSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>\n<span class="token function">gimmeSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 9</span>\n<span class="token function">gimmeSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 33</span>\n<span class="token function">gimmeSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 105</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以为我们的数字序列生成器实现标准的迭代器接口：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="727421902017422200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var something = (function() {\n  var nextVal;\n  return {\n    // for..of 循环需要\n    [Symbol.iterator]: function() {\n      return this;\n    },\n    // 标准迭代器接口方法\n    next: function() {\n      if (nextVal === undefined) {\n        nextVal = 1;\n      } else {\n        nextVal = 3 * nextVal + 6;\n      }\n      return { done: false, value: nextVal };\n    }\n  };\n})();\nsomething.next().value; // 1\nsomething.next().value; // 9\nsomething.next().value; // 33\nsomething.next().value; // 105`, `727421902017422200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> something <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> nextVal<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token comment">// for..of 循环需要</span>\n    <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// 标准迭代器接口方法</span>\n    <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextVal <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        nextVal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        nextVal <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> nextVal <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span> done<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> nextVal <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nsomething<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 1</span>\nsomething<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 9</span>\nsomething<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 33</span>\nsomething<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 105</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或这样调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19624431223737670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (var v of something) {\n  console.log(v);\n  // 不要死循环！\n  if (v > 500) {\n    break;\n  }\n}\n// 1 9 33 105 321 969`, `19624431223737670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> something<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 不要死循环！</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">></span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">break</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 1 9 33 105 321 969</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66680592450664710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (var ret; (ret = something.next()) && !ret.done; ) {\n  console.log(ret.value);\n  // 不要死循环！\n  if (ret.value > 500) {\n    break; //这种手工 for 方法当然要比 ES6 的 for..of 循环语法丑陋，但其优点是，这样就可以在需要时向 next() 传递值。\n  }\n}\n// 1 9 33 105 321 969`, `66680592450664710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> ret<span class="token punctuation">;</span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> something<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ret<span class="token punctuation">.</span>done<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 不要死循环！</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//这种手工 for 方法当然要比 ES6 的 for..of 循环语法丑陋，但其优点是，这样就可以在需要时向 next() 传递值。</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 1 9 33 105 321 969</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="生成器中的-promise-并发"><a href="#%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%AD%E7%9A%84-promise-%E5%B9%B6%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成器中的 Promise 并发</h2>\n<p>你需要从两个不同的来源获取数据，然后把响应组合在一起以形成第三个请求，最终把最后一条响应打印出来。第 3 章已经用 Promise 研究过一个类似的场景，但是让我们在生成器的环境下重新考虑一下这个问题吧。</p>\n<p>第一次考虑代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94101070893743690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo() {\n  var r1 = yield request(\'http://some.url.1\');\n  var r2 = yield request(\'http://some.url.2\');\n  var r3 = yield request(\'http://some.url.3/?v=\' + r1 + \',\' + r2);\n  console.log(r3);\n}\n// 使用前面定义的工具 run(..)\nrun(foo);`, `94101070893743690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.3/?v=\'</span> <span class="token operator">+</span> r1 <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 使用前面定义的工具 run(..)</span>\n<span class="token function">run</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最自然有效的答案就是让异步流程基于 Promise，特别是基于它们以时间无关的方式管理状态的能力。</p>\n<p>最简单的方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92936583751364840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo() {\n  // 让两个请求&quot;并行&quot;\n  var p1 = request(\'http://some.url.1\');\n  var p2 = request(\'http://some.url.2\');\n  // 等待两个 promise 都决议\n  var r1 = yield p1;\n  var r2 = yield p2;\n  var r3 = yield request(\'http://some.url.3/?v=\' + r1 + \',\' + r2);\n  console.log(r3);\n}\n// 使用前面定义的工具 run(..)\nrun(foo);`, `92936583751364840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 让两个请求"并行"</span>\n  <span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 等待两个 promise 都决议</span>\n  <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> p1<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> p2<span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.3/?v=\'</span> <span class="token operator">+</span> r1 <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 使用前面定义的工具 run(..)</span>\n<span class="token function">run</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两个 yield 语句等待并取得 promise 的决议（分别写入 r1 和 r2 ）。如果 p1 先决议，那么 yield p1 就会先恢复执行，然后等待 yield p2 恢复。如果 p2 先决议，它就会耐心保持其决议值等待请求，但是 yield p1 将会先等待，直到 p1 决议。</p>\n<p>等价于 Promise.all([ .. ]) 工具：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94006680623448970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo() {\n  // 让两个请求&quot;并行&quot;，并等待两个 promise 都决议\n  var results = yield Promise.all([request(\'http://some.url.1\'), request(\'http://some.url.2\')]);\n  var r1 = results[0];\n  var r2 = results[1];\n  var r3 = yield request(\'http://some.url.3/?v=\' + r1 + \',\' + r2);\n  console.log(r3);\n}\n// 使用前面定义的工具 run(..)\nrun(foo);`, `94006680623448970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 让两个请求"并行"，并等待两个 promise 都决议</span>\n  <span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r1 <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r2 <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.3/?v=\'</span> <span class="token operator">+</span> r1 <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 使用前面定义的工具 run(..)</span>\n<span class="token function">run</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>更简洁的方案：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8778870718872622000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 注：普通函数，不是生成器\nfunction bar(url1, url2) {\n  return Promise.all([request(url1), request(url2)]);\n}\nfunction* foo() {\n  // 隐藏 bar(..) 内部基于 Promise 的并发细节\n  var results = yield bar(\'http://some.url.1\', \'http://some.url.2\');\n  var r1 = results[0];\n  var r2 = results[1];\n  var r3 = yield request(\'http://some.url.3/?v=\' + r1 + \',\' + r2);\n  console.log(r3);\n}\n// 使用前面定义的工具 run(..)\nrun(foo);`, `8778870718872622000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 注：普通函数，不是生成器</span>\n<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">url1<span class="token punctuation">,</span> url2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">request</span><span class="token punctuation">(</span>url1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">request</span><span class="token punctuation">(</span>url2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 隐藏 bar(..) 内部基于 Promise 的并发细节</span>\n  <span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">,</span> <span class="token string">\'http://some.url.2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r1 <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r2 <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.3/?v=\'</span> <span class="token operator">+</span> r1 <span class="token operator">+</span> <span class="token string">\',\'</span> <span class="token operator">+</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// 使用前面定义的工具 run(..)</span>\n<span class="token function">run</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想要实现一系列高级流程控制的话，那么非常有用的做法是：把你的 Promise 逻辑隐藏在一个只从生成器代码中调用的函数内部。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87517836578299800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function bar() {\n    Promise.all( [\n        baz( .. ).then( .. ),\n        Promise.race( [ .. ] )\n    ] ).then( .. )\n}`, `87517836578299800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>\n        <span class="token function">baz</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>\n        Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span> <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span>\n    <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有时候会需要这种逻辑，而如果把它直接放在生成器内部的话，那你就失去了几乎所有一开始使用生成器的理由。应该有意将这样的细节从生成器代码中抽象出来，以避免它把高层次的任务表达变得杂乱。</p>\n<h2 id="生成器委托"><a href="#%E7%94%9F%E6%88%90%E5%99%A8%E5%A7%94%E6%89%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成器委托</h2>\n<p>从一个生成器调用另一个生成器，使用辅助函数 run(..)，就像这样</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74342099371661250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo() {\n  var r2 = yield request(\'http://some.url.2\');\n  var r3 = yield request(\'http://some.url.3/?v=\' + r2);\n  return r3;\n}\nfunction* bar() {\n  var r1 = yield request(\'http://some.url.1\');\n  // 通过 run(..) &quot;委托&quot;给*foo()\n  var r3 = yield run(foo);\n  console.log(r3);\n}\nrun(bar);`, `74342099371661250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.3/?v=\'</span> <span class="token operator">+</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> r3<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 通过 run(..) "委托"给*foo()</span>\n  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">run</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">run</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们再次通过 run(..) 工具从 *bar() 内部运行 *foo() 。这里我们利用了如下事实：我们前面定义的 run(..) 返回一个 promise，这个 promise 在生成器运行结束时（或出错退出时）决议。因此，如果从一个 run(..) 调用中 yield 出来一个 promise 到另一个 run(..) 实例中，它会自动暂停 *bar() ，直到 *foo() 结束。</p>\n<p>其实还有一个更好的方法可以实现从 *bar() 调用 *foo() ，称为 yield 委托。 yield 委托的具体语法是： yield _ __（注意多出来的 _ ）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38047748388952310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo() {\n  var r2 = yield request(\'http://some.url.2\');\n  var r3 = yield request(\'http://some.url.3/?v=\' + r2);\n  return r3;\n}\nfunction* bar() {\n  var r1 = yield request(\'http://some.url.1\');\n  // 通过 yeild* &quot;委托&quot;给*foo()\n  var r3 = yield* foo();\n  console.log(r3);\n}\nrun(bar);`, `38047748388952310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.3/?v=\'</span> <span class="token operator">+</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> r3<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">\'http://some.url.1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 通过 yeild* "委托"给*foo()</span>\n  <span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r3<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">run</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>yield * 暂停了迭代控制，而不是生成器控制。当你调用 <em>foo() 生成器时，现在 yield 委托到了它的迭代器。但实际上，你可以 yield 委托到任意 iterable ， yield `</em>[1,2,3]<code class="language-text">会消耗数组值</code>[1,2,3]` 的默认迭代器。</p>\n<h3 id="为什么用委托"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8%E5%A7%94%E6%89%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么用委托</h3>\n<p>yield 委托的主要目的是代码组织，以达到与普通函数调用的对称。</p>\n<h3 id="消息委托"><a href="#%E6%B6%88%E6%81%AF%E5%A7%94%E6%89%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息委托</h3>\n<p>yield 委托是如何不只用于迭代器控制工作，也用于双向消息传递工作。认真跟踪下面的通过 yield 委托实现的消息流出入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30735108378796160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* foo() {\n  console.log(\'inside *foo():\', yield \'B\');\n  console.log(\'inside *foo():\', yield \'C\');\n  return \'D\';\n}\nfunction* bar() {\n  console.log(\'inside *bar():\', yield \'A\');\n  // yield 委托！\n  console.log(\'inside *bar():\', yield* foo());\n  console.log(\'inside *bar():\', yield \'E\');\n  return \'F\';\n}\nvar it = bar();\nconsole.log(\'outside:\', it.next().value);\n// outside: A\nconsole.log(\'outside:\', it.next(1).value);\n// inside *bar(): 1\n// outside: B\nconsole.log(\'outside:\', it.next(2).value);\n// inside *foo(): 2\n// outside: C\nconsole.log(\'outside:\', it.next(3).value);\n// inside *foo(): 3\n// inside *bar(): D\n// outside: E\nconsole.log(\'outside:\', it.next(4).value);\n// inside *bar(): 4\n// outside: F`, `30735108378796160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'inside *foo():\'</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">\'B\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'inside *foo():\'</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">\'C\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'D\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'inside *bar():\'</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">\'A\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// yield 委托！</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'inside *bar():\'</span><span class="token punctuation">,</span> <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'inside *bar():\'</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">\'E\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token string">\'F\'</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'outside:\'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// outside: A</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'outside:\'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// inside *bar(): 1</span>\n<span class="token comment">// outside: B</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'outside:\'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// inside *foo(): 2</span>\n<span class="token comment">// outside: C</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'outside:\'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// inside *foo(): 3</span>\n<span class="token comment">// inside *bar(): D</span>\n<span class="token comment">// outside: E</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'outside:\'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// inside *bar(): 4</span>\n<span class="token comment">// outside: F</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>',
excerpt:"…",timeToRead:33,tableOfContents:'<ul>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%BC%82%E6%AD%A5%EF%BC%9A%E7%8E%B0%E5%9C%A8%E4%B8%8E%E5%B0%86%E6%9D%A5">异步：现在与将来</a></p>\n<ul>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%88%86%E5%9D%97%E7%9A%84%E7%A8%8B%E5%BA%8F">分块的程序</a></p>\n<ul>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%BC%82%E6%AD%A5%E6%8E%A7%E5%88%B6%E5%8F%B0">异步控制台</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95">解决方法</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF">事件循环</a></li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%B9%B6%E8%A1%8C%E7%BA%BF%E7%A8%8B">并行线程</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%AE%8C%E6%95%B4%E8%BF%90%E8%A1%8C">完整运行</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%B9%B6%E5%8F%91">并发</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E9%9D%9E%E4%BA%A4%E4%BA%92">非交互</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%BA%A4%E4%BA%92">交互</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%8D%8F%E4%BD%9C">协作</a></li>\n</ul>\n</li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%BB%BB%E5%8A%A1">任务</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E8%AF%AD%E5%8F%A5%E9%A1%BA%E5%BA%8F">语句顺序</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%9B%9E%E8%B0%83">回调</a></p>\n<ul>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#continuation">continuation</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%B5%8C%E5%A5%97%E5%9B%9E%E8%B0%83%E4%B8%8E%E9%93%BE%E5%BC%8F%E5%9B%9E%E8%B0%83">嵌套回调与链式回调</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%BF%A1%E4%BB%BB%E9%97%AE%E9%A2%98">信任问题</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%BA%94%E4%B8%AA%E5%9B%9E%E8%B0%83%E7%9A%84%E6%95%85%E4%BA%8B">五个回调的故事</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%B8%8D%E5%8F%AA%E6%98%AF%E5%88%AB%E4%BA%BA%E7%9A%84%E4%BB%A3%E7%A0%81">不只是别人的代码</a></li>\n</ul>\n</li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E7%9C%81%E7%82%B9%E5%9B%9E%E8%B0%83">省点回调</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#promise">Promise</a></p>\n<ul>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%BB%80%E4%B9%88%E6%98%AF-promise">什么是 Promise</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E6%9C%AA%E6%9D%A5%E5%80%BC">未来值</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%AE%8C%E6%88%90%E4%BA%8B%E4%BB%B6">完成事件</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%85%B7%E6%9C%89-then-%E6%96%B9%E6%B3%95%E7%9A%84%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B">具有 then 方法的鸭子类型</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#promise-%E4%BF%A1%E4%BB%BB%E9%97%AE%E9%A2%98">Promise 信任问题</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E8%B0%83%E7%94%A8%E8%BF%87%E6%97%A9">调用过早</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E8%B0%83%E7%94%A8%E8%BF%87%E6%99%9A">调用过晚</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%9B%9E%E8%B0%83%E6%9C%AA%E8%B0%83%E7%94%A8">回调未调用</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E8%BF%87%E5%B0%91%E6%88%96%E8%BF%87%E5%A4%9A">调用次数过少或过多</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E6%9C%AA%E8%83%BD%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0--%E7%8E%AF%E5%A2%83%E5%80%BC">未能传递参数 / 环境值</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%90%9E%E6%8E%89%E9%94%99%E8%AF%AF%E6%88%96%E5%BC%82%E5%B8%B8">吞掉错误或异常</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E6%98%AF%E5%8F%AF%E4%BF%A1%E4%BB%BB%E7%9A%84-promise-%E5%90%97">是可信任的 Promise 吗</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%BB%BA%E7%AB%8B%E4%BF%A1%E4%BB%BB">建立信任</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E9%93%BE%E5%BC%8F%E6%B5%81">链式流</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E6%9C%AF%E8%AF%AD%EF%BC%9A%E5%86%B3%E8%AE%AE%E3%80%81%E5%AE%8C%E6%88%90%E4%BB%A5%E5%8F%8A%E6%8B%92%E7%BB%9D">术语：决议、完成以及拒绝</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#promise-%E6%A8%A1%E5%BC%8F">Promise 模式</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#promiseall--">Promise.all( .. )</a></li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#promiserace--">Promise.race( .. )</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E8%B6%85%E6%97%B6%E7%AB%9E%E8%B5%9B">超时竞赛</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#finally">finally</a></li>\n</ul>\n</li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#all---%E5%92%8C-race---%E7%9A%84%E5%8F%98%E4%BD%93">all( .. ) 和 race( .. ) 的变体</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%B9%B6%E5%8F%91%E8%BF%AD%E4%BB%A3">并发迭代</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#promise-%E5%B1%80%E9%99%90%E6%80%A7">Promise 局限性</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E9%A1%BA%E5%BA%8F%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">顺序错误处理</a></li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%8D%95%E4%B8%80%E5%80%BC">单一值</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%88%86%E8%A3%82%E5%80%BC">分裂值</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%B1%95%E5%BC%80--%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0">展开 / 传递参数</a></li>\n</ul>\n</li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%8D%95%E5%86%B3%E8%AE%AE">单决议</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E6%83%AF%E6%80%A7%EF%BC%88%E5%B0%81%E8%A3%85%E5%9B%9E%E8%B0%83%E4%BB%A3%E7%A0%81%EF%BC%89">惯性（封装回调代码）</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E6%97%A0%E6%B3%95%E5%8F%96%E6%B6%88%E7%9A%84-promise">无法取消的 Promise</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#promise-%E6%80%A7%E8%83%BD">Promise 性能</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E7%94%9F%E6%88%90%E5%99%A8">生成器</a></p>\n<ul>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E6%89%93%E7%A0%B4%E5%AE%8C%E6%95%B4%E8%BF%90%E8%A1%8C">打破完整运行</a></p>\n<ul>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA">输入和输出</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E8%BF%AD%E4%BB%A3%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92">迭代消息传递</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98%E7%9A%84%E6%95%85%E4%BA%8B">两个问题的故事</a></li>\n</ul>\n</li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E5%A4%9A%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8">多个迭代器</a></li>\n</ul>\n</li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E7%94%9F%E6%88%90%E5%99%A8%E4%BA%A7%E7%94%9F%E5%80%BC">生成器产生值</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E7%94%9F%E6%88%90%E8%80%85%E4%B8%8E%E8%BF%AD%E4%BB%A3%E5%99%A8">生成者与迭代器</a></li>\n</ul>\n</li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%AD%E7%9A%84-promise-%E5%B9%B6%E5%8F%91">生成器中的 Promise 并发</a></li>\n<li>\n<p><a href="/you-dont-know-js-asynchronism-and-performance/#%E7%94%9F%E6%88%90%E5%99%A8%E5%A7%94%E6%89%98">生成器委托</a></p>\n<ul>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8%E5%A7%94%E6%89%98">为什么用委托</a></li>\n<li><a href="/you-dont-know-js-asynchronism-and-performance/#%E6%B6%88%E6%81%AF%E5%A7%94%E6%89%98">消息委托</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>',wordCount:{words:2152},frontmatter:{date:"2018-11-16 14:35:13",path:"/you-dont-know-js-asynchronism-and-performance/",tags:"前端, JS, 你不知道的JS",title:"你不知道的 JS 之异步与性能",draft:null,catalog_number:null}},nextPost:{html:'<h2 id="前言"><a href="#%E5%89%8D%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前言</h2>\n<ul>\n<li>英文原版<a href="https://github.com/k88hudson/git-flight-rules/blob/master/README.md" target="_blank" rel="nofollow noreferrer noopener">README</a></li>\n<li>翻译可能存在错误或不标准的地方，欢迎大家指正和修改，谢谢！</li>\n</ul>\n<h2 id="什么是飞行规则"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%A3%9E%E8%A1%8C%E8%A7%84%E5%88%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是”飞行规则”?</h2>\n<p>一个 <a href="http://www.jsc.nasa.gov/news/columbia/fr_generic.pdf" target="_blank" rel="nofollow noreferrer noopener">宇航员指南 </a> (现在, 程序员们都在使用 GIT) 是关于出现问题过后应该怎么操作。</p>\n<blockquote>\n<p>飞行规则 (Flight Rules)- 是记录在手册上的来之不易的一系列知识，记录了某个事情发生的原因，以及怎样一步一步的进行处理。本质上, 它们是特定场景的非常详细的标准处理流程。</p>\n</blockquote>\n<blockquote>\n<p>自 20 世纪 60 年代初以来，NASA 一直在捕捉 (capturing) 我们的失误，灾难和解决方案, 当时水星时代 (Mercury-era) 的地面小组首先开始将“经验教训”收集到一个纲要 (compendium) 中，该纲现在已经有上千个问题情景，从发动机故障到破损的舱口把手到计算机故障，以及它们对应的解决方案。</p>\n</blockquote>\n<h2 id="这篇文章的约定"><a href="#%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E7%9A%84%E7%BA%A6%E5%AE%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>这篇文章的约定</h2>\n<p>为了清楚的表述，这篇文档里的所有例子使用了自定义的 bash 提示，以便指示当前分支和是否有暂存的变化 (changes)。分支名用小括号括起来，分支名后面跟的<code class="language-text">-</code>表示暂存的变化 (changes)。</p>\n<h2 id="编辑提交-editting-commits"><a href="#%E7%BC%96%E8%BE%91%E6%8F%90%E4%BA%A4-editting-commits" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编辑提交 (editting commits)</h2>\n<h3 id="我刚才提交了什么"><a href="#%E6%88%91%E5%88%9A%E6%89%8D%E6%8F%90%E4%BA%A4%E4%BA%86%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我刚才提交了什么?</h3>\n<p>如果你用 <code class="language-text">git commit -a</code> 提交了一次变化 (changes)，而你又不确定到底这次提交了哪些内容。你就可以用下面的命令显示当前<code class="language-text">HEAD</code>上的最近一次的提交 (commit):</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27030459142079600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git show`, `27030459142079600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git show</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>或者</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81222482006170930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git log -n1 -p`, `81222482006170930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git log<span class="token parameter"> -n1</span><span class="token parameter"> -p</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我的提交信息-commit-message-写错了"><a href="#%E6%88%91%E7%9A%84%E6%8F%90%E4%BA%A4%E4%BF%A1%E6%81%AF-commit-message-%E5%86%99%E9%94%99%E4%BA%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我的提交信息 (commit message) 写错了</h3>\n<p>如果你的提交信息 (commit message) 写错了且这次提交 (commit) 还没有推 (push), 你可以通过下面的方法来修改提交信息 (commit message):</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74710681410055700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git commit --amend`, `74710681410055700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git commit<span class="token parameter"> --amend</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这会打开你的默认编辑器, 在这里你可以编辑信息。另一方面, 你也可以用一条命令一次完成：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98661041031988230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git commit --amend -m \'xxxxxxx\'`, `98661041031988230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git commit<span class="token parameter"> --amend</span><span class="token parameter"> -m</span> </span><span class="token string">\'xxxxxxx\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果你已经推 (push) 了这次提交 (commit), 你可以修改这次提交 (commit) 然后强推 (force push), 但是不推荐这么做。</p>\n<h3 id="我提交-commit-里的用户名和邮箱不对"><a href="#%E6%88%91%E6%8F%90%E4%BA%A4-commit-%E9%87%8C%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E9%82%AE%E7%AE%B1%E4%B8%8D%E5%AF%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我提交 (commit) 里的用户名和邮箱不对</h3>\n<p>如果这只是单个提交 (commit)，修改它：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44438823951856500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git commit --amend --author &quot;New Authorname <authoremail@mydomain.com>&quot;`, `44438823951856500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git commit<span class="token parameter"> --amend</span><span class="token parameter"> --author</span> </span><span class="token string">"New Authorname &lt;authoremail@mydomain.com>"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果你需要修改所有历史, 参考 ‘git filter-branch’ 的指南页.</p>\n<h3 id="我想从一个提交-commit-里移除一个文件"><a href="#%E6%88%91%E6%83%B3%E4%BB%8E%E4%B8%80%E4%B8%AA%E6%8F%90%E4%BA%A4-commit-%E9%87%8C%E7%A7%BB%E9%99%A4%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想从一个提交 (commit) 里移除一个文件</h3>\n<p>通过下面的方法，从一个提交 (commit) 里移除一个文件:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41521131524757940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git checkout HEAD^ myfile\n\\$ git add -A\n\\$ git commit --amend`, `41521131524757940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git checkout HEAD^ myfile</span>\n<span class="token command">$ git add<span class="token parameter"> -A</span></span>\n<span class="token command">$ git commit<span class="token parameter"> --amend</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这将非常有用，当你有一个开放的补丁 (open patch)，你往上面提交了一个不必要的文件，你需要强推 (force push) 去更新这个远程补丁。</p>\n<h3 id="我想删除我的最后一次提交-commit"><a href="#%E6%88%91%E6%83%B3%E5%88%A0%E9%99%A4%E6%88%91%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E6%AC%A1%E6%8F%90%E4%BA%A4-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想删除我的最后一次提交 (commit)</h3>\n<p>如果你需要删除推了的提交 (pushed commits)，你可以使用下面的方法。可是，这会不可逆的改变你的历史，也会搞乱那些已经从该仓库拉取 (pulled) 了的人的历史。简而言之，如果你不是很确定，千万不要这么做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56834903285832696000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git reset HEAD^ --hard\n\\$ git push -f [remote] [branch]`, `56834903285832696000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git reset HEAD^<span class="token parameter"> --hard</span></span>\n<span class="token command">$ git push<span class="token parameter"> -f</span> [remote] [branch]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你还没有推到远程, 把 Git 重置 (reset) 到你最后一次提交前的状态就可以了 (同时保存暂存的变化):</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31999955713049076000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch-)\\$ git reset --soft HEAD@{1}`, `31999955713049076000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span>my<span class="token operator">-</span>branch<span class="token operator">-</span><span class="token punctuation">)</span>$ git reset <span class="token operator">--</span>soft <span class="token constant">HEAD</span>@<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这只能在没有推送之前有用。如果你已经推了, 唯一安全能做的是 <code class="language-text">git revert SHAofBadCommit</code>， 那会创建一个新的提交 (commit) 用于撤消前一个提交的所有变化 (changes)；或者, 如果你推的这个分支是 rebase-safe 的（例如：其它开发者不会从这个分支拉）, 只需要使用 <code class="language-text">git push -f</code> ；更多, 请参考 <a href="#deleteremove-last-pushed-commit">the above section</a>。</p>\n<h3 id="删除任意提交-commit"><a href="#%E5%88%A0%E9%99%A4%E4%BB%BB%E6%84%8F%E6%8F%90%E4%BA%A4-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除任意提交 (commit)</h3>\n<p>同样的警告：不到万不得已的时候不要这么做.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35935531654019215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git rebase --onto SHA1_OF_BAD_COMMIT^ SHA1_OF_BAD_COMMIT\n\\$ git push -f [remote] [branch]`, `35935531654019215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git rebase<span class="token parameter"> --onto</span> SHA1_OF_BAD_COMMIT^ SHA1_OF_BAD_COMMIT</span>\n<span class="token command">$ git push<span class="token parameter"> -f</span> [remote] [branch]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>或者做一个 <a href="#interactive-rebase">交互式 rebase</a> 删除那些你想要删除的提交 (commit) 里所对应的行。</p>\n<h3 id="我尝试推一个修正后的提交-amended-commit-到远程，但是报错："><a href="#%E6%88%91%E5%B0%9D%E8%AF%95%E6%8E%A8%E4%B8%80%E4%B8%AA%E4%BF%AE%E6%AD%A3%E5%90%8E%E7%9A%84%E6%8F%90%E4%BA%A4-amended-commit-%E5%88%B0%E8%BF%9C%E7%A8%8B%EF%BC%8C%E4%BD%86%E6%98%AF%E6%8A%A5%E9%94%99%EF%BC%9A" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我尝试推一个修正后的提交 (amended commit) 到远程，但是报错：</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89674096499481330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`To https://github.com/yourusername/repo.git\n! [rejected]        mybranch -> mybranch (non-fast-forward)\nerror: failed to push some refs to \'https://github.com/tanay1337/webmaker.org.git\'\nhint: Updates were rejected because the tip of your current branch is behind\nhint: its remote counterpart. Integrate the remote changes (e.g.\nhint: \'git pull ...\') before pushing again.\nhint: See the \'Note about fast-forwards\' in \'git push --help\' for details.`, `89674096499481330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git">To https://github.com/yourusername/repo.git\n! [rejected]        mybranch -> mybranch (non-fast-forward)\nerror: failed to push some refs to <span class="token string">\'https://github.com/tanay1337/webmaker.org.git\'</span>\nhint: Updates were rejected because the tip of your current branch is behind\nhint: its remote counterpart. Integrate the remote changes (e.g.\nhint: <span class="token string">\'git pull ...\'</span>) before pushing again.\nhint: See the <span class="token string">\'Note about fast-forwards\'</span> in <span class="token string">\'git push --help\'</span> for details.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意, rebasing(见下面) 和修正 (amending) 会用一个新的提交 (commit) 代替旧的，所以如果之前你已经往远程仓库上推过一次修正前的提交 (commit)，那你现在就必须强推 (force push) (<code class="language-text">-f</code>)。 注意：总是确保你指明一个分支!</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39100567760167530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git push origin mybranch -f`, `39100567760167530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git push origin mybranch<span class="token parameter"> -f</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>一般来说, 要避免强推。最好是创建和推 (push) 一个新的提交 (commit)，而不是强推一个修正后的提交。后者会使那些与该分支或该分支的子分支工作的开发者，在源历史中产生冲突。</p>\n<h3 id="我意外的做了一次硬重置-hard-reset，我想找回我的内容"><a href="#%E6%88%91%E6%84%8F%E5%A4%96%E7%9A%84%E5%81%9A%E4%BA%86%E4%B8%80%E6%AC%A1%E7%A1%AC%E9%87%8D%E7%BD%AE-hard-reset%EF%BC%8C%E6%88%91%E6%83%B3%E6%89%BE%E5%9B%9E%E6%88%91%E7%9A%84%E5%86%85%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我意外的做了一次硬重置 (hard reset)，我想找回我的内容</h3>\n<p>如果你意外的做了 <code class="language-text">git reset --hard</code>, 你通常能找回你的提交 (commit), 因为 Git 对每件事都会有日志，且都会保存几天。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65345267338548930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reflog`, `65345267338548930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git reflog</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>你将会看到一个你过去提交 (commit) 的列表和一个重置的提交。选择你想要回到的提交 (commit) 的 SHA，再重置一次：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88858123145454980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reset --hard SHA1234`, `88858123145454980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git reset<span class="token parameter"> --hard</span> SHA1234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样就完成了。</p>\n<h2 id="暂存-staging"><a href="#%E6%9A%82%E5%AD%98-staging" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>暂存 (Staging)</h2>\n<h3 id="我需要把暂存的内容添加到上一次的提交-commit"><a href="#%E6%88%91%E9%9C%80%E8%A6%81%E6%8A%8A%E6%9A%82%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9%E6%B7%BB%E5%8A%A0%E5%88%B0%E4%B8%8A%E4%B8%80%E6%AC%A1%E7%9A%84%E6%8F%90%E4%BA%A4-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我需要把暂存的内容添加到上一次的提交 (commit)</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49704840597318300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch-)\\$ git commit --amend`, `49704840597318300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch-)$ git commit<span class="token parameter"> --amend</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我想要暂存一个新文件的一部分，而不是这个文件的全部"><a href="#%E6%88%91%E6%83%B3%E8%A6%81%E6%9A%82%E5%AD%98%E4%B8%80%E4%B8%AA%E6%96%B0%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E8%BF%99%E4%B8%AA%E6%96%87%E4%BB%B6%E7%9A%84%E5%85%A8%E9%83%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想要暂存一个新文件的一部分，而不是这个文件的全部</h3>\n<p>一般来说, 如果你想暂存一个文件的一部分, 你可这样做:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75837979790935540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git add --patch filename.x`, `75837979790935540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git add<span class="token parameter"> --patch</span> filename.x</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">-p</code> 简写。这会打开交互模式， 你将能够用 <code class="language-text">s</code> 选项来分隔提交 (commit)； 然而, 如果这个文件是新的, 会没有这个选择， 添加一个新文件时, 这样做:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86921613045983200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git add -N filename.x`, `86921613045983200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git add<span class="token parameter"> -N</span> filename.x</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后, 你需要用 <code class="language-text">e</code> 选项来手动选择需要添加的行，执行 <code class="language-text">git diff --cached</code> 将会显示哪些行暂存了哪些行只是保存在本地了。</p>\n<p><a href="stage-in-two-commits"></a></p>\n<h3 id="我想把在一个文件里的变化-changes-加到两个提交-commit-里"><a href="#%E6%88%91%E6%83%B3%E6%8A%8A%E5%9C%A8%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E9%87%8C%E7%9A%84%E5%8F%98%E5%8C%96-changes-%E5%8A%A0%E5%88%B0%E4%B8%A4%E4%B8%AA%E6%8F%90%E4%BA%A4-commit-%E9%87%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想把在一个文件里的变化 (changes) 加到两个提交 (commit) 里</h3>\n<p><code class="language-text">git add</code> 会把整个文件加入到一个提交。<code class="language-text">git add -p</code> 允许交互式的选择你想要提交的部分.</p>\n<h3 id="我想把暂存的内容变成未暂存，把未暂存的内容暂存起来"><a href="#%E6%88%91%E6%83%B3%E6%8A%8A%E6%9A%82%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9%E5%8F%98%E6%88%90%E6%9C%AA%E6%9A%82%E5%AD%98%EF%BC%8C%E6%8A%8A%E6%9C%AA%E6%9A%82%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9%E6%9A%82%E5%AD%98%E8%B5%B7%E6%9D%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想把暂存的内容变成未暂存，把未暂存的内容暂存起来</h3>\n<p>这个有点困难， 我能想到的最好的方法是先 stash 未暂存的内容， 然后重置 (reset)，再 pop 第一步 stashed 的内容, 最后再 add 它们。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94779502167992800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git stash -k\n\\$ git reset --hard\n\\$ git stash pop\n\\$ git add -A`, `94779502167992800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git stash<span class="token parameter"> -k</span></span>\n<span class="token command">$ git reset<span class="token parameter"> --hard</span></span>\n<span class="token command">$ git stash pop</span>\n<span class="token command">$ git add<span class="token parameter"> -A</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="未暂存-unstaged-的内容"><a href="#%E6%9C%AA%E6%9A%82%E5%AD%98-unstaged-%E7%9A%84%E5%86%85%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>未暂存 (Unstaged) 的内容</h2>\n<h3 id="我想把未暂存的内容移动到一个新分支"><a href="#%E6%88%91%E6%83%B3%E6%8A%8A%E6%9C%AA%E6%9A%82%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9%E7%A7%BB%E5%8A%A8%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%88%86%E6%94%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想把未暂存的内容移动到一个新分支</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22276447481348870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git checkout -b my-branch`, `22276447481348870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git checkout<span class="token parameter"> -b</span> my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我想把未暂存的内容移动到另一个已存在的分支"><a href="#%E6%88%91%E6%83%B3%E6%8A%8A%E6%9C%AA%E6%9A%82%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9%E7%A7%BB%E5%8A%A8%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%B7%B2%E5%AD%98%E5%9C%A8%E7%9A%84%E5%88%86%E6%94%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想把未暂存的内容移动到另一个已存在的分支</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75316816380784380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git stash\n\\$ git checkout my-branch\n\\$ git stash pop`, `75316816380784380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git stash</span>\n<span class="token command">$ git checkout my-branch</span>\n<span class="token command">$ git stash pop</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="我想丢弃本地未提交的变化-uncommitted-changes"><a href="#%E6%88%91%E6%83%B3%E4%B8%A2%E5%BC%83%E6%9C%AC%E5%9C%B0%E6%9C%AA%E6%8F%90%E4%BA%A4%E7%9A%84%E5%8F%98%E5%8C%96-uncommitted-changes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想丢弃本地未提交的变化 (uncommitted changes)</h3>\n<p>如果你只是想重置源 (origin) 和你本地 (local) 之间的一些提交 (commit)，你可以：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58993446015637160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# one commit\n(my-branch)\\$ git reset --hard HEAD^\n# two commits\n(my-branch)\\$ git reset --hard HEAD^^\n# four commits\n(my-branch)\\$ git reset --hard HEAD~4\n# or\n(master)\\$ git checkout -f`, `58993446015637160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token comment"># one commit</span>\n<span class="token command">(my-branch)$ git reset<span class="token parameter"> --hard</span> HEAD^</span>\n<span class="token comment"># two commits</span>\n<span class="token command">(my-branch)$ git reset<span class="token parameter"> --hard</span> HEAD^^</span>\n<span class="token comment"># four commits</span>\n<span class="token command">(my-branch)$ git reset<span class="token parameter"> --hard</span> HEAD~4</span>\n<span class="token comment"># or</span>\n<span class="token command">(master)$ git checkout<span class="token parameter"> -f</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>重置某个特殊的文件, 你可以用文件名做为参数:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17902786629919310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git reset filename`, `17902786629919310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git reset filename</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我想丢弃某些未暂存的内容"><a href="#%E6%88%91%E6%83%B3%E4%B8%A2%E5%BC%83%E6%9F%90%E4%BA%9B%E6%9C%AA%E6%9A%82%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想丢弃某些未暂存的内容</h3>\n<p>如果你想丢弃工作拷贝中的一部分内容，而不是全部。</p>\n<p>签出 (checkout) 不需要的内容，保留需要的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76869233574683180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git checkout -p\n# Answer y to all of the snippets you want to drop`, `76869233574683180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git checkout<span class="token parameter"> -p</span></span>\n<span class="token comment"># Answer y to all of the snippets you want to drop</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>另外一个方法是使用 <code class="language-text">stash</code>， Stash 所有要保留下的内容, 重置工作拷贝, 重新应用保留的部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44838784230900840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git stash -p\n# Select all of the snippets you want to save\n\\$ git reset --hard\n\\$ git stash pop`, `44838784230900840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git stash<span class="token parameter"> -p</span></span>\n<span class="token comment"># Select all of the snippets you want to save</span>\n<span class="token command">$ git reset<span class="token parameter"> --hard</span></span>\n<span class="token command">$ git stash pop</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者, stash 你不需要的部分, 然后 stash drop。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34234615508150410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git stash -p\n# Select all of the snippets you don\'t want to save\n\\$ git stash drop`, `34234615508150410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git stash<span class="token parameter"> -p</span></span>\n<span class="token comment"># Select all of the snippets you don\'t want to save</span>\n<span class="token command">$ git stash drop</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h2 id="分支-branches"><a href="#%E5%88%86%E6%94%AF-branches" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分支 (Branches)</h2>\n<h3 id="我从错误的分支拉取了内容，或把内容拉取到了错误的分支"><a href="#%E6%88%91%E4%BB%8E%E9%94%99%E8%AF%AF%E7%9A%84%E5%88%86%E6%94%AF%E6%8B%89%E5%8F%96%E4%BA%86%E5%86%85%E5%AE%B9%EF%BC%8C%E6%88%96%E6%8A%8A%E5%86%85%E5%AE%B9%E6%8B%89%E5%8F%96%E5%88%B0%E4%BA%86%E9%94%99%E8%AF%AF%E7%9A%84%E5%88%86%E6%94%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我从错误的分支拉取了内容，或把内容拉取到了错误的分支</h3>\n<p>这是另外一种使用 <code class="language-text">git reflog</code> 情况，找到在这次错误拉 (pull) 之前 HEAD 的指向。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14864054328655206000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reflog\nab7555f HEAD@{0}: pull origin wrong-branch: Fast-forward\nc5bc55a HEAD@{1}: checkout: checkout message goes here`, `14864054328655206000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git reflog</span>\nab7555f HEAD@{0}: pull origin wrong-branch: Fast-forward\nc5bc55a HEAD@{1}: checkout: checkout message goes here</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>重置分支到你所需的提交 (desired commit):</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51350010250159930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git reset --hard c5bc55a`, `51350010250159930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git reset<span class="token parameter"> --hard</span> c5bc55a</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>完成。</p>\n<h3 id="我想扔掉本地的提交-commit，以便我的分支与远程的保持一致"><a href="#%E6%88%91%E6%83%B3%E6%89%94%E6%8E%89%E6%9C%AC%E5%9C%B0%E7%9A%84%E6%8F%90%E4%BA%A4-commit%EF%BC%8C%E4%BB%A5%E4%BE%BF%E6%88%91%E7%9A%84%E5%88%86%E6%94%AF%E4%B8%8E%E8%BF%9C%E7%A8%8B%E7%9A%84%E4%BF%9D%E6%8C%81%E4%B8%80%E8%87%B4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想扔掉本地的提交 (commit)，以便我的分支与远程的保持一致</h3>\n<p>先确认你没有推 (push) 你的内容到远程。</p>\n<p><code class="language-text">git status</code> 会显示你领先 (ahead) 源 (origin) 多少个提交:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55903468153229260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git status\n# On branch my-branch\n# Your branch is ahead of \'origin/my-branch\' by 2 commits.\n#   (use &quot;git push&quot; to publish your local commits)\n#`, `55903468153229260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git status</span>\n<span class="token comment"># On branch my-branch</span>\n<span class="token comment"># Your branch is ahead of \'origin/my-branch\' by 2 commits.</span>\n<span class="token comment">#   (use "git push" to publish your local commits)</span>\n<span class="token comment">#</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一种方法是:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57288771572058250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reset --hard origin/my-branch`, `57288771572058250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git reset<span class="token parameter"> --hard</span> origin/my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我需要提交到一个新分支，但错误的提交到了-master"><a href="#%E6%88%91%E9%9C%80%E8%A6%81%E6%8F%90%E4%BA%A4%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%88%86%E6%94%AF%EF%BC%8C%E4%BD%86%E9%94%99%E8%AF%AF%E7%9A%84%E6%8F%90%E4%BA%A4%E5%88%B0%E4%BA%86-master" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我需要提交到一个新分支，但错误的提交到了 master</h3>\n<p>在 master 下创建一个新分支，不切换到新分支,仍在 master 下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27071997356759890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git branch my-branch`, `27071997356759890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git branch my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>把 master 分支重置到前一个提交:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2475216633257693000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reset --hard HEAD^`, `2475216633257693000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git reset<span class="token parameter"> --hard</span> HEAD^</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><code class="language-text">HEAD^</code> 是 <code class="language-text">HEAD^1</code> 的简写，你可以通过指定要设置的<code class="language-text">HEAD</code>来进一步重置。</p>\n<p>或者, 如果你不想使用 <code class="language-text">HEAD^</code>, 找到你想重置到的提交 (commit) 的 hash(<code class="language-text">git log</code> 能够完成)， 然后重置到这个 hash。 使用<code class="language-text">git push</code> 同步内容到远程。</p>\n<p>例如, master 分支想重置到的提交的 hash 为<code class="language-text">a13b85e</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71141160787666190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reset --hard a13b85e\nHEAD is now at a13b85e`, `71141160787666190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git reset<span class="token parameter"> --hard</span> a13b85e</span>\nHEAD is now at a13b85e</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>签出 (checkout) 刚才新建的分支继续工作:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69954991603499205000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git checkout my-branch`, `69954991603499205000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git checkout my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我想保留来自另外一个-ref-ish-的整个文件"><a href="#%E6%88%91%E6%83%B3%E4%BF%9D%E7%95%99%E6%9D%A5%E8%87%AA%E5%8F%A6%E5%A4%96%E4%B8%80%E4%B8%AA-ref-ish-%E7%9A%84%E6%95%B4%E4%B8%AA%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想保留来自另外一个 ref-ish 的整个文件</h3>\n<p>假设你正在做一个原型方案 (原文为 working spike (see note)), 有成百的内容，每个都工作得很好。现在, 你提交到了一个分支，保存工作内容:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94608294373463230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(solution)\\$ git add -A && git commit -m &quot;Adding all changes from this spike into one big commit.&quot;`, `94608294373463230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(solution)$ git add<span class="token parameter"> -A</span> &amp;&amp; git commit<span class="token parameter"> -m</span> </span><span class="token string">"Adding all changes from this spike into one big commit."</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当你想要把它放到一个分支里 (可能是<code class="language-text">feature</code>, 或者 <code class="language-text">develop</code>), 你关心是保持整个文件的完整，你想要一个大的提交分隔成比较小。</p>\n<p>假设你有:</p>\n<ul>\n<li>分支 <code class="language-text">solution</code>, 拥有原型方案， 领先 <code class="language-text">develop</code> 分支。</li>\n<li>分支 <code class="language-text">develop</code>, 在这里你应用原型方案的一些内容。</li>\n</ul>\n<p>我去可以通过把内容拿到你的分支里，来解决这个问题:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62305478780371520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(develop)\\$ git checkout solution -- file1.txt`, `62305478780371520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(develop)$ git checkout solution -- file1.txt</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这会把这个文件内容从分支 <code class="language-text">solution</code> 拿到分支 <code class="language-text">develop</code> 里来:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71765696341984930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# On branch develop\n# Your branch is up-to-date with \'origin/develop\'.\n# Changes to be committed:\n#  (use &quot;git reset HEAD <file>...&quot; to unstage)\n#\n#        modified:   file1.txt`, `71765696341984930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token comment"># On branch develop</span>\n<span class="token comment"># Your branch is up-to-date with \'origin/develop\'.</span>\n<span class="token comment"># Changes to be committed:</span>\n<span class="token comment">#  (use "git reset HEAD &lt;file>..." to unstage)</span>\n<span class="token comment">#</span>\n<span class="token comment">#        modified:   file1.txt</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后, 正常提交。</p>\n<p>Note: Spike solutions are made to analyze or solve the problem. These solutions are used for estimation and discarded once everyone gets clear visualization of the problem. ~ <a href="https://en.wikipedia.org/wiki/Extreme_programming_practices" target="_blank" rel="nofollow noreferrer noopener">Wikipedia</a>.</p>\n<h3 id="我把几个提交-commit-提交到了同一个分支，而这些提交应该分布在不同的分支里"><a href="#%E6%88%91%E6%8A%8A%E5%87%A0%E4%B8%AA%E6%8F%90%E4%BA%A4-commit-%E6%8F%90%E4%BA%A4%E5%88%B0%E4%BA%86%E5%90%8C%E4%B8%80%E4%B8%AA%E5%88%86%E6%94%AF%EF%BC%8C%E8%80%8C%E8%BF%99%E4%BA%9B%E6%8F%90%E4%BA%A4%E5%BA%94%E8%AF%A5%E5%88%86%E5%B8%83%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E5%88%86%E6%94%AF%E9%87%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我把几个提交 (commit) 提交到了同一个分支，而这些提交应该分布在不同的分支里</h3>\n<p>假设你有一个<code class="language-text">master</code>分支， 执行<code class="language-text">git log</code>, 你看到你做过两次提交:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17273509079876192000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git log\n\ncommit e3851e817c451cc36f2e6f3049db528415e3c114\nAuthor: Alex Lee <alexlee@example.com>\nDate:   Tue Jul 22 15:39:27 2014 -0400\n\n    Bug #21 - Added CSRF protection\n\ncommit 5ea51731d150f7ddc4a365437931cd8be3bf3131\nAuthor: Alex Lee <alexlee@example.com>\nDate:   Tue Jul 22 15:39:12 2014 -0400\n\n    Bug #14 - Fixed spacing on title\n\ncommit a13b85e984171c6e2a1729bb061994525f626d14\nAuthor: Aki Rose <akirose@example.com>\nDate:   Tue Jul 21 01:12:48 2014 -0400\n\n    First commit`, `17273509079876192000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git log</span>\n\n<span class="token commit_sha1">commit e3851e817c451cc36f2e6f3049db528415e3c114</span>\nAuthor: Alex Lee &lt;alexlee@example.com>\nDate:   Tue Jul 22 15:39:27 2014 -0400\n\n    Bug #21 - Added CSRF protection\n\n<span class="token commit_sha1">commit 5ea51731d150f7ddc4a365437931cd8be3bf3131</span>\nAuthor: Alex Lee &lt;alexlee@example.com>\nDate:   Tue Jul 22 15:39:12 2014 -0400\n\n    Bug #14 - Fixed spacing on title\n\n<span class="token commit_sha1">commit a13b85e984171c6e2a1729bb061994525f626d14</span>\nAuthor: Aki Rose &lt;akirose@example.com>\nDate:   Tue Jul 21 01:12:48 2014 -0400\n\n    First commit</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让我们用提交 hash(commit hash) 标记 bug (<code class="language-text">e3851e8</code> for #21, <code class="language-text">5ea5173</code> for #14).</p>\n<p>首先, 我们把<code class="language-text">master</code>分支重置到正确的提交 (<code class="language-text">a13b85e</code>):</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56592436621468750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reset --hard a13b85e\nHEAD is now at a13b85e`, `56592436621468750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git reset<span class="token parameter"> --hard</span> a13b85e</span>\nHEAD is now at a13b85e</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>现在, 我们对 bug #21 创建一个新的分支:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49706993996693720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git checkout -b 21\n(21)\\$`, `49706993996693720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git checkout<span class="token parameter"> -b</span> 21</span>\n(21)$</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>接着, 我们用 -cherry-pick- 把对 bug #21 的提交放入当前分支。 这意味着我们将应用 (apply) 这个提交 (commit)，仅仅这一个提交 (commit)，直接在 HEAD 上面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81685544117839170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(21)\\$ git cherry-pick e3851e8`, `81685544117839170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(21)$ git cherry-pick e3851e8</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这时候, 这里可能会产生冲突， 参见<a href="#interactive-rebase">交互式 rebasing 章 </a> <a href="#merge-conflict">—冲突节—</a> 解决冲突.</p>\n<p>再者， 我们为 bug #14 创建一个新的分支, 也基于<code class="language-text">master</code>分支</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13389382434459374000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(21)\\$ git checkout master\n(master)\\$ git checkout -b 14\n(14)\\$`, `13389382434459374000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(21)$ git checkout master</span>\n<span class="token command">(master)$ git checkout<span class="token parameter"> -b</span> 14</span>\n(14)$</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>最后, 为 bug #14 执行 <code class="language-text">cherry-pick</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41440476494920910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(14)\\$ git cherry-pick 5ea5173`, `41440476494920910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(14)$ git cherry-pick 5ea5173</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我想删除上游-upstream-分支被删除了的本地分支"><a href="#%E6%88%91%E6%83%B3%E5%88%A0%E9%99%A4%E4%B8%8A%E6%B8%B8-upstream-%E5%88%86%E6%94%AF%E8%A2%AB%E5%88%A0%E9%99%A4%E4%BA%86%E7%9A%84%E6%9C%AC%E5%9C%B0%E5%88%86%E6%94%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想删除上游 (upstream) 分支被删除了的本地分支</h3>\n<p>一旦你在 github 上面合并 (merge) 了一个 pull request, 你就可以删除你 fork 里被合并的分支。 如果你不准备继续在这个分支里工作, 删除这个分支的本地拷贝会更干净，使你不会陷入工作分支和一堆陈旧分支的混乱之中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15643404380983329000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git fetch -p`, `15643404380983329000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git fetch<span class="token parameter"> -p</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我不小心删除了我的分支"><a href="#%E6%88%91%E4%B8%8D%E5%B0%8F%E5%BF%83%E5%88%A0%E9%99%A4%E4%BA%86%E6%88%91%E7%9A%84%E5%88%86%E6%94%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我不小心删除了我的分支</h3>\n<p>如果你定期推送到远程, 多数情况下应该是安全的，但有些时候还是可能删除了还没有推到远程的分支。 让我们先创建一个分支和一个新的文件:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65897350665596125000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git checkout -b my-branch\n(my-branch)\\$ git branch\n(my-branch)\\$ touch foo.txt\n(my-branch)\\$ ls\nREADME.md foo.txt`, `65897350665596125000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git checkout<span class="token parameter"> -b</span> my-branch</span>\n<span class="token command">(my-branch)$ git branch</span>\n(my-branch)$ touch foo.txt\n(my-branch)$ ls\nREADME.md foo.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>添加文件并做一次提交</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96050160816017000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git add .\n(my-branch)\\$ git commit -m \'foo.txt added\'\n(my-branch)\\$ foo.txt added\n 1 files changed, 1 insertions(+)\n create mode 100644 foo.txt\n(my-branch)\\$ git log\n\ncommit 4e3cd85a670ced7cc17a2b5d8d3d809ac88d5012\nAuthor: siemiatj <siemiatj@example.com>\nDate:   Wed Jul 30 00:34:10 2014 +0200\n\n    foo.txt added\n\ncommit 69204cdf0acbab201619d95ad8295928e7f411d5\nAuthor: Kate Hudson <katehudson@example.com>\nDate:   Tue Jul 29 13:14:46 2014 -0400\n\n    Fixes #6: Force pushing after amending commits`, `96050160816017000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git add .</span>\n<span class="token command">(my-branch)$ git commit<span class="token parameter"> -m</span> </span><span class="token string">\'foo.txt added\'</span>\n(my-branch)$ foo.txt added\n 1 files changed, 1 insertions(+)\n create mode 100644 foo.txt\n<span class="token command">(my-branch)$ git log</span>\n\n<span class="token commit_sha1">commit 4e3cd85a670ced7cc17a2b5d8d3d809ac88d5012</span>\nAuthor: siemiatj &lt;siemiatj@example.com>\nDate:   Wed Jul 30 00:34:10 2014 +0200\n\n    foo.txt added\n\n<span class="token commit_sha1">commit 69204cdf0acbab201619d95ad8295928e7f411d5</span>\nAuthor: Kate Hudson &lt;katehudson@example.com>\nDate:   Tue Jul 29 13:14:46 2014 -0400\n\n    Fixes #6: Force pushing after amending commits</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们切回到主 (master) 分支，‘不小心的’删除<code class="language-text">my-branch</code>分支</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67811270181317790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git checkout master\nSwitched to branch \'master\'\nYour branch is up-to-date with \'origin/master\'.\n(master)\\$ git branch -D my-branch\nDeleted branch my-branch (was 4e3cd85).\n(master)\\$ echo oh noes, deleted my branch!\noh noes, deleted my branch!`, `67811270181317790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git checkout master</span>\nSwitched to branch <span class="token string">\'master\'</span>\nYour branch is up-to-date with <span class="token string">\'origin/master\'</span>.\n<span class="token command">(master)$ git branch<span class="token parameter"> -D</span> my-branch</span>\nDeleted branch my-branch (was 4e3cd85).\n(master)$ echo oh noes, deleted my branch!\noh noes, deleted my branch!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这时候你应该想起了<code class="language-text">reflog</code>, 一个升级版的日志，它存储了仓库 (repo) 里面所有动作的历史。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80087457973299090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reflog\n69204cd HEAD@{0}: checkout: moving from my-branch to master\n4e3cd85 HEAD@{1}: commit: foo.txt added\n69204cd HEAD@{2}: checkout: moving from master to my-branch`, `80087457973299090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span>master<span class="token punctuation">)</span>$ git reflog\n<span class="token number">69204</span>cd <span class="token constant">HEAD</span>@<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">:</span> checkout<span class="token punctuation">:</span> moving <span class="token keyword">from</span> my<span class="token operator">-</span>branch to master\n<span class="token number">4e3</span>cd85 <span class="token constant">HEAD</span>@<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">:</span> commit<span class="token punctuation">:</span> foo<span class="token punctuation">.</span>txt added\n<span class="token number">69204</span>cd <span class="token constant">HEAD</span>@<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">:</span> checkout<span class="token punctuation">:</span> moving <span class="token keyword">from</span> master to my<span class="token operator">-</span>branch</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>正如你所见，我们有一个来自删除分支的提交 hash(commit hash)，接下来看看是否能恢复删除了的分支。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47199432786698340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git checkout -b my-branch-help\nSwitched to a new branch \'my-branch-help\'\n(my-branch-help)\\$ git reset --hard 4e3cd85\nHEAD is now at 4e3cd85 foo.txt added\n(my-branch-help)\\$ ls\nREADME.md foo.txt`, `47199432786698340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git checkout<span class="token parameter"> -b</span> my-branch-help</span>\nSwitched to a new branch <span class="token string">\'my-branch-help\'</span>\n<span class="token command">(my-branch-help)$ git reset<span class="token parameter"> --hard</span> 4e3cd85</span>\nHEAD is now at 4e3cd85 foo.txt added\n(my-branch-help)$ ls\nREADME.md foo.txt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看! 我们把删除的文件找回来了。 Git 的 <code class="language-text">reflog</code> 在 rebasing 出错的时候也是同样有用的。</p>\n<h3 id="我想删除一个分支"><a href="#%E6%88%91%E6%83%B3%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E5%88%86%E6%94%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想删除一个分支</h3>\n<p>删除一个远程分支:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66122174154536360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git push origin --delete my-branch`, `66122174154536360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git push origin<span class="token parameter"> --delete</span> my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>你也可以:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92643460609747090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git push origin :my-branch`, `92643460609747090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git push origin :my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>删除一个本地分支:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15080724688111725000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git branch -D my-branch`, `15080724688111725000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git branch<span class="token parameter"> -D</span> my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我想从别人正在工作的远程分支签出-checkout-一个分支"><a href="#%E6%88%91%E6%83%B3%E4%BB%8E%E5%88%AB%E4%BA%BA%E6%AD%A3%E5%9C%A8%E5%B7%A5%E4%BD%9C%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF%E7%AD%BE%E5%87%BA-checkout-%E4%B8%80%E4%B8%AA%E5%88%86%E6%94%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想从别人正在工作的远程分支签出 (checkout) 一个分支</h3>\n<p>首先, 从远程拉取 (fetch) 所有分支:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22604322437371980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git fetch --all`, `22604322437371980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git fetch<span class="token parameter"> --all</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>假设你想要从远程的<code class="language-text">daves</code>分支签出到本地的<code class="language-text">daves</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32545867764754810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git checkout --track origin/daves\nBranch daves set up to track remote branch daves from origin.\nSwitched to a new branch \'daves\'`, `32545867764754810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git checkout<span class="token parameter"> --track</span> origin/daves</span>\nBranch daves set up to track remote branch daves from origin.\nSwitched to a new branch <span class="token string">\'daves\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>(<code class="language-text">--track</code> 是 <code class="language-text">git checkout -b [branch] [remotename]/[branch]</code> 的简写)</p>\n<p>这样就得到了一个<code class="language-text">daves</code>分支的本地拷贝, 任何推过 (pushed) 的更新，远程都能看到.</p>\n<h2 id="rebasing-和合并-merging"><a href="#rebasing-%E5%92%8C%E5%90%88%E5%B9%B6-merging" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Rebasing 和合并 (Merging)</h2>\n<h3 id="我想撤销-rebasemerge"><a href="#%E6%88%91%E6%83%B3%E6%92%A4%E9%94%80-rebasemerge" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想撤销 rebase/merge</h3>\n<p>你可以合并 (merge) 或 rebase 了一个错误的分支, 或者完成不了一个进行中的 rebase/merge。 Git 在进行危险操作的时候会把原始的 HEAD 保存在一个叫 ORIG_HEAD 的变量里, 所以要把分支恢复到 rebase/merge 前的状态是很容易的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="196335916200873760"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git reset --hard ORIG_HEAD`, `196335916200873760`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git reset<span class="token parameter"> --hard</span> ORIG_HEAD</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="我已经-rebase-过-但是我不想强推-force-push"><a href="#%E6%88%91%E5%B7%B2%E7%BB%8F-rebase-%E8%BF%87-%E4%BD%86%E6%98%AF%E6%88%91%E4%B8%8D%E6%83%B3%E5%BC%BA%E6%8E%A8-force-push" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我已经 rebase 过, 但是我不想强推 (force push)</h3>\n<p>不幸的是，如果你想把这些变化 (changes) 反应到远程分支上，你就必须得强推 (force push)。 是因你快进 (Fast forward) 了提交，改变了 Git 历史, 远程分支不会接受变化 (changes)，除非强推 (force push)。这就是许多人使用 merge 工作流, 而不是 rebasing 工作流的主要原因之一， 开发者的强推 (force push) 会使大的团队陷入麻烦。使用时需要注意，一种安全使用 rebase 的方法是，不要把你的变化 (changes) 反映到远程分支上, 而是按下面的做:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39522984954591790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git checkout my-branch\n(my-branch)\\$ git rebase -i master\n(my-branch)\\$ git checkout master\n(master)\\$ git merge --ff-only my-branch`, `39522984954591790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git checkout my-branch</span>\n<span class="token command">(my-branch)$ git rebase<span class="token parameter"> -i</span> master</span>\n<span class="token command">(my-branch)$ git checkout master</span>\n<span class="token command">(master)$ git merge<span class="token parameter"> --ff</span>-only my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>更多, 参见 <a href="http://stackoverflow.com/questions/11058312/how-can-i-use-git-rebase-without-requiring-a-forced-push" target="_blank" rel="nofollow noreferrer noopener">this SO thread</a>.</p>\n<h3 id="我需要组合-combine-几个提交-commit"><a href="#%E6%88%91%E9%9C%80%E8%A6%81%E7%BB%84%E5%90%88-combine-%E5%87%A0%E4%B8%AA%E6%8F%90%E4%BA%A4-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我需要组合 (combine) 几个提交 (commit)</h3>\n<p>假设你的工作分支将会做对于 <code class="language-text">master</code> 的 pull-request。 一般情况下你不关心提交 (commit) 的时间戳，只想组合 -所有- 提交 (commit) 到一个单独的里面, 然后重置 (reset) 重提交 (recommit)。 确保主 (master) 分支是最新的和你的变化都已经提交了, 然后:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72915720058889314000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git reset --soft master\n(my-branch)\\$ git commit -am &quot;New awesome feature&quot;`, `72915720058889314000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git reset<span class="token parameter"> --soft</span> master</span>\n<span class="token command">(my-branch)$ git commit<span class="token parameter"> -am</span> </span><span class="token string">"New awesome feature"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你想要更多的控制, 想要保留时间戳, 你需要做交互式 rebase (interactive rebase):</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79293187839549260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git rebase -i master`, `79293187839549260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git rebase<span class="token parameter"> -i</span> master</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果没有相对的其它分支， 你将不得不相对自己的<code class="language-text">HEAD</code> 进行 rebase。 例如：你想组合最近的两次提交 (commit), 你将相对于<code class="language-text">HEAD~2</code> 进行 rebase， 组合最近 3 次提交 (commit), 相对于<code class="language-text">HEAD~3</code>, 等等。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43250162800835090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git rebase -i HEAD~2`, `43250162800835090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git rebase<span class="token parameter"> -i</span> HEAD~2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在你执行了交互式 rebase 的命令 (interactive rebase command) 后, 你将在你的编辑器里看到类似下面的内容:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38749387864333460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pick a9c8a1d Some refactoring\npick 01b2fd8 New awesome feature\npick b729ad5 fixup\npick e3851e8 another fix\n\n# Rebase 8074d12..b729ad5 onto 8074d12\n#\n# Commands:\n#  p, pick = use commit\n#  r, reword = use commit, but edit the commit message\n#  e, edit = use commit, but stop for amending\n#  s, squash = use commit, but meld into previous commit\n#  f, fixup = like &quot;squash&quot;, but discard this commit\'s log message\n#  x, exec = run command (the rest of the line) using shell\n#\n# These lines can be re-ordered; they are executed from top to bottom.\n#\n# If you remove a line here THAT COMMIT WILL BE LOST.\n#\n# However, if you remove everything, the rebase will be aborted.\n#\n# Note that empty commits are commented out`, `38749387864333460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                vim 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="vim"><pre style="counter-reset: linenumber NaN" class="language-vim line-numbers"><code class="language-vim">pick a9c8a1d Some refactoring\npick 01b2fd8 New awesome feature\npick b729ad5 fixup\npick e3851e8 another <span class="token keyword">fix</span>\n\n# Rebase 8074d12<span class="token operator">.</span><span class="token operator">.</span>b729ad5 onto 8074d12\n#\n# Commands<span class="token punctuation">:</span>\n#  <span class="token keyword">p</span><span class="token punctuation">,</span> pick <span class="token operator">=</span> use commit\n#  <span class="token keyword">r</span><span class="token punctuation">,</span> reword <span class="token operator">=</span> use commit<span class="token punctuation">,</span> but <span class="token keyword">edit</span> the commit message\n#  <span class="token keyword">e</span><span class="token punctuation">,</span> <span class="token keyword">edit</span> <span class="token operator">=</span> use commit<span class="token punctuation">,</span> but <span class="token keyword">stop</span> <span class="token keyword">for</span> amending\n#  s<span class="token punctuation">,</span> squash <span class="token operator">=</span> use commit<span class="token punctuation">,</span> but meld into <span class="token keyword">previous</span> commit\n#  <span class="token keyword">f</span><span class="token punctuation">,</span> fixup <span class="token operator">=</span> like <span class="token string">"squash"</span><span class="token punctuation">,</span> but discard this commit\'s log message\n#  <span class="token keyword">x</span><span class="token punctuation">,</span> exec <span class="token operator">=</span> run command <span class="token punctuation">(</span>the rest of the line<span class="token punctuation">)</span> using <span class="token keyword">shell</span>\n#\n# These <span class="token builtin">lines</span> can <span class="token keyword">be</span> re<span class="token operator">-</span>ordered<span class="token punctuation">;</span> they are executed from <span class="token builtin">top</span> <span class="token keyword">to</span> bottom<span class="token operator">.</span>\n#\n# If you remove a line here THAT COMMIT WILL BE LOST<span class="token operator">.</span>\n#\n# However<span class="token punctuation">,</span> <span class="token keyword">if</span> you remove everything<span class="token punctuation">,</span> the rebase will <span class="token keyword">be</span> aborted<span class="token operator">.</span>\n#\n# Note that empty commits are commented out</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所有以 <code class="language-text">#</code> 开头的行都是注释, 不会影响 rebase.</p>\n<p>然后，你可以用任何上面命令列表的命令替换 <code class="language-text">pick</code>, 你也可以通过删除对应的行来删除一个提交 (commit)。</p>\n<p>例如, 如果你想 —单独保留最旧 (first) 的提交 (commit),组合所有剩下的到第二个里面—, 你就应该编辑第二个提交 (commit) 后面的每个提交 (commit) 前的单词为 <code class="language-text">f</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99801469168243590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pick a9c8a1d Some refactoring\npick 01b2fd8 New awesome feature\nf b729ad5 fixup\nf e3851e8 another fix`, `99801469168243590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                vim 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="vim"><pre style="counter-reset: linenumber NaN" class="language-vim line-numbers"><code class="language-vim">pick a9c8a1d Some refactoring\npick 01b2fd8 New awesome feature\n<span class="token keyword">f</span> b729ad5 fixup\n<span class="token keyword">f</span> e3851e8 another <span class="token keyword">fix</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果你想组合这些提交 (commit) —并重命名这个提交 (commit)—, 你应该在第二个提交 (commit) 旁边添加一个<code class="language-text">r</code>，或者更简单的用<code class="language-text">s</code> 替代 <code class="language-text">f</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71752391839147320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pick a9c8a1d Some refactoring\npick 01b2fd8 New awesome feature\ns b729ad5 fixup\ns e3851e8 another fix`, `71752391839147320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                vim 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="vim"><pre style="counter-reset: linenumber NaN" class="language-vim line-numbers"><code class="language-vim">pick a9c8a1d Some refactoring\npick 01b2fd8 New awesome feature\ns b729ad5 fixup\ns e3851e8 another <span class="token keyword">fix</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以在接下来弹出的文本提示框里重命名提交 (commit)。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86092286281187080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Newer, awesomer features\n\n# Please enter the commit message for your changes. Lines starting\n# with \'#\' will be ignored, and an empty message aborts the commit.\n# rebase in progress; onto 8074d12\n# You are currently editing a commit while rebasing branch \'master\' on \'8074d12\'.\n#\n# Changes to be committed:\n#\tmodified:   README.md\n#`, `86092286281187080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                vim 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="vim"><pre style="counter-reset: linenumber NaN" class="language-vim line-numbers"><code class="language-vim">Newer<span class="token punctuation">,</span> awesomer features\n\n# Please enter the commit message <span class="token keyword">for</span> your <span class="token keyword">changes</span><span class="token operator">.</span> Lines starting\n# with <span class="token string">\'#\'</span> will <span class="token keyword">be</span> ignored<span class="token punctuation">,</span> and an empty message aborts the commit<span class="token operator">.</span>\n# rebase <span class="token keyword">in</span> progress<span class="token punctuation">;</span> onto 8074d12\n# You are currently editing a commit <span class="token keyword">while</span> rebasing branch <span class="token string">\'master\'</span> <span class="token keyword">on</span> <span class="token string">\'8074d12\'</span><span class="token operator">.</span>\n#\n# Changes <span class="token keyword">to</span> <span class="token keyword">be</span> committed<span class="token punctuation">:</span>\n#\t<span class="token builtin">modified</span><span class="token punctuation">:</span>   README<span class="token operator">.</span>md\n#</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果成功了, 你应该看到类似下面的内容:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83762375370383600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ Successfully rebased and updated refs/heads/master.`, `83762375370383600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git">(master)$ Successfully rebased and updated refs/heads/master.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="安全合并-merging-策略"><a href="#%E5%AE%89%E5%85%A8%E5%90%88%E5%B9%B6-merging-%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安全合并 (merging) 策略</h4>\n<p><code class="language-text">--no-commit</code> 执行合并 (merge) 但不自动提交, 给用户在做提交前检查和修改的机会。 <code class="language-text">no-ff</code> 会为特性分支 (feature branch) 的存在过留下证据, 保持项目历史一致。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12407001086798174000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git merge --no-ff --no-commit my-branch`, `12407001086798174000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git merge<span class="token parameter"> --no</span>-ff<span class="token parameter"> --no</span>-commit my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="我需要将一个分支合并成一个提交-commit"><a href="#%E6%88%91%E9%9C%80%E8%A6%81%E5%B0%86%E4%B8%80%E4%B8%AA%E5%88%86%E6%94%AF%E5%90%88%E5%B9%B6%E6%88%90%E4%B8%80%E4%B8%AA%E6%8F%90%E4%BA%A4-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我需要将一个分支合并成一个提交 (commit)</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51240852931973180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git merge --squash my-branch`, `51240852931973180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git merge<span class="token parameter"> --squash</span> my-branch</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h4 id="我只想组合-combine-未推的提交-unpushed-commit"><a href="#%E6%88%91%E5%8F%AA%E6%83%B3%E7%BB%84%E5%90%88-combine-%E6%9C%AA%E6%8E%A8%E7%9A%84%E6%8F%90%E4%BA%A4-unpushed-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我只想组合 (combine) 未推的提交 (unpushed commit)</h4>\n<p>有时候，在将数据推向上游之前，你有几个正在进行的工作提交 (commit)。这时候不希望把已经推 (push) 过的组合进来，因为其他人可能已经有提交 (commit) 引用它们了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84265882028877280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git rebase -i @{u}`, `84265882028877280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git rebase<span class="token parameter"> -i</span> @{u}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这会产生一次交互式的 rebase(interactive rebase), 只会列出没有推 (push) 的提交 (commit)， 在这个列表时进行 reorder/fix/squash 都是安全的。</p>\n<h3 id="检查是否分支上的所有提交-commit-都合并-merge-过了"><a href="#%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E5%88%86%E6%94%AF%E4%B8%8A%E7%9A%84%E6%89%80%E6%9C%89%E6%8F%90%E4%BA%A4-commit-%E9%83%BD%E5%90%88%E5%B9%B6-merge-%E8%BF%87%E4%BA%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>检查是否分支上的所有提交 (commit) 都合并 (merge) 过了</h3>\n<p>检查一个分支上的所有提交 (commit) 是否都已经合并 (merge) 到了其它分支, 你应该在这些分支的 head(或任何 commits) 之间做一次 diff:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87072915200151580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git log --graph --left-right --cherry-pick --oneline HEAD...feature/120-on-scroll`, `87072915200151580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git log<span class="token parameter"> --graph</span><span class="token parameter"> --left</span>-right<span class="token parameter"> --cherry</span>-pick<span class="token parameter"> --oneline</span> HEAD...feature/120-on-scroll</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这会告诉你在一个分支里有而另一个分支没有的所有提交 (commit), 和分支之间不共享的提交 (commit) 的列表。 另一个做法可以是:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77671036103301040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git log master ^feature/120-on-scroll --no-merges`, `77671036103301040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git log master ^feature/120-on-scroll<span class="token parameter"> --no</span>-merges</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="交互式-rebaseinteractive-rebase-可能出现的问题"><a href="#%E4%BA%A4%E4%BA%92%E5%BC%8F-rebaseinteractive-rebase-%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>交互式 rebase(interactive rebase) 可能出现的问题</h3>\n<h4 id="这个-rebase-编辑屏幕出现-noop"><a href="#%E8%BF%99%E4%B8%AA-rebase-%E7%BC%96%E8%BE%91%E5%B1%8F%E5%B9%95%E5%87%BA%E7%8E%B0-noop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>这个 rebase 编辑屏幕出现 ‘noop’</h4>\n<p>如果你看到的是这样:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90881866140173940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`noop;`, `90881866140173940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">noop<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这意味着你 rebase 的分支和当前分支在同一个提交 (commit) 上, 或者 -领先 (ahead)- 当前分支。 你可以尝试:</p>\n<ul>\n<li>检查确保主 (master) 分支没有问题</li>\n<li>rebase <code class="language-text">HEAD~2</code> 或者更早</li>\n</ul>\n<h4 id="有冲突的情况"><a href="#%E6%9C%89%E5%86%B2%E7%AA%81%E7%9A%84%E6%83%85%E5%86%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>有冲突的情况</h4>\n<p>如果你不能成功的完成 rebase, 你可能必须要解决冲突。</p>\n<p>首先执行 <code class="language-text">git status</code> 找出哪些文件有冲突:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11761169037003970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git status\nOn branch my-branch\nChanges not staged for commit:\n  (use &quot;git add <file>...&quot; to update what will be committed)\n  (use &quot;git checkout -- <file>...&quot; to discard changes in working directory)\n\n\tmodified:   README.md`, `11761169037003970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git status</span>\nOn branch my-branch\nChanges not staged for commit:\n  (use <span class="token string">"git add &lt;file>..."</span> to update what will be committed)\n  (use <span class="token string">"git checkout -- &lt;file>..."</span> to discard changes in working directory)\n\n\tmodified:   README.md</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这个例子里面, <code class="language-text">README.md</code> 有冲突。 打开这个文件找到类似下面的内容:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48693451491047465000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`   <<<<<<< HEAD\n   some code\n   =========\n   some code\n   >>>>>>> new-commit`, `48693451491047465000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                vim 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="vim"><pre style="counter-reset: linenumber NaN" class="language-vim line-numbers"><code class="language-vim">   <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">&lt;</span> HEAD\n   some code\n   <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>\n   some code\n   <span class="token operator">></span><span class="token operator">></span><span class="token operator">></span><span class="token operator">></span><span class="token operator">></span><span class="token operator">></span><span class="token operator">></span> <span class="token keyword">new</span><span class="token operator">-</span>commit</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你需要解决新提交的代码 (示例里, 从中间<code class="language-text">==</code>线到<code class="language-text">new-commit</code>的地方) 与<code class="language-text">HEAD</code> 之间不一样的地方.</p>\n<p>有时候这些合并非常复杂，你应该使用可视化的差异编辑器 (visual diff editor):</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23545623799452774000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master-)\\$ git mergetool -t opendiff`, `23545623799452774000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master-)$ git mergetool<span class="token parameter"> -t</span> opendiff</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在你解决完所有冲突和测试过后, <code class="language-text">git add</code> 变化了的 (changed) 文件, 然后用<code class="language-text">git rebase --continue</code> 继续 rebase。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4334727264387728000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git add README.md\n(my-branch)\\$ git rebase --continue`, `4334727264387728000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git add README.md</span>\n<span class="token command">(my-branch)$ git rebase<span class="token parameter"> --continue</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果在解决完所有的冲突过后，得到了与提交前一样的结果, 可以执行<code class="language-text">git rebase --skip</code>。</p>\n<p>任何时候你想结束整个 rebase 过程，回来 rebase 前的分支状态, 你可以做:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64237275168209250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(my-branch)\\$ git rebase --abort`, `64237275168209250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(my-branch)$ git rebase<span class="token parameter"> --abort</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="杂项-miscellaneous-objects"><a href="#%E6%9D%82%E9%A1%B9-miscellaneous-objects" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>杂项 (Miscellaneous Objects)</h2>\n<h3 id="克隆所有子模块"><a href="#%E5%85%8B%E9%9A%86%E6%89%80%E6%9C%89%E5%AD%90%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>克隆所有子模块</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46182703033176820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git clone --recursive git://github.com/foo/bar.git`, `46182703033176820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git clone<span class="token parameter"> --recursive</span> git://github.com/foo/bar.git</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果已经克隆了:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2106391781803007500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git submodule update --init --recursive`, `2106391781803007500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git submodule update<span class="token parameter"> --init</span><span class="token parameter"> --recursive</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="删除标签-tag"><a href="#%E5%88%A0%E9%99%A4%E6%A0%87%E7%AD%BE-tag" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>删除标签 (tag)</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69408546600185630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git tag -d <tag_name>\n\\$ git push <remote> :refs/tags/<tag_name>`, `69408546600185630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git tag<span class="token parameter"> -d</span> &lt;tag_name></span>\n<span class="token command">$ git push &lt;remote> :refs/tags/&lt;tag_name></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="恢复已删除标签-tag"><a href="#%E6%81%A2%E5%A4%8D%E5%B7%B2%E5%88%A0%E9%99%A4%E6%A0%87%E7%AD%BE-tag" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>恢复已删除标签 (tag)</h3>\n<p>如果你想恢复一个已删除标签 (tag), 可以按照下面的步骤: 首先, 需要找到无法访问的标签 (unreachable tag):</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53048405495895470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git fsck --unreachable | grep tag`, `53048405495895470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git fsck<span class="token parameter"> --unreachable</span> | grep tag</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>记下这个标签 (tag) 的 hash，然后用 Git 的 <a href="http://git-scm.com/docs/git-update-ref" target="_blank" rel="nofollow noreferrer noopener">update-ref</a>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90362512389046670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git update-ref refs/tags/<tag_name> <hash>`, `90362512389046670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git update-ref refs/tags/&lt;tag_name> &lt;hash></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这时你的标签 (tag) 应该已经恢复了。</p>\n<h3 id="已删除补丁-patch"><a href="#%E5%B7%B2%E5%88%A0%E9%99%A4%E8%A1%A5%E4%B8%81-patch" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>已删除补丁 (patch)</h3>\n<p>如果某人在 GitHub 上给你发了一个 pull request, 但是然后他删除了他自己的原始 fork, 你将没法克隆他们的提交 (commit) 或使用 <code class="language-text">git am</code>。在这种情况下, 最好手动的查看他们的提交 (commit)，并把它们拷贝到一个本地新分支，然后做提交。</p>\n<p>做完提交后, 再修改作者，参见<a href="#commit-wrong-author">变更作者 </a>。 然后, 应用变化, 再发起一个新的 pull request。</p>\n<h2 id="跟踪文件-tracking-files"><a href="#%E8%B7%9F%E8%B8%AA%E6%96%87%E4%BB%B6-tracking-files" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>跟踪文件 (Tracking Files)</h2>\n<h3 id="我只想改变一个文件名字的大小写，而不修改内容"><a href="#%E6%88%91%E5%8F%AA%E6%83%B3%E6%94%B9%E5%8F%98%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E5%90%8D%E5%AD%97%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%86%99%EF%BC%8C%E8%80%8C%E4%B8%8D%E4%BF%AE%E6%94%B9%E5%86%85%E5%AE%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我只想改变一个文件名字的大小写，而不修改内容</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88145452968870840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git mv --force myfile MyFile`, `88145452968870840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git mv<span class="token parameter"> --force</span> myfile MyFile</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p><a href="remove-from-git"></a></p>\n<h3 id="我想从-git-删除一个文件，但保留该文件"><a href="#%E6%88%91%E6%83%B3%E4%BB%8E-git-%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BD%86%E4%BF%9D%E7%95%99%E8%AF%A5%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想从 Git 删除一个文件，但保留该文件</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85787962467704210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git rm --cached log.txt`, `85787962467704210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git rm<span class="token parameter"> --cached</span> log.txt</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h2 id="配置-configuration"><a href="#%E9%85%8D%E7%BD%AE-configuration" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置 (Configuration)</h2>\n<h3 id="我想给一些-git-命令添加别名-alias"><a href="#%E6%88%91%E6%83%B3%E7%BB%99%E4%B8%80%E4%BA%9B-git-%E5%91%BD%E4%BB%A4%E6%B7%BB%E5%8A%A0%E5%88%AB%E5%90%8D-alias" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想给一些 Git 命令添加别名 (alias)</h3>\n<p>在 OS X 和 Linux 下, 你的 Git 的配置文件储存在 <code class="language-text">~/.gitconfig</code>。我在<code class="language-text">[alias]</code> 部分添加了一些快捷别名 (和一些我容易拼写错误的)，如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61631496454276260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[alias]\n    a = add\n    amend = commit --amend\n    c = commit\n    ca = commit --amend\n    ci = commit -a\n    co = checkout\n    d = diff\n    dc = diff --changed\n    ds = diff --staged\n    f = fetch\n    loll = log --graph --decorate --pretty=oneline --abbrev-commit\n    m = merge\n    one = log --pretty=oneline\n    outstanding = rebase -i @{u}\n    s = status\n    unpushed = log @{u}\n    wc = whatchanged\n    wip = rebase -i @{u}\n    zap = fetch -p`, `61631496454276260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                vim 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="vim"><pre style="counter-reset: linenumber NaN" class="language-vim line-numbers"><code class="language-vim"><span class="token punctuation">[</span>alias<span class="token punctuation">]</span>\n    a <span class="token operator">=</span> add\n    amend <span class="token operator">=</span> commit <span class="token operator">-</span><span class="token operator">-</span>amend\n    <span class="token keyword">c</span> <span class="token operator">=</span> commit\n    <span class="token keyword">ca</span> <span class="token operator">=</span> commit <span class="token operator">-</span><span class="token operator">-</span>amend\n    <span class="token builtin">ci</span> <span class="token operator">=</span> commit <span class="token operator">-</span>a\n    <span class="token keyword">co</span> <span class="token operator">=</span> checkout\n    <span class="token keyword">d</span> <span class="token operator">=</span> <span class="token builtin">diff</span>\n    dc <span class="token operator">=</span> <span class="token builtin">diff</span> <span class="token operator">-</span><span class="token operator">-</span>changed\n    <span class="token keyword">ds</span> <span class="token operator">=</span> <span class="token builtin">diff</span> <span class="token operator">-</span><span class="token operator">-</span>staged\n    <span class="token keyword">f</span> <span class="token operator">=</span> fetch\n    loll <span class="token operator">=</span> log <span class="token operator">-</span><span class="token operator">-</span>graph <span class="token operator">-</span><span class="token operator">-</span>decorate <span class="token operator">-</span><span class="token operator">-</span>pretty<span class="token operator">=</span>oneline <span class="token operator">-</span><span class="token operator">-</span>abbrev<span class="token operator">-</span>commit\n    <span class="token keyword">m</span> <span class="token operator">=</span> merge\n    one <span class="token operator">=</span> log <span class="token operator">-</span><span class="token operator">-</span>pretty<span class="token operator">=</span>oneline\n    outstanding <span class="token operator">=</span> rebase <span class="token operator">-</span>i @<span class="token punctuation">{</span><span class="token keyword">u</span><span class="token punctuation">}</span>\n    s <span class="token operator">=</span> status\n    unpushed <span class="token operator">=</span> log @<span class="token punctuation">{</span><span class="token keyword">u</span><span class="token punctuation">}</span>\n    <span class="token builtin">wc</span> <span class="token operator">=</span> whatchanged\n    wip <span class="token operator">=</span> rebase <span class="token operator">-</span>i @<span class="token punctuation">{</span><span class="token keyword">u</span><span class="token punctuation">}</span>\n    zap <span class="token operator">=</span> fetch <span class="token operator">-</span><span class="token keyword">p</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="我想缓存一个仓库-repository-的用户名和密码"><a href="#%E6%88%91%E6%83%B3%E7%BC%93%E5%AD%98%E4%B8%80%E4%B8%AA%E4%BB%93%E5%BA%93-repository-%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我想缓存一个仓库 (repository) 的用户名和密码</h3>\n<p>你可能有一个仓库需要授权，这时你可以缓存用户名和密码，而不用每次推/拉 (push/pull) 的时候都输入，Credential helper 能帮你。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7249747955250396000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git config --global credential.helper cache\n# Set git to use the credential memory cache`, `7249747955250396000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git config<span class="token parameter"> --global</span> credential.helper cache</span>\n<span class="token comment"># Set git to use the credential memory cache</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66707166631882810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git config --global credential.helper \'cache --timeout=3600\'\n# Set the cache to timeout after 1 hour (setting is in seconds)`, `66707166631882810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git config<span class="token parameter"> --global</span> credential.helper </span><span class="token string">\'cache --timeout=3600\'</span>\n<span class="token comment"># Set the cache to timeout after 1 hour (setting is in seconds)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p><a href="#ive-no-idea-what-i-did-wrong"></a></p>\n<h2 id="我不知道我做错了些什么"><a href="#%E6%88%91%E4%B8%8D%E7%9F%A5%E9%81%93%E6%88%91%E5%81%9A%E9%94%99%E4%BA%86%E4%BA%9B%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>我不知道我做错了些什么</h2>\n<p>你把事情搞砸了：你 <code class="language-text">重置 (reset)</code> 了一些东西, 或者你合并了错误的分支, 亦或你强推了后找不到你自己的提交 (commit) 了。有些时候, 你一直都做得很好, 但你想回到以前的某个状态。</p>\n<p>这就是 <code class="language-text">git reflog</code> 的目的， <code class="language-text">reflog</code> 记录对分支顶端 (the tip of a branch) 的任何改变, 即使那个顶端没有被任何分支或标签引用。基本上, 每次 HEAD 的改变, 一条新的记录就会增加到<code class="language-text">reflog</code>。遗憾的是，这只对本地分支起作用，且它只跟踪动作 (例如，不会跟踪一个没有被记录的文件的任何改变)。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50708901188843060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(master)\\$ git reflog\n0a2e358 HEAD@{0}: reset: moving to HEAD~2\n0254ea7 HEAD@{1}: checkout: moving from 2.2 to master\nc10f740 HEAD@{2}: checkout: moving from master to 2.2`, `50708901188843060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">(master)$ git reflog</span>\n0a2e358 HEAD@{0}: reset: moving to HEAD~2\n0254ea7 HEAD@{1}: checkout: moving from 2.2 to master\nc10f740 HEAD@{2}: checkout: moving from master to 2.2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的 reflog 展示了从 master 分支签出 (checkout) 到 2.2 分支，然后再签回。 那里，还有一个硬重置 (hard reset) 到一个较旧的提交。最新的动作出现在最上面以 <code class="language-text">HEAD@{0}</code>标识.</p>\n<p>如果事实证明你不小心回移 (move back) 了提交 (commit), reflog 会包含你不小心回移前 master 上指向的提交 (0254ea7)。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56619271879871140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ git reset --hard 0254ea7`, `56619271879871140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                git 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="git"><pre style="counter-reset: linenumber NaN" class="language-git line-numbers"><code class="language-git"><span class="token command">$ git reset<span class="token parameter"> --hard</span> 0254ea7</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后使用 git reset 就可以把 master 改回到之前的 commit，这提供了一个在历史被意外更改情况下的安全网。</p>\n<h2 id="其它资源-other-resources"><a href="#%E5%85%B6%E5%AE%83%E8%B5%84%E6%BA%90-other-resources" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其它资源 (Other Resources)</h2>\n<h3 id="书-books"><a href="#%E4%B9%A6-books" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>书 (Books)</h3>\n<ul>\n<li><a href="https://git-scm.com/book/en/v2" target="_blank" rel="nofollow noreferrer noopener">Pro Git</a> - Scott Chacon’s excellent git book</li>\n<li><a href="https://github.com/pluralsight/git-internals-pdf" target="_blank" rel="nofollow noreferrer noopener">Git Internals</a> - Scott Chacon’s other excellent git book</li>\n</ul>\n<h3 id="教程-tutorials"><a href="#%E6%95%99%E7%A8%8B-tutorials" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>教程 (Tutorials)</h3>\n<ul>\n<li><a href="https://learngitbranching.js.org/" target="_blank" rel="nofollow noreferrer noopener">Learn Git branching</a> 一个基于网页的交互式 branching/merging/rebasing 教程</li>\n<li><a href="https://medium.com/@porteneuve/getting-solid-at-git-rebase-vs-merge-4fa1a48c53aa" target="_blank" rel="nofollow noreferrer noopener">Getting solid at Git rebase vs. merge</a></li>\n<li><a href="https://github.com/asmeurer/git-workflow" target="_blank" rel="nofollow noreferrer noopener">git-workflow</a> - <a href="https://github.com/asmeurer" target="_blank" rel="nofollow noreferrer noopener">Aaron Meurer</a> 的怎么使用 Git 为开源仓库贡献</li>\n<li><a href="http://hugogiraudel.com/2015/08/13/github-as-a-workflow/" target="_blank" rel="nofollow noreferrer noopener">GitHub as a workflow</a> - 使用 GitHub 做为工作流的趣事, 尤其是空 PRs</li>\n</ul>\n<h3 id="脚本和工具-scripts-and-tools"><a href="#%E8%84%9A%E6%9C%AC%E5%92%8C%E5%B7%A5%E5%85%B7-scripts-and-tools" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本和工具 (Scripts and Tools)</h3>\n<ul>\n<li><a href="http://firstaidgit.io/" target="_blank" rel="nofollow noreferrer noopener">firstaidgit.io</a> 一个可搜索的最常被问到的 Git 的问题</li>\n<li><a href="https://github.com/unixorn/git-extra-commands" target="_blank" rel="nofollow noreferrer noopener">git-extra-commands</a> - 一堆有用的额外的 Git 脚本</li>\n<li><a href="https://github.com/tj/git-extras" target="_blank" rel="nofollow noreferrer noopener">git-extras</a> - GIT 工具集 — repo summary, repl, changelog population, author commit percentages and more</li>\n<li><a href="https://github.com/qw3rtman/git-fire" target="_blank" rel="nofollow noreferrer noopener">git-fire</a> - git-fire 是一个 Git 插件，用于帮助在紧急情况下添加所有当前文件, 做提交 (committing), 和推 (push) 到一个新分支 (阻止合并冲突)。</li>\n<li><a href="https://github.com/git-tips/tips" target="_blank" rel="nofollow noreferrer noopener">git-tips</a> - Git 小提示</li>\n</ul>\n<h3 id="gui-客户端-gui-clients"><a href="#gui-%E5%AE%A2%E6%88%B7%E7%AB%AF-gui-clients" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GUI 客户端 (GUI Clients)</h3>\n<ul>\n<li><a href="https://www.gitkraken.com/" target="_blank" rel="nofollow noreferrer noopener">GitKraken</a> - 豪华的 Git 客户端 Windows, Mac &#x26; Linux</li>\n<li><a href="https://git-cola.github.io/" target="_blank" rel="nofollow noreferrer noopener">git-cola</a> - 另外一个 Git 客户端 Windows &#x26; OS X</li>\n<li><a href="https://github.com/git-up/GitUp" target="_blank" rel="nofollow noreferrer noopener">GitUp</a> - 一个新的 Git 客户端，在处理 Git 的复杂性上有自己的特点</li>\n<li><a href="https://rowanj.github.io/gitx/" target="_blank" rel="nofollow noreferrer noopener">gitx-dev</a> - 图形化的 Git 客户端 OS X</li>\n<li><a href="https://www.sourcetreeapp.com/" target="_blank" rel="nofollow noreferrer noopener">Source Tree</a> - 免费的图形化 Git 客户端 Windows &#x26; OS X</li>\n<li><a href="http://www.git-tower.com/" target="_blank" rel="nofollow noreferrer noopener">Tower</a> - 图形化 Git 客户端 OS X(付费)</li>\n</ul>',
excerpt:"前言 英文原版 README 翻译可能存在错误或不标准的地方，欢迎大家指正和修改，谢谢！ 什么是”飞行规则”? 一个  宇航员指南   (现在, 程序员们都在使用 GIT) 是关于出现问题过后应该怎么操作。 飞行规则 (Flight Rules…",frontmatter:{date:"2018-11-09 10:09:28",path:"/git-flight-rules/",tags:"Git, git 飞行规则",title:"git 飞行规则",draft:null}},prePost:{html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>解决 react-player 控件在 IE 浏览器下声音的播放</p>\n<h1 id="核心思路"><a href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E8%B7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>核心思路</h1>\n<p>ReactPlayer 底层调用了 audio 标签来播放音频，video 标签来播放视频，因为在 IE 浏览器下是没有 audio 标签的，所以使用了 embed 标签，其在 IE 下是调用 windows media player，关于其用法如下</p>\n<h2 id="功能"><a href="#%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>功能</h2>\n<blockquote>\n<p>播放: MediaPlayer.Play()<br>\n暂停: MediaPlayer.Pause()<br>\n定位:</p>\n<ul>\n<li>MediaPlayer.SetCurrentEntry(lWhichEntry)</li>\n<li>MediaPlayer.Next()</li>\n<li>MediaPlayer.Previous()</li>\n</ul>\n<p>循环: MediaPlayer.PlayCount = 0</p>\n<ul>\n<li>0: the clip plays repeatedly</li>\n<li>1: once</li>\n</ul>\n<p>停止: MediaPlayer.Stop()</p>\n</blockquote>\n<h2 id="属性"><a href="#%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>属性</h2>\n<blockquote>\n<p>AllowChangeDisplaySize 返回或设置最终用户是否能设置显示尺寸(逻辑型)<br>\nAllowScan 返回或设置是否允许扫描(逻辑型)<br>\nAnimationAtStart 返回或设置控件开始播放之前是否先播放一个动画序列(逻辑型)<br>\nAudioStream 返回或设置音频流的编号(用于多音频流的剪辑，默认为-1)(长整型)<br>\nAutoRewind 返回或设置媒体文件播放完毕后是否自动回绕(逻辑型)<br>\nAutoSize 返回或设置是否自动调整控件大小来适应载入的媒体(逻辑型)<br>\nAutoStart 返回或设置在载入媒体文件之后是否自动开始播放(逻辑型)<br>\nBalance 返回或设置指定立体声媒体文件的播放声道(-10000 为左声道，10000 为右声道，0 为立体声)(长整型)<br>\nBandwidth 返回或设置当前文件的带宽(长整型)<br>\nBaseURL 返回基本的 HTTP URL(字符串)<br>\nBufferingCount 返回媒体文件回放时缓冲的总时间(长整型)<br>\nBufferingProgress 返回缓冲完成的百分比(长整型)<br>\nBufferingTime 返回缓冲的时间(双精度型)<br>\nCanPreview 返回或设置当前显示的剪辑是能否被预览(逻辑型)<br>\nCanScan 返回或设置当前文件是否支持快进或快退(逻辑型)<br>\nCanSeek 返回或设置当前文件是否能搜索并定位到某个时间(逻辑型)<br>\nCanSeekToMarkers 返回或设置文件是否支持搜索到标签(逻辑型)<br>\nCaptioningID 返回在标题中显示的帧或控件的名称(字符串)<br>\nChannelDescription 返回电台的描述(字符串)<br>\nChannelName 返回电台的名称(字符串)<br>\nChannelURL 返回电台的元文件的位置(字符串)<br>\nClickToPlay 返回或设置是否可以通过点击图像暂停或播放剪辑(逻辑型)<br>\nClientID 返回客户端唯一的标识符(字符串)<br>\nCodecCount 返回文件使用的可安装的 codecs 的个数(长整型)<br>\nContactAddress 返回电台的联系地址(字符串)<br>\nContactEmail 返回电台的联系电子邮件地址(字符串)<br>\nContactPhone 返回电台的联系电话(字符串)<br>\nCreationDate 返回剪辑的创建日期(日期型)<br>\nCurrentMarker 返回或设置当前书签号码(长整型)<br>\nCurrentPosition 返回或设置剪辑的当前位置(双精度型)<br>\nCursorType 返回或设置指针类型(长整型)<br>\nDefaultFrame 返回或设置控件的默认目标 Http 帧(字符串)<br>\nDisplayBackColor 返回或设置显示面板的背景色(OLE<em>COLOR 值)<br>\nDisplayForeColor 返回或设置显示面板的前景色(OLE_COLOR 值)<br>\nDisplayMode 返回或设置显示面板是否用秒或帧的形式显示当前位置(MPDisplayModeConstants 值)<br>\nDisplaySize 返回或设置图像显示窗口的大小(MPDisplaySizeConstant 值)<br>\nDuration 返回或设置剪辑剪辑的播放时间(双精度型)<br>\nEnableContextMenu 返回或设置是否允许使用上下文菜单(逻辑型)<br>\nEnabled 返回或设置控件是否可用(逻辑型)<br>\nEnableFullScreenControls 返回或设置全屏幕控制是否可用(逻辑型)<br>\nEnablePositionControls 返回或设置位置控制是否可用(逻辑型)<br>\nEnableTracker 返回或设置搜索栏控制是否可用(逻辑型)<br>\nErrorCode 返回当前错误代码(长整型)<br>\nErrorCorrection 返回当前剪辑的错误修正类型(长整型)<br>\nErrorDescription 返回当前错误的描述(字符串)<br>\nFileName 返回或设置要播放的剪辑的文件名称(字符串)<br>\nHasError 返回控件是否发生错误(逻辑型)<br>\nHasMultipleItems 返回或设置控件是否包含某些多重项目的内容(逻辑型)<br>\nImageSourceHeight 返回或设置当前剪辑的原始图像高度(长整型)<br>\nImageSourceWidth 返回或设置当前剪辑的原始图像宽度(长整型)<br>\nInvokeURLs 返回或设置 URL 是否自动发送请求(逻辑型)<br>\nIsBroadcast 返回或设置源是否进行广播(逻辑型)<br>\nIsDurationValid 返回或设置持续时间值是否有效(逻辑型)<br>\nLanguage 返回或设置用于本地化语言支持的当前区域语言(长整型)<br>\nLostPackets 返回丢失的数据包数量(长整型)<br>\nMarkerCount 返回文件书签的数量(长整型)<br>\nMute 返回或设置控件是否播放声音(逻辑型)<br>\nOpenState 返回控件的内容源状态(长整型)<br>\nPlayCount 返回或设置一个剪辑播放的次数(长整型)<br>\nPlayState 返回控件的当前操作状态(长整型)<br>\nPreviewMode 返回或设置控件是否处在预览模式(逻辑型)<br>\nRate 返回或设置回放帧频(双精度型)<br>\nReadyState 返回控件是否准备就绪(ReadyStateConstant 值)<br>\nReceivedPackets 返回已接收到的数据包的数量(长整型)<br>\nReceptionQuality 返回最后 30 秒接收到的数据包的百分比(长整型)<br>\nRecoveredPackets 返回已转换的数据包的数量(长整型)<br>\nSAMIFileName 返回或设置 closed-captioning 文件名(字符串)<br>\nSAMILang 返回或设置 closed captioning 语言(字符串)<br>\nSAMIStyle 返回或设置 closed captioning 风格(字符串)<br>\nSelectionEnd 返回或设置流的结束位置(双精度型)<br>\nSelectionStart 返回或设置流的起始位置(双精度型)<br>\nSendErrorEvents 返回或设置控件是否发送错误事件(逻辑型)<br>\nSendKeyboardEvents 返回或设置控件是否发送键盘事件(逻辑型)<br>\nSendMouseClickEvents 返回或设置控件是否发送鼠标单击事件(逻辑型)<br>\nSendMouseMoveEvents 返回或设置控件是否发送鼠标移动事件(逻辑型)<br>\nSendOpenStateChangeEvents 返回或设置控件是否发送打开状态改变事件(逻辑型)<br>\nSendPlayStateChangeEvents 返回或设置控件是否发送播放状态改变事件(逻辑型)<br>\nSendWarningEvents 返回或设置控件是否发送警告事件(逻辑型)<br>\nShowAudioControls 返回或设置是否显示音频控制(逻辑型)<br>\nShowCaptioning 返回或设置是否显示字幕(逻辑型)<br>\nShowControls 返回或设置控制面板是否可见(逻辑型)<br>\nShowDisplay 返回或设置是否显示显示面板(逻辑型)<br>\nShowGotoBar 返回或设置是否显示跳转栏(逻辑型)<br>\nShowPositionControls 返回或设置是否显示位置控制(逻辑型)<br>\nShowStatusBar 返回或设置是否显示状态栏(逻辑型)<br>\nShowTracker 返回或设置是否显示搜索栏(逻辑型)<br>\nSourceLink 返回内容文件的路径(字符串)<br>\nSourceProtocol 返回用于接收数据的协议(长整型)<br>\nStreamCount 返回媒体帧的数量(长整型)<br>\nTransparentAtStart 返回或设置在开始播放之前和停止之后控件是否透明(逻辑型)<br>\nVideoBorder3D 返回或设置视频边框是否显示为 3D 效果(逻辑型)<br>\nVideoBorderColor 返回或设置视频边框的颜色(OLE</em>颜色)<br>\nVideoBorderWidth 返回或设置视频边框的宽度(长整型)<br>\nVolume 返回或设置音量(长整型)</p>\n</blockquote>\n<h1 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h1>\n<p>兼容 IE9~IE11 的 react-player</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10740017588423268000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';\nimport PropTypes from \'prop-types\';\n\nfunction noop() {}\n\n// IE下的audio标签不能播放wav文件，改用embed标签播放，兼容版本：IE9~11\nexport class IEReactPlayer extends React.PureComponent {\n  static propTypes = {\n    url: PropTypes.string, // 播放路径\n    playing: PropTypes.bool, // 播放状态\n    onProgress: PropTypes.func, // 进度更新回调，返回已播放百分比\n    onDuration: PropTypes.func, // 录音长度回调，返回录音总时长，单位为秒\n    onEnded: PropTypes.func, // 录音结束回调，无返回值\n    volume: PropTypes.number, // 音量属性，范围0~1，此属性调整音量不生效，待解决\n    autostart: PropTypes.string, // 是否自动播放，此属性为了兼容Audio组件点击按钮后才请求url，防止点击两次播放按钮才开始播放的情况出现\n    progressInterval: PropTypes.number // 进度刷新间隔，默认100\n  };\n\n  static defaultProps = {\n    url: \'\',\n    playing: false,\n    autostart: \'false\',\n    progressInterval: 100\n  };\n\n  componentDidMount() {\n    const { progressInterval } = this.props;\n    this.timer = setInterval(() => {\n      // 0：停止状态，1：暂停状态，2：播放状态，4:资源加载完成\n      const { onProgress = noop, onDuration = noop, onEnded = noop } = this.props;\n      if (this.embed && this.embed.ReadyState === 4) {\n        onDuration(this.embed.Duration);\n        if (this.embed.PlayState !== 2) {\n          onEnded();\n        }\n        if (this.embed.PlayState === 2 || this.embed.PlayState === 0) {\n          onProgress({\n            played: this.embed.CurrentPosition / this.embed.Duration\n          });\n        }\n      }\n    }, progressInterval);\n  }\n\n  componentWillUnmount() {\n    this.timer && clearInterval(this.timer);\n  }\n\n  seekTo = (value) => {\n    // 设置播放位置，以秒为单位\n    this.embed.CurrentPosition = value * this.embed.Duration;\n  };\n\n  render() {\n    const { url, playing, volume, autostart } = this.props;\n    if (this.embed && this.embed.ReadyState === 4) {\n      if (playing) {\n        this.embed.play();\n      } else {\n        this.embed.pause();\n      }\n      this.embed.Volume = volume * 100;\n    }\n    return (\n      <div>\n        {url && (\n          <embed\n            ref={(r) => {\n              this.embed = r;\n            }}\n            src={url}\n            autostart={autostart}\n            hidden\n          />\n        )}\n      </div>\n    );\n  }\n}\n\nexport default IEReactPlayer;`, `10740017588423268000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">\'prop-types\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">noop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token comment">// IE下的audio标签不能播放wav文件，改用embed标签播放，兼容版本：IE9~11</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">IEReactPlayer</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>\n  <span class="token keyword">static</span> propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    url<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>string<span class="token punctuation">,</span> <span class="token comment">// 播放路径</span>\n    playing<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>bool<span class="token punctuation">,</span> <span class="token comment">// 播放状态</span>\n    onProgress<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>func<span class="token punctuation">,</span> <span class="token comment">// 进度更新回调，返回已播放百分比</span>\n    onDuration<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>func<span class="token punctuation">,</span> <span class="token comment">// 录音长度回调，返回录音总时长，单位为秒</span>\n    onEnded<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>func<span class="token punctuation">,</span> <span class="token comment">// 录音结束回调，无返回值</span>\n    volume<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>number<span class="token punctuation">,</span> <span class="token comment">// 音量属性，范围0~1，此属性调整音量不生效，待解决</span>\n    autostart<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>string<span class="token punctuation">,</span> <span class="token comment">// 是否自动播放，此属性为了兼容Audio组件点击按钮后才请求url，防止点击两次播放按钮才开始播放的情况出现</span>\n    progressInterval<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>number <span class="token comment">// 进度刷新间隔，默认100</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">static</span> defaultProps <span class="token operator">=</span> <span class="token punctuation">{</span>\n    url<span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">,</span>\n    playing<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    autostart<span class="token punctuation">:</span> <span class="token string">\'false\'</span><span class="token punctuation">,</span>\n    progressInterval<span class="token punctuation">:</span> <span class="token number">100</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> progressInterval <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 0：停止状态，1：暂停状态，2：播放状态，4:资源加载完成</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> onProgress <span class="token operator">=</span> noop<span class="token punctuation">,</span> onDuration <span class="token operator">=</span> noop<span class="token punctuation">,</span> onEnded <span class="token operator">=</span> noop <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>embed <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>ReadyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">onDuration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>PlayState <span class="token operator">!==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">onEnded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>PlayState <span class="token operator">===</span> <span class="token number">2</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>PlayState <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            played<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>CurrentPosition <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>Duration\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> progressInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function-variable function">seekTo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// 设置播放位置，以秒为单位</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>CurrentPosition <span class="token operator">=</span> value <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>Duration<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> playing<span class="token punctuation">,</span> volume<span class="token punctuation">,</span> autostart <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>embed <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>ReadyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>playing<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span>embed<span class="token punctuation">.</span>Volume <span class="token operator">=</span> volume <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>\n      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n        </span><span class="token punctuation">{</span>url <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>embed</span>\n            <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">this</span><span class="token punctuation">.</span>embed <span class="token operator">=</span> r<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>\n            <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>url<span class="token punctuation">}</span></span>\n            <span class="token attr-name">autostart</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>autostart<span class="token punctuation">}</span></span>\n            <span class="token attr-name">hidden</span>\n          <span class="token punctuation">/></span></span>\n        <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> IEReactPlayer<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h1>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2019-02-13-20-52-02-f4d5994a8a436d0e7485e76e6dd1fed7-2936c.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 71.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABZElEQVQoz41Su07EMBD0l9LxDTR8BQX/QIsQJaKgAyFRIEBUp0hwcnIJeTj2rl9M4rsoF+DEyLHs3Z3d2XVE27Z5nocQYoxhRPwfnHOCmZVS2LXW3vu5G4mstTASEbwLMryi7/uyLKWUWZbh0HXdlAKHoiiqqlqv1yjws7hAVjjqut5sNtjRAvhTbrhwRYHhCqlhWFNjAumh2e6ATngHjANqk4UIMRwjDSuwMabvlYCPZoB1OoOZrvgsU9XR+YM7vfV3Kzbdl8yLJXkOqJ2TtaGLZ3t27x4/2Bo01B8iN02DEBpFK01Pn/wm+b3gvEU+jUYOkTECEFHbMZUdndz44+twdBUuX9mbDkIGMrSlCS3IGD5GPdknP1owIwTSIwIPglC7z08Rv4raklPlrKIXSW1PPI5nV4r/6ggUvIVw3htiZbjVvEAaWOp8gS1ZcZAqGhdbG1d1tC5M8CNC2LOAk0ThD/sGEMUrqJkTcrQAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2019 02 13 20 52 02"\n        title=""\n        src="/static/2019-02-13-20-52-02-f4d5994a8a436d0e7485e76e6dd1fed7-fee1c.png"\n        srcset="/static/2019-02-13-20-52-02-f4d5994a8a436d0e7485e76e6dd1fed7-a67b7.png 200w,\n/static/2019-02-13-20-52-02-f4d5994a8a436d0e7485e76e6dd1fed7-0b187.png 400w,\n/static/2019-02-13-20-52-02-f4d5994a8a436d0e7485e76e6dd1fed7-fee1c.png 800w,\n/static/2019-02-13-20-52-02-f4d5994a8a436d0e7485e76e6dd1fed7-2936c.png 850w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>',excerpt:"需求背景 解决 react-player 控件在 IE 浏览器下声音的播放 核心思路 ReactPlayer 底层调用了 audio 标签来播放音频，video 标签来播放视频，因为在 IE 浏览器下是没有 audio 标签的，所以使用了 embed 标签，其在 IE…",frontmatter:{date:"2019-02-13 19:50:08",path:"/reactplayer-ie-compatibility/",tags:"前端, ReactPlayer, IE兼容性, 预研",title:"ReactPlayer之IE兼容性研究",draft:null}}},pathContext:{mainPostPath:"/you-dont-know-js-asynchronism-and-performance/",nextPostPath:"/git-flight-rules/",prePostPath:"/reactplayer-ie-compatibility/"}}}});
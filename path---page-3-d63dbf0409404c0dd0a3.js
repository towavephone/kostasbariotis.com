webpackJsonp([0xc61b59b78031],{1197:function(n,a){n.exports={data:{site:{siteMetadata:{description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"需求背景 基于公司的要求，需要对地图组件做出选型，以支持在地图上展示线路轨迹 技术选型 选型 优点 缺点 百度地图 大厂支持、UI 比较美观、API 文档较为清楚 内网搭建访问较为困难 高德地图 大厂支持、UI 比较美观、API 文档较为清楚 内网搭建访问较为困难 echarts 地图 UI 美观、API 文档较为清楚 内网搭建访问较为困难、功能较弱 天地图 支持离线访问、是专用地图 UI 不够美观、文档不够清楚 arcgis 支持离线访问、UI…",html:'<h1 id="需求背景"><a href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>需求背景</h1>\n<p>基于公司的要求，需要对地图组件做出选型，以支持在地图上展示线路轨迹</p>\n<h1 id="技术选型"><a href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>技术选型</h1>\n<table>\n<thead>\n<tr>\n<th align="center">选型</th>\n<th align="center">优点</th>\n<th align="center">缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">百度地图</td>\n<td align="center">大厂支持、UI 比较美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难</td>\n</tr>\n<tr>\n<td align="center">高德地图</td>\n<td align="center">大厂支持、UI 比较美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难</td>\n</tr>\n<tr>\n<td align="center">echarts 地图</td>\n<td align="center">UI 美观、API 文档较为清楚</td>\n<td align="center">内网搭建访问较为困难、功能较弱</td>\n</tr>\n<tr>\n<td align="center">天地图</td>\n<td align="center">支持离线访问、是专用地图</td>\n<td align="center">UI 不够美观、文档不够清楚</td>\n</tr>\n<tr>\n<td align="center">arcgis</td>\n<td align="center">支持离线访问、UI 上可做到切换不同图层</td>\n<td align="center">文档不够清楚</td>\n</tr>\n</tbody>\n</table>\n<p>最终由于是内网相关的项目，需要支持离线访问，同时那边所采用的地图组件也是 arcgis，所以最终采用 arcgis</p>\n<h1 id="前期准备"><a href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前期准备</h1>\n<h2 id="三方库本地化"><a href="#%E4%B8%89%E6%96%B9%E5%BA%93%E6%9C%AC%E5%9C%B0%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三方库本地化</h2>\n<p>考虑到在内网离线运行，所以要对 arcgis 的 js 库进行本地化，大致经历了以下过程：</p>\n<h3 id="配合内网验证-demo-静态文件服务器"><a href="#%E9%85%8D%E5%90%88%E5%86%85%E7%BD%91%E9%AA%8C%E8%AF%81-demo-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配合内网验证 demo 静态文件服务器</h3>\n<p>直接使用 nginx 或者 http-server 静态服务器，将 arcgis 脚本地址改为本地</p>\n<h3 id="静态文件服务器托管"><a href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%98%E7%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>静态文件服务器托管</h3>\n<p>将 arcgis 三方库托管在静态文件服务器上，同时反代相关路径，这里的后端采用 koa 技术栈</p>\n<p>src\\server\\controllers\\stat-multi.controller.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21585160579033547000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 访问地址的 css 路径：/stat-multi/arcgis/esri/themes/light/main.css\n// 访问地址的 url 路径：/stat-multi/arcgis/init.js\nconst config = require(\'config\'); // 全局配置\nconst proxy = require(\'http-proxy-middleware\');\nconst c2k = require(\'koa2-connect\');\n\nfunction proxyArcgis(ctx, next) {\n  const proxyMiddleware = c2k(\n    proxy({\n      target: config.arcgisMapHost,\n      // 对 /stat-multi/arcgis 开头的 url 进行反代\n      pathRewrite: (path) => path.replace(\'/stat-multi/arcgis\', \'\'),\n      onProxyRes: (proxyRes) => {\n        console.log(\'proxyRes\', proxyRes);\n        // proxyRes.headers[\'Cache-Control\'] = \'private,max-stale=0,max-age=0\'\n      },\n      onProxyReq: (proxyReq) => {\n        console.log(\'proxyReq\', proxyReq);\n      }\n    })\n  );\n  return proxyMiddleware(ctx, next);\n}\n\nproxyArcgis();`, `21585160579033547000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 访问地址的 css 路径：/stat-multi/arcgis/esri/themes/light/main.css</span>\n<span class="token comment">// 访问地址的 url 路径：/stat-multi/arcgis/init.js</span>\n<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'config\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 全局配置</span>\n<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http-proxy-middleware\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> c2k <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'koa2-connect\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">proxyArcgis</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> proxyMiddleware <span class="token operator">=</span> <span class="token function">c2k</span><span class="token punctuation">(</span>\n    <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      target<span class="token punctuation">:</span> config<span class="token punctuation">.</span>arcgisMapHost<span class="token punctuation">,</span>\n      <span class="token comment">// 对 /stat-multi/arcgis 开头的 url 进行反代</span>\n      <span class="token function-variable function">pathRewrite</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">\'/stat-multi/arcgis\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onProxyRes</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyRes</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'proxyRes\'</span><span class="token punctuation">,</span> proxyRes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// proxyRes.headers[\'Cache-Control\'] = \'private,max-stale=0,max-age=0\'</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">onProxyReq</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyReq</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'proxyReq\'</span><span class="token punctuation">,</span> proxyReq<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token function">proxyMiddleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">proxyArcgis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="npm-私有库托管"><a href="#npm-%E7%A7%81%E6%9C%89%E5%BA%93%E6%89%98%E7%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>npm 私有库托管</h3>\n<p>由于此三方库的静态文件服务器需要单独进行配置，略显繁琐，于是决定上传到公司 npm 私有库上，安装到后端对应的项目，并在后端以静态文件服务器的形式提供访问，这里后端采用 midway 技术栈</p>\n<p>server\\src\\config\\config.default.ts</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32641615655555367000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 访问地址的 css 路径：/static-apps/mut/arcgis/esri/themes/light/main.css\n// 访问地址的 url 路径：/static-apps/mut/arcgis/init.js\n\nconfig.static = {\n  prefix: \'/static-apps/mut\',\n  dir: [\n    path.join(appInfo.baseDir, \'app/public\'),\n    {\n      prefix: \'/static-apps/mut/arcgis\',\n      dir: path.join(process.cwd(), \'node_modules/上传到 npm 私有库的三方库/dist\'),\n      maxAge: 60 * 10 // 缓存 10 分钟\n    }\n  ]\n};`, `32641615655555367000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 访问地址的 css 路径：/static-apps/mut/arcgis/esri/themes/light/main.css</span>\n<span class="token comment">// 访问地址的 url 路径：/static-apps/mut/arcgis/init.js</span>\n\nconfig<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token punctuation">{</span>\n  prefix<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut\'</span><span class="token punctuation">,</span>\n  dir<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n    path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>appInfo<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">\'app/public\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      prefix<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis\'</span><span class="token punctuation">,</span>\n      dir<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'node_modules/上传到 npm 私有库的三方库/dist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n      maxAge<span class="token punctuation">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token comment">// 缓存 10 分钟</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="内网图层验证"><a href="#%E5%86%85%E7%BD%91%E5%9B%BE%E5%B1%82%E9%AA%8C%E8%AF%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内网图层验证</h2>\n<p>由于需要在内网离线运行，验证在内网 demo 是否能正常加载图层</p>\n<h3 id="react-arcgis"><a href="#react-arcgis" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-arcgis</h3>\n<p>首先确保没有多余的外网请求，在采用 <a href="https://github.com/Esri/react-arcgis" target="_blank" rel="nofollow noreferrer noopener">react-arcgis</a> 的过程中，发现无论采用什么图层也会加载 arcgis 的默认图层（在内网的情况下会阻塞内网图层的加载，同时也会对地图的加载速度造成影响），所以直接使用 <a href="https://github.com/Esri/esri-loader" target="_blank" rel="nofollow noreferrer noopener">esri-loader</a> 加载图层</p>\n<h3 id="esri-loader"><a href="#esri-loader" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>esri-loader</h3>\n<p>写出一个基本的 demo，在外网的情况下以天地图的图层进行访问，在内网以内部服务器返回的图层进行访问，在内网验证成功，未发现多余请求，主要验证代码如下：</p>\n<div>\n          <div\n            class="gatsby-resp-iframe-wrapper"\n            style="padding-bottom: 25%; position: relative; height: 0; overflow: hidden;margin-bottom: 2em"\n          >\n            <iframe src="/examples/arcgis-map-component-build-deploy/load-map-demo.html" style="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n          "></iframe>\n          </div>\n          </div>\n<p><div class="gatsby-highlight">\n        <pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>\n      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>\n      <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>initial-scale=1,maximum-scale=1,user-scalable=no<span class="token punctuation">"</span></span>\n    <span class="token punctuation">/></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>\n      Intro to MapView - Create a 2D map | Sample | ArcGIS API for JavaScript\n      4.18\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">\n      <span class="token selector">html,\n      body,\n      #viewDiv</span> <span class="token punctuation">{</span>\n        <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>\n        <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>\n        <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>\n        <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://js.arcgis.com/4.16/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n      <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n        <span class="token string">"esri/Map"</span><span class="token punctuation">,</span>\n        <span class="token string">"esri/views/MapView"</span><span class="token punctuation">,</span>\n        <span class="token string">"esri/layers/WebTileLayer"</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Map<span class="token punctuation">,</span> MapView<span class="token punctuation">,</span> WebTileLayer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 天地图加载图层，这里可以替换为内网服务器的图层</span>\n        <span class="token comment">// mapLayerUrlTemplate: 矢量底图经纬度投影</span>\n        <span class="token comment">// markerLayerUrlTemplate: 矢量注记经纬度投影</span>\n        <span class="token comment">// subDomains: 占位符</span>\n        <span class="token keyword">const</span> mapLayerUrlTemplate <span class="token operator">=</span> <span class="token string">\'http://{subDomain}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=vec&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;TILEMATRIX={level}&amp;TILEROW={row}&amp;TILECOL={col}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07\'</span>\n        <span class="token keyword">const</span> markerLayerUrlTemplate <span class="token operator">=</span> <span class="token string">\'http://{subDomain}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=cva&amp;STYLE=default&amp;TILEMATRIXSET=w&amp;FORMAT=tiles&amp;TILEMATRIX={level}&amp;TILEROW={row}&amp;TILECOL={col}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07\'</span>\n        <span class="token keyword">const</span> subDomains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'t0\'</span><span class="token punctuation">,</span> <span class="token string">\'t1\'</span><span class="token punctuation">,</span> <span class="token string">\'t2\'</span><span class="token punctuation">,</span> <span class="token string">\'t3\'</span><span class="token punctuation">,</span> <span class="token string">\'t4\'</span><span class="token punctuation">,</span> <span class="token string">\'t5\'</span><span class="token punctuation">,</span> <span class="token string">\'t6\'</span><span class="token punctuation">,</span> <span class="token string">\'t7\'</span><span class="token punctuation">]</span>\n\n        <span class="token keyword">const</span> mapLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> mapLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token keyword">const</span> markerLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> markerLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n        <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          layers<span class="token punctuation">:</span> <span class="token punctuation">[</span>mapLayer<span class="token punctuation">,</span> markerLayer<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          container<span class="token punctuation">:</span> <span class="token string">"viewDiv"</span><span class="token punctuation">,</span>\n          map<span class="token punctuation">,</span>\n          zoom<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">]</span> <span class="token comment">// longitude, latitude</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>\n          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载完成\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载失败\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>\n\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewDiv<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>\n        </div></p>\n<h2 id="经纬度修复"><a href="#%E7%BB%8F%E7%BA%AC%E5%BA%A6%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>经纬度修复</h2>\n<p>在地图上加载公司数据组给的数据时，发现有很多地点对应的经纬度有偏差，需要对数据组的经纬度数据修复</p>\n<h3 id="外网天地图修复脚本"><a href="#%E5%A4%96%E7%BD%91%E5%A4%A9%E5%9C%B0%E5%9B%BE%E4%BF%AE%E5%A4%8D%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>外网天地图修复脚本</h3>\n<p>核心逻辑：</p>\n<ol>\n<li>申请天地图服务器端的 key，确保根据地点获取地点详情接口请求成功</li>\n<li>考虑到天地图开放 API 可能有频率限制，采用串行逻辑请求接口</li>\n<li>更新数据库时采用增量更新的方式，即需要判断写入的 lat 或 lon 字段是否已写入，每次查出未写入的再进行更新</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79653091441351400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\nconst ProgressBar = require(\'progress\');\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\n\n// curl --connect-timeout 999999 -m 999999 \'http://localhost:8000/stat-multi/train-analysis/get-all-station-info?isUseTianDiTuApi=1&isUpdateDatabase=1&pageSize=1000\'\n// http://api.tianditu.gov.cn/geocoder?ds={&quot;keyWord&quot;:&quot;弯坵火车站&quot;}&tk=f73eace6fbf7a640861984ea1b3ffa07\nasync function updateGps(params = {}) {\n  const { isUseTianDiTuApi, isUpdateDatabase, pageSize = 10, current = 1 } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n  function getTianDiTuInfo(keyword) {\n    const tianDiTuApiUrl = \'http://api.tianditu.gov.cn\';\n    const token = \'ab61c4d11eab1728b7f6ff48639bc73e\';\n    return new Promise((resolve, reject) => {\n      request(\n        {\n          method: \'GET\',\n          url: encodeURI(\\`\\${tianDiTuApiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${keyword}&quot;}&tk=\\${token}\\`),\n          timeout: 10000\n        },\n        (error, response) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve(response.body);\n          }\n        }\n      );\n    });\n  }\n\n  async function getListByKeyword() {\n    const list = [];\n    const bar = new ProgressBar(\'更新中 [:bar] :rate/bps :percent :etas\', { total: rsp.length });\n    for (const item of rsp) {\n      const rsp2 = await getTianDiTuInfo(\\`\\${item.zm}火车站\\`);\n      const response = JSON.parse(rsp2);\n      const lon = lodash.get(response, \'location.lon\');\n      const lat = lodash.get(response, \'location.lat\');\n      if (isUpdateDatabase) {\n        const sql = \\`update \\${targetTable} set lat=\'\\${lat}\', lon=\'\\${lon}\' where zmdm=\'\\${item.zmdm}\'\\`;\n        const rsp3 = await sequelize.query(sql, {\n          type: sequelize.QueryTypes.UPDATE\n        });\n        bar.tick();\n        // console.log(rsp3)\n      }\n      list.push({\n        ...item,\n        lon,\n        lat\n      });\n    }\n    if (bar.complete) {\n      console.log(\'\\n刷新数据库完成\\n\');\n    }\n    return list;\n  }\n\n  if (isUseTianDiTuApi) {\n    return getListByKeyword();\n  }\n  return rsp;\n}\n\nupdateGps({\n  isUseTianDiTuApi: true, // 是否使用天地图 API 获取经纬度\n  isUpdateDatabase: true, // 是否更新数据库\n  current: 1, // 当前页\n  pageSize: 100 // 第几页\n}).then((rsp) => {\n  console.log(\\`\\${rsp.length} 个数据更新成功\\`);\n  process.exit(0);\n});`, `79653091441351400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// curl --connect-timeout 999999 -m 999999 \'http://localhost:8000/stat-multi/train-analysis/get-all-station-info?isUseTianDiTuApi=1&amp;isUpdateDatabase=1&amp;pageSize=1000\'</span>\n<span class="token comment">// http://api.tianditu.gov.cn/geocoder?ds={"keyWord":"弯坵火车站"}&amp;tk=f73eace6fbf7a640861984ea1b3ffa07</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseTianDiTuApi<span class="token punctuation">,</span> isUpdateDatabase<span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> current <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">function</span> <span class="token function">getTianDiTuInfo</span><span class="token punctuation">(</span><span class="token parameter">keyword</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> tianDiTuApiUrl <span class="token operator">=</span> <span class="token string">\'http://api.tianditu.gov.cn\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">\'ab61c4d11eab1728b7f6ff48639bc73e\'</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">request</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span>\n          method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n          url<span class="token punctuation">:</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tianDiTuApiUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/geocoder?ds={"keyWord":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}&amp;tk=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n          timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getListByKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'更新中 [:bar] :rate/bps :percent :etas\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> total<span class="token punctuation">:</span> rsp<span class="token punctuation">.</span>length <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> rsp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> rsp2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getTianDiTuInfo</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">火车站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rsp2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> lon <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> lat <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lat\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdateDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set lat=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\', lon=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' where zmdm=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// console.log(rsp3)</span>\n      <span class="token punctuation">}</span>\n      list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        lon<span class="token punctuation">,</span>\n        lat\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'\\n刷新数据库完成\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseTianDiTuApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">getListByKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">updateGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseTianDiTuApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否使用天地图 API 获取经纬度</span>\n  isUpdateDatabase<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否更新数据库</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 当前页</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment">// 第几页</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rsp<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新成功</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="内网修复脚本"><a href="#%E5%86%85%E7%BD%91%E4%BF%AE%E5%A4%8D%E8%84%9A%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内网修复脚本</h3>\n<p>在以上的版本上，核心逻辑多了以下功能：</p>\n<ol>\n<li>内网接口返回的经纬度单位是转换墨卡托投影单位，需要用 gcoord 三方库做转换</li>\n<li>get 参数处理</li>\n<li>增加成功、失败总数统计</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1619093638052193500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\nconst ProgressBar = require(\'progress\');\nconst gcoord = require(\'gcoord\');\n\n// const result = gcoord.transform(\n//   [12580093.358100001, 3273944.1777000017],    // 经纬度坐标\n//   gcoord.WebMercator,               // 当前坐标系\n//   gcoord.WGS84                 // 目标坐标系\n// );\n\n// console.log(result)\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\nconst { withExtraQuery } = require(\'./utils\');\n\nfunction getInfoByZm(searchText) {\n  // const apiUrl = \'http://api.tianditu.gov.cn/geocoder\'\n  // const token = \'ab61c4d11eab1728b7f6ff48639bc73e\'\n  // const url = encodeURI(\\`\\${apiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${searchText}&quot;}&tk=\\${token}\\`)\n\n  const apiUrl = \'http://10.160.9.49:8080/OneMapServer/rest/services/SEARCH_QGCZ/Transfer/find\';\n  const params = {\n    f: \'json\',\n    searchText,\n    contains: false,\n    layers: \'0\',\n    searchFields: \'name,label\'\n  };\n  const url = withExtraQuery(apiUrl, params);\n  // console.log(url)\n  return new Promise((resolve, reject) => {\n    request(\n      {\n        method: \'GET\',\n        url,\n        timeout: 10000\n      },\n      (error, response) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve(response.body);\n        }\n      }\n    );\n  });\n}\n\nasync function updateList(rsp, isUpdate) {\n  const list = [];\n  const bar = new ProgressBar(\'更新中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\', {\n    total: rsp.length\n  });\n  let successTotal = 0;\n  let failTotal = 0;\n  for (const item of rsp) {\n    try {\n      const rsp2 = await getInfoByZm(item.zm.trim());\n\n      const response = JSON.parse(rsp2);\n      // 墨卡托投影单位，需要做转换\n      const x = lodash.get(response, \'results[0].geometry.x\');\n      const y = lodash.get(response, \'results[0].geometry.y\');\n\n      let lon = x;\n      let lat = y;\n      if (x && y) {\n        const result = gcoord.transform(\n          [x, y], // 坐标\n          gcoord.WebMercator, // 当前坐标系\n          gcoord.WGS84 // 目标坐标系\n        );\n        lon = result[0];\n        lat = result[1];\n      }\n\n      // const lon = lodash.get(response, \'location.lon\')\n      // const lat = lodash.get(response, \'location.lat\')\n\n      if (isUpdate) {\n        const sql = \\`update \\${targetTable} set lat=\'\\${lat}\', lon=\'\\${lon}\' where zmdm=\'\\${item.zmdm}\'\\`;\n        const rsp3 = await sequelize.query(sql, {\n          type: sequelize.QueryTypes.UPDATE\n        });\n        successTotal += 1;\n        bar.tick();\n      }\n      list.push({\n        ...item,\n        lon,\n        lat\n      });\n    } catch (error) {\n      console.log(error);\n      if (isUpdate) {\n        bar.tick();\n        failTotal += 1;\n      }\n    }\n  }\n  if (bar.complete) {\n    console.log(\\`\\${successTotal} 个数据更新成功，\\${failTotal} 个数据更新失败\\`);\n  }\n  return list;\n}\n\n// isUseApi: 是否使用 api 查询地理坐标\n// isUpdate: 是否同步到数据库\nasync function getGps(params = {}) {\n  const { isUseApi, isUpdate, pageSize, current } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n\n  if (isUseApi) {\n    return updateList(rsp, isUpdate);\n  }\n  return rsp;\n}\n\ngetGps({\n  isUseApi: true,\n  isUpdate: true,\n  current: 1,\n  pageSize: 1000\n}).then((rsp) => {\n  // console.log(rsp)\n  process.exit(0);\n});`, `1619093638052193500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> ProgressBar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'progress\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> gcoord <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'gcoord\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// const result = gcoord.transform(</span>\n<span class="token comment">//   [12580093.358100001, 3273944.1777000017],    // 经纬度坐标</span>\n<span class="token comment">//   gcoord.WebMercator,               // 当前坐标系</span>\n<span class="token comment">//   gcoord.WGS84                 // 目标坐标系</span>\n<span class="token comment">// );</span>\n\n<span class="token comment">// console.log(result)</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> withExtraQuery <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./utils\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token parameter">searchText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// const apiUrl = \'http://api.tianditu.gov.cn/geocoder\'</span>\n  <span class="token comment">// const token = \'ab61c4d11eab1728b7f6ff48639bc73e\'</span>\n  <span class="token comment">// const url = encodeURI(`${apiUrl}/geocoder?ds={"keyWord":"${searchText}"}&amp;tk=${token}`)</span>\n\n  <span class="token keyword">const</span> apiUrl <span class="token operator">=</span> <span class="token string">\'http://10.160.9.49:8080/OneMapServer/rest/services/SEARCH_QGCZ/Transfer/find\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>\n    f<span class="token punctuation">:</span> <span class="token string">\'json\'</span><span class="token punctuation">,</span>\n    searchText<span class="token punctuation">,</span>\n    contains<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    layers<span class="token punctuation">:</span> <span class="token string">\'0\'</span><span class="token punctuation">,</span>\n    searchFields<span class="token punctuation">:</span> <span class="token string">\'name,label\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">withExtraQuery</span><span class="token punctuation">(</span>apiUrl<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// console.log(url)</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">request</span><span class="token punctuation">(</span>\n      <span class="token punctuation">{</span>\n        method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n        url<span class="token punctuation">,</span>\n        timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateList</span><span class="token punctuation">(</span><span class="token parameter">rsp<span class="token punctuation">,</span> isUpdate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressBar</span><span class="token punctuation">(</span><span class="token string">\'更新中 [:bar] :rate/bps :percent :etas 第 :current 个 总共 :total 个\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    total<span class="token punctuation">:</span> rsp<span class="token punctuation">.</span>length\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> successTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> failTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> rsp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> rsp2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>zm<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rsp2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 墨卡托投影单位，需要做转换</span>\n      <span class="token keyword">const</span> x <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].geometry.x\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> y <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].geometry.y\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">let</span> lon <span class="token operator">=</span> x<span class="token punctuation">;</span>\n      <span class="token keyword">let</span> lat <span class="token operator">=</span> y<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> result <span class="token operator">=</span> gcoord<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>\n          <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 坐标</span>\n          gcoord<span class="token punctuation">.</span>WebMercator<span class="token punctuation">,</span> <span class="token comment">// 当前坐标系</span>\n          gcoord<span class="token punctuation">.</span><span class="token constant">WGS84</span> <span class="token comment">// 目标坐标系</span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        lon <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        lat <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// const lon = lodash.get(response, \'location.lon\')</span>\n      <span class="token comment">// const lat = lodash.get(response, \'location.lat\')</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set lat=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\', lon=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' where zmdm=\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        successTotal <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        lon<span class="token punctuation">,</span>\n        lat\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        bar<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        failTotal <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>bar<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>successTotal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新成功，</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>failTotal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据更新失败</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// isUseApi: 是否使用 api 查询地理坐标</span>\n<span class="token comment">// isUpdate: 是否同步到数据库</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseApi<span class="token punctuation">,</span> isUpdate<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> current <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">updateList</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> isUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">getGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  isUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">1000</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// console.log(rsp)</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>内网执行脚本刷新结果：共 <code class="language-text">8493</code> 条数据，<code class="language-text">2038</code> 条查不出结果(部分原因是命名不规范或者不存在这个站)，<code class="language-text">6455</code> 条查出经纬度并完成入库</p>\n<h3 id="脚本执行线程池化"><a href="#%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>脚本执行线程池化</h3>\n<p>在以上的版本上，利用线程池的概念优化取数逻辑</p>\n<ol>\n<li>请求接口线程池化</li>\n<li>数据库数据更新线程池化</li>\n<li>数据库批量更新数据</li>\n</ol>\n<h4 id="带有并发数限制的异步任务"><a href="#%E5%B8%A6%E6%9C%89%E5%B9%B6%E5%8F%91%E6%95%B0%E9%99%90%E5%88%B6%E7%9A%84%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>带有并发数限制的异步任务</h4>\n<p>concurrentRun.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46561095305983490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制\n * @param {*} taskName 任务名称\n */\nmodule.exports = async function concurrentRun(fnList = [], max = 5, taskName = \'未命名\') {\n  if (!fnList.length) return;\n\n  console.log(\\`开始执行多个异步任务，最大并发数： \\${max}\\`);\n  const replyList = []; // 收集任务执行结果\n  const count = fnList.length; // 总任务数量\n  const startTime = new Date().getTime(); // 记录任务执行开始时间\n\n  let current = 0;\n  // 任务执行程序\n  const schedule = async (index) => {\n    return new Promise(async (resolve) => {\n      try {\n        const fn = fnList[index];\n        if (!fn) return resolve();\n\n        // 执行当前异步任务\n        const reply = await fn();\n        replyList[index] = reply;\n      } catch (e) {\n        console.log(e);\n        // 报错了不管继续下一个\n        resolve();\n      }\n\n      current++;\n      console.log(\n        \\`\\${taskName} 事务进度，第 \\${current} 个，共 \\${count} 个，进度为 \\${((current / count) * 100).toFixed(2)}% \\`\n      );\n\n      // 执行完当前任务后，继续执行任务池的剩余任务\n      await schedule(index + max);\n      resolve();\n    });\n  };\n\n  // 任务池执行程序\n  const scheduleList = new Array(max).fill(0).map((_, index) => schedule(index));\n  // 使用 Promise.all 批量执行\n  const r = await Promise.all(scheduleList);\n\n  const cost = (new Date().getTime() - startTime) / 1000;\n  console.log(\\`执行完成，最大并发数： \\${max}，耗时：\\${cost}s\\`);\n  return replyList;\n};`, `46561095305983490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/**\n * 执行多个异步任务\n * @param {*} fnList 任务列表\n * @param {*} max 最大并发数限制\n * @param {*} taskName 任务名称\n */</span>\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>fnList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> taskName <span class="token operator">=</span> <span class="token string">\'未命名\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fnList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>\n\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始执行多个异步任务，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> replyList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集任务执行结果</span>\n  <span class="token keyword">const</span> count <span class="token operator">=</span> fnList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 总任务数量</span>\n  <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录任务执行开始时间</span>\n\n  <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token comment">// 任务执行程序</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">schedule</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> fn <span class="token operator">=</span> fnList<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 执行当前异步任务</span>\n        <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        replyList<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> reply<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 报错了不管继续下一个</span>\n        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      current<span class="token operator">++</span><span class="token punctuation">;</span>\n      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\n        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>taskName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 事务进度，第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>current<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个，共 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个，进度为 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span><span class="token punctuation">(</span>current <span class="token operator">/</span> count<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">% </span><span class="token template-punctuation string">`</span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 执行完当前任务后，继续执行任务池的剩余任务</span>\n      <span class="token keyword">await</span> <span class="token function">schedule</span><span class="token punctuation">(</span>index <span class="token operator">+</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 任务池执行程序</span>\n  <span class="token keyword">const</span> scheduleList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">schedule</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 使用 Promise.all 批量执行</span>\n  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>scheduleList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> cost <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行完成，最大并发数： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，耗时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cost<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> replyList<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="请求接口并发执行数据更新并发执行"><a href="#%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>请求接口并发执行/数据更新并发执行</h4>\n<p>index.js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23650828702566740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const request = require(\'request\');\nconst lodash = require(\'lodash\');\n\nconst { sequelize } = require(\'./sequelize.js\');\nconst { targetTable } = require(\'./config.js\');\nconst concurrentRun = require(\'./concurrentRun.js\');\n\nfunction getInfoByZm(keyword) {\n  const tianDiTuApiUrl = \'http://api.tianditu.gov.cn\';\n  const token = \'ab61c4d11eab1728b7f6ff48639bc73e\';\n  return new Promise((resolve, reject) => {\n    request(\n      {\n        method: \'GET\',\n        url: encodeURI(\\`\\${tianDiTuApiUrl}/geocoder?ds={&quot;keyWord&quot;:&quot;\\${keyword}&quot;}&tk=\\${token}\\`),\n        timeout: 10000\n      },\n      (error, response) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve(response.body);\n        }\n      }\n    );\n  });\n}\n\nasync function updateDataBase(rsp) {\n  const zmdms = [];\n  const lons = [];\n  const lats = [];\n  rsp.forEach((item) => {\n    const lon = lodash.get(item.response, \'location.lon\');\n    const lat = lodash.get(item.response, \'location.lat\');\n    zmdms.push(\\`\'\\${item.zmdm}\'\\`);\n    lons.push(\\`when \'\\${item.zmdm}\' then \'\\${lon}\'\\`);\n    lats.push(\\`when \'\\${item.zmdm}\' then \'\\${lat}\'\\`);\n  });\n\n  const sql = \\`\n    update \\${targetTable} set \n    lon = case zmdm \\${lons.join(\' \')} end,\n    lat = case zmdm \\${lats.join(\' \')} end \n    where zmdm in (\\${zmdms.join(\',\')})\n  \\`;\n\n  const rsp3 = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.UPDATE\n  });\n}\n\nasync function updateList(rsp, isUpdate) {\n  const requestFnList = rsp.map((item) => () => getInfoByZm(\\`\\${item.zm.trim()}火车站\\`));\n\n  const list = await concurrentRun(requestFnList, 100, \'请求天地图\');\n\n  const result = rsp.map((item, index) => {\n    try {\n      return {\n        ...item,\n        response: JSON.parse(list[index])\n      };\n    } catch (e) {\n      return item;\n    }\n  });\n\n  if (isUpdate) {\n    // 每 100 个分隔成一组\n    const updateFnList = lodash.chunk(result, 100).map((item) => () => updateDataBase(item));\n\n    await concurrentRun(updateFnList, 5, \'保存到数据库\');\n  }\n  return list;\n}\n\n// isUseApi: 是否使用 api 查询地理坐标\n// isUpdate: 是否同步到数据库\n// pageSize:\nasync function getGps(params = {}) {\n  const { isUseApi, isUpdate, pageSize = 10, current = 1 } = params;\n  const offset = (current - 1) * pageSize;\n  const sql = \\`select * from \\${targetTable} where lat is null or lon is null order by zmdm limit \\${pageSize} offset \\${offset}\\`;\n  const rsp = await sequelize.query(sql, {\n    type: sequelize.QueryTypes.SELECT\n  });\n\n  if (isUseApi) {\n    return updateList(rsp, isUpdate);\n  }\n  return rsp;\n}\n\ngetGps({\n  isUseApi: true,\n  isUpdate: true,\n  current: 1,\n  pageSize: 9000\n}).then((rsp) => {\n  // console.log(rsp)\n  process.exit(0);\n});`, `23650828702566740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'request\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> lodash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'lodash\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./sequelize.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> targetTable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./config.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> concurrentRun <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'./concurrentRun.js\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token parameter">keyword</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> tianDiTuApiUrl <span class="token operator">=</span> <span class="token string">\'http://api.tianditu.gov.cn\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">\'ab61c4d11eab1728b7f6ff48639bc73e\'</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token function">request</span><span class="token punctuation">(</span>\n      <span class="token punctuation">{</span>\n        method<span class="token punctuation">:</span> <span class="token string">\'GET\'</span><span class="token punctuation">,</span>\n        url<span class="token punctuation">:</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tianDiTuApiUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/geocoder?ds={"keyWord":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}&amp;tk=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        timeout<span class="token punctuation">:</span> <span class="token number">10000</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateDataBase</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> zmdms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lons <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> lats <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  rsp<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> lon <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lon\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> lat <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>response<span class="token punctuation">,</span> <span class="token string">\'location.lat\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    zmdms<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    lons<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">when \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' then \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    lats<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">when \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zmdm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\' then \'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n    update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> set \n    lon = case zmdm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lons<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> end,\n    lat = case zmdm </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lats<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> end \n    where zmdm in (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>zmdms<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\',\'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)\n  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> rsp3 <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">UPDATE</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateList</span><span class="token punctuation">(</span><span class="token parameter">rsp<span class="token punctuation">,</span> isUpdate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> requestFnList <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">getInfoByZm</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">火车站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>requestFnList<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">\'请求天地图\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> result <span class="token operator">=</span> rsp<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token operator">...</span>item<span class="token punctuation">,</span>\n        response<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> item<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 每 100 个分隔成一组</span>\n    <span class="token keyword">const</span> updateFnList <span class="token operator">=</span> lodash<span class="token punctuation">.</span><span class="token function">chunk</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateDataBase</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">await</span> <span class="token function">concurrentRun</span><span class="token punctuation">(</span>updateFnList<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'保存到数据库\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> list<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// isUseApi: 是否使用 api 查询地理坐标</span>\n<span class="token comment">// isUpdate: 是否同步到数据库</span>\n<span class="token comment">// pageSize:</span>\n<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getGps</span><span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> isUseApi<span class="token punctuation">,</span> isUpdate<span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> current <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>targetTable<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where lat is null or lon is null order by zmdm limit </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> offset </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    type<span class="token punctuation">:</span> sequelize<span class="token punctuation">.</span>QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUseApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">updateList</span><span class="token punctuation">(</span>rsp<span class="token punctuation">,</span> isUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">getGps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  isUseApi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  isUpdate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  current<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n  pageSize<span class="token punctuation">:</span> <span class="token number">9000</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rsp</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// console.log(rsp)</span>\n  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="执行结果"><a href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>执行结果</h4>\n<p>以 1000 个数据为例</p>\n<p>不带并行执行情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82923566832209820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1000 个数据更新成功，0 个数据更新失败\nDone in 168.70s.`, `82923566832209820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1000 个数据更新成功，0 个数据更新失败\nDone in 168.70s.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>带并行执行情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43503246798857420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`开始执行多个异步任务，最大并发数： 100\n执行完成，最大并发数： 100，耗时：19.954s\n开始执行多个异步任务，最大并发数： 5\n执行完成，最大并发数： 5，耗时：0.289s\nDone in 21.41s.`, `43503246798857420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">开始执行多个异步任务，最大并发数： 100\n执行完成，最大并发数： 100，耗时：19.954s\n开始执行多个异步任务，最大并发数： 5\n执行完成，最大并发数： 5，耗时：0.289s\nDone in 21.41s.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="人工修复"><a href="#%E4%BA%BA%E5%B7%A5%E4%BF%AE%E5%A4%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>人工修复</h3>\n<p>经过以上修复，还是有部分数据未查到结果，最终采用内部（另外合作商）经纬度去修复</p>\n<h1 id="组件设计"><a href="#%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>组件设计</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72701381029517885000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`.\n├── api.js # api 请求，主要用来获取地图配置\n├── components\n│   ├── map\n│   │   ├── hooks\n│   │   │   ├── use-goto-map.js # 地图导航\n│   │   │   └── use-load-map.js # 地图加载\n│   │   └── index.jsx # 地图组件主入口\n│   └── route-display-layer\n│       ├── hooks\n│       │   ├── use-add-or-del-point.js # 设置删除、添加的监听事件\n│       │   ├── use-draw-line # 画地图上的线\n│       │   │   ├── const.js\n│       │   │   └── index.js\n│       │   ├── use-draw-point # 画地图上的非选中的点\n│       │   │   └── index.js\n│       │   ├── use-draw-start-pass-end # 画地图上的选中点\n│       │   │   ├── images\n│       │   │   │   ├── 圆心.png\n│       │   │   │   ├── 定位_终点.svg\n│       │   │   │   ├── 定位_起点.svg\n│       │   │   │   └── 定位_途点.svg\n│       │   │   └── index.js\n│       │   └── use-show-hover-text.js # 设置悬浮文字\n│       ├── index.jsx # 路线组件主入口\n│       └── styles.less\n├── index.jsx # 主入口文件\n└── styles.less`, `72701381029517885000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                bash 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">.</span>\n├── api.js <span class="token comment"># api 请求，主要用来获取地图配置</span>\n├── components\n│   ├── map\n│   │   ├── hooks\n│   │   │   ├── use-goto-map.js <span class="token comment"># 地图导航</span>\n│   │   │   └── use-load-map.js <span class="token comment"># 地图加载</span>\n│   │   └── index.jsx <span class="token comment"># 地图组件主入口</span>\n│   └── route-display-layer\n│       ├── hooks\n│       │   ├── use-add-or-del-point.js <span class="token comment"># 设置删除、添加的监听事件</span>\n│       │   ├── use-draw-line <span class="token comment"># 画地图上的线</span>\n│       │   │   ├── const.js\n│       │   │   └── index.js\n│       │   ├── use-draw-point <span class="token comment"># 画地图上的非选中的点</span>\n│       │   │   └── index.js\n│       │   ├── use-draw-start-pass-end <span class="token comment"># 画地图上的选中点</span>\n│       │   │   ├── images\n│       │   │   │   ├── 圆心.png\n│       │   │   │   ├── 定位_终点.svg\n│       │   │   │   ├── 定位_起点.svg\n│       │   │   │   └── 定位_途点.svg\n│       │   │   └── index.js\n│       │   └── use-show-hover-text.js <span class="token comment"># 设置悬浮文字</span>\n│       ├── index.jsx <span class="token comment"># 路线组件主入口</span>\n│       └── styles.less\n├── index.jsx <span class="token comment"># 主入口文件</span>\n└── styles.less</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="具体功能"><a href="#%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>具体功能</h1>\n<h2 id="主入口文件"><a href="#%E4%B8%BB%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主入口文件</h2>\n<p>核心逻辑：</p>\n<ol>\n<li>兼容地图配置从外部传入的情况</li>\n<li>path（站点数据）需要过滤掉经纬度无意义的站点</li>\n<li>route（路线信息）需要过滤掉缺失的线路，即 2 个站点间的路线有可能未知</li>\n<li>map, view 实例存在时才去渲染路线相关的组件</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8258649939319395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useEffect } from \'react\';\nimport { setDefaultOptions } from \'esri-loader\';\n\nimport RouteDisplayLayer from \'./components/route-display-layer\';\nimport Map from \'./components/map\';\nimport { getConfig } from \'./api\';\n\nimport styles from \'./styles.less\';\n\nsetDefaultOptions({\n  css: \'/static-apps/mut/arcgis/esri/themes/light/main.css\',\n  url: \'/static-apps/mut/arcgis/init.js\'\n});\n\n/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  showAddOrDelBtn: 是否显示添加删除按钮，\n  showLineInfo: 是否显示路线信息\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息（线路密度）\n*/\n\nexport { getConfig };\n\nexport default function RailwayMap(props) {\n  const { path, route } = props;\n  const [config, setConfig] = useState(props.config);\n\n  useEffect(() => {\n    const fetchConfig = async () => {\n      const data = await getConfig();\n      setConfig(data.result);\n    };\n    if (!config) {\n      fetchConfig();\n    }\n  }, [config]);\n\n  const { centerLon = 110, centerLat = 38, zoom = 5 } = props.settings || {};\n\n  const [map, setMap] = useState();\n  const [view, setView] = useState();\n\n  if (!config) {\n    return null;\n  }\n\n  const isFloat = (number) => /^(-?\\d+)(\\.\\d+)?\\$/.test(number);\n\n  // 过滤掉没有经纬度结点或者经纬度为 0 的结点\n  const filterPath = path.filter(\n    (item) => isFloat(item.lat) && isFloat(item.lon) && +item.lat !== 0 && +item.lon !== 0\n  );\n\n  const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm) || {};\n\n  const filterRoute = [];\n  for (let i = 0; i < route.length; i++) {\n    // 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线\n    // 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线\n    if (\n      getPointInfoByZmdm(route[i].zmdm).lon &&\n      getPointInfoByZmdm(route[i].zmdm).lat &&\n      (!getPointInfoByZmdm(route[i].next_zmdm).lon || !getPointInfoByZmdm(route[i].next_zmdm).lat)\n    ) {\n      const { zm: startZm, zmdm: startZmdm, xm } = route[i];\n\n      // 累加缺失的站点的里程数\n      let distance = 0;\n      if (route[i].czjl) {\n        distance = route[i].czjl;\n      }\n\n      let index = null;\n      for (let j = i + 1; j < route.length; j++) {\n        if (route[j].czjl) {\n          distance += route[j].czjl;\n        }\n        // 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并\n        if (getPointInfoByZmdm(route[j].next_zmdm).lon && getPointInfoByZmdm(route[j].next_zmdm).lat) {\n          index = j;\n          break;\n        }\n      }\n      if (!index) {\n        // eslint-disable-next-line no-continue\n        continue;\n      }\n      const { next_zmdm: endZmdm, next_zm: endZm } = route[index];\n      filterRoute.push({\n        zmdm: startZmdm,\n        zm: startZm,\n        next_zmdm: endZmdm,\n        next_zm: endZm,\n        xm,\n        czjl: distance\n      });\n      i = index;\n    }\n\n    // 经纬度都有的结点直接插入\n    if (\n      getPointInfoByZmdm(route[i].zmdm).lon &&\n      getPointInfoByZmdm(route[i].zmdm).lat &&\n      getPointInfoByZmdm(route[i].next_zmdm).lon &&\n      getPointInfoByZmdm(route[i].next_zmdm).lat\n    ) {\n      filterRoute.push(route[i]);\n    }\n  }\n\n  return (\n    <div className={styles.container}>\n      <Map\n        {...props}\n        config={config}\n        viewProperties={{\n          zoom: +zoom,\n          center: [+centerLon, +centerLat]\n        }}\n        setMap={setMap}\n        setView={setView}\n        view={view}\n      />\n      {map && view && <RouteDisplayLayer {...props} path={filterPath} route={filterRoute} map={map} view={view} />}\n    </div>\n  );\n}`, `8258649939319395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDefaultOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> RouteDisplayLayer <span class="token keyword">from</span> <span class="token string">\'./components/route-display-layer\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Map <span class="token keyword">from</span> <span class="token string">\'./components/map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./api\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token function">setDefaultOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  css<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/esri/themes/light/main.css\'</span><span class="token punctuation">,</span>\n  url<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/init.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  showAddOrDelBtn: 是否显示添加删除按钮，\n  showLineInfo: 是否显示路线信息\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息（线路密度）\n*/</span>\n\n<span class="token keyword">export</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> route <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>config<span class="token punctuation">,</span> setConfig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">fetchConfig</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setConfig</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">fetchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>config<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> centerLon <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">,</span> centerLat <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">.</span>settings <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>map<span class="token punctuation">,</span> setMap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> setView<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">isFloat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/^(-?\\d+)(\\.\\d+)?$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 过滤掉没有经纬度结点或者经纬度为 0 的结点</span>\n  <span class="token keyword">const</span> filterPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\n    <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon <span class="token operator">!==</span> <span class="token number">0</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> filterRoute <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线</span>\n    <span class="token comment">// 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span>\n      <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span>\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span> zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span> xm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n      <span class="token comment">// 累加缺失的站点的里程数</span>\n      <span class="token keyword">let</span> distance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        distance <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          distance <span class="token operator">+=</span> route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          index <span class="token operator">=</span> j<span class="token punctuation">;</span>\n          <span class="token keyword">break</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// eslint-disable-next-line no-continue</span>\n        <span class="token keyword">continue</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span> next_zm<span class="token punctuation">:</span> endZm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      filterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span>\n        zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span>\n        next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span>\n        next_zm<span class="token punctuation">:</span> endZm<span class="token punctuation">,</span>\n        xm<span class="token punctuation">,</span>\n        czjl<span class="token punctuation">:</span> distance\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      i <span class="token operator">=</span> index<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 经纬度都有的结点直接插入</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span>\n      <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      filterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Map\n        <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        viewProperties<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          zoom<span class="token punctuation">:</span> <span class="token operator">+</span>zoom<span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">+</span>centerLon<span class="token punctuation">,</span> <span class="token operator">+</span>centerLat<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span>\n        setMap<span class="token operator">=</span><span class="token punctuation">{</span>setMap<span class="token punctuation">}</span>\n        setView<span class="token operator">=</span><span class="token punctuation">{</span>setView<span class="token punctuation">}</span>\n        view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>map <span class="token operator">&amp;&amp;</span> view <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>RouteDisplayLayer <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> path<span class="token operator">=</span><span class="token punctuation">{</span>filterPath<span class="token punctuation">}</span> route<span class="token operator">=</span><span class="token punctuation">{</span>filterRoute<span class="token punctuation">}</span> map<span class="token operator">=</span><span class="token punctuation">{</span>map<span class="token punctuation">}</span> view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图组件主入口"><a href="#%E5%9C%B0%E5%9B%BE%E7%BB%84%E4%BB%B6%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图组件主入口</h2>\n<p>采用 hooks 方式拆分，下面的组件也是采用类似的拆分</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55312045634386700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useRef } from \'react\';\n\nimport useLoadMap from \'./hooks/use-load-map\';\nimport useGotoMap from \'./hooks/use-goto-map\';\n\nexport default function Map(props) {\n  const { height } = props;\n  const mapRef = useRef();\n  useLoadMap({\n    ...props,\n    mapRef\n  });\n  useGotoMap(props);\n\n  return (\n    <div\n      style={{\n        height\n      }}\n      ref={mapRef}\n    />\n  );\n}`, `55312045634386700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useLoadMap <span class="token keyword">from</span> <span class="token string">\'./hooks/use-load-map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useGotoMap <span class="token keyword">from</span> <span class="token string">\'./hooks/use-goto-map\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> mapRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">useLoadMap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token operator">...</span>props<span class="token punctuation">,</span>\n    mapRef\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">useGotoMap</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div\n      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n        height\n      <span class="token punctuation">}</span><span class="token punctuation">}</span>\n      ref<span class="token operator">=</span><span class="token punctuation">{</span>mapRef<span class="token punctuation">}</span>\n    <span class="token operator">/</span><span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图加载"><a href="#%E5%9C%B0%E5%9B%BE%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图加载</h2>\n<p>需要监听地图组件图层加载完毕事件</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72784361395458744000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect } from \'react\';\nimport { loadModules } from \'esri-loader\';\n\n// 地图加载\nexport default function useLoadMap(props) {\n  const { setMap, setView, viewProperties, config, mapRef, onRef } = props;\n  const { mapLayerUrlTemplate, subDomains, markerLayerUrlTemplate } = config;\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=layers-webtile-3d\n    loadModules([\'esri/Map\', \'esri/views/MapView\', \'esri/layers/WebTileLayer\'])\n      .then(([Map, MapView, WebTileLayer]) => {\n        const mapLayer = new WebTileLayer({\n          urlTemplate: mapLayerUrlTemplate,\n          subDomains\n        });\n        const markerLayer = new WebTileLayer({\n          urlTemplate: markerLayerUrlTemplate,\n          subDomains\n        });\n\n        const map = new Map({\n          layers: [mapLayer, markerLayer]\n        });\n\n        const view = new MapView({\n          container: mapRef.current,\n          map,\n          ...viewProperties\n        });\n\n        view.ui.move(\'zoom\', \'bottom-right\');\n\n        view.when(\n          () => {\n            console.log(\'地图加载完成\');\n            setMap(map);\n            setView(view);\n            onRef &&\n              onRef({\n                map,\n                view\n              });\n          },\n          (error) => {\n            console.log(\'地图加载失败\', error);\n          }\n        );\n      })\n      .catch((err) => {\n        // handle any errors\n        console.error(err);\n      });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [setMap, setView]);\n}`, `72784361395458744000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 地图加载</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useLoadMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> setMap<span class="token punctuation">,</span> setView<span class="token punctuation">,</span> viewProperties<span class="token punctuation">,</span> config<span class="token punctuation">,</span> mapRef<span class="token punctuation">,</span> onRef <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> mapLayerUrlTemplate<span class="token punctuation">,</span> subDomains<span class="token punctuation">,</span> markerLayerUrlTemplate <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=layers-webtile-3d</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Map\'</span><span class="token punctuation">,</span> <span class="token string">\'esri/views/MapView\'</span><span class="token punctuation">,</span> <span class="token string">\'esri/layers/WebTileLayer\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Map<span class="token punctuation">,</span> MapView<span class="token punctuation">,</span> WebTileLayer<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> mapLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> mapLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> markerLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebTileLayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          urlTemplate<span class="token punctuation">:</span> markerLayerUrlTemplate<span class="token punctuation">,</span>\n          subDomains\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          layers<span class="token punctuation">:</span> <span class="token punctuation">[</span>mapLayer<span class="token punctuation">,</span> markerLayer<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n          container<span class="token punctuation">:</span> mapRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span>\n          map<span class="token punctuation">,</span>\n          <span class="token operator">...</span>viewProperties\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span>ui<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token string">\'zoom\'</span><span class="token punctuation">,</span> <span class="token string">\'bottom-right\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        view<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>\n          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载完成\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">setMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">setView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            onRef <span class="token operator">&amp;&amp;</span>\n              <span class="token function">onRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                map<span class="token punctuation">,</span>\n                view\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'地图加载失败\'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">// handle any errors</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>setMap<span class="token punctuation">,</span> setView<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="地图导航"><a href="#%E5%9C%B0%E5%9B%BE%E5%AF%BC%E8%88%AA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>地图导航</h2>\n<p>初始化时直接导航到相应路线（暂时有 bug，因为不能确定路线组件完全加载的时机而导致的偶尔路线渲染不出来的现象）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98646626457647350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect } from \'react\';\n\n// 地图导航\nexport default function useGotoMap(props) {\n  const { view, goToCenter, path } = props;\n\n  useEffect(() => {\n    if (!view || !goToCenter || !path || !path.length) {\n      return;\n    }\n\n    // 暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug\n    if (goToCenter === true) {\n      view.goTo(\n        {\n          target: view.graphics\n        },\n        {\n          animate: false\n        }\n      );\n    } else {\n      view.goTo(goToCenter);\n    }\n  }, [path, view, goToCenter]);\n\n  // console.log(\'view\', view)\n  // const eventRef = useRef()\n  // useEffect(() => {\n  //   if (!view) {\n  //     return\n  //   }\n\n  //   eventRef.current = view.on(\'layerview-create\', () => {\n  //     console.log(\'dsads\')\n  //     console.log(get(view, \'graphics._items\', []).length)\n  //   })\n\n  //   return () => {\n  //     eventRef.current && eventRef.current.remove()\n  //   }\n  // }, [view])\n}`, `98646626457647350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 地图导航</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useGotoMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> goToCenter<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>view <span class="token operator">||</span> <span class="token operator">!</span>goToCenter <span class="token operator">||</span> <span class="token operator">!</span>path <span class="token operator">||</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>goToCenter <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      view<span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span>\n        <span class="token punctuation">{</span>\n          target<span class="token punctuation">:</span> view<span class="token punctuation">.</span>graphics\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n          animate<span class="token punctuation">:</span> <span class="token boolean">false</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      view<span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span>goToCenter<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> view<span class="token punctuation">,</span> goToCenter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// console.log(\'view\', view)</span>\n  <span class="token comment">// const eventRef = useRef()</span>\n  <span class="token comment">// useEffect(() => {</span>\n  <span class="token comment">//   if (!view) {</span>\n  <span class="token comment">//     return</span>\n  <span class="token comment">//   }</span>\n\n  <span class="token comment">//   eventRef.current = view.on(\'layerview-create\', () => {</span>\n  <span class="token comment">//     console.log(\'dsads\')</span>\n  <span class="token comment">//     console.log(get(view, \'graphics._items\', []).length)</span>\n  <span class="token comment">//   })</span>\n\n  <span class="token comment">//   return () => {</span>\n  <span class="token comment">//     eventRef.current &amp;&amp; eventRef.current.remove()</span>\n  <span class="token comment">//   }</span>\n  <span class="token comment">// }, [view])</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="路线组件主入口"><a href="#%E8%B7%AF%E7%BA%BF%E7%BB%84%E4%BB%B6%E4%B8%BB%E5%85%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>路线组件主入口</h2>\n<ol>\n<li>渲染路线信息组件</li>\n<li>渲染悬浮文字组件</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74498385411902780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { Fragment, useRef, useState } from \'react\';\nimport { ShrinkOutlined, ArrowsAltOutlined } from \'@ant-design/icons\';\nimport classnames from \'classnames\';\nimport { Button } from \'antd\';\n\nimport useDrawLine from \'./hooks/use-draw-line\';\nimport useDrawPoint from \'./hooks/use-draw-point\';\nimport useDrawStartPassEnd from \'./hooks/use-draw-start-pass-end\';\nimport useAddOrDelPoint from \'./hooks/use-add-or-del-point\';\nimport useShowHoverText from \'./hooks/use-show-hover-text\';\n\nimport styles from \'./styles.less\';\n\nexport default function RouteDisplayLayer(props) {\n  const { showLineInfo = true } = props;\n\n  const { lineInfo } = useDrawLine(props);\n\n  const [isExpand, setIsExpand] = useState(true);\n\n  useDrawPoint(props);\n\n  useDrawStartPassEnd(props);\n\n  useAddOrDelPoint(props);\n\n  const hoverNodeRef = useRef();\n\n  useShowHoverText({\n    ...props,\n    hoverNodeRef\n  });\n\n  const totalDistance = lineInfo.reduce((pre, cur) => pre + cur.distance, 0);\n\n  const totalHint = (\n    <span>\n      全程\n      {totalDistance}\n      公里\n    </span>\n  );\n\n  return (\n    <Fragment>\n      <span className={styles.hoverNode} ref={hoverNodeRef} />\n      {showLineInfo &&\n        lineInfo &&\n        lineInfo.length > 0 &&\n        (isExpand ? (\n          <div className={classnames(styles.lineInfoContainer, styles.lineInfo)}>\n            <div className={styles.header}>\n              {totalHint}\n              <div className={styles.expandBtn}>\n                <ShrinkOutlined onClick={() => setIsExpand(false)} />\n              </div>\n            </div>\n            <div className={styles.body}>\n              {lineInfo.map((item) => (\n                <div key={item.xm} className={styles.item}>\n                  <span\n                    className={styles.color}\n                    style={{\n                      background: item.color\n                    }}\n                  />\n                  <span className={styles.xm}>{item.xm}</span>\n                </div>\n              ))}\n            </div>\n          </div>\n        ) : (\n          <div className={styles.lineInfoContainer}>\n            <Button onClick={() => setIsExpand(true)} icon={<ArrowsAltOutlined />}>\n              {totalHint}\n            </Button>\n          </div>\n        ))}\n    </Fragment>\n  );\n}`, `74498385411902780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Fragment<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> ShrinkOutlined<span class="token punctuation">,</span> ArrowsAltOutlined <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'@ant-design/icons\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> classnames <span class="token keyword">from</span> <span class="token string">\'classnames\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'antd\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> useDrawLine <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-line\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useDrawPoint <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-point\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useDrawStartPassEnd <span class="token keyword">from</span> <span class="token string">\'./hooks/use-draw-start-pass-end\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useAddOrDelPoint <span class="token keyword">from</span> <span class="token string">\'./hooks/use-add-or-del-point\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> useShowHoverText <span class="token keyword">from</span> <span class="token string">\'./hooks/use-show-hover-text\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RouteDisplayLayer</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> showLineInfo <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> lineInfo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useDrawLine</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>isExpand<span class="token punctuation">,</span> setIsExpand<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useDrawPoint</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useDrawStartPassEnd</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useAddOrDelPoint</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> hoverNodeRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useShowHoverText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token operator">...</span>props<span class="token punctuation">,</span>\n    hoverNodeRef\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> totalDistance <span class="token operator">=</span> lineInfo<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> cur<span class="token punctuation">.</span>distance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> totalHint <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>span<span class="token operator">></span>\n      全程\n      <span class="token punctuation">{</span>totalDistance<span class="token punctuation">}</span>\n      公里\n    <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>Fragment<span class="token operator">></span>\n      <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>hoverNode<span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>hoverNodeRef<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>showLineInfo <span class="token operator">&amp;&amp;</span>\n        lineInfo <span class="token operator">&amp;&amp;</span>\n        lineInfo<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>\n        <span class="token punctuation">(</span>isExpand <span class="token operator">?</span> <span class="token punctuation">(</span>\n          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>styles<span class="token punctuation">.</span>lineInfoContainer<span class="token punctuation">,</span> styles<span class="token punctuation">.</span>lineInfo<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>header<span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>totalHint<span class="token punctuation">}</span>\n              <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>expandBtn<span class="token punctuation">}</span><span class="token operator">></span>\n                <span class="token operator">&lt;</span>ShrinkOutlined onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setIsExpand</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>\n              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>lineInfo<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n                <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>xm<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>item<span class="token punctuation">}</span><span class="token operator">></span>\n                  <span class="token operator">&lt;</span>span\n                    className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>color<span class="token punctuation">}</span>\n                    style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n                      background<span class="token punctuation">:</span> item<span class="token punctuation">.</span>color\n                    <span class="token punctuation">}</span><span class="token punctuation">}</span>\n                  <span class="token operator">/</span><span class="token operator">></span>\n                  <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>xm<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>xm<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n              <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>\n          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>lineInfoContainer<span class="token punctuation">}</span><span class="token operator">></span>\n            <span class="token operator">&lt;</span>Button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setIsExpand</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span> icon<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>ArrowsAltOutlined <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>\n              <span class="token punctuation">{</span>totalHint<span class="token punctuation">}</span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">></span>\n          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>Fragment<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的线"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E7%BA%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的线</h2>\n<ol>\n<li>根据 route、path 渲染路线</li>\n<li>根据 transport 渲染路线粗细，同时弹窗显示线路密度</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21703380641600200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get, groupBy } from \'lodash\';\n\nimport { LINE_COLORS, getLineSize } from \'./const\';\n\n// 画地图上的线\nexport default function useDrawLine(props) {\n  const { path, view, route, transport } = props;\n\n  const polylineGraphicsRef = useRef();\n\n  useEffect(() => {\n    const groupMap = groupBy(route, (item) => item.xm);\n    const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm);\n\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        if (polylineGraphicsRef.current) {\n          polylineGraphicsRef.current.forEach((item) => {\n            view.graphics.remove(item);\n          });\n          polylineGraphicsRef.current = [];\n        }\n\n        /* 根据 path、transport 计算密度总数 */\n        // 根据经过的 path 即站点累加密度情况\n        const transportList = []; // 运输密度统计表，以 path 最小单元做计算\n        if (transport && transport.length > 0) {\n          transport.forEach((item) => {\n            // 找到上车站的下标\n            const startIndex = path.findIndex((item2) => item2.zmdm === item.zmdm_sc);\n            // 找到下车站的下标\n            const endIndex = path.findIndex((item2) => item2.zmdm === item.zmdm_xc);\n            // 遍历上车站到下车站的站点，累加所有密度\n            for (let i = startIndex; i < endIndex; i++) {\n              const startZmdm = get(path, \\`[\\${i}].zmdm\\`);\n              const endZmdm = get(path, \\`[\\${i + 1}].zmdm\\`);\n              const findTransportList = transportList.find(\n                (item2) => get(item2, \'start.zmdm\') === startZmdm && get(item2, \'end.zmdm\') === endZmdm\n              );\n              if (findTransportList) {\n                findTransportList.total += item.ysrs;\n              } else {\n                transportList.push({\n                  start: path[i],\n                  end: path[i + 1],\n                  total: item.ysrs\n                });\n              }\n            }\n          });\n        }\n        // 根据起点代码、终点代码找到密度数\n        const getPeopleNumberByStartEnd = (startZmdm, endZmdm) =>\n          get(\n            transportList.find((item) => get(item, \'start.zmdm\') === startZmdm && get(item, \'end.zmdm\') === endZmdm),\n            \'total\',\n            0\n          );\n        /* 根据 path、transport 计算密度总数 */\n\n        const polylineGraphics = [];\n\n        // 渲染线路\n        const renderLine = ({ paths, width, distance, xm, index, peopleNumber }) => {\n          const content = [];\n          if (distance) {\n            content.push(\\`里程：\\${distance} 公里\\`);\n          }\n          if (peopleNumber) {\n            content.push(\\`运输密度：\\${peopleNumber} 人\\`);\n          }\n          const polylineGraphic = new Graphic({\n            geometry: {\n              type: \'polyline\',\n              paths: paths.map((item) => [+get(item, \'lon\', 0), +get(item, \'lat\', 0)])\n            },\n            symbol: {\n              type: \'simple-line\',\n              color: LINE_COLORS[index % LINE_COLORS.length],\n              width\n            },\n            attributes: {\n              xm\n            },\n            popupTemplate: {\n              title: xm,\n              content: content.join(\'、\')\n            }\n          });\n          polylineGraphics.push(polylineGraphic);\n          view.graphics.add(polylineGraphic);\n        };\n\n        Object.keys(groupMap).forEach((key, index) => {\n          const paths = [];\n          let totalDistance = 0;\n          groupMap[key].forEach((item) => {\n            const startPointInfo = getPointInfoByZmdm(item.zmdm);\n            const endPointInfo = getPointInfoByZmdm(item.next_zmdm);\n            totalDistance += item.czjl || 0;\n            paths.push([startPointInfo, endPointInfo]);\n          });\n          if (transport && transport.length > 0) {\n            paths.forEach((item) => {\n              const [startPointInfo, endPointInfo] = item;\n              const peopleNumber = getPeopleNumberByStartEnd(get(startPointInfo, \'zmdm\'), get(endPointInfo, \'zmdm\'));\n              const width = getLineSize(peopleNumber);\n              // console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key, peopleNumber, width)\n              renderLine({\n                distance: totalDistance,\n                width: \\`\\${width}px\\`,\n                paths: item,\n                xm: key,\n                index,\n                peopleNumber\n              });\n            });\n          } else {\n            paths.forEach((item) => {\n              // const [startPointInfo, endPointInfo] = item\n              // console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key)\n              renderLine({\n                distance: totalDistance,\n                width: \'6px\',\n                paths: item,\n                xm: key,\n                index\n              });\n            });\n          }\n        });\n        polylineGraphicsRef.current = polylineGraphics;\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, transport, route]);\n\n  const lineInfo = [];\n\n  const groupMap = groupBy(route, (item) => item.xm);\n  Object.keys(groupMap).forEach((key, index) => {\n    lineInfo.push({\n      xm: key,\n      color: LINE_COLORS[index % LINE_COLORS.length],\n      distance: groupMap[key].reduce((pre, cur) => pre + (cur.czjl || 0), 0)\n    });\n  });\n\n  return {\n    lineInfo\n  };\n}`, `21703380641600200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> groupBy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">,</span> getLineSize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./const\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上的线</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawLine</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> view<span class="token punctuation">,</span> route<span class="token punctuation">,</span> transport <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> polylineGraphicsRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> groupMap <span class="token operator">=</span> <span class="token function">groupBy</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>xm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>polylineGraphicsRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          polylineGraphicsRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          polylineGraphicsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">/* 根据 path、transport 计算密度总数 */</span>\n        <span class="token comment">// 根据经过的 path 即站点累加密度情况</span>\n        <span class="token keyword">const</span> transportList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 运输密度统计表，以 path 最小单元做计算</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>transport <span class="token operator">&amp;&amp;</span> transport<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          transport<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token comment">// 找到上车站的下标</span>\n            <span class="token keyword">const</span> startIndex <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm_sc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 找到下车站的下标</span>\n            <span class="token keyword">const</span> endIndex <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm_xc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 遍历上车站到下车站的站点，累加所有密度</span>\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> startZmdm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].zmdm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> endZmdm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].zmdm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> findTransportList <span class="token operator">=</span> transportList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>\n                <span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item2<span class="token punctuation">,</span> <span class="token string">\'start.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> startZmdm <span class="token operator">&amp;&amp;</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item2<span class="token punctuation">,</span> <span class="token string">\'end.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> endZmdm\n              <span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">if</span> <span class="token punctuation">(</span>findTransportList<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                findTransportList<span class="token punctuation">.</span>total <span class="token operator">+=</span> item<span class="token punctuation">.</span>ysrs<span class="token punctuation">;</span>\n              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                transportList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                  start<span class="token punctuation">:</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  end<span class="token punctuation">:</span> path<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                  total<span class="token punctuation">:</span> item<span class="token punctuation">.</span>ysrs\n                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 根据起点代码、终点代码找到密度数</span>\n        <span class="token keyword">const</span> <span class="token function-variable function">getPeopleNumberByStartEnd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">startZmdm<span class="token punctuation">,</span> endZmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span>\n          <span class="token keyword">get</span><span class="token punctuation">(</span>\n            transportList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'start.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> startZmdm <span class="token operator">&amp;&amp;</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'end.zmdm\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> endZmdm<span class="token punctuation">)</span><span class="token punctuation">,</span>\n            <span class="token string">\'total\'</span><span class="token punctuation">,</span>\n            <span class="token number">0</span>\n          <span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">/* 根据 path、transport 计算密度总数 */</span>\n\n        <span class="token keyword">const</span> polylineGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 渲染线路</span>\n        <span class="token keyword">const</span> <span class="token function-variable function">renderLine</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> paths<span class="token punctuation">,</span> width<span class="token punctuation">,</span> distance<span class="token punctuation">,</span> xm<span class="token punctuation">,</span> index<span class="token punctuation">,</span> peopleNumber <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>distance<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">里程：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 公里</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>peopleNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">运输密度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>peopleNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 人</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">const</span> polylineGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n            geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              type<span class="token punctuation">:</span> <span class="token string">\'polyline\'</span><span class="token punctuation">,</span>\n              paths<span class="token punctuation">:</span> paths<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">+</span><span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'lon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'lat\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              type<span class="token punctuation">:</span> <span class="token string">\'simple-line\'</span><span class="token punctuation">,</span>\n              color<span class="token punctuation">:</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">[</span>index <span class="token operator">%</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>\n              width\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              xm\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n              title<span class="token punctuation">:</span> xm<span class="token punctuation">,</span>\n              content<span class="token punctuation">:</span> content<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">\'、\'</span><span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          polylineGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>polylineGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>polylineGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>groupMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n          <span class="token keyword">let</span> totalDistance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n          groupMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> startPointInfo <span class="token operator">=</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">const</span> endPointInfo <span class="token operator">=</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            totalDistance <span class="token operator">+=</span> item<span class="token punctuation">.</span>czjl <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>\n            paths<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>startPointInfo<span class="token punctuation">,</span> endPointInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>transport <span class="token operator">&amp;&amp;</span> transport<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> <span class="token punctuation">[</span>startPointInfo<span class="token punctuation">,</span> endPointInfo<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>\n              <span class="token keyword">const</span> peopleNumber <span class="token operator">=</span> <span class="token function">getPeopleNumberByStartEnd</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">(</span>startPointInfo<span class="token punctuation">,</span> <span class="token string">\'zmdm\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">(</span>endPointInfo<span class="token punctuation">,</span> <span class="token string">\'zmdm\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token function">getLineSize</span><span class="token punctuation">(</span>peopleNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>\n              <span class="token comment">// console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key, peopleNumber, width)</span>\n              <span class="token function">renderLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                distance<span class="token punctuation">:</span> totalDistance<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                paths<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                index<span class="token punctuation">,</span>\n                peopleNumber\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n              <span class="token comment">// const [startPointInfo, endPointInfo] = item</span>\n              <span class="token comment">// console.log(get(startPointInfo, \'zm\'), get(endPointInfo, \'zm\'), key)</span>\n              <span class="token function">renderLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n                distance<span class="token punctuation">:</span> totalDistance<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'6px\'</span><span class="token punctuation">,</span>\n                paths<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                index\n              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        polylineGraphicsRef<span class="token punctuation">.</span>current <span class="token operator">=</span> polylineGraphics<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> transport<span class="token punctuation">,</span> route<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> lineInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> groupMap <span class="token operator">=</span> <span class="token function">groupBy</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>xm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>groupMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    lineInfo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      xm<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n      color<span class="token punctuation">:</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">[</span>index <span class="token operator">%</span> <span class="token constant">LINE_COLORS</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span>\n      distance<span class="token punctuation">:</span> groupMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span>czjl <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    lineInfo\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的非选中的点"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E9%9D%9E%E9%80%89%E4%B8%AD%E7%9A%84%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的非选中的点</h2>\n<p>渲染非选中的站点，弹窗显示站点信息并显示添加按钮</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84232128976996140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get } from \'lodash\';\n\n// 画地图上的非过滤条件上的点\nexport default function useDrawPoint(props) {\n  const { path, pointInfo = [], view, showAddOrDelBtn = true } = props;\n  const routerRef = useRef({\n    // 属于路径但不在过滤条件里面的点\n    notFilterPointGraphics: []\n  });\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        /** 画点 **/\n        const notFilterPointGraphicsRef = routerRef.current.notFilterPointGraphics;\n        if (notFilterPointGraphicsRef.length) {\n          notFilterPointGraphicsRef.forEach((item) => {\n            view.graphics.remove(item);\n          });\n          routerRef.current.notFilterPointGraphics = [];\n        }\n        /* 非查询条件上的点 */\n        const notFilterPointGraphics = [];\n        const filterPath = pointInfo\n          .filter((item) => item.value)\n          .map((item) => ({\n            ...item,\n            zmdm: get(item, \'value.key\', \'\')\n          }));\n        path.forEach((item) => {\n          const filterPathIndex = filterPath.findIndex((item2) => item2.zmdm === item.zmdm);\n          if (filterPathIndex === -1) {\n            /** 不在筛选条件里面的点 **/\n            const pointGraphic = new Graphic({\n              attributes: {\n                point: item,\n                path\n              },\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'simple-marker\',\n                color: \'#fff\',\n                size: \'10px\',\n                outline: {\n                  color: \'#2c42af\',\n                  width: \'2px\'\n                }\n              },\n              popupTemplate: {\n                title: \\`\\${item.zm}\\`,\n                content: \\`经度：\\${item.lon}，纬度：\\${item.lat}\\`,\n                actions: showAddOrDelBtn\n                  ? [\n                      {\n                        title: \'添加\',\n                        id: \'add\',\n                        className: \'esri-icon-add-attachment\'\n                      }\n                    ]\n                  : []\n              }\n            });\n            notFilterPointGraphics.push(pointGraphic);\n            view.graphics.add(pointGraphic);\n            /** 不在筛选条件里面的点 **/\n          }\n        });\n\n        routerRef.current.notFilterPointGraphics = notFilterPointGraphics;\n        /** 画点 **/\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, pointInfo, showAddOrDelBtn]);\n}`, `84232128976996140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上的非过滤条件上的点</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawPoint</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> pointInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view<span class="token punctuation">,</span> showAddOrDelBtn <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> routerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token comment">// 属于路径但不在过滤条件里面的点</span>\n    notFilterPointGraphics<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">/** 画点 **/</span>\n        <span class="token keyword">const</span> notFilterPointGraphicsRef <span class="token operator">=</span> routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>notFilterPointGraphicsRef<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          notFilterPointGraphicsRef<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">/* 非查询条件上的点 */</span>\n        <span class="token keyword">const</span> notFilterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> filterPath <span class="token operator">=</span> pointInfo\n          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token operator">...</span>item<span class="token punctuation">,</span>\n            zmdm<span class="token punctuation">:</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPathIndex <span class="token operator">=</span> filterPath<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">/** 不在筛选条件里面的点 **/</span>\n            <span class="token keyword">const</span> pointGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                point<span class="token punctuation">:</span> item<span class="token punctuation">,</span>\n                path\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'simple-marker\'</span><span class="token punctuation">,</span>\n                color<span class="token punctuation">:</span> <span class="token string">\'#fff\'</span><span class="token punctuation">,</span>\n                size<span class="token punctuation">:</span> <span class="token string">\'10px\'</span><span class="token punctuation">,</span>\n                outline<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                  color<span class="token punctuation">:</span> <span class="token string">\'#2c42af\'</span><span class="token punctuation">,</span>\n                  width<span class="token punctuation">:</span> <span class="token string">\'2px\'</span>\n                <span class="token punctuation">}</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                title<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                content<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">经度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，纬度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                actions<span class="token punctuation">:</span> showAddOrDelBtn\n                  <span class="token operator">?</span> <span class="token punctuation">[</span>\n                      <span class="token punctuation">{</span>\n                        title<span class="token punctuation">:</span> <span class="token string">\'添加\'</span><span class="token punctuation">,</span>\n                        id<span class="token punctuation">:</span> <span class="token string">\'add\'</span><span class="token punctuation">,</span>\n                        className<span class="token punctuation">:</span> <span class="token string">\'esri-icon-add-attachment\'</span>\n                      <span class="token punctuation">}</span>\n                    <span class="token punctuation">]</span>\n                  <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            notFilterPointGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pointGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pointGraphic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 不在筛选条件里面的点 **/</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>notFilterPointGraphics <span class="token operator">=</span> notFilterPointGraphics<span class="token punctuation">;</span>\n        <span class="token comment">/** 画点 **/</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> pointInfo<span class="token punctuation">,</span> showAddOrDelBtn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="画地图上的选中点"><a href="#%E7%94%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E9%80%89%E4%B8%AD%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>画地图上的选中点</h2>\n<p>渲染选中的站点，弹窗显示站点信息并显示删除按钮</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26801498005874080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { loadModules } from \'esri-loader\';\nimport { get } from \'lodash\';\n\nimport startPositionIcon from \'./images/定位_起点.svg\';\nimport byPositionIcon from \'./images/定位_途点.svg\';\nimport endPositionIcon from \'./images/定位_终点.svg\';\nimport CircleIcon from \'./images/圆心.png\';\n\n// 画地图上过滤条件上的点\nexport default function useDrawStartPassEnd(props) {\n  const { path, pointInfo = [], view, showAddOrDelBtn = true } = props;\n  const routerRef = useRef({\n    // 过滤条件上的点\n    filterPointGraphics: []\n  });\n\n  useEffect(() => {\n    // https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/\n    // https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html\n    loadModules([\'esri/Graphic\'])\n      .then(([Graphic]) => {\n        /** 画点 **/\n        const filterPointGraphicsRef = routerRef.current.filterPointGraphics;\n        if (filterPointGraphicsRef.length) {\n          filterPointGraphicsRef.forEach((item) => {\n            const [pointGraphic, markerGraphic] = item;\n            view.graphics.removeMany([pointGraphic, markerGraphic]);\n          });\n          routerRef.current.filterPointGraphics = [];\n        }\n        /* 查询条件上的点 */\n        const filterPointGraphics = [];\n        const filterPath = pointInfo\n          .filter((item) => item.value)\n          .map((item) => ({\n            ...item,\n            zmdm: get(item, \'value.key\', \'\')\n          }));\n        path.forEach((item) => {\n          const filterPathIndex = filterPath.findIndex((item2) => item2.zmdm === item.zmdm);\n          if (filterPathIndex !== -1) {\n            /** 画起点、终点、途点 **/\n            let positionIcon = byPositionIcon;\n            if (filterPathIndex === 0) {\n              positionIcon = startPositionIcon;\n            } else if (filterPathIndex === filterPath.length - 1) {\n              positionIcon = endPositionIcon;\n            }\n            const markerGraphic = new Graphic({\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'picture-marker\',\n                url: positionIcon,\n                yoffset: \'25px\',\n                width: \'32px\',\n                height: \'37px\'\n              }\n            });\n            /** 画起点、终点、途点 **/\n\n            /** 画查询条件里面的标记点 **/\n            const pointGraphic = new Graphic({\n              attributes: {\n                point: item\n              },\n              geometry: {\n                type: \'point\',\n                longitude: +item.lon,\n                latitude: +item.lat\n              },\n              symbol: {\n                type: \'picture-marker\',\n                url: CircleIcon,\n                width: \'20px\',\n                height: \'20px\'\n              },\n              popupTemplate: {\n                title: \\`\\${item.zm}：第\\${filterPathIndex + 1}站\\`,\n                content: \\`经度：\\${item.lon}，纬度：\\${item.lat}\\`,\n                actions:\n                  showAddOrDelBtn && filterPath.length > 2\n                    ? [\n                        {\n                          title: \'删除\',\n                          id: \'delete\',\n                          className: \'esri-icon-trash\'\n                        }\n                      ]\n                    : []\n              }\n            });\n            /** 画查询条件里面的标记点 **/\n            filterPointGraphics.push([pointGraphic, markerGraphic]);\n            // routerRef.current.filterPointGraphics = filterPointGraphics\n            view.graphics.addMany([pointGraphic, markerGraphic]);\n          }\n        });\n\n        routerRef.current.filterPointGraphics = filterPointGraphics;\n        /** 画点 **/\n      })\n      .catch((err) => {\n        console.error(err);\n      });\n  }, [view, path, pointInfo, showAddOrDelBtn]);\n}`, `26801498005874080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> loadModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> startPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_起点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> byPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_途点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> endPositionIcon <span class="token keyword">from</span> <span class="token string">\'./images/定位_终点.svg\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> CircleIcon <span class="token keyword">from</span> <span class="token string">\'./images/圆心.png\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 画地图上过滤条件上的点</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useDrawStartPassEnd</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> pointInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view<span class="token punctuation">,</span> showAddOrDelBtn <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> routerRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token comment">// 过滤条件上的点</span>\n    filterPointGraphics<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/guide/display-point-line-and-polygon-graphics/</span>\n    <span class="token comment">// https://developers.arcgis.com/javascript/latest/sample-code/intro-graphics/index.html</span>\n    <span class="token function">loadModules</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'esri/Graphic\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Graphic<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token comment">/** 画点 **/</span>\n        <span class="token keyword">const</span> filterPointGraphicsRef <span class="token operator">=</span> routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics<span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPointGraphicsRef<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          filterPointGraphicsRef<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> <span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">removeMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">/* 查询条件上的点 */</span>\n        <span class="token keyword">const</span> filterPointGraphics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> filterPath <span class="token operator">=</span> pointInfo\n          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token operator">...</span>item<span class="token punctuation">,</span>\n            zmdm<span class="token punctuation">:</span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPathIndex <span class="token operator">=</span> filterPath<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item2</span><span class="token punctuation">)</span> <span class="token operator">=></span> item2<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">/** 画起点、终点、途点 **/</span>\n            <span class="token keyword">let</span> positionIcon <span class="token operator">=</span> byPositionIcon<span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              positionIcon <span class="token operator">=</span> startPositionIcon<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPathIndex <span class="token operator">===</span> filterPath<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              positionIcon <span class="token operator">=</span> endPositionIcon<span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n            <span class="token keyword">const</span> markerGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'picture-marker\'</span><span class="token punctuation">,</span>\n                url<span class="token punctuation">:</span> positionIcon<span class="token punctuation">,</span>\n                yoffset<span class="token punctuation">:</span> <span class="token string">\'25px\'</span><span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'32px\'</span><span class="token punctuation">,</span>\n                height<span class="token punctuation">:</span> <span class="token string">\'37px\'</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 画起点、终点、途点 **/</span>\n\n            <span class="token comment">/** 画查询条件里面的标记点 **/</span>\n            <span class="token keyword">const</span> pointGraphic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n              attributes<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                point<span class="token punctuation">:</span> item\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              geometry<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'point\'</span><span class="token punctuation">,</span>\n                longitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">,</span>\n                latitude<span class="token punctuation">:</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              symbol<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                type<span class="token punctuation">:</span> <span class="token string">\'picture-marker\'</span><span class="token punctuation">,</span>\n                url<span class="token punctuation">:</span> CircleIcon<span class="token punctuation">,</span>\n                width<span class="token punctuation">:</span> <span class="token string">\'20px\'</span><span class="token punctuation">,</span>\n                height<span class="token punctuation">:</span> <span class="token string">\'20px\'</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              popupTemplate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n                title<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>zm<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">：第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filterPathIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">站</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                content<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">经度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lon<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，纬度：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>lat<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n                actions<span class="token punctuation">:</span>\n                  showAddOrDelBtn <span class="token operator">&amp;&amp;</span> filterPath<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">2</span>\n                    <span class="token operator">?</span> <span class="token punctuation">[</span>\n                        <span class="token punctuation">{</span>\n                          title<span class="token punctuation">:</span> <span class="token string">\'删除\'</span><span class="token punctuation">,</span>\n                          id<span class="token punctuation">:</span> <span class="token string">\'delete\'</span><span class="token punctuation">,</span>\n                          className<span class="token punctuation">:</span> <span class="token string">\'esri-icon-trash\'</span>\n                        <span class="token punctuation">}</span>\n                      <span class="token punctuation">]</span>\n                    <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n              <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">/** 画查询条件里面的标记点 **/</span>\n            filterPointGraphics<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// routerRef.current.filterPointGraphics = filterPointGraphics</span>\n            view<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">addMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pointGraphic<span class="token punctuation">,</span> markerGraphic<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        routerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>filterPointGraphics <span class="token operator">=</span> filterPointGraphics<span class="token punctuation">;</span>\n        <span class="token comment">/** 画点 **/</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> path<span class="token punctuation">,</span> pointInfo<span class="token punctuation">,</span> showAddOrDelBtn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="设置悬浮文字"><a href="#%E8%AE%BE%E7%BD%AE%E6%82%AC%E6%B5%AE%E6%96%87%E5%AD%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置悬浮文字</h2>\n<p>设置鼠标轨迹监听事件，对站点、路线做悬浮文字提示处理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22619183818535272000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { get, throttle } from \'lodash\';\n\n// 添加悬浮文字监听事件\nexport default function useShowHoverText(props) {\n  const { hoverNodeRef, view } = props;\n  const removePointerMoveEventRef = useRef(() => {});\n\n  useEffect(() => {\n    const handlePointMoveEvent = throttle((event) => {\n      if (!hoverNodeRef.current) {\n        return;\n      }\n      view.hitTest(event).then((response) => {\n        const type = get(response, \'results[0].graphic.geometry.type\');\n        const attributes = get(response, \'results[0].graphic.attributes\');\n        if (type === \'polyline\' && attributes) {\n          event.native.target.style = \'cursor: pointer\';\n          const xm = get(attributes, \'xm\');\n          hoverNodeRef.current.innerText = xm;\n          hoverNodeRef.current.style.left = \\`\\${event.x}px\\`;\n          hoverNodeRef.current.style.top = \\`\\${event.y}px\\`;\n          hoverNodeRef.current.style.display = \'block\';\n        } else if (type === \'point\' && attributes) {\n          event.native.target.style = \'cursor: pointer\';\n          const zm = get(attributes, \'point.zm\');\n          hoverNodeRef.current.innerText = zm;\n          hoverNodeRef.current.style.left = \\`\\${event.x - zm.length * 9}px\\`;\n          hoverNodeRef.current.style.top = \\`\\${event.y - 40}px\\`;\n          hoverNodeRef.current.style.display = \'block\';\n        } else {\n          hoverNodeRef.current.style.display = \'none\';\n          event.native.target.style = \'cursor: default\';\n        }\n      });\n    }, 200);\n\n    removePointerMoveEventRef.current();\n    const removePointerMoveEvent = view.on(\'pointer-move\', (event) => {\n      handlePointMoveEvent(event);\n    });\n    removePointerMoveEventRef.current = removePointerMoveEvent;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n}`, `22619183818535272000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> throttle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 添加悬浮文字监听事件</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useShowHoverText</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> hoverNodeRef<span class="token punctuation">,</span> view <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> removePointerMoveEventRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> handlePointMoveEvent <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      view<span class="token punctuation">.</span><span class="token function">hitTest</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].graphic.geometry.type\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> attributes <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">\'results[0].graphic.attributes\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">\'polyline\'</span> <span class="token operator">&amp;&amp;</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: pointer\'</span><span class="token punctuation">;</span>\n          <span class="token keyword">const</span> xm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">\'xm\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> xm<span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'block\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">\'point\'</span> <span class="token operator">&amp;&amp;</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: pointer\'</span><span class="token punctuation">;</span>\n          <span class="token keyword">const</span> zm <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">\'point.zm\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> zm<span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>x <span class="token operator">-</span> zm<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">9</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">40</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'block\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          hoverNodeRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">\'none\'</span><span class="token punctuation">;</span>\n          event<span class="token punctuation">.</span>native<span class="token punctuation">.</span>target<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">\'cursor: default\'</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    removePointerMoveEventRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> removePointerMoveEvent <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'pointer-move\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">handlePointMoveEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    removePointerMoveEventRef<span class="token punctuation">.</span>current <span class="token operator">=</span> removePointerMoveEvent<span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="设置删除、添加的监听事件"><a href="#%E8%AE%BE%E7%BD%AE%E5%88%A0%E9%99%A4%E3%80%81%E6%B7%BB%E5%8A%A0%E7%9A%84%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>设置删除、添加的监听事件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24212876144927863000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import { useEffect, useRef } from \'react\';\nimport { get } from \'lodash\';\nimport produce from \'immer\';\n\n// 设置删除、添加的监听事件\nexport default function useAddOrDelPoint(props) {\n  const { view, onPointInfoChange, pointInfo } = props;\n  const removeTriggerActionEventRef = useRef(() => {});\n\n  useEffect(() => {\n    const getFilterPointIndex = (point) => pointInfo.findIndex((item) => get(item, \'value.key\') === point.zmdm);\n\n    const handleAddPoint = () => {\n      const { point, path } = view.popup.viewModel.selectedFeature.attributes;\n      const state = produce(pointInfo, (draftState) => {\n        const filterIndex = getFilterPointIndex(point);\n        if (filterIndex !== -1) {\n          return;\n        }\n        const maxId = Math.max(...draftState.map((item) => item.id));\n        let insertIndex = 0;\n        const index = path.findIndex((item) => item.zmdm === point.zmdm);\n        // 向前查找\n        for (let i = index - 1; i >= 0; i--) {\n          const filterPointIndex = getFilterPointIndex(path[i]);\n          if (filterPointIndex !== -1) {\n            insertIndex = filterPointIndex + 1;\n            break;\n          }\n        }\n        draftState.splice(insertIndex, 0, {\n          id: maxId + 1,\n          value: {\n            key: point.zmdm,\n            label: point.zm\n          },\n          options: []\n        });\n      });\n      onPointInfoChange && onPointInfoChange(state);\n    };\n\n    const handleDeletePoint = () => {\n      const { point } = view.popup.viewModel.selectedFeature.attributes;\n      const state = produce(pointInfo, (draftState) => {\n        const index = getFilterPointIndex(point);\n        if (index !== -1) {\n          draftState.splice(index, 1);\n        }\n      });\n      onPointInfoChange && onPointInfoChange(state);\n    };\n\n    removeTriggerActionEventRef.current();\n    const removeTriggerActionEvent = view.popup.on(\'trigger-action\', (event) => {\n      const eventMap = {\n        add: handleAddPoint,\n        delete: handleDeletePoint\n      };\n      eventMap[event.action.id] && eventMap[event.action.id](event);\n      view.popup.close();\n    }).remove;\n    removeTriggerActionEventRef.current = removeTriggerActionEvent;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [pointInfo]);\n}`, `24212876144927863000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> produce <span class="token keyword">from</span> <span class="token string">\'immer\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 设置删除、添加的监听事件</span>\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useAddOrDelPoint</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> onPointInfoChange<span class="token punctuation">,</span> pointInfo <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> removeTriggerActionEventRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">getFilterPointIndex</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">point</span><span class="token punctuation">)</span> <span class="token operator">=></span> pointInfo<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">\'value.key\'</span><span class="token punctuation">)</span> <span class="token operator">===</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">handleAddPoint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> point<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span>viewModel<span class="token punctuation">.</span>selectedFeature<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">produce</span><span class="token punctuation">(</span>pointInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> filterIndex <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>filterIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">return</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">const</span> maxId <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>draftState<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">let</span> insertIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n        <span class="token keyword">const</span> index <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 向前查找</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> filterPointIndex <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>filterPointIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            insertIndex <span class="token operator">=</span> filterPointIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n            <span class="token keyword">break</span><span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        draftState<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>insertIndex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n          id<span class="token punctuation">:</span> maxId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n          value<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            key<span class="token punctuation">:</span> point<span class="token punctuation">.</span>zmdm<span class="token punctuation">,</span>\n            label<span class="token punctuation">:</span> point<span class="token punctuation">.</span>zm\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          options<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      onPointInfoChange <span class="token operator">&amp;&amp;</span> <span class="token function">onPointInfoChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">handleDeletePoint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> point <span class="token punctuation">}</span> <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span>viewModel<span class="token punctuation">.</span>selectedFeature<span class="token punctuation">.</span>attributes<span class="token punctuation">;</span>\n      <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">produce</span><span class="token punctuation">(</span>pointInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">draftState</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token function">getFilterPointIndex</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          draftState<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      onPointInfoChange <span class="token operator">&amp;&amp;</span> <span class="token function">onPointInfoChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    removeTriggerActionEventRef<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> removeTriggerActionEvent <span class="token operator">=</span> view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'trigger-action\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> eventMap <span class="token operator">=</span> <span class="token punctuation">{</span>\n        add<span class="token punctuation">:</span> handleAddPoint<span class="token punctuation">,</span>\n        <span class="token keyword">delete</span><span class="token punctuation">:</span> handleDeletePoint\n      <span class="token punctuation">}</span><span class="token punctuation">;</span>\n      eventMap<span class="token punctuation">[</span>event<span class="token punctuation">.</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> eventMap<span class="token punctuation">[</span>event<span class="token punctuation">.</span>action<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      view<span class="token punctuation">.</span>popup<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>remove<span class="token punctuation">;</span>\n    removeTriggerActionEventRef<span class="token punctuation">.</span>current <span class="token operator">=</span> removeTriggerActionEvent<span class="token punctuation">;</span>\n    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pointInfo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="实现效果"><a href="#%E5%AE%9E%E7%8E%B0%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现效果</h2>\n<p><a target="_blank" href="/basic-map-73d1bc2751b9d5d59709b58e7e9472fa.gif">基本功能</a></p>\n<p><a target="_blank" href="/basic-map-2-38ff4e55afa0347ffbdcb8f646d77589.gif">基本功能-路线的粗细</a></p>\n<h1 id="修复路线未加载"><a href="#%E4%BF%AE%E5%A4%8D%E8%B7%AF%E7%BA%BF%E6%9C%AA%E5%8A%A0%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复路线未加载</h1>\n<p><code class="language-text">暂时未找到 view.graphics 完全加载时的方法，会造成白屏 bug</code> 的原因是在跳转页面时发现这个组件会有一定概率渲染不出路线，经过调试打印发现，是路线多次渲染造成的，需要解决多次渲染的问题，以下是跳转页面到这个组件：</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-08-09-38-58-0bb735cb42560cf95345100491ec8d00-b8364.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 15.933669790915644%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAi0lEQVQI103LuwrCQBSE4bz/g4iJacU+GFMoFhYWghBYWLPnMuesyQO4IgThL6aYrxJNy2LzjJzVXXIWd2Z+sZAou/HtSdsezQmHK3bDd6xVZok5FgmQW8GqSmZcMDG9PV0esumkHbS86z/ZDqhiDCGMQFJQYTARSSyTITmmMfL+zM1x+uG1ukd3zx+Ow5v4Jg291AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 08 09 38 58"\n        title=""\n        src="/static/2021-01-08-09-38-58-0bb735cb42560cf95345100491ec8d00-fee1c.png"\n        srcset="/static/2021-01-08-09-38-58-0bb735cb42560cf95345100491ec8d00-a67b7.png 200w,\n/static/2021-01-08-09-38-58-0bb735cb42560cf95345100491ec8d00-0b187.png 400w,\n/static/2021-01-08-09-38-58-0bb735cb42560cf95345100491ec8d00-fee1c.png 800w,\n/static/2021-01-08-09-38-58-0bb735cb42560cf95345100491ec8d00-b1a91.png 1200w,\n/static/2021-01-08-09-38-58-0bb735cb42560cf95345100491ec8d00-b8364.png 1387w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-08-09-39-28-2da7dfb88f4943dc830fc6175db11618-8b0e1.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 294px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 90.47619047619047%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABkElEQVQ4y5VT7VLCMBDs+z+MT+AfxRGBGVFHQBiHtvS7hZJW0yaBJm6bUvGPhZubzF2Svd27pgbjgmRZmhJ4FMWE5JwLxvjJBWtTHWivj0rGDSVpHNqus7LNhbVehIGpZKFUqVdZUXn8btOKKnkK6rgwWHTDqU3CEQnHJBiLwkyDCYmmoTWg+xnixBlm8UuyefTXdwVZ7Px6J9kMcQrm4u118nB/Ox4Nps9Ps/fpQVClhKxAWzRrWR2b4NimnRtKqc3Gnc8/lsvVavVpmhbJ8vyLHg4VjqRsXNXepup3pwYTglFF2+02juM0TZMkcV2vLEt9+9zk39xADoDnecC7rosS3b1ea8FuY2EY+r4PZhRijPWWqMFgcxwHYMiGBKS73e5SMJhB2LUthLhOdhAEAEM2wFmWnU+oX7ZuuDOUg/I8z/vBuOc3hobBDAkYAUpAwkWyAQMAc0aAFlDo0oGBWcve7/dYOedXDEzLBkzLppR2j+mKT6UbxmvFZtVYPxgY27ahHG2jClYT/4dlodD/4B8feQl2mzA3RgAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 08 09 39 28"\n        title=""\n        src="/static/2021-01-08-09-39-28-2da7dfb88f4943dc830fc6175db11618-8b0e1.png"\n        srcset="/static/2021-01-08-09-39-28-2da7dfb88f4943dc830fc6175db11618-2d2ea.png 200w,\n/static/2021-01-08-09-39-28-2da7dfb88f4943dc830fc6175db11618-8b0e1.png 294w"\n        sizes="(max-width: 294px) 100vw, 294px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>如图所示这里 hooks 多次渲染是导致路线加载不出来的原因，需要修复依赖的数据多次改变的问题，使用 useMemo 修复</p>\n<h2 id="主入口文件-1"><a href="#%E4%B8%BB%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>主入口文件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38660509637920630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useState, useEffect, useMemo } from \'react\';\nimport { setDefaultOptions } from \'esri-loader\';\n\nimport RouteDisplayLayer from \'./components/route-display-layer\';\nimport Map from \'./components/map\';\nimport { getConfig } from \'./api\';\n\nimport styles from \'./styles.less\';\n\nsetDefaultOptions({\n  css: \'/static-apps/mut/arcgis/esri/themes/light/main.css\',\n  url: \'/static-apps/mut/arcgis/init.js\'\n});\n\n/*\n  config: esri 三方库后端配置地址（外部配置）\n  height: 地图高度\n  onRef：map 的 ref 回调\n  settings： {\n    centerLon 地图中心经度\n    centerLat 地图中心纬度\n    zoom 缩放级别\n  }\n  pointInfo: 过滤条件的起点、终点、途径点渲染\n  onPointInfoChange: 过滤条件变化回调\n  goToCenter: 初次加载是否到中心点\n  isAddOrEdit: 是否显示添加删除按钮\n  path: 站点信息\n  route: 路线信息\n  transport: 运输信息\n*/\n\nexport { getConfig };\n\nexport default function RailwayMap(props) {\n  const { path, route } = props;\n  const [config, setConfig] = useState(props.config);\n\n  useEffect(() => {\n    const fetchConfig = async () => {\n      const data = await getConfig();\n      setConfig(data.result);\n    };\n    if (!config) {\n      fetchConfig();\n    }\n  }, [config]);\n\n  const { centerLon = 110, centerLat = 38, zoom = 5 } = props.settings || {};\n\n  const [map, setMap] = useState();\n  const [view, setView] = useState();\n\n  const isFloat = (number) => /^(-?\\d+)(\\.\\d+)?\\$/.test(number);\n\n  // 过滤掉没有经纬度结点或者经纬度为 0 的结点\n  const filterPath = useMemo(() => {\n    return path.filter((item) => isFloat(item.lat) && isFloat(item.lon) && +item.lat !== 0 && +item.lon !== 0);\n  }, [path]);\n\n  const filterRoute = useMemo(() => {\n    const getPointInfoByZmdm = (zmdm) => path.find((item) => item.zmdm === zmdm) || {};\n    const renderFilterRoute = [];\n    for (let i = 0; i < route.length; i++) {\n      // 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线\n      // 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线\n      if (\n        getPointInfoByZmdm(route[i].zmdm).lon &&\n        getPointInfoByZmdm(route[i].zmdm).lat &&\n        (!getPointInfoByZmdm(route[i].next_zmdm).lon || !getPointInfoByZmdm(route[i].next_zmdm).lat)\n      ) {\n        const { zm: startZm, zmdm: startZmdm, xm } = route[i];\n\n        // 累加缺失的站点的里程数\n        let distance = 0;\n        if (route[i].czjl) {\n          distance = route[i].czjl;\n        }\n\n        let index = null;\n        for (let j = i + 1; j < route.length; j++) {\n          if (route[j].czjl) {\n            distance += route[j].czjl;\n          }\n          // 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并\n          if (getPointInfoByZmdm(route[j].next_zmdm).lon && getPointInfoByZmdm(route[j].next_zmdm).lat) {\n            index = j;\n            break;\n          }\n        }\n        if (!index) {\n          // eslint-disable-next-line no-continue\n          continue;\n        }\n        const { next_zmdm: endZmdm, next_zm: endZm } = route[index];\n        renderFilterRoute.push({\n          zmdm: startZmdm,\n          zm: startZm,\n          next_zmdm: endZmdm,\n          next_zm: endZm,\n          xm,\n          czjl: distance\n        });\n        i = index;\n      }\n\n      // 经纬度都有的结点直接插入\n      if (\n        getPointInfoByZmdm(route[i].zmdm).lon &&\n        getPointInfoByZmdm(route[i].zmdm).lat &&\n        getPointInfoByZmdm(route[i].next_zmdm).lon &&\n        getPointInfoByZmdm(route[i].next_zmdm).lat\n      ) {\n        renderFilterRoute.push(route[i]);\n      }\n    }\n    return renderFilterRoute;\n  }, [route, path]);\n\n  if (!config) {\n    return null;\n  }\n\n  return (\n    <div className={styles.container}>\n      <Map\n        {...props}\n        config={config}\n        viewProperties={{\n          zoom: +zoom,\n          center: [+centerLon, +centerLat]\n        }}\n        setMap={setMap}\n        setView={setView}\n        view={view}\n      />\n      {map && view && <RouteDisplayLayer {...props} path={filterPath} route={filterRoute} map={map} view={view} />}\n    </div>\n  );\n}`, `38660509637920630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{54-59,61-118} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> setDefaultOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'esri-loader\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> RouteDisplayLayer <span class="token keyword">from</span> <span class="token string">\'./components/route-display-layer\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> Map <span class="token keyword">from</span> <span class="token string">\'./components/map\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'./api\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">\'./styles.less\'</span><span class="token punctuation">;</span>\n\n<span class="token function">setDefaultOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  css<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/esri/themes/light/main.css\'</span><span class="token punctuation">,</span>\n  url<span class="token punctuation">:</span> <span class="token string">\'/static-apps/mut/arcgis/init.js\'</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">/*</span>\n<span class="token comment">  config: esri 三方库后端配置地址（外部配置）</span>\n<span class="token comment">  height: 地图高度</span>\n<span class="token comment">  onRef：map 的 ref 回调</span>\n<span class="token comment">  settings： {</span>\n<span class="token comment">    centerLon 地图中心经度</span>\n<span class="token comment">    centerLat 地图中心纬度</span>\n<span class="token comment">    zoom 缩放级别</span>\n<span class="token comment">  }</span>\n<span class="token comment">  pointInfo: 过滤条件的起点、终点、途径点渲染</span>\n<span class="token comment">  onPointInfoChange: 过滤条件变化回调</span>\n<span class="token comment">  goToCenter: 初次加载是否到中心点</span>\n<span class="token comment">  isAddOrEdit: 是否显示添加删除按钮</span>\n<span class="token comment">  path: 站点信息</span>\n<span class="token comment">  route: 路线信息</span>\n<span class="token comment">  transport: 运输信息</span>\n<span class="token comment">*/</span>\n\n<span class="token keyword">export</span> <span class="token punctuation">{</span> getConfig <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> route <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>config<span class="token punctuation">,</span> setConfig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">fetchConfig</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">setConfig</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">fetchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>config<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> centerLon <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">,</span> centerLat <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">,</span> zoom <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">.</span>settings <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>map<span class="token punctuation">,</span> setMap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>view<span class="token punctuation">,</span> setView<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> <span class="token function-variable function">isFloat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token regex">/^(-?\\d+)(\\.\\d+)?$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token comment">// 过滤掉没有经纬度结点或者经纬度为 0 的结点</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterPath <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFloat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lon<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lat <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>item<span class="token punctuation">.</span>lon <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterRoute <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> <span class="token function-variable function">getPointInfoByZmdm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">zmdm</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>zmdm <span class="token operator">===</span> zmdm<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> renderFilterRoute <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 补充缺失的线路，比如这种情况长沙-湘潭-武汉，长沙-湘潭段属于长湘线，湘潭到武汉属于湘武线</span></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 湘潭的经纬度为空，那么直接连起来的长沙 - 武汉叫长湘线</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span> zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span> xm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">        <span class="token comment">// 累加缺失的站点的里程数</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> distance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          distance <span class="token operator">=</span> route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> route<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            distance <span class="token operator">+=</span> route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>czjl<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// 这里需要找到第一个终点站经纬度不为零的站点的下标，以此来进行缺失经纬度站点的合并</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span> <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">            index <span class="token operator">=</span> j<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// eslint-disable-next-line no-continue</span></span><span class="gatsby-highlight-code-line">          <span class="token keyword">continue</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span> next_zm<span class="token punctuation">:</span> endZm <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        renderFilterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          zmdm<span class="token punctuation">:</span> startZmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          zm<span class="token punctuation">:</span> startZm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          next_zmdm<span class="token punctuation">:</span> endZmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          next_zm<span class="token punctuation">:</span> endZm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          xm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          czjl<span class="token punctuation">:</span> distance</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        i <span class="token operator">=</span> index<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">      <span class="token comment">// 经纬度都有的结点直接插入</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lon <span class="token operator">&amp;&amp;</span></span><span class="gatsby-highlight-code-line">        <span class="token function">getPointInfoByZmdm</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next_zmdm<span class="token punctuation">)</span><span class="token punctuation">.</span>lat</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        renderFilterRoute<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> renderFilterRoute<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>route<span class="token punctuation">,</span> path<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>\n      <span class="token operator">&lt;</span>Map\n        <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        viewProperties<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>\n          zoom<span class="token punctuation">:</span> <span class="token operator">+</span>zoom<span class="token punctuation">,</span>\n          center<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">+</span>centerLon<span class="token punctuation">,</span> <span class="token operator">+</span>centerLat<span class="token punctuation">]</span>\n        <span class="token punctuation">}</span><span class="token punctuation">}</span>\n        setMap<span class="token operator">=</span><span class="token punctuation">{</span>setMap<span class="token punctuation">}</span>\n        setView<span class="token operator">=</span><span class="token punctuation">{</span>setView<span class="token punctuation">}</span>\n        view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n      <span class="token punctuation">{</span>map <span class="token operator">&amp;&amp;</span> view <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>RouteDisplayLayer <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> path<span class="token operator">=</span><span class="token punctuation">{</span>filterPath<span class="token punctuation">}</span> route<span class="token operator">=</span><span class="token punctuation">{</span>filterRoute<span class="token punctuation">}</span> map<span class="token operator">=</span><span class="token punctuation">{</span>map<span class="token punctuation">}</span> view<span class="token operator">=</span><span class="token punctuation">{</span>view<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="传入的参数文件"><a href="#%E4%BC%A0%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传入的参数文件</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61938529739154506000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React, { useMemo } from \'react\';\nimport _ from \'lodash\';\nimport RailwayMap from \'@/common/railway-map\';\n\nexport default function RailwayMapDisplay({ data, config, index }: any) {\n  const path = _.get(data, \\`[\\${index}].result.path\\`, []);\n  const pointInfo = _.get(data, \\`[\\${index}].filter.pointInfo\\`, []);\n  const filterPointInfo = useMemo(\n    () =>\n      pointInfo.map((item: any) => ({\n        value: {\n          key: item.zmdm,\n          label: item.zm\n        }\n      })),\n    [pointInfo]\n  );\n  return (\n    config && (\n      <RailwayMap\n        path={path}\n        route={_.get(data, \\`[\\${index}].result.route\\`, [])}\n        transport={_.get(data, \\`[\\${index}].result.transport\\`, [])}\n        height={240}\n        goToCenter\n        showAddOrDelBtn={false}\n        showLineInfo={false}\n        config={config}\n        pointInfo={filterPointInfo}\n      />\n    )\n  );\n}`, `61938529739154506000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js{8-17} 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useMemo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">\'lodash\'</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> RailwayMap <span class="token keyword">from</span> <span class="token string">\'@/common/railway-map\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RailwayMapDisplay</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> config<span class="token punctuation">,</span> index <span class="token punctuation">}</span><span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> path <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.path</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> pointInfo <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].filter.pointInfo</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> filterPointInfo <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span></span><span class="gatsby-highlight-code-line">      pointInfo<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        value<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          key<span class="token punctuation">:</span> item<span class="token punctuation">.</span>zmdm<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">          label<span class="token punctuation">:</span> item<span class="token punctuation">.</span>zm</span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">[</span>pointInfo<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    config <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>\n      <span class="token operator">&lt;</span>RailwayMap\n        path<span class="token operator">=</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span>\n        route<span class="token operator">=</span><span class="token punctuation">{</span>_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.route</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n        transport<span class="token operator">=</span><span class="token punctuation">{</span>_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">].result.transport</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n        height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">240</span><span class="token punctuation">}</span>\n        goToCenter\n        showAddOrDelBtn<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span>\n        showLineInfo<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span>\n        config<span class="token operator">=</span><span class="token punctuation">{</span>config<span class="token punctuation">}</span>\n        pointInfo<span class="token operator">=</span><span class="token punctuation">{</span>filterPointInfo<span class="token punctuation">}</span>\n      <span class="token operator">/</span><span class="token operator">></span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="修复效果"><a href="#%E4%BF%AE%E5%A4%8D%E6%95%88%E6%9E%9C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>修复效果</h2>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-08-10-20-28-f90d2e0605ebefbbc598f14656b5776f-60e1b.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 17.050359712230218%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAm0lEQVQI1z3MuQrCQBSF4bz/e4hbXMDCzkKcJEYUBNGAG1GyjPfOuePE9E4hwlf8zTkBG91+pHF4O1jLzhkrRFQROMvN8XRfJdeukmGE+Q6D6KevMFlLINBEpbXGQPux5+8aR/usXGzztnmpDJ0lhzF6Cv3ox/c0laAoHlX5BDRAAIswsW99uGjm+lbwbEOhqsdrjBKEfzHSs/sCD5ma+63/+ywAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 08 10 20 28"\n        title=""\n        src="/static/2021-01-08-10-20-28-f90d2e0605ebefbbc598f14656b5776f-fee1c.png"\n        srcset="/static/2021-01-08-10-20-28-f90d2e0605ebefbbc598f14656b5776f-a67b7.png 200w,\n/static/2021-01-08-10-20-28-f90d2e0605ebefbbc598f14656b5776f-0b187.png 400w,\n/static/2021-01-08-10-20-28-f90d2e0605ebefbbc598f14656b5776f-fee1c.png 800w,\n/static/2021-01-08-10-20-28-f90d2e0605ebefbbc598f14656b5776f-b1a91.png 1200w,\n/static/2021-01-08-10-20-28-f90d2e0605ebefbbc598f14656b5776f-60e1b.png 1390w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-08-10-20-47-542e4928e5f607f0ec3c1e4533ad89f8-ce56f.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 188px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 131.38297872340425%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAIAAAA44esqAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACMklEQVQ4y4XUyVIiURAFUP//G3TpmhVfwJZoQwYJHBkERZlsRgGhj5U0IgJmRL3IelWZN+/NfO9ktVotl8vpdPr29jYej0ejUa/Xe319HQ6H9ldH7cQzm82q1er19XW9Xr+6uioWi/l8/vLy8vfgj8RarZbgZrPZbrel6Ha7T09P8P2xWCw+Dtgn8nw+T6VSp6en1vPz87Ozs0wmk06nlRCkjiEHZymsk8kE836/PxgM8PcK2aeDyO/v7/f397lcDtU/id3d3WWz2VKpRIJSYrL8rOITWW6aSQ+Ts0gs0OxIHf/sRw61Q+RyucxRBXA+8QqFAgejPcje5UBv/N9GiXEEyPs3MYUsf9habY0JhtFwr7e3t4+Pj78PCT7k1VtDRmTtBWUHvq8bhgeRO50OTDyfn58rlQrxOXak2I7fSbEOfnl5MV5WWVQb4812OrSL7FG2OkHRVrAU4g0sIg8PDzbtKEd2p2U7xRrZ30q1kurm5sYqzN+NRsM+OpXEiLJdyLpVurKRigMqQHZsj2CaKWuMIVhQMTDbI7EJ2DOeKjeG5NEe4LHij7YSYkgOjidWhcQuLi5cA8A55sRgKsfYHDwYYXIDiQMQ54RtCj52JCGDwhMIp1aroU2I3y+DMJg0D1inAuyRC+gbZ10NtpBdBsFTITSL8dxbwtdlwCDzsQAbtK0RYz/i9yAjCSfuAJrHBUzz2KQ5x6bOfZuw0NncOQyDxJRqdZ4w1yGf+HElKG0b/B+/WMV75RJ87wAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 08 10 20 47"\n        title=""\n        src="/static/2021-01-08-10-20-47-542e4928e5f607f0ec3c1e4533ad89f8-ce56f.png"\n        srcset="/static/2021-01-08-10-20-47-542e4928e5f607f0ec3c1e4533ad89f8-ce56f.png 188w"\n        sizes="(max-width: 188px) 100vw, 188px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>',
id:"/github/workspace/blog/基于arcgis地图组件的搭建部署/index.md absPath of file >>> MarkdownRemark",timeToRead:30,frontmatter:{date:"2021-04-23 18:53:54",path:"/arcgis-map-component-build-deploy/",tags:"前端, arcgis, 地图, 预研",title:"基于arcgis地图组件的搭建部署",draft:null}},{excerpt:"JS 基础问题 简述 与前端 Js 不同, 后端方面除了 SSR/爬虫之外很少会接触 DOM, 所以关于 DOM 方面的各种知识基本不会讨论.浏览器端除了图形业务外很少碰到内存问题, 但是后端几乎是直面服务器内存的, 更加偏向内存方面, 对于一些更基础的问题也会更加关注. 类型判断 看  lodash 作用域 看 《你不知道的 js》 引用传递 js…",html:'<h1 id="js-基础问题"><a href="#js-%E5%9F%BA%E7%A1%80%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JS 基础问题</h1>\n<h2 id="简述"><a href="#%E7%AE%80%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简述</h2>\n<p>与前端 Js 不同, 后端方面除了 SSR/爬虫之外很少会接触 DOM, 所以关于 DOM 方面的各种知识基本不会讨论.浏览器端除了图形业务外很少碰到内存问题, 但是后端几乎是直面服务器内存的, 更加偏向内存方面, 对于一些更基础的问题也会更加关注.</p>\n<h2 id="类型判断"><a href="#%E7%B1%BB%E5%9E%8B%E5%88%A4%E6%96%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类型判断</h2>\n<p>看 <a href="https://github.com/lodash/lodash" target="_blank" rel="nofollow noreferrer noopener">lodash</a></p>\n<h2 id="作用域"><a href="#%E4%BD%9C%E7%94%A8%E5%9F%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作用域</h2>\n<p>看 《你不知道的 js》</p>\n<h2 id="引用传递"><a href="#%E5%BC%95%E7%94%A8%E4%BC%A0%E9%80%92" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>引用传递</h2>\n<blockquote>\n<p>js 中什么类型是引用传递, 什么类型是值传递? 如何将值类型的变量以引用的方式传递?</p>\n</blockquote>\n<p>简单点说, 对象是引用传递, 基础类型是值传递, 通过将基础类型包装 (boxing) 可以以引用的方式传递.</p>\n<p>引用传递和值传递是一个非常简单的问题, 也是理解 JavaScript 中的内存方面问题的一个基础. 如果不了解引用可能很难去看很多问题.</p>\n<p>面试写代码的话, 可以通过 <code class="language-text">如何编写一个 json 对象的拷贝函数</code> 等类似的问题来考察对引用的了解. 不过笔者偶尔会有恶趣味, 喜欢先问应聘者对于 == 的 === 的区别的了解. 然后再问 <code class="language-text">[1]</code> == <code class="language-text">[1]</code> 是 true 还是 false. 如果基础不好的同学可能会被自己对于 == 和 === 的结论影响然后得出错误的结论.</p>\n<p>对于技术好的, 希望能直接反驳这个问题本身是有问题的, 比如讲清楚 JavaScript 中没有引用传递只是传递引用. 参见 Is JavaScript a pass-by-reference or pass-by-value language?. 虽然说是复杂版, 但是这些知识对于 3 年经验的同学真的应该是很简单的问题了.</p>\n<p>另外如果简历中有写 C++, 则必问 <code class="language-text">指针与引用的区别</code>.</p>\n<h2 id="内存释放"><a href="#%E5%86%85%E5%AD%98%E9%87%8A%E6%94%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存释放</h2>\n<blockquote>\n<p>JavaScript 中不同类型以及不同环境下变量的内存都是何时释放?</p>\n</blockquote>\n<p>引用类型是在没有引用之后, 通过 v8 的 GC 自动回收, 值类型如果是处于闭包的情况下, 要等闭包没有引用才会被 GC 回收, 非闭包的情况下等待 v8 的新生代 (new space) 切换的时候回收.</p>\n<p>与前端 Js 不同, 2 年以上经验的 Node.js 一定要开始注意内存了, 不说对 v8 的 GC 有多了解, 基础的内存释放一定有概念了, 并且要开始注意内存泄漏的问题了.</p>\n<p>你需要了解哪些操作一定会导致内存泄漏, 或者可以崩掉内存. 比如如下代码能否爆掉 V8 的内存?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6623581481722973000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let arr = [];\nwhile (true) arr.push(1);`, `6623581481722973000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后上述代码与下方的情况有什么区别?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98444411935604470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let arr = [];\nwhile (true) arr.push();`, `98444411935604470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果 push 的是 Buffer 情况又会有什么区别?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59674839350145655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let arr = [];\nwhile (true) arr.push(new Buffer(1000));`, `59674839350145655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>思考完之后可以尝试找找别的情况如何爆掉 V8 的内存. 以及来聊聊内存泄漏?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51005481507488290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function out() {\n  const bigData = new Buffer(100);\n  inner = function() {\n    void bigData;\n  };\n}`, `51005481507488290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> bigData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function-variable function">inner</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">void</span> bigData<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>闭包会引用到父级函数中的变量，如果闭包未释放，就会导致内存泄漏。上面例子是 inner 直接挂在了 root 上，从而导致内存泄漏（bigData 不会释放）。详见 <a href="https://zhuanlan.zhihu.com/p/25736931" target="_blank" rel="nofollow noreferrer noopener">如何分析 Node.js 中的内存泄漏</a></p>\n<p>对于一些高水平的同学, 要求能清楚的了解 V8 内存 GC 的机制, 懂得内存快照等 (之后会在调试/优化的小结中讨论) 了. 比如 V8 中不同类型的数据存储的位置, 在内存释放的时候不同区域的不同策略等等.</p>\n<h2 id="es6-新特性"><a href="#es6-%E6%96%B0%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ES6 新特性</h2>\n<p>看阮一峰的 <a href="http://es6.ruanyifeng.com/" target="_blank" rel="nofollow noreferrer noopener">ECMAScript 6 入门</a></p>\n<p>比较简单的会问 let 与 var 的区别, 以及 <code class="language-text">箭头函数</code> 与 <code class="language-text">function</code> 的区别等等.</p>\n<p>深入的话, es6 有太多细节可以深入了. 比如结合 <code class="language-text">引用</code> 的知识点来询问 const 方面的知识. 结合 <code class="language-text">{}</code> 的使用与缺点来谈 Set, Map 等. 比如私有化的问题与 symbol 等等.</p>\n<p>其他像是闭包是什么? 这种问烂了问题已经感觉没必要问了, 取而代之的是询问闭包应用的场景更加合理. 比如说, 如果回答者通常使用闭包实现数据的私有, 那么可以接着问 es6 的一些新特性 (例如 class, symbol) 能否实现私有, 如果能的话那为什么要用闭包? 亦或者是什么闭包中的数据/私有化的数据的内存什么时候释放? 等等.</p>\n<p><code class="language-text">...</code> 的使用上, 如何实现一个数组的去重 (使用 Set 可以加分).</p>\n<blockquote>\n<p>const 定义的 Array 中间元素能否被修改? 如果可以, 那 const 修饰对象有什么意义?</p>\n</blockquote>\n<p>其中的值可以被修改. 意义上, 主要保护引用不被修改 (如用 Map 等接口对引用的变化很敏感, 使用 const 保护引用始终如一是有意义的), 也适合用在 immutable 的场景.</p>\n<h1 id="模块"><a href="#%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块</h1>\n<h2 id="常见问题"><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常见问题</h2>\n<blockquote>\n<p>如何在不重启 node 进程的情况下热更新一个 js/json 文件? 这个问题本身是否有问题?</p>\n</blockquote>\n<p>可以清除掉 require.cache 的缓存重新 require(xxx), 视具体情况还可以用 VM 模块重新执行.</p>\n<p>当然这个问题可能是典型的 X-Y Problem, 使用 js 实现热更新很容易碰到 v8 优化之后各地拿到缓存的引用导致热更新 js 没意义. 当然热更新 json 还是可以简单一点比如用读取文件的方式来热更新, 但是这样也不如从 redis 之类的数据库中读取比较合理.</p>\n<h2 id="简述-1"><a href="#%E7%AE%80%E8%BF%B0-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简述</h2>\n<p>其他还有很多内容也是属于很 ‘基础’ 的 Node.js 问题 (例如异步/线程等等), 但是由于归类的问题并没有放在这个分类中. 所以这里只简单讲几个之后没归类的基础问题.</p>\n<h2 id="模块机制"><a href="#%E6%A8%A1%E5%9D%97%E6%9C%BA%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块机制</h2>\n<p>node 的基础中毫无疑问的应该是有关于模块机制的方面的, 也即 require 这个内置功能的一些原理的问题.</p>\n<p>关于模块互相引用之类的, 不了解的推荐先好好读读官方文档.</p>\n<p>其实官方文档已经说得很清楚了, 每个 node 进程只有一个 VM 的上下文, 不会跟浏览器相差多少, 模块机制在文档中也描述的非常清楚了:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46919267578607070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function require(...) {\n  var module = { exports: {} };\n  ((module, exports) => {\n    // Your module code here. In this example, define a function.\n    function some_func() {};\n    exports = some_func;\n    // At this point, exports is no longer a shortcut to module.exports, and\n    // this module will still export an empty default object.\n    module.exports = some_func;\n    // At this point, the module will now export some_func, instead of the\n    // default object.\n  })(module, module.exports);\n  return module.exports;\n}`, `46919267578607070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// Your module code here. In this example, define a function.</span>\n    <span class="token keyword">function</span> <span class="token function">some_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    exports <span class="token operator">=</span> some_func<span class="token punctuation">;</span>\n    <span class="token comment">// At this point, exports is no longer a shortcut to module.exports, and</span>\n    <span class="token comment">// this module will still export an empty default object.</span>\n    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> some_func<span class="token punctuation">;</span>\n    <span class="token comment">// At this point, the module will now export some_func, instead of the</span>\n    <span class="token comment">// default object.</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>如果 a.js require 了 b.js, 那么在 b 中定义全局变量 t = 111 能否在 a 中直接打印出来?</p>\n</blockquote>\n<p>每个 .js 能独立一个环境只是因为 node 帮你在外层包了一圈自执行, 所以你使用 t = 111 定义全局变量在其他地方当然能拿到. 情况如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37112327205035565000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// b.js\n(function(exports, require, module, __filename, __dirname) {\n  t = 111;\n})();\n\n// a.js\n(function(exports, require, module, __filename, __dirname) {\n  // ...\n  console.log(t); // 111\n})();`, `37112327205035565000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// b.js</span>\n<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  t <span class="token operator">=</span> <span class="token number">111</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// a.js</span>\n<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 111</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>a.js 和 b.js 两个文件互相 require 是否会死循环? 双方是否能导出变量? 如何从设计上避免这种问题?</p>\n</blockquote>\n<p>不会, 先执行的导出其未完成的副本, 通过导出工厂函数让对方从函数去拿比较好避免. 模块在导出的只是 var module = { exports: {…} }; 中的 exports, 以从 a.js 启动为例, a.js 还没执行完会返回一个 a.js 的 exports 对象的未完成的副本给 b.js 模块。 然后 b.js 完成加载，并将 exports 对象提供给 a.js 模块。</p>\n<p>另外还有非常基础和常见的问题, 比如 module.exports 和 exports 的区别这里也能一并解决了 exports 只是 module.exports 的一个引用.</p>\n<p>再晋级一点, 众所周知, node 的模块机制是基于 CommonJS 规范的. 对于从前端转 node 的同学, 如果面试官想问的难一点会考查关于 CommonJS 的一些问题. 比如比较 AMD（提前执行、依赖前置）, CMD（延迟执行、依赖就近）, CommonJS 三者的区别, 包括询问关于 node 中 require 的实现原理等.</p>\n<blockquote>\n<p>node 中 require 的实现原理</p>\n</blockquote>\n<p>require 命令是 CommonJS 规范之中，用来加载其他模块的命令。它其实不是一个全局命令，而是指向当前模块的 module.require 命令，而后者又调用 Node 的内部命令 Module._load。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54498810699461894000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Module._load = function(request, parent, isMain) {\n  // 1. 检查 Module._cache，是否缓存之中有指定模块\n  // 2. 如果缓存之中没有，就创建一个新的 Module 实例\n  // 3. 将它保存到缓存\n  // 4. 使用 module.load() 加载指定的模块文件，\n  //    读取文件内容之后，使用 module.compile() 执行文件代码\n  // 5. 如果加载/解析过程报错，就从缓存删除该模块\n  // 6. 返回该模块的 module.exports\n};`, `54498810699461894000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. 检查 Module._cache，是否缓存之中有指定模块</span>\n  <span class="token comment">// 2. 如果缓存之中没有，就创建一个新的 Module 实例</span>\n  <span class="token comment">// 3. 将它保存到缓存</span>\n  <span class="token comment">// 4. 使用 module.load() 加载指定的模块文件，</span>\n  <span class="token comment">//    读取文件内容之后，使用 module.compile() 执行文件代码</span>\n  <span class="token comment">// 5. 如果加载/解析过程报错，就从缓存删除该模块</span>\n  <span class="token comment">// 6. 返回该模块的 module.exports</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的第 4 步，采用 module.compile() 执行指定模块的脚本，逻辑如下。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27969657228471490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Module.prototype._compile = function(content, filename) {\n  // 1. 生成一个 require 函数，指向 module.require\n  // 2. 加载其他辅助方法到 require\n  // 3. 将文件内容放到一个函数之中，该函数可调用 require\n  // 4. 执行该函数\n};`, `27969657228471490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. 生成一个 require 函数，指向 module.require</span>\n  <span class="token comment">// 2. 加载其他辅助方法到 require</span>\n  <span class="token comment">// 3. 将文件内容放到一个函数之中，该函数可调用 require</span>\n  <span class="token comment">// 4. 执行该函数</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的第 1 步和第 2 步，require 函数及其辅助方法主要如下。</p>\n<ol>\n<li>require(): 加载外部模块</li>\n<li>require.resolve()：将模块名解析到一个绝对路径</li>\n<li>require.main：指向主模块</li>\n<li>require.cache：指向所有缓存的模块</li>\n<li>require.extensions：根据文件的后缀名，调用不同的执行函数</li>\n</ol>\n<p>一旦 require 函数准备完毕，整个所要加载的脚本内容，就被放到一个新的函数之中，这样可以避免污染全局环境。该函数的参数包括 require、module、exports，以及其他一些参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77265608349969510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(function(exports, require, module, __filename, __dirname) {\n  // YOUR CODE INJECTED HERE!\n});`, `77265608349969510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// YOUR CODE INJECTED HERE!</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">Module._compile</code> 方法是同步执行的，所以 <code class="language-text">Module._load</code> 要等它执行完成，才会向用户返回 module.exports 的值。</p>\n<h2 id="热更新"><a href="#%E7%83%AD%E6%9B%B4%E6%96%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>热更新</h2>\n<p>从面试官的角度看, 热更新是很多程序常见的问题. 对客户端而言, 热更新意味着不用换包, 当然也包含着 md5 校验/差异更新等复杂问题; 对服务端而言, 热更新意味着服务不用重启, 这样可用性较高同时也优雅和有逼格. 问的过程中可以一定程度的暴露应聘程序员的水平.</p>\n<p>从 PHP 转 node 的同学可能会有些想法, 比如 PHP 的代码直接刷上去就好了, 并没有所谓的重启. 而 node 重启看起来动作还挺大. 当然这里面的区别, 主要是与同时有 PHP 与 node 开发经验的同学可以讨论, 也是很好的切入点.</p>\n<p>在 Node.js 中做热更新代码, 牵扯到的知识点可能主要是 require 会有一个 cache, 有这个 cache 在, 即使你更新了 .js 文件, 在代码中再次 require 还是会拿到之前的编译好缓存在 v8 内存 (code space) 中的的旧代码. 但是如果只是单纯的清除掉 require 中的 cache, 再次 require 确实能拿到新的代码, 但是这时候很容易碰到各地维持旧的引用依旧跑的旧的代码的问题. 如果还要继续推行这种热更新代码的话, 可能要推翻当前的架构, 从头开始重新设计一下目前的框架.</p>\n<p>不过热更新 json 之类的配置文件的话, 还是可以简单的实现的, 更新 require 的 cache 可以实现, 不会有持有旧引用的问题, 可以参见我 2 年前写着玩的<a href="https://www.npmjs.com/package/auto-reload" target="_blank" rel="nofollow noreferrer noopener">例子</a>, 但是如果旧的引用一直被持有很容易出现内存泄漏, 而要热更新配置的话, 为什么不存数据库? 或者用 zookeeper 之类的服务? 通过更新文件还要再发布一次, 但是存数据库直接写个接口配个界面多爽你说是不是?</p>\n<p>所以这个问题其实本身其实是值得商榷的, 可能是典型的 X-Y Problem, 不过聊起来确实是可以暴露水平.</p>\n<h2 id="上下文"><a href="#%E4%B8%8A%E4%B8%8B%E6%96%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>上下文</h2>\n<p>对于 Node.js 而言, 正常情况下只有一个上下文, 甚至于内置的很多方面例如 require 的实现只是在启动的时候运行了内置的函数.</p>\n<p>每个单独的 .js 文件并不意味着单独的上下文, 在某个 .js 文件中污染了全局的作用域一样能影响到其他的地方.</p>\n<p>而目前的 Node.js 将 VM 的接口暴露了出来, 可以让你自己创建一个新的 js 上下文, 这一点上跟前端 js 还是区别挺大的. 在执行外部代码的时候, 通过创建新的上下文沙盒 (sandbox) 可以避免上下文被污染:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71315255882729270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'use strict\';\nconst vm = require(\'vm\');\n\nlet code = \\`(function(require) {\n\n  const http = require(\'http\');\n\n  http.createServer( (request, response) => {\n    response.writeHead(200, {\'Content-Type\': \'text/plain\'});\n    response.end(\'Hello World\\\\n\');\n  }).listen(8124);\n\n  console.log(\'Server running at http://127.0.0.1:8124/\');\n})\\`;\n\nvm.runInThisContext(code)(require);`, `71315255882729270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token string">\'use strict\'</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'vm\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(function(require) {\n\n  const http = require(\'http\');\n\n  http.createServer( (request, response) => {\n    response.writeHead(200, {\'Content-Type\': \'text/plain\'});\n    response.end(\'Hello World\\\\n\');\n  }).listen(8124);\n\n  console.log(\'Server running at http://127.0.0.1:8124/\');\n})</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>\n\nvm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">(</span>require<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种执行方式与 eval 和 Function 有明显的区别. 关于 VM 更多的一些接口可以先阅读官方文档 VM (虚拟机)</p>\n<p>讲完这个知识点, 这里留下一个简单的问题, 既然可以通过新的上下文来避免污染, 那么为什么 Node.js 不给每一个 .js 文件以独立的上下文来避免作用域被污染?</p>\n<blockquote>\n<p>为什么 Node.js 不给每一个 .js 文件以独立的上下文来避免作用域被污染?</p>\n</blockquote>\n<p>node 中 require 的实现原理里面有说明，_compile 函数有调用 vm.runInThisContext 函数，即 Node.js 模块正常情况对作用域不会造成污染，意外创建全局变量是一种例外</p>\n<h1 id="事件异步"><a href="#%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事件/异步</h1>\n<h2 id="promise"><a href="#promise" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Promise</h2>\n<p>相信很多同学在面试的时候都碰到过这样一个问题, 如何处理 Callback Hell. 在早些年的时候, 大家会看到有很多的解决方案例如 Q, async, EventProxy 等等. 最后从流行程度来看 Promise 当之无愧的独领风骚, 并且是在 ES6 的 JavaScript 标准上赢得了支持.</p>\n<p>关于它的基础知识/概念推荐看阮一峰的 Promise 对象 这里就不多不赘述.</p>\n<blockquote>\n<p>Promise 中 .then 的第二参数与 .catch 有什么区别?</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87727203281212870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`somePromise()\n  .then(function() {\n    throw new Error(\'oh noes\');\n  })\n  .catch(function(err) {\n    // I caught your error! :)\n  });\n\nsomePromise().then(\n  function() {\n    throw new Error(\'oh noes\');\n  },\n  function(err) {\n    // I didn\'t catch your error! :(\n  }\n);`, `87727203281212870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">somePromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'oh noes\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// I caught your error! :)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">somePromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'oh noes\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// I didn\'t catch your error! :(</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>建议使用 catch</p>\n<p>另外关于同步与异步, 有个问题希望大家看一下, 这是很简单的 Promise 的使用例子:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21874916218363280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let doSth = new Promise((resolve, reject) => {\n  console.log(\'hello\');\n  resolve();\n});\n\ndoSth.then(() => {\n  console.log(\'over\');\n});`, `21874916218363280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> doSth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndoSth<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'over\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>毫无疑问的可以得到以下输出结果:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23455725362454327000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hello\nover`, `23455725362454327000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">hello\nover</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是首先的问题是, 该 Promise 封装的代码肯定是同步的, 那么这个 then 的执行是异步的吗?（异步）</p>\n<p>其次的问题是, 如下代码, setTimeout 到 10s 之后再 .then 调用, 那么 hello 是会在 10s 之后在打印吗, 还是一开始就打印?（hello 是会在 10s 之后在打印）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74289175641505040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let doSth = new Promise((resolve, reject) => {\n  console.log(\'hello\');\n  resolve();\n});\n\nsetTimeout(() => {\n  doSth.then(() => {\n    console.log(\'over\');\n  });\n}, 10000);`, `74289175641505040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> doSth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  doSth<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'over\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以及理解如下代码的执行顺序</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35345359612086910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`setTimeout(function() {\n  console.log(1);\n}, 0);\nnew Promise(function executor(resolve) {\n  console.log(2);\n  for (var i = 0; i < 10000; i++) {\n    i == 9999 && resolve();\n  }\n  console.log(3);\n}).then(function() {\n  console.log(4);\n});\nconsole.log(5);`, `35345359612086910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    i <span class="token operator">==</span> <span class="token number">9999</span> <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4013995294511319000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`2\n3\n5\n4\n1`, `4013995294511319000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">2\n3\n5\n4\n1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="events"><a href="#events" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Events</h2>\n<p>Events 是 Node.js 中一个非常重要的 core 模块, 在 node 中有许多重要的 core API 都是依赖其建立的. 比如 Stream 是基于 Events 实现的, 而 fs, net, http 等模块都依赖 Stream, 所以 Events 模块的重要性可见一斑.</p>\n<p>通过继承 EventEmitter 来使得一个类具有 node 提供的基本的 event 方法, 这样的对象可以称作 emitter, 而触发(emit)事件的 cb 则称作 listener. 与前端 DOM 树上的事件并不相同, emitter 的触发不存在冒泡, 逐层捕获等事件行为, 也没有处理事件传递的方法.</p>\n<blockquote>\n<p>Eventemitter 的 emit 是同步还是异步?</p>\n</blockquote>\n<p>Node.js 中 Eventemitter 的 emit 是同步的.</p>\n<p>另外, 可以讨论如下的执行结果是输出 <code class="language-text">hi 1</code> 还是 <code class="language-text">hi 2</code>?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68821191747126420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const EventEmitter = require(\'events\');\n\nlet emitter = new EventEmitter();\n\nemitter.on(\'myEvent\', () => {\n  console.log(\'hi 1\');\n});\n\nemitter.on(\'myEvent\', () => {\n  console.log(\'hi 2\');\n});\n\nemitter.emit(\'myEvent\');`, `68821191747126420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'events\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hi 1\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hi 2\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66195034537703520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hi 1\nhi 2`, `66195034537703520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">hi 1\nhi 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>或者如下情况是否会死循环?（会出现）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9310020612876446000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const EventEmitter = require(\'events\');\n\nlet emitter = new EventEmitter();\n\nemitter.on(\'myEvent\', () => {\n  console.log(\'hi\');\n  emitter.emit(\'myEvent\');\n});\n\nemitter.emit(\'myEvent\');`, `9310020612876446000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'events\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以及这样会不会死循环?（不会出现，只是多了一个监听）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19751736645367290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const EventEmitter = require(\'events\');\n\nlet emitter = new EventEmitter();\n\nemitter.on(\'myEvent\', function sth() {\n  emitter.on(\'myEvent\', sth);\n  console.log(\'hi\');\n});\n\nemitter.emit(\'myEvent\');`, `19751736645367290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'events\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">sth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">,</span> sth<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nemitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'myEvent\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 emitter 处理问题可以处理比较复杂的状态场景, 比如 TCP 的复杂状态机, 做多项异步操作的时候每一步都可能报错, 这个时候 .emit 错误并且执行某些 .once 的操作可以将你从泥沼中拯救出来.</p>\n<p>另外可以注意一下的是, 有些同学喜欢用 emitter 来监控某些类的状态, 但是在这些类释放的时候可能会忘记释放 emitter, 而这些类的内部可能持有该 emitter 的 listener 的引用从而导致内存泄漏.</p>\n<h2 id="阻塞异步"><a href="#%E9%98%BB%E5%A1%9E%E5%BC%82%E6%AD%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>阻塞/异步</h2>\n<blockquote>\n<p>如何判断接口是否异步? 是否只要有回调函数就是异步?</p>\n</blockquote>\n<p>开放性问题, 每个写 node 的人都有一套自己的判断方式.</p>\n<ul>\n<li>看文档</li>\n<li>console.log 打印看看</li>\n<li>看是否有 IO 操作</li>\n</ul>\n<p>单纯使用回调函数并不会异步, IO 操作才可能会异步, 除此之外还有使用 setTimeout 等方式实现异步.</p>\n<blockquote>\n<p>有这样一个场景, 你在线上使用 koa 搭建了一个网站, 这个网站项目中有一个你同事写的接口 A, 而 A 接口中在特殊情况下会变成死循环. 那么首先问题是, 如果触发了这个死循环, 会对网站造成什么影响?</p>\n</blockquote>\n<p>Node.js 中执行 js 代码的过程是单线程的. 只有当前代码都执行完, 才会切入事件循环, 然后从事件队列中 pop 出下一个回调函数开始执行代码. 所以实现一个 sleep 函数, 只要通过一个死循环就可以阻塞整个 js 的执行流程. (关于如何避免坑爹的同事写出死循环, 在后面的测试环节有写到.)</p>\n<blockquote>\n<p>如何实现一个 sleep 函数?</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67402694002642270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function sleep(ms) {\n  var start = Date.now(),\n    expire = start + ms;\n  while (Date.now() < expire);\n  return;\n}`, `67402694002642270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    expire <span class="token operator">=</span> start <span class="token operator">+</span> ms<span class="token punctuation">;</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而异步, 是使用 libuv 来实现的 (C/C++的同学可以参见 libev 和 libevent) 另一个线程里的事件队列.</p>\n<p>如果在线上的网站中出现了死循环的逻辑被触发, 整个进程就会一直卡在死循环中, 如果没有多进程部署的话, 之后的网站请求全部会超时, js 代码没有结束那么事件队列就会停下等待不会执行异步, 整个网站无法响应.</p>\n<blockquote>\n<p>如何实现一个异步的 reduce? (注:不是异步完了之后同步 reduce)</p>\n</blockquote>\n<p>需要了解 reduce 的情况, 是第 n 个与 n + 1 的结果异步处理完之后, 在用新的结果与第 n + 2 个元素继续依次异步下去.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52588724691496755000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 当 await memo 不是最先出现时，所有的 sleep 并行执行，因为 await memo 使得函数等待上一个函数完成后执行\n// utility function for sleeping\nconst sleep = (n) => new Promise((res) => setTimeout(res, n));\n\nconst arr = [1, 2, 3];\nconst startTime = new Date().getTime();\nconst asyncRes = await arr.reduce(async (memo, e) => {\n  await sleep(2000);\n  console.log(e);\n  return (await memo) + e;\n}, 0);\n\nconsole.log(asyncRes, \\`Took \\${new Date().getTime() - startTime} ms\\`);`, `52588724691496755000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 当 await memo 不是最先出现时，所有的 sleep 并行执行，因为 await memo 使得函数等待上一个函数完成后执行</span>\n<span class="token comment">// utility function for sleeping</span>\n<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> asyncRes <span class="token operator">=</span> <span class="token keyword">await</span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> memo<span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>asyncRes<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Took </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89095591356036710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1\n2\n3\n6 &quot;Took 2001 ms&quot;`, `89095591356036710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1\n2\n3\n6 &quot;Took 2001 ms&quot;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17243444049615708000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 当 await memo 最先出现时，这些函数按顺序运行，所有的 sleep 串行执行\nconst sleep = (n) => new Promise((res) => setTimeout(res, n));\nconst arr = [1, 2, 3];\n\nconst startTime = new Date().getTime();\n\nconst asyncRes = await arr.reduce(async (memo, e) => {\n  await memo;\n  await sleep(2000);\n  console.log(e);\n  return (await memo) + e;\n}, 0);\n\nconsole.log(asyncRes, \\`Took \\${new Date().getTime() - startTime} ms\\`);`, `17243444049615708000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 当 await memo 最先出现时，这些函数按顺序运行，所有的 sleep 串行执行</span>\n<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> asyncRes <span class="token operator">=</span> <span class="token keyword">await</span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">await</span> memo<span class="token punctuation">;</span>\n  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> memo<span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>asyncRes<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Took </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63265422929791470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1\n2\n3\n6 &quot;Took 6003 ms&quot;`, `63265422929791470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1\n2\n3\n6 &quot;Took 6003 ms&quot;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="timers"><a href="#timers" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Timers</h2>\n<p>在笔者这里将 Node.js 中的异步简单的划分为两种, 硬异步和软异步.</p>\n<p>硬异步是指由于 IO 操作或者外部调用走 libuv 而需要异步的情况. 当然, 也存在 readFileSync, execSync 等例外情况, 不过 node 由于是单线程的, 所以如果常规业务在普通时段执行可能比较耗时同步的 IO 操作会使得其执行过程中其他的所有操作都不能响应, 有点作死的感觉. 不过在启动/初始化以及一些工具脚本的应用场景下是完全没问题的. 而一般的场景下 IO 操作都是需要异步的.</p>\n<p>软异步是指, 通过 setTimeout 等方式来实现的异步.</p>\n<blockquote>\n<p>关于 nextTick, setTimeout 以及 setImmediate 三者的区别</p>\n</blockquote>\n<p>setImmediate vs process.nextTick</p>\n<ul>\n<li>setImmediate() 属于 check 观察者，其设置的回调函数，会插入到下次事件循环的末尾。</li>\n<li>process.nextTick() 设置的回调函数，会在代码运行完成后立即执行，会在下次事件循环之前被调用，原文是 “the callback will fire as soon as the code runs to completion, but before going back to the event loop.”</li>\n<li>process.nextTick() 所设置的回调函数会存放到数组中，一次性执行所有回调函数。</li>\n<li>setImmediate() 所设置的回调函数会存到到链表中，每次事件循环只执行链表中的一个回调函数。</li>\n</ul>\n<p>setTimeout(fn, 0) vs setImmediate</p>\n<p>执行 setTimeout(fn, 0) 其实就是在执行 setTimeout(fn, 1)，也就是说 setImmediate() 是有可能先于 setTimeout(fn, 0) 执行的。</p>\n<p><strong>Event loop 示例</strong></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23356985459406210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`   ┌───────────────────────┐\n┌─>│        timers         │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     I/O callbacks     │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     idle, prepare     │\n│  └──────────┬────────────┘      ┌───────────────┐\n│  ┌──────────┴────────────┐      │   incoming:   │\n│  │         poll          │<─────┤  connections, │\n│  └──────────┬────────────┘      │   data, etc.  │\n│  ┌──────────┴────────────┐      └───────────────┘\n│  │        check          │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n└──┤    close callbacks    │\n   └───────────────────────┘`, `23356985459406210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">   ┌───────────────────────┐\n┌─&gt;│        timers         │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     I/O callbacks     │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     idle, prepare     │\n│  └──────────┬────────────┘      ┌───────────────┐\n│  ┌──────────┴────────────┐      │   incoming:   │\n│  │         poll          │&lt;─────┤  connections, │\n│  └──────────┬────────────┘      │   data, etc.  │\n│  ┌──────────┴────────────┐      └───────────────┘\n│  │        check          │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n└──┤    close callbacks    │\n   └───────────────────────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于事件循环, Timers 以及 nextTick 的关系详见官方文档 The Node.js Event Loop, Timers, and process.nextTick()，<a href="https://cnodejs.org/topic/57d68794cb6f605d360105bf" target="_blank" rel="nofollow noreferrer noopener">论坛中文讨论</a></p>\n<h2 id="并行并发"><a href="#%E5%B9%B6%E8%A1%8C%E5%B9%B6%E5%8F%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并行/并发</h2>\n<p>并行 (Parallel) 与并发 (Concurrent) 是两个很常见的概念.</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2020-12-28-16-48-29-126c02db95f6c371cae8335bb802734b-81a6c.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 600px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 75.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABZUlEQVQoz5WT6W6DMBCE8/7vF5L0R6RcgIFwmcOYq5/ZlioVjdSRsJa1Z3d2DLt5nq21Xdf1fd+27TiOayx51qZpirJ0a1EYY+Zv7HjIplmWF0WSJBwtdZln+fP5jKKoWFDXNXFVVSTTNH0hC+jJRrIgjuMsy4IgICYYpxE+yfv9Tq3f5GmaWE3X3W43TkC7XK++7yuliItFFGTP8/I83+gsJdycYoG1TD4MAyuiCEQOWJu9kN8DwrDgpfO4gOy0wPa2H3gQYcV8tjAfX8kQkPnpjIdBGD4eDzagIUxrHSexiiIIvLIyvwwfLtBV9UUWPdJW5qThKlLycqNlWepKy+6GYZQ/n89ySX7gukFojdMcRWrv7U8fp22334OrZnCKou5PctM2fIPOobY1nRHDQF07JgaJ5g2yKMetUDljCDiNZiqGSh2Ox8v1wsxy8h+yuQKUU+ud7FXV6rOAWfg9kIM0SlDrE04nZrW0iZWCAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2020 12 28 16 48 29"\n        title=""\n        src="/static/2020-12-28-16-48-29-126c02db95f6c371cae8335bb802734b-81a6c.png"\n        srcset="/static/2020-12-28-16-48-29-126c02db95f6c371cae8335bb802734b-468c3.png 200w,\n/static/2020-12-28-16-48-29-126c02db95f6c371cae8335bb802734b-3ff2b.png 400w,\n/static/2020-12-28-16-48-29-126c02db95f6c371cae8335bb802734b-81a6c.png 600w"\n        sizes="(max-width: 600px) 100vw, 600px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>并发 (Concurrent) = 2 队列对应 1 咖啡机.</p>\n<p>并行 (Parallel) = 2 队列对应 2 咖啡机.</p>\n<p>Node.js 通过事件循环来挨个抽取事件队列中的一个个 Task 执行, 从而避免了传统的多线程情况下 <code class="language-text">2个队列对应 1个咖啡机</code> 的时候上下文切换以及资源争抢/同步的问题, 所以获得了高并发的成就.</p>\n<p>至于在 node 中并行, 你可以通过 cluster 来再添加一个咖啡机.</p>\n<h1 id="进程"><a href="#%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程</h1>\n<h2 id="简述-2"><a href="#%E7%AE%80%E8%BF%B0-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简述</h2>\n<p>关于 Process, 我们需要讨论的是两个概念：操作系统的进程、Node.js 中的 Process 对象. 操作进程对于服务端而言, 好比 html 之于前端一样基础. 想做服务端编程是不可能绕过 Unix/Linux 的. 在 Linux/Unix/Mac 系统中运行 ps -ef 命令可以看到当前系统中运行的进程. 各个参数如下:</p>\n<table>\n<thead>\n<tr>\n<th>列名称</th>\n<th>意义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>UID</td>\n<td>执行该进程的用户 ID</td>\n</tr>\n<tr>\n<td>PID</td>\n<td>进程编号</td>\n</tr>\n<tr>\n<td>PPID</td>\n<td>该进程的父进程编号</td>\n</tr>\n<tr>\n<td>C</td>\n<td>该进程所在的 CPU 利用率</td>\n</tr>\n<tr>\n<td>STIME</td>\n<td>进程执行时间</td>\n</tr>\n<tr>\n<td>TTY</td>\n<td>进程相关的终端类型</td>\n</tr>\n<tr>\n<td>TIME</td>\n<td>进程所占用的 CPU 时间</td>\n</tr>\n<tr>\n<td>CMD</td>\n<td>创建该进程的指令</td>\n</tr>\n</tbody>\n</table>\n<p>关于进程以及操作系统一些更深入的细节推荐阅读 APUE, 即《Unix 高级编程》等书籍来了解.</p>\n<h2 id="process"><a href="#process" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Process</h2>\n<p>这里来讨论 Node.js 中的 process 对象. 直接在代码中通过 console.log(process) 即可打印出来. 可以看到 process 对象暴露了非常多有用的属性以及方法, 具体的细节见<a href="https://nodejs.org/dist/latest-v6.x/docs/api/process.html" target="_blank" rel="nofollow noreferrer noopener">官方文档</a>, 已经说的挺详细了. 其中包括但不限于:</p>\n<ul>\n<li>进程基础信息</li>\n<li>进程 Usage</li>\n<li>进程级事件</li>\n<li>依赖模块/版本信息</li>\n<li>OS 基础信息</li>\n<li>账户信息</li>\n<li>信号收发</li>\n<li>三个标准流</li>\n</ul>\n<h3 id="processnexttick"><a href="#processnexttick" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>process.nextTick</h3>\n<p>上一节已经提到过 process.nextTick 了, 这是一个你需要了解的, 重要的, 基础方法.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12803124766116491000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`   ┌───────────────────────┐\n┌─>│        timers         │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     I/O callbacks     │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     idle, prepare     │\n│  └──────────┬────────────┘      ┌───────────────┐\n│  ┌──────────┴────────────┐      │   incoming:   │\n│  │         poll          │<─────┤  connections, │\n│  └──────────┬────────────┘      │   data, etc.  │\n│  ┌──────────┴────────────┐      └───────────────┘\n│  │        check          │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n└──┤    close callbacks    │\n   └───────────────────────┘`, `12803124766116491000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">   ┌───────────────────────┐\n┌─&gt;│        timers         │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     I/O callbacks     │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n│  │     idle, prepare     │\n│  └──────────┬────────────┘      ┌───────────────┐\n│  ┌──────────┴────────────┐      │   incoming:   │\n│  │         poll          │&lt;─────┤  connections, │\n│  └──────────┬────────────┘      │   data, etc.  │\n│  ┌──────────┴────────────┐      └───────────────┘\n│  │        check          │\n│  └──────────┬────────────┘\n│  ┌──────────┴────────────┐\n└──┤    close callbacks    │\n   └───────────────────────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>process.nextTick 并不属于 Event loop 中的某一个阶段, 而是在 Event loop 的每一个阶段结束后, 直接执行 nextTickQueue 中插入的 “Tick”, 并且直到整个 Queue 处理完. 所以面试时又有可以问的问题了, 递归调用 process.nextTick 会怎么样?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5413262929990870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function test() {\n  process.nextTick(() => test());\n}`, `5413262929990870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>超过 1000 次会提示调用栈过多</p>\n<p>这种情况与以下情况, 有什么区别? 为什么?</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87412667598372360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function test() {\n  setTimeout(() => test(), 0);\n}`, `87412667598372360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>process.nextTick 是将异步回调放到当前帧的末尾、io 回调之前，如果 nextTick 过多，会导致 io 回调不断延后,最后 callback 堆积太多.</li>\n<li>setImmediate 是将异步回调放到下一帧，不影响 io 回调，不会造成 callback 堆积.</li>\n<li>process.nextTick() 所设置的回调函数会存放到数组中，一次性执行所有回调函数。</li>\n<li>setImmediate() 所设置的回调函数会存到到链表中，每次事件循环只执行链表中的一个回调函数。</li>\n</ul>\n<h3 id="配置"><a href="#%E9%85%8D%E7%BD%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置</h3>\n<p>配置是开发部署中一个很常见的问题，普通的配置有两种方式，一是定义配置文件，二是使用环境变量</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-04-10-46-00-bf49abe74c79c523cfb87620d90817d2-9cc21.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 68.53094705443698%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB7klEQVQoz5VTTW/TQBD1b4A7P6dcqDggpHIATkVIVPwDDtz4AZXgCGoDqBfUAxSpAYQrRVRJnCapEye4KRBKqOPvrO3d9X4wa1elLVCJ0fNotN43895Iq8n/D1EAQhNCeH4YhnEczeIYAaIwnsXI9YJDx0MoSZMM4Ey9IIicqe+6AWOs7KLB197b3zL7+m7vY9eEvD0Y1noDvWNWmzufrGFrtN+w9z60OnrXrPWsra45QfE0SwhjipwLjgUjRxm6AigcF0UuBBGClkWpN+ccAJK1sz4KEj2B/N/mtd9rEDxN0wSh/PMDaS3IwW05uKXQvylbN6SxII3rJOinmB/P0QqaoJRijH3fdxxn/eX9Z8tzlSdXK4/nny5feb1yDRt3Wfue3F0ikZ2R02TOOdBg4wghKOYe6hfvbF5aege4sPj28qNGkErMxHmyS+0/xpN21fJ8L89hKYxxBlmNEgD+FzLIVrsTqneK0sOxS2kOLgihaZZlWEVWgFAKl3h5/4/JZSPwIZhK4sw/efpEkUeRbwdTDKtOk5J/pCLDRqdf7/TqplW3hg3bbn4ZGeOvxsG35uT7jBBF7rg/d5yD0Pddzz2eD9kLotVXb1bWN1Y3NivV9891/cV2ba1VX+saFdOYoJl2/hvgyoMoTZ5E2f0XbDsJure/bRMAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 04 10 46 00"\n        title=""\n        src="/static/2021-01-04-10-46-00-bf49abe74c79c523cfb87620d90817d2-fee1c.png"\n        srcset="/static/2021-01-04-10-46-00-bf49abe74c79c523cfb87620d90817d2-a67b7.png 200w,\n/static/2021-01-04-10-46-00-bf49abe74c79c523cfb87620d90817d2-0b187.png 400w,\n/static/2021-01-04-10-46-00-bf49abe74c79c523cfb87620d90817d2-fee1c.png 800w,\n/static/2021-01-04-10-46-00-bf49abe74c79c523cfb87620d90817d2-b1a91.png 1200w,\n/static/2021-01-04-10-46-00-bf49abe74c79c523cfb87620d90817d2-9cc21.png 1341w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>你可以通过设置环境变量来指定配置, 然后通过 process.env 来获取配置项. 另外也可以通过读取定义好的配置文件来获取, 在这方面有很多不错的库例如 dotenv, node-config 等, 而在使用这些库来加载配置文件的时候, 通常都会碰到一个当前工作目录的问题</p>\n<blockquote>\n<p>进程的当前工作目录是什么? 有什么作用?</p>\n</blockquote>\n<p>当前进程启动的目录, 通过 process.cwd() 获取当前工作目录 (current working directory), 通常是命令行启动的时候所在的目录 (也可以在启动时指定), 文件操作等使用相对路径的时候会相对当前工作目录来获取文件.</p>\n<p>一些获取配置的第三方模块就是通过你的当前目录来找配置文件的. 所以如果你错误的目录启动脚本, 可能没法得到正确的结果. 在程序中可以通过 process.chdir() 来改变当前的工作目录.</p>\n<h3 id="标准流"><a href="#%E6%A0%87%E5%87%86%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标准流</h3>\n<p>在 process 对象上还暴露了 process.stderr, process.stdout 以及 process.stdin 三个标准流, 熟悉 C/C++/Java 的同学应该对此比较熟悉. 关于这几个流, 常见的面试问题是问 console.log 是同步还是异步? 如何实现一个 console.log?</p>\n<p>如果简历中有出现 C/C++ 关键字, 一般都会问到如何实现一个同步的输入 (类似实现 C 语言的 scanf, C++ 的 cin, Python 的 raw_input 等).</p>\n<h3 id="维护方面"><a href="#%E7%BB%B4%E6%8A%A4%E6%96%B9%E9%9D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>维护方面</h3>\n<p>熟悉与进程有关的基础命令, 如 top, ps, pstree 等命令</p>\n<h2 id="child-process"><a href="#child-process" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Child Process</h2>\n<p>子进程 (Child Process) 是进程中一个重要的概念. 你可以通过 Node.js 的 child_process 模块来执行可执行文件, 调用命令行命令, 比如其他语言的程序等. 也可以通过该模块来将 .js 代码以子进程的方式启动. 比较有名的网易的分布式架构 pomelo 就是基于该模块 (而不是 cluster) 来实现多进程分布式架构的.</p>\n<blockquote>\n<p>child_process.fork 与 POSIX 的 fork 有什么区别?</p>\n</blockquote>\n<p>Node.js 的 child<em>process.fork() 在 Unix 上的实现最终调用了 POSIX <a href="http://man7.org/linux/man-pages/man2/fork.2.html" target="_blank" rel="nofollow noreferrer noopener">fork(2)</a>, 而 POSIX 的 fork 需要手动管理子进程的资源释放 (waitpid), child</em>process.fork 则不用关心这个问题, Node.js 会自动释放, 并且可以在 option 中选择父进程死后是否允许子进程存活.</p>\n<ul>\n<li>\n<p>spawn() 启动一个子进程来执行命令</p>\n<ul>\n<li>options.detached 父进程死后是否允许子进程存活</li>\n<li>options.stdio 指定子进程的三个标准流</li>\n</ul>\n</li>\n<li>spawnSync() 同步版的 spawn, 可指定超时, 返回的对象可获得子进程的情况</li>\n<li>exec() 启动一个子进程来执行命令, 带回调参数获知子进程的情况, 可指定进程运行的超时时间</li>\n<li>execSync() 同步版的 exec(), 可指定超时, 返回子进程的输出 (stdout)</li>\n<li>execFile() 启动一个子进程来执行一个可执行文件, 可指定进程运行的超时时间</li>\n<li>execFileSync() 同步版的 execFile(), 返回子进程的输出, 如何超时或者 exit code 不为 0, 会直接 throw Error</li>\n<li>fork() 加强版的 spawn(), 返回值是 ChildProcess 对象可以与子进程交互</li>\n</ul>\n<p>其中 exec/execSync 方法会直接调用 bash 来解释命令, 所以如果有命令有外部参数, 则需要注意被注入的情况.</p>\n<h3 id="childkill-与-childsend"><a href="#childkill-%E4%B8%8E-childsend" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>child.kill 与 child.send</h3>\n<p>常见会问的面试题, 如 child.kill 与 child.send 的区别. 二者一个是基于信号系统, 一个是基于 IPC.</p>\n<blockquote>\n<p>父进程或子进程的死亡是否会影响对方? 什么是孤儿进程?</p>\n</blockquote>\n<p>子进程死亡不会影响父进程, 不过子进程死亡时（线程组的最后一个线程，通常是“领头”线程死亡时），会向它的父进程发送死亡信号. 反之父进程死亡, 一般情况下子进程也会随之死亡, 但如果此时子进程处于可运行态、僵死状态等等的话, 子进程将被进程 1（init 进程）收养，从而成为孤儿进程. 另外, 子进程死亡的时候（处于“终止状态”），父进程没有及时调用 wait() 或 waitpid() 来返回死亡进程的相关信息，此时子进程还有一个 PCB 残留在进程表中，被称作僵尸进程.</p>\n<h2 id="cluster"><a href="#cluster" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cluster</h2>\n<p>Cluster 是常见的 Node.js 利用多核的办法. 它是基于 child_process.fork() 实现的, 所以 cluster 产生的进程之间是通过 IPC 来通信的, 并且它也没有拷贝父进程的空间, 而是通过加入 cluster.isMaster 这个标识, 来区分父进程以及子进程, 达到类似 POSIX 的 fork 的效果.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55510189776782080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const cluster = require(\'cluster\'); // | |\nconst http = require(\'http\'); // | |\nconst numCPUs = require(\'os\').cpus().length; // | |    都执行了\n// | |\nif (cluster.isMaster) {\n  // |-|-----------------\n  // Fork workers.                             //   |\n  for (var i = 0; i < numCPUs; i++) {\n    //   |\n    cluster.fork(); //   |\n  } //   | 仅父进程执行 (a.js)\n  cluster.on(\'exit\', (worker) => {\n    //   |\n    console.log(\\`\\${worker.process.pid} died\\`); //   |\n  }); //   |\n} else {\n  // |-------------------\n  // Workers can share any TCP connection      // |\n  // In this case it is an HTTP server         // |\n  http\n    .createServer((req, res) => {\n      // |\n      res.writeHead(200); // |   仅子进程执行 (b.js)\n      res.end(\'hello world\\n\'); // |\n    })\n    .listen(8000); // |\n} // |-------------------\n// | |\nconsole.log(\'hello\'); // | |    都执行了`, `55510189776782080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'cluster\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// | |</span>\n<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// | |</span>\n<span class="token keyword">const</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'os\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// | |    都执行了</span>\n<span class="token comment">// | |</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// |-|-----------------</span>\n  <span class="token comment">// Fork workers.                             //   |</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">//   |</span>\n    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//   |</span>\n  <span class="token punctuation">}</span> <span class="token comment">//   | 仅父进程执行 (a.js)</span>\n  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'exit\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">worker</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">//   |</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> died</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//   |</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//   |</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// |-------------------</span>\n  <span class="token comment">// Workers can share any TCP connection      // |</span>\n  <span class="token comment">// In this case it is an HTTP server         // |</span>\n  http\n    <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// |</span>\n      res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// |   仅子进程执行 (b.js)</span>\n      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">\'hello world\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// |</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// |</span>\n<span class="token punctuation">}</span> <span class="token comment">// |-------------------</span>\n<span class="token comment">// | |</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// | |    都执行了</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在上述代码中 numCPUs 虽然是全局变量但是, 在父进程中修改它, 子进程中并不会改变, 因为父进程与子进程是完全独立的两个空间. 他们所谓的共有仅仅只是都执行了, 并不是同一份.</p>\n<p>你可以把父进程执行的部分当做 a.js, 子进程执行的部分当做 b.js, 你可以把他们想象成是先执行了 node a.js 然后 cluster.fork 了几次, 就执行了几次 node b.js. 而 cluster 模块则是二者之间的一个桥梁, 你可以通过 cluster 提供的方法, 让其二者之间进行沟通交流.</p>\n<h3 id="how-it-works"><a href="#how-it-works" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How It Works</h3>\n<p>worker 进程是由 child_process.fork() 方法创建的, 所以可以通过 IPC 在主进程和子进程之间相互传递服务器句柄.</p>\n<p>cluster 模块提供了两种分发连接的方式.</p>\n<p>第一种方式 (默认方式, 不适用于 windows), 通过时间片轮转法（round-robin）分发连接. 主进程监听端口, 接收到新连接之后, 通过时间片轮转法来决定将接收到的客户端的 socket 句柄传递给指定的 worker 处理. 至于每个连接由哪个 worker 来处理, 完全由内置的循环算法决定.</p>\n<p>第二种方式是由主进程创建 socket 监听端口后, 将 socket 句柄直接分发给相应的 worker, 然后当连接进来时, 就直接由相应的 worker 来接收连接并处理.</p>\n<p>使用第二种方式时理论上性能应该较高, 然而时间上存在负载不均衡的问题, 比如通常 70% 的连接仅被 8 个进程中的 2 个处理, 而其他进程比较清闲.</p>\n<h2 id="进程间通信"><a href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程间通信</h2>\n<p>IPC (Inter-process communication) 进程间通信技术. 常见的进程间通信技术列表如下:</p>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>无连接</th>\n<th>可靠</th>\n<th>流控制</th>\n<th>优先级</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>普通 PIPE</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>命名 PIPE</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>消息队列</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>信号量</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>共享存储</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>UNIX 流 SOCKET</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>UNIX 数据包 SOCKET</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n<td>N</td>\n</tr>\n</tbody>\n</table>\n<p>Node.js 中的 IPC 通信是由 libuv 通过管道技术实现的, 在 windows 下由命名管道（named pipe）实现也就是上表中的最后第二个, *nix 系统则采用 UDS (Unix Domain Socket) 实现.</p>\n<p>普通的 socket 是为网络通讯设计的, 而网络本身是不可靠的, 而为 IPC 设计的 socket 则不然, 因为默认本地的网络环境是可靠的, 所以可以简化大量不必要的 encode/decode 以及计算校验等, 得到效率更高的 UDS 通信.</p>\n<p>如果了解 Node.js 的 IPC 的话, 可以问个比较有意思的问题</p>\n<blockquote>\n<p>在 IPC 通道建立之前, 父进程与子进程是怎么通信的? 如果没有通信, 那 IPC 是怎么建立的?</p>\n</blockquote>\n<p>这个问题也挺简单, 只是个思路的问题. 在通过 <code class="language-text">child_process</code> 建立子进程的时候, 是可以指定子进程的 env (环境变量) 的. 所以 Node.js 在启动子进程的时候, 主进程先建立 IPC 频道, 然后将 IPC 频道的 fd (文件描述符) 通过环境变量 (<code class="language-text">NODE_CHANNEL_FD</code>) 的方式传递给子进程, 然后子进程通过 fd 连上 IPC 与父进程建立连接.</p>\n<p>最后于进程间通信 (IPC) 的问题, 一般不会直接问 IPC 的实现, 而是会问什么情况下需要 IPC, 以及使用 IPC 处理过什么业务场景等.</p>\n<h2 id="守护进程"><a href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>守护进程</h2>\n<p>最后的守护进程, 是服务端方面一个很基础的概念了. 很多人可能只知道通过 pm2 之类的工具可以将进程以守护进程的方式启动, 却不了解什么是守护进程, 为什么要用守护进程. 对于水平好的同学, 我们是希望能了解守护进程的实现的.</p>\n<p>普通的进程, 在用户退出终端之后就会直接关闭. 通过 &#x26; 启动到后台的进程, 之后会由于会话（session 组）被回收而终止进程. 守护进程是不依赖终端（tty）的进程, 不会因为用户退出终端而停止运行的进程.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60510361969022980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 守护进程实现 (C语言版本)\nvoid init_daemon()\n{\n    pid_t pid;\n    int i = 0;\n\n    if ((pid = fork()) == -1) {\n        printf(&quot;Fork error !\\n&quot;);\n        exit(1);\n    }\n\n    if (pid != 0) {\n        exit(0);        // 父进程退出\n    }\n\n    setsid();           // 子进程开启新会话, 并成为会话首进程和组长进程\n    if ((pid = fork()) == -1) {\n        printf(&quot;Fork error !\\n&quot;);\n        exit(-1);\n    }\n    if (pid != 0) {\n        exit(0);        // 结束第一子进程, 第二子进程不再是会话首进程\n                        // 避免当前会话组重新与tty连接\n    }\n    chdir(&quot;/tmp&quot;);      // 改变工作目录\n    umask(0);           // 重设文件掩码\n    for (; i < getdtablesize(); ++i) {\n       close(i);        // 关闭打开的文件描述符\n    }\n\n    return;\n}`, `60510361969022980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token comment">// 守护进程实现 (C语言版本)</span>\n<span class="token keyword">void</span> <span class="token function">init_daemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    pid_t pid<span class="token punctuation">;</span>\n    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fork error !\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 父进程退出</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 子进程开启新会话, 并成为会话首进程和组长进程</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fork error !\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 结束第一子进程, 第二子进程不再是会话首进程</span>\n                        <span class="token comment">// 避免当前会话组重新与tty连接</span>\n    <span class="token punctuation">}</span>\n    <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 改变工作目录</span>\n    <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 重设文件掩码</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">getdtablesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n       <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 关闭打开的文件描述符</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1176332929057300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`var spawn = require(\'child_process\').spawn;\nvar process = require(\'process\');\n\nvar p = spawn(\'node\', [\'b.js\'], {\n  detached: true\n});\nconsole.log(process.pid, p.pid);\nprocess.exit(0);`, `1176332929057300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">var</span> spawn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'child_process\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>spawn<span class="token punctuation">;</span>\n<span class="token keyword">var</span> process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'process\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">\'node\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'b.js\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  detached<span class="token punctuation">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> p<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>\nprocess<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="io"><a href="#io" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IO</h1>\n<h2 id="简述-3"><a href="#%E7%AE%80%E8%BF%B0-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简述</h2>\n<p>Node.js 是以 IO 密集型业务著称. 那么问题来了, 你真的了解什么叫 IO, 什么又叫 IO 密集型业务吗?</p>\n<h2 id="buffer"><a href="#buffer" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Buffer</h2>\n<p>Buffer 是 Node.js 中用于处理二进制数据的类, 其中与 IO 相关的操作 (网络/文件等) 均基于 Buffer. Buffer 类的实例非常类似整数数组, 但其大小是固定不变的, 并且其内存在 V8 堆栈外分配原始内存空间. Buffer 类的实例创建之后, 其所占用的内存大小就不能再进行调整.</p>\n<p>在 Node.js v6.x 之后 new Buffer() 接口开始被废弃, 理由是参数类型不同会返回不同类型的 Buffer 对象, 所以当开发者没有正确校验参数或没有正确初始化 Buffer 对象的内容时, 以及不了解的情况下初始化 就会在不经意间向代码中引入安全性和可靠性问题.</p>\n<table>\n<thead>\n<tr>\n<th>接口</th>\n<th>用途</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Buffer.from()</td>\n<td>根据已有数据生成一个 Buffer 对象</td>\n</tr>\n<tr>\n<td>Buffer.alloc()</td>\n<td>创建一个初始化后的 Buffer 对象</td>\n</tr>\n<tr>\n<td>Buffer.allocUnsafe()</td>\n<td>创建一个未初始化的 Buffer 对象</td>\n</tr>\n</tbody>\n</table>\n<h3 id="typedarray"><a href="#typedarray" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TypedArray</h3>\n<p>Node.js 的 Buffer 在 ES6 增加了 TypedArray 类型之后, 修改了原来的 Buffer 的实现, 选择基于 TypedArray 中 Uint8Array 来实现, 从而提升了一波性能.</p>\n<p>使用上, 你需要了解如下情况:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54857860053545470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const arr = new Uint16Array(2);\narr[0] = 5000;\narr[1] = 4000;\n\nconst buf1 = Buffer.from(arr); // 拷贝了该 buffer\nconst buf2 = Buffer.from(arr.buffer); // 与该数组共享了内存\n\nconsole.log(buf1);\n// 输出: <Buffer 88 a0>, 拷贝的 buffer 只有两个元素\nconsole.log(buf2);\n// 输出: <Buffer 88 13 a0 0f>\n\narr[1] = 6000;\nconsole.log(buf1);\n// 输出: <Buffer 88 a0>\nconsole.log(buf2);\n// 输出: <Buffer 88 13 70 17>`, `54857860053545470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\narr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>\narr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> buf1 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拷贝了该 buffer</span>\n<span class="token keyword">const</span> buf2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 与该数组共享了内存</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 输出: &lt;Buffer 88 a0>, 拷贝的 buffer 只有两个元素</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 输出: &lt;Buffer 88 13 a0 0f></span>\n\narr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6000</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 输出: &lt;Buffer 88 a0></span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 输出: &lt;Buffer 88 13 70 17></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="string-decoder"><a href="#string-decoder" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>String Decoder</h2>\n<p>字符串解码器 (String Decoder) 是一个用于将 Buffer 拿来 decode 到 string 的模块, 是作为 Buffer.toString 的一个补充, 它支持多字节 UTF-8 和 UTF-16 字符. 例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36157015667686453000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const StringDecoder = require(\'string_decoder\').StringDecoder;\nconst decoder = new StringDecoder(\'utf8\');\n\nconst cent = Buffer.from([0xc2, 0xa2]);\nconsole.log(decoder.write(cent)); // ¢\n\nconst euro = Buffer.from([0xe2, 0x82, 0xac]);\nconsole.log(decoder.write(euro)); // €`, `36157015667686453000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> StringDecoder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'string_decoder\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>StringDecoder<span class="token punctuation">;</span>\n<span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token string">\'utf8\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> cent <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xc2</span><span class="token punctuation">,</span> <span class="token number">0xa2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>cent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ¢</span>\n\n<span class="token keyword">const</span> euro <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xe2</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xac</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>euro<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// €</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>stringDecoder.write 会确保返回的字符串不包含 Buffer 末尾残缺的多字节字符，残缺的多字节字符会被保存在一个内部的 buffer 中用于下次调用 stringDecoder.write() 或 stringDecoder.end()。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34225412866234640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const StringDecoder = require(\'string_decoder\').StringDecoder;\nconst decoder = new StringDecoder(\'utf8\');\n\ndecoder.write(Buffer.from([0xe2]));\ndecoder.write(Buffer.from([0x82]));\nconsole.log(decoder.end(Buffer.from([0xac]))); // €`, `34225412866234640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> StringDecoder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'string_decoder\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>StringDecoder<span class="token punctuation">;</span>\n<span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token string">\'utf8\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ndecoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xe2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ndecoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x82</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xac</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// €</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="stream"><a href="#stream" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stream</h2>\n<p>Node.js 内置的 stream 模块是多个核心模块的基础. 但是流 (stream) 是一种很早之前流行的编程方式. 可以用大家比较熟悉的 C 语言来看这种流式操作:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29437439997255942000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int copy(const char *src, const char *dest)\n{\n    FILE *fpSrc, *fpDest;\n    char buf[BUF_SIZE] = {0};\n    int lenSrc, lenDest;\n\n    // 打开 src 的文件\n    if ((fpSrc = fopen(src, &quot;r&quot;)) == NULL)\n    {\n        printf(&quot;文件 \'%s\' 无法打开\\n&quot;, src);\n        return FAILURE;\n    }\n\n    // 打开 dest 的文件\n    if ((fpDest = fopen(dest, &quot;w&quot;)) == NULL)\n    {\n        printf(&quot;文件 \'%s\' 无法打开\\n&quot;, dest);\n        fclose(fpSrc);\n        return FAILURE;\n    }\n\n    // 从 src 中读取 BUF_SIZE 长的数据到 buf 中\n    while ((lenSrc = fread(buf, 1, BUF_SIZE, fpSrc)) > 0)\n    {\n        // 将 buf 中的数据写入 dest 中\n        if ((lenDest = fwrite(buf, 1, lenSrc, fpDest)) != lenSrc)\n        {\n            printf(&quot;写入文件 \'%s\' 失败\\n&quot;, dest);\n            fclose(fpSrc);\n            fclose(fpDest);\n            return FAILURE;\n        }\n        // 写入成功后清空 buf\n        memset(buf, 0, BUF_SIZE);\n    }\n\n    // 关闭文件\n    fclose(fpSrc);\n    fclose(fpDest);\n    return SUCCESS;\n}`, `29437439997255942000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">int</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dest<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    FILE <span class="token operator">*</span>fpSrc<span class="token punctuation">,</span> <span class="token operator">*</span>fpDest<span class="token punctuation">;</span>\n    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">int</span> lenSrc<span class="token punctuation">,</span> lenDest<span class="token punctuation">;</span>\n\n    <span class="token comment">// 打开 src 的文件</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fpSrc <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件 \'%s\' 无法打开\\n"</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 打开 dest 的文件</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fpDest <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件 \'%s\' 无法打开\\n"</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 从 src 中读取 BUF_SIZE 长的数据到 buf 中</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lenSrc <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">,</span> fpSrc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token comment">// 将 buf 中的数据写入 dest 中</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lenDest <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lenSrc<span class="token punctuation">,</span> fpDest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> lenSrc<span class="token punctuation">)</span>\n        <span class="token punctuation">{</span>\n            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写入文件 \'%s\' 失败\\n"</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token function">fclose</span><span class="token punctuation">(</span>fpDest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 写入成功后清空 buf</span>\n        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 关闭文件</span>\n    <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">fclose</span><span class="token punctuation">(</span>fpDest<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>应用的场景很简单, 你要拷贝一个 20G 大的文件, 如果你一次性将 20G 的数据读入到内存, 你的内存条可能不够用, 或者严重影响性能. 但是你如果使用一个 1MB 大小的缓存 (buf) 每次读取 1Mb, 然后写入 1Mb, 那么不论这个文件多大都只会占用 1Mb 的内存.</p>\n<p>而在 Node.js 中, 原理与上述 C 代码类似, 不过在读写的实现上通过 libuv 与 EventEmitter 加上了异步的特性. 在 linux/unix 中你可以通过 | 来感受到流式操作.</p>\n<h3 id="stream-的类型"><a href="#stream-%E7%9A%84%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stream 的类型</h3>\n<table>\n<thead>\n<tr>\n<th>类</th>\n<th>使用场景</th>\n<th>重写方法</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href="https://github.com/substack/stream-handbook#readable-streams" target="_blank" rel="nofollow noreferrer noopener">Readable</a></td>\n<td>只读</td>\n<td>_\nread</td>\n</tr>\n<tr>\n<td><a href="https://github.com/substack/stream-handbook#writable-streams" target="_blank" rel="nofollow noreferrer noopener">Writable</a></td>\n<td>只写</td>\n<td>_\nwrite</td>\n</tr>\n<tr>\n<td><a href="https://github.com/substack/stream-handbook#duplex" target="_blank" rel="nofollow noreferrer noopener">Duplex</a></td>\n<td>读写</td>\n<td>_\nread, \n_\nwrite</td>\n</tr>\n<tr>\n<td><a href="https://github.com/substack/stream-handbook#transform" target="_blank" rel="nofollow noreferrer noopener">Transform</a></td>\n<td>操作被写入数据, 然后读出结果</td>\n<td>_\ntransform, \n_\nflush</td>\n</tr>\n</tbody>\n</table>\n<h3 id="对象模式"><a href="#%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对象模式</h3>\n<p>通过 Node API 创建的流, 只能够对字符串或者 buffer 对象进行操作. 但其实流的实现是可以基于其他的 JavaScript 类型(除了 null, 它在流中有特殊的含义)的. 这样的流就处在 “对象模式(objectMode)” 中. 在创建流对象的时候, 可以通过提供 <code class="language-text">objectMode</code> 参数来生成对象模式的流. 试图将现有的流转换为对象模式是不安全的</p>\n<h3 id="缓冲区"><a href="#%E7%BC%93%E5%86%B2%E5%8C%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓冲区</h3>\n<p>Node.js 中 stream 的缓冲区, 以开头的 C 语言拷贝文件的代码为模板讨论, (抛开异步的区别看) 则是从 <code class="language-text">src</code> 中读出数据到 <code class="language-text">buf</code> 中后, 并没有直接写入 <code class="language-text">dest</code> 中, 而是先放在一个比较大的缓冲区中, 等待写入(消费) <code class="language-text">dest</code> 中. 即, 在缓冲区的帮助下可以使读与写的过程分离.</p>\n<p>Readable 和 Writable 流都会将数据储存在内部的缓冲区中. 缓冲区可以分别通过 <code class="language-text">writable._writableState.getBuffer()</code> 和 <code class="language-text">readable._readableState.buffer</code> 来访问. 缓冲区的大小, 由构造 stream 时候的 <code class="language-text">highWaterMark</code> 标志指定可容纳的 byte 大小, 对于 <code class="language-text">objectMode</code> 的 stream, 该标志表示可以容纳的对象个数.</p>\n<h4 id="可读流"><a href="#%E5%8F%AF%E8%AF%BB%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可读流</h4>\n<p>当一个可读实例调用 <code class="language-text">stream.push()</code> 方法的时候, 数据将会被推入缓冲区. 如果数据没有被消费, 即调用 <code class="language-text">stream.read()</code> 方法读取的话, 那么数据会一直留在缓冲队列中. 当缓冲区中的数据到达 <code class="language-text">highWaterMark</code> 指定的阈值, 可读流将停止从底层汲取数据, 直到当前缓冲的报备成功消耗为止.</p>\n<h4 id="可写流"><a href="#%E5%8F%AF%E5%86%99%E6%B5%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可写流</h4>\n<p>在一个在可写实例上不停地调用 writable.write(chunk) 的时候数据会被写入可写流的缓冲区. 如果当前缓冲区的缓冲的数据量低于 <code class="language-text">highWaterMark</code> 设定的值, 调用 writable.write() 方法会返回 true (表示数据已经写入缓冲区), 否则当缓冲的数据量达到了阈值, 数据无法写入缓冲区 write 方法会返回 false, 直到 drain 事件触发之后才能继续调用 write 写入.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38578205640596270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Write the data to the supplied writable stream one million times.\n// Be attentive to back-pressure.\nfunction writeOneMillionTimes(writer, data, encoding, callback) {\n  let i = 1000000;\n  write();\n  function write() {\n    var ok = true;\n    do {\n      i--;\n      if (i === 0) {\n        // last time!\n        writer.write(data, encoding, callback);\n      } else {\n        // see if we should continue, or wait\n        // don\'t pass the callback, because we\'re not done yet.\n        ok = writer.write(data, encoding);\n      }\n    } while (i > 0 && ok);\n    if (i > 0) {\n      // had to stop early!\n      // write some more once it drains\n      writer.once(\'drain\', write);\n    }\n  }\n}`, `38578205640596270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Write the data to the supplied writable stream one million times.</span>\n<span class="token comment">// Be attentive to back-pressure.</span>\n<span class="token keyword">function</span> <span class="token function">writeOneMillionTimes</span><span class="token punctuation">(</span><span class="token parameter">writer<span class="token punctuation">,</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>\n  <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token keyword">do</span> <span class="token punctuation">{</span>\n      i<span class="token operator">--</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// last time!</span>\n        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// see if we should continue, or wait</span>\n        <span class="token comment">// don\'t pass the callback, because we\'re not done yet.</span>\n        ok <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ok<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// had to stop early!</span>\n      <span class="token comment">// write some more once it drains</span>\n      writer<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">\'drain\'</span><span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="duplex-与-transform"><a href="#duplex-%E4%B8%8E-transform" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Duplex 与 Transform</h4>\n<p>Duplex 流和 Transform 流都是同时可读写的, 他们会在内部维持两个缓冲区, 分别对应读取和写入, 这样就可以允许两边同时独立操作, 维持高效的数据流. 比如说 net.Socket 是一个 Duplex 流, Readable 端允许从 socket 获取、消耗数据, Writable 端允许向 socket 写入数据. 数据写入的速度很有可能与消耗的速度有差距, 所以两端可以独立操作和缓冲是很重要的.</p>\n<h3 id="pipe"><a href="#pipe" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pipe</h3>\n<p>stream 的 <code class="language-text">.pipe()</code>, 将一个可写流附到可读流上, 同时将可写流切换到流模式, 并把所有数据推给可写流. 在 pipe 传递数据的过程中, <code class="language-text">objectMode</code> 是传递引用, 非 <code class="language-text">objectMode</code> 则是拷贝一份数据传递下去.</p>\n<p>pipe 方法最主要的目的就是将数据的流动缓冲到一个可接受的水平, 不让不同速度的数据源之间的差异导致内存被占满. 关于 pipe 的实现参见 David Cai 的 <a href="https://cnodejs.org/topic/56ba030271204e03637a3870" target="_blank" rel="nofollow noreferrer noopener">通过源码解析 Node.js 中导流（pipe）的实现</a></p>\n<h2 id="console"><a href="#console" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Console</h2>\n<p><a href="https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_a_note_on_process_i_o" target="_blank" rel="nofollow noreferrer noopener">console.log 同步还是异步取决于与谁相连和<code class="language-text">os</code></a>. 不过一般情况下的实现都是如下 (<a href="https://github.com/nodejs/node/blob/v6.x/lib/console.js#L42" target="_blank" rel="nofollow noreferrer noopener">6.x 源代码</a>)，其中 <code class="language-text">this._stdout</code> 默认是 <code class="language-text">process.stdout</code>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48627037685429840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// As of v8 5.0.71.32, the combination of rest param, template string\n// and .apply(null, args) benchmarks consistently faster than using\n// the spread operator when calling util.format.\nConsole.prototype.log = function(...args) {\n  this._stdout.write(\\`\\${util.format.apply(null, args)}\\n\\`);\n};`, `48627037685429840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// As of v8 5.0.71.32, the combination of rest param, template string</span>\n<span class="token comment">// and .apply(null, args) benchmarks consistently faster than using</span>\n<span class="token comment">// the spread operator when calling util.format.</span>\n<span class="token class-name">Console</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>_stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>util<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>自己实现一个 console.log 可以参考如下代码:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27538619265432818000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let print = (str) => process.stdout.write(str + \'\\n\');\n\nprint(\'hello world\');`, `27538619265432818000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=></span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token string">\'\\n\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>注意: 该代码并没有处理多参数, 也没有处理占位符 (即 util.format 的功能).</p>\n<h3 id="consolelogbindconsole-问题"><a href="#consolelogbindconsole-%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>console.log.bind(console) 问题</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9014437122338381000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 源码出处 https://github.com/nodejs/node/blob/v6.x/lib/console.js\nfunction Console(stdout, stderr) {\n  // ... init ...\n\n  // bind the prototype functions to this Console instance\n  var keys = Object.keys(Console.prototype);\n  for (var v = 0; v < keys.length; v++) {\n    var k = keys[v];\n    this[k] = this[k].bind(this);\n  }\n}`, `9014437122338381000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 源码出处 https://github.com/nodejs/node/blob/v6.x/lib/console.js</span>\n<span class="token keyword">function</span> <span class="token function">Console</span><span class="token punctuation">(</span><span class="token parameter">stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ... init ...</span>\n\n  <span class="token comment">// bind the prototype functions to this Console instance</span>\n  <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token class-name">Console</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> v<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">var</span> k <span class="token operator">=</span> keys<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="file"><a href="#file" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>File</h2>\n<p>“一切皆是文件”是 Unix/Linux 的基本哲学之一, 不仅普通的文件、目录、字符设备、块设备、套接字等在 Unix/Linux 中都是以文件被对待, 也就是说这些资源的操作对象均为 fd (文件描述符), 都可以通过同一套 system call 来读写. 在 linux 中你可以通过 ulimit 来对 fd 资源进行一定程度的管理限制.</p>\n<p>Node.js 封装了标准 POSIX 文件 I/O 操作的集合. 通过 require(‘fs’) 可以加载该模块. 该模块中的所有方法都有异步执行和同步执行两个版本. 你可以通过 fs.open 获得一个文件的文件描述符.</p>\n<h3 id="编码"><a href="#%E7%BC%96%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编码</h3>\n<p>UTF8, GBK, es6 中对编码的支持, 如何计算一个汉字的长度</p>\n<p>BOM</p>\n<h3 id="stdio"><a href="#stdio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>stdio</h3>\n<p>stdio (standard input output) 标准的输入输出流, 即输入流 (stdin), 输出流 (stdout), 错误流 (stderr) 三者. 在 Node.js 中分别对应 <code class="language-text">process.stdin</code> (Readable), <code class="language-text">process.stdout</code> (Writable) 以及 <code class="language-text">process.stderr</code> (Writable) 三个 stream.</p>\n<p>输出函数是每个人在学习任何一门编程语言时所需要学到的第一个函数. 例如 C 语言的 <code class="language-text">printf(&quot;hello, world!&quot;);</code> python/ruby 的 <code class="language-text">print &#39;hello, world!&#39;</code> 以及 JavaScript 中的 <code class="language-text">console.log(&#39;hello, world!&#39;);</code></p>\n<p>以 C 语言的伪代码来看的话, 这类输出函数的实现思路如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89081658044018620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int printf(FILE *stream, 要打印的内容)\n{\n  // ...\n\n  // 1. 申请一个临时内存空间\n  char *s = malloc(4096);\n\n  // 2. 处理好要打印的的内容, 其值存储在 s 中\n  //      ...\n\n  // 3. 将 s 上的内容写入到 stream 中\n  fwrite(s, stream);\n\n  // 4. 释放临时空间\n  free(s);\n\n  // ...\n}`, `89081658044018620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">int</span> <span class="token function">printf</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">,</span> 要打印的内容<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n\n  <span class="token comment">// 1. 申请一个临时内存空间</span>\n  <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 2. 处理好要打印的的内容, 其值存储在 s 中</span>\n  <span class="token comment">//      ...</span>\n\n  <span class="token comment">// 3. 将 s 上的内容写入到 stream 中</span>\n  <span class="token function">fwrite</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 4. 释放临时空间</span>\n  <span class="token function">free</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要了解的是第 3 步, 其中的 stream 则是指 stdout (输出流). 实际上在 shell 上运行一个应用程序的时候, shell 做的第一个操作是 fork 当前 shell 的进程 (所以, 如果你通过 ps 去查看你从 shell 上启动的进程, 其父进程 pid 就是当前 shell 的 pid), 在这个过程中也把 shell 的 stdio 继承给了你当前的应用进程, 所以你在当前进程里面将数据写入到 stdout, 也就是写入到了 shell 的 stdout, 即在当前 shell 上显示了.</p>\n<p>输入也是同理, 当前进程继承了 shell 的 stdin, 所以当你从 stdin 中读取数据时, 其实就获取到你在 shell 上输入的数据. (PS: shell 可以是 windows 下的 cmd, powershell, 也可以是 linux 下 bash 或者 zsh 等)</p>\n<p>当你使用 ssh 在远程服务器上运行一个命令的时候, 在服务器上的命令输出虽然也是写入到服务器上 shell 的 stdout, 但是这个远程的 shell 是从 sshd 服务上 fork 出来的, 其 stdout 是继承自 sshd 的一个 fd, 这个 fd 其实是个 socket, 所以最终其实是写入到了一个 socket 中, 通过这个 socket 传输你本地的计算机上的 shell 的 stdout.</p>\n<p>如果你理解了上述情况, 那么你也就能理解为什么守护进程需要关闭 stdio, 如果切到后台的守护进程没有关闭 stdio 的话, 那么你在用 shell 操作的过程中, 屏幕上会莫名其妙的多出来一些输出. 此处对应<a href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B">守护进程</a>的 C 实现中的这一段:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49974181737782650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (; i < getdtablesize(); ++i) {\n  close(i);  // 关闭打开的 fd\n}`, `49974181737782650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                c 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="c"><pre style="counter-reset: linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">getdtablesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 关闭打开的 fd</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Linux/unix 的 fd 都被设计为整型数字, 从 0 开始. 你可以尝试运行如下代码查看.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5986983174418348000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`console.log(process.stdin.fd); // 0\nconsole.log(process.stdout.fd); // 1\nconsole.log(process.stderr.fd); // 2`, `5986983174418348000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">console.log(process.stdin.fd); // 0\nconsole.log(process.stdout.fd); // 1\nconsole.log(process.stderr.fd); // 2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在上一节中的 <a href="#childkill-%E4%B8%8E-childsend">在 IPC 通道建立之前, 父进程与子进程是怎么通信的? 如果没有通信, 那 IPC 是怎么建立的?</a> 中使用环境变量传递 fd 的方法, 这么看起来就很直白了, 因为传递 fd 其实是直接传递了一个整型数字.</p>\n<h3 id="如何同步的获取用户的输入"><a href="#%E5%A6%82%E4%BD%95%E5%90%8C%E6%AD%A5%E7%9A%84%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%9A%84%E8%BE%93%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何同步的获取用户的输入?</h3>\n<p>如果你理解了上述的内容, 那么放到 Node.js 中来看, 获取用户的输入其实就是读取 Node.js 进程中的输入流 (即 process.stdin 这个 stream) 的数据.</p>\n<p>而要同步读取, 则是不用异步的 read 接口, 而是用同步的 readSync 接口去读取 stdin 的数据即可实现. 以下来自万能的 stackoverflow:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87077854029347100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/*\n * http://stackoverflow.com/questions/3430939/node-js-readsync-from-stdin\n * @mklement0\n */\nvar fs = require(\'fs\');\n\nvar BUFSIZE = 256;\nvar buf = new Buffer(BUFSIZE);\nvar bytesRead;\n\nmodule.exports = function() {\n  var fd = \'win32\' === process.platform ? process.stdin.fd : fs.openSync(\'/dev/stdin\', \'rs\');\n  bytesRead = 0;\n\n  try {\n    bytesRead = fs.readSync(fd, buf, 0, BUFSIZE);\n  } catch (e) {\n    if (e.code === \'EAGAIN\') {\n      // \'resource temporarily unavailable\'\n      // Happens on OS X 10.8.3 (not Windows 7!), if there\'s no\n      // stdin input - typically when invoking a script without any\n      // input (for interactive stdin input).\n      // If you were to just continue, you\'d create a tight loop.\n      console.error(\'ERROR: interactive stdin input not supported.\');\n      process.exit(1);\n    } else if (e.code === \'EOF\') {\n      // Happens on Windows 7, but not OS X 10.8.3:\n      // simply signals the end of *piped* stdin input.\n      return \'\';\n    }\n    throw e; // unexpected exception\n  }\n\n  if (bytesRead === 0) {\n    // No more stdin input available.\n    // OS X 10.8.3: regardless of input method, this is how the end\n    //   of input is signaled.\n    // Windows 7: this is how the end of input is signaled for\n    //   *interactive* stdin input.\n    return \'\';\n  }\n  // Process the chunk read.\n\n  var content = buf.toString(null, 0, bytesRead - 1);\n\n  return content;\n};`, `87077854029347100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/*\n * http://stackoverflow.com/questions/3430939/node-js-readsync-from-stdin\n * @mklement0\n */</span>\n<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">var</span> <span class="token constant">BUFSIZE</span> <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token constant">BUFSIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">var</span> bytesRead<span class="token punctuation">;</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token string">\'win32\'</span> <span class="token operator">===</span> process<span class="token punctuation">.</span>platform <span class="token operator">?</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fd <span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span><span class="token string">\'/dev/stdin\'</span><span class="token punctuation">,</span> <span class="token string">\'rs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  bytesRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    bytesRead <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readSync</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">BUFSIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">\'EAGAIN\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// \'resource temporarily unavailable\'</span>\n      <span class="token comment">// Happens on OS X 10.8.3 (not Windows 7!), if there\'s no</span>\n      <span class="token comment">// stdin input - typically when invoking a script without any</span>\n      <span class="token comment">// input (for interactive stdin input).</span>\n      <span class="token comment">// If you were to just continue, you\'d create a tight loop.</span>\n      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'ERROR: interactive stdin input not supported.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">\'EOF\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// Happens on Windows 7, but not OS X 10.8.3:</span>\n      <span class="token comment">// simply signals the end of *piped* stdin input.</span>\n      <span class="token keyword">return</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// unexpected exception</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// No more stdin input available.</span>\n    <span class="token comment">// OS X 10.8.3: regardless of input method, this is how the end</span>\n    <span class="token comment">//   of input is signaled.</span>\n    <span class="token comment">// Windows 7: this is how the end of input is signaled for</span>\n    <span class="token comment">//   *interactive* stdin input.</span>\n    <span class="token keyword">return</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// Process the chunk read.</span>\n\n  <span class="token keyword">var</span> content <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> content<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="readline"><a href="#readline" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Readline</h2>\n<p><code class="language-text">readline</code> 模块提供了一个用于从 Readble 的 stream (例如 process.stdin) 中一次读取一行的接口. 当然你也可以用来读取文件或者 net, http 的 stream, 比如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34858423113294500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const readline = require(\'readline\');\nconst fs = require(\'fs\');\n\nconst rl = readline.createInterface({\n  input: fs.createReadStream(\'sample.txt\')\n});\n\nrl.on(\'line\', (line) => {\n  console.log(\\`Line from file: \\${line}\\`);\n});`, `34858423113294500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'readline\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  input<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">\'sample.txt\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nrl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'line\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">line</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Line from file: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实现上, realine 在读取 TTY 的数据时, 是通过 <code class="language-text">input.on(&#39;keypress&#39;, onkeypress)</code> 时发现用户按下了回车键来判断是新的 line 的, 而读取一般的 stream 时, 则是通过缓存数据然后用正则 .test 来判断是否为 new line 的.</p>\n<p>PS: 打个广告, 如果在编写脚本时, 不习惯这样异步获取输入, 想要同步获取同步的用户输入可以看一看这个 Node.js 版本类 C 语言使用的 <a href="https://github.com/Lellansin/node-scanf/" target="_blank" rel="nofollow noreferrer noopener">scanf</a> 模块 (支持 ts).</p>\n<h2 id="repl"><a href="#repl" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>REPL</h2>\n<p>Read-Eval-Print-Loop (REPL)</p>\n<h1 id="network"><a href="#network" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Network</h1>\n<h2 id="net"><a href="#net" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Net</h2>\n<p>目前互联化的核心是建立在 TCP/IP 协议的基础上的, 这些协议将数据分割成小的数据包进行传输, 并且解决传输过程中各种各样复杂的问题. 关于协议的具体细节推荐阅读 W.Richard Stevens 的<a href="https://www.amazon.cn/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71-%E5%8D%8F%E8%AE%AE-W-Richard-Stevens/dp/B00116OTVS/" target="_blank" rel="nofollow noreferrer noopener">《TCP/IP 详解 卷 1：协议》</a>, 本文不做赘述, 只是列举一些常见的知识点, 新人推荐看<a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00DMS9990/" target="_blank" rel="nofollow noreferrer noopener">《图解 TCP/IP》</a>, 抓包工具推荐看<a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00PB5QQ84/" target="_blank" rel="nofollow noreferrer noopener">《Wireshark 网络分析就这么简单》</a>.</p>\n<h3 id="粘包"><a href="#%E7%B2%98%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>粘包</h3>\n<p>默认情况下, TCP 连接会启用延迟传送算法 (Nagle 算法), 在数据发送之前缓存他们. 如果短时间有多个数据发送, 会缓冲到一起作一次发送 (缓冲大小见 <code class="language-text">socket.bufferSize</code>), 这样可以减少 IO 消耗提高性能.</p>\n<p>如果是传输文件的话, 那么根本不用处理粘包的问题, 来一个包拼一个包就好了. 但是如果是多条消息, 或者是别的用途的数据那么就需要处理粘包.</p>\n<p>可以参见网上流传比较广的一个例子, 连续调用两次 send 分别发送两段数据 data1 和 data2, 在接收端有以下几种常见的情况:</p>\n<ul>\n<li>A. 先接收到 data1, 然后接收到 data2 .</li>\n<li>B. 先接收到 data1 的部分数据, 然后接收到 data1 余下的部分以及 data2 的全部.</li>\n<li>C. 先接收到了 data1 的全部数据和 data2 的部分数据, 然后接收到了 data2 的余下的数据.</li>\n<li>D. 一次性接收到了 data1 和 data2 的全部数据.</li>\n</ul>\n<p>其中的 BCD 就是我们常见的粘包的情况. 而对于处理粘包的问题, 常见的解决方案有:</p>\n<ul>\n<li>\n<ol>\n<li>多次发送之前间隔一个等待时间</li>\n</ol>\n</li>\n<li>\n<ol start="2">\n<li>关闭 Nagle 算法</li>\n</ol>\n</li>\n<li>\n<ol start="3">\n<li>进行封包/拆包</li>\n</ol>\n</li>\n</ul>\n<p><strong><em>方案 1</em></strong></p>\n<p>只需要等上一段时间再进行下一次 send 就好, 适用于交互频率特别低的场景. 缺点也很明显, 对于比较频繁的场景而言传输效率实在太低. 不过几乎不用做什么处理.</p>\n<p><strong><em>方案 2</em></strong></p>\n<p>关闭 Nagle 算法, 在 Node.js 中你可以通过 <a href="https://nodejs.org/dist/latest-v6.x/docs/api/net.html#net_socket_setnodelay_nodelay" target="_blank" rel="nofollow noreferrer noopener"><code class="language-text">socket.setNoDelay()</code></a> 方法来关闭 Nagle 算法, 让每一次 send 都不缓冲直接发送.</p>\n<p>该方法比较适用于每次发送的数据都比较大 (但不是文件那么大), 并且频率不是特别高的场景. 如果是每次发送的数据量比较小, 并且频率特别高的, 关闭 Nagle 纯属自废武功.</p>\n<p>另外, 该方法不适用于网络较差的情况, 因为 Nagle 算法是在服务端进行的包合并情况, 但是如果短时间内客户端的网络情况不好, 或者应用层由于某些原因不能及时将 TCP 的数据 recv, 就会造成多个包在客户端缓冲从而粘包的情况. (如果是在稳定的机房内部通信那么这个概率是比较小可以选择忽略的)</p>\n<p><strong><em>方案 3</em></strong></p>\n<p>封包/拆包是目前业内常见的解决方案了. 即给每个数据包在发送之前, 于其前/后放一些有特征的数据, 然后收到数据的时候根据特征数据分割出来各个数据包.</p>\n<h3 id="可靠传输"><a href="#%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可靠传输</h3>\n<p>为每一个发送的数据包分配一个序列号(SYN, Synchronize packet), 每一个包在对方收到后要返回一个对应的应答数据包(ACK, Acknowledgement), 发送方如果发现某个包没有被对方 ACK, 则会选择重发. 接收方通过 SYN 序号来保证数据的不会乱序(reordering), 发送方通过 ACK 来保证数据不缺漏, 以此参考决定是否重传. 关于具体的序号计算, 丢包时的重传机制等可以参见阅读陈皓的 <a href="http://coolshell.cn/articles/11564.html" target="_blank" rel="nofollow noreferrer noopener">《TCP 的那些事儿（上）》</a> 此处不做赘述.</p>\n<h3 id="window"><a href="#window" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>window</h3>\n<p>TCP 头里有一个 Window 字段, 是接收端告诉发送端自己还有多少缓冲区可以接收数据的. 发送端就可以根据接收端的处理能力来发送数据, 从而避免接收端处理不过来. 详细参见陈皓的 <a href="http://coolshell.cn/articles/11609.html" target="_blank" rel="nofollow noreferrer noopener">《TCP 的那些事儿（下）》</a></p>\n<blockquote>\n<p>window 是否设置的越大越好?</p>\n</blockquote>\n<p>类似木桶理论, 一个木桶能装多少水, 是由最短的那块木板决定的. 一个 TCP 连接的 window 是由该连接中间一连串设备中 window 最小的那一个设备决定的.</p>\n<h3 id="backlog"><a href="#backlog" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>backlog</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-03-09-14-09-15-60cb597a6066e1975b294c6418a458c3-fa1ac.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 59.48121645796065%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABmElEQVQoz31RyW4UMRCd/wUkkJA4sdzyB/AFXJAQ4pwLJ05IQUEsl0mYTi/T3Wl7vJe3Ktw9GSBhxJNlW5bfe1WvVoiYMWXKGTPdBhLO75TLxVm7WyCEGIah7OXD6kpenHx8/Oz0wauzkyK0p+2FfkznLz7cf3567/W3l5Syd9YYoxeEEGYyJGjUVS02W93uyUg3mwvyovn8/fJTN62Z9Vsu6rqpqopz7r1XSq2oEEJAcJQi3a07BTGZvgG5e/TFPP2qY54rygcUcvJGNPWm7ztI6BMJnyNSzGR8kHJntbTWvLlU7zcqxPi7tbns/SEt9FxOGmTA0WBvMnPYMtVdcy6UNZoPHeu3bduWqGKMpeeickN2PmhjLYTiXDxDKraZKePBrXfw5Fy9/SmxJObAuRK8BYADGRP9Nae4DGfubY4trZl8eMbf1W6Zwq1MVpRjtKJvKyMmCNFFGm02AYu51uq6q8TQEEg6hiVtTFKpcWLCQMizc1kuYul2HHshWEkdj5PpMNZ/gTmBsZJRBPofefa/q4DHJf/gF9KqsWpDWUn9AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 03 09 14 09 15"\n        title=""\n        src="/static/2021-03-09-14-09-15-60cb597a6066e1975b294c6418a458c3-fee1c.png"\n        srcset="/static/2021-03-09-14-09-15-60cb597a6066e1975b294c6418a458c3-a67b7.png 200w,\n/static/2021-03-09-14-09-15-60cb597a6066e1975b294c6418a458c3-0b187.png 400w,\n/static/2021-03-09-14-09-15-60cb597a6066e1975b294c6418a458c3-fee1c.png 800w,\n/static/2021-03-09-14-09-15-60cb597a6066e1975b294c6418a458c3-fa1ac.png 1118w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>关于该 backlog 的定义参见 <a href="https://linux.die.net/man/2/listen" target="_blank" rel="nofollow noreferrer noopener">man</a> 手册:</p>\n<blockquote>\n<p>The behavior of the backlog argument on TCP sockets changed with Linux 2.2. Now it specifies the queue length for completely established sockets waiting to be accepted, instead of the number of incomplete connection requests.</p>\n</blockquote>\n<p>backlog 用于设置客户端与服务端 <code class="language-text">ESTABLISHED</code> 之后等待 accept 的队列长图 (如上图中的 accept queue). 如果 backlog 过小, 在并发连接大的情况下容易导致 accept queue 装满之后断开连接. 但是如果将这个队列设置的特别大, 那么假定连接数并发量是 65525, 以 php-fpm 的 qps 5000 为例, 处理完约耗时 13s, 而这段时间中连接可能早已被 nginx 或者客户端断开, 那么我们去 accept 这个 socket 时只会拿到一个 broken pipe (该例子出处见 <a href="https://github.com/php/php-src/commit/ebf4ffc9354f316f19c839a114b26a564033708a" target="_blank" rel="nofollow noreferrer noopener">PHP 源码 Set FPM<em>BACKLOG</em>DEFAULT to 511</a>). 经过<del>我也不懂的</del>计算 backlog 的长度默认是 511.</p>\n<p>另外提一句, 这个 backlog 是通过系统指定时是通过 <code class="language-text">somaxconn</code> 参数来指定 accept queue 的. 而 <code class="language-text">tcp_max_syn_backlog</code> 参数指定的是 SYN queue 的长度.</p>\n<h3 id="状态机"><a href="#%E7%8A%B6%E6%80%81%E6%9C%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态机</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-03-09-14-57-03-7c9a9ff3d6d7d3453331853d36c6e589-b1c4a.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 562px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 142.52669039145906%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAIAAAAl5NuSAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAFUUlEQVQ4y22V2XfTRhTG/f+/FQ49ByiUBhpaoJSkJCEhdhIv8SLL2ldr32Xt3iTZkqbjwKEvnXOPzn2Y38x37zeaaYH/G/v9vqkblmVkWfY8L4rCOI6+RfgwoihyXbcFp9Z7UO++R1U2oAGWac+w2ZeLi5ubW46jdd1I03UYJlm2rWtQVQ2k8jxvNQ1YWiCSm0SFAZN6bQKV8tEJ0u91BoPeFEFpJpTlRlFqHI9EsVAUkGWgKLbf4UwDobRXiYTqa6OvLHoj0vema7txUilKYxhA0xrbBjSdyHKpqmC5BGWZt6DI1KgX85K814i+YtKZhAY6mXpiAerDDnCqph1C4HN06lNUKis/YAA0KqEusvZr9ssrijiLdTKAylOtaaoDDEVCUtfB3a3YbrNXV7Q4r1ZLKPsBtriMvfXGZ/zghKE6pkZ6qQZitfm28w+YJOLb2zmK+rD+7zvDmtcuUPAFOZCYsa4Qi6UKEvnQBVjRQTaEVbhEY5qAYVJJKpUfsiG8coCKh2hHQK8FFY+TCAReYxtFss2dpBCNnREA02tcC8xQT1UKuMp/NRtUhvwTfH5PfTrBu7TbMzR+ve4IfEcQ2izbVzV5v+vbiyvS/fXj/elX6abrZ2nzHZ5PFn8/Zo6PZr+dTF/00T/HA3qZTRd+RxT6ukYuUzpLzjT1HaO8usKOTtmTMyNN9mVZHODE2DMjlRjM8cHcELIkbNIYRAHYVE24afQAOCngpHQ4lAb3Ur837/WUJKkPMKw5s4DPl9Beqm/Y9NoiVyaRLaDPh4bVNLVi6RVDrwZ9/fwc63VlglzBRj40rG5Ss4YHM9Uqj89dbmtxK5fN8RulyveGmgy6lijmHLeGBxMmht5A5w4wPJ5Qti1kIhKwI0dCI3EawFwR4nfXJ4iOnGPtk2F3rpTILMSIeDL1EdQfjt0orna7orVNA0/TdW6usrzKCq6qlUHGmfjPk5+e9B89GT46Qp+FlrW0Y0vQZHou4PycEBealdhWa3Ookl4aJPwmGr6y6NxlDWbATL9u8jh2FGV4Z47unfFI7/fXLJOSxIqm4DfC8BbI9IcwqkipQskXkcHlXyreS1QKVlTFyRInreFIvx8uZhh1eZULwuEX0/R8Pm81MeyVWviiS15Kw7f85K1AvFkYX7cev9mkeeDuFKE2tca0wn4ff/mCPDqifzuSPn1cC2wLwEZn+j6UfaYtTz9gvSOZe+/77TDEFgvU99FFiO4yCWhGNL7XLz4RH475T+/MzvmaZ1pQauEJucubzMjmxjY3cUyE5zqS1LXtCTy7AOhgowFVX/NcRJIOgrjoNKXpXBBbpS8s5lOHn5jMMNWJpcnUpRxGWJrSljWuKhXyDYQ1I6NpvtOBQVxe2pMJNP0AFw4jo+05cp07zD6Yg9ooSrEoGJI8c5z7zZauVjLcOee5Hcvhp6fBBCl5fivwrViaKN3fZ2dP8fNfpO6bVJsC4IVhX1VeT6dPMeyZaX9IHQwYtn97o/9xjL98Tr18YZ58XPJ0a+swNtUWx59h2EwbmgyvlvWaXPh3knRumdd+0C0SaI+5QEZq5wt3caq0vzjDu43It8DainWKHFzyyO3aE8HSBJW6XDFhBGtGoohOMqZMJSg7wLGIpIzR2JpMAgxLKRr6rEC3Mp1MNAJ6dri7G3Oz5pIAnU1PLHOQJLNdaYJ91VQ1aJpys1lFUb5aqbBh33zOfcHhx7FKRPA2c7Hp3VtjfDy6fEyOn1vaW92YptnKcR3H8wzDcD0vzTL46DzAD3F4MmKliQ93X6qhNtt2ddSzMd/Finx5eJUeRlVVdfUtrf8Fagz5wneskBMAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 03 09 14 57 03"\n        title=""\n        src="/static/2021-03-09-14-57-03-7c9a9ff3d6d7d3453331853d36c6e589-b1c4a.png"\n        srcset="/static/2021-03-09-14-57-03-7c9a9ff3d6d7d3453331853d36c6e589-3ced9.png 200w,\n/static/2021-03-09-14-57-03-7c9a9ff3d6d7d3453331853d36c6e589-4c4f5.png 400w,\n/static/2021-03-09-14-57-03-7c9a9ff3d6d7d3453331853d36c6e589-b1c4a.png 562w"\n        sizes="(max-width: 562px) 100vw, 562px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>关于网络连接的建立以及断开, 存在着一个复杂的状态转换机制, 完整的状态表参见 [《The TCP/IP Guide》](<a href="http://www.tcpipguide.com/free/t_TCPOperationalOverviewandtheTCPFiniteStateMachineF-2.htm" target="_blank" rel="nofollow noreferrer noopener">http://www.tcpipguide.com/free/t_TCPOperationalOverviewandtheTCPFiniteStateMachineF-2.htm</a></p>\n<table>\n<thead>\n<tr>\n<th>state</th>\n<th>简述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CLOSED</td>\n<td>连接关闭, 所有连接的初始状态</td>\n</tr>\n<tr>\n<td>LISTEN</td>\n<td>监听状态, 等待客户端发送 SYN</td>\n</tr>\n<tr>\n<td>SYN-SENT</td>\n<td>客户端发送了 SYN, 等待服务端回复</td>\n</tr>\n<tr>\n<td>SYN-RECEIVED</td>\n<td>双方都收到了 SYN, 等待 ACK</td>\n</tr>\n<tr>\n<td>ESTABLISHED</td>\n<td>SYN-RECEIVED 收到 ACK 之后, 状态切换为连接已建立.</td>\n</tr>\n<tr>\n<td>CLOSE-WAIT</td>\n<td>被动方收到了关闭请求(FIN)后, 发送 ACK, 如果有数据要发送, 则发送数据, 无数据发送则回复 FIN. 状态切换到 LAST-ACK</td>\n</tr>\n<tr>\n<td>LAST-ACK</td>\n<td>等待对方 ACK 当前设备的 CLOSE-WAIT 时发送的 FIN, 等到则切换 CLOSED</td>\n</tr>\n<tr>\n<td>FIN-WAIT-1</td>\n<td>主动方发送 FIN, 等待 ACK</td>\n</tr>\n<tr>\n<td>FIN-WAIT-2</td>\n<td>主动方收到被动方的 ACK, 等待 FIN</td>\n</tr>\n<tr>\n<td>CLOSING</td>\n<td>主动方收到了 FIN, 却没收到 FIN-WAIT-1 时发的 ACK, 此时等待那个 ACK</td>\n</tr>\n<tr>\n<td>TIME-WAIT</td>\n<td>主动方收到 FIN, 返回收到对方 FIN 的 ACK, 等待对方是否真的收到了 ACK, 如果过一会又来一个 FIN, 表示对方没收到, 这时要再 ACK 一次</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p><code class="language-text">TIME_WAIT</code> 是什么情况? 出现过多的 <code class="language-text">TIME_WAIT</code> 可能是什么原因?</p>\n</blockquote>\n<p><code class="language-text">TIME_WAIT</code> 是连接的某一方 (可能是服务端也可能是客户端) 主动断开连接时, 四次挥手等待被断开的一方是否收到最后一次挥手 (ACK) 的状态. 如果在等待时间中, 再次收到第三次挥手 (FIN) 表示对方没收到最后一次挥手, 这时要再 ACK 一次. 这个等待的作用是避免出现连接混用的情况 (<code class="language-text">prevent potential overlap with new connections</code> see <a href="http://www.tcpipguide.com/free/t_TCPConnectionTermination.htm" target="_blank" rel="nofollow noreferrer noopener">TCP Connection Termination</a> for more).</p>\n<p>出现大量的 <code class="language-text">TIME_WAIT</code> 比较常见的情况是, 并发量大, 服务器在短时间断开了大量连接. 对应 HTTP server 的情况可能是没开启 <code class="language-text">keepAlive</code>. 如果有开 <code class="language-text">keepAlive</code>, 一般是等待客户端自己主动断开, 那么<code class="language-text">TIME_WAIT</code> 就只存在客户端, 而服务端则是 <code class="language-text">CLOSE_WAIT</code> 的状态, 如果服务端出现大量 <code class="language-text">CLOSE_WAIT</code>, 意味着当前服务端建立的连接大面积的被断开, 可能是目标服务集群重启之类.</p>\n<h2 id="udp"><a href="#udp" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UDP</h2>\n<blockquote>\n<p>TCP/UDP 的区别? UDP 有粘包吗?</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>协议</th>\n<th>连接性</th>\n<th>双工性</th>\n<th>可靠性</th>\n<th>有序性</th>\n<th>有界性</th>\n<th>拥塞控制</th>\n<th>传输速度</th>\n<th>量级</th>\n<th>头部大小</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>TCP</td>\n<td>面向连接\n<br>\n(Connection oriented)</td>\n<td>全双工(1:1)</td>\n<td>可靠\n<br>\n(重传机制)</td>\n<td>有序\n<br>\n(通过 SYN 排序)</td>\n<td>无, 有\n<a href="#%E7%B2%98%E5%8C%85">粘包情况</a></td>\n<td>有</td>\n<td>慢</td>\n<td>低</td>\n<td>20~60 字节</td>\n</tr>\n<tr>\n<td>UDP</td>\n<td>无连接\n<br>\n(Connection less)</td>\n<td>n:m</td>\n<td>不可靠\n<br>\n(丢包后数据丢失)</td>\n<td>无序</td>\n<td>有消息边界, \n<strong>无粘包</strong></td>\n<td>无</td>\n<td>快</td>\n<td>高</td>\n<td>8 字节</td>\n</tr>\n</tbody>\n</table>\n<p>UDP socket 支持 n 对 m 的连接状态, 在<a href="https://nodejs.org/dist/latest-v6.x/docs/api/dgram.html" target="_blank" rel="nofollow noreferrer noopener">官方文档</a>中有写到在 <code class="language-text">dgram.createSocket(options[, callback])</code> 中的 option 可以指定 <code class="language-text">reuseAddr</code> 即 <code class="language-text">SO_REUSEADDR</code> 标志. 通过 <code class="language-text">SO_REUSEADDR</code> 可以简单的实现 n 对 m 的多播特性 (不过仅在支持多播的系统上才有).</p>\n<h3 id="常见的应用场景"><a href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常见的应用场景</h3>\n<table>\n  <tr><th>传输层协议</th><th>应用</th><th>应用层协议</th></tr>\n  <tr><td rowspan="5">TCP</td><td>电子邮件</td><td>SMTP</td></tr>\n  <tr><td>终端连接</td><td>TELNET</td></tr>\n  <tr><td>终端连接</td><td>SSH</td></tr>\n  <tr><td>万维网</td><td>HTTP</td></tr>\n  <tr><td>文件传输</td><td>FTP</td></tr>\n  <tr><td rowspan="8">UDP</td><td>域名解析</td><td>DNS</td></tr>\n  <tr><td>简单文件传输</td><td>TFTP</td></tr>\n  <tr><td>网络时间校对</td><td>NTP</td></tr>\n  <tr><td>网络文件系统</td><td>NFS</td></tr>\n  <tr><td>路由选择</td><td>RIP</td></tr>\n  <tr><td>IP电话</td><td>-</td></tr>\n  <tr><td>流式多媒体通信</td><td>-</td></tr>\n</table>\n<p>简单的说, UDP 速度快, 开销低, 不用封包/拆包允许丢一部分数据, 监控统计/日志数据上报/流媒体通信等场景都可以用 UDP. 目前 Node.js 的项目中使用 UDP 比较流行的是 <a href="https://github.com/etsy/statsd" target="_blank" rel="nofollow noreferrer noopener">StatsD</a> 监控服务.</p>\n<h2 id="http"><a href="#http" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HTTP</h2>\n<p>目前世界上运行最良好的分布式集群, 莫过于当前的万维网 (http servers) 了. 目前前端工程师也都是靠 HTTP 协议吃饭的, 所以 2-3 年的前端同学都应该对 HTTP 有比较深的理解了, 所以这里不做太多的赘述. 推荐书籍<a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00JTQK1L4/" target="_blank" rel="nofollow noreferrer noopener">《图解 HTTP》</a>, 博客<a href="http://www.ruanyifeng.com/blog/2016/08/http.html" target="_blank" rel="nofollow noreferrer noopener">HTTP 协议入门</a>.</p>\n<p>另外最近几年开始大家对 HTTP 的面试的考察也渐渐偏向<a href="http://www.ruanyifeng.com/blog/2011/09/restful.html" target="_blank" rel="nofollow noreferrer noopener">理解 RESTful 架构</a>. 简单的说, RESTful 是把每个 URI 当做资源 (Resources), 通过 method 作为动词来对资源做不同的动作, 然后服务器返回 status 来得知资源状态的变化 (State Transfer);</p>\n<h3 id="methodstatus"><a href="#methodstatus" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>method/status</h3>\n<p>因为 HTTP 的方法 (method) 与状态码 (status) 讲解太常见, 你可以使用如下代码打印出来自己看 Node.js 官方定义的, 完整的就不列举了.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79521644916659720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const http = require(\'http\');\n\nconsole.log(http.METHODS);\nconsole.log(http.STATUS_CODES);`, `79521644916659720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'http\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token constant">METHODS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token constant">STATUS_CODES</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一个常见的 method 列表, 关于这些 method 在 RESTful 中的一些应用的详细可以参见<a href="http://www.restapitutorial.com/lessons/httpmethods.html" target="_blank" rel="nofollow noreferrer noopener">Using HTTP Methods for RESTful Services</a></p>\n<table>\n<thead>\n<tr>\n<th>methods</th>\n<th>CRUD</th>\n<th>幂等</th>\n<th>缓存</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GET</td>\n<td>Read</td>\n<td>✓</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>POST</td>\n<td>Create</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>PUT</td>\n<td>Update/Replace</td>\n<td>✓</td>\n<td></td>\n</tr>\n<tr>\n<td>PATCH</td>\n<td>Update/Modify</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>DELETE</td>\n<td>Delete</td>\n<td>✓</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>GET 和 POST 有什么区别?</p>\n</blockquote>\n<p>网上有很多讲这个的, 比如从书签, url 等前端的角度去看他们的区别这里不赘述. 而从后端的角度看, 前两年出来一个 《GET 和 POST 没有区别》(出处不好考究, 就没贴了) 的文章比较有名, 早在我刚学 PHP 的时候也有过这种疑惑, 刚学 Node 的时候发现不能像 PHP 那样同时处理 GET 和 POST 的时候还很不适应. 后来接触 RESTful 才意识到, 这两个东西最根本的差别是语义, 引申了看, 协议 (protocol) 这种东西就是人与人之间协商的约定, 什么行为是什么作用都是”约定”好的, 而不是强制使用的, 非要把 GET 当 POST 这样不遵守约定的做法我们也爱莫能助.</p>\n<p>跑题了, 简而言之, 讨论这二者的区别最好从 RESTful 提倡的语义角度来讲<del>比较符合当代程序员的逼格</del>比较合理.</p>\n<blockquote>\n<p>POST 和 PUT 有什么区别?</p>\n</blockquote>\n<p>POST 是新建 (create) 资源, 非幂等, 同一个请求如果重复 POST 会新建多个资源. PUT 是 Update/Replace, 幂等, 同一个 PUT 请求重复操作会得到同样的结果.</p>\n<h3 id="headers"><a href="#headers" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>headers</h3>\n<p>HTTP headers 是在进行 HTTP 请求的交互过程中互相支会对方一些信息的主要字段. 比如请求 (Request) 的时候告诉服务端自己能接受的各项参数, 以及之前就存在本地的一些数据等. 详细各位可以参见 wikipedia:</p>\n<ul>\n<li><a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields#Request_fields" target="_blank" rel="nofollow noreferrer noopener">Request fields</a></li>\n<li><a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields#Response_fields" target="_blank" rel="nofollow noreferrer noopener">Response fields</a></li>\n</ul>\n<blockquote>\n<p>cookie 与 session 的区别? 服务端如何清除 cookie?</p>\n</blockquote>\n<p>主要区别在于, session 存在服务端, cookie 存在客户端. session 比 cookie 更安全. 而且 cookie 不一定一直能用 (可能被浏览器关掉). 服务端可以通过设置 cookie 的值为空并设置一个及时的 expires 来清除存在客户端上的 cookie.</p>\n<blockquote>\n<p>什么是跨域请求? 如何允许跨域?</p>\n</blockquote>\n<p>出于安全考虑, 默认情况下使用 XMLHttpRequest 和 Fetch 发起 HTTP 请求必须遵守同源策略, 即只能向相同 host 请求 (host = hostname : port) 注[1]. 向不同 host 的请求被称作跨域请求 (cross-origin HTTP request). 可以通过设置 <a href="https://developer.mozilla.org/en-US/docs/Glossary/CORS" target="_blank" rel="nofollow noreferrer noopener">CORS headers</a> 即 <code class="language-text">Access-Control-Allow-</code> 系列来允许跨域. 例如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44943869331133880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`location ~* ^/(?:v1|_) {\n  if (\\$request_method = OPTIONS) { return 200 \'\'; }\n  header_filter_by_lua \'\n    ngx.header[&quot;Access-Control-Allow-Origin&quot;] = ngx.var.http_origin; # 这样相当于允许所有来源了\n    ngx.header[&quot;Access-Control-Allow-Methods&quot;] = &quot;GET, POST, PUT, DELETE, PATCH, OPTIONS&quot;;\n    ngx.header[&quot;Access-Control-Allow-Credentials&quot;] = &quot;true&quot;;\n    ngx.header[&quot;Access-Control-Allow-Headers&quot;] = &quot;Content-Type&quot;;\n  \';\n  proxy_pass http://localhost:3001;\n}`, `44943869331133880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">location ~* ^/(?:v1|_) {\n  if ($request_method = OPTIONS) { return 200 &#39;&#39;; }\n  header_filter_by_lua &#39;\n    ngx.header[&quot;Access-Control-Allow-Origin&quot;] = ngx.var.http_origin; # 这样相当于允许所有来源了\n    ngx.header[&quot;Access-Control-Allow-Methods&quot;] = &quot;GET, POST, PUT, DELETE, PATCH, OPTIONS&quot;;\n    ngx.header[&quot;Access-Control-Allow-Credentials&quot;] = &quot;true&quot;;\n    ngx.header[&quot;Access-Control-Allow-Headers&quot;] = &quot;Content-Type&quot;;\n  &#39;;\n  proxy_pass http://localhost:3001;\n}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注[1]：同源除了相同 host 也包括相同协议. 所以即使 host 相同, 从 HTTP 到 HTTPS 也属于跨域, 见<a href="https://github.com/ElemeFE/node-interview/issues/55" target="_blank" rel="nofollow noreferrer noopener">讨论</a>.</p>\n<blockquote>\n<p><code class="language-text">Script error.</code> 是什么错误? 如何拿到更详细的信息?</p>\n</blockquote>\n<p>接上题, 由于同源性策略 (CORS), 如果你引用的 js 脚本所在的域与当前域不同, 那么浏览器会把 onError 中的 msg 替换为 <code class="language-text">Script error.</code> 要拿到详细错误的方法, 处理配好 <code class="language-text">Access-Control-Allow-Origin</code> 还有在引用脚本的时候指定 <code class="language-text">crossorigin</code> 例如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34001963796030534000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script src=&quot;http://another-domain.com/app.js&quot; crossorigin=&quot;anonymous&quot;></script>`, `34001963796030534000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                html 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://another-domain.com/app.js<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>详见 <a href="https://sentry.io/answers/javascript-script-error/" target="_blank" rel="nofollow noreferrer noopener">JavaScript Script Error.</a></p>\n<h3 id="agent"><a href="#agent" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Agent</h3>\n<p>Node.js 中的 <code class="language-text">http.Agent</code> 用于池化 HTTP 客户端请求的 socket (pooling sockets used in HTTP client requests). 也就是复用 HTTP 请求时候的 socket. 如果你没有指定 Agent 的话, 默认用的是 <code class="language-text">http.globalAgent</code>.</p>\n<p>另外, 目前在 Node.js 的 6.8.1（包括）到 6.10（不包括）版本中发现一个问题:</p>\n<ul>\n<li>\n<ol>\n<li>你将 keepAlive 设置为 <code class="language-text">true</code> 时, socket 有复用</li>\n</ol>\n</li>\n<li>\n<ol start="2">\n<li>即使 keepAlive 没有设置成 <code class="language-text">true</code> 但是长时间内有大量请求时, 同样有复用 socket (复用情况参见<a href="https://github.com/zcs19871221" target="_blank" rel="nofollow noreferrer noopener">@zcs19871221</a>的<a href="https://github.com/zcs19871221/mydoc/blob/master/nodejsAgent.md" target="_blank" rel="nofollow noreferrer noopener">解析</a>)</li>\n</ol>\n</li>\n</ul>\n<p>1 和 2 这两种情况下, 一旦设置了 request timeout, 由于 socket 一直未销毁, 如果你在请求完成以后没有注意清除该事件, 会导致事件重复监听, 且该事件闭包引用了 req, 会导致内存泄漏.</p>\n<p>如果有疑虑的话可以参见 Node 官方讨论的 <a href="https://github.com/nodejs/node/issues/9268" target="_blank" rel="nofollow noreferrer noopener">issue</a> 以及引入此 bug 的 <a href="https://github.com/nodejs/node/blob/ee7af01b93cc46f1848f6962ad2d6c93f319341a/lib/_http_client.js#L565" target="_blank" rel="nofollow noreferrer noopener">commit</a>, 如果此处描述有疑问可以在本 repo 的 <a href="https://github.com/ElemeFE/node-interview/issues/19" target="_blank" rel="nofollow noreferrer noopener">issue</a> 中指出.</p>\n<h3 id="socket-hang-up"><a href="#socket-hang-up" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>socket hang up</h3>\n<p>hang up 有挂断的意思, socket hang up 也可以理解为 socket 被挂断. 在 Node.js 中当你要 response 一个请求的时候, 发现该这个 socket 已经被 “挂断”, 就会就会报 socket hang up 错误.</p>\n<p><a href="https://github.com/nodejs/node/blob/v6.x/lib/_http_client.js#L286" target="_blank" rel="nofollow noreferrer noopener">Node.js 中源码的情况:</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43805581841405280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function socketCloseListener() {\n  var socket = this;\n  var req = socket._httpMessage;\n\n  // Pull through final chunk, if anything is buffered.\n  // the ondata function will handle it properly, and this\n  // is a no-op if no final chunk remains.\n  socket.read();\n\n  // NOTE: It\'s important to get parser here, because it could be freed by\n  // the \\`socketOnData\\`.\n  var parser = socket.parser;\n  req.emit(\'close\');\n  if (req.res && req.res.readable) {\n    // Socket closed before we emitted \'end\' below.\n    req.res.emit(\'aborted\');\n    var res = req.res;\n    res.on(\'end\', function() {\n      res.emit(\'close\');\n    });\n    res.push(null);\n  } else if (!req.res && !req.socket._hadError) {\n    // This socket error fired before we started to\n    // receive a response. The error needs to\n    // fire on the request.\n    req.emit(\'error\', createHangUpError()); // <------------------- socket hang up\n    req.socket._hadError = true;\n  }\n\n  // Too bad.  That output wasn\'t getting written.\n  // This is pretty terrible that it doesn\'t raise an error.\n  // Fixed better in v0.10\n  if (req.output) req.output.length = 0;\n  if (req.outputEncodings) req.outputEncodings.length = 0;\n\n  if (parser) {\n    parser.finish();\n    freeParser(parser, req, socket);\n  }\n}`, `43805581841405280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">socketCloseListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> req <span class="token operator">=</span> socket<span class="token punctuation">.</span>_httpMessage<span class="token punctuation">;</span>\n\n  <span class="token comment">// Pull through final chunk, if anything is buffered.</span>\n  <span class="token comment">// the ondata function will handle it properly, and this</span>\n  <span class="token comment">// is a no-op if no final chunk remains.</span>\n  socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// NOTE: It\'s important to get parser here, because it could be freed by</span>\n  <span class="token comment">// the `socketOnData`.</span>\n  <span class="token keyword">var</span> parser <span class="token operator">=</span> socket<span class="token punctuation">.</span>parser<span class="token punctuation">;</span>\n  req<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'close\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>res <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>res<span class="token punctuation">.</span>readable<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// Socket closed before we emitted \'end\' below.</span>\n    req<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'aborted\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> res <span class="token operator">=</span> req<span class="token punctuation">.</span>res<span class="token punctuation">;</span>\n    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'end\'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      res<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'close\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>res <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>_hadError<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// This socket error fired before we started to</span>\n    <span class="token comment">// receive a response. The error needs to</span>\n    <span class="token comment">// fire on the request.</span>\n    req<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">\'error\'</span><span class="token punctuation">,</span> <span class="token function">createHangUpError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;------------------- socket hang up</span>\n    req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>_hadError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Too bad.  That output wasn\'t getting written.</span>\n  <span class="token comment">// This is pretty terrible that it doesn\'t raise an error.</span>\n  <span class="token comment">// Fixed better in v0.10</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>output<span class="token punctuation">)</span> req<span class="token punctuation">.</span>output<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>outputEncodings<span class="token punctuation">)</span> req<span class="token punctuation">.</span>outputEncodings<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    parser<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">freeParser</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> req<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>典型的情况是用户使用浏览器, 请求的时间有点长, 然后用户简单的按了一下 F5 刷新页面. 这个操作会让浏览器取消之前的请求, 然后导致服务端 throw 了一个 socket hang up.</p>\n<p>详见万能的 stackoverflow: <a href="http://stackoverflow.com/questions/16995184/nodejs-what-does-socket-hang-up-actually-mean" target="_blank" rel="nofollow noreferrer noopener">NodeJS - What does “socket hang up” actually mean?</a></p>\n<h2 id="dns"><a href="#dns" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DNS</h2>\n<p>早期可以用 TCP/IP 通信之后, 有一个比较蛋疼的问题, 就是 ip 都是一串比较长的数字, 比较难记, 于是大家想了个办法, 给每个 ip 取个好记一点的名字比如 <code class="language-text">Alan -&gt; 192.168.0.11</code> 这样只需要记住好记的名字即可, 随着这个名字的规范化最终变成了今天的域名 (Domain name), 而帮助别人记录这个名字的服务就叫域名解析服务 (Domain Name Service).</p>\n<p>DNS 服务主要基于 UDP, 这里简单介绍 Node.js 实现的接口中的两个方法:</p>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>功能</th>\n<th>同步</th>\n<th>网络请求</th>\n<th>速度</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>.lookup(hostname\n[\n, options\n]\n, cb)</td>\n<td>通过系统自带的 DNS 缓存 (如 \n<code class="language-text">/etc/hosts</code>\n)</td>\n<td>同步</td>\n<td>无</td>\n<td>快</td>\n</tr>\n<tr>\n<td>.resolve(hostname\n[\n, rrtype\n]\n, cb)</td>\n<td>通过系统配置的 DNS 服务器指定的记录 (rrtype 指定)</td>\n<td>异步</td>\n<td>有</td>\n<td>慢</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>DNS 模块中 .lookup 与 .resolve 的区别?</p>\n</blockquote>\n<p>当你要解析一个域名的 ip 时, 通过 .lookup 查询直接调用 <code class="language-text">getaddrinfo</code> 来拿取地址, 速度很快, 但是如果本地的 hosts 文件被修改了, .lookup 就会拿 hosts 文件中的地方, 而 .resolve 依旧是外部正常的地址.</p>\n<p>由于 .lookup 是同步的, 所以如果由于什么不可控的原因导致 <code class="language-text">getaddrinfo</code> 缓慢或者阻塞是会影响整个 Node 进程的, 参见<a href="https://nodejs.org/dist/latest-v6.x/docs/api/dns.html#dns_dns_lookup" target="_blank" rel="nofollow noreferrer noopener">文档</a>.</p>\n<blockquote>\n<p>hosts 文件是什么? 什么叫 DNS 本地解析?</p>\n</blockquote>\n<p>hosts 文件是个没有扩展名的系统文件, 其作用就是将网址域名与其对应的 IP 地址建立一个关联“数据库”, 当用户在浏览器中输入一个需要登录的网址时, 系统会首先自动从 hosts 文件中寻找对应的 IP 地址.</p>\n<p>当我们访问一个域名时, 实际上需要的是访问对应的 IP 地址. 这时候, 获取 IP 地址的方式, 先是读取浏览器缓存, 如果未命中 => 接着读取本地 hosts 文件, 如果还是未命中 => 则向 DNS 服务器发送请求获取. 在向 DNS 服务器获取 IP 地址之前的行为, 叫做 DNS 本地解析.</p>\n<h2 id="zlib"><a href="#zlib" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ZLIB</h2>\n<p>在网络传输过程中, 如果网速稳定的情况下, 对数据进行压缩, 压缩比率越大, 那么传输的效率就越高等同于速度越快了. zlib 模块提供了 Gzip/Gunzip, Deflate/Inflate 和 DeflateRaw/InflateRaw 等压缩方法的类, 这些类接收相同的参数, 都属于可读写的 Stream 实例.</p>\n<h2 id="rpc"><a href="#rpc" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RPC</h2>\n<p>RPC (Remote Procedure Call Protocol) 基于 TCP/IP 来实现调用远程服务器的方法, 与 http 同属应用层. 常用于构建集群, 以及微服务 (推荐一本<a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B01MXY8ARP" target="_blank" rel="nofollow noreferrer noopener">《Node.js 微服务》</a><del>虽然我还没看完</del>)</p>\n<p>常见的 RPC 方式:</p>\n<ul>\n<li><a href="http://thrift.apache.org/" target="_blank" rel="nofollow noreferrer noopener">Thrift</a></li>\n<li>HTTP</li>\n<li>MQ</li>\n</ul>\n<h3 id="thrift"><a href="#thrift" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Thrift</h3>\n<blockquote>\n<p><strong>Thrift</strong>是一种<a href="https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3%E6%8F%8F%E8%BF%B0%E8%AF%AD%E8%A8%80" title="接口描述语言" target="_blank" rel="nofollow noreferrer noopener">接口描述语言</a>和二进制通讯协议，它被用来定义和创建跨语言的服务。它被当作一个<a href="https://zh.wikipedia.org/wiki/%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8" title="远程过程调用" target="_blank" rel="nofollow noreferrer noopener">远程过程调用</a>（RPC）框架来使用，是由<a href="https://zh.wikipedia.org/wiki/Facebook" title="Facebook" target="_blank" rel="nofollow noreferrer noopener">Facebook</a>为“大规模跨语言服务开发”而开发的。它通过一个代码生成引擎联合了一个软件栈，来创建不同程度的、无缝的<a href="https://zh.wikipedia.org/wiki/%E8%B7%A8%E5%B9%B3%E5%8F%B0" title="跨平台" target="_blank" rel="nofollow noreferrer noopener">跨平台</a>高效服务，可以使用<a href="https://zh.wikipedia.org/wiki/C%E2%99%AF" title="C♯" target="_blank" rel="nofollow noreferrer noopener">C#</a>、<a href="https://zh.wikipedia.org/wiki/C%2B%2B" title="C++" target="_blank" rel="nofollow noreferrer noopener">C++</a>（基于<a href="https://zh.wikipedia.org/wiki/POSIX" title="POSIX" target="_blank" rel="nofollow noreferrer noopener">POSIX</a>兼容系统）、Cappuccino、<a href="https://zh.wikipedia.org/wiki/Cocoa" title="Cocoa" target="_blank" rel="nofollow noreferrer noopener">Cocoa</a>、<a href="https://zh.wikipedia.org/wiki/Delphi" title="Delphi" target="_blank" rel="nofollow noreferrer noopener">Delphi</a>、<a href="https://zh.wikipedia.org/wiki/Erlang" title="Erlang" target="_blank" rel="nofollow noreferrer noopener">Erlang</a>、<a href="https://zh.wikipedia.org/wiki/Go" title="Go" target="_blank" rel="nofollow noreferrer noopener">Go</a>、<a href="https://zh.wikipedia.org/wiki/Haskell" title="Haskell" target="_blank" rel="nofollow noreferrer noopener">Haskell</a>、<a href="https://zh.wikipedia.org/wiki/Java" title="Java" target="_blank" rel="nofollow noreferrer noopener">Java</a>、<a href="https://zh.wikipedia.org/wiki/Node.js" title="Node.js" target="_blank" rel="nofollow noreferrer noopener">Node.js</a>、<a href="https://zh.wikipedia.org/wiki/OCaml" title="OCaml" target="_blank" rel="nofollow noreferrer noopener">OCaml</a>、<a href="https://zh.wikipedia.org/wiki/Perl" title="Perl" target="_blank" rel="nofollow noreferrer noopener">Perl</a>、<a href="https://zh.wikipedia.org/wiki/PHP" title="PHP" target="_blank" rel="nofollow noreferrer noopener">PHP</a>、<a href="https://zh.wikipedia.org/wiki/Python" title="Python" target="_blank" rel="nofollow noreferrer noopener">Python</a>、<a href="https://zh.wikipedia.org/wiki/Ruby" title="Ruby" target="_blank" rel="nofollow noreferrer noopener">Ruby</a>和<a href="https://zh.wikipedia.org/wiki/Smalltalk" title="Smalltalk" target="_blank" rel="nofollow noreferrer noopener">Smalltalk</a>。虽然它以前是由 Facebook 开发的，但它现在是<a href="https://zh.wikipedia.org/wiki/Apache%E8%BD%AF%E4%BB%B6%E5%9F%BA%E9%87%91%E4%BC%9A" title="Apache软件基金会" target="_blank" rel="nofollow noreferrer noopener">Apache 软件基金会</a>的<a href="https://zh.wikipedia.org/wiki/%E5%BC%80%E6%BA%90" title="开源" target="_blank" rel="nofollow noreferrer noopener">开源</a>项目了。该实现被描述在 2007 年 4 月的一篇由 Facebook 发表的技术论文中，该论文现由 Apache 掌管。</p>\n</blockquote>\n<h3 id="http-1"><a href="#http-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HTTP</h3>\n<p>使用 HTTP 协议来进行 RPC 调用也是很常见的, 相比 TCP 连接, 通过 HTTP 的方式性能会差一些, 但是在使用以及调试上会简单一些. 近期比较有名的框架参见 <a href="http://www.grpc.io/" target="_blank" rel="nofollow noreferrer noopener">gRPC</a>:</p>\n<blockquote>\n<p>gRPC is an open source remote procedure call (RPC) system initially developed at Google. It uses HTTP/2 for transport, Protocol Buffers as the interface description language, and provides features such as authentication, bidirectional streaming and flow control, blocking or nonblocking bindings, and cancellation and timeouts. It generates cross-platform client and server bindings for many languages.</p>\n</blockquote>\n<h3 id="mq"><a href="#mq" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MQ</h3>\n<p>使用消息队列 (Message Queue) 来进行 RPC 调用 (RPC over mq) 在业内有不少例子, 比较适合业务解耦/广播/限流等场景.</p>\n<h1 id="os"><a href="#os" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OS</h1>\n<h2 id="tty"><a href="#tty" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TTY</h2>\n<p>“tty” 原意是指 “teletype” 即打字机, “pty” 则是 “pseudo-teletype” 即伪打字机. 在 Unix 中, <code class="language-text">/dev/tty*</code> 是指任何表现的像打字机的设备, 例如终端 (terminal).</p>\n<p>你可以通过 <code class="language-text">w</code> 命令查看当前登录的用户情况, 你会发现每登录了一个窗口就会有一个新的 tty.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52676945271967980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ w\n 11:49:43 up 482 days, 19:38,  3 users,  load average: 0.03, 0.08, 0.07\nUSER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT\ndev      pts/0    10.0.128.252     10:44    1:01m  0.09s  0.07s -bash\ndev      pts/2    10.0.128.252     11:08    2:07   0.17s  0.14s top\nroot     pts/3    10.0.240.2       11:43    7.00s  0.04s  0.00s w`, `52676945271967980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                shell 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">$ w\n <span class="token number">11</span>:49:43 up <span class="token number">482</span> days, <span class="token number">19</span>:38,  <span class="token number">3</span> users,  load average: <span class="token number">0.03</span>, <span class="token number">0.08</span>, <span class="token number">0.07</span>\n<span class="token environment constant">USER</span>     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT\ndev      pts/0    <span class="token number">10.0</span>.128.252     <span class="token number">10</span>:44    <span class="token number">1</span>:01m  <span class="token number">0</span>.09s  <span class="token number">0</span>.07s -bash\ndev      pts/2    <span class="token number">10.0</span>.128.252     <span class="token number">11</span>:08    <span class="token number">2</span>:07   <span class="token number">0</span>.17s  <span class="token number">0</span>.14s <span class="token function">top</span>\nroot     pts/3    <span class="token number">10.0</span>.240.2       <span class="token number">11</span>:43    <span class="token number">7</span>.00s  <span class="token number">0</span>.04s  <span class="token number">0</span>.00s w</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 ps 命令查看进程信息中也有 tty 的信息:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74599555433485040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ps -x\n  PID TTY      STAT   TIME COMMAND\n 5530 ?        S      0:00 sshd: dev@pts/3\n 5531 pts/3    Ss+    0:00 -bash\n11296 ?        S      0:00 sshd: dev@pts/4\n11297 pts/4    Ss     0:00 -bash\n13318 pts/4    R+     0:00 ps -x\n23733 ?        Ssl    2:53 PM2 v1.1.2: God Daemon`, `74599555433485040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                shell 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">$ <span class="token function">ps</span> -x\n  PID TTY      STAT   TIME COMMAND\n <span class="token number">5530</span> ?        S      <span class="token number">0</span>:00 sshd: dev@pts/3\n <span class="token number">5531</span> pts/3    Ss+    <span class="token number">0</span>:00 -bash\n<span class="token number">11296</span> ?        S      <span class="token number">0</span>:00 sshd: dev@pts/4\n<span class="token number">11297</span> pts/4    Ss     <span class="token number">0</span>:00 -bash\n<span class="token number">13318</span> pts/4    R+     <span class="token number">0</span>:00 <span class="token function">ps</span> -x\n<span class="token number">23733</span> ?        Ssl    <span class="token number">2</span>:53 PM2 v1.1.2: God Daemon</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中为 <code class="language-text">?</code> 的是没有依赖 TTY 的进程, 即<a href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B">守护进程</a>.</p>\n<p>在 Node.js 中你可以通过 stdio 的 isTTY 来判断当前进程是否处于 TTY (如终端) 的环境.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36980167780338704000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ node -p -e &quot;Boolean(process.stdout.isTTY)&quot;\ntrue\n\\$ node -p -e &quot;Boolean(process.stdout.isTTY)&quot; | cat\nfalse`, `36980167780338704000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                shell 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">$ node -p -e <span class="token string">"Boolean(process.stdout.isTTY)"</span>\n<span class="token boolean">true</span>\n$ node -p -e <span class="token string">"Boolean(process.stdout.isTTY)"</span> <span class="token operator">|</span> <span class="token function">cat</span>\n<span class="token boolean">false</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="os-1"><a href="#os-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OS</h2>\n<p>通过 OS 模块可以获取到当前系统一些基础信息的辅助函数.</p>\n<table>\n<thead>\n<tr>\n<th>属性</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>os.EOL</td>\n<td>根据当前系统, 返回当前系统的 \n<code class="language-text">End Of Line</code></td>\n</tr>\n<tr>\n<td>os.arch()</td>\n<td>返回当前系统的 CPU 架构, 如 \n<code class="language-text">&#39;x86&#39;</code>\n 和 \n<code class="language-text">&#39;x64&#39;</code></td>\n</tr>\n<tr>\n<td>os.constants</td>\n<td>返回系统常量</td>\n</tr>\n<tr>\n<td>os.cpus()</td>\n<td>返回 CPU 每个核的信息</td>\n</tr>\n<tr>\n<td>os.endianness()</td>\n<td>返回 CPU 字节序, 如果是大端字节序返回 \n<code class="language-text">BE</code>\n, 小端字节序则 \n<code class="language-text">LE</code></td>\n</tr>\n<tr>\n<td>os.freemem()</td>\n<td>返回系统空闲内存的大小, 单位是字节</td>\n</tr>\n<tr>\n<td>os.homedir()</td>\n<td>返回当前用户的根目录</td>\n</tr>\n<tr>\n<td>os.hostname()</td>\n<td>返回当前系统的主机名</td>\n</tr>\n<tr>\n<td>os.loadavg()</td>\n<td>返回负载信息</td>\n</tr>\n<tr>\n<td>os.networkInterfaces()</td>\n<td>返回网卡信息 (类似 \n<code class="language-text">ifconfig</code>\n)</td>\n</tr>\n<tr>\n<td>os.platform()</td>\n<td>返回编译时指定的平台信息, 如 \n<code class="language-text">win32</code>\n, \n<code class="language-text">linux</code>\n, 同 \n<code class="language-text">process.platform()</code></td>\n</tr>\n<tr>\n<td>os.release()</td>\n<td>返回操作系统的分发版本号</td>\n</tr>\n<tr>\n<td>os.tmpdir()</td>\n<td>返回系统默认的临时文件夹</td>\n</tr>\n<tr>\n<td>os.totalmem()</td>\n<td>返回总内存大小(同内存条大小)</td>\n</tr>\n<tr>\n<td>os.type()</td>\n<td>根据 \n<code class="language-text">[uname](https://en.wikipedia.org/wiki/Uname#Examples)</code>\n 返回系统的名称</td>\n</tr>\n<tr>\n<td>os.uptime()</td>\n<td>返回系统的运行时间，单位是秒</td>\n</tr>\n<tr>\n<td>os.userInfo(\n[\noptions\n]\n)</td>\n<td>返回当前用户信息</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>不同操作系统的换行符 (EOL) 有什么区别?</p>\n</blockquote>\n<p>end of line (EOL) 同 newline, line ending, 以及 line break.</p>\n<p>通常由 line feed (LF, <code class="language-text">\\n</code>) 和 carriage return (CR, <code class="language-text">\\r</code>) 组成. 常见的情况:</p>\n<table>\n<thead>\n<tr>\n<th>符号</th>\n<th>系统</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>LF</td>\n<td>在 Unix 或 Unix 相容系统 (GNU/Linux, AIX, Xenix, Mac OS X, …)、BeOS、Amiga、RISC OS</td>\n</tr>\n<tr>\n<td>CR+LF</td>\n<td>MS-DOS、微软视窗操作系统 (Microsoft Windows)、大部分非 Unix 的系统</td>\n</tr>\n<tr>\n<td>CR</td>\n<td>Apple II 家族, Mac OS 至版本 9</td>\n</tr>\n</tbody>\n</table>\n<p>如果不了解 EOL 跨系统的兼容情况, 那么在处理文件的行分割/行统计等情况时可能会被坑.</p>\n<h3 id="os-常量"><a href="#os-%E5%B8%B8%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OS 常量</h3>\n<ul>\n<li>信号常量 (Signal Constants), 如 <code class="language-text">SIGHUP</code>, <code class="language-text">SIGKILL</code> 等.</li>\n<li>POSIX 错误常量 (POSIX Error Constants), 如 <code class="language-text">EACCES</code>, <code class="language-text">EADDRINUSE</code> 等.</li>\n<li>Windows 错误常量 (Windows Specific Error Constants), 如 <code class="language-text">WSAEACCES</code>, <code class="language-text">WSAEBADF</code> 等.</li>\n<li>libuv 常量 (libuv Constants), 仅 <code class="language-text">UV_UDP_REUSEADDR</code>.</li>\n</ul>\n<h2 id="path"><a href="#path" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Path</h2>\n<p>Node.js 内置的 path 是用于处理路径问题的模块. 不过众所周知, 路径在不同操作系统下有不可调和的差异.</p>\n<h3 id="windows-vs-posix"><a href="#windows-vs-posix" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Windows vs. POSIX</h3>\n<table>\n<thead>\n<tr>\n<th>POSIX</th>\n<th>值</th>\n<th>Windows</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path.posix.sep</td>\n<td><code class="language-text">&#39;/&#39;</code></td>\n<td>path.win32.sep</td>\n<td><code class="language-text">&#39;\\\\&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.normalize(‘/foo/bar//baz/asdf/quux/..‘)</td>\n<td><code class="language-text">&#39;/foo/bar/baz/asdf&#39;</code></td>\n<td>path.win32.normalize(‘C:\n\\\ntemp\n\\\n\\\nfoo\n\\\nbar\n\\\n..\n\\\n‘)</td>\n<td><code class="language-text">&#39;C:\\\\temp\\\\foo\\\\&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.basename(‘/tmp/myfile.html’)</td>\n<td><code class="language-text">&#39;myfile.html&#39;</code></td>\n<td>path.win32.basename(‘C:\n\\\ntemp\n\\\nmyfile.html’)</td>\n<td><code class="language-text">&#39;myfile.html&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.join(‘/asdf’, ‘/test.html’)</td>\n<td><code class="language-text">&#39;/asdf/test.html&#39;</code></td>\n<td>path.win32.join(‘/asdf’, ‘/test.html’)</td>\n<td><code class="language-text">&#39;\\\\asdf\\\\test.html&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.relative(‘/root/a’, ‘/root/b’)</td>\n<td><code class="language-text">&#39;../b&#39;</code></td>\n<td>path.win32.relative(‘C:\n\\\na’, ‘c:\n\\\nb’)</td>\n<td><code class="language-text">&#39;..\\\\b&#39;</code></td>\n</tr>\n<tr>\n<td>path.posix.isAbsolute(‘/baz/..‘)</td>\n<td><code class="language-text">true</code></td>\n<td>path.win32.isAbsolute(‘C:\n\\\nfoo\n\\\n..‘)</td>\n<td><code class="language-text">true</code></td>\n</tr>\n<tr>\n<td>path.posix.delimiter</td>\n<td><code class="language-text">&#39;:&#39;</code></td>\n<td>path.win32.delimiter</td>\n<td><code class="language-text">&#39;,&#39;</code></td>\n</tr>\n<tr>\n<td>process.env.PATH</td>\n<td><code class="language-text">&#39;/usr/bin:/bin&#39;</code></td>\n<td>process.env.PATH</td>\n<td><code class="language-text">C:\\Windows\\system32;C:\\Program Files\\node\\&#39;</code></td>\n</tr>\n<tr>\n<td>PATH.split(path.posix.delimiter)</td>\n<td><code class="language-text">[&#39;/usr/bin&#39;, &#39;/bin&#39;]</code></td>\n<td>PATH.split(path.win32.delimiter)</td>\n<td><code class="language-text">[&#39;C:\\\\Windows\\\\system32&#39;, &#39;C:\\\\Program Files\\\\node\\\\&#39;]</code></td>\n</tr>\n</tbody>\n</table>\n<p>看了上表之后, 你应该了解到当你处于某个平台之下的时候, 所使用的 <code class="language-text">path</code> 模块的方法其实就是对应的平台的方法, 例如笔者这里用的是 mac, 所以:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11755078936320330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const path = require(\'path\');\nconsole.log(path.basename === path.posix.basename); // true`, `11755078936320330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>basename <span class="token operator">===</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>basename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你处于其中某一个平台, 但是要处理另外一个平台的路径, 需要注意这个跨平台的问题.</p>\n<h3 id="path-对象"><a href="#path-%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>path 对象</h3>\n<p>on POSIX:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36331577530701263000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`path.parse(\'/home/user/dir/file.txt\');\n// Returns:\n// {\n//    root : &quot;/&quot;,\n//    dir : &quot;/home/user/dir&quot;,\n//    base : &quot;file.txt&quot;,\n//    ext : &quot;.txt&quot;,\n//    name : &quot;file&quot;\n// }`, `36331577530701263000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">\'/home/user/dir/file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// Returns:</span>\n<span class="token comment">// {</span>\n<span class="token comment">//    root : "/",</span>\n<span class="token comment">//    dir : "/home/user/dir",</span>\n<span class="token comment">//    base : "file.txt",</span>\n<span class="token comment">//    ext : ".txt",</span>\n<span class="token comment">//    name : "file"</span>\n<span class="token comment">// }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17909372607757000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`┌─────────────────────┬────────────┐\n│          dir        │    base    │\n├──────┬              ├──────┬─────┤\n│ root │              │ name │ ext │\n&quot;  /    home/user/dir / file  .txt &quot;\n└──────┴──────────────┴──────┴─────┘`, `17909372607757000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">┌─────────────────────┬────────────┐\n│          dir        │    base    │\n├──────┬              ├──────┬─────┤\n│ root │              │ name │ ext │\n<span class="token string">"  /    home/user/dir / file  .txt "</span>\n└──────┴──────────────┴──────┴─────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>on Windows:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52153859094573170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`path.parse(\'C:\\\\path\\\\dir\\\\file.txt\');\n// Returns:\n// {\n//    root : &quot;C:\\\\&quot;,\n//    dir : &quot;C:\\\\path\\\\dir&quot;,\n//    base : &quot;file.txt&quot;,\n//    ext : &quot;.txt&quot;,\n//    name : &quot;file&quot;\n// }`, `52153859094573170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">\'C:\\\\path\\\\dir\\\\file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// Returns:</span>\n<span class="token comment">// {</span>\n<span class="token comment">//    root : "C:\\\\",</span>\n<span class="token comment">//    dir : "C:\\\\path\\\\dir",</span>\n<span class="token comment">//    base : "file.txt",</span>\n<span class="token comment">//    ext : ".txt",</span>\n<span class="token comment">//    name : "file"</span>\n<span class="token comment">// }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86122876811346540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`┌─────────────────────┬────────────┐\n│          dir        │    base    │\n├──────┬              ├──────┬─────┤\n│ root │              │ name │ ext │\n&quot; C:\\      path\\dir   \\ file  .txt &quot;\n└──────┴──────────────┴──────┴─────┘`, `86122876811346540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">┌─────────────────────┬────────────┐\n│          dir        │    base    │\n├──────┬              ├──────┬─────┤\n│ root │              │ name │ ext │\n<span class="token string">" C:\\      path\\dir   \\ file  .txt "</span>\n└──────┴──────────────┴──────┴─────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="pathextnamepath"><a href="#pathextnamepath" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>path.extname(path)</h3>\n<table>\n<thead>\n<tr>\n<th>case</th>\n<th>return</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>path.extname(‘index.html’)</td>\n<td><code class="language-text">&#39;.html&#39;</code></td>\n</tr>\n<tr>\n<td>path.extname(‘index.coffee.md’)</td>\n<td><code class="language-text">&#39;.md&#39;</code></td>\n</tr>\n<tr>\n<td>path.extname(‘index.‘)</td>\n<td><code class="language-text">&#39;.&#39;</code></td>\n</tr>\n<tr>\n<td>path.extname(‘index’)</td>\n<td><code class="language-text">&#39;&#39;</code></td>\n</tr>\n<tr>\n<td>path.extname(‘.index’)</td>\n<td><code class="language-text">&#39;&#39;</code></td>\n</tr>\n</tbody>\n</table>\n<h2 id="命令行参数"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命令行参数</h2>\n<p>命令行参数 (Command Line Options), 即对 CLI 使用上的一些文档. 关于 CLI 主要有 4 种使用方式:</p>\n<ul>\n<li>node <a href="">options</a> <a href="">script.js | -e “script”</a></li>\n<li>node debug [script.js | -e “script” | <code class="language-text">&lt;host&gt;:&lt;port&gt;</code>] …</li>\n<li>node —v8-options</li>\n<li>无参数直接启动 REPL 环境</li>\n</ul>\n<h3 id="options"><a href="#options" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Options</h3>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>简介</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-v, —version</td>\n<td>查看当前 node 版本</td>\n</tr>\n<tr>\n<td>-h, —help</td>\n<td>查看帮助文档</td>\n</tr>\n<tr>\n<td>-e, —eval “script”</td>\n<td>将参数字符串当做代码执行</td>\n</tr>\n<tr>\n<td>-p, —print “script”</td>\n<td>打印 \n<code class="language-text">-e</code>\n 的返回值</td>\n</tr>\n<tr>\n<td>-c, —check</td>\n<td>检查语法并不执行</td>\n</tr>\n<tr>\n<td>-i, —interactive</td>\n<td>即使 stdin 不是终端也打开 REPL 模式</td>\n</tr>\n<tr>\n<td>-r, —require module</td>\n<td>在启动前预先 \n<code class="language-text">require</code>\n 指定模块</td>\n</tr>\n<tr>\n<td>—no-deprecation</td>\n<td>关闭废弃模块警告</td>\n</tr>\n<tr>\n<td>—trace-deprecation</td>\n<td>打印废弃模块的堆栈跟踪信息</td>\n</tr>\n<tr>\n<td>—throw-deprecation</td>\n<td>执行废弃模块时抛出错误</td>\n</tr>\n<tr>\n<td>—no-warnings</td>\n<td>无视报警（包括废弃警告）</td>\n</tr>\n<tr>\n<td>—trace-warnings</td>\n<td>打印警告的 stack （包括废弃模块）</td>\n</tr>\n<tr>\n<td>—trace-sync-io</td>\n<td>只要检测到异步 I/O 出于 Event loop 的开头就打印 stack trace</td>\n</tr>\n<tr>\n<td>—zero-fill-buffers</td>\n<td>自动初始化(zero-fill) \n<strong>Buffer</strong>\n 和 \n<strong>SlowBuffer</strong></td>\n</tr>\n<tr>\n<td>—preserve-symlinks</td>\n<td>在解析和缓存模块时指示模块加载程序保存符号链接</td>\n</tr>\n<tr>\n<td>—track-heap-objects</td>\n<td>为堆快照跟踪堆对象的分配情况</td>\n</tr>\n<tr>\n<td>—prof-process</td>\n<td>使用 v8 选项 \n<code class="language-text">--prof</code>\n 生成 Profilling 报告</td>\n</tr>\n<tr>\n<td>—v8-options</td>\n<td>显示 v8 命令行选项</td>\n</tr>\n<tr>\n<td>—tls-cipher-list=list</td>\n<td>指明替代的默认 TLS 加密器列表</td>\n</tr>\n<tr>\n<td>—enable-fips</td>\n<td>在启动时开启 FIPS-compliant crypto</td>\n</tr>\n<tr>\n<td>—force-fips</td>\n<td>在启动时强制实施 FIPS-compliant</td>\n</tr>\n<tr>\n<td>—openssl-config=file</td>\n<td>启动时加载 OpenSSL 配置文件</td>\n</tr>\n<tr>\n<td>—icu-data-dir=file</td>\n<td>指定 ICU 数据加载路径</td>\n</tr>\n</tbody>\n</table>\n<h3 id="环境变量"><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境变量</h3>\n<table>\n<thead>\n<tr>\n<th>环境变量</th>\n<th>简介</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class="language-text">NODE_DEBUG=module[,…]</code></td>\n<td>指定要打印调试信息的核心模块列表</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_PATH=path[:…]</code></td>\n<td>指定搜索目录模块路径的前缀列表</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_DISABLE_COLORS=1</code></td>\n<td>关闭 REPL 的颜色显示</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_ICU_DATA=file</code></td>\n<td>ICU (Intl object) 数据路径</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_REPL_HISTORY=file</code></td>\n<td>持久化存储 REPL 历史文件的路径</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_TTY_UNSAFE_ASYNC=1</code></td>\n<td>设置为 1 时, 将同步操作 stdio (如 console.log 变成同步)</td>\n</tr>\n<tr>\n<td><code class="language-text">NODE_EXTRA_CA_CERTS=file</code></td>\n<td>指定 CA (如 VeriSign) 的额外证书路径</td>\n</tr>\n</tbody>\n</table>\n<h2 id="负载"><a href="#%E8%B4%9F%E8%BD%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>负载</h2>\n<p>负载是衡量服务器运行状态的一个重要概念. 通过负载情况, 我们可以知道服务器目前状态是空闲、良好、繁忙还是即将 crash.</p>\n<p>通常我们要查看的负载是 CPU 负载, 详细一点的情况你可以通过阅读这篇博客: <a href="http://blog.scoutapp.com/articles/2009/07/31/understanding-load-averages" target="_blank" rel="nofollow noreferrer noopener">Understanding Linux CPU Load</a> 来了解.</p>\n<p>命令行上可以通过 <code class="language-text">uptime</code>, <code class="language-text">top</code> 命令, Node.js 中可以通过 <code class="language-text">os.loadavg()</code> 来获取当前系统的负载情况:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22488914442094400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`load average: 0.09, 0.05, 0.01`, `22488914442094400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">load average: 0.09, 0.05, 0.01</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>其中分别是最近 1 分钟, 5 分钟, 15 分钟内系统 CPU 的平均负载. 当 CPU 的一个核工作饱和的时候负载为 1, 有几核 CPU 那么饱和负载就是几.</p>\n<p>在 Node.js 中单个进程的 CPU 负载查看可以使用 <a href="https://github.com/soyuka/pidusage" target="_blank" rel="nofollow noreferrer noopener">pidusage</a> 模块.</p>\n<p>除了 CPU 负载, 对于服务端 (偏维护) 还需要了解网络负载, 磁盘负载等.</p>\n<h2 id="checklist"><a href="#checklist" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CheckList</h2>\n<blockquote>\n<p>有一个醉汉半夜在路灯下徘徊，路过的人奇怪地问他：“你在路灯下找什么？”醉汉回答：“我在找我的 KEY”,路人更奇怪了：“找钥匙为什么在路灯下?”，醉汉说：“因为这里最亮！”。</p>\n</blockquote>\n<p>很多服务端的同学在说到检查服务器状态时只知道使用 <code class="language-text">top</code> 命令, 其实情况就和上面的笑话一样, 因为对于他们而言 <code class="language-text">top</code> 是最亮的那盏路灯.</p>\n<p>对于服务端程序员而言, 完整的服务器 checklist 首推 <a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B0140I5WPK" target="_blank" rel="nofollow noreferrer noopener">《性能之巅》</a> 第二章中讲述的 <a href="http://www.brendangregg.com/USEmethod/use-linux.html" target="_blank" rel="nofollow noreferrer noopener">USE 方法</a>.</p>\n<p>The USE Method provides a strategy for performing a complete check of system health, identifying common bottlenecks and errors. For each system resource, metrics for utilization, saturation and errors are identified and checked. Any issues discovered are then investigated using further strategies.</p>\n<p>This is an example USE-based metric list for Linux operating systems (eg, Ubuntu, CentOS, Fedora). This is primarily intended for system administrators of the physical systems, who are using command line tools. Some of these metrics can be found in remote monitoring tools.</p>\n<h3 id="physical-resources"><a href="#physical-resources" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Physical Resources</h3>\n<table border="1" cellpadding="2" width="100%">\n<tbody><tr><th>component</th><th>type</th><th>metric</th></tr>\n<tr><td>CPU</td><td>utilization</td><td>system-wide: <tt>vmstat 1</tt>, "us" + "sy" + "st"; <tt>sar -u</tt>, sum fields except "%idle" and "%iowait"; <tt>dstat -c</tt>, sum fields except "idl" and "wai"; per-cpu: <tt>mpstat -P ALL 1</tt>, sum fields except "%idle" and "%iowait"; <tt>sar -P ALL</tt>, same as <tt>mpstat</tt>; per-process: <tt>top</tt>, "%CPU"; <tt>htop</tt>, "CPU%"; <tt>ps -o pcpu</tt>; <tt>pidstat 1</tt>, "%CPU"; per-kernel-thread: <tt>top</tt>/<tt>htop</tt> ("K" to toggle), where VIRT == 0 (heuristic). [1]</td></tr>\n<tr><td>CPU</td><td>saturation</td><td>system-wide: <tt>vmstat 1</tt>, "r" &gt; CPU count [2]; <tt>sar -q</tt>, "runq-sz" &gt; CPU count; <tt>dstat -p</tt>, "run" &gt; CPU count; per-process: /proc/PID/schedstat 2nd field (sched_info.run_delay); <tt>perf sched latency</tt> (shows "Average" and "Maximum" delay per-schedule); dynamic tracing, eg, SystemTap schedtimes.stp "queued(us)" [3]</td></tr>\n<tr><td>CPU</td><td>errors</td><td><tt>perf</tt> (LPE) if processor specific error events (CPC) are available; eg, AMD64\'s "04Ah Single-bit ECC Errors Recorded by Scrubber" [4]</td></tr>\n<tr><td>Memory capacity</td><td>utilization</td><td>system-wide: <tt>free -m</tt>, "Mem:" (main memory), "Swap:" (virtual memory); <tt>vmstat 1</tt>, "free" (main memory), "swap" (virtual memory); <tt>sar -r</tt>, "%memused"; <tt>dstat -m</tt>, "free"; <tt>slabtop -s c</tt> for kmem slab usage; per-process: <tt>top</tt>/<tt>htop</tt>, "RES" (resident main memory), "VIRT" (virtual memory), "Mem" for system-wide summary</td></tr>\n<tr><td>Memory capacity</td><td>saturation</td><td>system-wide: <tt>vmstat 1</tt>, "si"/"so" (swapping); <tt>sar -B</tt>, "pgscank" + "pgscand" (scanning); <tt>sar -W</tt>; per-process: 10th field (min_flt) from /proc/PID/stat for minor-fault rate, or dynamic tracing [5]; OOM killer: <tt>dmesg | grep killed</tt></td></tr>\n<tr><td>Memory capacity</td><td>errors</td><td><tt>dmesg</tt> for physical failures; dynamic tracing, eg, SystemTap uprobes for failed malloc()s</td></tr>\n<tr><td>Network Interfaces</td><td>utilization</td><td><tt>sar -n DEV 1</tt>, "rxKB/s"/max "txKB/s"/max; <tt>ip -s link</tt>, RX/TX tput / max bandwidth; /proc/net/dev, "bytes" RX/TX tput/max; nicstat "%Util" [6]</td></tr>\n<tr><td>Network Interfaces</td><td>saturation</td><td><tt>ifconfig</tt>, "overruns", "dropped"; <tt>netstat -s</tt>, "segments retransmited"; <tt>sar -n EDEV</tt>, *drop and *fifo metrics; /proc/net/dev, RX/TX "drop"; nicstat "Sat" [6]; dynamic tracing for other TCP/IP stack queueing [7]</td></tr>\n<tr><td>Network Interfaces</td><td>errors</td><td><tt>ifconfig</tt>, "errors", "dropped"; <tt>netstat -i</tt>, "RX-ERR"/"TX-ERR"; <tt>ip -s link</tt>, "errors"; <tt>sar -n EDEV</tt>, "rxerr/s" "txerr/s"; /proc/net/dev, "errs", "drop"; extra counters may be under /sys/class/net/...; dynamic tracing of driver function returns 76]</td></tr>\n<tr><td>Storage device I/O</td><td>utilization</td><td>system-wide: <tt>iostat -xz 1</tt>, "%util"; <tt>sar -d</tt>, "%util"; per-process: iotop; <tt>pidstat -d</tt>; /proc/PID/sched "se.statistics.iowait_sum"</td></tr>\n<tr><td>Storage device I/O</td><td>saturation</td><td><tt>iostat -xnz 1</tt>, "avgqu-sz" &gt; 1, or high "await"; <tt>sar -d</tt> same; LPE block probes for queue length/latency; dynamic/static tracing of I/O subsystem (incl. LPE block probes)</td></tr>\n<tr><td>Storage device I/O</td><td>errors</td><td>/sys/devices/.../ioerr_cnt; <tt>smartctl</tt>; dynamic/static tracing of I/O subsystem response codes [8]</td></tr>\n<tr><td>Storage capacity</td><td>utilization</td><td>swap: <tt>swapon -s</tt>; <tt>free</tt>; /proc/meminfo "SwapFree"/"SwapTotal"; file systems: "df -h"</td></tr>\n<tr><td>Storage capacity</td><td>saturation</td><td>not sure this one makes sense - once it\'s full, ENOSPC</td></tr>\n<tr><td>Storage capacity</td><td>errors</td><td><tt>strace</tt> for ENOSPC; dynamic tracing for ENOSPC; /var/log/messages errs, depending on FS</td></tr>\n<tr><td>Storage controller</td><td>utilization</td><td><tt>iostat -xz 1</tt>, sum devices and compare to known IOPS/tput limits per-card</td></tr>\n<tr><td>Storage controller</td><td>saturation</td><td>see storage device saturation, ...</td></tr>\n<tr><td>Storage controller</td><td>errors</td><td>see storage device errors, ...</td></tr>\n<tr><td>Network controller</td><td>utilization</td><td>infer from <tt>ip -s link</tt> (or /proc/net/dev) and known controller max tput for its interfaces</td></tr>\n<tr><td>Network controller</td><td>saturation</td><td>see network interface saturation, ...</td></tr>\n<tr><td>Network controller</td><td>errors</td><td>see network interface errors, ...</td></tr>\n<tr><td>CPU interconnect</td><td>utilization</td><td>LPE (CPC) for CPU interconnect ports, tput / max</td></tr>\n<tr><td>CPU interconnect</td><td>saturation</td><td>LPE (CPC) for stall cycles</td></tr>\n<tr><td>CPU interconnect</td><td>errors</td><td>LPE (CPC) for whatever is available</td></tr>\n<tr><td>Memory interconnect</td><td>utilization</td><td>LPE (CPC) for memory busses, tput / max; or CPI greater than, say, 5; CPC may also have local vs remote counters</td></tr>\n<tr><td>Memory interconnect</td><td>saturation</td><td>LPE (CPC) for stall cycles</td></tr>\n<tr><td>Memory interconnect</td><td>errors</td><td>LPE (CPC) for whatever is available</td></tr>\n<tr><td>I/O interconnect</td><td>utilization</td><td>LPE (CPC) for tput / max if available; inference via known tput from iostat/ip/...</td></tr>\n<tr><td>I/O interconnect</td><td>saturation</td><td>LPE (CPC) for stall cycles</td></tr>\n<tr><td>I/O interconnect</td><td>errors</td><td>LPE (CPC) for whatever is available </td></tr>\n</tbody></table>\n<h3 id="software-resources"><a href="#software-resources" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Software Resources</h3>\n<table border="1" width="100%">\n<tbody><tr><th>component</th><th>type</th><th>metric</th></tr>\n<!--SW-START-->\n<tr><td>Kernel mutex</td><td>utilization</td><td>With CONFIG_LOCK_STATS=y, /proc/lock_stat "holdtime-totat" / "acquisitions" (also see "holdtime-min", "holdtime-max") [8]; dynamic tracing of lock functions or instructions (maybe)</td></tr>\n<tr><td>Kernel mutex</td><td>saturation</td><td>With CONFIG_LOCK_STATS=y, /proc/lock_stat "waittime-total" / "contentions" (also see "waittime-min", "waittime-max"); dynamic tracing of lock functions or instructions (maybe); spinning shows up with profiling (<tt>perf record -a -g -F 997 ...</tt>, <tt>oprofile</tt>, dynamic tracing)</td></tr>\n<tr><td>Kernel mutex</td><td>errors</td><td>dynamic tracing (eg, recusive mutex enter); other errors can cause kernel lockup/panic, debug with kdump/<tt>crash</tt></td></tr>\n<tr><td>User mutex</td><td>utilization</td><td><tt>valgrind --tool=drd --exclusive-threshold=...</tt> (held time); dynamic tracing of lock to unlock function time</td></tr>\n<tr><td>User mutex</td><td>saturation</td><td><tt>valgrind --tool=drd</tt> to infer contention from held time; dynamic tracing of synchronization functions for wait time; profiling (oprofile, PEL, ...) user stacks for spins</td></tr>\n<tr><td>User mutex</td><td>errors</td><td><tt>valgrind --tool=drd</tt> various errors; dynamic tracing of pthread_mutex_lock() for EAGAIN, EINVAL, EPERM, EDEADLK, ENOMEM, EOWNERDEAD, ...</td></tr>\n<tr><td>Task capacity</td><td>utilization</td><td><tt>top</tt>/<tt>htop</tt>, "Tasks" (current); <tt>sysctl kernel.threads-max</tt>, /proc/sys/kernel/threads-max (max)</td></tr>\n<tr><td>Task capacity</td><td>saturation</td><td>threads blocking on memory allocation; at this point the page scanner should be running (sar -B "pgscan*"), else examine using dynamic tracing</td></tr>\n<tr><td>Task capacity</td><td>errors</td><td>"can\'t fork()" errors; user-level threads: pthread_create() failures with EAGAIN, EINVAL, ...; kernel: dynamic tracing of kernel_thread() ENOMEM</td></tr>\n<tr><td>File descriptors</td><td>utilization</td><td>system-wide: <tt>sar -v</tt>, "file-nr" vs /proc/sys/fs/file-max; <tt>dstat --fs</tt>, "files"; or just /proc/sys/fs/file-nr; per-process: <tt>ls /proc/PID/fd | wc -l</tt> vs <tt>ulimit -n</tt></td></tr>\n<tr><td>File descriptors</td><td>saturation</td><td>does this make sense?  I don\'t think there is any queueing or blocking, other than on memory allocation.</td></tr>\n<tr><td>File descriptors</td><td>errors</td><td><tt>strace</tt> errno == EMFILE on syscalls returning fds (eg, open(), accept(), ...).</td></tr>\n</tbody></table>\n<h4 id="ulimit"><a href="#ulimit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ulimit</h4>\n<p>ulimit 用于管理用户对系统资源的访问.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94605715037357590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`-a   显示目前全部限制情况\n-c   设定 core 文件的最大值, 单位为区块\n-d   <数据节区大小> 程序数据节区的最大值, 单位为KB\n-f   <文件大小> shell 所能建立的最大文件, 单位为区块\n-H   设定资源的硬性限制, 也就是管理员所设下的限制\n-m   <内存大小> 指定可使用内存的上限, 单位为 KB\n-n   <文件描述符数目> 指定同一时间最多可开启的 fd 数\n-p   <缓冲区大小> 指定管道缓冲区的大小, 单位512字节\n-s   <堆叠大小> 指定堆叠的上限, 单位为 KB\n-S   设定资源的弹性限制\n-t   指定CPU使用时间的上限, 单位为秒\n-u   <进程数目> 用户最多可开启的进程数目\n-v   <虚拟内存大小> 指定可使用的虚拟内存上限, 单位为 KB`, `94605715037357590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">-a   显示目前全部限制情况\n-c   设定 core 文件的最大值, 单位为区块\n-d   &lt;数据节区大小&gt; 程序数据节区的最大值, 单位为KB\n-f   &lt;文件大小&gt; shell 所能建立的最大文件, 单位为区块\n-H   设定资源的硬性限制, 也就是管理员所设下的限制\n-m   &lt;内存大小&gt; 指定可使用内存的上限, 单位为 KB\n-n   &lt;文件描述符数目&gt; 指定同一时间最多可开启的 fd 数\n-p   &lt;缓冲区大小&gt; 指定管道缓冲区的大小, 单位512字节\n-s   &lt;堆叠大小&gt; 指定堆叠的上限, 单位为 KB\n-S   设定资源的弹性限制\n-t   指定CPU使用时间的上限, 单位为秒\n-u   &lt;进程数目&gt; 用户最多可开启的进程数目\n-v   &lt;虚拟内存大小&gt; 指定可使用的虚拟内存上限, 单位为 KB</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>例如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3696695403830507500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ ulimit -a\ncore file size          (blocks, -c) 0\ndata seg size           (kbytes, -d) unlimited\nscheduling priority             (-e) 0\nfile size               (blocks, -f) unlimited\npending signals                 (-i) 127988\nmax locked memory       (kbytes, -l) 64\nmax memory size         (kbytes, -m) unlimited\nopen files                      (-n) 655360\npipe size            (512 bytes, -p) 8\nPOSIX message queues     (bytes, -q) 819200\nreal-time priority              (-r) 0\nstack size              (kbytes, -s) 8192\ncpu time               (seconds, -t) unlimited\nmax user processes              (-u) 4096\nvirtual memory          (kbytes, -v) unlimited\nfile locks                      (-x) unlimited`, `3696695403830507500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ ulimit -a\ncore file size          (blocks, -c) 0\ndata seg size           (kbytes, -d) unlimited\nscheduling priority             (-e) 0\nfile size               (blocks, -f) unlimited\npending signals                 (-i) 127988\nmax locked memory       (kbytes, -l) 64\nmax memory size         (kbytes, -m) unlimited\nopen files                      (-n) 655360\npipe size            (512 bytes, -p) 8\nPOSIX message queues     (bytes, -q) 819200\nreal-time priority              (-r) 0\nstack size              (kbytes, -s) 8192\ncpu time               (seconds, -t) unlimited\nmax user processes              (-u) 4096\nvirtual memory          (kbytes, -v) unlimited\nfile locks                      (-x) unlimited</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意, open socket 等资源拿到的也是 fd, 所以 <code class="language-text">ulimit -n</code> 比较小除了文件打不开, 还可能建立不了 socket 链接.</p>\n<h1 id="错误处理调试"><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>错误处理/调试</h1>\n<h2 id="errors"><a href="#errors" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Errors</h2>\n<p>在 Node.js 中的错误主要有以下四种类型：</p>\n<table>\n<thead>\n<tr>\n<th>错误</th>\n<th>名称</th>\n<th>触发</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Standard JavaScript errors</td>\n<td>标准 JavaScript 错误</td>\n<td>由错误代码触发</td>\n</tr>\n<tr>\n<td>System errors</td>\n<td>系统错误</td>\n<td>由操作系统触发</td>\n</tr>\n<tr>\n<td>User-specified errors</td>\n<td>用户自定义错误</td>\n<td>通过 throw 抛出</td>\n</tr>\n<tr>\n<td>Assertion errors</td>\n<td>断言错误</td>\n<td>由 \n<code class="language-text">assert</code>\n 模块触发</td>\n</tr>\n</tbody>\n</table>\n<p>其中标准的 JavaScript 错误常见有：</p>\n<ul>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/EvalError" target="_blank" rel="nofollow noreferrer noopener">EvalError</a>: 调用 eval() 出现错误时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SyntaxError" target="_blank" rel="nofollow noreferrer noopener">SyntaxError</a>: 代码不符合 JavaScript 语法规范时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RangeError" target="_blank" rel="nofollow noreferrer noopener">RangeError</a>: 数组越界时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ReferenceError" target="_blank" rel="nofollow noreferrer noopener">ReferenceError</a>: 引用未定义的变量时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypeError" target="_blank" rel="nofollow noreferrer noopener">TypeError</a>: 参数类型错误时抛出该错误</li>\n<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/URIError" target="_blank" rel="nofollow noreferrer noopener">URIError</a>: 误用全局的 URI 处理函数时抛出该错误</li>\n</ul>\n<p>而常见的系统错误列表可以通过 Node.js 的 os 对象常看列表：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1325907018996463900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const os = require(\'os\');\n\nconsole.log(os.constants.errno);`, `1325907018996463900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'os\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>目前搜索 Node.js 面试题, 发现很多题目已经跟不上 Node.js 的发展了.比较老的 <a href="https://cnodejs.org/topic/55714dfac4e7fbea6e9a2e5d" target="_blank" rel="nofollow noreferrer noopener">NodeJS 错误处理最佳实践</a>, 译自 Joyent 的官方博客, 其中有这样的描述:</p>\n<blockquote>\n<p>实际上, <code class="language-text">try/catch</code> 唯一常用的是在 <code class="language-text">JSON.parse</code> 和类似验证用户输入的地方</p>\n</blockquote>\n<p>然而实际上现在在 Node.js 中你已经可以轻松的使用 try/catch 去捕获异步的异常了. 并且在 Node.js v7.6 之后使用了升级引擎的新版 v8, 旧版中 try/catch 代码不能优化的问题也解决了. 所以我们现在再来看</p>\n<blockquote>\n<p>怎么处理未预料的出错? 用 try/catch , domains 还是其它什么?</p>\n</blockquote>\n<p>在 Node.js 中错误处理主要有一下几种方法:</p>\n<ul>\n<li>callback(err, data) 回调约定</li>\n<li>throw / try / catch</li>\n<li>EventEmitter 的 error 事件</li>\n</ul>\n<p>callback(err, data) 这种形式的错误处理起来繁琐, 并不具备强制性, 目前已经处于仅需要了解, 不推荐使用的情况. 而 domain 模块则是半只脚踏进棺材了.</p>\n<ol>\n<li>\n<p>感谢 <a href="https://github.com/visionmedia/co" target="_blank" rel="nofollow noreferrer noopener">co</a> 的先河, 现在的你已经简单的使用 try/catch 保护关键的位置, 以 koa 为例, 可以通过中间件的形式来进行错误处理, 详见 <a href="https://github.com/koajs/koa/wiki/Error-Handling" target="_blank" rel="nofollow noreferrer noopener">Koa error handling</a>. 之后的 async/await 均属于这种模式.</p>\n</li>\n<li>\n<p>通过 EventEmitter 的错误监听形式为各大关键的对象加上错误监听的回调. 例如监听 http server, tcp server 等对象的 <code class="language-text">error</code> 事件以及 process 对象提供的 <code class="language-text">uncaughtException</code> 和 <code class="language-text">unhandledRejection</code> 等等.</p>\n</li>\n<li>\n<p>使用 Promise 来封装异步, 并通过 Promise 的错误处理来 handle 错误.</p>\n</li>\n<li>\n<p>如果上述办法不能起到良好的作用, 那么你需要学习如何优雅的 <a href="http://wiki.c2.com/?LetItCrash" target="_blank" rel="nofollow noreferrer noopener">Let It Crash</a></p>\n</li>\n</ol>\n<blockquote>\n<p>为什么要在 cb 的第一参数传 error? 为什么有的 cb 第一个参数不是 error, 例如 http.createServer?</p>\n</blockquote>\n<h3 id="错误栈丢失"><a href="#%E9%94%99%E8%AF%AF%E6%A0%88%E4%B8%A2%E5%A4%B1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>错误栈丢失</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74783731655884440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function test() {\n  throw new Error(\'test error\');\n}\n\nfunction main() {\n  test();\n}\n\nmain();`, `74783731655884440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以收获报错:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59298847764723565000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/data/node-interview/error.js:2\n  throw new Error(\'test error\');\n  ^\n\nError: test error\n    at test (/data/node-interview/error.js:2:9)\n    at main (/data/node-interview/error.js:6:3)\n    at Object.<anonymous> (/data/node-interview/error.js:9:1)\n    at Module._compile (module.js:570:32)\n    at Object.Module._extensions..js (module.js:579:10)\n    at Module.load (module.js:487:32)\n    at tryModuleLoad (module.js:446:12)\n    at Function.Module._load (module.js:438:3)\n    at Module.runMain (module.js:604:10)\n    at run (bootstrap_node.js:394:7)`, `59298847764723565000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">2</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token operator">^</span>\n\nError<span class="token punctuation">:</span> test error\n    at <span class="token function">test</span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>\n    at <span class="token function">main</span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">)</span>\n    at Object<span class="token punctuation">.</span><span class="token operator">&lt;</span>anonymous<span class="token operator">></span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">)</span>\n    at Module<span class="token punctuation">.</span><span class="token function">_compile</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">570</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">)</span>\n    at Object<span class="token punctuation">.</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">js</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">579</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>\n    at Module<span class="token punctuation">.</span><span class="token function">load</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">487</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">)</span>\n    at <span class="token function">tryModuleLoad</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">446</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">)</span>\n    at Function<span class="token punctuation">.</span>Module<span class="token punctuation">.</span><span class="token function">_load</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">438</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">)</span>\n    at Module<span class="token punctuation">.</span><span class="token function">runMain</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">604</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>\n    at <span class="token function">run</span> <span class="token punctuation">(</span>bootstrap_node<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">394</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以发现报错的行数, test 函数, main 函数的调用关系都在 stack 中清晰的体现.</p>\n<p>当你使用 setImmediate 等定时器来设置异步的时候:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69363033403420670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function test() {\n  throw new Error(\'test error\');\n}\n\nfunction main() {\n  setImmediate(() => test());\n}\n\nmain();`, `69363033403420670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们发现</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26066702019518173000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/data/node-interview/error.js:2\n  throw new Error(\'test error\');\n  ^\n\nError: test error\n    at test (/data/node-interview/error.js:2:9)\n    at Immediate.setImmediate (/data/node-interview/error.js:6:22)\n    at runCallback (timers.js:637:20)\n    at tryOnImmediate (timers.js:610:5)\n    at processImmediate [as _immediateCallback] (timers.js:582:5)`, `26066702019518173000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">2</span>\n  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token operator">^</span>\n\nError<span class="token punctuation">:</span> test error\n    at <span class="token function">test</span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>\n    at Immediate<span class="token punctuation">.</span><span class="token function">setImmediate</span> <span class="token punctuation">(</span><span class="token operator">/</span>data<span class="token operator">/</span>node<span class="token operator">-</span>interview<span class="token operator">/</span>error<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">22</span><span class="token punctuation">)</span>\n    at <span class="token function">runCallback</span> <span class="token punctuation">(</span>timers<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">637</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">)</span>\n    at <span class="token function">tryOnImmediate</span> <span class="token punctuation">(</span>timers<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">610</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">)</span>\n    at processImmediate <span class="token punctuation">[</span><span class="token keyword">as</span> _immediateCallback<span class="token punctuation">]</span> <span class="token punctuation">(</span>timers<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">582</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>错误栈中仅输出到 test 函数内调用的地方位置, 再往上 main 的调用信息就丢失了. 也就是说如果你的函数调用深度比较深的情况下, 你使用异步调用某个函数出错了的情况下追溯这个异步的调用是一个很困难的事情, 因为其之上的栈都已经丢失了. 如果你用过 <a href="https://github.com/caolan/async" target="_blank" rel="nofollow noreferrer noopener">async</a> 之类的模块, 你还可能发现, 报错的 stack 会非常的长而且曲折, 光看 stack 很难去定位问题.</p>\n<p>这在项目不大/作者清楚的情况下不是问题, 但是当项目大起来, 开发人员多起来之后, 这样追溯错误会变得异常痛苦. 关于这个问题, 在上文中提到 <a href="https://cnodejs.org/topic/55714dfac4e7fbea6e9a2e5d" target="_blank" rel="nofollow noreferrer noopener">错误处理的最佳实践</a> 中, 关于 <code class="language-text">编写新函数的具体建议</code> 那一带的内容有描述到. 通过使用 <a href="https://www.npmjs.com/package/verror" target="_blank" rel="nofollow noreferrer noopener">verror</a> 这样的方式, 让 Error 一层层封装, 并在每一层将错误的信息一层层的包上, 最后拿到的 Error 直接可以从 message 中获取用于定位问题的关键信息.</p>\n<p>以昨天的数据为准（2017-3-13）各位只要对比一下看看 npm 上上个月 <a href="https://www.npmjs.com/package/verror" target="_blank" rel="nofollow noreferrer noopener">verror</a> 的下载量 <code class="language-text">1100w</code> 比 <a href="https://www.npmjs.com/package/express" target="_blank" rel="nofollow noreferrer noopener">express</a> 的 <code class="language-text">1070w</code> 还高. 应该就能感受到这种写法有多流行了.</p>\n<h3 id="防御性编程"><a href="#%E9%98%B2%E5%BE%A1%E6%80%A7%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>防御性编程</h3>\n<p>错误并不可怕, 可怕的是你不去准备应对错误————<a href="http://blog.jobbole.com/101651/" target="_blank" rel="nofollow noreferrer noopener">防御性编程的介绍和技巧</a></p>\n<h3 id="let-it-crash"><a href="#let-it-crash" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>let it crash</h3>\n<p><a href="http://wiki.c2.com/?LetItCrash" target="_blank" rel="nofollow noreferrer noopener">Let It Crash</a></p>\n<h3 id="uncaughtexception"><a href="#uncaughtexception" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>uncaughtException</h3>\n<p>当异常没有被捕获一路冒泡到 Event Loop 时就会触发该事件 process 对象上的 <code class="language-text">uncaughtException</code> 事件. 默认情况下, Node.js 对于此类异常会直接将其堆栈跟踪信息输出给 <code class="language-text">stderr</code> 并结束进程, 而为 <code class="language-text">uncaughtException</code> 事件添加监听可以覆盖该默认行为, 不会直接结束进程.</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61095982518651585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`process.on(\'uncaughtException\', (err) => {\n  console.log(\\`Caught exception: \\${err}\\`);\n});\n\nsetTimeout(() => {\n  console.log(\'This will still run.\');\n}, 500);\n\n// Intentionally cause an exception, but don\'t catch it.\nnonexistentFunc();\nconsole.log(\'This will not run.\');`, `61095982518651585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'uncaughtException\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Caught exception: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'This will still run.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// Intentionally cause an exception, but don\'t catch it.</span>\n<span class="token function">nonexistentFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'This will not run.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="合理使用-uncaughtexception"><a href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8-uncaughtexception" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>合理使用 uncaughtException</h4>\n<p><code class="language-text">uncaughtException</code> 的初衷是可以让你拿到错误之后可以做一些回收处理之后再 process.exit. 官方的同志们还曾经讨论过要移除该事件 (详见 <a href="https://github.com/nodejs/node-v0.x-archive/issues/2582" target="_blank" rel="nofollow noreferrer noopener">issues</a>)</p>\n<p>所以你需要明白 <code class="language-text">uncaughtException</code> 其实已经是非常规手段了, 应尽量避免使用它来处理错误. 因为通过该事件捕获到错误后, 并不代表 <code class="language-text">你可以愉快的继续运行 (On Error Resume Next)</code>. 程序内部存在未处理的异常, 这意味着应用程序处于一种未知的状态. 如果不能适当的恢复其状态, 那么很有可能会触发不可预见的问题. (使用 domain 会很夸张的加剧这个现象, 并产生新人不能理解的各类幽灵问题)</p>\n<p>如果在 <code class="language-text">.on</code> 指定的监听回调中报错不会被捕获, Node.js 的进程会直接终断并返回一个非零的退出码, 最后输出相应的堆栈信息. 否则, 会出现无限递归. 除此之外, 内存崩溃/底层报错等情况也不会被捕获, <strong>目前猜测</strong>是 v8/C++ 那边撂担子不干了, Node.js 完全插不上话导致的 (TODO 整理到这里才想起来这个念头尚未验证, 如果有空的朋友帮忙验证下).</p>\n<p>所以官方建议的使用 <code class="language-text">uncaughtException</code> 的正确姿势是在结束进程前使用同步的方式清理已使用的资源 (文件描述符、句柄等) 然后 process.exit.</p>\n<p>在 uncaughtException 事件之后执行普通的恢复操作并不安全. 官方建议是另外在专门准备一个 monitor 进程来做健康检查并通过 monitor 来管理恢复情况, 并在必要的时候重启 (所以官方是含蓄的提醒各位用 pm2 之类的工具).</p>\n<h3 id="unhandledrejection"><a href="#unhandledrejection" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>unhandledRejection</h3>\n<p>当 Promise 被 reject 且没有绑定监听处理时, 就会触发该事件. 该事件对排查和追踪没有处理 reject 行为的 Promise 很有用.</p>\n<p>该事件的回调函数接收以下参数：</p>\n<ul>\n<li><code class="language-text">reason</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" target="_blank" rel="nofollow noreferrer noopener"><code class="language-text">&lt;Error&gt;</code></a> | <code class="language-text">&lt;any&gt;</code> 该 Promise 被 reject 的对象 (通常为 Error 对象)</li>\n<li><code class="language-text">p</code> 被 reject 的 Promise 本身</li>\n</ul>\n<p>例如</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11487075897687759000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`process.on(\'unhandledRejection\', (reason, p) => {\n  console.log(\'Unhandled Rejection at: Promise\', p, \'reason:\', reason);\n  // application specific logging, throwing an error, or other logic here\n});\n\nsomePromise.then((res) => {\n  return reportToUser(JSON.pasre(res)); // note the typo (\\`pasre\\`)\n}); // no \\`.catch\\` or \\`.then\\``, `11487075897687759000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">\'unhandledRejection\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> p</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Unhandled Rejection at: Promise\'</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token string">\'reason:\'</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// application specific logging, throwing an error, or other logic here</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nsomePromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">reportToUser</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">pasre</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// note the typo (`pasre`)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// no `.catch` or `.then`</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以下代码也会触发 <code class="language-text">unhandledRejection</code> 事件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10161824140298047000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function SomeResource() {\n  // Initially set the loaded status to a rejected promise\n  this.loaded = Promise.reject(new Error(\'Resource not yet loaded!\'));\n}\n\nvar resource = new SomeResource();\n// no .catch or .then on resource.loaded for at least a turn`, `10161824140298047000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">SomeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Initially set the loaded status to a rejected promise</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'Resource not yet loaded!\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">var</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SomeResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// no .catch or .then on resource.loaded for at least a turn</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>In this example case, it is possible to track the rejection as a developer error as would typically be the case for other ‘unhandledRejection’ events. To address such failures, a non-operational <code class="language-text">.catch(() =&gt; { })</code> handler may be attached to resource.loaded, which would prevent the ‘unhandledRejection’ event from being emitted. Alternatively, the ‘rejectionHandled’ event may be used.</p>\n</blockquote>\n<h2 id="domain"><a href="#domain" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Domain</h2>\n<p>Node.js 早期, try/catch 无法捕获异步的错误, 而错误优先的 callback 仅仅是一种约定并没有强制性并且写起来十分繁琐. 所以为了能够很好的捕获异常, Node.js 从 v0.8 开始引入 domain 这个模块.</p>\n<p>domain 本身是一个 EventEmitter 对象, 其中文意思是 “域” 的意思, 捕获异步异常的基本思路是创建一个域, cb 函数会在定义时会继承上一层的域, 报错通过当前域的 <code class="language-text">.emit(&#39;error&#39;, err)</code> 方法触发错误事件将错误传递上去, 从而使得异步错误可以被强制捕获. (更多内容详见 <a href="https://cnodejs.org/topic/516b64596d38277306407936" target="_blank" rel="nofollow noreferrer noopener">Node.js 异步异常的处理与 domain 模块解析</a>)</p>\n<p>但是 domain 的引入也带来了更多新的问题. 比如依赖的模块无法继承你定义的 domain, 导致你写的 domain 无法 cover 依赖模块报错. 而且, 很多人 (特别是新人) 由于不了解 Node.js 的内存/异步流程等问题, 在使用 domain 处理报错的时候, 没有做到完善的处理并盲目的让代码继续走下去, 这很可能导致<strong>项目完全无法维护</strong> (可能出现的问题真是不胜枚举, 各种梦魇…)</p>\n<p>该模块目前的情况: <a href="https://github.com/nodejs/node/issues/66" target="_blank" rel="nofollow noreferrer noopener">deprecate domains</a></p>\n<h2 id="debugger"><a href="#debugger" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Debugger</h2>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-03-20-15-43-51-71557b407619a09a956d6d8871d0cfa1-9cc21.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 71.88665175242357%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACHElEQVQoz5VS22pTQRTNR/gB4ru3Z3/Bv/DNF/HRN79A6ItYSNpKqbQFlTYlUEKjrSmpbbTYJjHmJCRNk5wk5zIz5zIzZ27HOUkoiYjgYs/AHmbtWbP2TsX/DzUJjZRSynEhcBEAyAXI8wKdmqalUwg9hHwEvYE5Hlvu2HIs29XnN1VSel22O0eX1XKzVaz9PDNaX+uNwvlFsVIrVmunhnFS/5Uvn+vDs4ZRqtUr3a5DMaBkRmaxIkpgwbFgRAoRq0nIZFeKK7WgWSkmJZdyRv4DlEUewT4lPoum4bEIsYhNCPNI3dRzXdeGQPnBi2+Htw/ePTzYvL+3ei+7cjebebC3eufj8nazIkLMtaB5MmMMAOA4zmg4NG3raG1968nT7NLSTqee6xp5s5MftHP9Vi/0kkfmfpGQOedhGBJCQg/1ge9vvYqfP1KbbziVivN/9CwhY4yhbosGAjCIRz9eWvu3vMEHn8ZCMu3ZNFSs/kLmQjiuVq3b6AiMni0fph5nNj7VY0kZF2riyHQw1BwWDJMTxJKfVLsbnxtGz44oplEUUW1/skeEyEXDE7LPo5BF8WLVxEjOAdQD5kPfh0EAwwBh7FGCKAkZm5GPh1en5hW0tWxbp1KPgUheaLavX7/dTr/fTe/k0rn9lUJh7fjLermU+V7aNaozMhE8EkKPlsa8KkJotz+8Ho6vR1bPsnuO0wduH4GeBy0c6Au/AVNbCEgxfvzFAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 03 20 15 43 51"\n        title=""\n        src="/static/2021-03-20-15-43-51-71557b407619a09a956d6d8871d0cfa1-fee1c.png"\n        srcset="/static/2021-03-20-15-43-51-71557b407619a09a956d6d8871d0cfa1-a67b7.png 200w,\n/static/2021-03-20-15-43-51-71557b407619a09a956d6d8871d0cfa1-0b187.png 400w,\n/static/2021-03-20-15-43-51-71557b407619a09a956d6d8871d0cfa1-fee1c.png 800w,\n/static/2021-03-20-15-43-51-71557b407619a09a956d6d8871d0cfa1-b1a91.png 1200w,\n/static/2021-03-20-15-43-51-71557b407619a09a956d6d8871d0cfa1-9cc21.png 1341w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>类似 gdb 的命令行下 debug 工具 (上图中的 build-in debugger), 同时也支持远程 debug (类似 <a href="https://github.com/node-inspector/node-inspector" target="_blank" rel="nofollow noreferrer noopener">node-inspector</a>, 目前处于试验状态). 当然, 目前有不少同学觉得 <a href="https://code.visualstudio.com/" target="_blank" rel="nofollow noreferrer noopener">vscode</a> 对 debug 工具集成的比较好.</p>\n<p>关于这个 build-in debugger 使用推荐看<a href="https://nodejs.org/dist/latest-v6.x/docs/api/debugger.html" target="_blank" rel="nofollow noreferrer noopener">官方文档</a>. 如果要深入一点, 你可能对本文感兴趣: <a href="http://code.oneapm.com/nodejs/2015/06/27/intereference/" target="_blank" rel="nofollow noreferrer noopener">动态修改 NodeJS 程序中的变量值</a></p>\n<h2 id="cc-addon"><a href="#cc-addon" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>C/C++ Addon</h2>\n<p>在 Node.js 中开发 addon 最痛苦的地方莫过于升级 V8 导致的 C/C++ 代码不能兼容的问题, 这个问题在很早就出现了. 为了解决这个问题前人开了一个叫 <a href="https://github.com/nodejs/nan" target="_blank" rel="nofollow noreferrer noopener">nan</a> 的项目.</p>\n<p>要学习 addon 开发, 除了<a href="https://nodejs.org/docs/latest/api/addons.html" target="_blank" rel="nofollow noreferrer noopener">官方文档</a>也推荐阅读这个: <a href="https://github.com/nodejs/node-addon-examples" target="_blank" rel="nofollow noreferrer noopener">https://github.com/nodejs/node-addon-examples</a></p>\n<h2 id="v8"><a href="#v8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>V8</h2>\n<p>这里并不是介绍 V8, 而是介绍 Node.js 中的 V8 这个模块. 该模块用于开放 Node.js 内建的 V8 引擎的事件和接口. 这些接口由 V8 底层决定, 所以无法保证绝对的稳定性.</p>\n<table>\n<thead>\n<tr>\n<th>接口</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>v8.getHeapStatistics()</td>\n<td>获取 heap 信息</td>\n</tr>\n<tr>\n<td>v8.getHeapSpaceStatistics()</td>\n<td>获取 heap space 信息</td>\n</tr>\n<tr>\n<td>v8.setFlagsFromString(string)</td>\n<td>动态设置 V8 options</td>\n</tr>\n</tbody>\n</table>\n<h3 id="v8setflagsfromstringstring"><a href="#v8setflagsfromstringstring" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>v8.setFlagsFromString(string)</h3>\n<p>该方法用于添加额外的 V8 命令行标志. 该方法需谨慎使用, 在 VM 启动后修改配置可能会发生不可预测的行为、崩溃和数据丢失; 或者什么反应都没有.</p>\n<p>通过 <code class="language-text">node --v8-options</code> 命令可以查询当前 Node.js 环境中有哪些可用的 V8 options. 此外, 还可以参考非官方维护的一个 <a href="https://github.com/thlorenz/v8-flags/blob/master/flags-0.11.md" target="_blank" rel="nofollow noreferrer noopener">V8 options 列表</a>.</p>\n<p>用法:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66090926996709510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Print GC events to stdout for one minute.\nconst v8 = require(\'v8\');\nv8.setFlagsFromString(\'--trace_gc\');\nsetTimeout(function() {\n  v8.setFlagsFromString(\'--notrace_gc\');\n}, 60e3);`, `66090926996709510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Print GC events to stdout for one minute.</span>\n<span class="token keyword">const</span> v8 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'v8\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nv8<span class="token punctuation">.</span><span class="token function">setFlagsFromString</span><span class="token punctuation">(</span><span class="token string">\'--trace_gc\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  v8<span class="token punctuation">.</span><span class="token function">setFlagsFromString</span><span class="token punctuation">(</span><span class="token string">\'--notrace_gc\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">60e3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="内存快照"><a href="#%E5%86%85%E5%AD%98%E5%BF%AB%E7%85%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内存快照</h2>\n<p>内存快照常用与解决内存泄漏的问题. 快照工具推荐使用 <a href="https://github.com/bnoordhuis/node-heapdump" target="_blank" rel="nofollow noreferrer noopener">heapdump</a> 用来保存内存快照, 使用 <a href="https://github.com/Jam3/devtool" target="_blank" rel="nofollow noreferrer noopener">devtool</a> 来查看内存快照. 使用 heapdump 保存内存快照时, 只会有 Node.js 环境中的对象, 不会受到干扰（如果使用 <a href="https://github.com/node-inspector/node-inspector" target="_blank" rel="nofollow noreferrer noopener">node-inspector</a> 的话, 快照中会有前端的变量干扰）.</p>\n<p>使用以及内存泄漏的常见原因详见: <a href="https://zhuanlan.zhihu.com/p/25736931?group_id=825001468703674368" target="_blank" rel="nofollow noreferrer noopener">如何分析 Node.js 中的内存泄漏</a>.</p>\n<h2 id="cpu-profiling"><a href="#cpu-profiling" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CPU profiling</h2>\n<p>CPU profiling (剖析) 常用于性能优化. 有许多用于做 profiling 的第三方工具, 但是大部分情况下, 使用 Node.js 内置的是最简单的. 其内置调用的就是 <a href="https://github.com/v8/v8/wiki/Using%20V8%E2%80%99s%20internal%20profiler" target="_blank" rel="nofollow noreferrer noopener">V8 本身的 profiler</a>, 它可以在程序执行过程中中是对 stack 间隔性的抽样分析.</p>\n<p>使用 <code class="language-text">--prof</code> 开启内置的 profilling</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16177652460804470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`node --prof app.js`, `16177652460804470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                shell 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">node --prof app.js</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>程序运行之后会生成一个 <code class="language-text">isolate-0xnnnnnnnnnnnn-v8.log</code> 在当前运行目录.</p>\n<p>你可以使用 <code class="language-text">--prof-process</code> 来生成报告查看</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37540747231294900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`node --prof-process isolate-0xnnnnnnnnnnnn-v8.log`, `37540747231294900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">node --prof-process isolate-0xnnnnnnnnnnnn-v8.log</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>报告形如:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63742060602897050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Statistical profiling result from isolate-0x103001200-v8.log, (12042 ticks, 2634 unaccounted, 0 excluded).\n\n [Shared libraries]:\n   ticks  total  nonlib   name\n     35    0.3%          /usr/lib/system/libsystem_platform.dylib\n     27    0.2%          /usr/lib/system/libsystem_pthread.dylib\n      7    0.1%          /usr/lib/system/libsystem_c.dylib\n      3    0.0%          /usr/lib/system/libsystem_kernel.dylib\n      1    0.0%          /usr/lib/system/libsystem_malloc.dylib\n\n [JavaScript]:\n   ticks  total  nonlib   name\n    208    1.7%    1.7%  Stub: LoadICStub\n    187    1.6%    1.6%  KeyedLoadIC: A keyed load IC from the snapshot\n    104    0.9%    0.9%  Stub: VectorStoreICStub\n     69    0.6%    0.6%  LazyCompile: *emit events.js:136:44\n     68    0.6%    0.6%  Builtin: CallFunction_ReceiverIsNotNullOrUndefined\n     65    0.5%    0.5%  KeyedStoreIC: A keyed store IC from the snapshot {2}\n     47    0.4%    0.4%  Builtin: CallFunction_ReceiverIsAny\n     43    0.4%    0.4%  LazyCompile: *storeHeader _http_outgoing.js:312:21\n     34    0.3%    0.3%  LazyCompile: *removeListener events.js:315:28\n     33    0.3%    0.3%  Stub: RegExpExecStub\n     33    0.3%    0.3%  LazyCompile: *_addListener events.js:210:22\n     32    0.3%    0.3%  Stub: CEntryStub\n     32    0.3%    0.3%  Builtin: ArgumentsAdaptorTrampoline\n     31    0.3%    0.3%  Stub: FastNewClosureStub\n     30    0.2%    0.3%  Stub: InstanceOfStub\n     ...\n\n [C++]:\n   ticks  total  nonlib   name\n    460    3.8%    3.8%  _mach_port_extract_member\n    329    2.7%    2.7%  _openat\\$NOCANCEL\n    199    1.7%    1.7%  ___bsdthread_register\n    136    1.1%    1.1%  ___mkdir_extended\n    116    1.0%    1.0%  node::HandleWrap::Close(v8::FunctionCallbackInfo<v8::Value> const&)\n    112    0.9%    0.9%  void v8::internal::BodyDescriptorBase::IterateBodyImpl<v8::internal::StaticScavengeVisitor>(v8::internal::Heap*, v8::internal::HeapObject*, int, int)\n    106    0.9%    0.9%  _http_parser_execute\n    103    0.9%    0.9%  _szone_malloc_should_clear\n     99    0.8%    0.8%  int v8::internal::BinarySearch<(v8::internal::SearchMode)1, v8::internal::DescriptorArray>(v8::internal::DescriptorArray*, v8::internal::Name*, int, int*)\n     89    0.7%    0.7%  node::TCPWrap::Connect(v8::FunctionCallbackInfo<v8::Value> const&)\n     86    0.7%    0.7%  v8::internal::LookupIterator::State v8::internal::LookupIterator::LookupInRegularHolder<false>(v8::internal::Map*, v8::internal::JSReceiver*)\n     ...\n\n [Bottom up (heavy) profile]:\n  Note: percentage shows a share of a particular caller in the total\n  amount of its parent calls.\n  Callers occupying less than 2.0% are not shown.\n\n   ticks parent  name\n   2634   21.9%  UNKNOWN\n    764   29.0%    LazyCompile: *connect net.js:815:17\n    764  100.0%      LazyCompile: ~<anonymous> net.js:966:30\n    764  100.0%        LazyCompile: *_tickCallback internal/process/next_tick.js:87:25\n    193    7.3%    LazyCompile: *createWriteReq net.js:732:24\n    101   52.3%      LazyCompile: *Socket._writeGeneric net.js:660:42\n     99   98.0%        LazyCompile: ~<anonymous> net.js:667:34\n     99  100.0%          LazyCompile: ~g events.js:287:13\n     99  100.0%            LazyCompile: *emit events.js:136:44\n     92   47.7%      LazyCompile: ~Socket._writeGeneric net.js:660:42\n     91   98.9%        LazyCompile: ~<anonymous> net.js:667:34\n     91  100.0%          LazyCompile: ~g events.js:287:13\n     91  100.0%            LazyCompile: *emit events.js:136:44\n\t ...`, `63742060602897050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Statistical profiling result from isolate-0x103001200-v8.log, (12042 ticks, 2634 unaccounted, 0 excluded).\n\n [Shared libraries]:\n   ticks  total  nonlib   name\n     35    0.3%          /usr/lib/system/libsystem_platform.dylib\n     27    0.2%          /usr/lib/system/libsystem_pthread.dylib\n      7    0.1%          /usr/lib/system/libsystem_c.dylib\n      3    0.0%          /usr/lib/system/libsystem_kernel.dylib\n      1    0.0%          /usr/lib/system/libsystem_malloc.dylib\n\n [JavaScript]:\n   ticks  total  nonlib   name\n    208    1.7%    1.7%  Stub: LoadICStub\n    187    1.6%    1.6%  KeyedLoadIC: A keyed load IC from the snapshot\n    104    0.9%    0.9%  Stub: VectorStoreICStub\n     69    0.6%    0.6%  LazyCompile: *emit events.js:136:44\n     68    0.6%    0.6%  Builtin: CallFunction_ReceiverIsNotNullOrUndefined\n     65    0.5%    0.5%  KeyedStoreIC: A keyed store IC from the snapshot {2}\n     47    0.4%    0.4%  Builtin: CallFunction_ReceiverIsAny\n     43    0.4%    0.4%  LazyCompile: *storeHeader _http_outgoing.js:312:21\n     34    0.3%    0.3%  LazyCompile: *removeListener events.js:315:28\n     33    0.3%    0.3%  Stub: RegExpExecStub\n     33    0.3%    0.3%  LazyCompile: *_addListener events.js:210:22\n     32    0.3%    0.3%  Stub: CEntryStub\n     32    0.3%    0.3%  Builtin: ArgumentsAdaptorTrampoline\n     31    0.3%    0.3%  Stub: FastNewClosureStub\n     30    0.2%    0.3%  Stub: InstanceOfStub\n     ...\n\n [C++]:\n   ticks  total  nonlib   name\n    460    3.8%    3.8%  _mach_port_extract_member\n    329    2.7%    2.7%  _openat$NOCANCEL\n    199    1.7%    1.7%  ___bsdthread_register\n    136    1.1%    1.1%  ___mkdir_extended\n    116    1.0%    1.0%  node::HandleWrap::Close(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)\n    112    0.9%    0.9%  void v8::internal::BodyDescriptorBase::IterateBodyImpl&lt;v8::internal::StaticScavengeVisitor&gt;(v8::internal::Heap*, v8::internal::HeapObject*, int, int)\n    106    0.9%    0.9%  _http_parser_execute\n    103    0.9%    0.9%  _szone_malloc_should_clear\n     99    0.8%    0.8%  int v8::internal::BinarySearch&lt;(v8::internal::SearchMode)1, v8::internal::DescriptorArray&gt;(v8::internal::DescriptorArray*, v8::internal::Name*, int, int*)\n     89    0.7%    0.7%  node::TCPWrap::Connect(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)\n     86    0.7%    0.7%  v8::internal::LookupIterator::State v8::internal::LookupIterator::LookupInRegularHolder&lt;false&gt;(v8::internal::Map*, v8::internal::JSReceiver*)\n     ...\n\n [Bottom up (heavy) profile]:\n  Note: percentage shows a share of a particular caller in the total\n  amount of its parent calls.\n  Callers occupying less than 2.0% are not shown.\n\n   ticks parent  name\n   2634   21.9%  UNKNOWN\n    764   29.0%    LazyCompile: *connect net.js:815:17\n    764  100.0%      LazyCompile: ~&lt;anonymous&gt; net.js:966:30\n    764  100.0%        LazyCompile: *_tickCallback internal/process/next_tick.js:87:25\n    193    7.3%    LazyCompile: *createWriteReq net.js:732:24\n    101   52.3%      LazyCompile: *Socket._writeGeneric net.js:660:42\n     99   98.0%        LazyCompile: ~&lt;anonymous&gt; net.js:667:34\n     99  100.0%          LazyCompile: ~g events.js:287:13\n     99  100.0%            LazyCompile: *emit events.js:136:44\n     92   47.7%      LazyCompile: ~Socket._writeGeneric net.js:660:42\n     91   98.9%        LazyCompile: ~&lt;anonymous&gt; net.js:667:34\n     91  100.0%          LazyCompile: ~g events.js:287:13\n     91  100.0%            LazyCompile: *emit events.js:136:44\n\t ...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<table>\n<thead>\n<tr>\n<th>字段</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ticks</td>\n<td>时间片</td>\n</tr>\n<tr>\n<td>total</td>\n<td>当前操作执行的时间占总时间的比率</td>\n</tr>\n<tr>\n<td>nonlib</td>\n<td>当前非 System library 执行时间比率</td>\n</tr>\n</tbody>\n</table>\n<h1 id="util"><a href="#util" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>util</h1>\n<h2 id="url"><a href="#url" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>URL</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21785903348016890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`┌─────────────────────────────────────────────────────────────────────────────┐\n│                                    href                                     │\n├──────────┬┬───────────┬─────────────────┬───────────────────────────┬───────┤\n│ protocol ││   auth    │      host       │           path            │ hash  │\n│          ││           ├──────────┬──────┼──────────┬────────────────┤       │\n│          ││           │ hostname │ port │ pathname │     search     │       │\n│          ││           │          │      │          ├─┬──────────────┤       │\n│          ││           │          │      │          │ │    query     │       │\n&quot;  http:   // user:pass @ host.com : 8080   /p/a/t/h  ?  query=string   #hash &quot;\n│          ││           │          │      │          │ │              │       │\n└──────────┴┴───────────┴──────────┴──────┴──────────┴─┴──────────────┴───────┘`, `21785903348016890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">┌─────────────────────────────────────────────────────────────────────────────┐\n│                                    href                                     │\n├──────────┬┬───────────┬─────────────────┬───────────────────────────┬───────┤\n│ protocol ││   auth    │      host       │           path            │ hash  │\n│          ││           ├──────────┬──────┼──────────┬────────────────┤       │\n│          ││           │ hostname │ port │ pathname │     search     │       │\n│          ││           │          │      │          ├─┬──────────────┤       │\n│          ││           │          │      │          │ │    query     │       │\n<span class="token string">"  http:   // user:pass @ host.com : 8080   /p/a/t/h  ?  query=string   #hash "</span>\n│          ││           │          │      │          │ │              │       │\n└──────────┴┴───────────┴──────────┴──────┴──────────┴─┴──────────────┴───────┘</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="转义字符"><a href="#%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>转义字符</h3>\n<p>常见的需要转义的字符列表:</p>\n<table>\n<thead>\n<tr>\n<th>字符</th>\n<th>encodeURI</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class="language-text">&#39; &#39;</code></td>\n<td><code class="language-text">&#39;%20&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">&lt;</code></td>\n<td><code class="language-text">&#39;%3C&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">&gt;</code></td>\n<td><code class="language-text">&#39;%3E&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">&quot;</code></td>\n<td><code class="language-text">&#39;%22&#39;</code></td>\n</tr>\n<tr>\n<td>`</td>\n<td><code class="language-text">&#39;%60&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">\\r</code></td>\n<td><code class="language-text">&#39;%0D&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">\\n</code></td>\n<td><code class="language-text">&#39;%0A&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">\\t</code></td>\n<td><code class="language-text">&#39;%09&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">{</code></td>\n<td><code class="language-text">&#39;%7B&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">}</code></td>\n<td><code class="language-text">&#39;%7D&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">|</code></td>\n<td><code class="language-text">&#39;%7C&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">\\\\</code></td>\n<td><code class="language-text">&#39;%5C&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">^</code></td>\n<td><code class="language-text">&#39;%5E&#39;</code></td>\n</tr>\n<tr>\n<td><code class="language-text">&#39;</code></td>\n<td><code class="language-text">&#39;%27&#39;</code></td>\n</tr>\n</tbody>\n</table>\n<p>想了解更多? 你可以这样:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34777638562288927000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Array(range)\n  .fill(0)\n  .map((_, i) => String.fromCharCode(i))\n  .map(encodeURI);`, `34777638562288927000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">Array</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>encodeURI<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="query-strings"><a href="#query-strings" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Query Strings</h2>\n<p>query string 属于 URL 的一部分, 见上方 URL 的表. 在 Node.js 中有内置提供一个 <code class="language-text">querystring</code> 的模块.</p>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>.parse(str[, sep[, eq\n[\n, options\n]\n]])</td>\n<td>将一个 query string 解析为 json 对象</td>\n</tr>\n<tr>\n<td>.unescape(str)</td>\n<td>供 .parse 调用的内置解转义方法, 暴露出来以供用户自行替代</td>\n</tr>\n<tr>\n<td>.stringify(obj[, sep[, eq\n[\n, options\n]\n]])</td>\n<td>将一个 json 对象转换成 query string</td>\n</tr>\n<tr>\n<td>.escape(str)</td>\n<td>供 .stringify 调用的内置转义方法, 暴露出来以供用户自行替代</td>\n</tr>\n</tbody>\n</table>\n<p>Node.js 内置的 querystring 目前对于有深度的结构尚不支持. 见如下:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23216069888118395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const qs = require(\'qs\'); // 第三方\nconst querystring = require(\'querystring\'); // Node.js 内置\n\nlet obj = { a: { b: { c: 1 } } };\n\nconsole.log(qs.stringify(obj)); // \'a%5Bb%5D%5Bc%5D=1\'\nconsole.log(querystring.stringify(obj)); // \'a=\'\n\nlet str = \'a%5Bb%5D%5Bc%5D=1\';\n\nconsole.log(qs.parse(str)); // { a: { b: { c: \'1\' } } }\nconsole.log(querystring.parse(str)); // { \'a[b][c]\': \'1\' }`, `23216069888118395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'qs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第三方</span>\n<span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'querystring\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Node.js 内置</span>\n\n<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token punctuation">{</span> b<span class="token punctuation">:</span> <span class="token punctuation">{</span> c<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'a%5Bb%5D%5Bc%5D=1\'</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'a=\'</span>\n\n<span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">\'a%5Bb%5D%5Bc%5D=1\'</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { a: { b: { c: \'1\' } } }</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { \'a[b][c]\': \'1\' }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p><a name="q-get-param"></a> HTTP 如何通过 GET 方法 (URL) 传递 let arr = [1,2,3,4] 给服务器?</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43021648333120496000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const qs = require(\'qs\');\n\nlet arr = [1, 2, 3, 4];\nlet str = qs.stringify({ arr });\n\nconsole.log(str); // arr%5B0%5D=1&arr%5B1%5D=2&arr%5B2%5D=3&arr%5B3%5D=4\nconsole.log(decodeURI(str)); // \'arr[0]=1&arr[1]=2&arr[2]=3&arr[3]=4\'\nconsole.log(qs.parse(str)); // { arr: [ \'1\', \'2\', \'3\', \'4\' ] }`, `43021648333120496000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'qs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token keyword">let</span> str <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> arr <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// arr%5B0%5D=1&amp;arr%5B1%5D=2&amp;arr%5B2%5D=3&amp;arr%5B3%5D=4</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">decodeURI</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'arr[0]=1&amp;arr[1]=2&amp;arr[2]=3&amp;arr[3]=4\'</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { arr: [ \'1\', \'2\', \'3\', \'4\' ] }</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 <code class="language-text">https://your.host/api/?arr[0]=1&amp;arr[1]=2&amp;arr[2]=3&amp;arr[3]=4</code> 即可传递把 arr 数组传递给服务器</p>\n<h2 id="util-1"><a href="#util-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>util</h2>\n<p>util.is*() 从 v4.0.0 开始被不建议使用即将废弃 (deprecated). 大概的废弃原因, 笔者个人认为是维护这些功能吃力不讨好, 而且现在流行的轮子那么多. 那么一下是具体列表:</p>\n<ul>\n<li>util.debug(string)</li>\n<li>util.error([…strings])</li>\n<li>util.isArray(object)</li>\n<li>util.isBoolean(object)</li>\n<li>util.isBuffer(object)</li>\n<li>util.isDate(object)</li>\n<li>util.isError(object)</li>\n<li>util.isFunction(object)</li>\n<li>util.isNull(object)</li>\n<li>util.isNullOrUndefined(object)</li>\n<li>util.isNumber(object)</li>\n<li>util.isObject(object)</li>\n<li>util.isPrimitive(object)</li>\n<li>util.isRegExp(object)</li>\n<li>util.isString(object)</li>\n<li>util.isSymbol(object)</li>\n<li>util.isUndefined(object)</li>\n<li>util.log(string)</li>\n<li>util.print([…strings])</li>\n<li>util.puts([…strings])</li>\n<li>util._extend(target, source)</li>\n</ul>\n<p>其中大部分都可以作为面试题来问如何实现.</p>\n<h3 id="utilinherits"><a href="#utilinherits" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>util.inherits</h3>\n<blockquote>\n<p>Node.js 中继承 (util.inherits) 的实现?</p>\n</blockquote>\n<p><a href="https://github.com/nodejs/node/blob/v7.6.0/lib/util.js#L960" target="_blank" rel="nofollow noreferrer noopener">https://github.com/nodejs/node/blob/v7.6.0/lib/util.js#L960</a></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7918946559083450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/**\n * Inherit the prototype methods from one constructor into another.\n *\n * The Function.prototype.inherits from lang.js rewritten as a standalone\n * function (not on Function.prototype). NOTE: If this file is to be loaded\n * during bootstrapping this function needs to be rewritten using some native\n * functions as prototype setup using normal JavaScript does not work as\n * expected during bootstrapping (see mirror.js in r114903).\n *\n * @param {function} ctor Constructor function which needs to inherit the\n *     prototype.\n * @param {function} superCtor Constructor function to inherit prototype from.\n * @throws {TypeError} Will error if either constructor is null, or if\n *     the super constructor lacks a prototype.\n */\nexports.inherits = function(ctor, superCtor) {\n  if (ctor === undefined || ctor === null)\n    throw new TypeError(\'The constructor to &quot;inherits&quot; must not be \' + \'null or undefined\');\n\n  if (superCtor === undefined || superCtor === null)\n    throw new TypeError(\'The super constructor to &quot;inherits&quot; must not \' + \'be null or undefined\');\n\n  if (superCtor.prototype === undefined)\n    throw new TypeError(\'The super constructor to &quot;inherits&quot; must \' + \'have a prototype\');\n\n  ctor.super_ = superCtor;\n  Object.setPrototypeOf(ctor.prototype, superCtor.prototype);\n};`, `7918946559083450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">/**\n * Inherit the prototype methods from one constructor into another.\n *\n * The Function.prototype.inherits from lang.js rewritten as a standalone\n * function (not on Function.prototype). NOTE: If this file is to be loaded\n * during bootstrapping this function needs to be rewritten using some native\n * functions as prototype setup using normal JavaScript does not work as\n * expected during bootstrapping (see mirror.js in r114903).\n *\n * @param {function} ctor Constructor function which needs to inherit the\n *     prototype.\n * @param {function} superCtor Constructor function to inherit prototype from.\n * @throws {TypeError} Will error if either constructor is null, or if\n *     the super constructor lacks a prototype.\n */</span>\nexports<span class="token punctuation">.</span><span class="token function-variable function">inherits</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctor<span class="token punctuation">,</span> superCtor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctor <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> ctor <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">\'The constructor to "inherits" must not be \'</span> <span class="token operator">+</span> <span class="token string">\'null or undefined\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>superCtor <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> superCtor <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">\'The super constructor to "inherits" must not \'</span> <span class="token operator">+</span> <span class="token string">\'be null or undefined\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>superCtor<span class="token punctuation">.</span>prototype <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">\'The super constructor to "inherits" must \'</span> <span class="token operator">+</span> <span class="token string">\'have a prototype\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  ctor<span class="token punctuation">.</span>super_ <span class="token operator">=</span> superCtor<span class="token punctuation">;</span>\n  Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>ctor<span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> superCtor<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="正则表达式"><a href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正则表达式</h2>\n<p>正则表达式最早生物学上用来描述大脑神经元的一种表达式, 被 GNU 的大胡子拿来做字符串匹配之后在原本的道路上渐行渐远.</p>\n<p>整理中..</p>\n<h2 id="常用模块"><a href="#%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>常用模块</h2>\n<p><a href="https://github.com/sindresorhus/awesome-nodejs" target="_blank" rel="nofollow noreferrer noopener">Awesome Node.js</a> <a href="https://www.npmjs.com/browse/depended" target="_blank" rel="nofollow noreferrer noopener">Most depended-upon packages</a></p>\n<blockquote>\n<p><a name="q-traversal"></a> 如何获取某个文件夹下所有的文件名?</p>\n</blockquote>\n<p>一个简单的例子:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57462432208685965000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const fs = require(\'fs\');\nconst path = require(\'path\');\n\nfunction traversal(dir) {\n  let res = [];\n  for (let item of fs.readdirSync(dir)) {\n    let filepath = path.join(dir, item);\n    try {\n      let fd = fs.openSync(filepath, \'r\');\n      let flag = fs.fstatSync(fd).isDirectory();\n      fs.close(fd);\n      if (flag) {\n        res.push(...traversal(filepath));\n      } else {\n        res.push(filepath);\n      }\n    } catch (err) {\n      if (\n        err.code === \'ENOENT\' && // link 文件打不开\n        !!fs.readlinkSync(filepath)\n      ) {\n        // 判断是否 link 文件\n        res.push(filepath);\n      } else {\n        console.error(\'err\', err);\n      }\n    }\n  }\n  return res.map((file) => path.basename(file));\n}\n\nconsole.log(traversal(\'.\'));`, `57462432208685965000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'fs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">traversal</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">of</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> filepath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token keyword">let</span> fd <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> flag <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">fstatSync</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">traversal</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>\n        err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">\'ENOENT\'</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// link 文件打不开</span>\n        <span class="token operator">!</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">readlinkSync</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>\n      <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 判断是否 link 文件</span>\n        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'err\'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">traversal</span><span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然也可以 Oh my <a href="https://github.com/isaacs/node-glob" target="_blank" rel="nofollow noreferrer noopener">glob</a>:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32252113037998977000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const glob = require(\'glob\');\n\nglob(\'**/*.js\', (err, files) => {\n  if (err) {\n    throw new Error(err);\n  }\n  files.map((filename) => {\n    console.log(\'Here you are:\', filename);\n  });\n});`, `32252113037998977000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                javascript 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'glob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">\'**/*.js\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'Here you are:\'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="存储"><a href="#%E5%AD%98%E5%82%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>存储</h1>\n<h2 id="简介"><a href="#%E7%AE%80%E4%BB%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简介</h2>\n<p>科班的同学可以了解一下<a href="http://www.cnblogs.com/CareySon/archive/2010/02/16/1668803.html" target="_blank" rel="nofollow noreferrer noopener">数据库范式</a>, 在 ElemeFe 面试不会问, 但是其他地方可能会问 (比如阿里).</p>\n<h2 id="mysql"><a href="#mysql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mysql</h2>\n<p>SQL (Structured Query Language) 是<a href="https://en.wikipedia.org/wiki/Relational_database" target="_blank" rel="nofollow noreferrer noopener">关系式数据库管理系统</a>的标准语言, 关于关系型数据库这里主要带大家看一下 Mysql 的几个问题</p>\n<h3 id="存储引擎"><a href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>存储引擎</h3>\n<table>\n<thead>\n<tr>\n<th>attr</th>\n<th>MyISAM</th>\n<th>InnoDB</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Locking</td>\n<td>Table-level</td>\n<td>Row-level</td>\n</tr>\n<tr>\n<td>designed for</td>\n<td>need of speed</td>\n<td>high volume of data</td>\n</tr>\n<tr>\n<td>foreign keys</td>\n<td>× (DBMS)</td>\n<td>✓ (RDBMS)</td>\n</tr>\n<tr>\n<td>transaction</td>\n<td>×</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>fulltext search</td>\n<td>✓</td>\n<td>×</td>\n</tr>\n<tr>\n<td>scene</td>\n<td>lots of select</td>\n<td>lots of insert/update</td>\n</tr>\n<tr>\n<td>count rows</td>\n<td>fast</td>\n<td>slow</td>\n</tr>\n<tr>\n<td>auto_increment</td>\n<td>fast</td>\n<td>slow</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>你的数据库有外键吗？</li>\n<li>你需要事务支持吗？</li>\n<li>你需要全文索引吗？</li>\n<li>你经常使用什么样的查询模式？</li>\n<li>你的数据有多大？</li>\n</ul>\n<p>参见 <a href="http://coolshell.cn/articles/652.html" target="_blank" rel="nofollow noreferrer noopener">MYSQL: INNODB 还是 MYISAM?</a></p>\n<h3 id="索引"><a href="#%E7%B4%A2%E5%BC%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>索引</h3>\n<p>索引是用空间换时间的一种优化策略. 推荐阅读: <a href="http://www.cnblogs.com/cq-home/p/3482101.html" target="_blank" rel="nofollow noreferrer noopener">mysql 索引类型</a> 以及 <a href="http://blog.mimvp.com/2015/03/the-difference-between-primary-key-and-unique-index/" target="_blank" rel="nofollow noreferrer noopener">主键与唯一索引的区别</a></p>\n<h2 id="mongodb"><a href="#mongodb" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mongodb</h2>\n<blockquote>\n<p>Monogdb 连接问题(超时/断开等)有可能是什么问题导致的?</p>\n</blockquote>\n<ul>\n<li>网络问题</li>\n<li>任务跑不完, 超过了 driver 的默认链接超时时间 (如 30s)</li>\n<li>Monogdb 宕机了</li>\n<li>超过了连接空闲时间 (connection idle time) 被断开</li>\n<li>fd 不够用 (ulimit 设置)</li>\n<li>mongodb 最大连接数不够用 (可能是连接未复用导致)</li>\n<li>etc…</li>\n</ul>\n<h3 id="other"><a href="#other" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>other</h3>\n<p>populate</p>\n<p>aggregate</p>\n<p>pipeline</p>\n<p>Cursor</p>\n<p>整理中</p>\n<h2 id="replication"><a href="#replication" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Replication</h2>\n<blockquote>\n<p>备份数据库与 M/S, M/M 等部署方式的区别?</p>\n</blockquote>\n<p>关于数据库基于各种模式的特点全部可以通过以下图片分清:</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-03-23-13-51-02-fe1e0b22b905d74bb1b57deaa98dff93-e4a38.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 45.08580343213728%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACEElEQVQoz01RW28SURDen6YveHkolbqAIlitzXoLwVCxXpIGiYYm9smn2kYrYhWDuFZr7eVBtDZB64uUVg1d2rLL3s45e82yQHfXU5+cTCaTSb75vvmG8P4L13VlQZA4TkeK5+5DJFmWhucKEk1D2Xe6Lb7pOF1J5pEiu65DWJaFEFJVFdeu4+jTRYa6xccfON+zrh3XmkmNG5HZhGdc21XH5tnrC40U/Ss5t3v5j0kTBt6pKLqOK2r3em5mRj1M2b6bzfkrFc3/ZTuw3gqaIumB/i01mteDOe5Ejg3mlKPr1iOi3W7LsgwhxCva3a5IT9buDTLZ+KcK9YQN5erht3JsqxWpsuTmxqXKe6pcOlcuDq+VIo2fzwl8kmkaWLNt27j/ak4UVLKknaVB9PVO7A0Xm5OitBArWJFa4YbnT8NwCg6nvFjCeUEfMGNa6SBE1/HW0Pgrvo8WThX50NNNcnY7SINQqRWe1U9WXya0Y0l9MAk2LvD1I4Y8RWBCjMOaAQAuNjb/mBm5yI6OgkocWmFBOMM0IwqM2OZpZu/qyjdqcXVokTm/JAR+azNEr9cDEOjYMcPA4E56Wjo0ZPhS9juqYx3viH2wGaiCgRrwL3HkM7E/t+fPNwbygu+HNkng36qaitPQ/4ELH4XbE1p6Sl99KIpjGn9XgeOfUXYZZD7UM8uNzMpOpizcL6M7dXPhLyEfoGwxMWFkAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 03 23 13 51 02"\n        title=""\n        src="/static/2021-03-23-13-51-02-fe1e0b22b905d74bb1b57deaa98dff93-fee1c.png"\n        srcset="/static/2021-03-23-13-51-02-fe1e0b22b905d74bb1b57deaa98dff93-a67b7.png 200w,\n/static/2021-03-23-13-51-02-fe1e0b22b905d74bb1b57deaa98dff93-0b187.png 400w,\n/static/2021-03-23-13-51-02-fe1e0b22b905d74bb1b57deaa98dff93-fee1c.png 800w,\n/static/2021-03-23-13-51-02-fe1e0b22b905d74bb1b57deaa98dff93-b1a91.png 1200w,\n/static/2021-03-23-13-51-02-fe1e0b22b905d74bb1b57deaa98dff93-e4a38.png 1282w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>图片出处：Google App Engine 的 co-founder Ryan Barrett 在 2009 年的 google i/o 上的演讲 <a href="http://snarfed.org/transactions_across_datacenters_io.html" target="_blank" rel="nofollow noreferrer noopener">《Transaction Across DataCenter》</a>（视频： <a href="http://www.youtube.com/watch?v=srOgpXECblk%EF%BC%89" target="_blank" rel="nofollow noreferrer noopener">http://www.youtube.com/watch?v=srOgpXECblk）</a></p>\n<p>根据上图, 我们可以知道 Master/Slave 与 Master/Master 的关系.</p>\n<table>\n  <tr><th>attr</th><th>Master/Slave</th><th>Master/Master</th></tr>\n  <tr><td>一致性</td><td colspan="2">Eventually：当你写入一个新值后，有可能读不出来，但在某个时间窗口之后保证最终能读出来。比如：DNS，电子邮件、Amazon S3，Google搜索引擎这样的系统。</td></tr>\n  <tr><td>事务</td><td align="center">完整</td><td align="center">本地</td></tr>\n  <tr><td>延迟</td><td colspan="2" align="center">低延迟</td></tr>\n  <tr><td>吞吐</td><td colspan="2" align="center">高吞吐</td></tr>\n  <tr><td>数据丢失</td><td colspan="2" align="center">部分丢失</td></tr>\n  <tr><td>熔断</td><td align="center">只读</td><td align="center">读/写</td></tr>\n</table>\n<h3 id="读写分离"><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读写分离</h3>\n<p>读写分离是在 query 量大的情况下减轻单个 DB 节点压力, 优化数据库读/写速度的一种策略. 不论是 MySQL 还是 MongoDB 都可以进行读写分离.</p>\n<p>读写分离的配置方式直接搜索一下 <code class="language-text">数据库名 + 读写分离</code> 即可找到. 通常是 M/S 的情况, 使用 Master 专门写, 用 Slave 节点专门读. 使用读写分离时, 请确认读的请求对一致性要求不高, 因为从写库同步读库是有延迟的.</p>\n<h2 id="数据一致性"><a href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据一致性</h2>\n<p>关于数据一致性推荐看陈皓的<a href="http://www.infoq.com/cn/articles/distributed-system-transaction-processing" target="_blank" rel="nofollow noreferrer noopener">分布式系统的事务处理</a></p>\n<blockquote>\n<p>什么情况下数据会出现脏数据? 如何避免?</p>\n</blockquote>\n<ul>\n<li>从 A 帐号中把余额读出来</li>\n<li>对 A 帐号做减法操作</li>\n<li>把结果写回 A 帐号中</li>\n<li>从 B 帐号中把余额读出来</li>\n<li>对 B 帐号做加法操作</li>\n<li>把结果写回 B 帐号中</li>\n</ul>\n<p>为了数据的一致性, 这 6 件事, 要么都成功做完, 要么都不成功, 而且这个操作的过程中, 对 A、B 帐号的其它访问必需锁死, 所谓锁死就是要排除其它的读写操作, 否则就会出现脏数据 ---- 即数据一致性的问题.</p>\n<p>这个问题并不仅仅出现在数据库操作中, 普通的并发以及并行操作都可能导致出现脏数据. 避免出现脏数据通常是从架构上避免或者采用事务的思想处理.</p>\n<h3 id="矛盾"><a href="#%E7%9F%9B%E7%9B%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>矛盾</h3>\n<ul>\n<li>1）要想让数据有高可用性，就得写多份数据</li>\n<li>2）写多份的问题会导致数据一致性的问题</li>\n<li>3）数据一致性的问题又会引发性能问题</li>\n</ul>\n<p>强一致性必然导致性能短板, 而弱一致性则有很好的性能但是存在数据安全(灾备数据丢失)/一致性(脏读/脏写等)的问题.</p>\n<p>目前 Node.js 业内流行的主要是与 Mongodb 配合, 在数据一致性方面属于短板.</p>\n<h3 id="事务"><a href="#%E4%BA%8B%E5%8A%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>事务</h3>\n<p>事务并不仅仅是 sql 数据库中的一个功能, 也是分布式系统开发中的一个思想, 事务在分布式的问题中可以称为 “两阶段提交” (以下引用陈皓原文)</p>\n<p>第一阶段：</p>\n<ul>\n<li>协调者会问所有的参与者结点，是否可以执行提交操作。</li>\n<li>各个参与者开始事务执行的准备工作：如：为资源上锁，预留资源，写 undo/redo log……</li>\n<li>参与者响应协调者，如果事务的准备工作成功，则回应“可以提交”，否则回应“拒绝提交”。</li>\n</ul>\n<p>第二阶段：</p>\n<ul>\n<li>如果所有的参与者都回应“可以提交”，那么，协调者向所有的参与者发送“正式提交”的命令。参与者完成正式提交，并释放所有资源，然后回应“完成”，协调者收集各结点的“完成”回应后结束这个 Global Transaction。</li>\n<li>如果有一个参与者回应“拒绝提交”，那么，协调者向所有的参与者发送“回滚操作”，并释放所有资源，然后回应“回滚完成”，协调者收集各结点的“回滚”回应后，取消这个 Global Transaction。</li>\n</ul>\n<p>异常:</p>\n<ul>\n<li>如果第一阶段中，参与者没有收到询问请求，或是参与者的回应没有到达协调者。那么，需要协调者做超时处理，一旦超时，可以当作失败，也可以重试。</li>\n<li>如果第二阶段中，正式提交发出后，如果有的参与者没有收到，或是参与者提交/回滚后的确认信息没有返回，一旦参与者的回应超时，要么重试，要么把那个参与者标记为问题结点剔除整个集群，这样可以保证服务结点都是数据一致性的。</li>\n<li>第二阶段中，如果参与者收不到协调者的 commit/fallback 指令，参与者将处于“状态未知”阶段，参与者完全不知道要怎么办。</li>\n</ul>\n<h2 id="缓存"><a href="#%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缓存</h2>\n<blockquote>\n<p>redis 与 memcached 的区别?</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>attr</th>\n<th>memcached</th>\n<th>redis</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>struct</td>\n<td>key/value</td>\n<td>key/value + list, set, hash etc.</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>×</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>Persistence</td>\n<td>×</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>transcations</td>\n<td>×</td>\n<td>✓</td>\n</tr>\n<tr>\n<td>consistency</td>\n<td>strong (by cas)</td>\n<td>weak</td>\n</tr>\n<tr>\n<td>thread</td>\n<td>multi</td>\n<td>single</td>\n</tr>\n<tr>\n<td>memory</td>\n<td>physical</td>\n<td>physical &#x26; swap</td>\n</tr>\n</tbody>\n</table>\n<h2 id="其他"><a href="#%E5%85%B6%E4%BB%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>其他</h2>\n<ul>\n<li>zookeeper</li>\n<li>kafka</li>\n<li>storm</li>\n<li>hadoop</li>\n<li>spark</li>\n</ul>\n<h1 id="安全"><a href="#%E5%AE%89%E5%85%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安全</h1>\n<h2 id="crypto"><a href="#crypto" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Crypto</h2>\n<p>Node.js 的 <code class="language-text">crypto</code> 模块封装了诸多的加密功能, 包括 OpenSSL 的哈希、HMAC、加密、解密、签名和验证函数等.</p>\n<p>Node.js 的加密貌似有点问题, 某些算法算出来跟别的语言 (比如 Python) 不一样. 具体情况还在整理中 (时间不定), 欢迎补充.</p>\n<blockquote>\n<p>加密是如何保证用户密码的安全性?</p>\n</blockquote>\n<p>在客户端加密, 是增加传输的过程中被第三方嗅探到密码后破解的成本. 对于游戏, 在客户端加密是防止外挂/破解等. 在服务端加密 (如 md5) 是避免管理数据库的 DBA 或者攻击者攻击数据库之后直接拿到明文密码, 从而提高安全性.</p>\n<h2 id="tlsssl"><a href="#tlsssl" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TLS/SSL</h2>\n<p>早期的网络传输协议由于只在大学内使用, 所以是默认互相信任的. 所以传统的网络通信可以说是没有考虑网络安全的. 早年的浏览器大厂网景公司为了应对这个情况设计了 SSL (Secure Socket Layer), SSL 的主要用途是:</p>\n<ol>\n<li>认证用户和服务器, 确保数据发送到正确的客户机和服务器;</li>\n<li>加密数据以防止数据中途被窃取;</li>\n<li>维护数据的完整性, 确保数据在传输过程中不被改变.</li>\n</ol>\n<p>存在三个特性:</p>\n<ul>\n<li>机密性：SSL 协议使用密钥加密通信数据</li>\n<li>可靠性：服务器和客户都会被认证, 客户的认证是可选的</li>\n<li>完整性：SSL 协议会对传送的数据进行完整性检查</li>\n</ul>\n<p>1999 年, SSL 因为应用广泛, 已经成为互联网上的事实标准. IETF 就在那年把 SSL 标准化/强化. 标准化之后的名称改为传输层安全协议 (Transport Layer Security, TLS). 很多相关的文章都把这两者并列称呼 (TLS/SSL), 因为这两者可以视作同一个东西的不同阶段.</p>\n<h2 id="https"><a href="#https" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HTTPS</h2>\n<p>在网络上, 每个网站都在各自的服务器上, 想要确保你访问的是一个正确的网站, 并且访问到这个网站正确的数据 (没有被劫持/篡改), 除了需要传输安全之外, 还需要安全的认证, 认证不能由目标网站进行, 否则恶意/钓鱼网站也可以自己说自己是对的, 所以为了能在网络上维护网络之间的基本信任, 早期的大厂们合力推动了一项名为 PKI 的基础设施, 通过第三方来认证网站.</p>\n<p>公钥基础设施 (Public Key Infrastructure, PKI) 是一种遵循标准的, 利用公钥加密技术为电子商务的开展提供一套安全基础平台的技术和规范. 其基础建置包含认证中心 (Certification Authority, CA) 、注册中心 (Register Authority, RA) 、目录服务 (Directory Service, DS) 服务器.</p>\n<p>由 RA 统筹、审核用户的证书申请, 将证书申请送至 CA 处理后发出证书, 并将证书公告至 DS 中. 在使用证书的过程中, 除了对证书的信任关系与证书本身的正确性做检查外, 并透过产生和发布证书废止列表 (Certificate Revocation List, CRL) 对证书的状态做确认检查, 了解证书是否因某种原因而遭废弃. 证书就像是个人的身分证, 其内容包括证书序号、用户名称、公开金钥 (Public Key) 、证书有效期限等.</p>\n<p>在 TLS/SSL 中你可以使用 OpenSSL 来生成 TLS/SSL 传输时用来认证的 public/private key. 不过这个 public/private key 是自己生成的, 而通过 PKI 基础设施可以获得权威的第三方证书 (key) 从而加密 HTTP 传输安全. 目前博客圈子里比较流行的是 <a href="https://imququ.com/post/letsencrypt-certificate.html" target="_blank" rel="nofollow noreferrer noopener">Let’s Encrypt 签发免费的 HTTPS 证书</a>.</p>\n<p>需要注意的是, 如果 PKI 受到攻击, 那么 HTTPS 也一样不安全. 可以参见 <a href="https://www.zhihu.com/question/22795329" target="_blank" rel="nofollow noreferrer noopener">HTTPS 劫持 - 知乎讨论</a> 中的情况, 证书由 CA 机构签发, 一般浏览器遇到非权威的 CA 机构是会告警的 (参见 <a href="https://kyfw.12306.cn/otn/" target="_blank" rel="nofollow noreferrer noopener">12306</a>), 但是如果你在某些特殊的情况下信任了某个未知机构/证书, 那么也可能被劫持.</p>\n<p>此外有的 CA 机构以邮件方式认证, 那么当某个网站的邮件服务收到攻击/渗透, 那么攻击者也可能以此从 CA 机构获取权威的正确的证书.</p>\n<h2 id="xss"><a href="#xss" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>XSS</h2>\n<p>跨站脚本 (Cross-Site Scripting, XSS) 是一种代码注入方式, 为了与 CSS 区分所以被称作 XSS. 早期常见于网络论坛, 起因是网站没有对用户的输入进行严格的限制, 使得攻击者可以将脚本上传到帖子让其他人浏览到有恶意脚本的页面, 其注入方式很简单包括但不限于 JavaScript / VBScript / CSS / Flash 等.</p>\n<p>当其他用户浏览到这些网页时, 就会执行这些恶意脚本, 对用户进行 Cookie 窃取/会话劫持/钓鱼欺骗等各种攻击. 其原理, 如使用 js 脚本收集当前用户环境的信息 (Cookie 等), 然后通过 img.src, Ajax, onclick/onload/onerror 事件等方式将用户数据传递到攻击者的服务器上. 钓鱼欺骗则常见于使用脚本进行视觉欺骗, 构建假的恶意的 Button 覆盖/替换真实的场景等情况 (该情况在用户上传 CSS 的时候也可能出现, 如早期淘宝网店装修, 使用 CSS 拼接假的评分数据等覆盖在真的评分数据上误导用户).</p>\n<blockquote>\n<p>过滤 Html 标签能否防止 XSS? 请列举不能的情况?</p>\n</blockquote>\n<p>用户除了上传</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9681050111652278000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script>\n  alert(\'xss\');\n</script>`, `9681050111652278000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                html 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">\'xss\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>还可以使用图片 url 等方式来上传脚本进行攻击</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26768034727976930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<table background=&quot;javascript:alert(/xss/)&quot;></table>\n<img src=&quot;javascript:alert(\'xss\')&quot; />`, `26768034727976930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                html 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">background</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:alert(/xss/)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:alert(\'xss\')<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>还可以使用各种方式来回避检查, 例如空格, 回车, Tab</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25525735603776110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<img\n  src=&quot;javas cript:\nalert(\'xss\')&quot;\n/>`, `25525735603776110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                html 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>\n  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javas cript:\nalert(\'xss\')<span class="token punctuation">"</span></span>\n<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还可以通过各种编码转换 (URL 编码, Unicode 编码, HTML 编码, ESCAPE 等) 来绕过检查</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23799922997468470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<img%20src=%22javascript:alert(\'xss\');%22>\n<img src=&quot;javascrip&#116&#58alert(/xss/)&quot;>`, `23799922997468470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">&lt;img%20src=%22javascript:alert(&#39;xss&#39;);%22&gt;\n&lt;img src=&quot;javascrip&amp;#116&amp;#58alert(/xss/)&quot;&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="csp-策略"><a href="#csp-%E7%AD%96%E7%95%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CSP 策略</h3>\n<p>在百般无奈, 没有统一解决方案的情况下, 厂商们推出了 CSP 策略.</p>\n<p>以 Node.js 为例, 计算脚本的 hashes 值:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23485627791378480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const crypto = require(\'crypto\');\n\nfunction getHashByCode(code, algorithm = \'sha256\') {\n  return (\n    algorithm +\n    \'-\' +\n    crypto\n      .createHash(algorithm)\n      .update(code, \'utf8\')\n      .digest(\'base64\')\n  );\n}\n\ngetHashByCode(\'console.log(&quot;hello world&quot;);\'); // \'sha256-wxWy1+9LmiuOeDwtQyZNmWpT0jqCUikqaqVlJdtdh/0=\'`, `23485627791378480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'crypto\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">getHashByCode</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> algorithm <span class="token operator">=</span> <span class="token string">\'sha256\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    algorithm <span class="token operator">+</span>\n    <span class="token string">\'-\'</span> <span class="token operator">+</span>\n    crypto\n      <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">\'utf8\'</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">\'base64\'</span><span class="token punctuation">)</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">getHashByCode</span><span class="token punctuation">(</span><span class="token string">\'console.log("hello world");\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \'sha256-wxWy1+9LmiuOeDwtQyZNmWpT0jqCUikqaqVlJdtdh/0=\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>设置 CSP 头:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92675317220085890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`content-security-policy: script-src \'sha256-wxWy1+9LmiuOeDwtQyZNmWpT0jqCUikqaqVlJdtdh/0=\'`, `92675317220085890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">content-security-policy: script-src &#39;sha256-wxWy1+9LmiuOeDwtQyZNmWpT0jqCUikqaqVlJdtdh/0=&#39;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37722065273632180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`<script>\n  console.log(\'hello geemo\');\n</script>\n<!-- 不执行 -->\n<script>\n  console.log(\'hello world\');\n</script>\n<!-- 执行 -->`, `37722065273632180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                html 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello geemo\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n<span class="token comment">&lt;!-- 不执行 --></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n<span class="token comment">&lt;!-- 执行 --></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>策略指令可以参见 <a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP/CSP_policy_directives" target="_blank" rel="nofollow noreferrer noopener">CSP Policy Directives</a>以及<a href="http://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="nofollow noreferrer noopener">阮一峰的博文</a>, <a href="https://imququ.com/post/content-security-policy-reference.html" target="_blank" rel="nofollow noreferrer noopener">屈大神的博文</a></p>\n<h2 id="csrf"><a href="#csrf" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CSRF</h2>\n<p>跨站请求伪造 <code class="language-text">(Cross-Site Request Forgery, CSRF, https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet)</code> 是一种伪造跨站请求的攻击方式. 例如利用你在 A 站 (攻击目标) 的 cookie / 权限等, 在 B 站 (恶意/钓鱼网站) 拼装 A 站的请求.</p>\n<p>比如 Q 君是某论坛管理员. 已知这个论坛 A 删除的接口是 post 到某个地址, 并指定一个帖子的 id. 那么我可以在自己的博客 B 上组织一个 CSRF 请求. 然后诱使 Q 君来访问我的博客. 就可以在 Q 君不知情的情况下删除掉我想删的某个帖子.</p>\n<p>钓鱼方式包括但不限于公开网站 (xss), 攻击者的恶意网站, email 邮件, 微博, 微信, 短信等及时消息.</p>\n<p>同源策略是最早用于防止 CSRF 的一种方式, 即关于跨站请求 (Cross-Site Request) 只有在同源/信任的情况下才可以请求. 但是如果一个网站群, 在互相信任的情况下, 某个网站出现了问题:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53630398610698490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a.public.com\nb.public.com\nc.public.com\n...`, `53630398610698490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">a.public.com\nb.public.com\nc.public.com\n...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上情况下, 如果 c.public.com 上没有预防 xss 等情况, 使得攻击者可以基于此站对其他信任的网站发起 CSRF 攻击.</p>\n<p>另外同源策略主要是浏览器来进行验证的, 并且不同浏览器的实现又各自不同, 所以在某些浏览器上可以直接绕过, 而且也可以直接通过短信等方式直接绕过浏览器.</p>\n<p>预防:</p>\n<ol>\n<li>A 站 (预防站) 检查 http 请求的 header 确认其 origin</li>\n<li>检查 CSRF token</li>\n</ol>\n<h3 id="1同源检查"><a href="#1%E5%90%8C%E6%BA%90%E6%A3%80%E6%9F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.同源检查</h3>\n<p>通过检查来过滤简单的 CSRF 攻击, 主要检查一下两个 header:</p>\n<ul>\n<li>Origin Header</li>\n<li>Referer Header</li>\n</ul>\n<h3 id="2csrf-token"><a href="#2csrf-token" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.CSRF token</h3>\n<p>简单来说, 对需要预防的请求, 通过特别的算法生成 token 存在 session 中, 然后将 token 隐藏在正确的界面表单中, 正式请求时带上该 token 在服务端验证, 避免跨站请求.</p>\n<h2 id="中间人攻击"><a href="#%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>中间人攻击</h2>\n<p>中间人 (Man-in-the-middle attack, MITM) 是指攻击者与通讯的两端分别创建独立的联系, 并交换其所收到的数据, 使通讯的两端认为他们正在通过一个私密的连接与对方直接对话, 但事实上整个会话都被攻击者完全控制. 在中间人攻击中, 攻击者可以拦截通讯双方的通话并插入新的内容.</p>\n<p>目前比较常见的是在公共场所放置精心准备的免费 wifi, 劫持/监控通过该 wifi 的流量. 或者攻击路由器, 连上你家 wifi 攻破你家 wifi 之后在上面劫持流量等.</p>\n<p>对于通信过程中的 MITM, 常见的方案是通过 PKI / TLS 预防, 及时是通过存在第三方中间人的 wifi 你通过 HTTPS 访问的页面依旧是安全的. 而 HTTP 协议是明文传输, 则没有任何防护可言.</p>\n<p>不常见的还有强力的互相认证, 你确认他之后, 他也确认你一下; 延迟测试, 统计传输时间, 如果通讯延迟过高则认为可能存在第三方中间人; 等等.</p>\n<h2 id="sqlnosql-注入"><a href="#sqlnosql-%E6%B3%A8%E5%85%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SQL/NoSQL 注入</h2>\n<p>注入攻击是指当所执行的一些操作中有部分由用户传入时, 用户可以将其恶意逻辑注入到操作中. 当你使用 eval, new Function 等方式执行的字符串中有用户输入的部分时, 就可能被注入攻击. 上文中的 XSS 就属于一种注入攻击. 前面的章节中也提到过 Node.js 的 child_process.exec 由于调用 bash 解析, 如果执行的命令中有部分属于用户输入, 也可能被注入攻击.</p>\n<h3 id="sql"><a href="#sql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SQL</h3>\n<p>Sql 注入是网站常见的一种注入攻击方式. 其原因主要是由于登录时需要验证用户名/密码, 其执行 sql 类似:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57886106642046740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SELECT * FROM users WHERE usernae = \'myName\' AND password = \'mySecret\';`, `57886106642046740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                sql 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> usernae <span class="token operator">=</span> <span class="token string">\'myName\'</span> <span class="token operator">AND</span> password <span class="token operator">=</span> <span class="token string">\'mySecret\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>其中的用户名和密码属于用户输入的部分, 那么在未做检查的情况下, 用户可能拼接恶意的字符串来达到其某种目的, 例如上传密码为 <code class="language-text">&#39;; DROP TABLE users; --</code> 使得最终执行的内容为:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92533065274676260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SELECT * FROM users WHERE usernae = \'myName\' AND password = \'\'; DROP TABLE users; --\';`, `92533065274676260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                sql 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="sql"><pre style="counter-reset: linenumber NaN" class="language-sql line-numbers"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> usernae <span class="token operator">=</span> <span class="token string">\'myName\'</span> <span class="token operator">AND</span> password <span class="token operator">=</span> <span class="token string">\'\'</span><span class="token punctuation">;</span> <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> users<span class="token punctuation">;</span> <span class="token comment">--\';</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>其能实现的功能, 包括但不限于删除数据 (经济损失), 篡改数据 (密码等), 窃取数据 (网站管理权限, 用户数据) 等. 防治手段常见于:</p>\n<ul>\n<li>给表名/字段名加前缀 (避免被猜到)</li>\n<li>报错隐藏表信息 (避免被看到, 12306 早期就出现过的问题)</li>\n<li>过滤可以拼接 SQL 的关键字符</li>\n<li>对用户输入进行转义</li>\n<li>验证用户输入的类型 (避免 limit, order by 等注入)</li>\n</ul>\n<h3 id="nosql"><a href="#nosql" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>NoSQL</h3>\n<p>看个简单的情况:</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13074186139089461000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`let { user, pass, age } = ctx.query;\n\ndb.collection.find({\n  user,\n  pass,\n  \\$where: \\`this.age >= \\${age}\\`\n});`, `13074186139089461000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">let</span> <span class="token punctuation">{</span> user<span class="token punctuation">,</span> pass<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>\n\ndb<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  user<span class="token punctuation">,</span>\n  pass<span class="token punctuation">,</span>\n  $where<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this.age >= </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么这里的 age 就可以注入了. 另外 GET/POST 还可以传递深层结构 (比如 <code class="language-text">?name[0]=alan</code> 传递上来), 通过 qs 之类的模块解析后导致注入, 如 <a href="https://github.com/cnodejs/nodeclub/commit/0f6cc14f6bcbbe6b4de3199c6896efaec637693e" target="_blank" rel="nofollow noreferrer noopener">cnodejs 遭遇 mongodb 注入</a>.</p>',
id:"/github/workspace/blog/Node.js面试入门/index.md absPath of file >>> MarkdownRemark",timeToRead:78,frontmatter:{date:"2021-02-26 18:27:10",path:"/nodejs-interview-introduce-learn/",tags:"后端, nodejs",title:"Node.js面试入门",draft:null}},{excerpt:"Diff 算法 概览 在 beginWork 一节我们提到 对于 update 的组件，他会将当前组件与该组件在上次更新时对应的 Fiber 节点比较（也就是俗称的 Diff 算法），将比较的结果生成新 Fiber 节点。 这一章我们讲解 Diff 算法的实现。 你可以从 这里 看到 Diff 算法的介绍。 为了防止概念混淆，这里再强调下 一个 DOM 节点在某一时刻最多会有 4 个节点和他相关。 current Fiber。如果该 DOM 节点已在页面中，current Fiber…",html:'<h1 id="diff-算法"><a href="#diff-%E7%AE%97%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Diff 算法</h1>\n<h2 id="概览"><a href="#%E6%A6%82%E8%A7%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概览</h2>\n<p>在 beginWork 一节我们提到</p>\n<blockquote>\n<p>对于 update 的组件，他会将当前组件与该组件在上次更新时对应的 Fiber 节点比较（也就是俗称的 Diff 算法），将比较的结果生成新 Fiber 节点。</p>\n</blockquote>\n<p>这一章我们讲解 Diff 算法的实现。</p>\n<p>你可以从<a href="https://zh-hans.reactjs.org/docs/reconciliation.html#the-diffing-algorithm" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 Diff 算法的介绍。</p>\n<p>为了防止概念混淆，这里再强调下</p>\n<p>一个 DOM 节点在某一时刻最多会有 4 个节点和他相关。</p>\n<ol>\n<li>current Fiber。如果该 DOM 节点已在页面中，current Fiber 代表该 DOM 节点对应的 Fiber 节点。</li>\n<li>workInProgress Fiber。如果该 DOM 节点将在本次更新中渲染到页面中，workInProgress Fiber 代表该 DOM 节点对应的 Fiber 节点。</li>\n<li>DOM 节点本身。</li>\n<li>JSX 对象。即 ClassComponent 的 render 方法的返回结果，或 FunctionComponent 的调用结果。JSX 对象中包含描述 DOM 节点的信息。</li>\n</ol>\n<p>Diff 算法的本质是对比 1 和 4，生成 2。</p>\n<h3 id="diff-的瓶颈以及-react-如何应对"><a href="#diff-%E7%9A%84%E7%93%B6%E9%A2%88%E4%BB%A5%E5%8F%8A-react-%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Diff 的瓶颈以及 React 如何应对</h3>\n<p>由于 Diff 操作本身也会带来性能损耗，React 文档中提到，即使在最前沿的算法中，将前后两棵树完全比对的算法的复杂程度为 <code class="language-text">O(n^3)</code>，其中 n 是树中元素的数量。</p>\n<p>如果在 React 中使用了该算法，那么展示 1000 个元素所需要执行的计算量将在十亿的量级范围。这个开销实在是太过高昂。</p>\n<p>为了降低算法复杂度，React 的 diff 会预设三个限制：</p>\n<ol>\n<li>只对同级元素进行 Diff。如果一个 DOM 节点在前后两次更新中跨越了层级，那么 React 不会尝试复用他。</li>\n<li>两个不同类型的元素会产生出不同的树。如果元素由 div 变为 p，React 会销毁 div 及其子孙节点，并新建 p 及其子孙节点。</li>\n<li>开发者可以通过 key prop 来暗示哪些子元素在不同的渲染下能保持稳定。考虑如下例子：</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74714284634090820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 更新前\n<div>\n  <p key=&quot;ka&quot;>ka</p>\n  <h3 key=&quot;song&quot;>song</h3>\n</div>\n\n// 更新后\n<div>\n  <h3 key=&quot;song&quot;>song</h3>\n  <p key=&quot;ka&quot;>ka</p>\n</div>`, `74714284634090820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 更新前</span>\n<span class="token operator">&lt;</span>div<span class="token operator">></span>\n  <span class="token operator">&lt;</span>p key<span class="token operator">=</span><span class="token string">"ka"</span><span class="token operator">></span>ka<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>\n  <span class="token operator">&lt;</span>h3 key<span class="token operator">=</span><span class="token string">"song"</span><span class="token operator">></span>song<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n\n<span class="token comment">// 更新后</span>\n<span class="token operator">&lt;</span>div<span class="token operator">></span>\n  <span class="token operator">&lt;</span>h3 key<span class="token operator">=</span><span class="token string">"song"</span><span class="token operator">></span>song<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">></span>\n  <span class="token operator">&lt;</span>p key<span class="token operator">=</span><span class="token string">"ka"</span><span class="token operator">></span>ka<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果没有 key，React 会认为 div 的第一个子节点由 p 变为 h3，第二个子节点由 h3 变为 p。这符合限制 2 的设定，会销毁并新建。</p>\n<p>但是当我们用 key 指明了节点前后对应关系后，React 知道 <code class="language-text">key === &quot;ka&quot;</code> 的 p 在更新后还存在，所以 DOM 节点可以复用，只是需要交换下顺序。</p>\n<p>这就是 React 为了应对算法性能瓶颈做出的三条限制。</p>\n<h3 id="diff-是如何实现的"><a href="#diff-%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Diff 是如何实现的</h3>\n<p>我们从 Diff 的入口函数 reconcileChildFibers 出发，该函数会根据 newChild（即 JSX 对象）类型调用不同的处理函数。</p>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L1280" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 reconcileChildFibers 的源码。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31023547791691050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 根据 newChild 类型选择不同 diff 函数处理\nfunction reconcileChildFibers(returnFiber: Fiber, currentFirstChild: Fiber | null, newChild: any): Fiber | null {\n  const isObject = typeof newChild === \'object\' && newChild !== null;\n\n  if (isObject) {\n    // object 类型，可能是 REACT_ELEMENT_TYPE 或 REACT_PORTAL_TYPE\n    switch (newChild.\\$\\$typeof) {\n      case REACT_ELEMENT_TYPE:\n      // 调用 reconcileSingleElement 处理\n      // // ...省略其他 case\n    }\n  }\n\n  if (typeof newChild === \'string\' || typeof newChild === \'number\') {\n    // 调用 reconcileSingleTextNode 处理\n    // ...省略\n  }\n\n  if (isArray(newChild)) {\n    // 调用 reconcileChildrenArray 处理\n    // ...省略\n  }\n\n  // 一些其他情况调用处理函数\n  // ...省略\n\n  // 以上都没有命中，删除节点\n  return deleteRemainingChildren(returnFiber, currentFirstChild);\n}`, `31023547791691050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 根据 newChild 类型选择不同 diff 函数处理</span>\n<span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> newChild<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">\'object\'</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// object 类型，可能是 REACT_ELEMENT_TYPE 或 REACT_PORTAL_TYPE</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">:</span>\n      <span class="token comment">// 调用 reconcileSingleElement 处理</span>\n      <span class="token comment">// // ...省略其他 case</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">\'string\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">\'number\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 调用 reconcileSingleTextNode 处理</span>\n    <span class="token comment">// ...省略</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 调用 reconcileChildrenArray 处理</span>\n    <span class="token comment">// ...省略</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 一些其他情况调用处理函数</span>\n  <span class="token comment">// ...省略</span>\n\n  <span class="token comment">// 以上都没有命中，删除节点</span>\n  <span class="token keyword">return</span> <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以从同级的节点数量将 Diff 分为两类：</p>\n<ol>\n<li>当 newChild 类型为 object、number、string，代表同级只有一个节点</li>\n<li>当 newChild 类型为 Array，同级有多个节点</li>\n</ol>\n<p>在接下来两节我们会分别讨论这两类节点的 Diff。</p>\n<h2 id="单节点-diff"><a href="#%E5%8D%95%E8%8A%82%E7%82%B9-diff" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单节点 Diff</h2>\n<p>对于单个节点，我们以类型 object 为例，会进入 reconcileSingleElement</p>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L1141" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 reconcileSingleElement 源码</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45309974283912790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const isObject = typeof newChild === \'object\' && newChild !== null;\n\nif (isObject) {\n  // 对象类型，可能是 REACT_ELEMENT_TYPE 或 REACT_PORTAL_TYPE\n  switch (newChild.\\$\\$typeof) {\n    case REACT_ELEMENT_TYPE:\n    // 调用 reconcileSingleElement 处理\n    // ...其他 case\n  }\n}`, `45309974283912790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">\'object\'</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 对象类型，可能是 REACT_ELEMENT_TYPE 或 REACT_PORTAL_TYPE</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">:</span>\n    <span class="token comment">// 调用 reconcileSingleElement 处理</span>\n    <span class="token comment">// ...其他 case</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个函数会做如下事情：</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-29-14-33-49-aa6f372038f19dc1f6e0686e17c0fbd1-4114c.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 76.99115044247787%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABfElEQVQoz42SDU/CMBCG+f//w4RgQgSjYYnJwBgwfiCKDAGRCIPwMXFs6z7au6sdE1AggVvTNb0+ubfvNSV3IhBoeaFAlIcilfxIDZJIcsFlpd7KanrLtKJ4kw7DAkgAAko7wpuqcVm6bQ+t8Hh4fYxFYimbjpWtyq5hzoXrecldjoKVYFpdnoG0QfLDfq1gVQpAVZdWgE/vA/2uZgxmDGNFQNIPQo/5EDtKe+CIiyTBBPWmdq1rjmzGSQmJd3EZCgakvbI3hikFyrNdkerIfjhxW32uYPPQmXpzFzwfwmPheEbQO+XCq567L2TKOWPSlstWL8UTEKpnl6z3V5741sidmIvx0BnbkfO/stzq/fYjCSFiEPrIAwg58tgCQheYGgvBbO45gjnAIuB/YCQ1AoBiu3JRu8o/aJpRfJt1VcqJvPOqli5m06Vs/lHLXJ+d6Kcf1ucG/vWZ0GTjjtWrD5o9x7SC77iLwI1Ru95vvvSNxrCl1s/9xpcfp34ACeNlJbpoUCgAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 29 14 33 49"\n        title=""\n        src="/static/2021-01-29-14-33-49-aa6f372038f19dc1f6e0686e17c0fbd1-fee1c.png"\n        srcset="/static/2021-01-29-14-33-49-aa6f372038f19dc1f6e0686e17c0fbd1-a67b7.png 200w,\n/static/2021-01-29-14-33-49-aa6f372038f19dc1f6e0686e17c0fbd1-0b187.png 400w,\n/static/2021-01-29-14-33-49-aa6f372038f19dc1f6e0686e17c0fbd1-fee1c.png 800w,\n/static/2021-01-29-14-33-49-aa6f372038f19dc1f6e0686e17c0fbd1-b1a91.png 1200w,\n/static/2021-01-29-14-33-49-aa6f372038f19dc1f6e0686e17c0fbd1-4114c.png 1582w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>让我们看看第二步判断 DOM 节点是否可以复用是如何实现的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6400387690772336000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function reconcileSingleElement(returnFiber: Fiber, currentFirstChild: Fiber | null, element: ReactElement): Fiber {\n  const key = element.key;\n  let child = currentFirstChild;\n\n  // 首先判断是否存在对应 DOM 节点\n  while (child !== null) {\n    // 上一次更新存在 DOM 节点，接下来判断是否可复用\n\n    // 首先比较 key 是否相同\n    if (child.key === key) {\n      // key 相同，接下来比较 type 是否相同\n\n      switch (child.tag) {\n        // ...省略 case\n\n        default: {\n          if (child.elementType === element.type) {\n            // type 相同则表示可以复用\n            // 返回复用的 fiber\n            return existing;\n          }\n\n          // type 不同则跳出 switch\n          break;\n        }\n      }\n      // 代码执行到这里代表：key 相同但是 type 不同\n      // 将该 fiber 及其兄弟 fiber 标记为删除\n      deleteRemainingChildren(returnFiber, child);\n      break;\n    } else {\n      // key 不同，将该 fiber 标记为删除\n      deleteChild(returnFiber, child);\n    }\n    child = child.sibling;\n  }\n\n  // 创建新Fiber，并返回 ...省略\n}`, `6400387690772336000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> element<span class="token punctuation">:</span> ReactElement</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> key <span class="token operator">=</span> element<span class="token punctuation">.</span>key<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> child <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>\n\n  <span class="token comment">// 首先判断是否存在对应 DOM 节点</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 上一次更新存在 DOM 节点，接下来判断是否可复用</span>\n\n    <span class="token comment">// 首先比较 key 是否相同</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// key 相同，接下来比较 type 是否相同</span>\n\n      <span class="token keyword">switch</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// ...省略 case</span>\n\n        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>elementType <span class="token operator">===</span> element<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// type 相同则表示可以复用</span>\n            <span class="token comment">// 返回复用的 fiber</span>\n            <span class="token keyword">return</span> existing<span class="token punctuation">;</span>\n          <span class="token punctuation">}</span>\n\n          <span class="token comment">// type 不同则跳出 switch</span>\n          <span class="token keyword">break</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 代码执行到这里代表：key 相同但是 type 不同</span>\n      <span class="token comment">// 将该 fiber 及其兄弟 fiber 标记为删除</span>\n      <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">break</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// key 不同，将该 fiber 标记为删除</span>\n      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    child <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 创建新Fiber，并返回 ...省略</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还记得我们刚才提到的，React 预设的限制么，</p>\n<p>从代码可以看出，React 通过先判断 key 是否相同，如果 key 相同则判断 type 是否相同，只有都相同时一个 DOM 节点才能复用。</p>\n<p>这里有个细节需要关注下：</p>\n<ul>\n<li>当 child !== null 且 key 相同且 type 不同时执行 deleteRemainingChildren 将 child 及其兄弟 fiber 都标记删除。</li>\n<li>当 child !== null 且 key 不同时仅将 child 标记删除。</li>\n</ul>\n<p>考虑如下例子：</p>\n<p>当前页面有 3 个 li，我们要全部删除，再插入一个 p。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54574193807012540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 当前页面显示的\nul > li * 3\n\n// 这次需要更新的\nul > p`, `54574193807012540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 当前页面显示的\nul &gt; li * 3\n\n// 这次需要更新的\nul &gt; p</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于本次更新时只有一个 p，属于单一节点的 Diff，会走上面介绍的代码逻辑。</p>\n<p>在 reconcileSingleElement 中遍历之前的 3 个 fiber（对应的 DOM 为 3 个 li），寻找本次更新的 p 是否可以复用之前的 3 个 fiber 中某个的 DOM。</p>\n<p>当 key 相同且 type 不同时，代表我们已经找到本次更新的 p 对应的上次的 fiber，但是 p 与 li type 不同，不能复用。既然唯一的可能性已经不能复用，则剩下的 fiber 都没有机会了，所以都需要标记删除。</p>\n<p>当 key 不同时只代表遍历到的该 fiber 不能被 p 复用，后面还有兄弟 fiber 还没有遍历到。所以仅仅标记该 fiber 删除。</p>\n<h3 id="练习题"><a href="#%E7%BB%83%E4%B9%A0%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>练习题</h3>\n<p>让我们来做几道习题巩固下吧：</p>\n<p>请判断如下 JSX 对象对应的 DOM 元素是否可以复用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61289464068770650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 习题1 更新前\n<div>ka song</div>\n// 更新后\n<p>ka song</p>\n\n// 习题2 更新前\n<div key=&quot;xxx&quot;>ka song</div>\n// 更新后\n<div key=&quot;ooo&quot;>ka song</div>\n\n// 习题3 更新前\n<div key=&quot;xxx&quot;>ka song</div>\n// 更新后\n<p key=&quot;ooo&quot;>ka song</p>\n\n// 习题4 更新前\n<div key=&quot;xxx&quot;>ka song</div>\n// 更新后\n<div key=&quot;xxx&quot;>xiao bei</div>`, `61289464068770650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 习题1 更新前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token comment">// 更新后</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>\n\n<span class="token comment">// 习题2 更新前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xxx<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token comment">// 更新后</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ooo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n\n<span class="token comment">// 习题3 更新前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xxx<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token comment">// 更新后</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ooo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>\n\n<span class="token comment">// 习题4 更新前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xxx<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">ka song</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n<span class="token comment">// 更新后</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>xxx<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">xiao bei</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>公布答案：</p>\n<p>习题 1: 未设置 key prop 默认 key = null;，所以更新前后 key 相同，都为 null，但是更新前 type 为 div，更新后为 p，type 改变则不能复用。</p>\n<p>习题 2: 更新前后 key 改变，不需要再判断 type，不能复用。</p>\n<p>习题 3: 更新前后 key 改变，不需要再判断 type，不能复用。</p>\n<p>习题 4: 更新前后 key 与 type 都未改变，可以复用。children 变化，DOM 的子元素需要更新。</p>\n<h2 id="多节点-diff"><a href="#%E5%A4%9A%E8%8A%82%E7%82%B9-diff" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多节点 Diff</h2>\n<p>上一节我们介绍了单一节点的 Diff，现在考虑我们有一个 FunctionComponent：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23242963097755197000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function List() {\n  return (\n    <ul>\n      <li key=\'0\'>0</li>\n      <li key=\'1\'>1</li>\n      <li key=\'2\'>2</li>\n      <li key=\'3\'>3</li>\n    </ul>\n  );\n}`, `23242963097755197000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>0<span class="token punctuation">\'</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>1<span class="token punctuation">\'</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>2<span class="token punctuation">\'</span></span><span class="token punctuation">></span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">\'</span>3<span class="token punctuation">\'</span></span><span class="token punctuation">></span></span><span class="token plain-text">3</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>他的返回值 JSX 对象的 children 属性不是单一节点，而是包含四个对象的数组</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20786201062757280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  \\$\\$typeof: Symbol(react.element),\n  key: null,\n  props: {\n    children: [\n      {\\$\\$typeof: Symbol(react.element), type: &quot;li&quot;, key: &quot;0&quot;, ref: null, props: {…}, …}\n      {\\$\\$typeof: Symbol(react.element), type: &quot;li&quot;, key: &quot;1&quot;, ref: null, props: {…}, …}\n      {\\$\\$typeof: Symbol(react.element), type: &quot;li&quot;, key: &quot;2&quot;, ref: null, props: {…}, …}\n      {\\$\\$typeof: Symbol(react.element), type: &quot;li&quot;, key: &quot;3&quot;, ref: null, props: {…}, …}\n    ]\n  },\n  ref: null,\n  type: &quot;ul&quot;\n}`, `20786201062757280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  key<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  props<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n      <span class="token punctuation">{</span>$$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">"li"</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span>\n      <span class="token punctuation">{</span>$$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">"li"</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span>\n      <span class="token punctuation">{</span>$$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">"li"</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span>\n      <span class="token punctuation">{</span>$$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token string">"li"</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  ref<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  type<span class="token punctuation">:</span> <span class="token string">"ul"</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种情况下，reconcileChildFibers 的 newChild 参数类型为 Array，在 reconcileChildFibers 函数内部对应如下情况：</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L1352" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段源码逻辑</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50273937551073700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (isArray(newChild)) {\n  // 调用 reconcileChildrenArray 处理\n  // ...省略\n}`, `50273937551073700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 调用 reconcileChildrenArray 处理</span>\n  <span class="token comment">// ...省略</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这一节我们来看看，如何处理同级多个节点的 Diff。</p>\n<h3 id="概览-1"><a href="#%E6%A6%82%E8%A7%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概览</h3>\n<p>首先归纳下我们需要处理的情况：</p>\n<p>我们以之前代表更新前的 JSX 对象，之后代表更新后的 JSX 对象</p>\n<h4 id="情况-1：节点更新"><a href="#%E6%83%85%E5%86%B5-1%EF%BC%9A%E8%8A%82%E7%82%B9%E6%9B%B4%E6%96%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>情况 1：节点更新</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30065333623977010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 之前\n<ul>\n  <li key=&quot;0&quot; className=&quot;before&quot;>0<li>\n  <li key=&quot;1&quot;>1<li>\n</ul>\n\n// 之后 情况1 —— 节点属性变化\n<ul>\n  <li key=&quot;0&quot; className=&quot;after&quot;>0<li>\n  <li key=&quot;1&quot;>1<li>\n</ul>\n\n// 之后 情况2 —— 节点类型更新\n<ul>\n  <div key=&quot;0&quot;>0</div>\n  <li key=&quot;1&quot;>1<li>\n</ul>`, `30065333623977010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 之前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>before<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n\n// 之后 情况1 —— 节点属性变化\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>after<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n\n// 之后 情况2 —— 节点类型更新\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="情况-2：节点新增或减少"><a href="#%E6%83%85%E5%86%B5-2%EF%BC%9A%E8%8A%82%E7%82%B9%E6%96%B0%E5%A2%9E%E6%88%96%E5%87%8F%E5%B0%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>情况 2：节点新增或减少</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1220027108362398200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 之前\n<ul>\n  <li key=&quot;0&quot;>0<li>\n  <li key=&quot;1&quot;>1<li>\n</ul>\n\n// 之后 情况1 —— 新增节点\n<ul>\n  <li key=&quot;0&quot;>0<li>\n  <li key=&quot;1&quot;>1<li>\n  <li key=&quot;2&quot;>2<li>\n</ul>\n\n// 之后 情况2 —— 删除节点\n<ul>\n  <li key=&quot;1&quot;>1<li>\n</ul>`, `1220027108362398200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 之前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n\n// 之后 情况1 —— 新增节点\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n\n// 之后 情况2 —— 删除节点\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="情况-3：节点位置变化"><a href="#%E6%83%85%E5%86%B5-3%EF%BC%9A%E8%8A%82%E7%82%B9%E4%BD%8D%E7%BD%AE%E5%8F%98%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>情况 3：节点位置变化</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48236325884081020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 之前\n<ul>\n  <li key=&quot;0&quot;>0<li>\n  <li key=&quot;1&quot;>1<li>\n</ul>\n\n// 之后\n<ul>\n  <li key=&quot;1&quot;>1<li>\n  <li key=&quot;0&quot;>0<li>\n</ul>`, `48236325884081020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 之前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n\n// 之后\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">\n</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同级多个节点的 Diff，一定属于以上三种情况中的一种或多种。</p>\n<h3 id="diff-的思路"><a href="#diff-%E7%9A%84%E6%80%9D%E8%B7%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Diff 的思路</h3>\n<p>该如何设计算法呢？如果让我设计一个 Diff 算法，我首先想到的方案是：</p>\n<ol>\n<li>判断当前节点的更新属于哪种情况</li>\n<li>如果是新增，执行新增逻辑</li>\n<li>如果是删除，执行删除逻辑</li>\n<li>如果是更新，执行更新逻辑</li>\n</ol>\n<p>按这个方案，其实有个隐含的前提——不同操作的优先级是相同的</p>\n<p>但是 React 团队发现，在日常开发中，相较于新增和删除，更新组件发生的频率更高。所以 Diff 会优先判断当前节点是否属于更新。</p>\n<blockquote>\n<p>注意</p>\n<p>在我们做数组相关的算法题时，经常使用双指针从数组头和尾同时遍历以提高效率，但是这里却不行。</p>\n<p>虽然本次更新的 JSX 对象 newChildren 为数组形式，但是和 newChildren 中每个组件进行比较的是 current fiber，同级的 Fiber 节点是由 sibling 指针链接形成的单链表，即不支持双指针遍历。</p>\n<p>即 <code class="language-text">newChildren[0]</code> 与 fiber 比较，<code class="language-text">newChildren[1]</code> 与 fiber.sibling 比较。</p>\n<p>所以无法使用双指针优化。</p>\n</blockquote>\n<p>基于以上原因，Diff 算法的整体逻辑会经历两轮遍历：</p>\n<p>第一轮遍历：处理更新的节点。</p>\n<p>第二轮遍历：处理剩下的不属于更新的节点。</p>\n<h3 id="第一轮遍历"><a href="#%E7%AC%AC%E4%B8%80%E8%BD%AE%E9%81%8D%E5%8E%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第一轮遍历</h3>\n<p>第一轮遍历步骤如下：</p>\n<ol>\n<li>let i = 0，遍历 newChildren，将 <code class="language-text">newChildren[i]</code> 与 oldFiber 比较，判断 DOM 节点是否可复用。</li>\n<li>如果可复用，i++，继续比较 <code class="language-text">newChildren[i]</code> 与 oldFiber.sibling，可以复用则继续遍历。</li>\n<li>\n<p>如果不可复用，分两种情况：</p>\n<ol>\n<li>key 不同导致不可复用，立即跳出整个遍历，第一轮遍历结束。</li>\n<li>key 相同 type 不同导致不可复用，会将 oldFiber 标记为 DELETION，并继续遍历</li>\n</ol>\n</li>\n<li>如果 newChildren 遍历完（即 i === newChildren.length - 1）或者 oldFiber 遍历完（即 oldFiber.sibling === null），跳出遍历，第一轮遍历结束。</li>\n</ol>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L818" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这轮遍历的源码</p>\n</blockquote>\n<p>当遍历结束后，会有两种结果：</p>\n<h4 id="步骤-3-跳出的遍历"><a href="#%E6%AD%A5%E9%AA%A4-3-%E8%B7%B3%E5%87%BA%E7%9A%84%E9%81%8D%E5%8E%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤 3 跳出的遍历</h4>\n<p>此时 newChildren 没有遍历完，oldFiber 也没有遍历完。</p>\n<p>举个例子，考虑如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50427889701452400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 之前\n<li key=&quot;0&quot;>0</li>\n<li key=&quot;1&quot;>1</li>\n<li key=&quot;2&quot;>2</li>\n\n// 之后\n<li key=&quot;0&quot;>0</li>\n<li key=&quot;2&quot;>1</li>\n<li key=&quot;1&quot;>2</li>`, `50427889701452400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 之前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n\n<span class="token comment">// 之后</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第一个节点可复用，遍历到 key === 2 的节点发现 key 改变，不可复用，跳出遍历，等待第二轮遍历处理。</p>\n<p>此时 oldFiber 剩下 key === 1、key === 2 未遍历，newChildren 剩下 key === 2、key === 1 未遍历。</p>\n<h4 id="步骤-4-跳出的遍历"><a href="#%E6%AD%A5%E9%AA%A4-4-%E8%B7%B3%E5%87%BA%E7%9A%84%E9%81%8D%E5%8E%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>步骤 4 跳出的遍历</h4>\n<p>可能 newChildren 遍历完，或 oldFiber 遍历完，或他们同时遍历完。</p>\n<p>举个例子，考虑如下代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62983636750062600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 之前\n<li key=&quot;0&quot; className=&quot;a&quot;>0</li>\n<li key=&quot;1&quot; className=&quot;b&quot;>1</li>\n\n// 之后 情况1 —— newChildren 与 oldFiber 都遍历完\n<li key=&quot;0&quot; className=&quot;aa&quot;>0</li>\n<li key=&quot;1&quot; className=&quot;bb&quot;>1</li>\n\n// 之后 情况2 —— newChildren 没遍历完，oldFiber 遍历完\n// newChildren 剩下 key === &quot;2&quot; 未遍历\n<li key=&quot;0&quot; className=&quot;aa&quot;>0</li>\n<li key=&quot;1&quot; className=&quot;bb&quot;>1</li>\n<li key=&quot;2&quot; className=&quot;cc&quot;>2</li>\n\n// 之后 情况3 —— newChildren 遍历完，oldFiber 没遍历完\n// oldFiber 剩下 key === &quot;1&quot; 未遍历\n<li key=&quot;0&quot; className=&quot;aa&quot;>0</li>`, `62983636750062600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 之前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>b<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n\n<span class="token comment">// 之后 情况1 —— newChildren 与 oldFiber 都遍历完</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aa<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bb<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n\n<span class="token comment">// 之后 情况2 —— newChildren 没遍历完，oldFiber 遍历完</span>\n<span class="token comment">// newChildren 剩下 key === "2" 未遍历</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aa<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bb<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cc<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">2</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n\n<span class="token comment">// 之后 情况3 —— newChildren 遍历完，oldFiber 没遍历完</span>\n<span class="token comment">// oldFiber 剩下 key === "1" 未遍历</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aa<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">0</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带着第一轮遍历的结果，我们开始第二轮遍历。</p>\n<h3 id="第二轮遍历"><a href="#%E7%AC%AC%E4%BA%8C%E8%BD%AE%E9%81%8D%E5%8E%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二轮遍历</h3>\n<p>对于第一轮遍历的结果，我们分别讨论：</p>\n<h4 id="newchildren-与-oldfiber-同时遍历完"><a href="#newchildren-%E4%B8%8E-oldfiber-%E5%90%8C%E6%97%B6%E9%81%8D%E5%8E%86%E5%AE%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>newChildren 与 oldFiber 同时遍历完</h4>\n<p>那就是最理想的情况：只需在第一轮遍历进行组件更新。此时 Diff 结束。</p>\n<h4 id="newchildren-没遍历完，oldfiber-遍历完"><a href="#newchildren-%E6%B2%A1%E9%81%8D%E5%8E%86%E5%AE%8C%EF%BC%8Coldfiber-%E9%81%8D%E5%8E%86%E5%AE%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>newChildren 没遍历完，oldFiber 遍历完</h4>\n<p>已有的 DOM 节点都复用了，这时还有新加入的节点，意味着本次更新有新节点插入，我们只需要遍历剩下的 newChildren 为生成的 workInProgress fiber 依次标记 Placement。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L869" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段源码逻辑</p>\n</blockquote>\n<h4 id="newchildren-遍历完，oldfiber-没遍历完"><a href="#newchildren-%E9%81%8D%E5%8E%86%E5%AE%8C%EF%BC%8Coldfiber-%E6%B2%A1%E9%81%8D%E5%8E%86%E5%AE%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>newChildren 遍历完，oldFiber 没遍历完</h4>\n<p>意味着本次更新比之前的节点数量少，有节点被删除了。所以需要遍历剩下的 oldFiber，依次标记 Deletion。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L863" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段源码逻辑</p>\n</blockquote>\n<h4 id="newchildren-与-oldfiber-都没遍历完"><a href="#newchildren-%E4%B8%8E-oldfiber-%E9%83%BD%E6%B2%A1%E9%81%8D%E5%8E%86%E5%AE%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>newChildren 与 oldFiber 都没遍历完</h4>\n<p>这意味着有节点在这次更新中改变了位置。</p>\n<p>这是 Diff 算法最精髓也是最难懂的部分。我们接下来会重点讲解。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L893" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段源码逻辑</p>\n</blockquote>\n<h3 id="处理移动的节点"><a href="#%E5%A4%84%E7%90%86%E7%A7%BB%E5%8A%A8%E7%9A%84%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>处理移动的节点</h3>\n<p>由于有节点改变了位置，所以不能再用位置索引 i 对比前后的节点，那么如何才能将同一个节点在两次更新中对应上呢？</p>\n<p>我们需要使用 key。</p>\n<p>为了快速的找到 key 对应的 oldFiber，我们将所有还未处理的 oldFiber 存入以 key 为 key，oldFiber 为 value 的 Map 中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14393186263347313000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const existingChildren = mapRemainingChildren(returnFiber, oldFiber);`, `14393186263347313000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactChildFiber.new.js#L890" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段源码逻辑</p>\n</blockquote>\n<p>接下来遍历剩余的 newChildren，通过 <code class="language-text">newChildren[i].key</code> 就能在 existingChildren 中找到 key 相同的 oldFiber。</p>\n<h3 id="标记节点是否移动"><a href="#%E6%A0%87%E8%AE%B0%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E7%A7%BB%E5%8A%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>标记节点是否移动</h3>\n<p>既然我们的目标是寻找移动的节点，那么我们需要明确：节点是否移动是以什么为参照物？</p>\n<p>我们的参照物是：最后一个可复用的节点在 oldFiber 中的位置索引（用变量 lastPlacedIndex 表示）。</p>\n<p>由于本次更新中节点是按 newChildren 的顺序排列。在遍历 newChildren 过程中，每个遍历到的可复用节点一定是当前遍历到的所有可复用节点中最靠右的那个，即一定在 lastPlacedIndex 对应的可复用的节点在本次更新中位置的后面。</p>\n<p>那么我们只需要比较遍历到的可复用节点在上次更新时是否也在 lastPlacedIndex 对应的 oldFiber 后面，就能知道两次更新中这两个节点的相对位置改变没有。</p>\n<p>我们用变量 oldIndex 表示遍历到的可复用节点在 oldFiber 中的位置索引。如果 oldIndex &#x3C; lastPlacedIndex，代表本次更新该节点需要向右移动。</p>\n<p>lastPlacedIndex 初始为 0，每遍历一个可复用的节点，如果 oldIndex >= lastPlacedIndex，则 lastPlacedIndex = oldIndex。</p>\n<p>单纯文字表达比较晦涩，这里我们提供两个 Demo，你可以对照着理解。</p>\n<h3 id="demo1"><a href="#demo1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Demo1</h3>\n<p>在 Demo 中我们简化下书写，每个字母代表一个节点，字母的值代表节点的 key</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51539158941307360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 之前\nabcd\n\n// 之后\nacdb\n\n===第一轮遍历开始===\na（之后）vs a（之前）\nkey 不变，可复用\n此时 a 对应的 oldFiber（之前的 a）在之前的数组（abcd）中索引为 0\n所以 lastPlacedIndex = 0;\n\n继续第一轮遍历...\n\nc（之后）vs b（之前）\nkey 改变，不能复用，跳出第一轮遍历\n此时 lastPlacedIndex === 0;\n===第一轮遍历结束===\n\n===第二轮遍历开始===\nnewChildren === cdb，没用完，不需要执行删除旧节点\noldFiber === bcd，没用完，不需要执行插入新节点\n\n将剩余 oldFiber（bcd）保存为 map\n\n// 当前 oldFiber：bcd\n// 当前 newChildren：cdb\n\n继续遍历剩余 newChildren\n\nkey === c 在 oldFiber 中存在\nconst oldIndex = c（之前）.index;\n此时 oldIndex === 2;  // 之前节点为 abcd，所以c.index === 2\n比较 oldIndex 与 lastPlacedIndex;\n\n如果 oldIndex >= lastPlacedIndex 代表该可复用节点不需要移动\n并将 lastPlacedIndex = oldIndex;\n如果 oldIndex < lastplacedIndex 该可复用节点之前插入的位置索引小于这次更新需要插入的位置索引，代表该节点需要向右移动\n\n在例子中，oldIndex 2 > lastPlacedIndex 0，\n则 lastPlacedIndex = 2;\nc 节点位置不变\n\n继续遍历剩余 newChildren\n\n// 当前oldFiber：bd\n// 当前newChildren：db\n\nkey === d 在 oldFiber 中存在\nconst oldIndex = d（之前）.index;\noldIndex 3 > lastPlacedIndex 2 // 之前节点为 abcd，所以 d.index === 3\n则 lastPlacedIndex = 3;\nd 节点位置不变\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：b\n// 当前 newChildren：b\n\nkey === b 在 oldFiber 中存在\nconst oldIndex = b（之前）.index;\noldIndex 1 < lastPlacedIndex 3 // 之前节点为 abcd，所以 b.index === 1\n则 b 节点需要向右移动\n===第二轮遍历结束===\n\n最终 acd 3 个节点都没有移动，b 节点被标记为移动`, `51539158941307360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 之前\nabcd\n\n// 之后\nacdb\n\n===第一轮遍历开始===\na（之后）vs a（之前）\nkey 不变，可复用\n此时 a 对应的 oldFiber（之前的 a）在之前的数组（abcd）中索引为 0\n所以 lastPlacedIndex = 0;\n\n继续第一轮遍历...\n\nc（之后）vs b（之前）\nkey 改变，不能复用，跳出第一轮遍历\n此时 lastPlacedIndex === 0;\n===第一轮遍历结束===\n\n===第二轮遍历开始===\nnewChildren === cdb，没用完，不需要执行删除旧节点\noldFiber === bcd，没用完，不需要执行插入新节点\n\n将剩余 oldFiber（bcd）保存为 map\n\n// 当前 oldFiber：bcd\n// 当前 newChildren：cdb\n\n继续遍历剩余 newChildren\n\nkey === c 在 oldFiber 中存在\nconst oldIndex = c（之前）.index;\n此时 oldIndex === 2;  // 之前节点为 abcd，所以c.index === 2\n比较 oldIndex 与 lastPlacedIndex;\n\n如果 oldIndex &gt;= lastPlacedIndex 代表该可复用节点不需要移动\n并将 lastPlacedIndex = oldIndex;\n如果 oldIndex &lt; lastplacedIndex 该可复用节点之前插入的位置索引小于这次更新需要插入的位置索引，代表该节点需要向右移动\n\n在例子中，oldIndex 2 &gt; lastPlacedIndex 0，\n则 lastPlacedIndex = 2;\nc 节点位置不变\n\n继续遍历剩余 newChildren\n\n// 当前oldFiber：bd\n// 当前newChildren：db\n\nkey === d 在 oldFiber 中存在\nconst oldIndex = d（之前）.index;\noldIndex 3 &gt; lastPlacedIndex 2 // 之前节点为 abcd，所以 d.index === 3\n则 lastPlacedIndex = 3;\nd 节点位置不变\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：b\n// 当前 newChildren：b\n\nkey === b 在 oldFiber 中存在\nconst oldIndex = b（之前）.index;\noldIndex 1 &lt; lastPlacedIndex 3 // 之前节点为 abcd，所以 b.index === 1\n则 b 节点需要向右移动\n===第二轮遍历结束===\n\n最终 acd 3 个节点都没有移动，b 节点被标记为移动</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="demo2"><a href="#demo2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Demo2</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20271423045891113000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 之前\nabcd\n\n// 之后\ndabc\n\n===第一轮遍历开始===\nd（之后）vs a（之前）\nkey 改变，不能复用，跳出遍历\n===第一轮遍历结束===\n\n===第二轮遍历开始===\nnewChildren === dabc，没用完，不需要执行删除旧节点\noldFiber === abcd，没用完，不需要执行插入新节点\n\n将剩余 oldFiber（abcd）保存为 map\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：abcd\n// 当前 newChildren：dabc\n\nkey === d 在 oldFiber 中存在\nconst oldIndex = d（之前）.index;\n此时 oldIndex === 3; // 之前节点为 abcd，所以 d.index === 3\n比较 oldIndex 与 lastPlacedIndex;\noldIndex 3 > lastPlacedIndex 0\n则 lastPlacedIndex = 3;\nd 节点位置不变\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：abc\n// 当前 newChildren：abc\n\nkey === a 在 oldFiber 中存在\nconst oldIndex = a（之前）.index; // 之前节点为 abcd，所以 a.index === 0\n此时 oldIndex === 0;\n比较 oldIndex 与 lastPlacedIndex;\noldIndex 0 < lastPlacedIndex 3\n则 a 节点需要向右移动\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：bc\n// 当前 newChildren：bc\n\nkey === b 在 oldFiber 中存在\nconst oldIndex = b（之前）.index; // 之前节点为 abcd，所以 b.index === 1\n此时 oldIndex === 1;\n比较 oldIndex 与 lastPlacedIndex;\noldIndex 1 < lastPlacedIndex 3\n则 b 节点需要向右移动\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：c\n// 当前 newChildren：c\n\nkey === c 在 oldFiber 中存在\nconst oldIndex = c（之前）.index; // 之前节点为 abcd，所以 c.index === 2\n此时 oldIndex === 2;\n比较 oldIndex 与 lastPlacedIndex;\noldIndex 2 < lastPlacedIndex 3\n则 c 节点需要向右移动\n\n===第二轮遍历结束===`, `20271423045891113000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// 之前\nabcd\n\n// 之后\ndabc\n\n===第一轮遍历开始===\nd（之后）vs a（之前）\nkey 改变，不能复用，跳出遍历\n===第一轮遍历结束===\n\n===第二轮遍历开始===\nnewChildren === dabc，没用完，不需要执行删除旧节点\noldFiber === abcd，没用完，不需要执行插入新节点\n\n将剩余 oldFiber（abcd）保存为 map\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：abcd\n// 当前 newChildren：dabc\n\nkey === d 在 oldFiber 中存在\nconst oldIndex = d（之前）.index;\n此时 oldIndex === 3; // 之前节点为 abcd，所以 d.index === 3\n比较 oldIndex 与 lastPlacedIndex;\noldIndex 3 &gt; lastPlacedIndex 0\n则 lastPlacedIndex = 3;\nd 节点位置不变\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：abc\n// 当前 newChildren：abc\n\nkey === a 在 oldFiber 中存在\nconst oldIndex = a（之前）.index; // 之前节点为 abcd，所以 a.index === 0\n此时 oldIndex === 0;\n比较 oldIndex 与 lastPlacedIndex;\noldIndex 0 &lt; lastPlacedIndex 3\n则 a 节点需要向右移动\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：bc\n// 当前 newChildren：bc\n\nkey === b 在 oldFiber 中存在\nconst oldIndex = b（之前）.index; // 之前节点为 abcd，所以 b.index === 1\n此时 oldIndex === 1;\n比较 oldIndex 与 lastPlacedIndex;\noldIndex 1 &lt; lastPlacedIndex 3\n则 b 节点需要向右移动\n\n继续遍历剩余 newChildren\n\n// 当前 oldFiber：c\n// 当前 newChildren：c\n\nkey === c 在 oldFiber 中存在\nconst oldIndex = c（之前）.index; // 之前节点为 abcd，所以 c.index === 2\n此时 oldIndex === 2;\n比较 oldIndex 与 lastPlacedIndex;\noldIndex 2 &lt; lastPlacedIndex 3\n则 c 节点需要向右移动\n\n===第二轮遍历结束===</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，我们以为从 abcd 变为 dabc，只需要将 d 移动到前面。</p>\n<p>但实际上 React 保持 d 不变，将 abc 分别移动到了 d 的后面。</p>\n<p>从这点可以看出，考虑性能，我们要尽量减少将节点从后面移动到前面的操作。</p>\n<h1 id="状态更新"><a href="#%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态更新</h1>\n<h2 id="流程概览"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概览</h2>\n<p>经过前几章的学习，我们终于有足够的前置知识理解状态更新的整个流程。</p>\n<p>这一章我们看看几种常见的触发状态更新的方法是如何完成工作的。</p>\n<h3 id="几个关键节点"><a href="#%E5%87%A0%E4%B8%AA%E5%85%B3%E9%94%AE%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>几个关键节点</h3>\n<p>在开始学习前，我们先了解源码中几个关键节点（即几个关键函数的调用）。通过这章的学习，我们会将这些关键节点的调用路径串起来。</p>\n<p>先从我们所熟知的概念开始。</p>\n<h4 id="render-阶段的开始"><a href="#render-%E9%98%B6%E6%AE%B5%E7%9A%84%E5%BC%80%E5%A7%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>render 阶段的开始</h4>\n<p>我们在 render 阶段流程概览一节讲到，</p>\n<p>render 阶段开始于 performSyncWorkOnRoot 或 performConcurrentWorkOnRoot 方法的调用。这取决于本次更新是同步更新还是异步更新。</p>\n<h4 id="commit-阶段的开始"><a href="#commit-%E9%98%B6%E6%AE%B5%E7%9A%84%E5%BC%80%E5%A7%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>commit 阶段的开始</h4>\n<p>我们在 commit 阶段流程概览一节讲到，</p>\n<p>commit 阶段开始于 commitRoot 方法的调用。其中 rootFiber 会作为传参。</p>\n<p>我们已经知道，render 阶段完成后会进入 commit 阶段，让我们继续补全从触发状态更新到 render 阶段的路径。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87963735123680280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`触发状态更新（根据场景调用不同方法）\n\n    |\n    |\n    v\n\n    ？\n\n    |\n    |\n    v\n\nrender阶段（\\`performSyncWorkOnRoot\\` 或 \\`performConcurrentWorkOnRoot\\`）\n\n    |\n    |\n    v\n\ncommit阶段（\\`commitRoot\\`）`, `87963735123680280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">触发状态更新（根据场景调用不同方法）\n\n    |\n    |\n    v\n\n    ？\n\n    |\n    |\n    v\n\nrender阶段（`performSyncWorkOnRoot` 或 `performConcurrentWorkOnRoot`）\n\n    |\n    |\n    v\n\ncommit阶段（`commitRoot`）</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="创建-update-对象"><a href="#%E5%88%9B%E5%BB%BA-update-%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 Update 对象</h4>\n<p>在 React 中，有如下方法可以触发状态更新（排除 SSR 相关）：</p>\n<ul>\n<li>ReactDOM.render</li>\n<li>this.setState</li>\n<li>this.forceUpdate</li>\n<li>useState</li>\n<li>useReducer</li>\n</ul>\n<p>这些方法调用的场景各不相同，他们是如何接入同一套状态更新机制呢？</p>\n<p>答案是：每次状态更新都会创建一个保存更新状态相关内容的对象，我们叫他 Update。在 render 阶段的 beginWork 中会根据 Update 计算新的 state。</p>\n<p>我们会在下一节详细讲解 Update。</p>\n<h4 id="从-fiber-到-root"><a href="#%E4%BB%8E-fiber-%E5%88%B0-root" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从 fiber 到 root</h4>\n<p>现在触发状态更新的 fiber 上已经包含 Update 对象。</p>\n<p>我们知道，render 阶段是从 rootFiber 开始向下遍历。那么如何从触发状态更新的 fiber 得到 rootFiber 呢？</p>\n<p>答案是：调用 markUpdateLaneFromFiberToRoot 方法。</p>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L636" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 markUpdateLaneFromFiberToRoot 的源码</p>\n</blockquote>\n<p>该方法做的工作可以概括为：从触发状态更新的 fiber 一直向上遍历到 rootFiber，并返回 rootFiber。</p>\n<p>由于不同更新优先级不尽相同，所以过程中还会更新遍历到的 fiber 的优先级。这对于我们当前属于超纲内容。</p>\n<h4 id="调度更新"><a href="#%E8%B0%83%E5%BA%A6%E6%9B%B4%E6%96%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调度更新</h4>\n<p>现在我们拥有一个 rootFiber，该 rootFiber 对应的 Fiber 树中某个 Fiber 节点包含一个 Update。</p>\n<p>接下来通知 Scheduler 根据更新的优先级，决定以同步还是异步的方式调度本次更新。</p>\n<p>这里调用的方法是 ensureRootIsScheduled。</p>\n<p>以下是 ensureRootIsScheduled 最核心的一段代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37910184590537875000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (newCallbackPriority === SyncLanePriority) {\n  // 任务已经过期，需要同步执行 render 阶段\n  newCallbackNode = scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root));\n} else {\n  // 根据任务优先级异步执行 render 阶段\n  var schedulerPriorityLevel = lanePriorityToSchedulerPriority(newCallbackPriority);\n  newCallbackNode = scheduleCallback(schedulerPriorityLevel, performConcurrentWorkOnRoot.bind(null, root));\n}`, `37910184590537875000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>newCallbackPriority <span class="token operator">===</span> SyncLanePriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 任务已经过期，需要同步执行 render 阶段</span>\n  newCallbackNode <span class="token operator">=</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 根据任务优先级异步执行 render 阶段</span>\n  <span class="token keyword">var</span> schedulerPriorityLevel <span class="token operator">=</span> <span class="token function">lanePriorityToSchedulerPriority</span><span class="token punctuation">(</span>newCallbackPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  newCallbackNode <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>schedulerPriorityLevel<span class="token punctuation">,</span> <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/b6df4417c79c11cfb44f965fab55b573882b1d54/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L602" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 ensureRootIsScheduled 的源码</p>\n</blockquote>\n<p>其中，scheduleCallback 和 scheduleSyncCallback 会调用 Scheduler 提供的调度方法根据优先级调度回调函数执行。</p>\n<p>可以看到，这里调度的回调函数为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35813854478646514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`performSyncWorkOnRoot.bind(null, root);\nperformConcurrentWorkOnRoot.bind(null, root);`, `35813854478646514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>即 render 阶段的入口函数。</p>\n<p>至此，状态更新就和我们所熟知的 render 阶段连接上了。</p>\n<h3 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>让我们梳理下状态更新的整个调用路径的关键节点：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29047777536082563000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`触发状态更新（根据场景调用不同方法）\n\n    |\n    |\n    v\n\n创建 Update 对象（接下来三节详解）\n\n    |\n    |\n    v\n\n从 fiber 到 root（\\`markUpdateLaneFromFiberToRoot\\`）\n\n    |\n    |\n    v\n\n调度更新（\\`ensureRootIsScheduled\\`）\n\n    |\n    |\n    v\n\nrender阶段（\\`performSyncWorkOnRoot\\` 或 \\`performConcurrentWorkOnRoot\\`）\n\n    |\n    |\n    v\n\ncommit阶段（\\`commitRoot\\`）`, `29047777536082563000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">触发状态更新（根据场景调用不同方法）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\n创建 Update 对象（接下来三节详解）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\n从 fiber 到 root（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">markUpdateLaneFromFiberToRoot</span><span class="token template-punctuation string">`</span></span>）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\n调度更新（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ensureRootIsScheduled</span><span class="token template-punctuation string">`</span></span>）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\nrender阶段（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">performSyncWorkOnRoot</span><span class="token template-punctuation string">`</span></span> 或 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">performConcurrentWorkOnRoot</span><span class="token template-punctuation string">`</span></span>）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\ncommit阶段（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">commitRoot</span><span class="token template-punctuation string">`</span></span>）</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>本节我们了解了状态更新的整个流程。</p>\n<p>在接下来三节中，我们会花大量篇幅讲解 Update 的工作机制，因为他是构成 React concurrent mode 的核心机制之一。</p>\n<h2 id="心智模型"><a href="#%E5%BF%83%E6%99%BA%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>心智模型</h2>\n<p>在深入源码前，让我们先建立更新机制的心智模型。</p>\n<p>在后面两节讲解源码时，我们会将代码与心智模型联系上，方便你更好理解。</p>\n<h3 id="同步更新的-react"><a href="#%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0%E7%9A%84-react" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>同步更新的 React</h3>\n<p>我们可以将更新机制类比代码版本控制。</p>\n<p>在没有代码版本控制前，我们在代码中逐步叠加功能。一切看起来井然有序，直到我们遇到了一个紧急线上 bug（红色节点）。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-02-01-11-03-04-fe04d9bfbba59061f0fa80a63494dbe0-506c4.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 27.51937984496124%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA60lEQVQY02P4////v3//oeAfEPyF8zC5///9haoGkwwQ8SevP3369hOu7OHLj19//IKw//779+Dlxx+//kBN+PXr87Xrf3/+hGq++vC1e9XKuiXH/nx7+vXRmhPXHrhWruxZd/bv1/vfHq/be/6+XcnSOTuu/v90/ePr3Q+mz97IxHantx+qGWhPXPfmyZvO/f/z5efbU9cePI/q2Dx/99X/fz7+fnv69K1noa0b1h298//X629frjxbu363vNLjJcsQzv71+88fJN/9/P3nLzL3159/iID5//f7d4SfkYIASP2FcWEUKhdZNQDS40k1FGZh6QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 02 01 11 03 04"\n        title=""\n        src="/static/2021-02-01-11-03-04-fe04d9bfbba59061f0fa80a63494dbe0-fee1c.png"\n        srcset="/static/2021-02-01-11-03-04-fe04d9bfbba59061f0fa80a63494dbe0-a67b7.png 200w,\n/static/2021-02-01-11-03-04-fe04d9bfbba59061f0fa80a63494dbe0-0b187.png 400w,\n/static/2021-02-01-11-03-04-fe04d9bfbba59061f0fa80a63494dbe0-fee1c.png 800w,\n/static/2021-02-01-11-03-04-fe04d9bfbba59061f0fa80a63494dbe0-b1a91.png 1200w,\n/static/2021-02-01-11-03-04-fe04d9bfbba59061f0fa80a63494dbe0-506c4.png 1548w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>为了修复这个 bug，我们需要首先将之前的代码提交。</p>\n<p>在 React 中，所有通过 ReactDOM.render 创建的应用（其他创建应用的方式参考 ReactDOM.render 一节）都是通过类似的方式更新状态。</p>\n<p>即没有优先级概念，高优更新（红色节点）需要排在其他更新后面执行。</p>\n<h3 id="并发更新的-react"><a href="#%E5%B9%B6%E5%8F%91%E6%9B%B4%E6%96%B0%E7%9A%84-react" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并发更新的 React</h3>\n<p>当有了代码版本控制，有紧急线上 bug 需要修复时，我们暂存当前分支的修改，在 master 分支修复 bug 并紧急上线。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-02-01-11-03-44-0d76cff9f84aecc7d14910dd9d910799-446cc.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 47.008547008547005%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABTElEQVQoz6VQuU7DQBB1i0RBQ49EQcE30NDyATQ0lLR8BxIVFQ0IEB/AFSXgRELKJUTiXE5QQg4rtnPZ8Tre+NiDtR2cBmiY3eLNm3k7b5ajQRB2QkAW4IeISt+Ai5QDvd8bNv9Wzpots/ERpVw4amSox+f7h6e71e4bSx3P9rC7vK6NKQWiyG9tJzY2p+8FX44xEzOeSuPPo7O9g5OdtJhAFBlwYtpT09bBXGcAQA1Sd5zLPK6t362sjvikL0aIi/Ysd7LZevx3137P5Ck2erhf2o5qDcmstIHj4SBDmJBCU83XZddDgUmEMC6pVlGZeQgHP+Xv7IvHBrx5KV/EhZask7liKbmBZt4ma1fPlbZqEChDNa9o5nWidBkTpCEI5y0mI0QytT5f7Fq2S7GDHMCeT1ellNCFjscY7AJm4bXSSwm9OWMC4xz9R3wBFOj08p8CDn4AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 02 01 11 03 44"\n        title=""\n        src="/static/2021-02-01-11-03-44-0d76cff9f84aecc7d14910dd9d910799-fee1c.png"\n        srcset="/static/2021-02-01-11-03-44-0d76cff9f84aecc7d14910dd9d910799-a67b7.png 200w,\n/static/2021-02-01-11-03-44-0d76cff9f84aecc7d14910dd9d910799-0b187.png 400w,\n/static/2021-02-01-11-03-44-0d76cff9f84aecc7d14910dd9d910799-fee1c.png 800w,\n/static/2021-02-01-11-03-44-0d76cff9f84aecc7d14910dd9d910799-446cc.png 1170w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>bug 修复上线后通过 git rebase 命令和开发分支连接上。开发分支基于修复 bug 的版本继续开发。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-02-01-11-03-59-e8d7c3d9dcf64ee9ddb4d327b455516c-69be6.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 63.829787234042556%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABf0lEQVQoz2P4TwFg+PcPRO278LB95fH7Lz4A2f8gQsRoBuInrz951652q1pZMGMPSDPxNgPxu0/f47q3OJUv71h1nDSbIUofvPiw68ydz99/gTWTYDNI7b+f7/58OPufJK0gzf/+AqkPTw/d3Z/y6+c3mLP//v33/89fEBNIglUCyX8QQaDwX7Ag1OafPz69eXEZoujfvz8QwV+//3798QtJEAR+/PrzDSoIDjCgMRPWn43s3Lnr7H0g9/ev7/9+vf/282/jkiPAgDx98xlI8OeX/38+v/n0o3jW3tQJ228+eQvVfPf5e2BQe9WsTO7f+e/Xhyfn2t6cqzx566196RLfutXl8w7///vm/rHSz9d7N595YVO0yKViRc+ak1DNv//8bV521L9h7YZjt0AO+/ryz9dHn77/KZm9L6R5/cFLj4CC3z8/+f/jxfN339Mnbo/q2HTx3kuoZoj+d5+/owUm0Hvvv/xAEwSGwsevPxB+hqcqWPL4B40/rIL/ECQAcdnUxVxZmBAAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 02 01 11 03 59"\n        title=""\n        src="/static/2021-02-01-11-03-59-e8d7c3d9dcf64ee9ddb4d327b455516c-fee1c.png"\n        srcset="/static/2021-02-01-11-03-59-e8d7c3d9dcf64ee9ddb4d327b455516c-a67b7.png 200w,\n/static/2021-02-01-11-03-59-e8d7c3d9dcf64ee9ddb4d327b455516c-0b187.png 400w,\n/static/2021-02-01-11-03-59-e8d7c3d9dcf64ee9ddb4d327b455516c-fee1c.png 800w,\n/static/2021-02-01-11-03-59-e8d7c3d9dcf64ee9ddb4d327b455516c-69be6.png 1034w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>在 React 中，通过 ReactDOM.createBlockingRoot 和 ReactDOM.createRoot 创建的应用会采用并发的方式更新状态。</p>\n<p>高优更新（红色节点）中断正在进行中的低优更新（蓝色节点），先完成 render - commit 流程。</p>\n<p>待高优更新完成后，低优更新基于高优更新的结果重新更新。</p>\n<p>接下来两节我们会从源码角度讲解这套并发更新是如何实现的。</p>\n<h2 id="update"><a href="#update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update</h2>\n<p>通过本章第一节学习，我们知道状态更新流程开始后首先会创建 Update 对象。</p>\n<p>本节我们学习 Update 的结构与工作流程。</p>\n<blockquote>\n<p>你可以将 Update 类比心智模型中的一次 commit。</p>\n</blockquote>\n<h3 id="update-的分类"><a href="#update-%E7%9A%84%E5%88%86%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update 的分类</h3>\n<p>我们先来了解 Update 的结构。</p>\n<p>首先，我们将可以触发更新的方法所隶属的组件分类：</p>\n<ul>\n<li>ReactDOM.render —— HostRoot</li>\n<li>this.setState —— ClassComponent</li>\n<li>this.forceUpdate —— ClassComponent</li>\n<li>useState —— FunctionComponent</li>\n<li>useReducer —— FunctionComponent</li>\n</ul>\n<p>可以看到，一共三种组件（HostRoot | ClassComponent | FunctionComponent）可以触发更新。</p>\n<p>由于不同类型组件工作方式不同，所以存在两种不同结构的 Update，其中 ClassComponent 与 HostRoot 共用一套 Update 结构，FunctionComponent 单独使用一种 Update 结构。</p>\n<p>虽然他们的结构不同，但是他们工作机制与工作流程大体相同。在本节我们介绍前一种 Update，FunctionComponent 对应的 Update 在 Hooks 章节介绍。</p>\n<h3 id="update-的结构"><a href="#update-%E7%9A%84%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update 的结构</h3>\n<p>ClassComponent 与 HostRoot（即 rootFiber.tag 对应类型）共用同一种 Update 结构。</p>\n<p>对应的结构如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26615083615051070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const update: Update<*> = {\n  eventTime,\n  lane,\n  suspenseConfig,\n  tag: UpdateState,\n  payload: null,\n  callback: null,\n\n  next: null\n};`, `26615083615051070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> update<span class="token punctuation">:</span> Update<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  eventTime<span class="token punctuation">,</span>\n  lane<span class="token punctuation">,</span>\n  suspenseConfig<span class="token punctuation">,</span>\n  tag<span class="token punctuation">:</span> UpdateState<span class="token punctuation">,</span>\n  payload<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  callback<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n\n  next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>Update 由 createUpdate 方法返回，你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactUpdateQueue.old.js#L189" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 createUpdate 的源码</p>\n</blockquote>\n<p>字段意义如下：</p>\n<ul>\n<li>eventTime：任务时间，通过 performance.now() 获取的毫秒数。由于该字段在未来会重构，当前我们不需要理解他。</li>\n<li>\n<p>lane：优先级相关字段。当前还不需要掌握他，只需要知道不同 Update 优先级可能是不同的。</p>\n<blockquote>\n<p>你可以将 lane 类比心智模型中需求的紧急程度。</p>\n</blockquote>\n</li>\n<li>suspenseConfig：Suspense 相关，暂不关注。</li>\n<li>tag：更新的类型，包括 UpdateState | ReplaceState | ForceUpdate | CaptureUpdate。</li>\n<li>payload：更新挂载的数据，不同类型组件挂载的数据不同。对于 ClassComponent，payload 为 this.setState 的第一个传参。对于 HostRoot，payload 为 ReactDOM.render 的第一个传参。</li>\n<li>callback：更新的回调函数。即在 commit 阶段的 layout 子阶段一节中提到的回调函数。</li>\n<li>next：与其他 Update 连接形成链表。</li>\n</ul>\n<h3 id="update-与-fiber-的联系"><a href="#update-%E4%B8%8E-fiber-%E7%9A%84%E8%81%94%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update 与 Fiber 的联系</h3>\n<p>我们发现，Update 存在一个连接其他 Update 形成链表的字段 next。联系 React 中另一种以链表形式组成的结构 Fiber，他们之间有什么关联么？</p>\n<p>答案是肯定的。</p>\n<p>从双缓存机制一节我们知道，Fiber 节点组成 Fiber 树，页面中最多同时存在两棵 Fiber 树：</p>\n<ul>\n<li>代表当前页面状态的 current Fiber 树</li>\n<li>代表正在 render 阶段的 workInProgress Fiber 树</li>\n</ul>\n<p>类似 Fiber 节点组成 Fiber 树，Fiber 节点上的多个 Update 会组成链表并被包含在 fiber.updateQueue 中。</p>\n<blockquote>\n<p>什么情况下一个 Fiber 节点会存在多个 Update？</p>\n<p>你可能疑惑为什么一个 Fiber 节点会存在多个 Update。这其实是很常见的情况。</p>\n<p>在这里介绍一种最简单的情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26287486211043774000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`onClick() {\nthis.setState({\n  a: 1\n})\n\nthis.setState({\n  b: 2\n})\n}`, `26287486211043774000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  a<span class="token punctuation">:</span> <span class="token number">1</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  b<span class="token punctuation">:</span> <span class="token number">2</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在一个 ClassComponent 中触发 this.onClick 方法，方法内部调用了两次 this.setState。这会在该 fiber 中产生两个 Update。</p>\n</blockquote>\n<p>Fiber 节点最多同时存在两个 updateQueue：</p>\n<ul>\n<li>current fiber 保存的 updateQueue 即 current updateQueue</li>\n<li>workInProgress fiber 保存的 updateQueue 即 workInProgress updateQueue</li>\n</ul>\n<p>在 commit 阶段完成页面渲染后，workInProgress Fiber 树变为 current Fiber 树，workInProgress Fiber 树内 Fiber 节点的 updateQueue 就变成 current updateQueue。</p>\n<h3 id="updatequeue"><a href="#updatequeue" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>updateQueue</h3>\n<p>updateQueue 有三种类型，其中针对 HostComponent 的类型我们在 completeWork 一节介绍过。</p>\n<p>剩下两种类型和 Update 的两种类型对应。</p>\n<p>ClassComponent 与 HostRoot 使用的 UpdateQueue 结构如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2418971381523471400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const queue: UpdateQueue<State> = {\n  baseState: fiber.memoizedState,\n  firstBaseUpdate: null,\n  lastBaseUpdate: null,\n  shared: {\n    pending: null\n  },\n  effects: null\n};`, `2418971381523471400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> queue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  baseState<span class="token punctuation">:</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>\n  firstBaseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  lastBaseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  shared<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    pending<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  effects<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>UpdateQueue 由 initializeUpdateQueue 方法返回，你可以从这里看到 initializeUpdateQueue 的源码</p>\n</blockquote>\n<p>字段说明如下：</p>\n<ul>\n<li>\n<p>baseState：本次更新前该 Fiber 节点的 state，Update 基于该 state 计算更新后的 state。</p>\n<blockquote>\n<p>你可以将 baseState 类比心智模型中的 master 分支。</p>\n</blockquote>\n</li>\n<li>\n<p>firstBaseUpdate 与 lastBaseUpdate：本次更新前该 Fiber 节点已保存的 Update。以链表形式存在，链表头为 firstBaseUpdate，链表尾为 lastBaseUpdate。之所以在更新产生前该 Fiber 节点内就存在 Update，是由于某些 Update 优先级较低所以在上次 render 阶段由 Update 计算 state 时被跳过。</p>\n<blockquote>\n<p>你可以将 baseUpdate 类比心智模型中执行 git rebase 基于的 commit（节点 D）。</p>\n</blockquote>\n</li>\n<li>\n<p>shared.pending：触发更新时，产生的 Update 会保存在 shared.pending 中形成单向环状链表。当由 Update 计算 state 时这个环会被剪开并连接在 lastBaseUpdate 后面。</p>\n<blockquote>\n<p>你可以将 shared.pending 类比心智模型中本次需要提交的 commit（节点 ABC）。</p>\n</blockquote>\n</li>\n<li>\n<p>effects：数组。保存 update.callback !== null 的 Update。</p>\n</li>\n</ul>\n<h3 id="例子"><a href="#%E4%BE%8B%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h3>\n<p>updateQueue 相关代码逻辑涉及到大量链表操作，比较难懂。在此我们举例对 updateQueue 的工作流程讲解下。</p>\n<p>假设有一个 fiber 刚经历 commit 阶段完成渲染。</p>\n<p>该 fiber 上有两个由于优先级过低所以在上次的 render 阶段并没有处理的 Update。他们会成为下次更新的 baseUpdate。</p>\n<p>我们称其为 u1 和 u2，其中 u1.next === u2。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67351343092171590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue.firstBaseUpdate === u1;\nfiber.updateQueue.lastBaseUpdate === u2;\nu1.next === u2;`, `67351343092171590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>firstBaseUpdate <span class="token operator">===</span> u1<span class="token punctuation">;</span>\nfiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>lastBaseUpdate <span class="token operator">===</span> u2<span class="token punctuation">;</span>\nu1<span class="token punctuation">.</span>next <span class="token operator">===</span> u2<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们用 —> 表示链表的指向：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86556036399080360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue.baseUpdate: u1 --> u2`, `86556036399080360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>baseUpdate<span class="token punctuation">:</span> u1 <span class="token operator">--</span><span class="token operator">></span> u2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在我们在 fiber 上触发两次状态更新，这会产生两个新 Update。</p>\n<p>我们称其为 u3 和 u4。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35481177549902500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue.shared.pending === u3;\nu3.next === u4;\nu4.next === u3;`, `35481177549902500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>pending <span class="token operator">===</span> u3<span class="token punctuation">;</span>\nu3<span class="token punctuation">.</span>next <span class="token operator">===</span> u4<span class="token punctuation">;</span>\nu4<span class="token punctuation">.</span>next <span class="token operator">===</span> u3<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>由于 shared.pending 是环状链表，用图表示为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34706864560619910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue.shared.pending:   u3 --> u4\n                                     ^      |\n                                     |______|`, `34706864560619910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>pending<span class="token punctuation">:</span>   u3 <span class="token operator">--</span><span class="token operator">></span> u4\n                                     <span class="token operator">^</span>      <span class="token operator">|</span>\n                                     <span class="token operator">|</span>______<span class="token operator">|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>更新调度完成后进入 render 阶段。</p>\n<p>此时 shared.pending 的环被剪开并连接在 updateQueue.lastBaseUpdate 后面：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96526243604448220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue.baseUpdate: u1 --> u2 --> u3 --> u4`, `96526243604448220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>baseUpdate<span class="token punctuation">:</span> u1 <span class="token operator">--</span><span class="token operator">></span> u2 <span class="token operator">--</span><span class="token operator">></span> u3 <span class="token operator">--</span><span class="token operator">></span> u4</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>接下来遍历 updateQueue.baseUpdate 链表，以 fiber.updateQueue.baseState 为初始 state，依次与遍历到的每个 Update 计算并产生新的 state（该操作类比 Array.prototype.reduce）。</p>\n<p>在遍历时如果有优先级低的 Update 会被跳过。</p>\n<p>当遍历完成后获得的 state，就是该 Fiber 节点在本次更新的 state（源码中叫做 memoizedState）。</p>\n<blockquote>\n<p>render 阶段的 Update 操作由 processUpdateQueue 完成，你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactUpdateQueue.new.js#L405" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 processUpdateQueue 的源码</p>\n</blockquote>\n<p>state 的变化在 render 阶段产生与上次更新不同的 JSX 对象，通过 Diff 算法产生 effectTag，在 commit 阶段渲染在页面上。</p>\n<p>渲染完成后 workInProgress Fiber 树变为 current Fiber 树，整个更新流程结束。</p>\n<h2 id="深入理解优先级"><a href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E4%BC%98%E5%85%88%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>深入理解优先级</h2>\n<p>通过更新的心智模型，我们了解到更新具有优先级。</p>\n<p>那么什么是优先级？优先级以什么为依据？如何通过优先级决定哪个状态应该先被更新？</p>\n<p>本节我们会详细讲解。</p>\n<h3 id="什么是优先级"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BC%98%E5%85%88%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是优先级</h3>\n<p>在 React 理念一节我们聊到 React 将人机交互研究的结果整合到真实的 UI 中。具体到 React 运行上这是什么意思呢？</p>\n<p>状态更新由用户交互产生，用户心里对交互执行顺序有个预期。React 根据人机交互研究的结果中用户对交互的预期顺序为交互产生的状态更新赋予不同优先级。</p>\n<p>具体如下：</p>\n<ul>\n<li>生命周期方法：同步执行。</li>\n<li>受控的用户输入：比如输入框内输入文字，同步执行。</li>\n<li>交互事件：比如动画，高优先级执行。</li>\n<li>其他：比如数据请求，低优先级执行。</li>\n</ul>\n<h3 id="如何调度优先级"><a href="#%E5%A6%82%E4%BD%95%E8%B0%83%E5%BA%A6%E4%BC%98%E5%85%88%E7%BA%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何调度优先级</h3>\n<p>我们在新的 React 结构一节讲到，React 通过 Scheduler 调度任务。</p>\n<p>具体到代码，每当需要调度任务时，React 会调用 Scheduler 提供的方法 runWithPriority。</p>\n<p>该方法接收一个优先级常量与一个回调函数作为参数。回调函数会以优先级高低为顺序排列在一个定时器中并在合适的时间触发。</p>\n<p>对于更新来讲，传递的回调函数一般为状态更新流程概览一节讲到的 render 阶段的入口函数。</p>\n<blockquote>\n<p>你可以在 <code class="language-text">==unstable_runWithPriority==</code> <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/scheduler/src/Scheduler.js#L217" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 runWithPriority 方法的定义。在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/scheduler/src/SchedulerPriorities.js" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 Scheduler 对优先级常量的定义。</p>\n</blockquote>\n<h3 id="例子-1"><a href="#%E4%BE%8B%E5%AD%90-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h3>\n<p>优先级最终会反映到 update.lane 变量上。当前我们只需要知道这个变量能够区分 Update 的优先级。</p>\n<p>接下来我们通过一个例子结合上一节介绍的 Update 相关字段讲解优先级如何决定更新的顺序。</p>\n<blockquote>\n<p>该例子来自 React Core Team Andrew 向网友讲解 Update 工作流程的<a href="https://twitter.com/acdlite/status/978412930973687808" target="_blank" rel="nofollow noreferrer noopener">推文</a></p>\n</blockquote>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-dc1fc.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 56.30914826498423%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB40lEQVQoz11SyW7bMBTU1xborZ/QW4H8QIEeChToIY1/IQ1gO0AKtKl3y1LjpZZky1q4SBQl7qEkH4q+A5fBzDxySMe0pdtBYhHf1Uw0XNhRqg68Vk8gGj1pbZRSuitHHm54FTNhVJM8Dj9+uV8Oxv7t0HWPmeVbVivVnRM/F+v3ACAIQZIklFKnDm5hHqUZgBCTRilj0PZT5A8upckswKX5/wBaKtk3d7ptC0KM//gbjPAx2n37/uNu7H99WAZpwRnfeNswjHq5EAISzVhrasWqtVEyS9PlcnGJz10H3VnbcxgSj9b3b/bHoG8sGMHuh4aEvdgATF7+ni55UUtDhc5KBmuRNxISlhYMwJCgecF1UQtMJSIEh4MLispGtmJKa4hwBlBREiE1qurEe+GjR1jR4XA0/vlEOLdhcGUAKk+XOKmoajO3nTW7BtGV7PPNY+X57UIpIRs7dfe1edbW3bJ6sqM2bwU9WYRzXpKK2XhVxfx3KTolSU5IyaUmJS6oqQ+f4foGVgZCaAOyfCc+Tqaz2XzlPT//WiwWQRAIwbNo7q4W08l0vz8E0Wm3253PcU2R586WK/f3ZGIRG7OT5dD1fM/3t9stxhgAkOcgy4sgCOMUBGHoe14URfZL/PPc12u+AiEjZw0BynDwAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 02 01 11 17 25"\n        title=""\n        src="/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-fee1c.png"\n        srcset="/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-a67b7.png 200w,\n/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-0b187.png 400w,\n/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-fee1c.png 800w,\n/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-b1a91.png 1200w,\n/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-95179.png 1600w,\n/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-5d5ba.png 2400w,\n/static/2021-02-01-11-17-25-4eaa8f94b2c9b4131bee3b82d9e67b4e-dc1fc.png 2536w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>在这个例子中，有两个 Update。我们将“关闭黑夜模式”产生的 Update 称为 u1，输入字母 “I” 产生的 Update 称为 u2。</p>\n<p>其中 u1 先触发并进入 render 阶段。其优先级较低，执行时间较长。此时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67120195074414420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue = {\n  baseState: {\n    blackTheme: true,\n    text: \'H\'\n  },\n  firstBaseUpdate: null,\n  lastBaseUpdate: null\n  shared: {\n    pending: u1\n  },\n  effects: null\n};`, `67120195074414420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token punctuation">{</span>\n  baseState<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    blackTheme<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    text<span class="token punctuation">:</span> <span class="token string">\'H\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  firstBaseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  lastBaseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  shared<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    pending<span class="token punctuation">:</span> u1\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  effects<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 u1 完成 render 阶段前用户通过键盘输入字母“I”，产生了 u2。u2 属于受控的用户输入，优先级高于 u1，于是中断 u1 产生的 render 阶段。</p>\n<p>此时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38088914180488320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue.shared.pending === u2 ----> u1\n                                     ^        |\n                                     |________|\n// 即\nu2.next === u1;\nu1.next === u2;`, `38088914180488320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>pending <span class="token operator">===</span> u2 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">></span> u1\n                                     <span class="token operator">^</span>        <span class="token operator">|</span>\n                                     <span class="token operator">|</span>________<span class="token operator">|</span>\n<span class="token comment">// 即</span>\nu2<span class="token punctuation">.</span>next <span class="token operator">===</span> u1<span class="token punctuation">;</span>\nu1<span class="token punctuation">.</span>next <span class="token operator">===</span> u2<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 u2 优先级高于 u1。</p>\n<p>接下来进入 u2 产生的 render 阶段。</p>\n<p>在 processUpdateQueue 方法中，shared.pending 环状链表会被剪开并拼接在 baseUpdate 后面。</p>\n<p>需要明确一点，shared.pending 指向最后一个 pending 的 update，所以实际执行时 update 的顺序为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56716941361023010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`u1 -- u2`, `56716941361023010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">u1 <span class="token operator">--</span> u2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>接下来遍历 baseUpdate，处理优先级合适的 Update（这一次处理的是更高优的 u2）。</p>\n<p>由于 u2 不是 baseUpdate 中的第一个 update，在其之前的 u1 由于优先级不够被跳过。</p>\n<p>update 之间可能有依赖关系，所以被跳过的 update 及其后面所有 update 会成为下次更新的 baseUpdate。（即 u1 — u2）。</p>\n<p>最终 u2 完成 render - commit 阶段。</p>\n<p>此时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28442204875633558000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue = {\n  baseState: {\n    blackTheme: true,\n    text: \'HI\'\n  },\n  firstBaseUpdate: u1,\n  lastBaseUpdate: u2\n  shared: {\n    pending: null\n  },\n  effects: null\n};`, `28442204875633558000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token punctuation">{</span>\n  baseState<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    blackTheme<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    text<span class="token punctuation">:</span> <span class="token string">\'HI\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  firstBaseUpdate<span class="token punctuation">:</span> u1<span class="token punctuation">,</span>\n  lastBaseUpdate<span class="token punctuation">:</span> u2\n  shared<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    pending<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  effects<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 commit 阶段结尾会再调度一次更新。在该次更新中会基于 baseState 中 firstBaseUpdate 保存的 u1，开启一次新的 render 阶段。</p>\n<p>最终两次 Update 都完成后的结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7184473397074820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiber.updateQueue = {\n  baseState: {\n    blackTheme: false,\n    text: \'HI\'\n  },\n  firstBaseUpdate: null,\n  lastBaseUpdate: null\n  shared: {\n    pending: null\n  },\n  effects: null\n};`, `7184473397074820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token punctuation">{</span>\n  baseState<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    blackTheme<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>\n    text<span class="token punctuation">:</span> <span class="token string">\'HI\'</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  firstBaseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  lastBaseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  shared<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    pending<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  effects<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以看见，u2 对应的更新执行了两次，相应的 render 阶段的生命周期勾子 componentWillXXX 也会触发两次。这也是为什么这些勾子会被标记为 unsafe_。</p>\n<h3 id="如何保证状态正确"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%8A%B6%E6%80%81%E6%AD%A3%E7%A1%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证状态正确</h3>\n<p>现在我们基本掌握了 updateQueue 的工作流程。还有两个疑问：</p>\n<ul>\n<li>render 阶段可能被中断。如何保证 updateQueue 中保存的 Update 不丢失？</li>\n<li>有时候当前状态需要依赖前一个状态。如何在支持跳过低优先级状态的同时保证状态依赖的连续性？</li>\n</ul>\n<p>我们分别讲解下。</p>\n<h4 id="如何保证-update-不丢失"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-update-%E4%B8%8D%E4%B8%A2%E5%A4%B1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证 Update 不丢失</h4>\n<p>在上一节例子中我们讲到，在 render 阶段，shared.pending 的环被剪开并连接在 updateQueue.lastBaseUpdate 后面。</p>\n<p>实际上 shared.pending 会被同时连接在 workInProgress updateQueue.lastBaseUpdate 与 current updateQueue.lastBaseUpdate 后面。</p>\n<blockquote>\n<p>具体代码见<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L424" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n</blockquote>\n<p>当 render 阶段被中断后重新开始时，会基于 current updateQueue 克隆出 workInProgress updateQueue。由于 current updateQueue.lastBaseUpdate 已经保存了上一次的 Update，所以不会丢失。</p>\n<p>当 commit 阶段完成渲染，由于 workInProgress updateQueue.lastBaseUpdate 中保存了上一次的 Update，所以 workInProgress Fiber 树变成 current Fiber 树后也不会造成 Update 丢失。</p>\n<h4 id="如何保证状态依赖的连续性"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%8A%B6%E6%80%81%E4%BE%9D%E8%B5%96%E7%9A%84%E8%BF%9E%E7%BB%AD%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证状态依赖的连续性</h4>\n<p>当某个 Update 由于优先级低而被跳过时，保存在 baseUpdate 中的不仅是该 Update，还包括链表中该 Update 之后的所有 Update。</p>\n<p>考虑如下例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75386454871326130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baseState: \'\'\nshared.pending: A1 --> B2 --> C1 --> D2`, `75386454871326130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">baseState<span class="token punctuation">:</span> <span class="token string">\'\'</span>\nshared<span class="token punctuation">.</span>pending<span class="token punctuation">:</span> <span class="token constant">A1</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token constant">B2</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token constant">C1</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token constant">D2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其中字母代表该 Update 要在页面插入的字母，数字代表优先级，值越低优先级越高。</p>\n<p>第一次 render，优先级为 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24635755514295845000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baseState: \'\';\nbaseUpdate: null;\nrender阶段使用的Update: [A1, C1];\nmemoizedState: \'AC\';`, `24635755514295845000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">baseState<span class="token punctuation">:</span> <span class="token string">\'\'</span><span class="token punctuation">;</span>\nbaseUpdate<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\nrender阶段使用的Update<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token constant">A1</span><span class="token punctuation">,</span> <span class="token constant">C1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\nmemoizedState<span class="token punctuation">:</span> <span class="token string">\'AC\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 B2 由于优先级为 2，低于当前优先级，所以他及其后面的所有 Update 会被保存在 baseUpdate 中作为下次更新的 Update（即 B2 C1 D2）。</p>\n<p>这么做是为了保持状态的前后依赖顺序。</p>\n<p>第二次 render，优先级为 2。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75305059638152460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baseState: \'A\';\nbaseUpdate: B2-- > C1-- > D2;\nrender阶段使用的Update: [B2, C1, D2];\nmemoizedState: \'ABCD\';`, `75305059638152460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">baseState<span class="token punctuation">:</span> <span class="token string">\'A\'</span><span class="token punctuation">;</span>\nbaseUpdate<span class="token punctuation">:</span> <span class="token constant">B2</span><span class="token operator">--</span> <span class="token operator">></span> <span class="token constant">C1</span><span class="token operator">--</span> <span class="token operator">></span> <span class="token constant">D2</span><span class="token punctuation">;</span>\nrender阶段使用的Update<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token constant">B2</span><span class="token punctuation">,</span> <span class="token constant">C1</span><span class="token punctuation">,</span> <span class="token constant">D2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\nmemoizedState<span class="token punctuation">:</span> <span class="token string">\'ABCD\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意这里 baseState 并不是上一次更新的 memoizedState。这是由于 B2 被跳过了。</p>\n<p>即当有 Update 被跳过时，下次更新的 baseState !== 上次更新的 memoizedState。</p>\n<blockquote>\n<p>跳过 B2 的逻辑见<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L479" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n</blockquote>\n<p>通过以上例子我们可以发现，React 保证最终的状态一定和用户触发的交互一致，但是中间过程状态可能由于设备不同而不同。</p>\n<h2 id="reactdomrender"><a href="#reactdomrender" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ReactDOM.render</h2>\n<p>经过五章的学习，我们终于回到了 React 应用的起点。</p>\n<p>这一节我们完整的走通 ReactDOM.render 完成页面渲染的整个流程。</p>\n<h3 id="创建-fiber"><a href="#%E5%88%9B%E5%BB%BA-fiber" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 fiber</h3>\n<p>从<a href="https://react.iamkasong.com/process/doubleBuffer.html#mount%E6%97%B6" target="_blank" rel="nofollow noreferrer noopener">双缓存机制一节</a>我们知道，首次执行 ReactDOM.render 会创建 fiberRootNode 和 rootFiber。其中 fiberRootNode 是整个应用的根节点，rootFiber 是要渲染组件所在组件树的根节点。</p>\n<p>这一步发生在调用 ReactDOM.render 后进入的 legacyRenderSubtreeIntoContainer 方法中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31795307289885843000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// container 指 ReactDOM.render 的第二个参数（即应用挂载的 DOM 节点）\nroot = container._reactRootContainer = legacyCreateRootFromDOMContainer(container, forceHydrate);\nfiberRoot = root._internalRoot;`, `31795307289885843000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// container 指 ReactDOM.render 的第二个参数（即应用挂载的 DOM 节点）</span>\nroot <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> forceHydrate<span class="token punctuation">)</span><span class="token punctuation">;</span>\nfiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-dom/src/client/ReactDOMLegacy.js#L193" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这一步的代码</p>\n</blockquote>\n<p>legacyCreateRootFromDOMContainer 方法内部会调用 createFiberRoot 方法完成 fiberRootNode 和 rootFiber 的创建以及关联并初始化 updateQueue。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88525707458415970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function createFiberRoot(\n  containerInfo: any,\n  tag: RootTag,\n  hydrate: boolean,\n  hydrationCallbacks: null | SuspenseHydrationCallbacks\n): FiberRoot {\n  // 创建 fiberRootNode\n  const root: FiberRoot = (new FiberRootNode(containerInfo, tag, hydrate): any);\n\n  // 创建 rootFiber\n  const uninitializedFiber = createHostRootFiber(tag);\n\n  // 连接 rootFiber 与 fiberRootNode\n  root.current = uninitializedFiber;\n  uninitializedFiber.stateNode = root;\n\n  // 初始化 updateQueue\n  initializeUpdateQueue(uninitializedFiber);\n\n  return root;\n}`, `88525707458415970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>\n  <span class="token parameter">containerInfo<span class="token punctuation">:</span> any<span class="token punctuation">,</span>\n  tag<span class="token punctuation">:</span> RootTag<span class="token punctuation">,</span>\n  hydrate<span class="token punctuation">:</span> boolean<span class="token punctuation">,</span>\n  hydrationCallbacks<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseHydrationCallbacks</span>\n<span class="token punctuation">)</span><span class="token punctuation">:</span> FiberRoot <span class="token punctuation">{</span>\n  <span class="token comment">// 创建 fiberRootNode</span>\n  <span class="token keyword">const</span> root<span class="token punctuation">:</span> FiberRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 创建 rootFiber</span>\n  <span class="token keyword">const</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 连接 rootFiber 与 fiberRootNode</span>\n  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>\n  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>\n\n  <span class="token comment">// 初始化 updateQueue</span>\n  <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>uninitializedFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> root<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>根据以上代码，现在我们可以在双缓存机制一节基础上补充上 rootFiber 到 fiberRootNode 的引用。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-02-02-10-21-45-dd7cf95a74dcc5313ae8aaa4a533df5b-9f160.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 734px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 63.48773841961852%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABC0lEQVQoz6VSi07DMAzc//8XmqbxEKIMWFvKkKbSLV3TJmmedkimgSYW0NAsK3Js3cW+eOIvsEkyC5hIIv7MJ8DaodDQdgPphg3pWsqaeHI26tGgOyL4BmOkxliQGpT12ePiajq7vruf39yGYDqbr+sP6by28NfLgVoZGBQQ7nqFh4a9Nw4DEvGkbWUkkz0VO+tMqDLl6GiF0lxSNlIq2hAAurRglJM1qeq24pIP0lFhHETGVZO/b8vVpgiurUqAcS9S6CeMtFO+Vz4IBknFT8HWgTRICMmeXh6yRV6UUumQiRrGeQ/+GxiFwbohz8sif31bllX4FWng3CUBPFZxf0X874bhl1+wnmfaJy7B+xd+on5sAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 02 02 10 21 45"\n        title=""\n        src="/static/2021-02-02-10-21-45-dd7cf95a74dcc5313ae8aaa4a533df5b-9f160.png"\n        srcset="/static/2021-02-02-10-21-45-dd7cf95a74dcc5313ae8aaa4a533df5b-6716a.png 200w,\n/static/2021-02-02-10-21-45-dd7cf95a74dcc5313ae8aaa4a533df5b-f6bb6.png 400w,\n/static/2021-02-02-10-21-45-dd7cf95a74dcc5313ae8aaa4a533df5b-9f160.png 734w"\n        sizes="(max-width: 734px) 100vw, 734px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberRoot.new.js#L97" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这一步的代码</p>\n</blockquote>\n<h3 id="创建-update"><a href="#%E5%88%9B%E5%BB%BA-update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创建 update</h3>\n<p>我们已经做好了组件的初始化工作，接下来就等待创建 Update 来开启一次更新。</p>\n<p>这一步发生在 updateContainer 方法中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19081254272308556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function updateContainer(\n  element: ReactNodeList,\n  container: OpaqueRoot,\n  parentComponent: ?React\\$Component<any, any>,\n  callback: ?Function\n): Lane {\n  // ...省略与逻辑不相关代码\n\n  // 创建 update\n  const update = createUpdate(eventTime, lane, suspenseConfig);\n\n  // update.payload 为需要挂载在根节点的组件\n  update.payload = { element };\n\n  // callback 为 ReactDOM.render 的第三个参数 —— 回调函数\n  callback = callback === undefined ? null : callback;\n  if (callback !== null) {\n    update.callback = callback;\n  }\n\n  // 将生成的 update 加入 updateQueue\n  enqueueUpdate(current, update);\n  // 调度更新\n  scheduleUpdateOnFiber(current, lane, eventTime);\n\n  // ...省略与逻辑不相关代码\n}`, `19081254272308556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>\n  <span class="token parameter">element<span class="token punctuation">:</span> ReactNodeList<span class="token punctuation">,</span>\n  container<span class="token punctuation">:</span> OpaqueRoot<span class="token punctuation">,</span>\n  parentComponent<span class="token punctuation">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span>\n  callback<span class="token punctuation">:</span> <span class="token operator">?</span>Function</span>\n<span class="token punctuation">)</span><span class="token punctuation">:</span> Lane <span class="token punctuation">{</span>\n  <span class="token comment">// ...省略与逻辑不相关代码</span>\n\n  <span class="token comment">// 创建 update</span>\n  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// update.payload 为需要挂载在根节点的组件</span>\n  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span> element <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// callback 为 ReactDOM.render 的第三个参数 —— 回调函数</span>\n  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> callback<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 将生成的 update 加入 updateQueue</span>\n  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 调度更新</span>\n  <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...省略与逻辑不相关代码</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberReconciler.new.js#L255" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 updateContainer 的代码</p>\n</blockquote>\n<p>值得注意的是其中 <code class="language-text">update.payload = {element}</code>;</p>\n<p>这就是我们在 Update 一节介绍的，对于 HostRoot，payload 为 ReactDOM.render 的第一个传参。</p>\n<h3 id="流程概览-1"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概览</h3>\n<p>至此，ReactDOM.render 的流程就和我们已知的流程连接上了。</p>\n<p>整个流程如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64255853431490585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`创建 fiberRootNode、rootFiber、updateQueue（\\`legacyCreateRootFromDOMContainer\\`）\n\n    |\n    |\n    v\n\n创建 Update 对象（\\`updateContainer\\`）\n\n    |\n    |\n    v\n\n从 fiber 到 root（\\`markUpdateLaneFromFiberToRoot\\`）\n\n    |\n    |\n    v\n\n调度更新（\\`ensureRootIsScheduled\\`）\n\n    |\n    |\n    v\n\nrender 阶段（\\`performSyncWorkOnRoot\\` 或 \\`performConcurrentWorkOnRoot\\`）\n\n    |\n    |\n    v\n\ncommit 阶段（\\`commitRoot\\`）`, `64255853431490585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">创建 fiberRootNode、rootFiber、updateQueue（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">legacyCreateRootFromDOMContainer</span><span class="token template-punctuation string">`</span></span>）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\n创建 Update 对象（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">updateContainer</span><span class="token template-punctuation string">`</span></span>）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\n从 fiber 到 root（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">markUpdateLaneFromFiberToRoot</span><span class="token template-punctuation string">`</span></span>）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\n调度更新（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ensureRootIsScheduled</span><span class="token template-punctuation string">`</span></span>）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\nrender 阶段（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">performSyncWorkOnRoot</span><span class="token template-punctuation string">`</span></span> 或 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">performConcurrentWorkOnRoot</span><span class="token template-punctuation string">`</span></span>）\n\n    <span class="token operator">|</span>\n    <span class="token operator">|</span>\n    v\n\ncommit 阶段（<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">commitRoot</span><span class="token template-punctuation string">`</span></span>）</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="react-的其他入口函数"><a href="#react-%E7%9A%84%E5%85%B6%E4%BB%96%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React 的其他入口函数</h3>\n<p>当前 React 共有三种模式：</p>\n<ul>\n<li>legacy，这是当前 React 使用的方式。当前没有计划删除本模式，但是这个模式可能不支持一些新功能。</li>\n<li>blocking，开启部分 concurrent 模式特性的中间模式。目前正在实验中。作为迁移到 concurrent 模式的第一个步骤。</li>\n<li>concurrent，面向未来的开发模式。我们之前讲的任务中断/任务优先级都是针对 concurrent 模式。</li>\n</ul>\n<p>你可以从下表看出各种模式对特性的支持：</p>\n<table>\n<thead>\n<tr>\n<th align="center"></th>\n<th align="center">legacy 模式</th>\n<th align="center">blocking 模式</th>\n<th align="center">concurrent 模式</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="center">String Refs</td>\n<td align="center">✅</td>\n<td align="center">🚫\n*\n*</td>\n<td align="center">🚫\n*\n*</td>\n</tr>\n<tr>\n<td align="center">Legacy Context</td>\n<td align="center">✅</td>\n<td align="center">🚫\n*\n*</td>\n<td align="center">🚫\n*\n*</td>\n</tr>\n<tr>\n<td align="center">findDOMNode</td>\n<td align="center">✅</td>\n<td align="center">🚫\n*\n*</td>\n<td align="center">🚫\n*\n*</td>\n</tr>\n<tr>\n<td align="center">Suspense</td>\n<td align="center">✅</td>\n<td align="center">✅</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">SuspenseList</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">Suspense SSR + Hydration</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">Progressive Hydration</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">Selective Hydration</td>\n<td align="center">🚫</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">Cooperative Multitasking</td>\n<td align="center">🚫</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">Automatic batching of multiple setStates</td>\n<td align="center">🚫\n*</td>\n<td align="center">✅</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">Priority-based Rendering</td>\n<td align="center">🚫</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">Interruptible Prerendering</td>\n<td align="center">🚫</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">useTransition</td>\n<td align="center">🚫</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">useDeferredValue</td>\n<td align="center">🚫</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n</tr>\n<tr>\n<td align="center">Suspense Reveal “Train”</td>\n<td align="center">🚫</td>\n<td align="center">🚫</td>\n<td align="center">✅</td>\n</tr>\n</tbody>\n</table>\n<p>*：legacy 模式在合成事件中有自动批处理的功能，但仅限于一个浏览器任务。非 React 事件想使用这个功能必须使用 unstable_batchedUpdates。在 blocking 模式和 concurrent 模式下，所有的 setState 在默认情况下都是批处理的。</p>\n<p>**：会在开发中发出警告。</p>\n<p>模式的变化影响整个应用的工作方式，所以无法只针对某个组件开启不同模式。</p>\n<p>基于此原因，可以通过不同的入口函数开启不同模式：</p>\n<ul>\n<li>legacy — <code class="language-text">ReactDOM.render(&lt;App /&gt;, rootNode)</code></li>\n<li>blocking — <code class="language-text">ReactDOM.createBlockingRoot(rootNode).render(&lt;App /&gt;)</code></li>\n<li>concurrent — <code class="language-text">ReactDOM.createRoot(rootNode).render(&lt;App /&gt;)</code></li>\n</ul>\n<blockquote>\n<p>你可以在<a href="https://zh-hans.reactjs.org/docs/concurrent-mode-adoption.html#why-so-many-modes" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 React 团队解释为什么会有这么多模式</p>\n</blockquote>\n<p>虽然不同模式的入口函数不同，但是他们仅对 fiber.mode 变量产生影响，对我们在流程概览中描述的流程并无影响。</p>\n<h2 id="thissetstate"><a href="#thissetstate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>this.setState</h2>\n<p>当我们有了前面知识的铺垫，就很容易理解 this.setState 的工作流程。</p>\n<h3 id="流程概览-2"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概览</h3>\n<p>可以看到，this.setState 内会调用 this.updater.enqueueSetState 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22457715872331030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Component.prototype.setState = function(partialState, callback) {\n  if (!(typeof partialState === \'object\' || typeof partialState === \'function\' || partialState == null)) {\n    {\n      throw Error(\n        \'setState(...): takes an object of state variables to update or a function which returns an object of state variables.\'\n      );\n    }\n  }\n  this.updater.enqueueSetState(this, partialState, callback, \'setState\');\n};`, `22457715872331030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">partialState<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> partialState <span class="token operator">===</span> <span class="token string">\'object\'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> partialState <span class="token operator">===</span> <span class="token string">\'function\'</span> <span class="token operator">||</span> partialState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token punctuation">{</span>\n      <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>\n        <span class="token string">\'setState(...): takes an object of state variables to update or a function which returns an object of state variables.\'</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token string">\'setState\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react/src/ReactBaseClasses.js#L57" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段代码</p>\n</blockquote>\n<p>在 enqueueSetState 方法中就是我们熟悉的从创建 update 到调度 update 的流程了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18175128899308591000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`enqueueSetState(inst, payload, callback) {\n  // 通过组件实例获取对应 fiber\n  const fiber = getInstance(inst);\n\n  const eventTime = requestEventTime();\n  const suspenseConfig = requestCurrentSuspenseConfig();\n\n  // 获取优先级\n  const lane = requestUpdateLane(fiber, suspenseConfig);\n\n  // 创建 update\n  const update = createUpdate(eventTime, lane, suspenseConfig);\n\n  update.payload = payload;\n\n  // 赋值回调函数\n  if (callback !== undefined && callback !== null) {\n    update.callback = callback;\n  }\n\n  // 将 update 插入 updateQueue\n  enqueueUpdate(fiber, update);\n  // 调度 update\n  scheduleUpdateOnFiber(fiber, lane, eventTime);\n}`, `18175128899308591000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 通过组件实例获取对应 fiber</span>\n  <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 获取优先级</span>\n  <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 创建 update</span>\n  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span>\n\n  <span class="token comment">// 赋值回调函数</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 将 update 插入 updateQueue</span>\n  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 调度 update</span>\n  <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L196" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 enqueueSetState 代码</p>\n</blockquote>\n<p>这里值得注意的是对于 ClassComponent，update.payload 为 this.setState 的第一个传参（即要改变的 state）。</p>\n<h3 id="thisforceupdate"><a href="#thisforceupdate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>this.forceUpdate</h3>\n<p>在 this.updater 上，除了 enqueueSetState 外，还存在 enqueueForceUpdate，当我们调用 this.forceUpdate 时会调用他。</p>\n<p>可以看到，除了赋值 <code class="language-text">update.tag = ForceUpdate;</code> 以及没有 payload 外，其他逻辑与 this.setState 一致。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78611121459721620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`enqueueForceUpdate(inst, callback) {\n    const fiber = getInstance(inst);\n    const eventTime = requestEventTime();\n    const suspenseConfig = requestCurrentSuspenseConfig();\n    const lane = requestUpdateLane(fiber, suspenseConfig);\n\n    const update = createUpdate(eventTime, lane, suspenseConfig);\n\n    // 赋值 tag 为 ForceUpdate\n    update.tag = ForceUpdate;\n\n    if (callback !== undefined && callback !== null) {\n      update.callback = callback;\n    }\n\n    enqueueUpdate(fiber, update);\n    scheduleUpdateOnFiber(fiber, lane, eventTime);\n  },\n};`, `78611121459721620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">enqueueForceUpdate</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 赋值 tag 为 ForceUpdate</span>\n    update<span class="token punctuation">.</span>tag <span class="token operator">=</span> ForceUpdate<span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L260" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 enqueueForceUpdate 代码</p>\n</blockquote>\n<p>那么赋值 <code class="language-text">update.tag = ForceUpdate;</code> 有何作用呢？</p>\n<p>在判断 ClassComponent 是否需要更新时有两个条件需要满足：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67671669046944880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const shouldUpdate =\n  checkHasForceUpdateAfterProcessing() ||\n  checkShouldComponentUpdate(workInProgress, ctor, oldProps, newProps, oldState, newState, nextContext);`, `67671669046944880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> shouldUpdate <span class="token operator">=</span>\n  <span class="token function">checkHasForceUpdateAfterProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>\n  <span class="token function">checkShouldComponentUpdate</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> oldState<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L1137" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段代码</p>\n</blockquote>\n<ul>\n<li>checkHasForceUpdateAfterProcessing：内部会判断本次更新的 Update 是否为 ForceUpdate。即如果本次更新的 Update 中存在 tag 为 ForceUpdate，则返回 true。</li>\n<li>checkShouldComponentUpdate：内部会调用 shouldComponentUpdate 方法。以及当该 ClassComponent 为 PureComponent 时会浅比较 state 与 props。</li>\n</ul>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L294" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 checkShouldComponentUpdate 代码</p>\n</blockquote>\n<p>所以，当某次更新含有 tag 为 ForceUpdate 的 Update，那么当前 ClassComponent 不会受其他性能优化手段（shouldComponentUpdate|PureComponent）影响，一定会更新。</p>\n<h3 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>至此，我们学习完了 <code class="language-text">HostRoot | ClassComponent</code> 所使用的 Update 的更新流程。</p>\n<p>在下一章我们会学习另一种数据结构的 Update —— 用于 Hooks 的 Update。</p>\n<h1 id="hooks"><a href="#hooks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hooks</h1>\n<h2 id="hooks-理念"><a href="#hooks-%E7%90%86%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hooks 理念</h2>\n<p>你可以从<a href="https://zh-hans.reactjs.org/docs/hooks-intro.html#motivation" target="_blank" rel="nofollow noreferrer noopener">这里</a>了解 Hooks 的设计动机。作为一名框架使用者，了解设计动机对于我们日常开发就足够了。</p>\n<p>但是，为了更好的理解 Hooks 的源码架构，我们需要转换身份，以框架开发者的角度来看待 Hooks 的设计理念。</p>\n<h3 id="从-logo-聊起"><a href="#%E4%BB%8E-logo-%E8%81%8A%E8%B5%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从 LOGO 聊起</h3>\n<p>React LOGO 的图案是代表原子（atom）的符号。世间万物由原子组成，原子的类型与属性决定了事物的外观与表现。</p>\n<p>同样，在 React 中，我们可以将 UI 拆分为很多独立的单元，每个单元被称为 Component。这些 Component 的属性与类型决定了 UI 的外观与表现。</p>\n<p>讽刺的是，原子在希腊语中的意思为不可分割的（indivisible），但随后科学家在原子中发现了更小的粒子 —— 电子（electron）。电子可以很好的解释原子是如何工作的。</p>\n<p>在 React 中，我们可以说 ClassComponent 是一类原子。</p>\n<p>但对于 Hooks 来说，与其说是一类原子，不如说他是更贴近事物运行规律的电子。</p>\n<p>我们知道，React 的架构遵循 schedule - render - commit 的运行流程，这个流程是 React 世界最底层的运行规律。</p>\n<p>ClassComponent 作为 React 世界的原子，他的生命周期（componentWillXXX/componentDidXXX）是为了介入 React 的运行流程而实现的更上层抽象，这么做是为了方便框架使用者更容易上手。</p>\n<p>相比于 ClassComponent 的更上层抽象，Hooks 则更贴近 React 内部运行的各种概念（state | context | life-cycle）。</p>\n<p>作为使用 React 技术栈的开发者，当我们初次学习 Hooks 时，不管是官方文档还是身边有经验的同事，总会拿 ClassComponent 的生命周期来类比 Hooks API 的执行时机。</p>\n<p>这固然是很好的上手方式，但是当我们熟练运用 Hooks 时，就会发现，这两者的概念有很多割裂感，并不是同一抽象层次可以互相替代的概念。</p>\n<p>比如：替代 componentWillReceiveProps 的 Hooks 是什么呢？</p>\n<p>可能有些同学会回答，是 useEffect：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39592522209201865000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`useEffect(() => {\n  console.log(\'something updated\');\n}, [props.something]);`, `39592522209201865000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'something updated\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>props<span class="token punctuation">.</span>something<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但是 componentWillReceiveProps 是在 render 阶段执行，而 useEffect 是在 commit 阶段完成渲染后异步执行。</p>\n<blockquote>\n<p>这篇文章可以帮你更好理解 componentWillReceiveProps：<a href="https://juejin.im/post/5f05a3e25188252e5c576cdb" target="_blank" rel="nofollow noreferrer noopener">深入源码剖析 componentWillXXX 为什么 UNSAFE</a></p>\n</blockquote>\n<p>所以，从源码运行规律的角度看待 Hooks，可能是更好的角度。这也是为什么上文说 Hooks 是 React 世界的电子而不是原子的原因。</p>\n<blockquote>\n<p>以上见解参考自<a href="https://www.youtube.com/watch?v=dpw9EHDh2bM&#x26;feature=youtu.be" target="_blank" rel="nofollow noreferrer noopener">React Core Team Dan 在 React Conf2018 的演讲</a></p>\n</blockquote>\n<h3 id="总结-2"><a href="#%E6%80%BB%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>Concurrent Mode 是 React 未来的发展方向，而 Hooks 是能够最大限度发挥 Concurrent Mode 潜力的 Component 构建方式。</p>\n<p>正如 Dan 在 React Conf 2018 演讲结尾所说：你可以从 React 的 LOGO 中看到这些围绕着核心的电子飞行轨道，Hooks 可能一直就在其中。</p>\n<h2 id="极简-hooks-实现"><a href="#%E6%9E%81%E7%AE%80-hooks-%E5%AE%9E%E7%8E%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>极简 Hooks 实现</h2>\n<p>为了更好理解 Hooks 原理，这一节我们遵循 React 的运行流程，实现一个不到 100 行代码的极简 useState Hook。建议对照着代码来看本节内容。</p>\n<h3 id="工作原理"><a href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工作原理</h3>\n<p>对于 useState Hook，考虑如下例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4151562821346877000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  const [num, updateNum] = useState(0);\n\n  return <p onClick={() => updateNum((num) => num + 1)}>{num}</p>;\n}`, `4151562821346877000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以将工作分为两部分：</p>\n<ol>\n<li>通过一些途径产生更新，更新会造成组件 render。</li>\n<li>组件 render 时 useState 返回的 num 为更新后的结果。</li>\n</ol>\n<p>其中步骤 1 的更新可以分为 mount 和 update：</p>\n<ol>\n<li>调用 ReactDOM.render 会产生 mount 的更新，更新内容为 useState 的 initialValue（即 0）。</li>\n<li>点击 p 标签触发 updateNum 会产生一次 update 的更新，更新内容为 num => num + 1。</li>\n</ol>\n<p>接下来讲解这两个步骤如何实现。</p>\n<h3 id="更新是什么"><a href="#%E6%9B%B4%E6%96%B0%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更新是什么</h3>\n<blockquote>\n<p>通过一些途径产生更新，更新会造成组件 render。</p>\n</blockquote>\n<p>首先我们要明确更新是什么。</p>\n<p>在我们的极简例子中，更新就是如下数据结构：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72813344068472150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const update = {\n  // 更新执行的函数\n  action,\n  // 与同一个 Hook 的其他更新形成链表\n  next: null\n};`, `72813344068472150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 更新执行的函数</span>\n  action<span class="token punctuation">,</span>\n  <span class="token comment">// 与同一个 Hook 的其他更新形成链表</span>\n  next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于 App 来说，点击 p 标签产生的 update 的 action 为 num => num + 1。</p>\n<p>如果我们改写下 App 的 onClick：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55788184640088965000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 之前\nreturn <p onClick={() => updateNum((num) => num + 1)}>{num}</p>;\n\n// 之后\nreturn (\n  <p\n    onClick={() => {\n      updateNum((num) => num + 1);\n      updateNum((num) => num + 1);\n      updateNum((num) => num + 1);\n    }}\n  >\n    {num}\n  </p>\n);`, `55788184640088965000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 之前</span>\n<span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><span class="token punctuation">;</span>\n\n<span class="token comment">// 之后</span>\n<span class="token keyword">return</span> <span class="token punctuation">(</span>\n  <span class="token operator">&lt;</span>p\n    onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">}</span>\n  <span class="token operator">></span>\n    <span class="token punctuation">{</span>num<span class="token punctuation">}</span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>\n<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么点击 p 标签会产生三个 update。</p>\n<h3 id="update-数据结构"><a href="#update-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>update 数据结构</h3>\n<p>这些 update 是如何组合在一起呢？</p>\n<p>答案是：他们会形成环状单向链表。</p>\n<p>调用 updateNum 实际调用的是 <code class="language-text">dispatchAction.bind(null, hook.queue)</code>，我们先来了解下这个函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97717198297515970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function dispatchAction(queue, action) {\n  // 创建 update\n  const update = {\n    action,\n    next: null\n  };\n\n  // 环状单向链表操作\n  if (queue.pending === null) {\n    update.next = update;\n  } else {\n    update.next = queue.pending.next;\n    queue.pending.next = update;\n  }\n  queue.pending = update;\n\n  // 模拟 React 开始调度更新\n  schedule();\n}`, `97717198297515970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 创建 update</span>\n  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>\n    action<span class="token punctuation">,</span>\n    next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 环状单向链表操作</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    update<span class="token punctuation">.</span>next <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n    queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>\n\n  <span class="token comment">// 模拟 React 开始调度更新</span>\n  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>环状链表操作不太容易理解，这里我们详细讲解下。</p>\n<p>当产生第一个 update（我们叫他 u0），此时 <code class="language-text">queue.pending === null</code>。</p>\n<p><code class="language-text">update.next = update;</code> 即 <code class="language-text">u0.next = u0</code>，他会和自己首尾相连形成单向环状链表。</p>\n<p>然后 <code class="language-text">queue.pending = update;</code> 即 <code class="language-text">queue.pending = u0</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65026983603423070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`queue.pending = u0 ---> u0\n                ^       |\n                |       |\n                ---------`, `65026983603423070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> u0 <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">></span> u0\n                <span class="token operator">^</span>       <span class="token operator">|</span>\n                <span class="token operator">|</span>       <span class="token operator">|</span>\n                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当产生第二个 update（我们叫他 u1），<code class="language-text">update.next = queue.pending.next;</code>，此时 <code class="language-text">queue.pending.next === u0</code>，即 <code class="language-text">u1.next = u0</code>。</p>\n<p><code class="language-text">queue.pending.next = update;</code> 即 <code class="language-text">u0.next = u1</code>。</p>\n<p>然后 <code class="language-text">queue.pending = update;</code> 即 <code class="language-text">queue.pending = u1</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76918344048973820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`queue.pending = u1 ---> u0\n                ^       |\n                |       |\n                ---------`, `76918344048973820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> u1 <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">></span> u0\n                <span class="token operator">^</span>       <span class="token operator">|</span>\n                <span class="token operator">|</span>       <span class="token operator">|</span>\n                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以照着这个例子模拟插入多个 update 的情况，会发现 queue.pending 始终指向最后一个插入的 update。</p>\n<p>这样做的好处是，当我们要遍历 update 时，queue.pending.next 指向第一个插入的 update。</p>\n<h3 id="状态如何保存"><a href="#%E7%8A%B6%E6%80%81%E5%A6%82%E4%BD%95%E4%BF%9D%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>状态如何保存</h3>\n<p>现在我们知道，更新产生的 update 对象会保存在 queue 中。</p>\n<p>不同于 ClassComponent 的实例可以存储数据，对于 FunctionComponent，queue 存储在哪里呢？</p>\n<p>答案是：FunctionComponent 对应的 fiber 中。</p>\n<p>我们使用如下精简的 fiber 结构：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97372512347178250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// App 组件对应的 fiber 对象\nconst fiber = {\n  // 保存该 FunctionComponent 对应的 Hooks 链表\n  memoizedState: null,\n  // 指向 App 函数\n  stateNode: App\n};`, `97372512347178250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// App 组件对应的 fiber 对象</span>\n<span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 保存该 FunctionComponent 对应的 Hooks 链表</span>\n  memoizedState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  <span class="token comment">// 指向 App 函数</span>\n  stateNode<span class="token punctuation">:</span> App\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="hook-数据结构"><a href="#hook-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hook 数据结构</h3>\n<p>接下来我们关注 fiber.memoizedState 中保存的 Hook 的数据结构。</p>\n<p>可以看到，Hook 与 update 类似，都通过链表连接。不过 Hook 是无环的单向链表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93052807654906870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`hook = {\n  // 保存 update 的 queue，即上文介绍的 queue\n  queue: {\n    pending: null\n  },\n  // 保存 hook 对应的 state\n  memoizedState: initialState,\n  // 与下一个 Hook 连接形成单向无环链表\n  next: null\n};`, `93052807654906870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">hook <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 保存 update 的 queue，即上文介绍的 queue</span>\n  queue<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n    pending<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// 保存 hook 对应的 state</span>\n  memoizedState<span class="token punctuation">:</span> initialState<span class="token punctuation">,</span>\n  <span class="token comment">// 与下一个 Hook 连接形成单向无环链表</span>\n  next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意</p>\n<p>注意区分 update 与 hook 的所属关系：</p>\n<p>每个 useState 对应一个 hook 对象。</p>\n<p>调用 <code class="language-text">const [num, updateNum] = useState(0);</code> 时 updateNum（即上文介绍的 dispatchAction）产生的 update 保存在 useState 对应的 hook.queue 中。</p>\n</blockquote>\n<h3 id="模拟-react-调度更新流程"><a href="#%E6%A8%A1%E6%8B%9F-react-%E8%B0%83%E5%BA%A6%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模拟 React 调度更新流程</h3>\n<p>在上文 dispatchAction 末尾我们通过 schedule 方法模拟 React 调度更新流程。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76039812861605540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function dispatchAction(queue, action) {\n  // ...创建 update\n\n  // ...环状单向链表操作\n\n  // 模拟 React 开始调度更新\n  schedule();\n}`, `76039812861605540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...创建 update</span>\n\n  <span class="token comment">// ...环状单向链表操作</span>\n\n  <span class="token comment">// 模拟 React 开始调度更新</span>\n  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们来实现他。</p>\n<p>我们用 isMount 变量指代是 mount 还是 update。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53676478070806490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 首次 render 时是 mount\nisMount = true;\n\nfunction schedule() {\n  // 更新前将 workInProgressHook 重置为 fiber 保存的第一个 Hook\n  workInProgressHook = fiber.memoizedState;\n  // 触发组件 render\n  fiber.stateNode();\n  // 组件首次 render 为 mount，以后再触发的更新为 update\n  isMount = false;\n}`, `53676478070806490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 首次 render 时是 mount</span>\nisMount <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 更新前将 workInProgressHook 重置为 fiber 保存的第一个 Hook</span>\n  workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>\n  <span class="token comment">// 触发组件 render</span>\n  fiber<span class="token punctuation">.</span><span class="token function">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 组件首次 render 为 mount，以后再触发的更新为 update</span>\n  isMount <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 workInProgressHook 变量指向当前正在工作的 hook。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75453817937124560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`workInProgressHook = fiber.memoizedState;`, `75453817937124560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在组件 render 时，每当遇到下一个 useState，我们移动 workInProgressHook 的指针。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46318808115160360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`workInProgressHook = workInProgressHook.next;`, `46318808115160360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样，只要每次组件 render 时 useState 的调用顺序及数量保持一致，那么始终可以通过 workInProgressHook 找到当前 useState 对应的 hook 对象。</p>\n<p>到此为止，我们已经完成第一步。</p>\n<blockquote>\n<p>通过一些途径产生更新，更新会造成组件 render。</p>\n</blockquote>\n<p>接下来实现第二步。</p>\n<blockquote>\n<p>组件 render 时 useState 返回的 num 为更新后的结果。</p>\n</blockquote>\n<h3 id="计算-state"><a href="#%E8%AE%A1%E7%AE%97-state" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>计算 state</h3>\n<p>组件 render 时会调用 useState，他的大体逻辑如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92808483030094800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function useState(initialState) {\n  // 当前 useState 使用的 hook 会被赋值该该变量\n  let hook;\n\n  if (isMount) {\n    // ...mount 时需要生成 hook 对象\n  } else {\n    // ...update 时从 workInProgressHook 中取出该 useState 对应的 hook\n  }\n\n  let baseState = hook.memoizedState;\n  if (hook.queue.pending) {\n    // ...根据 queue.pending 中保存的 update 更新 state\n  }\n  hook.memoizedState = baseState;\n\n  return [baseState, dispatchAction.bind(null, hook.queue)];\n}`, `92808483030094800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 当前 useState 使用的 hook 会被赋值该该变量</span>\n  <span class="token keyword">let</span> hook<span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...mount 时需要生成 hook 对象</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...update 时从 workInProgressHook 中取出该 useState 对应的 hook</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...根据 queue.pending 中保存的 update 更新 state</span>\n  <span class="token punctuation">}</span>\n  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们首先关注如何获取 hook 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45444154672472890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (isMount) {\n  // mount 时为该 useState 生成 hook\n  hook = {\n    queue: {\n      pending: null\n    },\n    memoizedState: initialState,\n    next: null\n  };\n\n  // 将 hook 插入 fiber.memoizedState 链表末尾\n  if (!fiber.memoizedState) {\n    fiber.memoizedState = hook;\n  } else {\n    workInProgressHook.next = hook;\n  }\n  // 移动 workInProgressHook 指针\n  workInProgressHook = hook;\n} else {\n  // update 时找到对应 hook\n  hook = workInProgressHook;\n  // 移动 workInProgressHook 指针\n  workInProgressHook = workInProgressHook.next;\n}`, `45444154672472890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// mount 时为该 useState 生成 hook</span>\n  hook <span class="token operator">=</span> <span class="token punctuation">{</span>\n    queue<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      pending<span class="token punctuation">:</span> <span class="token keyword">null</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    memoizedState<span class="token punctuation">:</span> initialState<span class="token punctuation">,</span>\n    next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 将 hook 插入 fiber.memoizedState 链表末尾</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    fiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// 移动 workInProgressHook 指针</span>\n  workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// update 时找到对应 hook</span>\n  hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>\n  <span class="token comment">// 移动 workInProgressHook 指针</span>\n  workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当找到该 useState 对应的 hook 后，如果该 hook.queue.pending 不为空（即存在 update），则更新其 state。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22693928311277834000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// update 执行前的初始 state\nlet baseState = hook.memoizedState;\n\nif (hook.queue.pending) {\n  // 获取 update 环状单向链表中第一个 update\n  let firstUpdate = hook.queue.pending.next;\n\n  do {\n    // 执行 update action\n    const action = firstUpdate.action;\n    baseState = action(baseState);\n    firstUpdate = firstUpdate.next;\n\n    // 最后一个 update 执行完后跳出循环\n  } while (firstUpdate !== hook.queue.pending.next);\n\n  // 清空 queue.pending\n  hook.queue.pending = null;\n}\n\n// 将 update action 执行完后的 state 作为 memoizedState\nhook.memoizedState = baseState;`, `22693928311277834000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// update 执行前的初始 state</span>\n<span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取 update 环状单向链表中第一个 update</span>\n  <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n\n  <span class="token keyword">do</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 执行 update action</span>\n    <span class="token keyword">const</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action<span class="token punctuation">;</span>\n    baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n\n    <span class="token comment">// 最后一个 update 执行完后跳出循环</span>\n  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 清空 queue.pending</span>\n  hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 将 update action 执行完后的 state 作为 memoizedState</span>\nhook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>完整代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37199993480038780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function useState(initialState) {\n  let hook;\n\n  if (isMount) {\n    hook = {\n      queue: {\n        pending: null\n      },\n      memoizedState: initialState,\n      next: null\n    };\n    if (!fiber.memoizedState) {\n      fiber.memoizedState = hook;\n    } else {\n      workInProgressHook.next = hook;\n    }\n    workInProgressHook = hook;\n  } else {\n    hook = workInProgressHook;\n    workInProgressHook = workInProgressHook.next;\n  }\n\n  let baseState = hook.memoizedState;\n  if (hook.queue.pending) {\n    let firstUpdate = hook.queue.pending.next;\n\n    do {\n      const action = firstUpdate.action;\n      baseState = action(baseState);\n      firstUpdate = firstUpdate.next;\n    } while (firstUpdate !== hook.queue.pending);\n\n    hook.queue.pending = null;\n  }\n  hook.memoizedState = baseState;\n\n  return [baseState, dispatchAction.bind(null, hook.queue)];\n}`, `37199993480038780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> hook<span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    hook <span class="token operator">=</span> <span class="token punctuation">{</span>\n      queue<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        pending<span class="token punctuation">:</span> <span class="token keyword">null</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      memoizedState<span class="token punctuation">:</span> initialState<span class="token punctuation">,</span>\n      next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      fiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>\n    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n\n    <span class="token keyword">do</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action<span class="token punctuation">;</span>\n      baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="对触发事件进行抽象"><a href="#%E5%AF%B9%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6%E8%BF%9B%E8%A1%8C%E6%8A%BD%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对触发事件进行抽象</h3>\n<p>最后，让我们抽象一下 React 的事件触发方式</p>\n<p>通过调用 App 返回的 click 方法模拟组件 click 的行为。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86664587914494660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  const [num, updateNum] = useState(0);\n\n  console.log(\\`\\${isMount ? \'mount\' : \'update\'} num: \\`, num);\n\n  return {\n    click() {\n      updateNum((num) => num + 1);\n    }\n  };\n}`, `86664587914494660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isMount <span class="token operator">?</span> <span class="token string">\'mount\'</span> <span class="token punctuation">:</span> <span class="token string">\'update\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> num: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="在线-demo"><a href="#%E5%9C%A8%E7%BA%BF-demo" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在线 Demo</h3>\n<p>至此，我们完成了一个不到 100 行代码的 Hooks。重要的是，他与 React 的运行逻辑相同。</p>\n<div>\n          <div\n            class="gatsby-resp-iframe-wrapper"\n            style="padding-bottom: 25%; position: relative; height: 0; overflow: hidden;margin-bottom: 2em"\n          >\n            <iframe src="/examples/react-technology-notes-realization/use-state-demo.html" style="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n          "></iframe>\n          </div>\n          </div>\n<p><div class="gatsby-highlight">\n        <pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>JS Bin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>加1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>加3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>console<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">\n    <span class="token keyword">let</span> workInProgressHook<span class="token punctuation">;</span>\n    <span class="token comment">// 首次 render 时是 mount</span>\n    <span class="token keyword">let</span> isMount <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// App 组件对应的 fiber 对象</span>\n    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 保存该 FunctionComponent 对应的 Hooks 链表</span>\n      memoizedState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n      <span class="token comment">// 指向 App 函数</span>\n      stateNode<span class="token punctuation">:</span> App\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">function</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 更新前将 workInProgressHook 重置为 fiber 保存的第一个 Hook</span>\n      workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>\n      <span class="token comment">// 触发组件 render</span>\n      <span class="token keyword">const</span> app <span class="token operator">=</span> fiber<span class="token punctuation">.</span><span class="token function">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// 组件首次 render 为 mount，以后再触发的更新为 update</span>\n      isMount <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> app<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 创建 update</span>\n      <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>\n        action<span class="token punctuation">,</span>\n        next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 环状单向链表操作</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        update<span class="token punctuation">.</span>next <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n        queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 模拟 React 开始调度更新</span>\n      queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>\n\n      <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 当前 useState 使用的 hook 会被赋值该变量</span>\n      <span class="token keyword">let</span> hook<span class="token punctuation">;</span>\n\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// mount 时需要生成 hook 对象</span>\n        hook <span class="token operator">=</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 保存 update 的 queue，即上文介绍的 queue</span>\n          queue<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n            pending<span class="token punctuation">:</span> <span class="token keyword">null</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n          <span class="token comment">// 保存 hook 对应的 state</span>\n          memoizedState<span class="token punctuation">:</span> initialState<span class="token punctuation">,</span>\n          <span class="token comment">// 与下一个 Hook 连接形成单向无环链表</span>\n          next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 将 hook 插入 fiber.memoizedState 链表末尾</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          fiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">// 移动 workInProgressHook 指针</span>\n        workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// update 时从 workInProgressHook 中取出该 useState 对应的 hook</span>\n        hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>\n        <span class="token comment">// 移动 workInProgressHook 指针</span>\n        workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 根据 queue.pending 中保存的 update 更新 state</span>\n        <span class="token comment">// 获取 update 环状单向链表中第一个 update</span>\n        <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n        <span class="token keyword">do</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 执行 update action</span>\n          <span class="token keyword">const</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action<span class="token punctuation">;</span>\n          baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span><span class="token punctuation">;</span>\n          firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>\n\n          <span class="token comment">// 最后一个 update 执行完后跳出循环</span>\n        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span>\n\n        <span class="token comment">// 清空 queue.pending</span>\n        hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 将 update action 执行完后的 state 作为 memoizedState</span>\n      hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>\n\n      <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> consoleDOM <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#console\'</span><span class="token punctuation">)</span>\n      <span class="token keyword">const</span> textDOM <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createContextualFragment</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isMount <span class="token operator">?</span> <span class="token string">\'mount\'</span> <span class="token punctuation">:</span> <span class="token string">\'update\'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> num: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      consoleDOM<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>textDOM<span class="token punctuation">)</span>\n\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token function">clickOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function">clickThree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    window<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#btn1\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">clickOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#btn2\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">\'click\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      window<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">clickThree</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>\n        </div></p>\n<h3 id="与-react-的区别"><a href="#%E4%B8%8E-react-%E7%9A%84%E5%8C%BA%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与 React 的区别</h3>\n<p>我们用尽可能少的代码模拟了 Hooks 的运行，但是相比 React Hooks，他还有很多不足。以下是他与 React Hooks 的区别：</p>\n<ol>\n<li>React Hooks 没有使用 isMount 变量，而是在不同时机使用不同的 dispatcher。换言之，mount 时的 useState 与 update 时的 useState 不是同一个函数。</li>\n<li>React Hooks 有中途跳过更新的优化手段。</li>\n<li>React Hooks 有 batchedUpdates，当在 click 中触发三次 updateNum，精简 React 会触发三次更新，而 React 只会触发一次。</li>\n<li>React Hooks 的 update 有优先级概念，可以跳过不高优先的 update。</li>\n</ol>\n<p>更多的细节，我们会在本章后续小节讲解。</p>\n<h2 id="hooks-数据结构"><a href="#hooks-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hooks 数据结构</h2>\n<p>在上一节我们实现了一个极简的 useState，了解了 Hooks 的运行原理。</p>\n<p>本节我们讲解 Hooks 的数据结构，为后面介绍具体的 hook 打下基础。</p>\n<h3 id="dispatcher"><a href="#dispatcher" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dispatcher</h3>\n<p>在上一节的极简 useState 实现中，使用 isMount 变量区分 mount 与 update。</p>\n<p>在真实的 Hooks 中，组件 mount 时的 hook 与 update 时的 hook 来源于不同的对象，这类对象在源码中被称为 dispatcher。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16194064829074172000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// mount 时的 Dispatcher\nconst HooksDispatcherOnMount: Dispatcher = {\n  useCallback: mountCallback,\n  useContext: readContext,\n  useEffect: mountEffect,\n  useImperativeHandle: mountImperativeHandle,\n  useLayoutEffect: mountLayoutEffect,\n  useMemo: mountMemo,\n  useReducer: mountReducer,\n  useRef: mountRef,\n  useState: mountState\n  // ...省略\n};\n\n// update 时的 Dispatcher\nconst HooksDispatcherOnUpdate: Dispatcher = {\n  useCallback: updateCallback,\n  useContext: readContext,\n  useEffect: updateEffect,\n  useImperativeHandle: updateImperativeHandle,\n  useLayoutEffect: updateLayoutEffect,\n  useMemo: updateMemo,\n  useReducer: updateReducer,\n  useRef: updateRef,\n  useState: updateState\n  // ...省略\n};`, `16194064829074172000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// mount 时的 Dispatcher</span>\n<span class="token keyword">const</span> HooksDispatcherOnMount<span class="token punctuation">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>\n  useCallback<span class="token punctuation">:</span> mountCallback<span class="token punctuation">,</span>\n  useContext<span class="token punctuation">:</span> readContext<span class="token punctuation">,</span>\n  useEffect<span class="token punctuation">:</span> mountEffect<span class="token punctuation">,</span>\n  useImperativeHandle<span class="token punctuation">:</span> mountImperativeHandle<span class="token punctuation">,</span>\n  useLayoutEffect<span class="token punctuation">:</span> mountLayoutEffect<span class="token punctuation">,</span>\n  useMemo<span class="token punctuation">:</span> mountMemo<span class="token punctuation">,</span>\n  useReducer<span class="token punctuation">:</span> mountReducer<span class="token punctuation">,</span>\n  useRef<span class="token punctuation">:</span> mountRef<span class="token punctuation">,</span>\n  useState<span class="token punctuation">:</span> mountState\n  <span class="token comment">// ...省略</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token comment">// update 时的 Dispatcher</span>\n<span class="token keyword">const</span> HooksDispatcherOnUpdate<span class="token punctuation">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>\n  useCallback<span class="token punctuation">:</span> updateCallback<span class="token punctuation">,</span>\n  useContext<span class="token punctuation">:</span> readContext<span class="token punctuation">,</span>\n  useEffect<span class="token punctuation">:</span> updateEffect<span class="token punctuation">,</span>\n  useImperativeHandle<span class="token punctuation">:</span> updateImperativeHandle<span class="token punctuation">,</span>\n  useLayoutEffect<span class="token punctuation">:</span> updateLayoutEffect<span class="token punctuation">,</span>\n  useMemo<span class="token punctuation">:</span> updateMemo<span class="token punctuation">,</span>\n  useReducer<span class="token punctuation">:</span> updateReducer<span class="token punctuation">,</span>\n  useRef<span class="token punctuation">:</span> updateRef<span class="token punctuation">,</span>\n  useState<span class="token punctuation">:</span> updateState\n  <span class="token comment">// ...省略</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见，mount 时调用的 hook 和 update 时调用的 hook 其实是两个不同的函数。</p>\n<p>在 FunctionComponent render 前，会根据 FunctionComponent 对应 fiber 的以下条件区分 mount 与 update。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8564406187207218000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`current === null || current.memoizedState === null;`, `8564406187207218000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>并将不同情况对应的 dispatcher 赋值给全局变量 ReactCurrentDispatcher 的 current 属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5024053361365666000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ReactCurrentDispatcher.current =\n  current === null || current.memoizedState === null ? HooksDispatcherOnMount : HooksDispatcherOnUpdate;`, `5024053361365666000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>\n  current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> HooksDispatcherOnMount <span class="token punctuation">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L409" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这行代码</p>\n</blockquote>\n<p>在 FunctionComponent render 时，会从 ReactCurrentDispatcher.current（即当前 dispatcher）中寻找需要的 hook。</p>\n<p>换言之，不同的调用栈上下文为 ReactCurrentDispatcher.current 赋值不同的 dispatcher，则 FunctionComponent render 时调用的 hook 也是不同的函数。</p>\n<blockquote>\n<p>除了这两个 dispatcher，你可以在<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1775" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到其他 dispatcher 定义</p>\n</blockquote>\n<h3 id="一个-dispatcher-使用场景"><a href="#%E4%B8%80%E4%B8%AA-dispatcher-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一个 dispatcher 使用场景</h3>\n<p>当错误的书写了嵌套形式的 hook，如：</p>\n<p>此时 ReactCurrentDispatcher.current 已经指向 ContextOnlyDispatcher，所以调用 useState 实际会调用 throwInvalidHookError，直接抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55740160083886070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export const ContextOnlyDispatcher: Dispatcher = {\n  useCallback: throwInvalidHookError,\n  useContext: throwInvalidHookError,\n  useEffect: throwInvalidHookError,\n  useImperativeHandle: throwInvalidHookError,\n  useLayoutEffect: throwInvalidHookError,\n  // ...省略`, `55740160083886070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> ContextOnlyDispatcher<span class="token punctuation">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>\n  useCallback<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>\n  useContext<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>\n  useEffect<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>\n  useImperativeHandle<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>\n  useLayoutEffect<span class="token punctuation">:</span> throwInvalidHookError<span class="token punctuation">,</span>\n  <span class="token comment">// ...省略</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以在<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L458" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段逻辑</p>\n<h3 id="hook-的数据结构"><a href="#hook-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hook 的数据结构</h3>\n<p>接下来我们学习 hook 的数据结构。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1061040147749725600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const hook: Hook = {\n  memoizedState: null,\n\n  baseState: null,\n  baseQueue: null,\n  queue: null,\n\n  next: null\n};`, `1061040147749725600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> hook<span class="token punctuation">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>\n  memoizedState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n\n  baseState<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  baseQueue<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  queue<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n\n  next<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L546" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到创建 hook 的逻辑</p>\n</blockquote>\n<p>其中除 memoizedState 以外字段的意义与上一章介绍的 updateQueue 类似。</p>\n<h3 id="memoizedstate"><a href="#memoizedstate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>memoizedState</h3>\n<p>hook 与 FunctionComponent fiber 都存在 memoizedState 属性，不要混淆他们的概念。</p>\n<p>fiber.memoizedState：FunctionComponent 对应 fiber 保存的 Hooks 链表。</p>\n<p>hook.memoizedState：Hooks 链表中保存的单一 hook 对应的数据。</p>\n<p>不同类型 hook 的 memoizedState 保存不同类型数据，具体如下：</p>\n<ul>\n<li>useState：对于 <code class="language-text">const [state, updateState] = useState(initialState)</code>，memoizedState 保存 state 的值</li>\n<li>useReducer：对于 <code class="language-text">const [state, dispatch] = useReducer(reducer, {});</code>，memoizedState 保存 state 的值</li>\n<li>useEffect：memoizedState 保存包含 useEffect 回调函数、依赖项等的链表数据结构 effect，你可以在<a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1181" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 effect 的创建过程。effect 链表同时会保存在 fiber.updateQueue 中</li>\n<li>useRef：对于 useRef(1)，memoizedState 保存 <code class="language-text">{current: 1}</code></li>\n<li>useMemo：对于 <code class="language-text">useMemo(callback, [depA])</code>，memoizedState 保存[ <code class="language-text">[callback(), depA]</code></li>\n<li>useCallback：对于 <code class="language-text">useCallback(callback, [depA])</code>，memoizedState 保存 <code class="language-text">[callback, depA]</code>。与 useMemo 的区别是，useCallback 保存的是 callback 函数本身，而 useMemo 保存的是 callback 函数的执行结果</li>\n</ul>\n<p>有些 hook 是没有 memoizedState 的，比如：</p>\n<ul>\n<li>useContext</li>\n</ul>\n<h2 id="usestate-与-usereducer"><a href="#usestate-%E4%B8%8E-usereducer" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>useState 与 useReducer</h2>\n<p>Redux 的作者 Dan 加入 React 核心团队后的一大贡献就是“将 Redux 的理念带入 React”。</p>\n<p>这里面最显而易见的影响莫过于 useState 与 useReducer 这两个 Hook。本质来说，useState 只是预置了 reducer 的 useReducer。</p>\n<p>本节我们来学习 useState 与 useReducer 的实现。</p>\n<h3 id="流程概览-3"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概览</h3>\n<p>我们将这两个 Hook 的工作流程分为声明阶段和调用阶段，对于：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3907041833868629500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  const [state, dispatch] = useReducer(reducer, { a: 1 });\n\n  const [num, updateNum] = useState(0);\n\n  return (\n    <div>\n      <button onClick={() => dispatch({ type: \'a\' })}>{state.a}</button>\n      <button onClick={() => updateNum((num) => num + 1)}>{num}</button>\n    </div>\n  );\n}`, `3907041833868629500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div<span class="token operator">></span>\n      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">\'a\'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>a<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>\n      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>声明阶段即 App 调用时，会依次执行 useReducer 与 useState 方法。</p>\n<p>调用阶段即点击按钮后，dispatch 或 updateNum 被调用时。</p>\n<h3 id="声明阶段"><a href="#%E5%A3%B0%E6%98%8E%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>声明阶段</h3>\n<p>当 FunctionComponent 进入 render 阶段的 beginWork 时，会调用 <a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L1419" target="_blank" rel="nofollow noreferrer noopener">renderWithHooks</a> 方法。</p>\n<p>该方法内部会执行 FunctionComponent 对应函数（即 fiber.type）。</p>\n<p>你可以在 <a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L415" target="_blank" rel="nofollow noreferrer noopener">这里</a> 看到这段逻辑</p>\n<p>对于这两个 Hook，他们的源码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39619977858761340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function useState(initialState) {\n  var dispatcher = resolveDispatcher();\n  return dispatcher.useState(initialState);\n}\nfunction useReducer(reducer, initialArg, init) {\n  var dispatcher = resolveDispatcher();\n  return dispatcher.useReducer(reducer, initialArg, init);\n}`, `39619977858761340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">useReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialArg<span class="token punctuation">,</span> init</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialArg<span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>正如上一节 <a href="https://react.iamkasong.com/hooks/structure.html#dispatcher" target="_blank" rel="nofollow noreferrer noopener">dispatcher</a> 所说，在不同场景下，同一个 Hook 会调用不同处理函数。</p>\n<p>我们分别讲解 mount 与 update 两个场景。</p>\n<h4 id="mount-时"><a href="#mount-%E6%97%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mount 时</h4>\n<p>mount 时，useReducer 会调用 <a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L638" target="_blank" rel="nofollow noreferrer noopener">mountReducer</a>，useState 会调用 <a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L1143" target="_blank" rel="nofollow noreferrer noopener">mountState</a>。</p>\n<p>我们来简单对比这这两个方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62458208032464445000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function mountState<S>(initialState: (() => S) | S): [S, Dispatch<BasicStateAction<S>>] {\n  // 创建并返回当前的 hook\n  const hook = mountWorkInProgressHook();\n\n  // ...赋值初始 state\n\n  // 创建 queue\n  const queue = (hook.queue = {\n    pending: null,\n    dispatch: null,\n    lastRenderedReducer: basicStateReducer,\n    lastRenderedState: (initialState: any)\n  });\n\n  // ...创建 dispatch\n  return [hook.memoizedState, dispatch];\n}\n\nfunction mountReducer<S, I, A>(reducer: (S, A) => S, initialArg: I, init?: (I) => S): [S, Dispatch<A>] {\n  // 创建并返回当前的 hook\n  const hook = mountWorkInProgressHook();\n\n  // ...赋值初始 state\n\n  // 创建 queue\n  const queue = (hook.queue = {\n    pending: null,\n    dispatch: null,\n    lastRenderedReducer: reducer,\n    lastRenderedState: (initialState: any)\n  });\n\n  // ...创建 dispatch\n  return [hook.memoizedState, dispatch];\n}`, `62458208032464445000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> mountState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">></span><span class="token punctuation">(</span>initialState<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">>></span><span class="token punctuation">]</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 创建并返回当前的 hook</span>\n  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...赋值初始 state</span>\n\n  <span class="token comment">// 创建 queue</span>\n  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>\n    pending<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    dispatch<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    lastRenderedReducer<span class="token punctuation">:</span> basicStateReducer<span class="token punctuation">,</span>\n    lastRenderedState<span class="token punctuation">:</span> <span class="token punctuation">(</span>initialState<span class="token punctuation">:</span> any<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...创建 dispatch</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> mountReducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function-variable function">reducer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">S</span><span class="token punctuation">,</span> initialArg<span class="token punctuation">:</span> <span class="token constant">I</span><span class="token punctuation">,</span> init<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">I</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 创建并返回当前的 hook</span>\n  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...赋值初始 state</span>\n\n  <span class="token comment">// 创建 queue</span>\n  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>\n    pending<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    dispatch<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n    lastRenderedReducer<span class="token punctuation">:</span> reducer<span class="token punctuation">,</span>\n    lastRenderedState<span class="token punctuation">:</span> <span class="token punctuation">(</span>initialState<span class="token punctuation">:</span> any<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// ...创建 dispatch</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中 mountWorkInProgressHook 方法会创建并返回对应 hook，对应极简 Hooks 实现中 useState 方法的 isMount 逻辑部分。</p>\n<p>可以看到，mount 时这两个 Hook 的唯一区别为 queue 参数的 lastRenderedReducer 字段。</p>\n<p>queue 的数据结构如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17271713179095527000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const queue = (hook.queue = {\n  // 与极简实现中的同名字段意义相同，保存 update 对象\n  pending: null,\n  // 保存 dispatchAction.bind() 的值\n  dispatch: null,\n  // 上一次 render 时使用的 reducer\n  lastRenderedReducer: reducer,\n  // 上一次 render 时的 state\n  lastRenderedState: (initialState: any)\n});`, `17271713179095527000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 与极简实现中的同名字段意义相同，保存 update 对象</span>\n  pending<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  <span class="token comment">// 保存 dispatchAction.bind() 的值</span>\n  dispatch<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  <span class="token comment">// 上一次 render 时使用的 reducer</span>\n  lastRenderedReducer<span class="token punctuation">:</span> reducer<span class="token punctuation">,</span>\n  <span class="token comment">// 上一次 render 时的 state</span>\n  lastRenderedState<span class="token punctuation">:</span> <span class="token punctuation">(</span>initialState<span class="token punctuation">:</span> any<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中，useReducer 的 lastRenderedReducer 为传入的 reducer 参数。useState 的 lastRenderedReducer 为 basicStateReducer。</p>\n<p>basicStateReducer 方法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53311753281812080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function basicStateReducer<S>(state: S, action: BasicStateAction<S>): S {\n  return typeof action === \'function\' ? action(state) : action;\n}`, `53311753281812080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> basicStateReducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">></span><span class="token punctuation">(</span>state<span class="token punctuation">:</span> <span class="token constant">S</span><span class="token punctuation">,</span> action<span class="token punctuation">:</span> BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">S</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">\'function\'</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">:</span> action<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>可见，useState 即 reducer 参数为 basicStateReducer 的 useReducer。</p>\n<p>mount 时的整体运行逻辑与极简实现的 isMount 逻辑类似，你可以对照着看。</p>\n<h4 id="update-时"><a href="#update-%E6%97%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>update 时</h4>\n<p>如果说 mount 时这两者还有区别，那 update 时，useReducer 与 useState 调用的则是同一个函数 <a href="https://github.com/acdlite/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberHooks.new.js#L665" target="_blank" rel="nofollow noreferrer noopener">updateReducer</a>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56122908599443180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function updateReducer<S, I, A>(reducer: (S, A) => S, initialArg: I, init?: (I) => S): [S, Dispatch<A>] {\n  // 获取当前 hook\n  const hook = updateWorkInProgressHook();\n  const queue = hook.queue;\n\n  queue.lastRenderedReducer = reducer;\n\n  // ...同 update 与 updateQueue 类似的更新逻辑\n\n  const dispatch: Dispatch<A> = (queue.dispatch: any);\n  return [hook.memoizedState, dispatch];\n}`, `56122908599443180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> updateReducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function-variable function">reducer</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">S</span><span class="token punctuation">,</span> initialArg<span class="token punctuation">:</span> <span class="token constant">I</span><span class="token punctuation">,</span> init<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">I</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 获取当前 hook</span>\n  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> queue <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>\n\n  queue<span class="token punctuation">.</span>lastRenderedReducer <span class="token operator">=</span> reducer<span class="token punctuation">;</span>\n\n  <span class="token comment">// ...同 update 与 updateQueue 类似的更新逻辑</span>\n\n  <span class="token keyword">const</span> dispatch<span class="token punctuation">:</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>整个流程可以概括为一句话：</p>\n<blockquote>\n<p>找到对应的 hook，根据 update 计算该 hook 的新 state 并返回。</p>\n</blockquote>\n<p>mount 时获取当前 hook 使用的是 mountWorkInProgressHook，而 update 时使用的是 updateWorkInProgressHook，这里的原因是：</p>\n<ul>\n<li>mount 时可以确定是调用 ReactDOM.render 或相关初始化 API 产生的更新，只会执行一次。</li>\n<li>update 可能是在事件回调或副作用中触发的更新或者是 render 阶段触发的更新，为了避免组件无限循环更新，后者需要区别对待。</li>\n</ul>',
id:"/github/workspace/blog/React技术解密笔记——实现篇/index.md absPath of file >>> MarkdownRemark",timeToRead:50,frontmatter:{date:"2021-02-01 10:53:07",path:"/react-technology-notes-realization/",tags:"前端, React, 高级前端",title:"React技术解密笔记——实现篇",draft:null}},{excerpt:"render 阶段 流程概览 本章我们会讲解 Fiber 节点是如何被创建并构建 Fiber 树的。 render 阶段开始于 performSyncWorkOnRoot 或 performConcurrentWorkOnRoot 方法的调用。这取决于本次更新是同步更新还是异步更新。 我们现在还不需要学习这两个方法，只需要知道在这两个方法中会调用如下两个方法： 可以看到，他们唯一的区别是是否调用 shouldYield。如果当前浏览器帧没有剩余时间，shouldYield…",html:'<h1 id="render-阶段"><a href="#render-%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>render 阶段</h1>\n<h2 id="流程概览"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概览</h2>\n<p>本章我们会讲解 Fiber 节点是如何被创建并构建 Fiber 树的。</p>\n<p>render 阶段开始于 performSyncWorkOnRoot 或 performConcurrentWorkOnRoot 方法的调用。这取决于本次更新是同步更新还是异步更新。</p>\n<p>我们现在还不需要学习这两个方法，只需要知道在这两个方法中会调用如下两个方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52738839424053060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// performSyncWorkOnRoot会调用该方法\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n\n// performConcurrentWorkOnRoot会调用该方法\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}`, `52738839424053060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// performSyncWorkOnRoot会调用该方法</span>\n<span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// performConcurrentWorkOnRoot会调用该方法</span>\n<span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，他们唯一的区别是是否调用 shouldYield。如果当前浏览器帧没有剩余时间，shouldYield 会中止循环，直到浏览器有空闲时间后再继续遍历。</p>\n<p>workInProgress 代表当前已创建的 workInProgress fiber。</p>\n<p>performUnitOfWork 方法会创建下一个 Fiber 节点并赋值给 workInProgress，并将 workInProgress 与已创建的 Fiber 节点连接起来构成 Fiber 树。</p>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1599" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 workLoopConcurrent 的源码</p>\n</blockquote>\n<p>我们知道 Fiber Reconciler 是从 Stack Reconciler 重构而来，通过遍历的方式实现可中断的递归，所以 performUnitOfWork 的工作可以分为两部分：“递”和“归”。</p>\n<h3 id="递阶段"><a href="#%E9%80%92%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>“递”阶段</h3>\n<p>首先从 rootFiber 开始向下深度优先遍历。为遍历到的每个 Fiber 节点调用 <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L3058" target="_blank" rel="nofollow noreferrer noopener">beginWork 方法</a>。</p>\n<p>该方法会根据传入的 Fiber 节点创建子 Fiber 节点，并将这两个 Fiber 节点连接起来。</p>\n<p>当遍历到叶子节点（即没有子组件的组件）时就会进入“归”阶段。</p>\n<h3 id="归阶段"><a href="#%E5%BD%92%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>“归”阶段</h3>\n<p>在“归”阶段会调用 <a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L652" target="_blank" rel="nofollow noreferrer noopener">completeWork</a> 处理 Fiber 节点。</p>\n<p>当某个 Fiber 节点执行完 completeWork，如果其存在兄弟 Fiber 节点（即 fiber.sibling !== null），会进入其兄弟 Fiber 的“递”阶段。</p>\n<p>如果不存在兄弟 Fiber，会进入父级 Fiber 的“归”阶段。</p>\n<p>“递”和“归”阶段会交错执行直到“归”到 rootFiber。至此，render 阶段的工作就结束了。</p>\n<h3 id="例子"><a href="#%E4%BE%8B%E5%AD%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h3>\n<p>以上一节的例子举例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80852733353915270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  return (\n    <div>\n      i am\n      <span>KaSong</span>\n    </div>\n  );\n}\n\nReactDOM.render(<App />, document.getElementById(\'root\'));`, `80852733353915270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div<span class="token operator">></span>\n      i am\n      <span class="token operator">&lt;</span>span<span class="token operator">></span>KaSong<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'root\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对应的 Fiber 树结构：</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-21-17-58-17-f6bcacfdef6508ce0ffa17d297746c02-d2875.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 82.6946847960445%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABu0lEQVQ4y41TC28TMQze//9TCCGBELAWNAqT1q3Pu+MeubwuT9uHr2WwCmhrRbHl5Ivtz87NeJCMZAIMEYaELpH2OQKOl+SGDkq75BIKZV69frPe7lwepYvsJzoLPioOE2F6YrlvN7Vim9flyEdVy6IST4CoPXAKvSlLsbbBXAYTkbSi6ksTcjsA753pGlWF5K+K7BMGGKUN35cb7eIQaYgTYXQN2AawkZT1H+d3jTQM3gofMh7zAgQgoL/Y+wVOObroEpAK1Nnkk/fRGx+HgHpQq+p+XT/EHP5d8659fCq/JoDeBB+hEqvH8ptxkrvAPfcpI/4/Mg+JZZ5srHRSPhsPMeNvOmqdTMSAI3NpPN+lkyFRLsVM2tgPn253+4KBrUkJ2I+FDNzC2ecvb9+9N3bgRg4hH7l8rhmQx9P41ErLnDNhteq2zbISBTttHHdN/7AXh4xGpNO0T2U65IIbWTIXm/q+FEXggJF60/3ot0LXZ8AvniHsdFspIT3aiHLQtayMUxfAB24pA/o8NkItlpvVrmKDx4HOpv1HmHP+pEVRzGbzu8XidjaX0+jRVWCWkCEAJRp5TcaLf/4TtbXfi5tRl/oAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 21 17 58 17"\n        title=""\n        src="/static/2021-01-21-17-58-17-f6bcacfdef6508ce0ffa17d297746c02-fee1c.png"\n        srcset="/static/2021-01-21-17-58-17-f6bcacfdef6508ce0ffa17d297746c02-a67b7.png 200w,\n/static/2021-01-21-17-58-17-f6bcacfdef6508ce0ffa17d297746c02-0b187.png 400w,\n/static/2021-01-21-17-58-17-f6bcacfdef6508ce0ffa17d297746c02-fee1c.png 800w,\n/static/2021-01-21-17-58-17-f6bcacfdef6508ce0ffa17d297746c02-b1a91.png 1200w,\n/static/2021-01-21-17-58-17-f6bcacfdef6508ce0ffa17d297746c02-95179.png 1600w,\n/static/2021-01-21-17-58-17-f6bcacfdef6508ce0ffa17d297746c02-d2875.png 1618w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>render 阶段会依次执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85211003728000680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1. rootFiber beginWork\n2. App Fiber beginWork\n3. div Fiber beginWork\n4. &quot;i am&quot; Fiber beginWork\n5. &quot;i am&quot; Fiber completeWork\n6. span Fiber beginWork\n7. span Fiber completeWork\n8. div Fiber completeWork\n9. App Fiber completeWork\n10. rootFiber completeWork`, `85211003728000680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1. rootFiber beginWork\n2. App Fiber beginWork\n3. div Fiber beginWork\n4. &quot;i am&quot; Fiber beginWork\n5. &quot;i am&quot; Fiber completeWork\n6. span Fiber beginWork\n7. span Fiber completeWork\n8. div Fiber completeWork\n9. App Fiber completeWork\n10. rootFiber completeWork</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意</p>\n<p>之所以没有 “KaSong” Fiber 的 beginWork/completeWork，是因为作为一种性能优化手段，针对只有单一文本子节点的 Fiber，React 会特殊处理。</p>\n</blockquote>\n<h2 id="beginwork"><a href="#beginwork" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>beginWork</h2>\n<p>上一节我们了解到 render 阶段的工作可以分为“递”阶段和“归”阶段。其中“递”阶段会执行 beginWork，“归”阶段会执行 completeWork。这一节我们看看“递”阶段的 beginWork 方法究竟做了什么。</p>\n<h3 id="方法概览"><a href="#%E6%96%B9%E6%B3%95%E6%A6%82%E8%A7%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方法概览</h3>\n<p>可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L3075" target="_blank" rel="nofollow noreferrer noopener">源码这里</a>看到 beginWork 的定义。整个方法大概有 500 行代码。</p>\n<p>从上一节我们已经知道，beginWork 的工作是传入当前 Fiber 节点，创建子 Fiber 节点，我们从传参来看看具体是如何做的。</p>\n<h4 id="从传参看方法执行"><a href="#%E4%BB%8E%E4%BC%A0%E5%8F%82%E7%9C%8B%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从传参看方法执行</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62334836803684060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function beginWork(current: Fiber | null, workInProgress: Fiber, renderLanes: Lanes): Fiber | null {\n  // ...省略函数体\n}`, `62334836803684060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> renderLanes<span class="token punctuation">:</span> Lanes</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...省略函数体</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>其中传参：</p>\n<ul>\n<li>current：当前组件对应的 Fiber 节点在上一次更新时的 Fiber 节点，即 workInProgress.alternate</li>\n<li>workInProgress：当前组件对应的 Fiber 节点</li>\n<li>renderLanes：优先级相关，在讲解 Scheduler 时再讲解</li>\n</ul>\n<p>从双缓存机制一节我们知道，除 rootFiber 以外， 组件 mount 时，由于是首次渲染，是不存在当前组件对应的 Fiber 节点在上一次更新时的 Fiber 节点，即 mount 时 current === null。</p>\n<p>组件 update 时，由于之前已经 mount 过，所以 current !== null。</p>\n<p>所以我们可以通过 <code class="language-text">current === null</code> 来区分组件是处于 mount 还是 update。</p>\n<p>基于此原因，beginWork 的工作可以分为两部分：</p>\n<ul>\n<li>update 时：如果 current 存在，在满足一定条件时可以复用 current 节点，这样就能克隆 current.child 作为 workInProgress.child，而不需要新建 workInProgress.child。</li>\n<li>mount 时：除 fiberRootNode 以外，current === null。会根据 fiber.tag 不同，创建不同类型的子 Fiber 节点</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29988485367269480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function beginWork(current: Fiber | null, workInProgress: Fiber, renderLanes: Lanes): Fiber | null {\n  // update 时：如果 current 存在可能存在优化路径\n  // 可以复用 current（即上一次更新的 Fiber 节点）\n  if (current !== null) {\n    // ...省略\n\n    // 复用 current\n    return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);\n  } else {\n    didReceiveUpdate = false;\n  }\n\n  // mount 时：根据 tag 不同，创建不同的子 Fiber 节点\n  switch (workInProgress.tag) {\n    case IndeterminateComponent:\n    // ...省略\n    case LazyComponent:\n    // ...省略\n    case FunctionComponent:\n    // ...省略\n    case ClassComponent:\n    // ...省略\n    case HostRoot:\n    // ...省略\n    case HostComponent:\n    // ...省略\n    case HostText:\n    // ...省略\n    // ...省略其他类型\n  }\n}`, `29988485367269480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> renderLanes<span class="token punctuation">:</span> Lanes</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>\n  <span class="token comment">// update 时：如果 current 存在可能存在优化路径</span>\n  <span class="token comment">// 可以复用 current（即上一次更新的 Fiber 节点）</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...省略</span>\n\n    <span class="token comment">// 复用 current</span>\n    <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// mount 时：根据 tag 不同，创建不同的子 Fiber 节点</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> IndeterminateComponent<span class="token punctuation">:</span>\n    <span class="token comment">// ...省略</span>\n    <span class="token keyword">case</span> LazyComponent<span class="token punctuation">:</span>\n    <span class="token comment">// ...省略</span>\n    <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>\n    <span class="token comment">// ...省略</span>\n    <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span>\n    <span class="token comment">// ...省略</span>\n    <span class="token keyword">case</span> HostRoot<span class="token punctuation">:</span>\n    <span class="token comment">// ...省略</span>\n    <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span>\n    <span class="token comment">// ...省略</span>\n    <span class="token keyword">case</span> HostText<span class="token punctuation">:</span>\n    <span class="token comment">// ...省略</span>\n    <span class="token comment">// ...省略其他类型</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="update-时"><a href="#update-%E6%97%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>update 时</h3>\n<p>我们可以看到，满足如下情况时 didReceiveUpdate === false（即可以直接复用前一次更新的子 Fiber，不需要新建子 Fiber）</p>\n<ol>\n<li><code class="language-text">oldProps === newProps &amp;&amp; workInProgress.type === current.type</code>，即 props 与 fiber.type 不变</li>\n<li><code class="language-text">!includesSomeLane(renderLanes, updateLanes)</code>，即当前 Fiber 节点优先级不够，会在讲解 Scheduler 时介绍</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13813560132074777000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (current !== null) {\n  const oldProps = current.memoizedProps;\n  const newProps = workInProgress.pendingProps;\n\n  if (oldProps !== newProps || hasLegacyContextChanged() || (__DEV__ ? workInProgress.type !== current.type : false)) {\n    didReceiveUpdate = true;\n  } else if (!includesSomeLane(renderLanes, updateLanes)) {\n    didReceiveUpdate = false;\n    switch (\n      workInProgress.tag\n      // 省略处理\n    ) {\n    }\n    return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);\n  } else {\n    didReceiveUpdate = false;\n  }\n} else {\n  didReceiveUpdate = false;\n}`, `13813560132074777000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> oldProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span> <span class="token function">hasLegacyContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> workInProgress<span class="token punctuation">.</span>type <span class="token operator">!==</span> current<span class="token punctuation">.</span>type <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">includesSomeLane</span><span class="token punctuation">(</span>renderLanes<span class="token punctuation">,</span> updateLanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>\n      workInProgress<span class="token punctuation">.</span>tag\n      <span class="token comment">// 省略处理</span>\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="mount-时"><a href="#mount-%E6%97%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mount 时</h3>\n<p>当不满足优化路径时，我们就进入第二部分，新建子 Fiber。</p>\n<p>我们可以看到，根据 fiber.tag 不同，进入不同类型 Fiber 的创建逻辑。</p>\n<p>可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactWorkTags.js" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 tag 对应的组件类型</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73494515105641150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// mount 时：根据 tag 不同，创建不同的 Fiber 节点\nswitch (workInProgress.tag) {\n  case IndeterminateComponent:\n  // ...省略\n  case LazyComponent:\n  // ...省略\n  case FunctionComponent:\n  // ...省略\n  case ClassComponent:\n  // ...省略\n  case HostRoot:\n  // ...省略\n  case HostComponent:\n  // ...省略\n  case HostText:\n  // ...省略\n  // ...省略其他类型\n}`, `73494515105641150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// mount 时：根据 tag 不同，创建不同的 Fiber 节点</span>\n<span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">case</span> IndeterminateComponent<span class="token punctuation">:</span>\n  <span class="token comment">// ...省略</span>\n  <span class="token keyword">case</span> LazyComponent<span class="token punctuation">:</span>\n  <span class="token comment">// ...省略</span>\n  <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>\n  <span class="token comment">// ...省略</span>\n  <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span>\n  <span class="token comment">// ...省略</span>\n  <span class="token keyword">case</span> HostRoot<span class="token punctuation">:</span>\n  <span class="token comment">// ...省略</span>\n  <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span>\n  <span class="token comment">// ...省略</span>\n  <span class="token keyword">case</span> HostText<span class="token punctuation">:</span>\n  <span class="token comment">// ...省略</span>\n  <span class="token comment">// ...省略其他类型</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于我们常见的组件类型，如（FunctionComponent/ClassComponent/HostComponent），最终会进入 reconcileChildren 方法。</p>\n<h3 id="reconcilechildren"><a href="#reconcilechildren" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>reconcileChildren</h3>\n<p>从该函数名就能看出这是 Reconciler 模块的核心部分。那么他究竟做了什么呢？</p>\n<ul>\n<li>对于 mount 的组件，他会创建新的子 Fiber 节点</li>\n<li>对于 update 的组件，他会将当前组件与该组件在上次更新时对应的 Fiber 节点比较（也就是俗称的 Diff 算法），将比较的结果生成新 Fiber 节点</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13779895608120451000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function reconcileChildren(current: Fiber | null, workInProgress: Fiber, nextChildren: any, renderLanes: Lanes) {\n  if (current === null) {\n    // 对于mount的组件\n    workInProgress.child = mountChildFibers(workInProgress, null, nextChildren, renderLanes);\n  } else {\n    // 对于update的组件\n    workInProgress.child = reconcileChildFibers(workInProgress, current.child, nextChildren, renderLanes);\n  }\n}`, `13779895608120451000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> nextChildren<span class="token punctuation">:</span> any<span class="token punctuation">,</span> renderLanes<span class="token punctuation">:</span> Lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对于mount的组件</span>\n    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 对于update的组件</span>\n    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> current<span class="token punctuation">.</span>child<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从代码可以看出，和 beginWork 一样，他也是通过 <code class="language-text">current === null</code> 区分 mount 与 update。</p>\n<p>不论走哪个逻辑，最终他会生成新的子 Fiber 节点并赋值给 workInProgress.child，作为本次 beginWork 返回值，并作为下次 performUnitOfWork 执行时 workInProgress 的传参。</p>\n<blockquote>\n<p>注意</p>\n<p>值得一提的是，mountChildFibers 与 reconcileChildFibers 这两个方法的逻辑基本一致。唯一的区别是：reconcileChildFibers 会为生成的 Fiber 节点带上 effectTag 属性，而 mountChildFibers 不会。</p>\n</blockquote>\n<h3 id="effecttag"><a href="#effecttag" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>effectTag</h3>\n<p>我们知道，render 阶段的工作是在内存中进行，当工作结束后会通知 Renderer 需要执行的 DOM 操作。要执行 DOM 操作的具体类型就保存在 fiber.effectTag 中。</p>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactSideEffectTags.js" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 effectTag 对应的 DOM 操作</p>\n</blockquote>\n<p>比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43910849325818390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// DOM 需要插入到页面中\nexport const Placement = /*                */ 0b00000000000010;\n// DOM 需要更新\nexport const Update = /*                   */ 0b00000000000100;\n// DOM 需要插入到页面中并更新\nexport const PlacementAndUpdate = /*       */ 0b00000000000110;\n// DOM 需要删除\nexport const Deletion = /*                 */ 0b00000000001000;`, `43910849325818390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// DOM 需要插入到页面中</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> Placement <span class="token operator">=</span> <span class="token comment">/*                */</span> <span class="token number">0b00000000000010</span><span class="token punctuation">;</span>\n<span class="token comment">// DOM 需要更新</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> Update <span class="token operator">=</span> <span class="token comment">/*                   */</span> <span class="token number">0b00000000000100</span><span class="token punctuation">;</span>\n<span class="token comment">// DOM 需要插入到页面中并更新</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> PlacementAndUpdate <span class="token operator">=</span> <span class="token comment">/*       */</span> <span class="token number">0b00000000000110</span><span class="token punctuation">;</span>\n<span class="token comment">// DOM 需要删除</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> Deletion <span class="token operator">=</span> <span class="token comment">/*                 */</span> <span class="token number">0b00000000001000</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>通过二进制表示 effectTag，可以方便的使用位操作为 fiber.effectTag 赋值多个 effect。</p>\n</blockquote>\n<p>那么，如果要通知 Renderer 将 Fiber 节点对应的 DOM 节点插入页面中，需要满足两个条件：</p>\n<ol>\n<li>fiber.stateNode 存在，即 Fiber 节点中保存了对应的 DOM 节点</li>\n<li>(fiber.effectTag &#x26; Placement) !== 0，即 Fiber 节点存在 Placement effectTag</li>\n</ol>\n<p>我们知道，mount 时，<code class="language-text">fiber.stateNode === null</code>，且在 reconcileChildren 中调用的 mountChildFibers 不会为 Fiber 节点赋值 effectTag。那么首屏渲染如何完成呢？</p>\n<p>针对第一个问题，fiber.stateNode 会在 completeWork 中创建，我们会在下一节介绍。</p>\n<p>第二个问题的答案十分巧妙：假设 mountChildFibers 也会赋值 effectTag，那么可以预见 mount 时整棵 Fiber 树所有节点都会有 Placement effectTag。那么 commit 阶段在执行 DOM 操作时每个节点都会执行一次插入操作，这样大量的 DOM 操作是极低效的。</p>\n<p>为了解决这个问题，在 mount 时只有 rootFiber 会赋值 Placement effectTag，在 commit 阶段只会执行一次插入操作。</p>\n<h3 id="参考资料"><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考资料</h3>\n<p>beginWork 流程图</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-22-10-42-18-caba41064a5ec2b50d3061e096f0b360-72d75.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA9UlEQVQoz5WRyU4EMQxE+///jRMS4gRCYhA9vWVPvMTBnQsDzNBQByuJVKpX8dC6pE+X4e7x6eHlBCx6nn3KxIvP98+nULD90HB5oVon44mlIAaA0cYA+L4aG1O7puHbPWTIWCcfM+5RIsJV2g19MQPXcbVn45GrAk/Wzy5kFqP8QIfYMrnoe73a2uSW2a0kDYmu5n+akXA3awpgKGkL2pcUwcSk1t+wuWeebSzEe/OCr9Mybs4leJuNL3DQmWtF1rHz8f5PUPsGb//XhdlmXBS5Ng/kgF2h0XhXcEu4BN3AUbJ205wqolOLICmJ9HeWv+z5X/oAvwGIYLJSJZkAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 22 10 42 18"\n        title=""\n        src="/static/2021-01-22-10-42-18-caba41064a5ec2b50d3061e096f0b360-fee1c.png"\n        srcset="/static/2021-01-22-10-42-18-caba41064a5ec2b50d3061e096f0b360-a67b7.png 200w,\n/static/2021-01-22-10-42-18-caba41064a5ec2b50d3061e096f0b360-0b187.png 400w,\n/static/2021-01-22-10-42-18-caba41064a5ec2b50d3061e096f0b360-fee1c.png 800w,\n/static/2021-01-22-10-42-18-caba41064a5ec2b50d3061e096f0b360-b1a91.png 1200w,\n/static/2021-01-22-10-42-18-caba41064a5ec2b50d3061e096f0b360-95179.png 1600w,\n/static/2021-01-22-10-42-18-caba41064a5ec2b50d3061e096f0b360-72d75.png 1920w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id="completework"><a href="#completework" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>completeWork</h2>\n<p>在流程概览一节我们了解组件在 render 阶段会经历 beginWork 与 completeWork。</p>\n<p>上一节我们讲解了组件执行 beginWork 后会创建子 Fiber 节点，节点上可能存在 effectTag。</p>\n<p>这一节让我们看看 completeWork 会做什么工作。</p>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L673" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 completeWork 方法定义。</p>\n<h3 id="流程概览-1"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概览</h3>\n<p>类似 beginWork，completeWork 也是针对不同 fiber.tag 调用不同的处理逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89001454642326900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function completeWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes,\n): Fiber | null {\n  const newProps = workInProgress.pendingProps;\n\n  switch (workInProgress.tag) {\n    case IndeterminateComponent:\n    case LazyComponent:\n    case SimpleMemoComponent:\n    case FunctionComponent:\n    case ForwardRef:\n    case Fragment:\n    case Mode:\n    case Profiler:\n    case ContextConsumer:\n    case MemoComponent:\n      return null;\n    case ClassComponent: {\n      // ...省略\n      return null;\n    }\n    case HostRoot: {\n      // ...省略\n      updateHostContainer(workInProgress);\n      return null;\n    }\n    case HostComponent: {\n      // ...省略\n      return null;\n    }\n  // ...省略`, `89001454642326900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>\n  <span class="token parameter">current<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  workInProgress<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>\n  renderLanes<span class="token punctuation">:</span> Lanes<span class="token punctuation">,</span></span>\n<span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>\n\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> IndeterminateComponent<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> LazyComponent<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> SimpleMemoComponent<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> ForwardRef<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> Fragment<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> Mode<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> Profiler<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> ContextConsumer<span class="token punctuation">:</span>\n    <span class="token keyword">case</span> MemoComponent<span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...省略</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">case</span> HostRoot<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...省略</span>\n      <span class="token function">updateHostContainer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...省略</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token comment">// ...省略</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们重点关注页面渲染所必须的 HostComponent（即原生 DOM 组件对应的 Fiber 节点），其他类型 Fiber 的处理留在具体功能实现时讲解。</p>\n<h3 id="处理-hostcomponent"><a href="#%E5%A4%84%E7%90%86-hostcomponent" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>处理 HostComponent</h3>\n<p>和 beginWork 一样，我们根据 <code class="language-text">current === null</code> 判断是 mount 还是 update。</p>\n<p>同时针对 HostComponent，判断 update 时我们还需要考虑 <code class="language-text">workInProgress.stateNode != null</code>（即该 Fiber 节点是否存在对应的 DOM 节点）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94465511888591980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`case HostComponent: {\n  popHostContext(workInProgress);\n  const rootContainerInstance = getRootHostContainer();\n  const type = workInProgress.type;\n\n  if (current !== null && workInProgress.stateNode != null) {\n    // update的情况\n    // ...省略\n  } else {\n    // mount的情况\n    // ...省略\n  }\n  return null;\n}`, `94465511888591980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token function">popHostContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> rootContainerInstance <span class="token operator">=</span> <span class="token function">getRootHostContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// update的情况</span>\n    <span class="token comment">// ...省略</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// mount的情况</span>\n    <span class="token comment">// ...省略</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="update-时-1"><a href="#update-%E6%97%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>update 时</h3>\n<p>当 update 时，Fiber 节点已经存在对应 DOM 节点，所以不需要生成 DOM 节点。需要做的主要是处理 props，比如：</p>\n<ul>\n<li>onClick、onChange 等回调函数的注册</li>\n<li>处理 style prop</li>\n<li>处理 DANGEROUSLY<em>SET</em>INNER_HTML prop</li>\n<li>处理 children prop</li>\n</ul>\n<p>我们去掉一些当前不需要关注的功能（比如 ref），可以看到最主要的逻辑是调用 updateHostComponent 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90009251575280700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (current !== null && workInProgress.stateNode != null) {\n  // update的情况\n  updateHostComponent(current, workInProgress, type, newProps, rootContainerInstance);\n}`, `90009251575280700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// update的情况</span>\n  <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> rootContainerInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L225" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 updateHostComponent 方法定义。</p>\n<p>在 updateHostComponent 内部，被处理完的 props 会被赋值给 workInProgress.updateQueue，并最终会在 commit 阶段被渲染在页面上。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66462334845372290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`workInProgress.updateQueue = (updatePayload: any);`, `66462334845372290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token punctuation">(</span>updatePayload<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>其中 updatePayload 为数组形式，他的奇数索引的值为变化的 prop key，偶数索引的值为变化的 prop value。</p>\n<blockquote>\n<p>具体渲染过程见 mutation 阶段一节</p>\n</blockquote>\n<h3 id="mount-时-1"><a href="#mount-%E6%97%B6-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mount 时</h3>\n<p>同样，我们省略了不相关的逻辑。可以看到，mount 时的主要逻辑包括三个：</p>\n<ul>\n<li>为 Fiber 节点生成对应的 DOM 节点</li>\n<li>将子孙 DOM 节点插入刚生成的 DOM 节点中</li>\n<li>与 update 逻辑中的 updateHostComponent 类似的处理 props 的过程</li>\n</ul>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68999349632884520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// mount 的情况\n\n// ...省略服务端渲染相关逻辑\n\nconst currentHostContext = getHostContext();\n// 为 fiber 创建对应 DOM 节点\nconst instance = createInstance(type, newProps, rootContainerInstance, currentHostContext, workInProgress);\n// 将子孙 DOM 节点插入刚生成的 DOM 节点中\nappendAllChildren(instance, workInProgress, false, false);\n// DOM 节点赋值给 fiber.stateNode\nworkInProgress.stateNode = instance;\n\n// 与 update 逻辑中的 updateHostComponent 类似的处理 props 的过程\nif (finalizeInitialChildren(instance, type, newProps, rootContainerInstance, currentHostContext)) {\n  markUpdate(workInProgress);\n}`, `68999349632884520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// mount 的情况</span>\n\n<span class="token comment">// ...省略服务端渲染相关逻辑</span>\n\n<span class="token keyword">const</span> currentHostContext <span class="token operator">=</span> <span class="token function">getHostContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 为 fiber 创建对应 DOM 节点</span>\n<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> rootContainerInstance<span class="token punctuation">,</span> currentHostContext<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 将子孙 DOM 节点插入刚生成的 DOM 节点中</span>\n<span class="token function">appendAllChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// DOM 节点赋值给 fiber.stateNode</span>\nworkInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>\n\n<span class="token comment">// 与 update 逻辑中的 updateHostComponent 类似的处理 props 的过程</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">finalizeInitialChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> rootContainerInstance<span class="token punctuation">,</span> currentHostContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">markUpdate</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还记得上一节我们讲到：mount 时只会在 rootFiber 存在 Placement effectTag。那么 commit 阶段是如何通过一次插入 DOM 操作（对应一个 Placement effectTag）将整棵 DOM 树插入页面的呢？</p>\n<p>原因就在于 completeWork 中的 appendAllChildren 方法。</p>\n<p>由于 completeWork 属于“归”阶段调用的函数，每次调用 appendAllChildren 时都会将已生成的子孙 DOM 节点插入当前生成的 DOM 节点下。那么当“归”到 rootFiber 时，我们已经有一个构建好的离屏 DOM 树。</p>\n<h3 id="effectlist"><a href="#effectlist" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>effectList</h3>\n<p>至此 render 阶段的绝大部分工作就完成了。</p>\n<p>还有一个问题：作为 DOM 操作的依据，commit 阶段需要找到所有有 effectTag 的 Fiber 节点并依次执行 effectTag 对应操作。难道需要在 commit 阶段再遍历一次 Fiber 树寻找 <code class="language-text">effectTag !== null</code> 的 Fiber 节点么？</p>\n<p>这显然是很低效的。</p>\n<p>为了解决这个问题，在 completeWork 的上层函数 completeUnitOfWork 中，每个执行完 completeWork 且存在 effectTag 的 Fiber 节点会被保存在一条被称为 effectList 的单向链表中。</p>\n<p>effectList 中第一个 Fiber 节点保存在 fiber.firstEffect，最后一个元素保存在 fiber.lastEffect。</p>\n<p>类似 appendAllChildren，在“归”阶段，所有有 effectTag 的 Fiber 节点都会被追加在 effectList 中，最终形成一条以 rootFiber.firstEffect 为起点的单向链表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45061565449255570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`                       nextEffect         nextEffect\nrootFiber.firstEffect -----------> fiber -----------> fiber`, `45061565449255570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">                       nextEffect         nextEffect\nrootFiber.firstEffect -----------&gt; fiber -----------&gt; fiber</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样，在 commit 阶段只需要遍历 effectList 就能执行所有 effect 了。</p>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1744" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段代码逻辑。</p>\n<p>借用 React 团队成员 Dan Abramov 的话：effectList 相较于 Fiber 树，就像圣诞树上挂的那一串彩灯。</p>\n<h3 id="流程结尾"><a href="#%E6%B5%81%E7%A8%8B%E7%BB%93%E5%B0%BE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程结尾</h3>\n<p>至此，render 阶段全部工作完成。在 performSyncWorkOnRoot 函数中 fiberRootNode 被传递给 commitRoot 方法，开启 commit 阶段工作流程。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60574676364668715000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`commitRoot(root);`, `60574676364668715000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>代码见<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1107" target="_blank" rel="nofollow noreferrer noopener">这里</a>。</p>\n<h3 id="参考资料-1"><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考资料</h3>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-22-11-00-58-2752d0ac0e3c528568d26090d2fe1e7e-c9723.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 88.08030112923463%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACHElEQVQ4y3VS2XLbMAzU/39RX/rQzrTukTSTVE6V+Eot2dZlHRTFm2AgynbdRsXs2JCEJQDuBuAcAiMj/WKXJRWx4/M58P39ahtukkV6lP4TnBGMf8a5TdV9jZY/46yRlilNpKJSU6V3nfgUPn28C+dJodwU2Xo4/6vBHVq6Ldu4InHVEqnxpYEB4P5C8M/zZQtlgarhQAugrUW8LQsmmRjLQ/EtWgltSyqWeb0uamnG4U41E2QMKrqmr0paE6HHIgOAwIQbmzGV9qrxJwXXV4u5NNBLyZTcN7hwJy3Ob3GFUYId4R8eovc3D+GuYODJLeMVZVyp4Wy/HCZM21YqvDxpAfNeWeOgM5AyvaeyVb4znvdjsX43u83bzvnO1yITZcNd/nn+PHtcPAwqmusxg1GnTpmkoeiQ38dBnoLy6ztHtWome22xLCMsJQzzgWzscIdUmuhQPCYZIkzSuO4u5mHa1D0vOyaMKbi+XcV36zjvBbKCWfj0PVqjq7ykzks7JOP4AlxSd/PNdr6J0TMMTo46jX2/fEGUlA8ca/HCUFvcXBhQZ5eDtx0GTnvz/PLl17JivjMaaMDZQJcYpjDALWwrsinqdV4nLW0UVIwfKZd+2QCuHHOBtyTgFMgnQrVcNRzFNxr+zDLtsEtnYUZ7DTO/bTBBxrpS6HVWLvZ5lKSrQ37oOIcJ5gQZtWml2Vft/tikDUlKNDmX/yG/ApDIFEsabW9gAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 22 11 00 58"\n        title=""\n        src="/static/2021-01-22-11-00-58-2752d0ac0e3c528568d26090d2fe1e7e-fee1c.png"\n        srcset="/static/2021-01-22-11-00-58-2752d0ac0e3c528568d26090d2fe1e7e-a67b7.png 200w,\n/static/2021-01-22-11-00-58-2752d0ac0e3c528568d26090d2fe1e7e-0b187.png 400w,\n/static/2021-01-22-11-00-58-2752d0ac0e3c528568d26090d2fe1e7e-fee1c.png 800w,\n/static/2021-01-22-11-00-58-2752d0ac0e3c528568d26090d2fe1e7e-b1a91.png 1200w,\n/static/2021-01-22-11-00-58-2752d0ac0e3c528568d26090d2fe1e7e-c9723.png 1594w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1 id="commit-阶段"><a href="#commit-%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>commit 阶段</h1>\n<h2 id="流程概览-2"><a href="#%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流程概览</h2>\n<p>commitRoot 方法是 commit 阶段工作的起点，fiberRootNode 会作为传参。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75488580877680530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`commitRoot(root);`, `75488580877680530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>在 rootFiber.firstEffect 上保存了一条需要执行副作用的 Fiber 节点的单向链表 effectList，这些 Fiber 节点的 updateQueue 中保存了变化的 props。</p>\n<p>这些副作用对应的 DOM 操作在 commit 阶段执行。</p>\n<p>除此之外，一些生命周期钩子（比如 componentDidXXX）、hook（比如 useEffect）需要在 commit 阶段执行。</p>\n<p>commit 阶段的主要工作（即 Renderer 的工作流程）分为三部分：</p>\n<ul>\n<li>before mutation 阶段（执行 DOM 操作前）</li>\n<li>mutation 阶段（执行 DOM 操作）</li>\n<li>layout 阶段（执行 DOM 操作后）</li>\n</ul>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2001" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commit 阶段的完整代码</p>\n<p>在 before mutation 阶段之前和 layout 阶段之后还有一些额外工作，涉及到比如 useEffect 的触发、优先级相关的重置、ref 的绑定/解绑。</p>\n<p>这些对我们当前属于超纲内容，为了内容完整性，在这节简单介绍。</p>\n<h3 id="before-mutation-之前"><a href="#before-mutation-%E4%B9%8B%E5%89%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>before mutation 之前</h3>\n<p>commitRootImpl 方法中直到第一句 <code class="language-text">if (firstEffect !== null)</code> 之前属于 before mutation 之前。</p>\n<p>我们大体看下他做的工作，现在你还不需要理解他们：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44847156707908575000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`do {\n  // 触发 useEffect 回调与其他同步任务。由于这些任务可能触发新的渲染，所以这里要一直遍历执行直到没有任务\n  flushPassiveEffects();\n} while (rootWithPendingPassiveEffects !== null);\n\n// root 指 fiberRootNode\n// root.finishedWork 指当前应用的 rootFiber\nconst finishedWork = root.finishedWork;\n\n// 凡是变量名带 lane 的都是优先级相关\nconst lanes = root.finishedLanes;\nif (finishedWork === null) {\n  return null;\n}\nroot.finishedWork = null;\nroot.finishedLanes = NoLanes;\n\n// 重置 Scheduler 绑定的回调函数\nroot.callbackNode = null;\nroot.callbackId = NoLanes;\n\nlet remainingLanes = mergeLanes(finishedWork.lanes, finishedWork.childLanes);\n// 重置优先级相关变量\nmarkRootFinished(root, remainingLanes);\n\n// 清除已完成的 discrete updates，例如：用户鼠标点击触发的更新。\nif (rootsWithPendingDiscreteUpdates !== null) {\n  if (!hasDiscreteLanes(remainingLanes) && rootsWithPendingDiscreteUpdates.has(root)) {\n    rootsWithPendingDiscreteUpdates.delete(root);\n  }\n}\n\n// 重置全局变量\nif (root === workInProgressRoot) {\n  workInProgressRoot = null;\n  workInProgress = null;\n  workInProgressRootRenderLanes = NoLanes;\n} else {\n}\n\n// 将 effectList 赋值给 firstEffect\n// 由于每个 fiber 的 effectList 只包含他的子孙节点\n// 所以根节点如果有 effectTag 则不会被包含进来\n// 所以这里将有 effectTag 的根节点插入到 effectList 尾部\n// 这样才能保证有 effect 的 fiber 都在 effectList 中\nlet firstEffect;\nif (finishedWork.effectTag > PerformedWork) {\n  if (finishedWork.lastEffect !== null) {\n    finishedWork.lastEffect.nextEffect = finishedWork;\n    firstEffect = finishedWork.firstEffect;\n  } else {\n    firstEffect = finishedWork;\n  }\n} else {\n  // 根节点没有 effectTag\n  firstEffect = finishedWork.firstEffect;\n}`, `44847156707908575000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">do</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 触发 useEffect 回调与其他同步任务。由于这些任务可能触发新的渲染，所以这里要一直遍历执行直到没有任务</span>\n  <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// root 指 fiberRootNode</span>\n<span class="token comment">// root.finishedWork 指当前应用的 rootFiber</span>\n<span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>\n\n<span class="token comment">// 凡是变量名带 lane 的都是优先级相关</span>\n<span class="token keyword">const</span> lanes <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedLanes<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\nroot<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\nroot<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>\n\n<span class="token comment">// 重置 Scheduler 绑定的回调函数</span>\nroot<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\nroot<span class="token punctuation">.</span>callbackId <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>\n\n<span class="token keyword">let</span> remainingLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> finishedWork<span class="token punctuation">.</span>childLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 重置优先级相关变量</span>\n<span class="token function">markRootFinished</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> remainingLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 清除已完成的 discrete updates，例如：用户鼠标点击触发的更新。</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>rootsWithPendingDiscreteUpdates <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasDiscreteLanes</span><span class="token punctuation">(</span>remainingLanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    rootsWithPendingDiscreteUpdates<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 重置全局变量</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 将 effectList 赋值给 firstEffect</span>\n<span class="token comment">// 由于每个 fiber 的 effectList 只包含他的子孙节点</span>\n<span class="token comment">// 所以根节点如果有 effectTag 则不会被包含进来</span>\n<span class="token comment">// 所以这里将有 effectTag 的根节点插入到 effectList 尾部</span>\n<span class="token comment">// 这样才能保证有 effect 的 fiber 都在 effectList 中</span>\n<span class="token keyword">let</span> firstEffect<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">></span> PerformedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    finishedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>\n    firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 根节点没有 effectTag</span>\n  firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，before mutation 之前主要做一些变量赋值，状态重置的工作。</p>\n<p>这一长串代码我们只需要关注最后赋值的 firstEffect，在 commit 的三个子阶段都会用到他。</p>\n<h3 id="layout-之后"><a href="#layout-%E4%B9%8B%E5%90%8E" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>layout 之后</h3>\n<p>接下来让我们简单看下 layout 阶段执行完后的代码，现在你还不需要理解他们：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12914436205253655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const rootDidHavePassiveEffects = rootDoesHavePassiveEffects;\n\n// useEffect 相关\nif (rootDoesHavePassiveEffects) {\n  rootDoesHavePassiveEffects = false;\n  rootWithPendingPassiveEffects = root;\n  pendingPassiveEffectsLanes = lanes;\n  pendingPassiveEffectsRenderPriority = renderPriorityLevel;\n} else {\n}\n\n// 性能优化相关\nif (remainingLanes !== NoLanes) {\n  if (enableSchedulerTracing) {\n    // ...\n  }\n} else {\n  // ...\n}\n\n// 性能优化相关\nif (enableSchedulerTracing) {\n  if (!rootDidHavePassiveEffects) {\n    // ...\n  }\n}\n\n// ...检测无限循环的同步任务\nif (remainingLanes === SyncLane) {\n  // ...\n}\n\n// 在离开 commitRoot 函数前调用，触发一次新的调度，确保任何附加的任务被调度\nensureRootIsScheduled(root, now());\n\n// ...处理未捕获错误及老版本遗留的边界问题\n\n// 执行同步任务，这样同步任务不需要等到下次事件循环再执行\n// 比如在 componentDidMount 中执行 setState 创建的更新会在这里被同步执行\n// 或 useLayoutEffect\nflushSyncCallbackQueue();\n\nreturn null;`, `12914436205253655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> rootDidHavePassiveEffects <span class="token operator">=</span> rootDoesHavePassiveEffects<span class="token punctuation">;</span>\n\n<span class="token comment">// useEffect 相关</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  rootWithPendingPassiveEffects <span class="token operator">=</span> root<span class="token punctuation">;</span>\n  pendingPassiveEffectsLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>\n  pendingPassiveEffectsRenderPriority <span class="token operator">=</span> renderPriorityLevel<span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 性能优化相关</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>remainingLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 性能优化相关</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDidHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ...检测无限循环的同步任务</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>remainingLanes <span class="token operator">===</span> SyncLane<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 在离开 commitRoot 函数前调用，触发一次新的调度，确保任何附加的任务被调度</span>\n<span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// ...处理未捕获错误及老版本遗留的边界问题</span>\n\n<span class="token comment">// 执行同步任务，这样同步任务不需要等到下次事件循环再执行</span>\n<span class="token comment">// 比如在 componentDidMount 中执行 setState 创建的更新会在这里被同步执行</span>\n<span class="token comment">// 或 useLayoutEffect</span>\n<span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2195" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段代码</p>\n</blockquote>\n<p>主要包括三点内容：</p>\n<ol>\n<li>\n<p>useEffect 相关的处理。</p>\n<p>我们会在讲解 layout 阶段时讲解。</p>\n</li>\n<li>\n<p>性能追踪相关。</p>\n<p>源码里有很多和 interaction 相关的变量。他们都和追踪 React 渲染时间、性能相关，在 <a href="https://zh-hans.reactjs.org/docs/profiler.html" target="_blank" rel="nofollow noreferrer noopener">Profiler API</a> 和 <a href="https://github.com/facebook/react-devtools/pull/1069" target="_blank" rel="nofollow noreferrer noopener">DevTools</a> 中使用。</p>\n<p>你可以在这里看到 <a href="https://gist.github.com/bvaughn/8de925562903afd2e7a12554adcdda16#overview" target="_blank" rel="nofollow noreferrer noopener">interaction</a> 的定义</p>\n</li>\n<li>\n<p>在 commit 阶段会触发一些生命周期钩子（如 componentDidXXX）和 hook（如 useLayoutEffect、useEffect）。</p>\n<p>在这些回调方法中可能触发新的更新，新的更新会开启新的 render-commit 流程。</p>\n</li>\n</ol>\n<h2 id="before-mutation-阶段"><a href="#before-mutation-%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>before mutation 阶段</h2>\n<p>在本节正式开始前，让我们复习下这一章到目前为止所学的。</p>\n<p>Renderer 工作的阶段被称为 commit 阶段，commit 阶段可以分为三个子阶段：</p>\n<ul>\n<li>before mutation 阶段（执行 DOM 操作前）</li>\n<li>mutation 阶段（执行 DOM 操作）</li>\n<li>layout 阶段（执行 DOM 操作后）</li>\n</ul>\n<p>本节我们看看 before mutation 阶段（执行 DOM 操作前）都做了什么。</p>\n<h3 id="概览"><a href="#%E6%A6%82%E8%A7%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概览</h3>\n<p>before mutation 阶段的代码很短，整个过程就是遍历 effectList 并调用 commitBeforeMutationEffects 函数处理。</p>\n<p>这部分源码在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2104-L2127" target="_blank" rel="nofollow noreferrer noopener">这里</a>。为了增加可读性，示例代码中删除了不相关的逻辑</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87506080201027760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 保存之前的优先级，以同步优先级执行，执行完毕后恢复之前优先级\nconst previousLanePriority = getCurrentUpdateLanePriority();\nsetCurrentUpdateLanePriority(SyncLanePriority);\n\n// 将当前上下文标记为 CommitContext，作为 commit 阶段的标志\nconst prevExecutionContext = executionContext;\nexecutionContext |= CommitContext;\n\n// 处理 focus 状态\nfocusedInstanceHandle = prepareForCommit(root.containerInfo);\nshouldFireAfterActiveInstanceBlur = false;\n\n// beforeMutation 阶段的主函数\ncommitBeforeMutationEffects(finishedWork);\n\nfocusedInstanceHandle = null;`, `87506080201027760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 保存之前的优先级，以同步优先级执行，执行完毕后恢复之前优先级</span>\n<span class="token keyword">const</span> previousLanePriority <span class="token operator">=</span> <span class="token function">getCurrentUpdateLanePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">setCurrentUpdateLanePriority</span><span class="token punctuation">(</span>SyncLanePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 将当前上下文标记为 CommitContext，作为 commit 阶段的标志</span>\n<span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>\nexecutionContext <span class="token operator">|=</span> CommitContext<span class="token punctuation">;</span>\n\n<span class="token comment">// 处理 focus 状态</span>\nfocusedInstanceHandle <span class="token operator">=</span> <span class="token function">prepareForCommit</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>\nshouldFireAfterActiveInstanceBlur <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n<span class="token comment">// beforeMutation 阶段的主函数</span>\n<span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nfocusedInstanceHandle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们重点关注 beforeMutation 阶段的主函数 commitBeforeMutationEffects 做了什么。</p>\n<h3 id="commitbeforemutationeffects"><a href="#commitbeforemutationeffects" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>commitBeforeMutationEffects</h3>\n<p>大体代码逻辑：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77254116334119880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function commitBeforeMutationEffects() {\n  while (nextEffect !== null) {\n    const current = nextEffect.alternate;\n\n    if (!shouldFireAfterActiveInstanceBlur && focusedInstanceHandle !== null) {\n      // ...focus blur 相关\n    }\n\n    const effectTag = nextEffect.effectTag;\n\n    // 调用 getSnapshotBeforeUpdate\n    if ((effectTag & Snapshot) !== NoEffect) {\n      commitBeforeMutationEffectOnFiber(current, nextEffect);\n    }\n\n    // 调度 useEffect\n    if ((effectTag & Passive) !== NoEffect) {\n      if (!rootDoesHavePassiveEffects) {\n        rootDoesHavePassiveEffects = true;\n        scheduleCallback(NormalSchedulerPriority, () => {\n          flushPassiveEffects();\n          return null;\n        });\n      }\n    }\n    nextEffect = nextEffect.nextEffect;\n  }\n}`, `77254116334119880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldFireAfterActiveInstanceBlur <span class="token operator">&amp;&amp;</span> focusedInstanceHandle <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ...focus blur 相关</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>\n\n    <span class="token comment">// 调用 getSnapshotBeforeUpdate</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 调度 useEffect</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>整体可以分为三部分：</p>\n<ol>\n<li>处理 DOM 节点渲染/删除后的 autoFocus、blur 逻辑。</li>\n<li>调用 getSnapshotBeforeUpdate 生命周期钩子。</li>\n<li>调度 useEffect。</li>\n</ol>\n<p>我们讲解下 2、3 两点。</p>\n<h3 id="调用-getsnapshotbeforeupdate"><a href="#%E8%B0%83%E7%94%A8-getsnapshotbeforeupdate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用 getSnapshotBeforeUpdate</h3>\n<p>commitBeforeMutationEffectOnFiber 是 commitBeforeMutationLifeCycles 的别名。</p>\n<p>在该方法内会调用 getSnapshotBeforeUpdate。</p>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L222" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段逻辑</p>\n<p>从 Reactv16 开始，componentWillXXX 钩子前增加了 UNSAFE_ 前缀。</p>\n<p>究其原因，是因为 Stack Reconciler 重构为 Fiber Reconciler 后，render 阶段的任务可能中断/重新开始，对应的组件在 render 阶段的生命周期钩子（即 componentWillXXX）可能触发多次。</p>\n<p>这种行为和 Reactv15 不一致，所以标记为 UNSAFE_。</p>\n<p>更详细的解释参照<a href="https://juejin.im/post/6847902224287285255#comment" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<p>为此，React 提供了替代的生命周期钩子 getSnapshotBeforeUpdate。</p>\n<p>我们可以看见，getSnapshotBeforeUpdate 是在 commit 阶段内的 before mutation 阶段调用的，由于 commit 阶段是同步的，所以不会遇到多次调用的问题。</p>\n<h3 id="调度-useeffect"><a href="#%E8%B0%83%E5%BA%A6-useeffect" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调度 useEffect</h3>\n<p>在这几行代码内，scheduleCallback 方法由 Scheduler 模块提供，用于以某个优先级异步调度一个回调函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20189664485699140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 调度 useEffect\nif ((effectTag & Passive) !== NoEffect) {\n  if (!rootDoesHavePassiveEffects) {\n    rootDoesHavePassiveEffects = true;\n    scheduleCallback(NormalSchedulerPriority, () => {\n      // 触发 useEffect\n      flushPassiveEffects();\n      return null;\n    });\n  }\n}`, `20189664485699140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 调度 useEffect</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// 触发 useEffect</span>\n      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在此处，被异步调度的回调函数就是触发 useEffect 的方法 flushPassiveEffects。</p>\n<p>我们接下来讨论 useEffect 如何被异步调度，以及为什么要异步（而不是同步）调度。</p>\n<h4 id="如何异步调度"><a href="#%E5%A6%82%E4%BD%95%E5%BC%82%E6%AD%A5%E8%B0%83%E5%BA%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何异步调度</h4>\n<p>在 flushPassiveEffects 方法内部会从全局变量 rootWithPendingPassiveEffects 获取 effectList。</p>\n<p>关于 flushPassiveEffects 的具体讲解参照 useEffect 与 useLayoutEffect 一节</p>\n<p>在 completeWork 一节我们讲到，effectList 中保存了需要执行副作用的 Fiber 节点。其中副作用包括</p>\n<ul>\n<li>插入 DOM 节点（Placement）</li>\n<li>更新 DOM 节点（Update）</li>\n<li>删除 DOM 节点（Deletion）</li>\n</ul>\n<p>除此外，当一个 FunctionComponent 含有 useEffect 或 useLayoutEffect，他对应的 Fiber 节点也会被赋值 effectTag。</p>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactHookEffectTags.js" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 hook 相关的 effectTag</p>\n<p>在 flushPassiveEffects 方法内部会遍历 rootWithPendingPassiveEffects（即 effectList）执行 effect 回调函数。</p>\n<p>如果在此时直接执行 <code class="language-text">rootWithPendingPassiveEffects === null</code>。</p>\n<p>那么 rootWithPendingPassiveEffects 会在何时赋值呢？</p>\n<p>在上一节 layout 之后的代码片段中会根据 <code class="language-text">rootDoesHavePassiveEffects === true</code> 决定是否赋值 rootWithPendingPassiveEffects。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27116445416300120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const rootDidHavePassiveEffects = rootDoesHavePassiveEffects;\nif (rootDoesHavePassiveEffects) {\n  rootDoesHavePassiveEffects = false;\n  rootWithPendingPassiveEffects = root;\n  pendingPassiveEffectsLanes = lanes;\n  pendingPassiveEffectsRenderPriority = renderPriorityLevel;\n}`, `27116445416300120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> rootDidHavePassiveEffects <span class="token operator">=</span> rootDoesHavePassiveEffects<span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n  rootWithPendingPassiveEffects <span class="token operator">=</span> root<span class="token punctuation">;</span>\n  pendingPassiveEffectsLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>\n  pendingPassiveEffectsRenderPriority <span class="token operator">=</span> renderPriorityLevel<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以整个 useEffect 异步调用分为三步：</p>\n<ol>\n<li>before mutation 阶段在 scheduleCallback 中调度 flushPassiveEffects</li>\n<li>layout 阶段之后将 effectList 赋值给 rootWithPendingPassiveEffects</li>\n<li>scheduleCallback 触发 flushPassiveEffects，flushPassiveEffects 内部遍历 rootWithPendingPassiveEffects</li>\n</ol>\n<h4 id="为什么需要异步调用"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么需要异步调用</h4>\n<p>摘录自 React 文档 effect 的执行时机：</p>\n<p>与 componentDidMount、componentDidUpdate 不同的是，在浏览器完成布局与绘制之后，传给 useEffect 的函数会延迟调用。这使得它适用于许多常见的副作用场景，比如设置订阅和事件处理等情况，因此不应在函数中执行阻塞浏览器更新屏幕的操作。</p>\n<p>可见，useEffect 异步执行的原因主要是防止同步执行时阻塞浏览器渲染。</p>\n<h3 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>经过本节学习，我们知道了在 before mutation 阶段，会遍历 effectList，依次执行：</p>\n<ol>\n<li>处理 DOM 节点渲染/删除后的 autoFocus、blur 逻辑</li>\n<li>调用 getSnapshotBeforeUpdate 生命周期钩子</li>\n<li>调度 useEffect</li>\n</ol>\n<h2 id="mutation-阶段"><a href="#mutation-%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mutation 阶段</h2>\n<p>终于到了执行 DOM 操作的 mutation 阶段</p>\n<h3 id="概览-1"><a href="#%E6%A6%82%E8%A7%88-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概览</h3>\n<p>类似 before mutation 阶段，mutation 阶段也是遍历 effectList，执行函数。这里执行的是 commitMutationEffects。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46156527248860860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`nextEffect = firstEffect;\ndo {\n  try {\n    commitMutationEffects(root, renderPriorityLevel);\n  } catch (error) {\n    invariant(nextEffect !== null, \'Should be working on an effect.\');\n    captureCommitPhaseError(nextEffect, error);\n    nextEffect = nextEffect.nextEffect;\n  }\n} while (nextEffect !== null);`, `46156527248860860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>\n<span class="token keyword">do</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">\'Should be working on an effect.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="commitmutationeffects"><a href="#commitmutationeffects" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>commitMutationEffects</h3>\n<p>代码如下：</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2091" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitMutationEffects 源码</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83879737961598340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function commitMutationEffects(root: FiberRoot, renderPriorityLevel) {\n  // 遍历 effectList\n  while (nextEffect !== null) {\n    const effectTag = nextEffect.effectTag;\n\n    // 根据 ContentReset effectTag 重置文字节点\n    if (effectTag & ContentReset) {\n      commitResetTextContent(nextEffect);\n    }\n\n    // 更新 ref\n    if (effectTag & Ref) {\n      const current = nextEffect.alternate;\n      if (current !== null) {\n        commitDetachRef(current);\n      }\n    }\n\n    // 根据 effectTag 分别处理\n    const primaryEffectTag = effectTag & (Placement | Update | Deletion | Hydrating);\n    switch (primaryEffectTag) {\n      // 插入DOM\n      case Placement: {\n        commitPlacement(nextEffect);\n        nextEffect.effectTag &= ~Placement;\n        break;\n      }\n      // 插入 DOM 并更新 DOM\n      case PlacementAndUpdate: {\n        // 插入\n        commitPlacement(nextEffect);\n        nextEffect.effectTag &= ~Placement;\n        // 更新\n        const current = nextEffect.alternate;\n        commitWork(current, nextEffect);\n        break;\n      }\n      // SSR\n      case Hydrating: {\n        nextEffect.effectTag &= ~Hydrating;\n        break;\n      }\n      // SSR\n      case HydratingAndUpdate: {\n        nextEffect.effectTag &= ~Hydrating;\n\n        const current = nextEffect.alternate;\n        commitWork(current, nextEffect);\n        break;\n      }\n      // 更新 DOM\n      case Update: {\n        const current = nextEffect.alternate;\n        commitWork(current, nextEffect);\n        break;\n      }\n      // 删除 DOM\n      case Deletion: {\n        commitDeletion(root, nextEffect, renderPriorityLevel);\n        break;\n      }\n    }\n\n    nextEffect = nextEffect.nextEffect;\n  }\n}`, `83879737961598340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 遍历 effectList</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>\n\n    <span class="token comment">// 根据 ContentReset effectTag 重置文字节点</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 更新 ref</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 根据 effectTag 分别处理</span>\n    <span class="token keyword">const</span> primaryEffectTag <span class="token operator">=</span> effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 插入DOM</span>\n      <span class="token keyword">case</span> Placement<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 插入 DOM 并更新 DOM</span>\n      <span class="token keyword">case</span> PlacementAndUpdate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 插入</span>\n        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>\n        <span class="token comment">// 更新</span>\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// SSR</span>\n      <span class="token keyword">case</span> Hydrating<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// SSR</span>\n      <span class="token keyword">case</span> HydratingAndUpdate<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>\n\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 更新 DOM</span>\n      <span class="token keyword">case</span> Update<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">// 删除 DOM</span>\n      <span class="token keyword">case</span> Deletion<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>commitMutationEffects 会遍历 effectList，对每个 Fiber 节点执行如下三个操作：</p>\n<ol>\n<li>根据 ContentReset effectTag 重置文字节点</li>\n<li>更新 ref</li>\n<li>根据 effectTag 分别处理，其中 effectTag 包括 (Placement | Update | Deletion | Hydrating)</li>\n</ol>\n<p>我们关注步骤三中的 Placement | Update | Deletion。Hydrating 作为服务端渲染相关，我们先不关注。</p>\n<h3 id="placement-effect"><a href="#placement-effect" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Placement effect</h3>\n<p>当 Fiber 节点含有 Placement effectTag，意味着该 Fiber 节点对应的 DOM 节点需要插入到页面中。</p>\n<p>调用的方法为 commitPlacement。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1156" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitPlacement 源码</p>\n</blockquote>\n<p>该方法所做的工作分为三步：</p>\n<ol>\n<li>\n<p>获取父级 DOM 节点。其中 finishedWork 为传入的 Fiber 节点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10920700350477320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const parentFiber = getHostParentFiber(finishedWork);\n// 父级 DOM 节点\nconst parentStateNode = parentFiber.stateNode;`, `10920700350477320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// 父级 DOM 节点</span>\n<span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>获取 Fiber 节点的 DOM 兄弟节点</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51524529067446200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`const before = getHostSibling(finishedWork);`, `51524529067446200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n</li>\n<li>\n<p>根据 DOM 兄弟节点是否存在决定调用 parentNode.insertBefore 或 parentNode.appendChild 执行 DOM 插入操作。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42764723971290300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// parentStateNode 是否是 rootFiber\nif (isContainer) {\n insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);\n} else {\n insertOrAppendPlacementNode(finishedWork, before, parent);\n}`, `42764723971290300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// parentStateNode 是否是 rootFiber</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>值得注意的是，getHostSibling（获取兄弟 DOM 节点）的执行很耗时，当在同一个父 Fiber 节点下依次执行多个插入操作，getHostSibling 算法的复杂度为指数级。</p>\n<p>这是由于 Fiber 节点不只包括 HostComponent，所以 Fiber 树和渲染的 DOM 树节点并不是一一对应的。要从 Fiber 节点找到 DOM 节点很可能跨层级遍历。</p>\n<p>考虑如下例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44863445915040416000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function Item() {\n  return <li><li>;\n}\n\nfunction App() {\n  return (\n    <div>\n      <Item/>\n    </div>\n  )\n}\n\nReactDOM.render(<App/>, document.getElementById(\'root\'));`, `44863445915040416000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">;\n}\n\nfunction App() </span><span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span><span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token plain-text">\n\nReactDOM.render(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span><span class="token punctuation">/></span></span><span class="token plain-text">, document.getElementById(\'root\'));</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对应的 Fiber 树和 DOM 树 结构为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30534003264957300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Fiber树\n          child      child      child       child\nrootFiber -----> App -----> div -----> Item -----> li\n\n// DOM树\n#root ---> div ---> li`, `30534003264957300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// Fiber树\n          child      child      child       child\nrootFiber -----&gt; App -----&gt; div -----&gt; Item -----&gt; li\n\n// DOM树\n#root ---&gt; div ---&gt; li</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当在 div 的子节点 Item 前插入一个新节点 p，即 App 变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60437080267822870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  return (\n    <div>\n      <p></p>\n      <Item />\n    </div>\n  );\n}`, `60437080267822870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对应的 Fiber 树和 DOM 树结构为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91391397796219200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Fiber树\n          child      child      child\nrootFiber -----> App -----> div -----> p\n                                       | sibling       child\n                                       | -------> Item -----> li\n// DOM树\n#root ---> div ---> p\n             |\n               ---> li`, `91391397796219200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// Fiber树\n          child      child      child\nrootFiber -----&gt; App -----&gt; div -----&gt; p\n                                       | sibling       child\n                                       | -------&gt; Item -----&gt; li\n// DOM树\n#root ---&gt; div ---&gt; p\n             |\n               ---&gt; li</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>此时 DOM 节点 p 的兄弟节点为 li，而 Fiber 节点 p 对应的兄弟 DOM 节点为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56401511914653610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiberP.sibling.child`, `56401511914653610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">fiberP.sibling.child</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>即 fiber p 的兄弟 fiber Item 的子 fiber li</p>\n<h3 id="update-effect"><a href="#update-effect" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update effect</h3>\n<p>当 Fiber 节点含有 Update effectTag，意味着该 Fiber 节点需要更新。调用的方法为 commitWork，他会根据 Fiber.tag 分别处理。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1441" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitWork 源码</p>\n</blockquote>\n<p>这里我们主要关注 FunctionComponent 和 HostComponent。</p>\n<h4 id="functioncomponent-mutation"><a href="#functioncomponent-mutation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FunctionComponent mutation</h4>\n<p>当 fiber.tag 为 FunctionComponent，会调用 commitHookEffectListUnmount。该方法会遍历 effectList，执行所有 useLayoutEffect hook 的销毁函数。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L314" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitHookEffectListUnmount 源码</p>\n</blockquote>\n<p>所谓“销毁函数”，见如下例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86469379332007700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`useLayoutEffect(() => {\n  // ...一些副作用逻辑\n\n  return () => {\n    // ...这就是销毁函数\n  };\n});`, `86469379332007700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...一些副作用逻辑</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token comment">// ...这就是销毁函数</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你不需要很了解 useLayoutEffect，我们会在下一节详细介绍。你只需要知道在 mutation 阶段会执行 useLayoutEffect 的销毁函数。</p>\n<h4 id="hostcomponent-mutation"><a href="#hostcomponent-mutation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HostComponent mutation</h4>\n<p>当 fiber.tag 为 HostComponent，会调用 commitUpdate。</p>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-dom/src/client/ReactDOMHostConfig.js#L423" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitUpdate 源码</p>\n<p>最终会在 updateDOMProperties 中将 render 阶段 completeWork 中为 Fiber 节点赋值的 updateQueue 对应的内容渲染在页面上。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11763953410558136000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for (let i = 0; i < updatePayload.length; i += 2) {\n  const propKey = updatePayload[i];\n  const propValue = updatePayload[i + 1];\n\n  // 处理 style\n  if (propKey === STYLE) {\n    setValueForStyles(domElement, propValue);\n    // 处理 DANGEROUSLY_SET_INNER_HTML\n  } else if (propKey === DANGEROUSLY_SET_INNER_HTML) {\n    setInnerHTML(domElement, propValue);\n    // 处理 children\n  } else if (propKey === CHILDREN) {\n    setTextContent(domElement, propValue);\n  } else {\n    // 处理剩余 props\n    setValueForProperty(domElement, propKey, propValue, isCustomComponentTag);\n  }\n}`, `11763953410558136000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updatePayload<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> propKey <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> propValue <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 处理 style</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setValueForStyles</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 处理 DANGEROUSLY_SET_INNER_HTML</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">DANGEROUSLY_SET_INNER_HTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setInnerHTML</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 处理 children</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">setTextContent</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 处理剩余 props</span>\n    <span class="token function">setValueForProperty</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propKey<span class="token punctuation">,</span> propValue<span class="token punctuation">,</span> isCustomComponentTag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="deletion-effect"><a href="#deletion-effect" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deletion effect</h3>\n<p>当 Fiber 节点含有 Deletion effectTag，意味着该 Fiber 节点对应的 DOM 节点需要从页面中删除。调用的方法为 commitDeletion。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L1421" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitDeletion 源码</p>\n</blockquote>\n<p>该方法会执行如下操作：</p>\n<ol>\n<li>递归调用 Fiber 节点及其子孙 Fiber 节点中 fiber.tag 为 ClassComponent 的 componentWillUnmount 生命周期钩子，从页面移除 Fiber 节点对应 DOM 节点</li>\n<li>解绑 ref</li>\n<li>调度 useEffect 的销毁函数</li>\n</ol>\n<h3 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>从这节我们学到，mutation 阶段会遍历 effectList，依次执行 commitMutationEffects。该方法的主要工作为“根据 effectTag 调用不同的处理函数处理 Fiber。</p>\n<h2 id="layout-阶段"><a href="#layout-%E9%98%B6%E6%AE%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>layout 阶段</h2>\n<p>该阶段之所以称为 layout，因为该阶段的代码都是在 DOM 渲染完成（mutation 阶段完成）后执行的。</p>\n<p>该阶段触发的生命周期钩子和 hook 可以直接访问到已经改变后的 DOM，即该阶段是可以参与 DOM layout 的阶段。</p>\n<h3 id="概览-2"><a href="#%E6%A6%82%E8%A7%88-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概览</h3>\n<p>与前两个阶段类似，layout 阶段也是遍历 effectList，执行函数。</p>\n<p>具体执行的函数是 commitLayoutEffects。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18455696660423946000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`root.current = finishedWork;\n\nnextEffect = firstEffect;\ndo {\n  try {\n    commitLayoutEffects(root, lanes);\n  } catch (error) {\n    invariant(nextEffect !== null, \'Should be working on an effect.\');\n    captureCommitPhaseError(nextEffect, error);\n    nextEffect = nextEffect.nextEffect;\n  }\n} while (nextEffect !== null);\n\nnextEffect = null;`, `18455696660423946000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>\n\nnextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>\n<span class="token keyword">do</span> <span class="token punctuation">{</span>\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">\'Should be working on an effect.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nnextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="commitlayouteffects"><a href="#commitlayouteffects" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>commitLayoutEffects</h3>\n<p>代码如下：</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2302" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitLayoutEffects 源码</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83499596616436330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function commitLayoutEffects(root: FiberRoot, committedLanes: Lanes) {\n  while (nextEffect !== null) {\n    const effectTag = nextEffect.effectTag;\n\n    // 调用生命周期钩子和 hook\n    if (effectTag & (Update | Callback)) {\n      const current = nextEffect.alternate;\n      commitLayoutEffectOnFiber(root, current, nextEffect, committedLanes);\n    }\n\n    // 赋值 ref\n    if (effectTag & Ref) {\n      commitAttachRef(nextEffect);\n    }\n\n    nextEffect = nextEffect.nextEffect;\n  }\n}`, `83499596616436330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span> committedLanes<span class="token punctuation">:</span> Lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>\n\n    <span class="token comment">// 调用生命周期钩子和 hook</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Update <span class="token operator">|</span> Callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n      <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> committedLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// 赋值 ref</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>commitLayoutEffects 一共做了两件事：</p>\n<ol>\n<li>commitLayoutEffectOnFiber（调用生命周期钩子和 hook 相关操作）</li>\n<li>commitAttachRef（赋值 ref）</li>\n</ol>\n<h3 id="commitlayouteffectonfiber"><a href="#commitlayouteffectonfiber" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>commitLayoutEffectOnFiber</h3>\n<p>commitLayoutEffectOnFiber 方法会根据 fiber.tag 对不同类型的节点分别处理。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L459" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitLayoutEffectOnFiber 源码（commitLayoutEffectOnFiber 为别名，方法原名为 commitLifeCycles）</p>\n</blockquote>\n<ul>\n<li>\n<p>对于 ClassComponent，他会通过 <code class="language-text">current === null</code> 区分是 mount 还是 update，调用 componentDidMount 或 componentDidUpdate。</p>\n<p>触发状态更新的 this.setState 如果赋值了第二个参数回调函数，也会在此时调用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62113083508780510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`this.setState({ xxx: 1 }, () => {\nconsole.log(\'i am update~\');\n});`, `62113083508780510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> xxx<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'i am update~\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>对于 FunctionComponent 及相关类型，他会调用 useLayoutEffect hook 的回调函数，调度 useEffect 的销毁与回调函数</p>\n<p>相关类型指特殊处理后的 FunctionComponent，比如 ForwardRef、React.memo 包裹的 FunctionComponent</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7489609306501843000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`switch (finishedWork.tag) {\n// 以下都是 FunctionComponent 及相关类型\ncase FunctionComponent:\ncase ForwardRef:\ncase SimpleMemoComponent:\ncase Block: {\n  // 执行 useLayoutEffect 的回调函数\n  commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork);\n  // 调度 useEffect 的销毁函数与回调函数\n  schedulePassiveEffects(finishedWork);\n  return;\n}`, `7489609306501843000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n<span class="token comment">// 以下都是 FunctionComponent 及相关类型</span>\n<span class="token keyword">case</span> FunctionComponent<span class="token punctuation">:</span>\n<span class="token keyword">case</span> ForwardRef<span class="token punctuation">:</span>\n<span class="token keyword">case</span> SimpleMemoComponent<span class="token punctuation">:</span>\n<span class="token keyword">case</span> Block<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 执行 useLayoutEffect 的回调函数</span>\n  <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span>HookLayout <span class="token operator">|</span> HookHasEffect<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// 调度 useEffect 的销毁函数与回调函数</span>\n  <span class="token function">schedulePassiveEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>你可以从<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L465-L491" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这段代码</p>\n</blockquote>\n</li>\n</ul>\n<p>在上一节介绍过，mutation 阶段会执行 useLayoutEffect hook 的销毁函数。</p>\n<p>结合这里我们可以发现，useLayoutEffect hook 从上一次更新的销毁函数调用到本次更新的回调函数调用是同步执行的。</p>\n<p>而 useEffect 则需要先调度，在 Layout 阶段完成后再异步执行。</p>\n<p>这就是 useLayoutEffect 与 useEffect 的区别。</p>\n<ul>\n<li>\n<p>对于 HostRoot，即 rootFiber，如果赋值了第三个参数回调函数，也会在此时调用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85371911188324070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ReactDOM.render(<App />, document.querySelector(\'#root\'), function() {\nconsole.log(\'i am mount~\');\n});`, `85371911188324070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#root\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'i am mount~\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h3 id="commitattachref"><a href="#commitattachref" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>commitAttachRef</h3>\n<p>commitLayoutEffects 会做的第二件事是 commitAttachRef。</p>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCommitWork.new.js#L823" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 commitAttachRef 源码</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15969268749294875000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function commitAttachRef(finishedWork: Fiber) {\n  const ref = finishedWork.ref;\n  if (ref !== null) {\n    const instance = finishedWork.stateNode;\n\n    // 获取 DOM 实例\n    let instanceToUse;\n    switch (finishedWork.tag) {\n      case HostComponent:\n        instanceToUse = getPublicInstance(instance);\n        break;\n      default:\n        instanceToUse = instance;\n    }\n\n    if (typeof ref === \'function\') {\n      // 如果 ref 是函数形式，调用回调函数\n      ref(instanceToUse);\n    } else {\n      // 如果 ref 是 ref 实例形式，赋值 ref.current\n      ref.current = instanceToUse;\n    }\n  }\n}`, `15969268749294875000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">commitAttachRef</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token punctuation">:</span> Fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ref <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>\n\n    <span class="token comment">// 获取 DOM 实例</span>\n    <span class="token keyword">let</span> instanceToUse<span class="token punctuation">;</span>\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span>\n        instanceToUse <span class="token operator">=</span> <span class="token function">getPublicInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">break</span><span class="token punctuation">;</span>\n      <span class="token keyword">default</span><span class="token punctuation">:</span>\n        instanceToUse <span class="token operator">=</span> instance<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ref <span class="token operator">===</span> <span class="token string">\'function\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果 ref 是函数形式，调用回调函数</span>\n      <span class="token function">ref</span><span class="token punctuation">(</span>instanceToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 如果 ref 是 ref 实例形式，赋值 ref.current</span>\n      ref<span class="token punctuation">.</span>current <span class="token operator">=</span> instanceToUse<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>代码逻辑很简单：获取 DOM 实例，更新 ref。</p>\n<h3 id="current-fiber-树切换"><a href="#current-fiber-%E6%A0%91%E5%88%87%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>current Fiber 树切换</h3>\n<p>至此，整个 layout 阶段就结束了。</p>\n<p>在结束本节的学习前，我们关注下这行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16675690754418948000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`root.current = finishedWork;`, `16675690754418948000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<blockquote>\n<p>你可以在<a href="https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L2022" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到这行代码</p>\n</blockquote>\n<p>在双缓存机制一节我们介绍过，workInProgress Fiber 树在 commit 阶段完成渲染后会变为 current Fiber 树。这行代码的作用就是切换 fiberRootNode 指向的 current Fiber 树。</p>\n<p>那么这行代码为什么在这里呢？（在 mutation 阶段结束后，layout 阶段开始前。）</p>\n<p>我们知道 componentWillUnmount 会在 mutation 阶段执行。此时 current Fiber 树还指向前一次更新的 Fiber 树，在生命周期钩子内获取的 DOM 还是更新前的。</p>\n<p>componentDidMount 和 componentDidUpdate 会在 layout 阶段执行。此时 current Fiber 树已经指向更新后的 Fiber 树，在生命周期钩子内获取的 DOM 就是更新后的。</p>\n<h3 id="总结-2"><a href="#%E6%80%BB%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>从这节我们学到，layout 阶段会遍历 effectList，依次执行 commitLayoutEffects。该方法的主要工作为“根据 effectTag 调用不同的处理函数处理 Fiber 并更新 ref。</p>',
id:"/github/workspace/blog/React技术解密笔记——架构篇/index.md absPath of file >>> MarkdownRemark",timeToRead:27,frontmatter:{date:"2021-01-21 17:34:36",path:"/react-technology-notes-framework/",tags:"前端, React, 高级前端",title:"React技术解密笔记——架构篇",draft:null}},{excerpt:"React 理念 React 理念 我们可以从官网看到 React 的理念： 我们认为，React 是用 JavaScript 构建快速响应的大型 Web 应用程序的首选方式。它在 Facebook 和 Instagram 上表现优秀。 可见，关键是实现快速响应。那么制约快速响应的因素是什么呢？ 我们日常使用 App…",html:'<h1 id="react-理念"><a href="#react-%E7%90%86%E5%BF%B5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React 理念</h1>\n<h2 id="react-理念-1"><a href="#react-%E7%90%86%E5%BF%B5-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React 理念</h2>\n<p>我们可以从官网看到 React 的理念：</p>\n<blockquote>\n<p>我们认为，React 是用 JavaScript 构建快速响应的大型 Web 应用程序的首选方式。它在 Facebook 和 Instagram 上表现优秀。</p>\n</blockquote>\n<p>可见，关键是实现快速响应。那么制约快速响应的因素是什么呢？</p>\n<p>我们日常使用 App，浏览网页时，有两类场景会制约快速响应：</p>\n<ul>\n<li>当遇到大计算量的操作或者设备性能不足使页面掉帧，导致卡顿。</li>\n<li>发送网络请求后，由于需要等待数据返回才能进一步操作导致不能快速响应。</li>\n</ul>\n<p>这两类场景可以概括为：</p>\n<ul>\n<li>CPU 的瓶颈</li>\n<li>IO 的瓶颈</li>\n</ul>\n<p>React 是如何解决这两个瓶颈的呢？</p>\n<h3 id="cpu-的瓶颈"><a href="#cpu-%E7%9A%84%E7%93%B6%E9%A2%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CPU 的瓶颈</h3>\n<p>当项目变得庞大、组件数量繁多时，就容易遇到 CPU 的瓶颈。</p>\n<p>考虑如下 Demo，我们向视图中渲染 3000 个 li：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20599827544436590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  const len = 3000;\n  return (\n    <ul>\n      {Array(len)\n        .fill(0)\n        .map((_, i) => (\n          <li>{i}</li>\n        ))}\n    </ul>\n  );\n}\n\nconst rootEl = document.querySelector(\'#root\');\nReactDOM.render(<App />, rootEl);`, `20599827544436590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> len <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">\n      </span><span class="token punctuation">{</span><span class="token function">Array</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>\n          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>i<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>\n        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">\n    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> rootEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">\'#root\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> rootEl<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>主流浏览器刷新频率为 60Hz，即每 （1000ms / 60Hz）16.6ms 浏览器刷新一次。</p>\n<p>我们知道，JS 可以操作 DOM，GUI 渲染线程与 JS 线程是互斥的。所以 JS 脚本执行和浏览器布局、绘制不能同时执行。</p>\n<p>在每 16.6ms 时间内，需要完成如下工作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24501509372601250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`JS 脚本执行 -----  样式布局 ----- 样式绘制`, `24501509372601250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">JS 脚本执行 -----  样式布局 ----- 样式绘制</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>当 JS 执行时间过长，超出了 16.6ms，这次刷新就没有时间执行样式布局和样式绘制了。</p>\n<p>在 Demo 中，由于组件数量繁多（3000 个），JS 脚本执行时间过长，页面掉帧，造成卡顿。</p>\n<p>可以从打印的执行堆栈图看到，JS 执行时间为 73.65ms，远远多于一帧的时间。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-20-11-08-03-00dbbe83f61a64b3e85e1f9f16df9e9e-d2345.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 61.545893719806756%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC0ElEQVQozy2QyU8TcQCFRzEiZ70JUZY/QC8mGgmyBfQiieABQQFJlKCUEBCKYReJTW3F0pYuFEo7QoZSyjKdMu2001l+M3SZtkNbqMgSJJFELiTGs1VMvuv3Xt6D1HNrSsvyBOLW2jyaBfcZagTXOyi5EW7rau7saOxqb3gjaZK2NErrarrra6QNT6TPX6pUKGT6NOKZVYIFXdw5k8DMCdcZsxtLkx6zzP6536EdhpVSZLwP1Y46J0YIw5huqOf23Ye3SgegId3EMrc070UcYAXss9wBAPuAP+SWuFWEtK0FnM6Qy844HKxjGaz4v9LJ07gORbIKHpzLLoLkEzoxxACKCAbpaIwXotwZXj/OAXKDp0jaS5AExZB+xgcCrJgIa8xzl3IrsvLvQ70qtTdOYWGCDvsCol9IMJE4E0myHgbzMigI4gRPIOvokgdz0j53gAbxoHwazsgpy8yrgF4pNO493sJ63KRrYcXlwENU5MAX2rPjITu+gfMpjE7YMIBSIsGn0vDioWp2PSOnNDO3AnrW/4E8ir+bs5koZ68F+UgEdHxMH0pq+U0tiEwJW0ZhW8NGJrmoKZqCU0eL30/6F30X0nK6ubqjjzzek1rWYRbtVBsVLm6ai1mjO6ZA0sAI5lDSKu7paWEKROcS+7bdY/zkdy/sOn+1ODOvEiprljq+7XdPr8hWyUfdyhal1RrZNoCojolO8WKa6eBWWtZRYSMXMwsp7OcvqRX7L5c3thsp31sYu9fQnVvUVNo8MCskDWzEyG8a2chMMGGJ7erpsImLIakj+8EJ+uO0x7yWkV3yV75T29k6Dpe9GMovqksvKShpmuJEEy8q8A0Zyqr9gsId1HJJOQZGl/1w8vBL/EAyufhvcyVUWPu6SjJ45ebj64V16bzLN6qHbR5LbKdNjdQP6Z+OGFpkRpXVWtE6Vtw8KNHaBubXqyTvL14rTx/2B/E8ueWYo1I+AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 20 11 08 03"\n        title=""\n        src="/static/2021-01-20-11-08-03-00dbbe83f61a64b3e85e1f9f16df9e9e-fee1c.png"\n        srcset="/static/2021-01-20-11-08-03-00dbbe83f61a64b3e85e1f9f16df9e9e-a67b7.png 200w,\n/static/2021-01-20-11-08-03-00dbbe83f61a64b3e85e1f9f16df9e9e-0b187.png 400w,\n/static/2021-01-20-11-08-03-00dbbe83f61a64b3e85e1f9f16df9e9e-fee1c.png 800w,\n/static/2021-01-20-11-08-03-00dbbe83f61a64b3e85e1f9f16df9e9e-d2345.png 1035w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>如何解决这个问题呢？</p>\n<p>答案是：在浏览器每一帧的时间中，预留一些时间给 JS 线程，React 利用这部分时间更新组件（可以看到，在源码中，预留的初始时间是 5ms）。</p>\n<p>当预留的时间不够用时，React 将线程控制权交还给浏览器使其有时间渲染 UI，React 则等待下一帧时间到来继续被中断的工作。</p>\n<blockquote>\n<p>这种将长任务分拆到每一帧中，像蚂蚁搬家一样一次执行一小段任务的操作，被称为时间切片（time slice）</p>\n</blockquote>\n<p>接下来我们开启 Concurrent Mode（后续章节会讲到，当前你只需了解开启后会启用时间切片）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32507863803420300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 通过使用ReactDOM.unstable_createRoot开启Concurrent Mode\n// ReactDOM.render(<App/>, rootEl);\nReactDOM.unstable_createRoot(rootEl).render(<App />);`, `32507863803420300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 通过使用ReactDOM.unstable_createRoot开启Concurrent Mode</span>\n<span class="token comment">// ReactDOM.render(&lt;App/>, rootEl);</span>\nReactDOM<span class="token punctuation">.</span><span class="token function">unstable_createRoot</span><span class="token punctuation">(</span>rootEl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>此时我们的长任务被拆分到每一帧不同的 task 中，JS 脚本执行时间大体在 5ms 左右，这样浏览器就有剩余时间执行样式布局和样式绘制，减少掉帧的可能性。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-20-11-16-52-39203a12a2cd216cf4fb8010900ad6b7-2beaa.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 37.54385964912281%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB6klEQVQY02OYP79lxqyWxYvaFy/umDm7deXy9jWrOtat7ly5oqO6obCoIrOsIru7s3zDuu61qztXr+xcvxZIdmza2Htw02SGznWzG5ZOm7xrUf/W+UVTe+YfX7Xg+Krl59YtP7++e/20jrVTu9bPmLJz/qpLm5aeXbvw+Mrl59YvOblq5dUNFw4cY+jYuLRu2bxJe9b0bl+RN3XygrPb55zYvPTSzuWXdy27uHPFld1rb+1fenHnkos7l13aNf/01sUXdgLFF17cfmLXWYaaJXMals/t3Ly0YeW8zP7+6Yc2zD2xecGZbfNPbQYyZh3dOOvYxol71/TuWDnnxJap+9fOO7UViBZe2XFiz2mG6PqW2Iqy2MZWv+Jar+zyxLbOkjkzimZNS+roBjIyevtiG9uy+icEl9cntnX55FWld/eWzJ5es3DG+Z1nGBTso0WNgrQ8kwwC0mStwjW9EhVsIjXcE+Ttoqxi8qxj8pQcozU9EqUtwhRsI4X0AlScYlRd4sw9E84uOcLArebFpuTBoeIpqOsPJPk0fdiVPICIWd5d0TrE2CeaUc6NU9WDRd6VRd6NRc6VX9uPRc6NQ91zefdGBjZFdwhiVXCDMIA6wQwPdkU3dkVXEFvBjV0JKA5Vya7ozqjgMq1uKQBfTOCztu+AiQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 20 11 16 52"\n        title=""\n        src="/static/2021-01-20-11-16-52-39203a12a2cd216cf4fb8010900ad6b7-fee1c.png"\n        srcset="/static/2021-01-20-11-16-52-39203a12a2cd216cf4fb8010900ad6b7-a67b7.png 200w,\n/static/2021-01-20-11-16-52-39203a12a2cd216cf4fb8010900ad6b7-0b187.png 400w,\n/static/2021-01-20-11-16-52-39203a12a2cd216cf4fb8010900ad6b7-fee1c.png 800w,\n/static/2021-01-20-11-16-52-39203a12a2cd216cf4fb8010900ad6b7-b1a91.png 1200w,\n/static/2021-01-20-11-16-52-39203a12a2cd216cf4fb8010900ad6b7-2beaa.png 1425w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>所以，解决 CPU 瓶颈的关键是实现时间切片，而时间切片的关键是：将同步的更新变为可中断的异步更新。</p>\n<h3 id="io-的瓶颈"><a href="#io-%E7%9A%84%E7%93%B6%E9%A2%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IO 的瓶颈</h3>\n<p>网络延迟是前端开发者无法解决的。如何在网络延迟客观存在的情况下，减少用户对网络延迟的感知？</p>\n<p>React 给出的答案是将人机交互研究的结果整合到真实的 UI 中。</p>\n<p>这里我们以业界人机交互最顶尖的苹果举例，在 IOS 系统中：</p>\n<p>点击“设置”面板中的“通用”，进入“通用”界面：</p>\n<p><a target="_blank" href="/legacy-move-44d21206ab9834e095a9808204cdfabc.gif">通用</a></p>\n<p>作为对比，再点击“设置”面板中的“Siri 与搜索”，进入“Siri 与搜索”界面：</p>\n<p><a target="_blank" href="/concurrent-move-e5a779e80bc251c0ed57218bc3a7bf27.gif">Siri 与搜索</a></p>\n<p>你能感受到两者体验上的区别么？</p>\n<p>事实上，点击“通用”后的交互是同步的，直接显示后续界面。而点击“Siri 与搜索”后的交互是异步的，需要等待请求返回后再显示后续界面。但从用户感知来看，这两者的区别微乎其微。</p>\n<p>这里的窍门在于：点击“Siri 与搜索”后，先在当前页面停留了一小段时间，这一小段时间被用来请求数据。</p>\n<p>当“这一小段时间”足够短时，用户是无感知的。如果请求时间超过一个范围，再显示 loading 的效果。</p>\n<p>试想如果我们一点击“Siri 与搜索”就显示 loading 效果，即使数据请求时间很短，loading 效果一闪而过。用户也是可以感知到的。</p>\n<p>为此，React 实现了 Suspense 功能及配套的 hook——useDeferredValue。</p>\n<p>而在源码内部，为了支持这些特性，同样需要将同步的更新变为可中断的异步更新。</p>\n<h3 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>通过以上内容，我们可以看到，React 为了践行“构建快速响应的大型 Web 应用程序”理念做出的努力。</p>\n<p>其中的关键是解决 CPU 的瓶颈与 IO 的瓶颈。而落实到实现上，则需要将同步的更新变为可中断的异步更新。</p>\n<h2 id="老的-react-架构"><a href="#%E8%80%81%E7%9A%84-react-%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>老的 React 架构</h2>\n<p>React 从 v15 升级到 v16 后重构了整个架构。本节我们聊聊 v15，看看他为什么不能满足快速响应的理念，以至于被重构。</p>\n<h3 id="react15-架构"><a href="#react15-%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React15 架构</h3>\n<p>React15 架构可以分为两层：</p>\n<ul>\n<li>Reconciler（协调器）—— 负责找出变化的组件</li>\n<li>Renderer（渲染器）—— 负责将变化的组件渲染到页面上</li>\n</ul>\n<h4 id="reconciler（协调器）"><a href="#reconciler%EF%BC%88%E5%8D%8F%E8%B0%83%E5%99%A8%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reconciler（协调器）</h4>\n<p>我们知道，在 React 中可以通过 this.setState、this.forceUpdate、ReactDOM.render 等 API 触发更新。</p>\n<p>每当有更新发生时，Reconciler 会做如下工作：</p>\n<ul>\n<li>调用函数组件、或 class 组件的 render 方法，将返回的 JSX 转化为虚拟 DOM</li>\n<li>将虚拟 DOM 和上次更新时的虚拟 DOM 对比</li>\n<li>通过对比找出本次更新中变化的虚拟 DOM</li>\n<li>通知 Renderer 将变化的虚拟 DOM 渲染到页面上</li>\n</ul>\n<h4 id="renderer（渲染器）"><a href="#renderer%EF%BC%88%E6%B8%B2%E6%9F%93%E5%99%A8%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Renderer（渲染器）</h4>\n<p>由于 React 支持跨平台，所以不同平台有不同的 Renderer。我们前端最熟悉的是负责在浏览器环境渲染的 Renderer —— ReactDOM。</p>\n<p>除此之外，还有：</p>\n<ul>\n<li>ReactNative 渲染器，渲染 App 原生组件</li>\n<li>ReactTest 渲染器，渲染出纯 Js 对象用于测试</li>\n<li>ReactArt 渲染器，渲染到 Canvas, SVG 或 VML (IE8)</li>\n</ul>\n<p>在每次更新发生时，Renderer 接到 Reconciler 通知，将变化的组件渲染在当前宿主环境。</p>\n<h3 id="react15-架构的缺点"><a href="#react15-%E6%9E%B6%E6%9E%84%E7%9A%84%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React15 架构的缺点</h3>\n<p>在 Reconciler 中，mount 的组件会调用 mountComponent，update 的组件会调用 updateComponent。这两个方法都会递归更新子组件。</p>\n<h4 id="递归更新的缺点"><a href="#%E9%80%92%E5%BD%92%E6%9B%B4%E6%96%B0%E7%9A%84%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>递归更新的缺点</h4>\n<p>由于递归执行，所以更新一旦开始，中途就无法中断。当层级很深时，递归更新时间超过了 16ms，用户交互就会卡顿。</p>\n<p>在上一节中，我们已经提出了解决办法——用可中断的异步更新代替同步的更新。那么 React15 的架构支持异步更新么？让我们看一个例子：</p>\n<p>我用红色标注了更新的步骤。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-20-13-39-51-9a4b5231f33456915a73f4d6bf15e9ce-f4bc6.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 45.94285714285714%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABI0lEQVQoz6VR2Y7DIAzM/39hq6pJWlpyCMIRQiBgZ026R1f7uJZAYDwz9lDt/4iKlpHy8XwqKeeEIqJcs9a673tjDL3iV7zOv8GIKcbZOe99yLBkDIAxRrrmnP+q4Y7fFEWZd53Smg5AWQSnlTbUjbjdWtIXQo7jqJTaUuK8iyEWCigUFdWHGJW3arVpz0Qg+/7JeV3XTdMwxqSU67pSLwBgZiucUsEe+nt1NIF283IxCYGSgnP2eBD4crm07Y1kp2my1uYMpTIsJsx4zP8J9imY1WWaCHAahq4fSLapm/udCSGccyQOULgJbKP/AZdUXOSiNyzwgTHq+HQ6nc/n6/XakSOKPNGkTM/TYiZv4DCoev8AfIuX1bS/fw8BaLR82EXXD7dyCN2IQMOxAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 20 13 39 51"\n        title=""\n        src="/static/2021-01-20-13-39-51-9a4b5231f33456915a73f4d6bf15e9ce-fee1c.png"\n        srcset="/static/2021-01-20-13-39-51-9a4b5231f33456915a73f4d6bf15e9ce-a67b7.png 200w,\n/static/2021-01-20-13-39-51-9a4b5231f33456915a73f4d6bf15e9ce-0b187.png 400w,\n/static/2021-01-20-13-39-51-9a4b5231f33456915a73f4d6bf15e9ce-fee1c.png 800w,\n/static/2021-01-20-13-39-51-9a4b5231f33456915a73f4d6bf15e9ce-b1a91.png 1200w,\n/static/2021-01-20-13-39-51-9a4b5231f33456915a73f4d6bf15e9ce-95179.png 1600w,\n/static/2021-01-20-13-39-51-9a4b5231f33456915a73f4d6bf15e9ce-f4bc6.png 1750w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>我们可以看到，Reconciler 和 Renderer 是交替工作的，当第一个 li 在页面上已经变化后，第二个 li 再进入 Reconciler。</p>\n<p>由于整个过程都是同步的，所以在用户看来所有 DOM 是同时更新的。</p>\n<p>接下来，让我们模拟一下，如果中途中断更新会怎么样？</p>\n<blockquote>\n<p>注意<br>\n以下是我们模拟中断的情况，实际上 React15 并不会中断进行中的更新</p>\n</blockquote>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-20-13-41-12-80b199c9e696429010f1ee6b56763694-6f195.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 43.109540636042404%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABJElEQVQoz4WQ226DMBBE+f8PTBUJWlokHGLMzfHdu+7ING2f2vNgFrPDjKZx1j6MCSFEYpdLoOJDMMY455i5/EmjpPwYhlne90DCsYpl2bUQQi3L/+LjOJ5LOJlzopyJKMYI/5yzq+AVtxhK3eVK8/beL3oz0SWmQrTe76MQXddeLpfr9Soq8zxrrb337WurnfE5cmEYNFRYR7s6DTGlvCsl53maJmi2bVNKxZjgnxISUeK8umPzuoq5wd3uNMSZETV51BXCOI7DMPR9f7uJdV2hhC1+ETlvVu9B0ynGA5m1NxggDpW2bV8qXddJKZEQl6giFXoE84jux3lzWpkdkU4HgGKstRCchhDjE4bAebE7kn85/64eBebKuXpCT86GvzdxfgKy8wleTsDK9QAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 20 13 41 12"\n        title=""\n        src="/static/2021-01-20-13-41-12-80b199c9e696429010f1ee6b56763694-fee1c.png"\n        srcset="/static/2021-01-20-13-41-12-80b199c9e696429010f1ee6b56763694-a67b7.png 200w,\n/static/2021-01-20-13-41-12-80b199c9e696429010f1ee6b56763694-0b187.png 400w,\n/static/2021-01-20-13-41-12-80b199c9e696429010f1ee6b56763694-fee1c.png 800w,\n/static/2021-01-20-13-41-12-80b199c9e696429010f1ee6b56763694-b1a91.png 1200w,\n/static/2021-01-20-13-41-12-80b199c9e696429010f1ee6b56763694-95179.png 1600w,\n/static/2021-01-20-13-41-12-80b199c9e696429010f1ee6b56763694-6f195.png 1698w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>当第一个 li 完成更新时中断更新，即步骤 3 完成后中断更新，此时后面的步骤都还未执行。</p>\n<p>用户本来期望 123 变为 246。实际却看见更新不完全的 DOM！（即 223）</p>\n<p>基于这个原因，React 决定重写整个架构。</p>\n<h2 id="新的-react-架构"><a href="#%E6%96%B0%E7%9A%84-react-%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>新的 React 架构</h2>\n<h3 id="react16-架构"><a href="#react16-%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React16 架构</h3>\n<p>React16 架构可以分为三层：</p>\n<ul>\n<li>Scheduler（调度器）—— 调度任务的优先级，高优任务优先进入 Reconciler</li>\n<li>Reconciler（协调器）—— 负责找出变化的组件</li>\n<li>Renderer（渲染器）—— 负责将变化的组件渲染到页面上</li>\n</ul>\n<p>可以看到，相较于 React15，React16 中新增了 Scheduler（调度器），让我们来了解下他。</p>\n<h4 id="scheduler（调度器）"><a href="#scheduler%EF%BC%88%E8%B0%83%E5%BA%A6%E5%99%A8%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scheduler（调度器）</h4>\n<p>既然我们以浏览器是否有剩余时间作为任务中断的标准，那么我们需要一种机制，当浏览器有剩余时间时通知我们。</p>\n<p>其实部分浏览器已经实现了这个 API，这就是 requestIdleCallback。但是由于以下因素，React 放弃使用：</p>\n<ul>\n<li>浏览器兼容性</li>\n<li>触发频率不稳定，受很多因素影响。比如当我们的浏览器切换 tab 后，之前 tab 注册的 requestIdleCallback 触发的频率会变得很低</li>\n</ul>\n<p>基于以上原因，React 实现了功能更完备的 requestIdleCallbackpolyfill，这就是 Scheduler。除了在空闲时触发回调的功能外，Scheduler 还提供了多种调度优先级供任务设置。</p>\n<blockquote>\n<p>Scheduler 是独立于 React 的库</p>\n</blockquote>\n<h4 id="reconciler（协调器）-1"><a href="#reconciler%EF%BC%88%E5%8D%8F%E8%B0%83%E5%99%A8%EF%BC%89-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reconciler（协调器）</h4>\n<p>我们知道，在 React15 中 Reconciler 是递归处理虚拟 DOM 的。让我们看看 React16 的 Reconciler。</p>\n<p>我们可以看见，更新工作从递归变成了可以中断的循环过程。每次循环都会调用 shouldYield 判断当前是否有剩余时间。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75849388001772030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`/** @noinline */\nfunction workLoopConcurrent() {\n  // Perform work until Scheduler asks us to yield\n  while (workInProgress !== null && !shouldYield()) {\n    workInProgress = performUnitOfWork(workInProgress);\n  }\n}`, `75849388001772030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">/** @noinline */</span>\n<span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Perform work until Scheduler asks us to yield</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    workInProgress <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么 React16 是如何解决中断更新时 DOM 渲染不完全的问题呢？</p>\n<p>在 React16 中，Reconciler 与 Renderer 不再是交替工作。当 Scheduler 将任务交给 Reconciler 后，Reconciler 会为变化的虚拟 DOM 打上代表增/删/更新的标记，类似这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26607724180398830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export const Placement = /*             */ 0b0000000000010;\nexport const Update = /*                */ 0b0000000000100;\nexport const PlacementAndUpdate = /*    */ 0b0000000000110;\nexport const Deletion = /*              */ 0b0000000001000;`, `26607724180398830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> Placement <span class="token operator">=</span> <span class="token comment">/*             */</span> <span class="token number">0b0000000000010</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> Update <span class="token operator">=</span> <span class="token comment">/*                */</span> <span class="token number">0b0000000000100</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> PlacementAndUpdate <span class="token operator">=</span> <span class="token comment">/*    */</span> <span class="token number">0b0000000000110</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">const</span> Deletion <span class="token operator">=</span> <span class="token comment">/*              */</span> <span class="token number">0b0000000001000</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>全部的标记见<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactSideEffectTags.js" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n</blockquote>\n<p>整个 Scheduler 与 Reconciler 的工作都在内存中进行。只有当所有组件都完成 Reconciler 的工作，才会统一交给 Renderer。</p>\n<blockquote>\n<p>你可以在<a href="https://zh-hans.reactjs.org/docs/codebase-overview.html#fiber-reconciler" target="_blank" rel="nofollow noreferrer noopener">这里</a>看到 React 官方对 React16 新 Reconciler 的解释</p>\n</blockquote>\n<h4 id="renderer（渲染器）-1"><a href="#renderer%EF%BC%88%E6%B8%B2%E6%9F%93%E5%99%A8%EF%BC%89-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Renderer（渲染器）</h4>\n<p>Renderer 根据 Reconciler 为虚拟 DOM 打的标记，同步执行对应的 DOM 操作。</p>\n<p>所以，对于我们在上一节使用过的 Demo</p>\n<p>在 React16 架构中整个更新流程为：</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-20-14-11-01-80f8ddce4ee76464a638a22e47279811-4711f.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 43.056768558951966%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABTElEQVQoz41QTXPrIAz0//9zObQ9tM9p3MZJDUiA+cYC/EjaaS89VLMwSGK1mh2uAqWxIBUHXLhwMe1/jkFoB8oul6tbTXQ+h7RvtFO5g37wK7kaHxEN8N3nan01rqx206ajt5r1zYUqdfWRaiulftLaHcPLNL3Nc8gp5OxT2tqeiMbX03Q+2xBuxZyD8Unb8XSa50vOmw8hptQfw+FweHp4+LheAUBw3qs2+KfHx9fjkTHGGRcgFBMG8GUcOWNKSc65Uso5OzClLwtDxFJK3yfRhla/3wMB3s4zeCIfeR//cTvaRmtdJ1trB/QRjO9JTmlvrdRGpXUFhD4Q+28u16AN2QBSLsvSObVWIupiA64rSqS7bNtbuYmX53/jcZp87PZ7XJUSSNZ/m9y+DavSVLluXGaO/SZxw2dKoAroqkxZoLjQ53a3+2qlfeE/GLYCLAGl9qkAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 20 14 11 01"\n        title=""\n        src="/static/2021-01-20-14-11-01-80f8ddce4ee76464a638a22e47279811-fee1c.png"\n        srcset="/static/2021-01-20-14-11-01-80f8ddce4ee76464a638a22e47279811-a67b7.png 200w,\n/static/2021-01-20-14-11-01-80f8ddce4ee76464a638a22e47279811-0b187.png 400w,\n/static/2021-01-20-14-11-01-80f8ddce4ee76464a638a22e47279811-fee1c.png 800w,\n/static/2021-01-20-14-11-01-80f8ddce4ee76464a638a22e47279811-b1a91.png 1200w,\n/static/2021-01-20-14-11-01-80f8ddce4ee76464a638a22e47279811-95179.png 1600w,\n/static/2021-01-20-14-11-01-80f8ddce4ee76464a638a22e47279811-4711f.png 2290w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>其中红框中的步骤随时可能由于以下原因被中断：</p>\n<ul>\n<li>有其他更高优任务需要先更新</li>\n<li>当前帧没有剩余时间</li>\n</ul>\n<p>由于红框中的工作都在内存中进行，不会更新页面上的 DOM，所以即使反复中断，用户也不会看见更新不完全的 DOM（即上一节演示的情况）。</p>\n<blockquote>\n<p>由于 Scheduler 和 Reconciler 都是平台无关的，所以 React 为他们单独发了一个包 react-Reconciler。你可以用这个包自己实现一个 ReactDOM，具体见参考资料</p>\n</blockquote>\n<h3 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>通过本节我们知道了 React16 采用新的 Reconciler。</p>\n<p>Reconciler 内部采用了 Fiber 的架构。</p>\n<p>Fiber 是什么？他和 Reconciler 或者说和 React 之间是什么关系？我们会在接下来三节解答。</p>\n<h2 id="fiber-架构的心智模型"><a href="#fiber-%E6%9E%B6%E6%9E%84%E7%9A%84%E5%BF%83%E6%99%BA%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber 架构的心智模型</h2>\n<p>React 核心团队成员 Sebastian Markbåge（React Hooks 的发明者）曾说：我们在 React 中做的就是践行代数效应（Algebraic Effects）。</p>\n<p>那么，代数效应是什么呢？他和 React 有什么关系呢。</p>\n<h3 id="什么是代数效应"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BB%A3%E6%95%B0%E6%95%88%E5%BA%94" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是代数效应</h3>\n<p>代数效应是函数式编程中的一个概念，用于将副作用从函数调用中分离。</p>\n<p>接下来我们用虚构的语法来解释。</p>\n<p>假设我们有一个函数 getTotalPicNum，传入 2 个用户名称后，分别查找该用户在平台保存的图片数量，最后将图片数量相加后返回。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24260100810906460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getTotalPicNum(user1, user2) {\n  const num1 = getPicNum(user1);\n  const num2 = getPicNum(user2);\n\n  return picNum1 + picNum2;\n}`, `24260100810906460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getTotalPicNum</span><span class="token punctuation">(</span><span class="token parameter">user1<span class="token punctuation">,</span> user2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> num1 <span class="token operator">=</span> <span class="token function">getPicNum</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> num2 <span class="token operator">=</span> <span class="token function">getPicNum</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> picNum1 <span class="token operator">+</span> picNum2<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 getTotalPicNum 中，我们不关注 getPicNum 的实现，只在乎“获取到两个数字后将他们相加的结果返回”这一过程。</p>\n<p>接下来我们来实现 getPicNum。</p>\n<p>“用户在平台保存的图片数量”是保存在服务器中的。所以，为了获取该值，我们需要发起异步请求。</p>\n<p>为了尽量保持 getTotalPicNum 的调用方式不变，我们首先想到了使用 async await</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28971024733427876000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async function getTotalPicNum(user1, user2) {\n  const num1 = await getPicNum(user1);\n  const num2 = await getPicNum(user2);\n\n  return picNum1 + picNum2;\n}`, `28971024733427876000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getTotalPicNum</span><span class="token punctuation">(</span><span class="token parameter">user1<span class="token punctuation">,</span> user2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> num1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getPicNum</span><span class="token punctuation">(</span>user1<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> num2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getPicNum</span><span class="token punctuation">(</span>user2<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> picNum1 <span class="token operator">+</span> picNum2<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，async await 是有传染性的 —— 当一个函数变为 async 后，这意味着调用他的函数也需要是 async，这破坏了 getTotalPicNum 的同步特性。</p>\n<p>有没有什么办法能保持 getTotalPicNum 保持现有调用方式不变的情况下实现异步请求呢？</p>\n<p>没有。不过我们可以虚构一个。</p>\n<p>我们虚构一个类似 try…catch 的语法 —— try…handle 与两个操作符 perform、resume。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97510927298342910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function getPicNum(name) {\n  const picNum = perform name;\n  return picNum;\n}\n\ntry {\n  getTotalPicNum(\'kaSong\', \'xiaoMing\');\n} handle (who) {\n  switch (who) {\n    case \'kaSong\':\n      resume with 230;\n    case \'xiaoMing\':\n      resume with 122;\n    default:\n      resume with 0;\n  }\n}`, `97510927298342910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getPicNum</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> picNum <span class="token operator">=</span> perform name<span class="token punctuation">;</span>\n  <span class="token keyword">return</span> picNum<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">try</span> <span class="token punctuation">{</span>\n  <span class="token function">getTotalPicNum</span><span class="token punctuation">(</span><span class="token string">\'kaSong\'</span><span class="token punctuation">,</span> <span class="token string">\'xiaoMing\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token function">handle</span> <span class="token punctuation">(</span><span class="token parameter">who</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>who<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token string">\'kaSong\'</span><span class="token punctuation">:</span>\n      resume <span class="token keyword">with</span> <span class="token number">230</span><span class="token punctuation">;</span>\n    <span class="token keyword">case</span> <span class="token string">\'xiaoMing\'</span><span class="token punctuation">:</span>\n      resume <span class="token keyword">with</span> <span class="token number">122</span><span class="token punctuation">;</span>\n    <span class="token keyword">default</span><span class="token punctuation">:</span>\n      resume <span class="token keyword">with</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当执行到 getTotalPicNum 内部的 getPicNum 方法时，会执行 perform name。</p>\n<p>此时函数调用栈会从 getPicNum 方法内跳出，被最近一个 try…handle 捕获。类似 throw Error 后被最近一个 try…catch 捕获。</p>\n<p>类似 throw Error 后 Error 会作为 catch 的参数，perform name 后 name 会作为 handle 的参数。</p>\n<p>与 try…catch 最大的不同在于：当 Error 被 catch 捕获后，之前的调用栈就销毁了。而 handle 执行 resume 后会回到之前 perform 的调用栈。</p>\n<p>对于 <code class="language-text">case &#39;kaSong&#39;</code>，执行完 <code class="language-text">resume with 230;</code> 后调用栈会回到 getPicNum，此时 <code class="language-text">picNum === 230</code></p>\n<blockquote>\n<p>注意<br>\n再次申明，try…handle 的语法是虚构的，只是为了演示代数效应的思想。</p>\n</blockquote>\n<p>总结一下：代数效应能够将副作用（例子中为请求图片数量）从函数逻辑中分离，使函数关注点保持纯粹。</p>\n<p>并且，从例子中可以看出，<code class="language-text">perform resume</code> 不需要区分同步异步。</p>\n<h3 id="代数效应在-react-中的应用"><a href="#%E4%BB%A3%E6%95%B0%E6%95%88%E5%BA%94%E5%9C%A8-react-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代数效应在 React 中的应用</h3>\n<p>那么代数效应与 React 有什么关系呢？最明显的例子就是 Hooks。</p>\n<p>对于类似 useState、useReducer、useRef 这样的 Hook，我们不需要关注 FunctionComponent 的 state 在 Hook 中是如何保存的，React 会为我们处理。</p>\n<p>我们只需要假设 useState 返回的是我们想要的 state，并编写业务逻辑就行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46936609582433350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  const [num, updateNum] = useState(0);\n\n  return <button onClick={() => updateNum((num) => num + 1)}>{num}</button>;\n}`, `46936609582433350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果这个例子还不够明显，可以看看官方的 <a href="https://codesandbox.io/s/frosty-hermann-bztrp?file=/src/index.js:152-160" target="_blank" rel="nofollow noreferrer noopener">Suspense Demo</a></p>\n<p>在 Demo 中 ProfileDetails 用于展示用户名称。而用户名称是异步请求的。</p>\n<p>但是 Demo 中完全是同步的写法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22145893976617103000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function ProfileDetails() {\n  const user = resource.user.read();\n  return <h1>{user.name}</h1>;\n}`, `22145893976617103000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">ProfileDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> user <span class="token operator">=</span> resource<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="代数效应与-generator"><a href="#%E4%BB%A3%E6%95%B0%E6%95%88%E5%BA%94%E4%B8%8E-generator" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代数效应与 Generator</h3>\n<p>从 React15 到 React16，协调器（Reconciler）重构的一大目的是：将老的同步更新的架构变为异步可中断更新。</p>\n<p>异步可中断更新可以理解为：更新在执行过程中可能会被打断（浏览器时间分片用尽或有更高优任务插队），当可以继续执行时恢复之前执行的中间状态。</p>\n<p>这就是代数效应中 try…handle 的作用。</p>\n<p>其实，浏览器原生就支持类似的实现，这就是 Generator。</p>\n<p>但是 Generator 的一些缺陷使 React 团队放弃了他：</p>\n<ul>\n<li>类似 async，Generator 也是传染性的，使用了 Generator 则上下文的其他函数也需要作出改变。这样心智负担比较重。</li>\n<li>Generator 执行的中间状态是上下文关联的。</li>\n</ul>\n<p>考虑如下例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23538333020649360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function* doWork(A, B, C) {\n  var x = doExpensiveWorkA(A);\n  yield;\n  var y = x + doExpensiveWorkB(B);\n  yield;\n  var z = y + doExpensiveWorkC(C);\n  return z;\n}`, `23538333020649360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">doExpensiveWorkA</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> y <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token function">doExpensiveWorkB</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">yield</span><span class="token punctuation">;</span>\n  <span class="token keyword">var</span> z <span class="token operator">=</span> y <span class="token operator">+</span> <span class="token function">doExpensiveWorkC</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> z<span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每当浏览器有空闲时间都会依次执行其中一个 doExpensiveWork，当时间用尽则会中断，当再次恢复时会从中断位置继续执行。</p>\n<p>只考虑“单一优先级任务的中断与继续”情况下 Generator 可以很好的实现异步可中断更新。</p>\n<p>但是当我们考虑“高优先级任务插队”的情况，如果此时已经完成 doExpensiveWorkA 与 doExpensiveWorkB 计算出 x 与 y。</p>\n<p>此时 B 组件接收到一个高优更新，由于 Generator 执行的中间状态是上下文关联的，所以计算 y 时无法复用之前已经计算出的 x，需要重新计算。</p>\n<p>如果通过全局变量保存之前执行的中间状态，又会引入新的复杂度。</p>\n<blockquote>\n<p>更详细的解释可以参考<a href="https://github.com/facebook/react/issues/7942#issuecomment-254987818" target="_blank" rel="nofollow noreferrer noopener">这个 issue</a></p>\n</blockquote>\n<p>基于这些原因，React 没有采用 Generator 实现协调器。</p>\n<h3 id="代数效应与-fiber"><a href="#%E4%BB%A3%E6%95%B0%E6%95%88%E5%BA%94%E4%B8%8E-fiber" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>代数效应与 Fiber</h3>\n<p>Fiber 并不是计算机术语中的新名词，他的中文翻译叫做纤程，与进程（Process）、线程（Thread）、协程（Coroutine）同为程序执行过程。</p>\n<p>在很多文章中将纤程理解为协程的一种实现。在 JS 中，协程的实现便是 Generator。</p>\n<p>所以，我们可以将纤程(Fiber)、协程(Generator)理解为代数效应思想在 JS 中的体现。</p>\n<p>React Fiber 可以理解为：</p>\n<p>React 内部实现的一套状态更新机制。支持任务不同优先级，可中断与恢复，并且恢复后可以复用之前的中间状态。</p>\n<p>其中每个任务更新单元为 React Element 对应的 Fiber 节点。</p>\n<h2 id="fiber-架构的实现原理"><a href="#fiber-%E6%9E%B6%E6%9E%84%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber 架构的实现原理</h2>\n<p>在新的 React 架构一节中，我们提到的虚拟 DOM 在 React 中有个正式的称呼——Fiber。在之后的学习中，我们会逐渐用 Fiber 来取代 React16 虚拟 DOM 这一称呼。</p>\n<p>接下来让我们了解下 Fiber 因何而来？他的作用是什么？</p>\n<h3 id="fiber-的起源"><a href="#fiber-%E7%9A%84%E8%B5%B7%E6%BA%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber 的起源</h3>\n<blockquote>\n<p>最早的 Fiber 官方解释来源于 <a href="https://github.com/acdlite/react-fiber-architecture" target="_blank" rel="nofollow noreferrer noopener">2016 年 React 团队成员 Acdlite 的一篇介绍</a>。</p>\n</blockquote>\n<p>从上一章的学习我们知道：</p>\n<p>在 React15 及以前，Reconciler 采用递归的方式创建虚拟 DOM，递归过程是不能中断的。如果组件树的层级很深，递归会占用线程很多时间，造成卡顿。</p>\n<p>为了解决这个问题，React16 将递归的无法中断的更新重构为异步的可中断更新，由于曾经用于递归的虚拟 DOM 数据结构已经无法满足需要。于是，全新的 Fiber 架构应运而生。</p>\n<h3 id="fiber-的含义"><a href="#fiber-%E7%9A%84%E5%90%AB%E4%B9%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber 的含义</h3>\n<p>Fiber 包含三层含义：</p>\n<ol>\n<li>作为架构来说，之前 React15 的 Reconciler 采用递归的方式执行，数据保存在递归调用栈中，所以被称为 stack Reconciler。React16 的 Reconciler 基于 Fiber 节点实现，被称为 Fiber Reconciler。</li>\n<li>作为静态的数据结构来说，每个 Fiber 节点对应一个 React element，保存了该组件的类型（函数组件/类组件/原生组件…）、对应的 DOM 节点等信息。</li>\n<li>作为动态的工作单元来说，每个 Fiber 节点保存了本次更新中该组件改变的状态、要执行的工作（需要被删除/被插入页面中/被更新…）。</li>\n</ol>\n<h3 id="fiber-的结构"><a href="#fiber-%E7%9A%84%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber 的结构</h3>\n<p>你可以从这里看到 <a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiber.new.js#L117" target="_blank" rel="nofollow noreferrer noopener">Fiber 节点的属性定义</a>。虽然属性很多，但我们可以按三层含义将他们分类来看</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26339331007956156000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function FiberNode(tag: WorkTag, pendingProps: mixed, key: null | string, mode: TypeOfMode) {\n  // 作为静态数据结构的属性\n  this.tag = tag;\n  this.key = key;\n  this.elementType = null;\n  this.type = null;\n  this.stateNode = null;\n\n  // 用于连接其他 Fiber 节点形成 Fiber 树\n  this.return = null;\n  this.child = null;\n  this.sibling = null;\n  this.index = 0;\n\n  this.ref = null;\n\n  // 作为动态的工作单元的属性\n  this.pendingProps = pendingProps;\n  this.memoizedProps = null;\n  this.updateQueue = null;\n  this.memoizedState = null;\n  this.dependencies = null;\n\n  this.mode = mode;\n\n  this.effectTag = NoEffect;\n  this.nextEffect = null;\n\n  this.firstEffect = null;\n  this.lastEffect = null;\n\n  // 调度优先级相关\n  this.lanes = NoLanes;\n  this.childLanes = NoLanes;\n\n  // 指向该 fiber 在另一次更新时对应的 fiber\n  this.alternate = null;\n}`, `26339331007956156000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">:</span> WorkTag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">:</span> mixed<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span> mode<span class="token punctuation">:</span> TypeOfMode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 作为静态数据结构的属性</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>elementType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 用于连接其他 Fiber 节点形成 Fiber 树</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 作为动态的工作单元的属性</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 调度优先级相关</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>childLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>\n\n  <span class="token comment">// 指向该 fiber 在另一次更新时对应的 fiber</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="作为架构来说"><a href="#%E4%BD%9C%E4%B8%BA%E6%9E%B6%E6%9E%84%E6%9D%A5%E8%AF%B4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作为架构来说</h4>\n<p>每个 Fiber 节点有个对应的 React element，多个 Fiber 节点是如何连接形成树呢？靠如下三个属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61479001033251350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 指向父级 Fiber 节点\nthis.return = null;\n// 指向子 Fiber 节点\nthis.child = null;\n// 指向右边第一个兄弟 Fiber 节点\nthis.sibling = null;`, `61479001033251350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 指向父级 Fiber 节点</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token comment">// 指向子 Fiber 节点</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token comment">// 指向右边第一个兄弟 Fiber 节点</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>举个例子，如下的组件结构：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59631547491403600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  return (\n    <div>\n      i am\n      <span>KaSong</span>\n    </div>\n  );\n}`, `59631547491403600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div<span class="token operator">></span>\n      i am\n      <span class="token operator">&lt;</span>span<span class="token operator">></span>KaSong<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对应的 Fiber 树结构：</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-21-11-24-26-f6bcacfdef6508ce0ffa17d297746c02-d2875.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 82.6946847960445%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABu0lEQVQ4y41TC28TMQze//9TCCGBELAWNAqT1q3Pu+MeubwuT9uHr2WwCmhrRbHl5Ivtz87NeJCMZAIMEYaELpH2OQKOl+SGDkq75BIKZV69frPe7lwepYvsJzoLPioOE2F6YrlvN7Vim9flyEdVy6IST4CoPXAKvSlLsbbBXAYTkbSi6ksTcjsA753pGlWF5K+K7BMGGKUN35cb7eIQaYgTYXQN2AawkZT1H+d3jTQM3gofMh7zAgQgoL/Y+wVOObroEpAK1Nnkk/fRGx+HgHpQq+p+XT/EHP5d8659fCq/JoDeBB+hEqvH8ptxkrvAPfcpI/4/Mg+JZZ5srHRSPhsPMeNvOmqdTMSAI3NpPN+lkyFRLsVM2tgPn253+4KBrUkJ2I+FDNzC2ecvb9+9N3bgRg4hH7l8rhmQx9P41ErLnDNhteq2zbISBTttHHdN/7AXh4xGpNO0T2U65IIbWTIXm/q+FEXggJF60/3ot0LXZ8AvniHsdFspIT3aiHLQtayMUxfAB24pA/o8NkItlpvVrmKDx4HOpv1HmHP+pEVRzGbzu8XidjaX0+jRVWCWkCEAJRp5TcaLf/4TtbXfi5tRl/oAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 21 11 24 26"\n        title=""\n        src="/static/2021-01-21-11-24-26-f6bcacfdef6508ce0ffa17d297746c02-fee1c.png"\n        srcset="/static/2021-01-21-11-24-26-f6bcacfdef6508ce0ffa17d297746c02-a67b7.png 200w,\n/static/2021-01-21-11-24-26-f6bcacfdef6508ce0ffa17d297746c02-0b187.png 400w,\n/static/2021-01-21-11-24-26-f6bcacfdef6508ce0ffa17d297746c02-fee1c.png 800w,\n/static/2021-01-21-11-24-26-f6bcacfdef6508ce0ffa17d297746c02-b1a91.png 1200w,\n/static/2021-01-21-11-24-26-f6bcacfdef6508ce0ffa17d297746c02-95179.png 1600w,\n/static/2021-01-21-11-24-26-f6bcacfdef6508ce0ffa17d297746c02-d2875.png 1618w"\n        sizes="(max-width: 800px) 100vw, 800px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<blockquote>\n<p>这里需要提一下，为什么父级指针叫做 return 而不是 parent 或者 father 呢？因为作为一个工作单元，return 指节点执行完 completeWork 后会返回的下一个节点。子 Fiber 节点及其兄弟节点完成工作后会返回其父级节点，所以用 return 指代父级节点。</p>\n</blockquote>\n<h4 id="作为静态的数据结构"><a href="#%E4%BD%9C%E4%B8%BA%E9%9D%99%E6%80%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作为静态的数据结构</h4>\n<p>作为一种静态的数据结构，保存了组件相关的信息：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97664370926458650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// Fiber 对应组件的类型 Function/Class/Host...\nthis.tag = tag;\n// key 属性\nthis.key = key;\n// 大部分情况同 type，某些情况不同，比如 FunctionComponent 使用 React.memo 包裹\nthis.elementType = null;\n// 对于 FunctionComponent，指函数本身，对于 ClassComponent，指 class，对于 HostComponent，指 DOM 节点 tagName\nthis.type = null;\n// Fiber 对应的真实 DOM 节点\nthis.stateNode = null;`, `97664370926458650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// Fiber 对应组件的类型 Function/Class/Host...</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>\n<span class="token comment">// key 属性</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>\n<span class="token comment">// 大部分情况同 type，某些情况不同，比如 FunctionComponent 使用 React.memo 包裹</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>elementType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token comment">// 对于 FunctionComponent，指函数本身，对于 ClassComponent，指 class，对于 HostComponent，指 DOM 节点 tagName</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token comment">// Fiber 对应的真实 DOM 节点</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="作为动态的工作单元"><a href="#%E4%BD%9C%E4%B8%BA%E5%8A%A8%E6%80%81%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8D%95%E5%85%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作为动态的工作单元</h4>\n<p>作为动态的工作单元，Fiber 中如下参数保存了本次更新相关的信息，我们会在后续的更新流程中使用到具体属性时再详细介绍</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27177034436707537000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 保存本次更新造成的状态改变相关信息\nthis.pendingProps = pendingProps;\nthis.memoizedProps = null;\nthis.updateQueue = null;\nthis.memoizedState = null;\nthis.dependencies = null;\n\nthis.mode = mode;\n\n// 保存本次更新会造成的DOM操作\nthis.effectTag = NoEffect;\nthis.nextEffect = null;\n\nthis.firstEffect = null;\nthis.lastEffect = null;`, `27177034436707537000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 保存本次更新造成的状态改变相关信息</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n<span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>\n\n<span class="token comment">// 保存本次更新会造成的DOM操作</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n<span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如下两个字段保存调度优先级相关的信息，会在讲解 Scheduler 时介绍。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92784456979137400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 调度优先级相关\nthis.lanes = NoLanes;\nthis.childLanes = NoLanes;`, `92784456979137400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// 调度优先级相关</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>\n<span class="token keyword">this</span><span class="token punctuation">.</span>childLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意</p>\n<p>在 2020 年 5 月，调度优先级策略经历了比较大的重构。以 expirationTime 属性为代表的优先级模型被 lane 取代。详见<a href="https://github.com/facebook/react/pull/18796" target="_blank" rel="nofollow noreferrer noopener">这个 PR</a></p>\n<p>如果你的源码中 fiber.expirationTime 仍存在，请参照调试源码章节获取最新代码。</p>\n</blockquote>\n<h3 id="总结-2"><a href="#%E6%80%BB%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>本节我们了解了 Fiber 的起源与架构，其中 Fiber 节点可以构成 Fiber 树。那么 Fiber 树和页面呈现的 DOM 树有什么关系，React 又是如何更新 DOM 的呢？</p>\n<h2 id="fiber-架构的工作原理"><a href="#fiber-%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fiber 架构的工作原理</h2>\n<p>通过上一节的学习，我们了解了 Fiber 是什么，知道 Fiber 节点可以保存对应的 DOM 节点。</p>\n<p>相应的，Fiber 节点构成的 Fiber 树就对应 DOM 树。</p>\n<p>那么如何更新 DOM 呢？这需要用到被称为“双缓存”的技术。</p>\n<h3 id="什么是双缓存"><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%8C%E7%BC%93%E5%AD%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>什么是“双缓存”</h3>\n<p>当我们用 canvas 绘制动画，每一帧绘制前都会调用 ctx.clearRect 清除上一帧的画面。</p>\n<p>如果当前帧画面计算量比较大，导致清除上一帧画面到绘制当前帧画面之间有较长间隙，就会出现白屏。</p>\n<p>为了解决这个问题，我们可以在内存中绘制当前帧动画，绘制完毕后直接用当前帧替换上一帧画面，由于省去了两帧替换间的计算时间，不会出现从白屏到出现画面的闪烁情况。</p>\n<p>这种在内存中构建并直接替换的技术叫做双缓存。</p>\n<p>React 使用“双缓存”来完成 Fiber 树的构建与替换——对应着 DOM 树的创建与更新。</p>\n<h3 id="双缓存-fiber-树"><a href="#%E5%8F%8C%E7%BC%93%E5%AD%98-fiber-%E6%A0%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>双缓存 Fiber 树</h3>\n<p>在 React 中最多会同时存在两棵 Fiber 树。当前屏幕上显示内容对应的 Fiber 树称为 current Fiber 树，正在内存中构建的 Fiber 树称为 workInProgress Fiber 树。</p>\n<p>current Fiber 树中的 Fiber 节点被称为 current fiber，workInProgress Fiber 树中的 Fiber 节点被称为 workInProgress fiber，他们通过 alternate 属性连接。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79033886061366920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`currentFiber.alternate === workInProgressFiber;\nworkInProgressFiber.alternate === currentFiber;`, `79033886061366920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> workInProgressFiber<span class="token punctuation">;</span>\nworkInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> currentFiber<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>React 应用的根节点通过 current 指针在不同 Fiber 树的 rootFiber 间切换来实现 Fiber 树的切换。</p>\n<p>当 workInProgress Fiber 树构建完成交给 Renderer 渲染在页面上后，应用根节点的 current 指针指向 workInProgress Fiber 树，此时 workInProgress Fiber 树就变为 current Fiber 树。</p>\n<p>每次状态更新都会产生新的 workInProgress Fiber 树，通过 current 与 workInProgress 的替换，完成 DOM 更新。</p>\n<p>接下来我们以具体例子讲解 mount 时、update 时的构建/替换流程。</p>\n<h3 id="mount-时"><a href="#mount-%E6%97%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mount 时</h3>\n<p>考虑如下例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88060653204631300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`function App() {\n  const [num, add] = useState(0);\n  return <p onClick={() => add(num + 1)}>{num}</p>;\n}\n\nReactDOM.render(<App />, document.getElementById(\'root\'));`, `88060653204631300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> add<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">add</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\nReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">\'root\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ol>\n<li>\n<p>首次执行 ReactDOM.render 会创建 fiberRootNode（源码中叫 fiberRoot）和 rootFiber。其中 fiberRootNode 是整个应用的根节点，rootFiber 是 <code class="language-text">&lt;App/&gt;</code> 所在组件树的根节点。</p>\n<p>之所以要区分 fiberRootNode 与 rootFiber，是因为在应用中我们可以多次调用 ReactDOM.render 渲染不同的组件树，他们会拥有不同的 rootFiber。但是整个应用的根节点只有一个，那就是 fiberRootNode。</p>\n<p>fiberRootNode 的 current 会指向当前页面上已渲染内容对应对 Fiber 树，被称为 current Fiber 树。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-21-11-51-03-28804fcf719208fb3ef2f9620256f11f-72b93.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 659px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 57.66312594840668%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA/ElEQVQoz6VSbUvDMBDu//9Ne9Hum0MH3ZTBKCots7qOpm3ec0m8LDhkogt4HOFyyXP33JNk/h+WXewNOKagZ3LgehQaA1y7kVNpTg5C21/BiATvm+Z9MpneLZfT2SxfLObzm9s8L4o1XhiEwdWdwc67aKGzDZ2pgqbjPVMDV4SG5oQKjDEv/+gc8YQZBe7n0UUqAwt1+1x9lOX+icreWE+4AeuSBEO2qA6SoqKjQo3CRP5JYCSpIES99EcWIn0SPKVCxoIGpqqqVbG5f1gV682hbXFeFkteA1t8wNf6bbsrX+r943Z3OBKhnTQ2ZWZ/lidS/Z5J/2Huy1PtEyWevrNeMjX7AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 21 11 51 03"\n        title=""\n        src="/static/2021-01-21-11-51-03-28804fcf719208fb3ef2f9620256f11f-72b93.png"\n        srcset="/static/2021-01-21-11-51-03-28804fcf719208fb3ef2f9620256f11f-6e9e4.png 200w,\n/static/2021-01-21-11-51-03-28804fcf719208fb3ef2f9620256f11f-8b598.png 400w,\n/static/2021-01-21-11-51-03-28804fcf719208fb3ef2f9620256f11f-72b93.png 659w"\n        sizes="(max-width: 659px) 100vw, 659px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33028057628669540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fiberRootNode.current = rootFiber;`, `33028057628669540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">fiberRootNode<span class="token punctuation">.</span>current <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于是首屏渲染，页面中还没有挂载任何 DOM，所以 fiberRootNode.current 指向的 rootFiber 没有任何子 Fiber 节点（即 current Fiber 树为空）。</p>\n</li>\n<li>\n<p>接下来进入 render 阶段，根据组件返回的 JSX 在内存中依次创建 Fiber 节点并连接在一起构建 Fiber 树，被称为 workInProgress Fiber 树。（下图中右侧为内存中构建的树，左侧为页面显示的树）</p>\n<p>在构建 workInProgress Fiber 树时会尝试复用 current Fiber 树中已有的 Fiber 节点内的属性，在首屏渲染时只有 rootFiber 存在对应的 current fiber（即 rootFiber.alternate）。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-21-13-50-15-aaf7f592248d720d3bef35b1c67e67d4-c23b1.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 706px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 124.5042492917847%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB7ElEQVQ4y52Ti27qMAyGef8HO9I0iTEuY4wz2o61dBRKb7nHyZwwWDd2yTlWVIHlP7Y/xwN7YRoM2jf+D57BpwipgUqT5tvo6fkxSpLnbLFcxess3bxQCVTAD2LDpebaZJvNaDSe3y/G09l4Mp3N7haLBwkG9T9l9uVZMFZbWwkrfZ2oQA+TAB/rfheDgUO7K+p832yY4A1TCq9x7Z++F/YuNqDLZovKbJ9VVHwOxJzn0xdLbfTJRZTtpBVKxS/3T9slftN9hAFY9lmkwOBxYhwAEVDsD8Pbyc3t5M/1cFdWndBZWRNOG9qlZYPdJut0PL27uh7O5g9NR1CCnQzAiU1Zd4/xOs2Lv6ukagiR7kYFmMQ2TOOE8qKM1tkqSTGqpQKxmy9pX5p5I2qFfvtr+sDMyQCgL+j/UFp3TPYcAZmxOS5B4PNSpuIOFROACIPESItJV24UxzejEWUcdR138/ldjEmo0AhoV9bzZUS4FM4DNhAYjtMfBwy7UKf1ChKfr8Bqf1mMSw0WiZBaBrsOEB7hIFQwMOlDGeN5nh/nivpQYPhamTI1EVlxwMKJ0MfFDnthfpcQmGu5t1f/AEz9HzDigeGGbFt1BMYVhAIT/jESStM09a/d+JUMEGO1hGvM3DFVtYz5bWXhwL6zVylMvZQ0Cw++AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 21 13 50 15"\n        title=""\n        src="/static/2021-01-21-13-50-15-aaf7f592248d720d3bef35b1c67e67d4-c23b1.png"\n        srcset="/static/2021-01-21-13-50-15-aaf7f592248d720d3bef35b1c67e67d4-8968d.png 200w,\n/static/2021-01-21-13-50-15-aaf7f592248d720d3bef35b1c67e67d4-750c3.png 400w,\n/static/2021-01-21-13-50-15-aaf7f592248d720d3bef35b1c67e67d4-c23b1.png 706w"\n        sizes="(max-width: 706px) 100vw, 706px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</li>\n<li>\n<p>图中右侧已构建完的 workInProgress Fiber 树在 commit 阶段渲染到页面。</p>\n<p>此时 DOM 更新为右侧树对应的样子。fiberRootNode 的 current 指针指向 workInProgress Fiber 树使其变为 current Fiber 树。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-21-13-52-59-4423fe5d38e7f32bdc3625298994d524-0e173.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 646px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 137.77089783281733%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB2ElEQVQ4y51UYXObMAzN//9J6922Lw3bh6x37ZddtpIUkh2EJgECxpYtsQesWdKOq5nOSQTxs6SnJ8/aERNheTE8CDO+X+2ZvXq2TirtKm21k9pYZVzvOMNtY7u/yMkoGABu26fo6eOnz0EQLBaL29s51nwerNdrbDhpOwYWY11lXF412zRLD0WcHpLskO7zDX6Kujasu8NHIp+NpS2NWL6qU8ZqVqaOs8c4C6Pdj1qbsnF8gZQ3bF2BraOTyusm3xWHsqHWw2ZDMvxycmFa4iHtf8V6C0YnFEnyfFxF28XD98d19Hwsa5KG3PtgdBVBwnD17e7u/v4h+PJ1s90ifH3RlVEwMkQPiAVnVNQCZlgUPuKR9qUmIameBPEl7LKN+8qL579g4xiiBW1IPqtsQwwfOrNOfAj7sy+K45ubD0mawifLlfFgG3IF4Yo6SYeb9HhSiro35HgKYRCplWk1X4+kmwZGP1EzFgY9Ka3rfSyvPvfydMahyfbXbg8HLKjupUfNEBPuD7DTaPoZrrhPRBM3PmDsRqhhFVrOvkwlTE0lbJgNLMeSnUh6//2xOItk4AxXZ5JDIYPvvETSy7Pbpw0tl8shESBrH3lSf60PAStN58heg/Hf9hsFa3Lor0VrrwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 21 13 52 59"\n        title=""\n        src="/static/2021-01-21-13-52-59-4423fe5d38e7f32bdc3625298994d524-0e173.png"\n        srcset="/static/2021-01-21-13-52-59-4423fe5d38e7f32bdc3625298994d524-2fb9f.png 200w,\n/static/2021-01-21-13-52-59-4423fe5d38e7f32bdc3625298994d524-f1e72.png 400w,\n/static/2021-01-21-13-52-59-4423fe5d38e7f32bdc3625298994d524-0e173.png 646w"\n        sizes="(max-width: 646px) 100vw, 646px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</li>\n</ol>\n<h3 id="update-时"><a href="#update-%E6%97%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>update 时</h3>\n<ol>\n<li>\n<p>接下来我们点击 p 节点触发状态改变，这会开启一次新的 render 阶段并构建一棵新的 workInProgress Fiber 树。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-21-13-55-02-273c6e77da3748e87c1316e525db0bc0-7ab71.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 716px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 124.30167597765363%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACo0lEQVQ4y6VU2W7bMBDM//9TURRpncROHQR9KIokji/ZlkTrJCmeqw4pw3ZOoKigB3K5w9md3eVF/x/fxfnGE3WGRKdrLuu2q3lXtaIVikutjFfWfwZW1inX7zL25eu36d395Y+r76Pry9H1+HYKcKs8fQLGGW43jpS2pTCVMNo4qUynjDIO9g+ZjdVSCaka711nSWr3DzmzJl2z2TJ7zJvmQyDRO+DBaF3f6n6QpeIsrzZlmxdtSjimd24I4M543pl9WT/Mk9lqW7dcaFrk62Q/T8tktnvmykH/TcoW623KCjhL7Q9goX3Vyrv7X1B1PJn+/vMgbZ+31vmg3547YfrnxepmMh3f3t1MfhY155oOYO/JxipEqaN4DpGi6j7ESBS3IdjIBzdynl6Viox12nyolXe+g5Jnml1EAcjGu7khaXxgpH7f7DbFPK83abVGArCCv1ahC8HsiY45o7BeKP20WGf72niCZcl2abllTb7IkqYzlvptxuarrdQGfQoJT2AwI+bx5PbxaQYLOqQQoOuhWSVpcF2tk9HVtewUOk0cwcge1dLOK99LS9qGGYgCHf7Boj2hCnCDs30jGDrU6zejc5o5cLxsvQMzhgaqlNLVEgPgoU1arpbZw7ZYJmwWpgKiaM94WCCKEzPaBYRgRJOJDrH30HzJin1TVLxesJzHUZZKs7JCwrhdaHcCgxnWZJc1XGIBS5heQmEgJ8RHyD2O4IBTbc/APvYQBFc2+AXl3TAKh3+waEfoUxPX/nPBiN4TzLwRDBeDEH1SyKAZFsj5CKYoAf5Guay1qBOch1flMFU2btIs51xgMRR2ACNaKBLiMraqmxhCgJwEgwBImJVNIxQWaKnji4VCYgu8UBbvKZijv3/xkgxxDotXCZ8bz0//AhKhs4PWXXE2AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 21 13 55 02"\n        title=""\n        src="/static/2021-01-21-13-55-02-273c6e77da3748e87c1316e525db0bc0-7ab71.png"\n        srcset="/static/2021-01-21-13-55-02-273c6e77da3748e87c1316e525db0bc0-a8f09.png 200w,\n/static/2021-01-21-13-55-02-273c6e77da3748e87c1316e525db0bc0-924e7.png 400w,\n/static/2021-01-21-13-55-02-273c6e77da3748e87c1316e525db0bc0-7ab71.png 716w"\n        sizes="(max-width: 716px) 100vw, 716px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>和 mount 时一样，workInProgress fiber 的创建可以复用 current Fiber 树对应的节点数据。</p>\n<blockquote>\n<p>这个决定是否复用的过程就是 Diff 算法，后面章节会详细讲解</p>\n</blockquote>\n</li>\n<li>\n<p>workInProgress Fiber 树在 render 阶段完成构建后进入 commit 阶段渲染到页面上。渲染完毕后，workInProgress Fiber 树变为 current Fiber 树。</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/2021-01-21-13-58-36-57e7b01ca785350dc727b89db9997d28-ac14c.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 674px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 133.23442136498517%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABxUlEQVQ4y5WU64rbMBCF8/6P1WY3Niy79EehpcvSJlAc7Pgq6zYXdWQtNEmzjTwMtiR8mNGnI2/CP0HExIHDRcoKxnU+/3JzpQRi7WmcdTfOp35qByXZjWpQWjuYHZ3rr8XWk8Ow3x8+fd4+v7w87IrHonx43O2Ksu16C8EjfSiW9qwPondAg6Feg0M2nrRHeUryzbaZGRAAPaANHL+bLYb/xl+xB/fr+ONQv75V31qlDXC4FxeVJTzyoFF6DhmxWfbJyqJAtsiHkxktWiBl6epgbosFoKVQVdXT0/N2u90VxeGw9xzu1n+vLAfYK1PV3bFTVdN1o5YVJM7dcwrtiUNuXIqZR+OZaYVYuEhB6VOANTo+dXQF3e1hk/ysFj80p7Ysy7puZDw7PHfih2IBMxqwwN2kv3z9XtWtxzAZhExgAlxSLqJ0IK80XQksdgvLXc4HFn0SjQnIx0m8yWnKmcAmi7AIjk0rxkoIZZoFTC1isePr20/rIyrlKEu83Ed2S07ufRDbXgvM3C1366hiSq1GoVgjTbPEsufBYLLk72YQb8k/aDSRQhZtESSTD32fPC36LHuKxjjSS4pJ0yDeTV4JbFX8Ae40Oei25tw7AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;"\n        alt="2021 01 21 13 58 36"\n        title=""\n        src="/static/2021-01-21-13-58-36-57e7b01ca785350dc727b89db9997d28-ac14c.png"\n        srcset="/static/2021-01-21-13-58-36-57e7b01ca785350dc727b89db9997d28-2d27a.png 200w,\n/static/2021-01-21-13-58-36-57e7b01ca785350dc727b89db9997d28-cc70c.png 400w,\n/static/2021-01-21-13-58-36-57e7b01ca785350dc727b89db9997d28-ac14c.png 674w"\n        sizes="(max-width: 674px) 100vw, 674px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</li>\n</ol>\n<h3 id="总结-3"><a href="#%E6%80%BB%E7%BB%93-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<p>本文介绍了 Fiber 树的构建与替换过程，这个过程伴随着 DOM 的更新。</p>\n<p>那么在构建过程中每个 Fiber 节点具体是如何创建的呢？我们会在架构篇的 render 阶段讲解。</p>\n<h2 id="总结-4"><a href="#%E6%80%BB%E7%BB%93-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h2>\n<p>通过本章的学习，我们了解了 React 的 Scheduler-Reconciler-Renderer 架构体系，在结束本章前，我想介绍几个源码内的术语：</p>\n<ul>\n<li>Reconciler 工作的阶段被称为 render 阶段。因为在该阶段会调用组件的 render 方法。</li>\n<li>Renderer 工作的阶段被称为 commit 阶段。就像你完成一个需求的编码后执行 git commit 提交代码。commit 阶段会把 render 阶段提交的信息渲染在页面上。</li>\n<li>render 与 commit 阶段统称为 work，即 React 在工作中。相对应的，如果任务正在 Scheduler 内调度，就不属于 work。</li>\n<li>在架构篇我们会分别讲解 Reconciler 和 Renderer 的工作流程，所以章节名分别为 render 阶段和 commit 阶段。</li>\n</ul>\n<h1 id="前置知识"><a href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前置知识</h1>\n<h2 id="源码的文件结构"><a href="#%E6%BA%90%E7%A0%81%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码的文件结构</h2>\n<p>经过之前的学习，我们已经知道 React16 的架构分为三层：</p>\n<ul>\n<li>Scheduler（调度器）—— 调度任务的优先级，高优任务优先进入 Reconciler</li>\n<li>Reconciler（协调器）—— 负责找出变化的组件</li>\n<li>Renderer（渲染器）—— 负责将变化的组件渲染到页面上</li>\n</ul>\n<p>那么架构是如何体现在源码的文件结构上呢，让我们一起看看吧。</p>\n<h3 id="顶层目录"><a href="#%E9%A1%B6%E5%B1%82%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>顶层目录</h3>\n<p>除去配置文件和隐藏文件夹，根目录的文件夹包括三个：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30203469606172328000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`根目录\n├── fixtures        # 包含一些给贡献者准备的小型 React 测试项目\n├── packages        # 包含元数据（比如 package.json）和 React 仓库中所有 package 的源码（子目录 src）\n├── scripts         # 各种工具链的脚本，比如 git、jest、eslint 等`, `30203469606172328000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">根目录\n├── fixtures        # 包含一些给贡献者准备的小型 React 测试项目\n├── packages        # 包含元数据（比如 package.json）和 React 仓库中所有 package 的源码（子目录 src）\n├── scripts         # 各种工具链的脚本，比如 git、jest、eslint 等</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里我们关注 packages 目录</p>\n<h3 id="packages-目录"><a href="#packages-%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>packages 目录</h3>\n<p>目录下的文件夹非常多，我们来看下：</p>\n<h4 id="react-文件夹"><a href="#react-%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react 文件夹</h4>\n<p>React 的核心，包含所有全局 React API，如：</p>\n<ul>\n<li>React.createElement</li>\n<li>React.Component</li>\n<li>React.Children</li>\n</ul>\n<p>这些 API 是全平台通用的，它不包含 ReactDOM、ReactNative 等平台特定的代码。在 NPM 上作为单独的一个包发布。</p>\n<h4 id="scheduler-文件夹"><a href="#scheduler-%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>scheduler 文件夹</h4>\n<p>Scheduler（调度器）的实现。</p>\n<h4 id="shared-文件夹"><a href="#shared-%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>shared 文件夹</h4>\n<p>源码中其他模块公用的方法和全局变量，比如在 shared/ReactSymbols.js 中保存 React 不同组件类型的定义。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43163385166039080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// ...\nexport let REACT_ELEMENT_TYPE = 0xeac7;\nexport let REACT_PORTAL_TYPE = 0xeaca;\nexport let REACT_FRAGMENT_TYPE = 0xeacb;\n// ...`, `43163385166039080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token comment">// ...</span>\n<span class="token keyword">export</span> <span class="token keyword">let</span> <span class="token constant">REACT_ELEMENT_TYPE</span> <span class="token operator">=</span> <span class="token number">0xeac7</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">let</span> <span class="token constant">REACT_PORTAL_TYPE</span> <span class="token operator">=</span> <span class="token number">0xeaca</span><span class="token punctuation">;</span>\n<span class="token keyword">export</span> <span class="token keyword">let</span> <span class="token constant">REACT_FRAGMENT_TYPE</span> <span class="token operator">=</span> <span class="token number">0xeacb</span><span class="token punctuation">;</span>\n<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="renderer-相关的文件夹"><a href="#renderer-%E7%9B%B8%E5%85%B3%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Renderer 相关的文件夹</h4>\n<p>如下几个文件夹为对应的 Renderer</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75187833640851050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`- react-art\n- react-dom                 # 注意这同时是 DOM 和 SSR（服务端渲染）的入口\n- react-native-renderer\n- react-noop-renderer       # 用于 debug fiber（后面会介绍 fiber）\n- react-test-renderer`, `75187833640851050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">- react-art\n- react-dom                 # 注意这同时是 DOM 和 SSR（服务端渲染）的入口\n- react-native-renderer\n- react-noop-renderer       # 用于 debug fiber（后面会介绍 fiber）\n- react-test-renderer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="试验性包的文件夹"><a href="#%E8%AF%95%E9%AA%8C%E6%80%A7%E5%8C%85%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>试验性包的文件夹</h4>\n<p>React 将自己流程中的一部分抽离出来，形成可以独立使用的包，由于他们是试验性质的，所以不被建议在生产环境使用。包括如下文件夹：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33316349975931560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`- react-server        # 创建自定义 SSR 流\n- react-client        # 创建自定义的流\n- react-fetch         # 用于数据请求\n- react-interactions  # 用于测试交互相关的内部特性，比如 React 的事件模型\n- react-reconciler    # Reconciler 的实现，你可以用他构建自己的 Renderer`, `33316349975931560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">- react-server        # 创建自定义 SSR 流\n- react-client        # 创建自定义的流\n- react-fetch         # 用于数据请求\n- react-interactions  # 用于测试交互相关的内部特性，比如 React 的事件模型\n- react-reconciler    # Reconciler 的实现，你可以用他构建自己的 Renderer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="辅助包的文件夹"><a href="#%E8%BE%85%E5%8A%A9%E5%8C%85%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>辅助包的文件夹</h4>\n<p>React 将一些辅助功能形成单独的包。包括如下文件夹：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13236850621820539000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`- react-is       # 用于测试组件是否是某类型\n- react-client   # 创建自定义的流\n- react-fetch    # 用于数据请求\n- react-refresh  # “热重载”的React官方实现`, `13236850621820539000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">- react-is       # 用于测试组件是否是某类型\n- react-client   # 创建自定义的流\n- react-fetch    # 用于数据请求\n- react-refresh  # “热重载”的React官方实现</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="react-reconciler-文件夹"><a href="#react-reconciler-%E6%96%87%E4%BB%B6%E5%A4%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>react-reconciler 文件夹</h4>\n<p>我们需要重点关注 react-reconciler，在接下来源码学习中 80% 的代码量都来自这个包。</p>\n<p>虽然他是一个实验性的包，内部的很多功能在正式版本中还未开放。但是他一边对接 Scheduler，一边对接不同平台的 Renderer，构成了整个 React16 的架构体系。</p>\n<h2 id="深入理解-jsx"><a href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-jsx" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>深入理解 JSX</h2>\n<h3 id="jsx-简介"><a href="#jsx-%E7%AE%80%E4%BB%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JSX 简介</h3>\n<p>相信作为 React 的使用者，你已经接触过 JSX。如果你还不了解他，可以看下官网对其的描述。</p>\n<p>JSX 在编译时会被 Babel 编译为 React.createElement 方法。</p>\n<p>这也是为什么在每个使用 JSX 的 JS 文件中，你必须显式的声明</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44103987136780300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import React from \'react\';`, `44103987136780300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">\'react\'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>否则在运行时该模块内就会报未定义变量 React 的错误。</p>\n<p>JSX 并不是只能被编译为 React.createElement 方法，你可以通过 @babel/plugin-transform-react-jsx 插件显式告诉 Babel 编译时需要将 JSX 编译为什么函数的调用（默认为 React.createElement）。</p>\n<p>比如在 preact 这个类 React 库中，JSX 会被编译为一个名为 h 的函数调用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90946448497237980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`// 编译前\n<p>KaSong</p>;\n// 编译后\nh(\'p\', null, \'KaSong\');`, `90946448497237980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 编译前</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">KaSong</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n<span class="token comment">// 编译后</span>\n<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">\'p\'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">\'KaSong\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="reactcreateelement"><a href="#reactcreateelement" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React.createElement</h3>\n<p>既然 JSX 会被编译为 React.createElement，让我们看看他做了什么：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15707982299297841000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function createElement(type, config, children) {\n  let propName;\n\n  const props = {};\n\n  let key = null;\n  let ref = null;\n  let self = null;\n  let source = null;\n\n  if (config != null) {\n    // 将 config 处理后赋值给 props\n    // ...省略\n  }\n\n  const childrenLength = arguments.length - 2;\n  // 处理 children，会被赋值给 props.children\n  // ...省略\n\n  // 处理 defaultProps\n  // ...省略\n\n  return ReactElement(type, key, ref, self, source, ReactCurrentOwner.current, props);\n}\n\nconst ReactElement = function(type, key, ref, self, source, owner, props) {\n  const element = {\n    // 标记这是个 React Element\n    \\$\\$typeof: REACT_ELEMENT_TYPE,\n\n    type: type,\n    key: key,\n    ref: ref,\n    props: props,\n    _owner: owner\n  };\n\n  return element;\n};`, `15707982299297841000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> propName<span class="token punctuation">;</span>\n\n  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n  <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 将 config 处理后赋值给 props</span>\n    <span class="token comment">// ...省略</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> childrenLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>\n  <span class="token comment">// 处理 children，会被赋值给 props.children</span>\n  <span class="token comment">// ...省略</span>\n\n  <span class="token comment">// 处理 defaultProps</span>\n  <span class="token comment">// ...省略</span>\n\n  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> self<span class="token punctuation">,</span> source<span class="token punctuation">,</span> ReactCurrentOwner<span class="token punctuation">.</span>current<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> <span class="token function-variable function">ReactElement</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> self<span class="token punctuation">,</span> source<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 标记这是个 React Element</span>\n    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">,</span>\n\n    type<span class="token punctuation">:</span> type<span class="token punctuation">,</span>\n    key<span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n    ref<span class="token punctuation">:</span> ref<span class="token punctuation">,</span>\n    props<span class="token punctuation">:</span> props<span class="token punctuation">,</span>\n    _owner<span class="token punctuation">:</span> owner\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">return</span> element<span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以看到，React.createElement 最终会调用 ReactElement 方法返回一个包含组件数据的对象，该对象有个参数 <code class="language-text">$$typeof: REACT_ELEMENT_TYPE</code> 标记了该对象是个 React Element。</p>\n<p>所以调用 React.createElement 返回的对象就是 React Element 么？</p>\n<p>React 提供了验证合法 React Element 的全局 API <a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react/src/ReactElement.js#L547" target="_blank" rel="nofollow noreferrer noopener">React.isValidElement</a>，我们看下他的实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53373757326502670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`export function isValidElement(object) {\n  return typeof object === \'object\' && object !== null && object.\\$\\$typeof === REACT_ELEMENT_TYPE;\n}`, `53373757326502670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isValidElement</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">typeof</span> object <span class="token operator">===</span> <span class="token string">\'object\'</span> <span class="token operator">&amp;&amp;</span> object <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> object<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，<code class="language-text">$$typeof === REACT_ELEMENT_TYPE</code> 的非 null 对象就是一个合法的 React Element。换言之，在 React 中，所有 JSX 在运行时的返回结果（即 <code class="language-text">React.createElement()</code> 的返回值）都是 React Element。</p>\n<p>那么 JSX 和 React Component 的关系呢?</p>\n<h3 id="react-component"><a href="#react-component" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React Component</h3>\n<p>在 React 中，我们常使用 ClassComponent 与 FunctionComponent 构建组件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92221099769402060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class AppClass extends React.Component {\n  render() {\n    return <p>KaSong</p>;\n  }\n}\nconsole.log(\'这是ClassComponent：\', AppClass);\nconsole.log(\'这是Element：\', <AppClass />);\n\nfunction AppFunc() {\n  return <p>KaSong</p>;\n}\nconsole.log(\'这是FunctionComponent：\', AppFunc);\nconsole.log(\'这是Element：\', <AppFunc />);`, `92221099769402060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                jsx 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">AppClass</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>\n  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">KaSong</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'这是ClassComponent：\'</span><span class="token punctuation">,</span> AppClass<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'这是Element：\'</span><span class="token punctuation">,</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppClass</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">AppFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">KaSong</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'这是FunctionComponent：\'</span><span class="token punctuation">,</span> AppFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'这是Element：\'</span><span class="token punctuation">,</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppFunc</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以从 Demo 控制台打印的对象看出，ClassComponent 对应的 Element 的 type 字段为 AppClass 自身。</p>\n<p>FunctionComponent 对应的 Element 的 type 字段为 AppFunc 自身，如下所示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67937449298974670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`{\n  \\$\\$typeof: Symbol(react.element),\n  key: null,\n  props: {},\n  ref: null,\n  type: ƒ AppFunc(),\n  _owner: null,\n  _store: {validated: false},\n  _self: null,\n  _source: null\n}`, `67937449298974670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>\n  $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  key<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n  ref<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  type<span class="token punctuation">:</span> ƒ <span class="token function">AppFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  _owner<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  _store<span class="token punctuation">:</span> <span class="token punctuation">{</span>validated<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n  _self<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>\n  _source<span class="token punctuation">:</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>值得注意的一点，由于</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35896309910848980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`AppClass instanceof Function === true;\nAppFunc instanceof Function === true;`, `35896309910848980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">AppClass <span class="token keyword">instanceof</span> <span class="token class-name">Function</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\nAppFunc <span class="token keyword">instanceof</span> <span class="token class-name">Function</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>所以无法通过引用类型区分 ClassComponent 和 FunctionComponent。React 通过 ClassComponent 实例原型上的 isReactComponent 变量判断是否是 ClassComponent。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14709621309002574000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`ClassComponent.prototype.isReactComponent = {};`, `14709621309002574000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                \n              >\n                js 复制代码\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token class-name">ClassComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="jsx-与-fiber-节点"><a href="#jsx-%E4%B8%8E-fiber-%E8%8A%82%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JSX 与 Fiber 节点</h3>\n<p>从上面的内容我们可以发现，JSX 是一种描述当前组件内容的数据结构，他不包含组件 schedule、reconcile、render 所需的相关信息。</p>\n<p>比如如下信息就不包括在 JSX 中：</p>\n<ul>\n<li>组件在更新中的优先级</li>\n<li>组件的 state</li>\n<li>组件被打上的用于 Renderer 的标记</li>\n</ul>\n<p>这些内容都包含在 Fiber 节点中。</p>\n<p>所以，在组件 mount 时，Reconciler 根据 JSX 描述的组件内容生成组件对应的 Fiber 节点。</p>\n<p>在 update 时，Reconciler 将 JSX 与 Fiber 节点保存的数据对比，生成组件对应的 Fiber 节点，并根据对比结果为 Fiber 节点打上标记。</p>',
id:"/github/workspace/blog/React技术解密笔记——理念篇/index.md absPath of file >>> MarkdownRemark",timeToRead:21,frontmatter:{date:"2021-01-20 10:51:32",path:"/react-technology-notes-idea/",tags:"前端, React, 高级前端",title:"React技术解密笔记——理念篇",draft:null}}],page:3,pagesSum:37,length:185,prevPath:"/page/2",nextPath:"/page/4"}}}});